class t{constructor(){if(this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){let t=arguments[0];this.componentsString=t}else if(arguments[0]instanceof t.Component&&arguments[1]instanceof t){let t=arguments[0],e=arguments[1];this._components.push(t),this._components=this._components.concat(e._components)}else if(arguments[0]instanceof Array){let t=arguments[0],e=!!arguments[1];this._components=this._components.concat(t),this._isRelative=e}}get isRelative(){return this._isRelative}get componentCount(){return this._components.length}get head(){return this._components.length>0?this._components[0]:null}get tail(){if(this._components.length>=2){let e=this._components.slice(1,this._components.length);return new t(e)}return t.self}get length(){return this._components.length}get lastComponent(){let t=this._components.length-1;return t>=0?this._components[t]:null}get containsNamedComponent(){for(let t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}static get self(){let e=new t;return e._isRelative=!0,e}GetComponent(t){return this._components[t]}PathByAppendingPath(e){let n=new t,i=0;for(let t=0;t<e._components.length&&e._components[t].isParent;++t)i++;for(let t=0;t<this._components.length-i;++t)n._components.push(this._components[t]);for(let t=i;t<e._components.length;++t)n._components.push(e._components[t]);return n}get componentsString(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString}set componentsString(e){if(this._components.length=0,this._componentsString=e,null==this._componentsString||""==this._componentsString)return;"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));let n=this._componentsString.split(".");for(let e of n)/^(\-|\+)?([0-9]+|Infinity)$/.test(e)?this._components.push(new t.Component(parseInt(e))):this._components.push(new t.Component(e))}toString(){return this.componentsString}Equals(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(let e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}PathByAppendingComponent(e){let n=new t;return n._components.push.apply(n._components,this._components),n._components.push(e),n}}var e,n,i;function a(t,e){return t instanceof e?u(t,e):null}function r(t,e){if(t instanceof e)return u(t,e);throw new Error(`${t} is not of type ${e}`)}function s(t){if("number"==typeof t)return t;throw new Error(`${t} is not a number`)}function l(t){return t.hasValidName&&t.name?t:null}function o(t){return void 0===t?null:t}function u(t,e){return t}t.parentId="^",function(t){class e{constructor(t){this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}get isIndex(){return this.index>=0}get isParent(){return this.name==t.parentId}static ToParent(){return new e(t.parentId)}toString(){return this.isIndex?this.index.toString():this.name}Equals(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}}t.Component=e}(t||(t={})),function(t){function e(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),""}t.AssertType=function(t,n,i){e(t instanceof n,i)},t.Assert=e}(e||(e={}));class h extends Error{}function c(t){throw new h(`${t} is null or undefined`)}class d{constructor(){this.parent=null,this._debugMetadata=null,this._path=null}get debugMetadata(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(t){this._debugMetadata=t}get ownDebugMetadata(){return this._debugMetadata}DebugLineNumberOfPath(t){if(null===t)return null;let e=this.rootContentContainer;if(e){let n=e.ContentAtPath(t).obj;if(n){let t=n.debugMetadata;if(null!==t)return t.startLineNumber}}return null}get path(){if(null==this._path)if(null==this.parent)this._path=new t;else{let e=[],n=this,i=a(n.parent,x);for(;null!==i;){let r=l(n);null!=r&&r.hasValidName?e.unshift(new t.Component(r.name)):e.unshift(new t.Component(i.content.indexOf(n))),n=i,i=a(i.parent,x)}this._path=new t(e)}return this._path}ResolvePath(t){if(null===t)return c("path");if(t.isRelative){let n=a(this,x);return null===n&&(e.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),n=a(this.parent,x),e.Assert(null!==n,"Expected parent to be a container"),e.Assert(t.GetComponent(0).isParent),t=t.tail),null===n?c("nearestContainer"):n.ContentAtPath(t)}{let e=this.rootContentContainer;return null===e?c("contentContainer"):e.ContentAtPath(t)}}ConvertPathToRelative(e){let n=this.path,i=Math.min(e.length,n.length),a=-1;for(let t=0;t<i;++t){let i=n.GetComponent(t),r=e.GetComponent(t);if(!i.Equals(r))break;a=t}if(-1==a)return e;let r=n.componentCount-1-a,s=[];for(let e=0;e<r;++e)s.push(t.Component.ToParent());for(let t=a+1;t<e.componentCount;++t)s.push(e.GetComponent(t));return new t(s,!0)}CompactPathString(t){let e=null,n=null;if(t.isRelative)n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString;else{n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString}return n.length<e.length?n:e}get rootContentContainer(){let t=this;for(;t.parent;)t=t.parent;return a(t,x)}Copy(){throw Error("Not Implemented: Doesn't support copying")}SetChild(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}}class p{constructor(t){t=void 0!==t?t.toString():"",this.string=t}get Length(){return this.string.length}Append(t){null!==t&&(this.string+=t)}AppendLine(t){void 0!==t&&this.Append(t),this.string+="\n"}AppendFormat(t,...e){this.string+=t.replace(/{(\d+)}/g,(t,n)=>void 0!==e[n]?e[n]:t)}toString(){return this.string}}class m{constructor(){if(this.originName=null,this.itemName=null,void 0!==arguments[1]){let t=arguments[0],e=arguments[1];this.originName=t,this.itemName=e}else if(arguments[0]){let t=arguments[0].toString().split(".");this.originName=t[0],this.itemName=t[1]}}static get Null(){return new m(null,null)}get isNull(){return null==this.originName&&null==this.itemName}get fullName(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}toString(){return this.fullName}Equals(t){if(t instanceof m){let e=t;return e.itemName==this.itemName&&e.originName==this.originName}return!1}copy(){return new m(this.originName,this.itemName)}serialized(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}static fromSerializedKey(t){let e=JSON.parse(t);if(!m.isLikeInkListItem(e))return m.Null;let n=e;return new m(n.originName,n.itemName)}static isLikeInkListItem(t){return"object"==typeof t&&(!(!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName"))&&(("string"==typeof t.originName||null===typeof t.originName)&&("string"==typeof t.itemName||null===typeof t.itemName)))}}class f extends Map{constructor(){if(super((()=>arguments[0]instanceof f?arguments[0]:void 0)()),this.origins=null,this._originNames=[],arguments[0]instanceof f){let t=arguments[0];t._originNames&&(this._originNames=t._originNames.slice())}else if("string"==typeof arguments[0]){let t=arguments[0],e=arguments[1];this.SetInitialOriginName(t);let n=e.listDefinitions.TryListGetDefinition(t,null);if(!n.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+t);this.origins=[n.result]}else if("object"==typeof arguments[0]&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){let t=arguments[0];this.Add(t.Key,t.Value)}}AddItem(t){if(t instanceof m){let e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return c("this.origins");for(let t of this.origins)if(t.name==e.originName){let n=t.TryGetValueForItem(e,0);if(n.exists)return void this.Add(e,n.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}{let e=t,n=null;if(null===this.origins)return c("this.origins");for(let t of this.origins){if(null===e)return c("itemName");if(t.ContainsItemWithName(e)){if(null!=n)throw new Error("Could not add the item "+e+" to this list because it could come from either "+t.name+" or "+n.name);n=t}}if(null==n)throw new Error("Could not add the item "+e+" to this list because it isn't known to any list definitions previously associated with this list.");let i=new m(n.name,e),a=n.ValueForItem(i);this.Add(i,a)}}ContainsItemNamed(t){for(let[e,n]of this){if(m.fromSerializedKey(e).itemName==t)return!0}return!1}ContainsKey(t){return this.has(t.serialized())}Add(t,e){let n=t.serialized();if(this.has(n))throw new Error(`The Map already contains an entry for ${t}`);this.set(n,e)}Remove(t){return this.delete(t.serialized())}get Count(){return this.size}get originOfMaxItem(){if(null==this.origins)return null;let t=this.maxItem.Key.originName,e=null;return this.origins.every(n=>n.name!=t||(e=n,!1)),e}get originNames(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);for(let[t,e]of this){let e=m.fromSerializedKey(t);if(null===e.originName)return c("item.originName");this._originNames.push(e.originName)}}return this._originNames}SetInitialOriginName(t){this._originNames=[t]}SetInitialOriginNames(t){this._originNames=null==t?null:t.slice()}get maxItem(){let t={Key:m.Null,Value:0};for(let[e,n]of this){let i=m.fromSerializedKey(e);(t.Key.isNull||n>t.Value)&&(t={Key:i,Value:n})}return t}get minItem(){let t={Key:m.Null,Value:0};for(let[e,n]of this){let i=m.fromSerializedKey(e);(t.Key.isNull||n<t.Value)&&(t={Key:i,Value:n})}return t}get inverse(){let t=new f;if(null!=this.origins)for(let e of this.origins)for(let[n,i]of e.items){let e=m.fromSerializedKey(n);this.ContainsKey(e)||t.Add(e,i)}return t}get all(){let t=new f;if(null!=this.origins)for(let e of this.origins)for(let[n,i]of e.items){let e=m.fromSerializedKey(n);t.set(e.serialized(),i)}return t}Union(t){let e=new f(this);for(let[n,i]of t)e.set(n,i);return e}Intersect(t){let e=new f;for(let[n,i]of this)t.has(n)&&e.set(n,i);return e}Without(t){let e=new f(this);for(let[n,i]of t)e.delete(n);return e}Contains(t){for(let[e,n]of t)if(!this.has(e))return!1;return!0}GreaterThan(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}GreaterThanOrEquals(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}LessThan(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}LessThanOrEquals(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}MaxAsList(){return this.Count>0?new f(this.maxItem):new f}MinAsList(){return this.Count>0?new f(this.minItem):new f}ListWithSubRange(t,e){if(0==this.Count)return new f;let n=this.orderedItems,i=0,a=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?i=t:t instanceof f&&t.Count>0&&(i=t.minItem.Value),Number.isInteger(e)?a=e:t instanceof f&&t.Count>0&&(a=e.maxItem.Value);let r=new f;r.SetInitialOriginNames(this.originNames);for(let t of n)t.Value>=i&&t.Value<=a&&r.Add(t.Key,t.Value);return r}Equals(t){if(t instanceof f==!1)return!1;if(t.Count!=this.Count)return!1;for(let[e,n]of this)if(!t.has(e))return!1;return!0}get orderedItems(){let t=new Array;for(let[e,n]of this){let i=m.fromSerializedKey(e);t.push({Key:i,Value:n})}return t.sort((t,e)=>null===t.Key.originName?c("x.Key.originName"):null===e.Key.originName?c("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0),t}toString(){let t=this.orderedItems,e=new p;for(let n=0;n<t.length;n++){n>0&&e.Append(", ");let i=t[n].Key;if(null===i.itemName)return c("item.itemName");e.Append(i.itemName)}return e.toString()}valueOf(){return NaN}}class g extends Error{constructor(t){super(t),this.useEndLineNumber=!1,this.message=t,this.name="StoryException"}}function C(t,e,n){if(null===t)return{result:n,exists:!1};let i=t.get(e);return i?{result:i,exists:!0}:{result:n,exists:!1}}class v extends d{static Create(e){if("boolean"==typeof e){e=!!e?1:0}return Number.isInteger(Number(e))?new y(Number(e)):isNaN(e)?"string"==typeof e?new b(String(e)):e instanceof t?new _(r(e,t)):e instanceof f?new E(r(e,f)):null:new T(Number(e))}Copy(){return r(v.Create(this),d)}BadCastException(t){return new g("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}class S extends v{constructor(t){super(),this.value=t}get valueObject(){return this.value}toString(){return null===this.value?c("Value.value"):this.value.toString()}}class y extends S{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return n.Int}Cast(t){if(null===this.value)return c("Value.value");if(t==this.valueType)return this;if(t==n.Float)return new T(this.value);if(t==n.String)return new b(""+this.value);throw this.BadCastException(t)}}class T extends S{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return n.Float}Cast(t){if(null===this.value)return c("Value.value");if(t==this.valueType)return this;if(t==n.Int)return new y(this.value);if(t==n.String)return new b(""+this.value);throw this.BadCastException(t)}}class b extends S{constructor(t){if(super(t||""),this._isNewline="\n"==this.value,this._isInlineWhitespace=!0,null===this.value)return c("Value.value");this.value.length>0&&this.value.split("").every(t=>" "==t||"\t"==t||(this._isInlineWhitespace=!1,!1))}get valueType(){return n.String}get isTruthy(){return null===this.value?c("Value.value"):this.value.length>0}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(t){if(t==this.valueType)return this;if(t==n.Int){let e=function(t,e=0){let n=parseInt(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(e.exists)return new y(e.result);throw this.BadCastException(t)}if(t==n.Float){let e=function(t,e=0){let n=parseFloat(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(e.exists)return new T(e.result);throw this.BadCastException(t)}throw this.BadCastException(t)}}class _ extends S{constructor(t){super(t)}get valueType(){return n.DivertTarget}get targetPath(){return null===this.value?c("Value.value"):this.value}set targetPath(t){this.value=t}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a divert target")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"DivertTargetValue("+this.targetPath+")"}}class w extends S{constructor(t,e=-1){super(t),this._contextIndex=e}get contextIndex(){return this._contextIndex}set contextIndex(t){this._contextIndex=t}get variableName(){return null===this.value?c("Value.value"):this.value}set variableName(t){this.value=t}get valueType(){return n.VariablePointer}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"VariablePointerValue("+this.variableName+")"}Copy(){return new w(this.variableName,this.contextIndex)}}class E extends S{get isTruthy(){return null===this.value?c("this.value"):this.value.Count>0}get valueType(){return n.List}Cast(t){if(null===this.value)return c("Value.value");if(t==n.Int){let t=this.value.maxItem;return t.Key.isNull?new y(0):new y(t.Value)}if(t==n.Float){let t=this.value.maxItem;return t.Key.isNull?new T(0):new T(t.Value)}if(t==n.String){let t=this.value.maxItem;return t.Key.isNull?new b(""):new b(t.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}constructor(t,e){super(null),t||e?t instanceof f?this.value=new f(t):t instanceof m&&"number"==typeof e&&(this.value=new f({Key:t,Value:e})):this.value=new f}static RetainListOriginsForAssignment(t,e){let n=a(t,E),i=a(e,E);return i&&null===i.value?c("newList.value"):n&&null===n.value?c("oldList.value"):void(n&&i&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames))}}!function(t){t[t.Int=0]="Int",t[t.Float=1]="Float",t[t.List=2]="List",t[t.String=3]="String",t[t.DivertTarget=4]="DivertTarget",t[t.VariablePointer=5]="VariablePointer"}(n||(n={}));class N{constructor(){this.obj=null,this.approximate=!1}get correctObj(){return this.approximate?null:this.obj}get container(){return this.obj instanceof x?this.obj:null}copy(){let t=new N;return t.obj=this.obj,t.approximate=this.approximate,t}}class x extends d{constructor(){super(...arguments),this.name="",this._content=[],this.namedContent=new Map,this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this._pathToFirstLeafContent=null}get hasValidName(){return null!=this.name&&this.name.length>0}get content(){return this._content}set content(t){this.AddContent(t)}get namedOnlyContent(){let t=new Map;for(let[e,n]of this.namedContent){let i=r(n,d);t.set(e,i)}for(let e of this.content){let n=l(e);null!=n&&n.hasValidName&&t.delete(n.name)}return 0==t.size&&(t=null),t}set namedOnlyContent(t){let e=this.namedOnlyContent;if(null!=e)for(let[t,n]of e)this.namedContent.delete(t);if(null!=t)for(let[e,n]of t){let t=l(n);null!=t&&this.AddToNamedContentOnly(t)}}get countFlags(){let t=0;return this.visitsShouldBeCounted&&(t|=x.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=x.CountFlags.Turns),this.countingAtStartOnly&&(t|=x.CountFlags.CountStartOnly),t==x.CountFlags.CountStartOnly&&(t=0),t}set countFlags(t){let e=t;(e&x.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&x.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&x.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}get pathToFirstLeafContent(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){let e=[],n=this;for(;n instanceof x;)n.content.length>0&&(e.push(new t.Component(0)),n=n.content[0]);return new t(e)}AddContent(t){if(t instanceof Array){let e=t;for(let t of e)this.AddContent(t)}else{let e=t;if(this._content.push(e),e.parent)throw new Error("content is already in "+e.parent);e.parent=this,this.TryAddNamedContent(e)}}TryAddNamedContent(t){let e=l(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}AddToNamedContentOnly(t){e.AssertType(t,d,"Can only add Runtime.Objects to a Runtime.Container"),r(t,d).parent=this,this.namedContent.set(t.name,t)}ContentAtPath(t,e=0,n=-1){-1==n&&(n=t.length);let i=new N;i.approximate=!1;let r=this,s=this;for(let l=e;l<n;++l){let e=t.GetComponent(l);if(null==r){i.approximate=!0;break}let n=r.ContentWithPathComponent(e);if(null==n){i.approximate=!0;break}s=n,r=a(n,x)}return i.obj=s,i}InsertContent(t,e){if(this.content[e]=t,t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}AddContentsOfContainer(t){this.content=this.content.concat(t.content);for(let e of t.content)e.parent=this,this.TryAddNamedContent(e)}ContentWithPathComponent(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;{if(null===t.name)return c("component.name");let e=C(this.namedContent,t.name,null);return e.exists?r(e.result,d):null}}BuildStringOfHierarchy(){let t;if(0==arguments.length)return t=new p,this.BuildStringOfHierarchy(t,0,null),t.toString();t=arguments[0];let n=arguments[1],i=arguments[2];function a(){for(let e=0;e<4*n;++e)t.Append(" ")}a(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==i&&t.Append("  <---"),t.AppendLine(),n++;for(let e=0;e<this.content.length;++e){let r=this.content[e];if(r instanceof x){r.BuildStringOfHierarchy(t,n,i)}else a(),r instanceof b?(t.Append('"'),t.Append(r.toString().replace("\n","\\n")),t.Append('"')):t.Append(r.toString());e!=this.content.length-1&&t.Append(","),r instanceof x||r!=i||t.Append("  <---"),t.AppendLine()}let s=new Map;for(let[t,e]of this.namedContent)this.content.indexOf(r(e,d))>=0||s.set(t,e);if(s.size>0){a(),t.AppendLine("-- named: --");for(let[a,r]of s){e.AssertType(r,x,"Can only print out named Containers"),r.BuildStringOfHierarchy(t,n,i),t.AppendLine()}}n--,a(),t.Append("]")}}!function(t){let e;!function(t){t[t.Visits=1]="Visits",t[t.Turns=2]="Turns",t[t.CountStartOnly=4]="CountStartOnly"}(e=t.CountFlags||(t.CountFlags={}))}(x||(x={}));class O extends d{toString(){return"Glue"}}class P extends d{get commandType(){return this._commandType}constructor(t=P.CommandType.NotSet){super(),this._commandType=t}Copy(){return new P(this.commandType)}static EvalStart(){return new P(P.CommandType.EvalStart)}static EvalOutput(){return new P(P.CommandType.EvalOutput)}static EvalEnd(){return new P(P.CommandType.EvalEnd)}static Duplicate(){return new P(P.CommandType.Duplicate)}static PopEvaluatedValue(){return new P(P.CommandType.PopEvaluatedValue)}static PopFunction(){return new P(P.CommandType.PopFunction)}static PopTunnel(){return new P(P.CommandType.PopTunnel)}static BeginString(){return new P(P.CommandType.BeginString)}static EndString(){return new P(P.CommandType.EndString)}static NoOp(){return new P(P.CommandType.NoOp)}static ChoiceCount(){return new P(P.CommandType.ChoiceCount)}static Turns(){return new P(P.CommandType.Turns)}static TurnsSince(){return new P(P.CommandType.TurnsSince)}static ReadCount(){return new P(P.CommandType.ReadCount)}static Random(){return new P(P.CommandType.Random)}static SeedRandom(){return new P(P.CommandType.SeedRandom)}static VisitIndex(){return new P(P.CommandType.VisitIndex)}static SequenceShuffleIndex(){return new P(P.CommandType.SequenceShuffleIndex)}static StartThread(){return new P(P.CommandType.StartThread)}static Done(){return new P(P.CommandType.Done)}static End(){return new P(P.CommandType.End)}static ListFromInt(){return new P(P.CommandType.ListFromInt)}static ListRange(){return new P(P.CommandType.ListRange)}static ListRandom(){return new P(P.CommandType.ListRandom)}toString(){return this.commandType.toString()}}!function(t){let e;!function(t){t[t.NotSet=-1]="NotSet",t[t.EvalStart=0]="EvalStart",t[t.EvalOutput=1]="EvalOutput",t[t.EvalEnd=2]="EvalEnd",t[t.Duplicate=3]="Duplicate",t[t.PopEvaluatedValue=4]="PopEvaluatedValue",t[t.PopFunction=5]="PopFunction",t[t.PopTunnel=6]="PopTunnel",t[t.BeginString=7]="BeginString",t[t.EndString=8]="EndString",t[t.NoOp=9]="NoOp",t[t.ChoiceCount=10]="ChoiceCount",t[t.Turns=11]="Turns",t[t.TurnsSince=12]="TurnsSince",t[t.Random=13]="Random",t[t.SeedRandom=14]="SeedRandom",t[t.VisitIndex=15]="VisitIndex",t[t.SequenceShuffleIndex=16]="SequenceShuffleIndex",t[t.StartThread=17]="StartThread",t[t.Done=18]="Done",t[t.End=19]="End",t[t.ListFromInt=20]="ListFromInt",t[t.ListRange=21]="ListRange",t[t.ListRandom=22]="ListRandom",t[t.ReadCount=23]="ReadCount",t[t.TOTAL_VALUES=24]="TOTAL_VALUES"}(e=t.CommandType||(t.CommandType={}))}(P||(P={})),function(t){t[t.Tunnel=0]="Tunnel",t[t.Function=1]="Function",t[t.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(i||(i={}));class A{constructor(){this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}Resolve(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}get isNull(){return null==this.container}get path(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new t.Component(this.index)):this.container.path}toString(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}copy(){return new A(this.container,this.index)}static StartOf(t){return new A(t,0)}static get Null(){return new A(null,-1)}}class k extends d{constructor(t){super(),this._targetPath=null,this._targetPointer=A.Null,this.variableDivertName=null,this.pushesToStack=!1,this.stackPushType=0,this.isExternal=!1,this.externalArgs=0,this.isConditional=!1,this.pushesToStack=!1,void 0!==t&&(this.pushesToStack=!0,this.stackPushType=t)}get targetPath(){if(null!=this._targetPath&&this._targetPath.isRelative){let t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath}set targetPath(t){this._targetPath=t,this._targetPointer=A.Null}get targetPointer(){if(this._targetPointer.isNull){let t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return c("this._targetPath");if(null===this._targetPath.lastComponent)return c("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return c("targetObj");this._targetPointer.container=t.parent instanceof x?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=A.StartOf(t instanceof x?t:null)}return this._targetPointer.copy()}get targetPathString(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)}set targetPathString(e){this.targetPath=null==e?null:new t(e)}get hasVariableTarget(){return null!=this.variableDivertName}Equals(t){let e=t;return e instanceof k&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:null===this.targetPath?c("this.targetPath"):this.targetPath.Equals(e.targetPath))}toString(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";{let t=new p,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==i.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}}class I extends d{constructor(t=!0){super(),this._pathOnChoice=null,this.hasCondition=!1,this.hasStartContent=!1,this.hasChoiceOnlyContent=!1,this.isInvisibleDefault=!1,this.onceOnly=!0,this.onceOnly=t}get pathOnChoice(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){let t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice}set pathOnChoice(t){this._pathOnChoice=t}get choiceTarget(){return null===this._pathOnChoice?c("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}get pathStringOnChoice(){return null===this.pathOnChoice?c("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(e){this.pathOnChoice=new t(e)}get flags(){let t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t}set flags(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}toString(){if(null===this.pathOnChoice)return c("ChoicePoint.pathOnChoice");return"Choice: -> "+this.pathOnChoice.toString()}}class F extends d{constructor(t=null){super(),this.pathForCount=null,this.name=t}get containerForCount(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}get pathStringForCount(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(e){this.pathForCount=null===e?null:new t(e)}toString(){if(null!=this.name)return"var("+this.name+")";return"read_count("+this.pathStringForCount+")"}}class V extends d{constructor(t,e){super(),this.variableName=t||null,this.isNewDeclaration=!!e,this.isGlobal=!1}toString(){return"VarAssign to "+this.variableName}}class L extends d{}class R extends d{constructor(){if(super(),this._name=null,this._numberOfParameters=0,this._prototype=null,this._isPrototype=!1,this._operationFuncs=null,0===arguments.length)R.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){let t=arguments[0];R.GenerateNativeFunctionsIfNecessary(),this.name=t}else if(2===arguments.length){let t=arguments[0],e=arguments[1];this._isPrototype=!0,this.name=t,this.numberOfParameters=e}}static CallWithName(t){return new R(t)}static CallExistsWithName(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}get name(){return null===this._name?c("NativeFunctionCall._name"):this._name}set name(t){this._name=t,this._isPrototype||(null===R._nativeFunctions?c("NativeFunctionCall._nativeFunctions"):this._prototype=R._nativeFunctions.get(this._name)||null)}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(t){this._numberOfParameters=t}Call(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");let e=!1;for(let n of t){if(n instanceof L)throw new g('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');n instanceof E&&(e=!0)}if(2==t.length&&e)return this.CallBinaryListOperation(t);let i=this.CoerceValuesToSingleType(t),a=i[0].valueType;return a==n.Int?this.CallType(i):a==n.Float?this.CallType(i):a==n.String?this.CallType(i):a==n.DivertTarget?this.CallType(i):a==n.List?this.CallType(i):null}CallType(t){let e=r(t[0],S),n=e.valueType,i=e,a=t.length;if(2==a||1==a){if(null===this._operationFuncs)return c("NativeFunctionCall._operationFuncs");let e=this._operationFuncs.get(n);if(!e)throw new g("Cannot perform operation "+this.name+" on "+n);if(2==a){let n=r(t[1],S),a=e;if(null===i.value||null===n.value)return c("NativeFunctionCall.Call BinaryOp values");let s=a(i.value,n.value);return S.Create(s)}{let t=e;if(null===i.value)return c("NativeFunctionCall.Call UnaryOp value");let n=t(i.value);return S.Create(n)}}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}CallBinaryListOperation(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof E&&t[1]instanceof y)return this.CallListIncrementOperation(t);let e=r(t[0],S),i=r(t[1],S);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==n.List&&i.valueType==n.List)){if(null===this._operationFuncs)return c("NativeFunctionCall._operationFuncs");let t=this._operationFuncs.get(n.Int);if(null===t)return c("NativeFunctionCall.CallBinaryListOperation op");let a=t(e.isTruthy?1:0,i.isTruthy?1:0);return new y(a)}if(e.valueType==n.List&&i.valueType==n.List)return this.CallType([e,i]);throw new g("Can not call use "+this.name+" operation on "+e.valueType+" and "+i.valueType)}CallListIncrementOperation(t){let e=r(t[0],E),i=r(t[1],y),a=new f;if(null===e.value)return c("NativeFunctionCall.CallListIncrementOperation listVal.value");for(let[t,r]of e.value){let s=m.fromSerializedKey(t);if(null===this._operationFuncs)return c("NativeFunctionCall._operationFuncs");let l=this._operationFuncs.get(n.Int);if(null===i.value)return c("NativeFunctionCall.CallListIncrementOperation intVal.value");let o=l(r,i.value),u=null;if(null===e.value.origins)return c("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");for(let t of e.value.origins)if(t.name==s.originName){u=t;break}if(null!=u){let t=u.TryGetItemWithValue(o,m.Null);t.exists&&a.Add(t.result,o)}}return new E(a)}CoerceValuesToSingleType(t){let e=n.Int,i=null;for(let s of t){let t=r(s,S);t.valueType>e&&(e=t.valueType),t.valueType==n.List&&(i=a(t,E))}let s=[];if(n[e]==n[n.List])for(let e of t){let t=r(e,S);if(t.valueType==n.List)s.push(t);else{if(t.valueType!=n.Int)throw new g("Cannot mix Lists and "+t.valueType+" values in this operation");{let e=parseInt(t.valueObject);if(null===(i=r(i,E)).value)return c("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");let n=i.value.originOfMaxItem;if(null===n)return c("NativeFunctionCall.CoerceValuesToSingleType list");let a=n.TryGetItemWithValue(e,m.Null);if(!a.exists)throw new g("Could not find List item with the value "+e+" in "+n.name);{let t=new E(a.result,e);s.push(t)}}}}else for(let n of t){let t=r(n,S).Cast(e);s.push(t)}return s}static Identity(t){return t}static GenerateNativeFunctionsIfNecessary(){if(null==this._nativeFunctions){this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(t,e)=>t+e),this.AddIntBinaryOp(this.Subtract,(t,e)=>t-e),this.AddIntBinaryOp(this.Multiply,(t,e)=>t*e),this.AddIntBinaryOp(this.Divide,(t,e)=>Math.round(t/e)),this.AddIntBinaryOp(this.Mod,(t,e)=>t%e),this.AddIntUnaryOp(this.Negate,t=>-t),this.AddIntBinaryOp(this.Equal,(t,e)=>t==e?1:0),this.AddIntBinaryOp(this.Greater,(t,e)=>t>e?1:0),this.AddIntBinaryOp(this.Less,(t,e)=>t<e?1:0),this.AddIntBinaryOp(this.GreaterThanOrEquals,(t,e)=>t>=e?1:0),this.AddIntBinaryOp(this.LessThanOrEquals,(t,e)=>t<=e?1:0),this.AddIntBinaryOp(this.NotEquals,(t,e)=>t!=e?1:0),this.AddIntUnaryOp(this.Not,t=>0==t?1:0),this.AddIntBinaryOp(this.And,(t,e)=>0!=t&&0!=e?1:0),this.AddIntBinaryOp(this.Or,(t,e)=>0!=t||0!=e?1:0),this.AddIntBinaryOp(this.Max,(t,e)=>Math.max(t,e)),this.AddIntBinaryOp(this.Min,(t,e)=>Math.min(t,e)),this.AddIntBinaryOp(this.Pow,(t,e)=>Math.pow(t,e)),this.AddIntUnaryOp(this.Floor,R.Identity),this.AddIntUnaryOp(this.Ceiling,R.Identity),this.AddIntUnaryOp(this.Int,R.Identity),this.AddIntUnaryOp(this.Float,t=>t),this.AddFloatBinaryOp(this.Add,(t,e)=>t+e),this.AddFloatBinaryOp(this.Subtract,(t,e)=>t-e),this.AddFloatBinaryOp(this.Multiply,(t,e)=>t*e),this.AddFloatBinaryOp(this.Divide,(t,e)=>t/e),this.AddFloatBinaryOp(this.Mod,(t,e)=>t%e),this.AddFloatUnaryOp(this.Negate,t=>-t),this.AddFloatBinaryOp(this.Equal,(t,e)=>t==e?1:0),this.AddFloatBinaryOp(this.Greater,(t,e)=>t>e?1:0),this.AddFloatBinaryOp(this.Less,(t,e)=>t<e?1:0),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(t,e)=>t>=e?1:0),this.AddFloatBinaryOp(this.LessThanOrEquals,(t,e)=>t<=e?1:0),this.AddFloatBinaryOp(this.NotEquals,(t,e)=>t!=e?1:0),this.AddFloatUnaryOp(this.Not,t=>0==t?1:0),this.AddFloatBinaryOp(this.And,(t,e)=>0!=t&&0!=e?1:0),this.AddFloatBinaryOp(this.Or,(t,e)=>0!=t||0!=e?1:0),this.AddFloatBinaryOp(this.Max,(t,e)=>Math.max(t,e)),this.AddFloatBinaryOp(this.Min,(t,e)=>Math.min(t,e)),this.AddFloatBinaryOp(this.Pow,(t,e)=>Math.pow(t,e)),this.AddFloatUnaryOp(this.Floor,t=>Math.floor(t)),this.AddFloatUnaryOp(this.Ceiling,t=>Math.ceil(t)),this.AddFloatUnaryOp(this.Int,t=>Math.floor(t)),this.AddFloatUnaryOp(this.Float,R.Identity),this.AddStringBinaryOp(this.Add,(t,e)=>t+e),this.AddStringBinaryOp(this.Equal,(t,e)=>t===e?1:0),this.AddStringBinaryOp(this.NotEquals,(t,e)=>t!==e?1:0),this.AddStringBinaryOp(this.Has,(t,e)=>t.includes(e)?1:0),this.AddStringBinaryOp(this.Hasnt,(t,e)=>t.includes(e)?0:1),this.AddListBinaryOp(this.Add,(t,e)=>t.Union(e)),this.AddListBinaryOp(this.Subtract,(t,e)=>t.Without(e)),this.AddListBinaryOp(this.Has,(t,e)=>t.Contains(e)?1:0),this.AddListBinaryOp(this.Hasnt,(t,e)=>t.Contains(e)?0:1),this.AddListBinaryOp(this.Intersect,(t,e)=>t.Intersect(e)),this.AddListBinaryOp(this.Equal,(t,e)=>t.Equals(e)?1:0),this.AddListBinaryOp(this.Greater,(t,e)=>t.GreaterThan(e)?1:0),this.AddListBinaryOp(this.Less,(t,e)=>t.LessThan(e)?1:0),this.AddListBinaryOp(this.GreaterThanOrEquals,(t,e)=>t.GreaterThanOrEquals(e)?1:0),this.AddListBinaryOp(this.LessThanOrEquals,(t,e)=>t.LessThanOrEquals(e)?1:0),this.AddListBinaryOp(this.NotEquals,(t,e)=>t.Equals(e)?0:1),this.AddListBinaryOp(this.And,(t,e)=>t.Count>0&&e.Count>0?1:0),this.AddListBinaryOp(this.Or,(t,e)=>t.Count>0||e.Count>0?1:0),this.AddListUnaryOp(this.Not,t=>0==t.Count?1:0),this.AddListUnaryOp(this.Invert,t=>t.inverse),this.AddListUnaryOp(this.All,t=>t.all),this.AddListUnaryOp(this.ListMin,t=>t.MinAsList()),this.AddListUnaryOp(this.ListMax,t=>t.MaxAsList()),this.AddListUnaryOp(this.Count,t=>t.Count),this.AddListUnaryOp(this.ValueOfList,t=>t.maxItem.Value);let t=(t,e)=>t.Equals(e)?1:0,e=(t,e)=>t.Equals(e)?0:1;this.AddOpToNativeFunc(this.Equal,2,n.DivertTarget,t),this.AddOpToNativeFunc(this.NotEquals,2,n.DivertTarget,e)}}AddOpFuncForType(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}static AddOpToNativeFunc(t,e,n,i){if(null===this._nativeFunctions)return c("NativeFunctionCall._nativeFunctions");let a=this._nativeFunctions.get(t);a||(a=new R(t,e),this._nativeFunctions.set(t,a)),a.AddOpFuncForType(n,i)}static AddIntBinaryOp(t,e){this.AddOpToNativeFunc(t,2,n.Int,e)}static AddIntUnaryOp(t,e){this.AddOpToNativeFunc(t,1,n.Int,e)}static AddFloatBinaryOp(t,e){this.AddOpToNativeFunc(t,2,n.Float,e)}static AddFloatUnaryOp(t,e){this.AddOpToNativeFunc(t,1,n.Float,e)}static AddStringBinaryOp(t,e){this.AddOpToNativeFunc(t,2,n.String,e)}static AddListBinaryOp(t,e){this.AddOpToNativeFunc(t,2,n.List,e)}static AddListUnaryOp(t,e){this.AddOpToNativeFunc(t,1,n.List,e)}toString(){return'Native "'+this.name+'"'}}R.Add="+",R.Subtract="-",R.Divide="/",R.Multiply="*",R.Mod="%",R.Negate="_",R.Equal="==",R.Greater=">",R.Less="<",R.GreaterThanOrEquals=">=",R.LessThanOrEquals="<=",R.NotEquals="!=",R.Not="!",R.And="&&",R.Or="||",R.Min="MIN",R.Max="MAX",R.Pow="POW",R.Floor="FLOOR",R.Ceiling="CEILING",R.Int="INT",R.Float="FLOAT",R.Has="?",R.Hasnt="!?",R.Intersect="^",R.ListMin="LIST_MIN",R.ListMax="LIST_MAX",R.All="LIST_ALL",R.Count="LIST_COUNT",R.ValueOfList="LIST_VALUE",R.Invert="LIST_INVERT",R._nativeFunctions=null;class D extends d{constructor(t){super(),this.text=t.toString()||""}toString(){return"# "+this.text}}class M extends d{constructor(){super(...arguments),this.text="",this.index=0,this.threadAtGeneration=null,this.sourcePath="",this.targetPath=null,this.isInvisibleDefault=!1,this.originalThreadIndex=0}get pathStringOnChoice(){return null===this.targetPath?c("Choice.targetPath"):this.targetPath.toString()}set pathStringOnChoice(e){this.targetPath=new t(e)}}class B{constructor(t,e){this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}get name(){return this._name}get items(){if(null==this._items){this._items=new Map;for(let[t,e]of this._itemNameToValues){let n=new m(this.name,t);this._items.set(n.serialized(),e)}}return this._items}ValueForItem(t){if(!t.itemName)return 0;let e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}ContainsItem(t){return!!t.itemName&&(t.originName==this.name&&this._itemNameToValues.has(t.itemName))}ContainsItemWithName(t){return this._itemNameToValues.has(t)}TryGetItemWithValue(t,e){for(let[e,n]of this._itemNameToValues)if(n==t)return{result:new m(this.name,e),exists:!0};return{result:m.Null,exists:!1}}TryGetValueForItem(t,e){if(!t.itemName)return{result:0,exists:!1};let n=this._itemNameToValues.get(t.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}}class G{constructor(t){this._lists=new Map,this._allUnambiguousListValueCache=new Map;for(let e of t){this._lists.set(e.name,e);for(let[t,n]of e.items){let e=m.fromSerializedKey(t),i=new E(e,n);if(!e.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(e.itemName,i),this._allUnambiguousListValueCache.set(e.fullName,i)}}}get lists(){let t=[];for(let[e,n]of this._lists)t.push(n);return t}TryListGetDefinition(t,e){if(null===t)return{result:e,exists:!1};let n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}FindSingleItemListWithName(t){if(null===t)return c("name");let e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}}class W{static ListToJArray(t){let e=[];for(let n of t)e.push(this.RuntimeObjectToJToken(n));return e}static JArrayToRuntimeObjList(t,e=!1){let n=t.length;e&&n--;let i=[];for(let e=0;e<n;e++){let n=t[e],a=this.JTokenToRuntimeObject(n);if(null===a)return c("runtimeObj");i.push(a)}return i}static DictionaryRuntimeObjsToJObject(t){let e={};for(let[n,i]of t){let t=a(i,d);null!=t&&(e[n]=this.RuntimeObjectToJToken(t))}return e}static JObjectToDictionaryRuntimeObjs(t){let e=new Map;for(let n in t)if(t.hasOwnProperty(n)){let i=this.JTokenToRuntimeObject(t[n]);if(null===i)return c("inkObject");e.set(n,i)}return e}static JObjectToIntDictionary(t){let e=new Map;for(let n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}static IntDictionaryToJObject(t){let e={};for(let[n,i]of t)e[n]=s(i);return e}static JTokenToRuntimeObject(e){if("number"==typeof e&&!isNaN(e))return S.Create(e);if("string"==typeof e){let t=e.toString(),n=t[0];if("^"==n)return new b(t.substring(1));if("\n"==n&&1==t.length)return new b("\n");if("<>"==t)return new O;for(let e=0;e<W._controlCommandNames.length;++e){if(t==W._controlCommandNames[e])return new P(e)}if("L^"==t&&(t="^"),R.CallExistsWithName(t))return R.CallWithName(t);if("->->"==t)return P.PopTunnel();if("~ret"==t)return P.PopFunction();if("void"==t)return new L}if("object"==typeof e&&e instanceof Array==!1){let n,a=e;if(a["^->"])return n=a["^->"],new _(new t(n.toString()));if(a["^var"]){n=a["^var"];let t=new w(n.toString());return"ci"in a&&(n=a.ci,t.contextIndex=parseInt(n)),t}let r=!1,s=!1,l=i.Function,o=!1;if((n=a["->"])?r=!0:(n=a["f()"])?(r=!0,s=!0,l=i.Function):(n=a["->t->"])?(r=!0,s=!0,l=i.Tunnel):(n=a["x()"])&&(r=!0,o=!0,s=!1,l=i.Function),r){let t=new k;t.pushesToStack=s,t.stackPushType=l,t.isExternal=o;let e=n.toString();return(n=a.var)?t.variableDivertName=e:t.targetPathString=e,t.isConditional=!!a.c,o&&(n=a.exArgs)&&(t.externalArgs=parseInt(n)),t}if(n=a["*"]){let t=new I;return t.pathStringOnChoice=n.toString(),(n=a.flg)&&(t.flags=parseInt(n)),t}if(n=a["VAR?"])return new F(n.toString());if(n=a["CNT?"]){let t=new F;return t.pathStringForCount=n.toString(),t}let u=!1,h=!1;if((n=a["VAR="])?(u=!0,h=!0):(n=a["temp="])&&(u=!0,h=!1),u){let t=n.toString(),e=!a.re,i=new V(t,e);return i.isGlobal=h,i}if(void 0!==a["#"])return n=a["#"],new D(n.toString());if(n=a.list){let t=n,e=new f;if(n=a.origins){let t=n;e.SetInitialOriginNames(t)}for(let n in t)if(t.hasOwnProperty(n)){let i=t[n],a=new m(n),r=parseInt(i);e.Add(a,r)}return new E(e)}if(null!=a.originalChoicePath)return this.JObjectToChoice(a)}if(e instanceof Array)return this.JArrayToContainer(e);if(null==e)return null;throw new Error("Failed to convert token to runtime object: "+JSON.stringify(e))}static RuntimeObjectToJToken(t){let e=a(t,x);if(e)return this.ContainerToJArray(e);let n=a(t,k);if(n){let t,e="->";n.isExternal?e="x()":n.pushesToStack&&(n.stackPushType==i.Function?e="f()":n.stackPushType==i.Tunnel&&(e="->t->")),t=n.hasVariableTarget?n.variableDivertName:n.targetPathString;let a={};return a[e]=t,n.hasVariableTarget&&(a.var=!0),n.isConditional&&(a.c=!0),n.externalArgs>0&&(a.exArgs=n.externalArgs),a}let r=a(t,I);if(r){let t={};return t["*"]=r.pathStringOnChoice,t.flg=r.flags,t}let s=a(t,y);if(s)return s.value;let l=a(t,T);if(l)return l.value;let o=a(t,b);if(o)return o.isNewline?"\n":"^"+o.value;let u=a(t,E);if(u)return this.InkListToJObject(u);let h=a(t,_);if(h){let t={};return null===h.value?c("divTargetVal.value"):(t["^->"]=h.value.componentsString,t)}let d=a(t,w);if(d){let t={};return t["^var"]=d.value,t.ci=d.contextIndex,t}if(a(t,O))return"<>";let p=a(t,P);if(p)return W._controlCommandNames[p.commandType];let m=a(t,R);if(m){let t=m.name;return"^"==t&&(t="L^"),t}let f=a(t,F);if(f){let t={},e=f.pathStringForCount;return null!=e?t["CNT?"]=e:t["VAR?"]=f.name,t}let g=a(t,V);if(g){let t={};return t[g.isGlobal?"VAR=":"temp="]=g.variableName,g.isNewDeclaration||(t.re=!0),t}if(a(t,L))return"void";let C=a(t,D);if(C){let t={};return t["#"]=C.text,t}let v=a(t,M);if(v)return this.ChoiceToJObject(v);throw new Error("Failed to convert runtime object to Json token: "+t)}static ContainerToJArray(t){let e=this.ListToJArray(t.content),n=t.namedOnlyContent,i=t.countFlags;if(null!=n&&n.size>0||i>0||null!=t.name){let a;if(null!=n){a=this.DictionaryRuntimeObjsToJObject(n);for(let t in a)if(a.hasOwnProperty(t)){let e=a[t];if(null!=e){let t=e[e.length-1];null!=t&&(delete t["#n"],0==Object.keys(t).length&&(e[e.length-1]=null))}}}else a={};i>0&&(a["#f"]=i),null!=t.name&&(a["#n"]=t.name),e.push(a)}else e.push(null);return e}static JArrayToContainer(t){let e=new x;e.content=this.JArrayToRuntimeObjList(t,!0);let n=t[t.length-1];if(null!=n){let t=new Map;for(let i in n)if("#f"==i)e.countFlags=parseInt(n[i]);else if("#n"==i)e.name=n[i].toString();else{let e=this.JTokenToRuntimeObject(n[i]),r=a(e,x);r&&(r.name=i),t.set(i,e)}e.namedOnlyContent=t}return e}static JObjectToChoice(t){let e=new M;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}static ChoiceToJObject(t){let e={};return e.text=t.text,e.index=t.index,e.originalChoicePath=t.sourcePath,e.originalThreadIndex=t.originalThreadIndex,e.targetPath=t.pathStringOnChoice,e}static InkListToJObject(t){let e=t.value;if(null===e)return c("rawList");let n={},i={};for(let[t,n]of e){i[m.fromSerializedKey(t).toString()]=n}return n.list=i,0==e.Count&&null!=e.originNames&&e.originNames.length>0&&(n.origins=e.originNames),n}static ListDefinitionsToJToken(t){let e={};for(let n of t.lists){let t={};for(let[e,i]of n.items){let n=m.fromSerializedKey(e);if(null===n.itemName)return c("item.itemName");t[n.itemName]=i}e[n.name]=t}return e}static JTokenToListDefinitions(t){let e=t,n=[];for(let t in e)if(e.hasOwnProperty(t)){let i=t.toString(),a=e[t],r=new Map;for(let n in a)if(e.hasOwnProperty(t)){let t=a[n];r.set(n,parseInt(t))}let s=new B(i,r);n.push(s)}return new G(n)}}W._controlCommandNames=(()=>{let t=[];t[P.CommandType.EvalStart]="ev",t[P.CommandType.EvalOutput]="out",t[P.CommandType.EvalEnd]="/ev",t[P.CommandType.Duplicate]="du",t[P.CommandType.PopEvaluatedValue]="pop",t[P.CommandType.PopFunction]="~ret",t[P.CommandType.PopTunnel]="->->",t[P.CommandType.BeginString]="str",t[P.CommandType.EndString]="/str",t[P.CommandType.NoOp]="nop",t[P.CommandType.ChoiceCount]="choiceCnt",t[P.CommandType.Turns]="turn",t[P.CommandType.TurnsSince]="turns",t[P.CommandType.ReadCount]="readc",t[P.CommandType.Random]="rnd",t[P.CommandType.SeedRandom]="srnd",t[P.CommandType.VisitIndex]="visit",t[P.CommandType.SequenceShuffleIndex]="seq",t[P.CommandType.StartThread]="thread",t[P.CommandType.Done]="done",t[P.CommandType.End]="end",t[P.CommandType.ListFromInt]="listInt",t[P.CommandType.ListRange]="range",t[P.CommandType.ListRandom]="lrnd";for(let e=0;e<P.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t})();class j{constructor(){if(this._threadCounter=0,arguments[0]instanceof x||null===arguments[0]){let t=arguments[0];this._threads=[],this._threads.push(new j.Thread),this._threads[0].callstack.push(new j.Element(i.Tunnel,A.StartOf(t)))}else{let t=arguments[0];this._threads=[];for(let e of t._threads)this._threads.push(e.Copy())}}get elements(){return this.callStack}get depth(){return this.elements.length}get currentElement(){let t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}get currentElementIndex(){return this.callStack.length-1}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(t){e.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}get canPop(){return this.callStack.length>1}SetJsonToken(t,e){this._threads.length=0;let n=t.threads;for(let t of n){let n=t,i=new j.Thread(n,e);this._threads.push(i)}this._threadCounter=parseInt(t.threadCounter)}GetJsonToken(){let t={},e=[];for(let t of this._threads)e.push(t.jsonToken);return t.threads=e,t.threadCounter=this._threadCounter,t}PushThread(){let t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}PopThread(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}get canPopThread(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}get elementIsEvaluateFromGame(){return this.currentElement.type==i.FunctionEvaluationFromGame}Push(t,e=0,n=0){let i=new j.Element(t,this.currentElement.currentPointer,!1);i.evaluationStackHeightWhenPushed=e,i.functionStartInOutputStream=n,this.callStack.push(i)}CanPop(t=null){return!!this.canPop&&(null==t||this.currentElement.type==t)}Pop(t=null){if(!this.CanPop(t))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}GetTemporaryVariableWithName(t,e=-1){-1==e&&(e=this.currentElementIndex+1);let n=C(this.callStack[e-1].temporaryVariables,t,null);return n.exists?n.result:null}SetTemporaryVariable(t,e,n,i=-1){-1==i&&(i=this.currentElementIndex+1);let a=this.callStack[i-1];if(!n&&!a.temporaryVariables.get(t))throw new g("Could not find temporary variable to set: "+t);let r=C(a.temporaryVariables,t,null);r.exists&&E.RetainListOriginsForAssignment(r.result,e),a.temporaryVariables.set(t,e)}ContextForVariableNamed(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}ThreadWithIndex(t){return this._threads.filter(e=>{if(e.threadIndex==t)return e})[0]}get callStack(){return this.currentThread.callstack}get callStackTrace(){let t=new p;for(let e=0;e<this._threads.length;e++){let n=this._threads[e],a=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,a?"(current) ":"");for(let e=0;e<n.callstack.length;e++){n.callstack[e].type==i.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");let a=n.callstack[e].currentPointer;if(!a.isNull){if(t.Append("<SOMEWHERE IN "),null===a.container)return c("pointer.container");t.Append(a.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}!function(e){class n{constructor(t,e,n=!1){this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=e.copy(),this.inExpressionEvaluation=n,this.temporaryVariables=new Map,this.type=t}Copy(){let t=new n(this.type,this.currentPointer,this.inExpressionEvaluation);return t.temporaryVariables=new Map(this.temporaryVariables),t.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,t.functionStartInOutputStream=this.functionStartInOutputStream,t}}e.Element=n;class i{constructor(){if(this.threadIndex=0,this.previousPointer=A.Null,this.callstack=[],arguments[0]&&arguments[1]){let e=arguments[0],i=arguments[1];this.threadIndex=parseInt(e.threadIndex);let a=e.callstack;for(let e of a){let a,r=e,s=parseInt(r.type),l=A.Null,o=r.cPath;if(void 0!==o){a=o.toString();let e=i.ContentAtPath(new t(a));if(l.container=e.container,l.index=parseInt(r.idx),null==e.obj)throw new Error("When loading state, internal story location couldn't be found: "+a+". Has the story changed since this save data was created?");if(e.approximate){if(null===l.container)return c("pointer.container");i.Warning("When loading state, exact internal story location couldn't be found: '"+a+"', so it was approximated to '"+l.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}let u=!!r.exp,h=new n(s,l,u),d=r.temp;h.temporaryVariables=W.JObjectToDictionaryRuntimeObjs(d),this.callstack.push(h)}let r=e.previousContentObject;if(void 0!==r){let e=new t(r.toString());this.previousPointer=i.PointerAtPath(e)}}}Copy(){let t=new i;t.threadIndex=this.threadIndex;for(let e of this.callstack)t.callstack.push(e.Copy());return t.previousPointer=this.previousPointer.copy(),t}get jsonToken(){let t={},e=[];for(let t of this.callstack){let n={};if(!t.currentPointer.isNull){if(null===t.currentPointer.container)return c("el.currentPointer.container");n.cPath=t.currentPointer.container.path.componentsString,n.idx=t.currentPointer.index}n.exp=t.inExpressionEvaluation,n.type=t.type,n.temp=W.DictionaryRuntimeObjsToJObject(t.temporaryVariables),e.push(n)}if(t.callstack=e,t.threadIndex=this.threadIndex,!this.previousPointer.isNull){let e=this.previousPointer.Resolve();if(null===e)return c("this.previousPointer.Resolve()");t.previousContentObject=e.path.toString()}return t}}e.Thread=i}(j||(j={}));class J{constructor(t,e){this.variableChangedEventCallbacks=[],this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariables=new Set,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=e;try{return new Proxy(this,{get:(t,e)=>e in t?t[e]:t.$(e),set:(t,e,n)=>(e in t?t[e]=n:t.$(e,n),!0)})}catch(t){}}variableChangedEvent(t,e){for(let n of this.variableChangedEventCallbacks)n(t,e)}get batchObservingVariableChanges(){return this._batchObservingVariableChanges}set batchObservingVariableChanges(t){if(this._batchObservingVariableChanges=t,t)this._changedVariables=new Set;else if(null!=this._changedVariables)for(let t of this._changedVariables){let e=this._globalVariables.get(t);e?this.variableChangedEvent(t,e):c("currentValue")}}get callStack(){return this._callStack}set callStack(t){this._callStack=t}$(t,e){if(void 0===e){let e=this._globalVariables.get(t);return void 0===e&&(e=this._defaultGlobalVariables.get(t)),void 0!==e?e.valueObject:null}{if(void 0===this._defaultGlobalVariables.get(t))throw new g("Cannot assign to a variable ("+t+") that hasn't been declared in the story");let n=S.Create(e);if(null==n)throw new g(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,n)}}CopyFrom(t){if(this._globalVariables=new Map(t._globalVariables),this._defaultGlobalVariables=new Map(t._defaultGlobalVariables),this.variableChangedEvent=t.variableChangedEvent,t.batchObservingVariableChanges!=this.batchObservingVariableChanges)if(t.batchObservingVariableChanges){if(this._batchObservingVariableChanges=!0,null===t._changedVariables)return c("toCopy._changedVariables");this._changedVariables=new Set(t._changedVariables)}else this._batchObservingVariableChanges=!1,this._changedVariables=null}get jsonToken(){return W.DictionaryRuntimeObjsToJObject(this._globalVariables)}set jsonToken(t){this._globalVariables=W.JObjectToDictionaryRuntimeObjs(t)}TryGetDefaultVariableValue(t){let e=C(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}GlobalVariableExistsWithName(t){return this._globalVariables.has(t)}GetVariableWithName(t,e=-1){let n=this.GetRawVariableWithName(t,e),i=a(n,w);return null!==i&&(n=this.ValueAtVariablePointer(i)),n}GetRawVariableWithName(t,e){let n=null;if(0==e||-1==e){let e=C(this._globalVariables,t,null);if(e.exists)return e.result;if(null===this._listDefsOrigin)return c("VariablesState._listDefsOrigin");let n=this._listDefsOrigin.FindSingleItemListWithName(t);if(n)return n}return n=this._callStack.GetTemporaryVariableWithName(t,e)}ValueAtVariablePointer(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}Assign(t,e){let n=t.variableName;if(null===n)return c("name");let i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this._globalVariables.has(n),t.isNewDeclaration){let t=a(e,w);if(null!==t){e=this.ResolveVariablePointer(t)}}else{let t=null;do{null!=(t=a(this.GetRawVariableWithName(n,i),w))&&(n=t.variableName,r=0==(i=t.contextIndex))}while(null!=t)}r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}SnapshotDefaultGlobals(){this._defaultGlobalVariables=new Map(this._globalVariables)}RetainListOriginsForAssignment(t,e){let n=r(t,E),i=r(e,E);n.value&&i.value&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}SetGlobal(t,e){let n=C(this._globalVariables,t,null);if(n.exists&&E.RetainListOriginsForAssignment(n.result,e),null===t)return c("variableName");if(this._globalVariables.set(t,e),null!=this.variableChangedEvent&&e!==n.result)if(this.batchObservingVariableChanges){if(null===this._changedVariables)return c("this._changedVariables");this._changedVariables.add(t)}else this.variableChangedEvent(t,e)}ResolveVariablePointer(t){let e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));let n=a(this.GetRawVariableWithName(t.variableName,e),w);return null!=n?n:new w(t.variableName,e)}GetContextIndexOfVariableNamed(t){return this._globalVariables.get(t)?0:this._callStack.currentElementIndex}ObserveVariableChange(t){this.variableChangedEventCallbacks.push(t)}}class q{constructor(t){this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=16807*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}}class K{constructor(t){this.kInkSaveStateVersion=8,this.kMinCompatibleLoadVersion=8,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=A.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this.story=t,this._outputStream=[],this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new j(t.rootContentContainer),this._variablesState=new J(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this._currentTurnIndex=-1;let e=(new Date).getTime();this.storySeed=new q(e).next()%100,this.previousRandom=0,this._currentChoices=[],this.GoToStart()}ToJson(t=!1){return JSON.stringify(this.jsonToken,null,t?2:0)}toJson(t=!1){return this.ToJson(t)}LoadJson(t){this.jsonToken=JSON.parse(t)}VisitCountAtPathString(t){let e=C(this.visitCounts,t,null);return e.exists?e.result:0}get callstackDepth(){return this.callStack.depth}get outputStream(){return this._outputStream}get currentChoices(){return this.canContinue?[]:this._currentChoices}get generatedChoices(){return this._currentChoices}get currentErrors(){return this._currentErrors}get currentWarnings(){return this._currentWarnings}get variablesState(){return this._variablesState}get evaluationStack(){return this._evaluationStack}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}get currentTurnIndex(){return this._currentTurnIndex}get currentPathString(){let t=this.currentPointer;return t.isNull?null:null===t.path?c("pointer.path"):t.path.toString()}get currentPointer(){return this.callStack.currentElement.currentPointer.copy()}set currentPointer(t){this.callStack.currentElement.currentPointer=t.copy()}get previousPointer(){return this.callStack.currentThread.previousPointer.copy()}set previousPointer(t){this.callStack.currentThread.previousPointer=t.copy()}get canContinue(){return!this.currentPointer.isNull&&!this.hasError}get hasError(){return null!=this.currentErrors&&this.currentErrors.length>0}get hasWarning(){return null!=this.currentWarnings&&this.currentWarnings.length>0}get currentText(){if(this._outputStreamTextDirty){let t=new p;for(let e of this._outputStream){let n=a(e,b);null!==n&&t.Append(n.value)}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}CleanOutputWhitespace(t){let e=new p,n=-1,i=0;for(let a=0;a<t.length;a++){let r=t.charAt(a),s=" "==r||"\t"==r;s&&-1==n&&(n=a),s||("\n"!=r&&n>0&&n!=i&&e.Append(" "),n=-1),"\n"==r&&(i=a+1),s||e.Append(r)}return e.toString()}get currentTags(){if(this._outputStreamTagsDirty){this._currentTags=[];for(let t of this._outputStream){let e=a(t,D);null!==e&&this._currentTags.push(e.text)}this._outputStreamTagsDirty=!1}return this._currentTags}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(t){this.callStack.currentElement.inExpressionEvaluation=t}GoToStart(){this.callStack.currentElement.currentPointer=A.StartOf(this.story.mainContentContainer)}Copy(){let t=new K(this.story);return t.outputStream.push.apply(t.outputStream,this._outputStream),this.OutputStreamDirty(),t._currentChoices.push.apply(t._currentChoices,this._currentChoices),this.hasError&&(t._currentErrors=[],t._currentErrors.push.apply(t._currentErrors,this.currentErrors)),this.hasWarning&&(t._currentWarnings=[],t._currentWarnings.push.apply(t._currentWarnings,this.currentWarnings)),t.callStack=new j(this.callStack),t._variablesState=new J(t.callStack,this.story.listDefinitions),t.variablesState.CopyFrom(this.variablesState),t.evaluationStack.push.apply(t.evaluationStack,this.evaluationStack),this.divertedPointer.isNull||(t.divertedPointer=this.divertedPointer.copy()),t.previousPointer=this.previousPointer.copy(),t._visitCounts=new Map(this.visitCounts),t._turnIndices=new Map(this.turnIndices),t._currentTurnIndex=this.currentTurnIndex,t.storySeed=this.storySeed,t.previousRandom=this.previousRandom,t.didSafeExit=this.didSafeExit,t}get jsonToken(){let t,e={};for(let e of this._currentChoices){if(null===e.threadAtGeneration)return c("c.threadAtGeneration");e.originalThreadIndex=e.threadAtGeneration.threadIndex,null==this.callStack.ThreadWithIndex(e.originalThreadIndex)&&(null==t&&(t=new Map),t[e.originalThreadIndex.toString()]=e.threadAtGeneration.jsonToken)}if(null!=t&&(e.choiceThreads=t),e.callstackThreads=this.callStack.GetJsonToken(),e.variablesState=this.variablesState.jsonToken,e.evalStack=W.ListToJArray(this.evaluationStack),e.outputStream=W.ListToJArray(this._outputStream),e.currentChoices=W.ListToJArray(this._currentChoices),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return c("this.divertedPointer.path");e.currentDivertTarget=this.divertedPointer.path.componentsString}return e.visitCounts=W.IntDictionaryToJObject(this.visitCounts),e.turnIndices=W.IntDictionaryToJObject(this.turnIndices),e.turnIdx=this.currentTurnIndex,e.storySeed=this.storySeed,e.inkSaveVersion=this.kInkSaveStateVersion,e.inkFormatVersion=this.story.inkVersionCurrent,e}set jsonToken(e){let n=e,i=n.inkSaveVersion;if(null==i)throw new g("ink save format incorrect, can't load.");if(parseInt(i)<this.kMinCompatibleLoadVersion)throw new g("Ink save format isn't compatible with the current version (saw '"+i+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(n.callstackThreads,this.story),this.variablesState.jsonToken=n.variablesState,this._evaluationStack=W.JArrayToRuntimeObjList(n.evalStack),this._outputStream=W.JArrayToRuntimeObjList(n.outputStream),this.OutputStreamDirty(),this._currentChoices=W.JArrayToRuntimeObjList(n.currentChoices);let a=n.currentDivertTarget;if(null!=a){let e=new t(a.toString());this.divertedPointer=this.story.PointerAtPath(e)}this._visitCounts=W.JObjectToIntDictionary(n.visitCounts),this._turnIndices=W.JObjectToIntDictionary(n.turnIndices),this._currentTurnIndex=parseInt(n.turnIdx),this.storySeed=parseInt(n.storySeed);let r=n.choiceThreads;for(let t of this._currentChoices){let e=this.callStack.ThreadWithIndex(t.originalThreadIndex);if(null!=e)t.threadAtGeneration=e.Copy();else{let e=r[t.originalThreadIndex.toString()];t.threadAtGeneration=new j.Thread(e,this.story)}}}ResetErrors(){this._currentErrors=null,this._currentWarnings=null}ResetOutput(t=null){this._outputStream.length=0,null!==t&&this._outputStream.push.apply(this._outputStream,t),this.OutputStreamDirty()}PushToOutputStream(t){let e=a(t,b);if(null!==e){let t=this.TrySplittingHeadTailWhitespace(e);if(null!==t){for(let e of t)this.PushToOutputStreamIndividual(e);return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}PopFromOutputStream(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}TrySplittingHeadTailWhitespace(t){let e=t.value;if(null===e)return c("single.value");let n=-1,i=-1;for(let t=0;t<e.length;++t){let a=e[t];if("\n"!=a){if(" "==a||"\t"==a)continue;break}-1==n&&(n=t),i=t}let a=-1,r=-1;for(let t=0;t<e.length;++t){let n=e[t];if("\n"!=n){if(" "==n||"\t"==n)continue;break}-1==a&&(a=t),r=t}if(-1==n&&-1==a)return null;let s=[],l=0,o=e.length;if(-1!=n){if(n>0){let t=new b(e.substring(0,n));s.push(t)}s.push(new b("\n")),l=i+1}if(-1!=a&&(o=r),o>l){let t=e.substring(l,o-l);s.push(new b(t))}if(-1!=a&&r>i&&(s.push(new b("\n")),a<e.length-1)){let t=e.length-a-1,n=new b(e.substring(a+1,t));s.push(n)}return s}PushToOutputStreamIndividual(t){let e=a(t,O),n=a(t,b),r=!0;if(e)this.TrimNewlinesFromOutputStream(),r=!0;else if(n){let t=-1,e=this.callStack.currentElement;e.type==i.Function&&(t=e.functionStartInOutputStream);let a=-1;for(let e=this._outputStream.length-1;e>=0;e--){let n=this._outputStream[e],i=n instanceof P?n:null;if(null!=(n instanceof O?n:null)){a=e;break}if(null!=i&&i.commandType==P.CommandType.BeginString){e>=t&&(t=-1);break}}let s=-1;if(-1!=(s=-1!=a&&-1!=t?Math.min(t,a):-1!=a?a:t)){if(n.isNewline)r=!1;else if(n.isNonWhitespace&&(a>-1&&this.RemoveExistingGlue(),t>-1)){let t=this.callStack.elements;for(let e=t.length-1;e>=0;e--){let n=t[e];if(n.type!=i.Function)break;n.functionStartInOutputStream=-1}}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(r=!1))}if(r){if(null===t)return c("obj");this._outputStream.push(t),this.OutputStreamDirty()}}TrimNewlinesFromOutputStream(){let t=-1,e=this._outputStream.length-1;for(;e>=0;){let n=this._outputStream[e],i=a(n,P),r=a(n,b);if(null!=i||null!=r&&r.isNonWhitespace)break;null!=r&&r.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this._outputStream.length;){a(this._outputStream[e],b)?this._outputStream.splice(e,1):e++}this.OutputStreamDirty()}RemoveExistingGlue(){for(let t=this._outputStream.length-1;t>=0;t--){let e=this._outputStream[t];if(e instanceof O)this._outputStream.splice(t,1);else if(e instanceof P)break}this.OutputStreamDirty()}get outputStreamEndsInNewline(){if(this._outputStream.length>0)for(let t=this._outputStream.length-1;t>=0;t--){if(this._outputStream[t]instanceof P)break;let e=this._outputStream[t];if(e instanceof b){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(let t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof b)return!0;return!1}get inStringEvaluation(){for(let t=this._outputStream.length-1;t>=0;t--){let e=a(this._outputStream[t],P);if(e instanceof P&&e.commandType==P.CommandType.BeginString)return!0}return!1}PushEvaluationStack(t){let e=a(t,E);if(e){let t=e.value;if(null===t)return c("rawList");if(null!=t.originNames){t.origins||(t.origins=[]),t.origins.length=0;for(let e of t.originNames){if(null===this.story.listDefinitions)return c("StoryState.story.listDefinitions");let n=this.story.listDefinitions.TryListGetDefinition(e,null);if(null===n.result)return c("StoryState def.result");t.origins.indexOf(n.result)<0&&t.origins.push(n.result)}}}if(null===t)return c("obj");this.evaluationStack.push(t)}PopEvaluationStack(t){if(void 0===t){return o(this.evaluationStack.pop())}if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return o(this.evaluationStack.splice(this.evaluationStack.length-t,t))}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}ForceEnd(){for(;this.callStack.canPopThread;)this.callStack.PopThread();for(;this.callStack.canPop;)this.PopCallStack();this._currentChoices.length=0,this.currentPointer=A.Null,this.previousPointer=A.Null,this.didSafeExit=!0}TrimWhitespaceFromFunctionEnd(){e.Assert(this.callStack.currentElement.type==i.Function);let t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(let e=this._outputStream.length-1;e>=t;e--){let t=this._outputStream[e],n=a(t,b),i=a(t,P);if(null!=n){if(i)break;if(!n.isNewline&&!n.isInlineWhitespace)break;this._outputStream.splice(e,1),this.OutputStreamDirty()}}}PopCallStack(t=null){this.callStack.currentElement.type==i.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}SetChosenPath(t,e){this._currentChoices.length=0;let n=this.story.PointerAtPath(t);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,e&&this._currentTurnIndex++}StartFunctionEvaluationFromGame(t,e){this.callStack.Push(i.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=A.StartOf(t),this.PassArgumentsToEvaluationStack(e)}PassArgumentsToEvaluationStack(t){if(null!=t)for(let e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string");this.PushEvaluationStack(S.Create(t[e]))}}TryExitFunctionEvaluationFromGame(){return this.callStack.currentElement.type==i.FunctionEvaluationFromGame&&(this.currentPointer=A.Null,this.didSafeExit=!0,!0)}CompleteFunctionEvaluationFromGame(){if(this.callStack.currentElement.type!=i.FunctionEvaluationFromGame)throw new g("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);let t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;for(;this.evaluationStack.length>t;){let t=this.PopEvaluationStack();null===e&&(e=t)}if(this.PopCallStack(i.FunctionEvaluationFromGame),e){if(e instanceof L)return null;let t=r(e,S);return t.valueType==n.DivertTarget?t.valueObject.toString():t.valueObject}return null}AddError(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}class U{constructor(){this.startTime=void 0}get ElapsedMilliseconds(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}Start(){this.startTime=(new Date).getTime()}Stop(){this.startTime=void 0}}Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});class z extends d{constructor(){let t;super(),this.inkVersionCurrent=19,this.inkVersionMinimumCompatible=18,this._prevContainers=[],this.allowExternalFunctionFallbacks=!1,this._listDefinitions=null,this._variableObservers=null,this._hasValidatedExternals=!1,this._temporaryEvaluationContainer=null,this._asyncContinueActive=!1,this._stateAtLastNewline=null,this._recursiveContinueCount=0,this._profiler=null;let e=null,n=null;if(arguments[0]instanceof x)t=arguments[0],void 0!==arguments[1]&&(e=arguments[1]),this._mainContentContainer=t;else if("string"==typeof arguments[0]){let t=arguments[0];n=JSON.parse(t)}else n=arguments[0];if(null!=e&&(this._listDefinitions=new G(e)),this._externals=new Map,null!==n){let t=n,e=t.inkVersion;if(null==e)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");let i=parseInt(e);if(i>this.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(i<this.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");i!=this.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");let a,s=t.root;if(null==s)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(a=t.listDefs)&&(this._listDefinitions=W.JTokenToListDefinitions(a)),this._mainContentContainer=r(W.JTokenToRuntimeObject(s),x),this.ResetState()}}get currentChoices(){let t=[];if(null===this._state)return c("this._state");for(let e of this._state.currentChoices)e.isInvisibleDefault||(e.index=t.length,t.push(e));return t}get currentText(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}get currentTags(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}get currentErrors(){return this.state.currentErrors}get currentWarnings(){return this.state.currentWarnings}get hasError(){return this.state.hasError}get hasWarning(){return this.state.hasWarning}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}StartProfiling(){}EndProfiling(){}ToJsonString(){let t=W.RuntimeObjectToJToken(this._mainContentContainer),e={};return e.inkVersion=this.inkVersionCurrent,e.root=t,null!=this._listDefinitions&&(e.listDefs=W.ListDefinitionsToJToken(this._listDefinitions)),JSON.stringify(e)}ResetState(){this.IfAsyncWeCant("ResetState"),this._state=new K(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}ResetErrors(){if(null===this._state)return c("this._state");this._state.ResetErrors()}ResetCallstack(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return c("this._state");this._state.ForceEnd()}ResetGlobals(){if(this._mainContentContainer.namedContent.get("global decl")){let e=this.state.currentPointer.copy();this.ChoosePath(new t("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=e}this.state.variablesState.SnapshotDefaultGlobals()}Continue(){return this.ContinueAsync(0),this.currentText}get canContinue(){return this.state.canContinue}get asyncContinueComplete(){return!this._asyncContinueActive}ContinueAsync(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}ContinueInternal(t=0){null!=this._profiler&&this._profiler.PreContinue();let e=t>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new g("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}let n=new U;n.Start();let a=!1;do{try{a=this.ContinueSingleStep()}catch(t){if(!(t instanceof g))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}if(a)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);n.Stop(),!a&&this.canContinue||(null!=this._stateAtLastNewline&&(this.RestoreStateSnapshot(this._stateAtLastNewline),this._stateAtLastNewline=null),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(i.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(i.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue()}ContinueSingleStep(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!=this._stateAtLastNewline){if(null===this._stateAtLastNewline.currentTags)return c("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return c("this.state.currentTags");let t=this.CalculateNewlineOutputStateChange(this._stateAtLastNewline.currentText,this.state.currentText,this._stateAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==z.OutputStateChange.ExtendedBeyondNewline)return this.RestoreStateSnapshot(this._stateAtLastNewline),!0;t==z.OutputStateChange.NewlineRemoved&&(this._stateAtLastNewline=null)}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateAtLastNewline&&(this._stateAtLastNewline=this.StateSnapshot()):this._stateAtLastNewline=null)}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}CalculateNewlineOutputStateChange(t,e,n,i){if(null===t)return c("prevText");if(null===e)return c("currText");let a=e.length>=t.length&&"\n"==e.charAt(t.length-1);if(n==i&&t.length==e.length&&a)return z.OutputStateChange.NoChange;if(!a)return z.OutputStateChange.NewlineRemoved;if(i>n)return z.OutputStateChange.ExtendedBeyondNewline;for(let n=t.length;n<e.length;n++){let t=e.charAt(n);if(" "!=t&&"\t"!=t)return z.OutputStateChange.ExtendedBeyondNewline}return z.OutputStateChange.NoChange}ContinueMaximally(){this.IfAsyncWeCant("ContinueMaximally");let t=new p;for(;this.canContinue;)t.Append(this.Continue());return t.toString()}ContentAtPath(t){return this.mainContentContainer.ContentAtPath(t)}KnotContainerWithName(t){let e=this.mainContentContainer.namedContent.get(t);return e instanceof x?e:null}PointerAtPath(t){if(0==t.length)return A.Null;let e=new A,n=t.length,i=null;return null===t.lastComponent?c("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}StateSnapshot(){return this.state.Copy()}RestoreStateSnapshot(t){this._state=t}Step(){let t=!0,e=this.state.currentPointer.copy();if(e.isNull)return;let n=a(e.Resolve(),x);for(;n&&(this.VisitContainer(n,!0),0!=n.content.length);)n=a((e=A.StartOf(n)).Resolve(),x);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);let i=e.Resolve(),r=this.PerformLogicAndFlowControl(i);if(this.state.currentPointer.isNull)return;r&&(t=!1);let s=a(i,I);if(s){let e=this.ProcessChoice(s);e&&this.state.generatedChoices.push(e),i=null,t=!1}if(i instanceof x&&(t=!1),t){let t=a(i,w);if(t&&-1==t.contextIndex){let e=this.state.callStack.ContextForVariableNamed(t.variableName);i=new w(t.variableName,e)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent();let l=a(i,P);l&&l.commandType==P.CommandType.StartThread&&this.state.callStack.PushThread()}VisitContainer(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.RecordTurnIndexVisitToContainer(t))}VisitChangedContainersDueToDivert(){let t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(e.isNull||-1==e.index)return;if(this._prevContainers.length=0,!t.isNull){let e=a(t.Resolve(),x)||a(t.container,x);for(;e;)this._prevContainers.push(e),e=a(e.parent,x)}let n=e.Resolve();if(null==n)return;let i=a(n.parent,x);for(;i&&(this._prevContainers.indexOf(i)<0||i.countingAtStartOnly);){let t=i.content.length>0&&n==i.content[0];this.VisitContainer(i,t),n=i,i=a(i.parent,x)}}ProcessChoice(t){let e=!0;if(t.hasCondition){let t=this.state.PopEvaluationStack();this.IsTruthy(t)||(e=!1)}let n="",i="";if(t.hasChoiceOnlyContent){i=r(this.state.PopEvaluationStack(),b).value||""}if(t.hasStartContent){n=r(this.state.PopEvaluationStack(),b).value||""}if(t.onceOnly){this.VisitCountForContainer(t.choiceTarget)>0&&(e=!1)}if(!e)return null;let a=new M;return a.targetPath=t.pathOnChoice,a.sourcePath=t.path.toString(),a.isInvisibleDefault=t.isInvisibleDefault,a.threadAtGeneration=this.state.callStack.currentThread.Copy(),a.text=(n+i).replace(/^[ \t]+|[ \t]+$/g,""),a}IsTruthy(t){if(t instanceof S){let e=t;if(e instanceof _){let t=e;return this.Error("Shouldn't use a divert target (to "+t.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}PerformLogicAndFlowControl(t){if(null==t)return!1;if(t instanceof k){let e=t;if(e.isConditional){let t=this.state.PopEvaluationStack();if(!this.IsTruthy(t))return!0}if(e.hasVariableTarget){let t=e.variableDivertName,n=this.state.variablesState.GetVariableWithName(t);if(null==n)this.Error("Tried to divert using a target from a variable that could not be found ("+t+")");else if(!(n instanceof _)){let e=a(n,y),i="Tried to divert to a target from a variable, but the variable ("+t+") didn't contain a divert target, it ";e instanceof y&&0==e.value?i+="was empty/null (the value 0).":i+="contained '"+n+"'.",this.Error(i)}let i=r(n,_);this.state.divertedPointer=this.PointerAtPath(i.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof P){let e=t;switch(e.commandType){case P.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case P.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case P.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){let t=this.state.PopEvaluationStack();if(!(t instanceof L)){let e=new b(t.toString());this.state.PushToOutputStream(e)}}break;case P.CommandType.NoOp:break;case P.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case P.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case P.CommandType.PopFunction:case P.CommandType.PopTunnel:let t=e.commandType==P.CommandType.PopFunction?i.Function:i.Tunnel,n=null;if(t==i.Tunnel){let t=this.state.PopEvaluationStack();null===(n=a(t,_))&&this.Assert(t instanceof L,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==t&&this.state.callStack.canPop)this.state.PopCallStack(),n&&(this.state.divertedPointer=this.PointerAtPath(n.targetPath));else{let e=new Map;e.set(i.Function,"function return statement (~ return)"),e.set(i.Tunnel,"tunnel onwards statement (->->)");let n=e.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(n="end of flow (-> END or choice)");let a="Found "+e.get(t)+", when expected "+n;this.Error(a)}break;case P.CommandType.BeginString:this.state.PushToOutputStream(e),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case P.CommandType.EndString:let s=[],l=0;for(let t=this.state.outputStream.length-1;t>=0;--t){let e=this.state.outputStream[t];l++;let n=a(e,P);if(n&&n.commandType==P.CommandType.BeginString)break;e instanceof b&&s.push(e)}this.state.PopFromOutputStream(l),s=s.reverse();let o=new p;for(let t of s)o.Append(t.toString());this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new b(o.toString()));break;case P.CommandType.ChoiceCount:let u=this.state.generatedChoices.length;this.state.PushEvaluationStack(new y(u));break;case P.CommandType.Turns:this.state.PushEvaluationStack(new y(this.state.currentTurnIndex+1));break;case P.CommandType.TurnsSince:case P.CommandType.ReadCount:let h=this.state.PopEvaluationStack();if(!(h instanceof _)){let t="";h instanceof y&&(t=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+h+t);break}let d,C=r(h,_),v=a(this.ContentAtPath(C.targetPath).correctObj,x);null!=v?d=e.commandType==P.CommandType.TurnsSince?this.TurnsSinceForContainer(v):this.VisitCountForContainer(v):(d=e.commandType==P.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+e.toString()+" lookup at "+C.targetPath.toString())),this.state.PushEvaluationStack(new y(d));break;case P.CommandType.Random:{let t=a(this.state.PopEvaluationStack(),y),e=a(this.state.PopEvaluationStack(),y);if(null==e||e instanceof y==!1)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==t||e instanceof y==!1)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===t.value)return c("maxInt.value");if(null===e.value)return c("minInt.value");let n=t.value-e.value+1;n<=0&&this.Error("RANDOM was called with minimum as "+e.value+" and maximum as "+t.value+". The maximum must be larger");let i=this.state.storySeed+this.state.previousRandom,r=new q(i).next(),s=r%n+e.value;this.state.PushEvaluationStack(new y(s)),this.state.previousRandom=r;break}case P.CommandType.SeedRandom:let T=a(this.state.PopEvaluationStack(),y);if(null==T||T instanceof y==!1)return this.Error("Invalid value passed to SEED_RANDOM");if(null===T.value)return c("minInt.value");this.state.storySeed=T.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new L);break;case P.CommandType.VisitIndex:let w=this.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new y(w));break;case P.CommandType.SequenceShuffleIndex:let N=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new y(N));break;case P.CommandType.StartThread:break;case P.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=A.Null);break;case P.CommandType.End:this.state.ForceEnd();break;case P.CommandType.ListFromInt:let O=a(this.state.PopEvaluationStack(),y),k=r(this.state.PopEvaluationStack(),b);if(null===O)throw new g("Passed non-integer when creating a list element from a numerical value.");let I=null;if(null===this.listDefinitions)return c("this.listDefinitions");let F=this.listDefinitions.TryListGetDefinition(k.value,null);if(!F.exists)throw new g("Failed to find LIST called "+k.value);{if(null===O.value)return c("minInt.value");let t=F.result.TryGetItemWithValue(O.value,m.Null);t.exists&&(I=new E(t.result,O.value))}null==I&&(I=new E),this.state.PushEvaluationStack(I);break;case P.CommandType.ListRange:let V=a(this.state.PopEvaluationStack(),S),R=a(this.state.PopEvaluationStack(),S),D=a(this.state.PopEvaluationStack(),E);if(null===D||null===R||null===V)throw new g("Expected list, minimum and maximum for LIST_RANGE");if(null===D.value)return c("targetList.value");let M=D.value.ListWithSubRange(R.valueObject,V.valueObject);this.state.PushEvaluationStack(new E(M));break;case P.CommandType.ListRandom:{let t=this.state.PopEvaluationStack();if(null===t)throw new g("Expected list for LIST_RANDOM");let e=t.value,n=null;if(null===e)throw c("list");if(0==e.Count)n=new f;else{let t=this.state.storySeed+this.state.previousRandom,i=new q(t).next(),a=i%e.Count,r=e.entries();for(let t=0;t<=a-1;t++)r.next();let s=r.next().value,l={Key:m.fromSerializedKey(s[0]),Value:s[1]};if(null===l.Key.originName)return c("randomItem.Key.originName");(n=new f(l.Key.originName,this)).Add(l.Key,l.Value),this.state.previousRandom=i}this.state.PushEvaluationStack(new E(n));break}default:this.Error("unhandled ControlCommand: "+e)}return!0}if(t instanceof V){let e=t,n=this.state.PopEvaluationStack();return this.state.variablesState.Assign(e,n),!0}if(t instanceof F){let e=t,n=null;if(null!=e.pathForCount){let t=e.containerForCount,i=this.VisitCountForContainer(t);n=new y(i)}else if(null==(n=this.state.variablesState.GetVariableWithName(e.name))){let t=this.state.variablesState.TryGetDefaultVariableValue(e.name);null!=t?(this.Warning("Variable not found in save state: '"+e.name+"', but seems to have been newly created. Assigning value from latest ink's declaration: "+t),n=t,this.state.variablesState.SetGlobal(e.name,n)):(this.Warning("Variable not found: '"+e.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit."),n=new y(0))}return this.state.PushEvaluationStack(n),!0}if(t instanceof R){let e=t,n=this.state.PopEvaluationStack(e.numberOfParameters),i=e.Call(n);return this.state.PushEvaluationStack(i),!0}return!1}ChoosePathString(e,n=!0,a=[]){if(this.IfAsyncWeCant("call ChoosePathString right now"),n)this.ResetCallstack();else if(this.state.callStack.currentElement.type==i.Function){let t="",n=this.state.callStack.currentElement.currentPointer.container;throw null!=n&&(t="("+n.path.toString()+") "),new Error("Story was running a function "+t+"when you called ChoosePathString("+e+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(a),this.ChoosePath(new t(e))}IfAsyncWeCant(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}ChoosePath(t,e=!0){this.state.SetChosenPath(t,e),this.VisitChangedContainersDueToDivert()}ChooseChoiceIndex(t){t=t;let e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");let n=e[t];return null===n.threadAtGeneration?c("choiceToChoose.threadAtGeneration"):null===n.targetPath?c("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}HasFunction(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}EvaluateFunction(t,e=[],n=!1){if(this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");let i=this.KnotContainerWithName(t);if(null==i)throw new Error("Function doesn't exist: '"+t+"'");let a=[];a.push.apply(a,this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);let r=new p;for(;this.canContinue;)r.Append(this.Continue());let s=r.toString();this._state.ResetOutput(a);let l=this.state.CompleteFunctionEvaluationFromGame();return n?{returned:l,output:s}:l}EvaluateExpression(t){let e=this.state.callStack.elements.length;this.state.callStack.Push(i.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();let n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}CallExternalFunction(t,e){if(null===t)return c("funcName");let n=this._externals.get(t),a=null;if(!(void 0!==n)){if(this.allowExternalFunctionFallbacks)return a=this.KnotContainerWithName(t),this.Assert(null!==a,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(i.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=A.StartOf(a));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}let s=[];for(let t=0;t<e;++t){let t=r(this.state.PopEvaluationStack(),S).valueObject;s.push(t)}s.reverse();let l=n(s),o=null;null!=l?(o=S.Create(l),this.Assert(null!==o,"Could not create ink value from returned object of type "+typeof l)):o=new L,this.state.PushEvaluationStack(o)}BindExternalFunctionGeneral(t,e){this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,e)}TryCoerce(t){return t}BindExternalFunction(t,e){this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,t=>{this.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");let n=[];for(let e=0,i=t.length;e<i;e++)n[e]=this.TryCoerce(t[e]);return e.apply(null,n)})}UnbindExternalFunction(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}ValidateExternalBindings(){let t=null,e=null,n=arguments[1]||new Set;if(arguments[0]instanceof x&&(t=arguments[0]),arguments[0]instanceof d&&(e=arguments[0]),null===t&&null===e)if(this.ValidateExternalBindings(this._mainContentContainer,n),this._hasValidatedExternals=!0,0==n.size)this._hasValidatedExternals=!0;else{let t="Error: Missing function binding for external";t+=n.size>1?"s":"",t+=": '",t+=Array.from(n).join("', '"),t+="' ",t+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(t)}else if(null!=t){for(let e of t.content){let t=e;null!=t&&t.hasValidName||this.ValidateExternalBindings(e,n)}for(let[e,i]of t.namedContent)this.ValidateExternalBindings(a(i,d),n)}else if(null!=e){let t=a(e,k);if(t&&t.isExternal){let e=t.targetPathString;if(null===e)return c("name");if(!this._externals.has(e))if(this.allowExternalFunctionFallbacks){this.mainContentContainer.namedContent.has(e)||n.add(e)}else n.add(e)}}}ObserveVariable(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new g("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}ObserveVariables(t,e){for(let n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}RemoveVariableObserver(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(void 0!==e){if(this._variableObservers.has(e)){let n=this._variableObservers.get(e);n.splice(n.indexOf(t),1)}}else{let e=this._variableObservers.keys();for(let n of e){let e=this._variableObservers.get(n);e.splice(e.indexOf(t),1)}}}VariableStateDidChangeEvent(t,e){if(null===this._variableObservers)return;let n=this._variableObservers.get(t);if(void 0!==n){if(!(e instanceof S))throw new Error("Tried to get the value of a variable that isn't a standard type");let i=r(e,S);for(let e of n)e(t,i.valueObject)}}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString("")}TagsForContentAtPath(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}TagsAtStartOfFlowContainerWithPathString(e){let n=new t(e),i=this.ContentAtPath(n).container;if(null===i)return c("flowContainer");for(;;){let t=i.content[0];if(!(t instanceof x))break;i=t}let r=null;for(let t of i.content){let e=a(t,D);if(!e)break;null==r&&(r=[]),r.push(e.text)}return r}BuildStringOfHierarchy(){let t=new p;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}BuildStringOfContainer(t){let e=new p;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}NextContent(){if(this.state.previousPointer=this.state.currentPointer.copy(),!this.state.divertedPointer.isNull&&(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=A.Null,this.VisitChangedContainersDueToDivert(),!this.state.currentPointer.isNull))return;if(!this.IncrementContentPointer()){let t=!1;this.state.callStack.CanPop(i.Function)?(this.state.PopCallStack(i.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new L),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}IncrementContentPointer(){let t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return c("pointer.container");for(;e.index>=e.container.content.length;){t=!1;let n=a(e.container.parent,x);if(n instanceof x==!1)break;let i=n.content.indexOf(e.container);if(-1==i)break;if((e=new A(n,i)).index++,t=!0,null===e.container)return c("pointer.container")}return t||(e=A.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}TryFollowDefaultInvisibleChoice(){let t=this._state.currentChoices,e=t.filter(t=>t.isInvisibleDefault);if(0==e.length||t.length>e.length)return!1;let n=e[0];return null===n.targetPath?c("choice.targetPath"):(this.ChoosePath(n.targetPath,!1),!0)}VisitCountForContainer(t){if(null===t)return c("container");if(!t.visitsShouldBeCounted)return console.warn("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;let e=0,n=t.path.toString();return e=this.state.visitCounts.get(n)||e}IncrementVisitCountForContainer(t){let e=0,n=t.path.toString();this.state.visitCounts.has(n)&&(e=this.state.visitCounts.get(n)),e++,this.state.visitCounts.set(n,e)}RecordTurnIndexVisitToContainer(t){let e=t.path.toString();this.state.turnIndices.set(e,this.state.currentTurnIndex)}TurnsSinceForContainer(t){t.turnIndexShouldBeCounted||this.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c).");let e=t.path.toString(),n=this.state.turnIndices.get(e);return void 0!==n?this.state.currentTurnIndex-n:-1}NextSequenceShuffleIndex(){let t=a(this.state.PopEvaluationStack(),y);if(!(t instanceof y))return this.Error("expected number of elements in sequence for shuffle index"),0;let e=this.state.currentPointer.container;if(null===e)return c("seqContainer");if(null===t.value)return c("numElementsIntVal.value");let n=t.value,i=r(this.state.PopEvaluationStack(),y).value;if(null===i)return c("seqCount");let s=i/n,l=i%n,o=e.path.toString(),u=0;for(let t=0,e=o.length;t<e;t++)u+=o.charCodeAt(t)||0;let h=u+s+this.state.storySeed,d=new q(Math.floor(h)),p=[];for(let t=0;t<n;++t)p.push(t);for(let t=0;t<=l;++t){let e=d.next()%p.length,n=p[e];if(p.splice(e,1),t==l)return n}throw new Error("Should never reach here")}Error(t,e=!1){let n=new g(t);throw n.useEndLineNumber=e,n}Warning(t){this.AddError(t,!0)}AddError(t,e=!1,n=!1){let i=this.currentDebugMetadata,a=e?"WARNING":"ERROR";if(null!=i){let e=n?i.endLineNumber:i.startLineNumber;t="RUNTIME "+a+": '"+i.fileName+"' line "+e+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+a+": "+t:"RUNTIME "+a+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,e),e||this.state.ForceEnd()}Assert(t,e=null){if(0==t)throw null==e&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}get currentDebugMetadata(){let t,e=this.state.currentPointer;if(!e.isNull&&null!==e.Resolve()&&null!==(t=e.Resolve().debugMetadata))return t;for(let n=this.state.callStack.elements.length-1;n>=0;--n)if(!(e=this.state.callStack.elements[n].currentPointer).isNull&&null!==e.Resolve()&&null!==(t=e.Resolve().debugMetadata))return t;for(let e=this.state.outputStream.length-1;e>=0;--e){if(null!==(t=this.state.outputStream[e].debugMetadata))return t}return null}get mainContentContainer(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}!function(t){let e;!function(t){t[t.NoChange=0]="NoChange",t[t.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",t[t.NewlineRemoved=2]="NewlineRemoved"}(e=t.OutputStateChange||(t.OutputStateChange={}))}(z||(z={}));export{z as Story,f as InkList};
