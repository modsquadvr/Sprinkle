{"version":3,"file":"ink.js","sources":["../src/Path.ts","../src/Debug.ts","../src/TypeAssertion.ts","../src/NullException.ts","../src/Object.ts","../src/StringBuilder.ts","../src/InkList.ts","../src/StoryException.ts","../src/TryGetResult.ts","../src/Value.ts","../src/SearchResult.ts","../src/Container.ts","../src/Glue.ts","../src/ControlCommand.ts","../src/PushPop.ts","../src/Pointer.ts","../src/Divert.ts","../src/ChoicePoint.ts","../src/VariableReference.ts","../src/VariableAssignment.ts","../src/Void.ts","../src/NativeFunctionCall.ts","../src/Tag.ts","../src/Choice.ts","../src/ListDefinition.ts","../src/ListDefinitionsOrigin.ts","../src/JsonSerialisation.ts","../src/PRNG.ts","../src/StopWatch.ts","../src/Story.ts","../src/CallStack.ts","../src/VariablesState.ts","../src/StoryState.ts","../src/Story.ts"],"sourcesContent":["export class Path{\r\n\tpublic static parentId = '^';\r\n\r\n\tpublic _isRelative: boolean;\r\n\tpublic _components: Path.Component[];\r\n\tpublic _componentsString: string | null;\r\n\r\n\tconstructor();\r\n\tconstructor(componentsString: string);\r\n\tconstructor(head: Path.Component, tail: Path);\r\n\tconstructor(head: Path.Component[], relative?: boolean);\r\n\tconstructor(){\r\n\t\tthis._components = [];\r\n\t\tthis._componentsString = null;\r\n\t\tthis._isRelative = false;\r\n\r\n\t\tif (typeof arguments[0] == 'string'){\r\n\t\t\tlet componentsString = arguments[0] as string;\r\n\t\t\tthis.componentsString = componentsString;\r\n\t\t}\r\n\t\telse if (arguments[0] instanceof Path.Component && arguments[1] instanceof Path){\r\n\t\t\tlet head = arguments[0] as Path.Component;\r\n\t\t\tlet tail = arguments[1] as Path;\r\n\t\t\tthis._components.push(head);\r\n\t\t\tthis._components = this._components.concat(tail._components);\r\n\t\t}\r\n\t\telse if (arguments[0] instanceof Array){\r\n\t\t\tlet head = arguments[0] as Path.Component[];\r\n\t\t\tlet relative = !!arguments[1] as boolean;\r\n\t\t\tthis._components = this._components.concat(head);\r\n\t\t\tthis._isRelative = relative;\r\n\t\t}\r\n\t}\r\n\tget isRelative(){\r\n\t\treturn this._isRelative;\r\n\t}\r\n\tget componentCount(): number{\r\n\t\treturn this._components.length;\r\n\t}\r\n\tget head(): Path.Component | null{\r\n\t\tif (this._components.length > 0) {\r\n\t\t\treturn this._components[0];\r\n\t\t} else {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\tget tail(): Path{\r\n\t\tif (this._components.length >= 2) {\r\n\t\t\t// careful, the original code uses length-1 here. This is because the second argument of\r\n\t\t\t// List.GetRange is a number of elements to extract, wherease Array.slice uses an index\r\n\t\t\tlet tailComps = this._components.slice(1, this._components.length);\r\n\t\t\treturn new Path(tailComps);\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn Path.self;\r\n\t\t}\r\n\t}\r\n\tget length(): number{\r\n\t\treturn this._components.length;\r\n\t}\r\n\tget lastComponent(): Path.Component | null{\r\n\t\tlet lastComponentIdx = this._components.length - 1;\r\n\t\tif (lastComponentIdx >= 0) {\r\n\t\t\treturn this._components[lastComponentIdx];\r\n\t\t} else {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\tget containsNamedComponent(): boolean{\r\n\t\tfor (let i = 0, l = this._components.length; i < l; i++){\r\n\t\t\tif (!this._components[i].isIndex){\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\tstatic get self(): Path{\r\n\t\tlet path = new Path();\r\n\t\tpath._isRelative = true;\r\n\t\treturn path;\r\n\t}\r\n\r\n\tpublic GetComponent(index: number): Path.Component{\r\n\t\treturn this._components[index];\r\n\t}\r\n\tpublic PathByAppendingPath(pathToAppend: Path): Path{\r\n\t\tlet p = new Path();\r\n\r\n\t\tlet upwardMoves = 0;\r\n\t\tfor (let i = 0; i < pathToAppend._components.length; ++i) {\r\n\t\t\tif (pathToAppend._components[i].isParent) {\r\n\t\t\t\tupwardMoves++;\r\n\t\t\t} else {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (let i = 0; i < this._components.length - upwardMoves; ++i) {\r\n\t\t\tp._components.push(this._components[i]);\r\n\t\t}\r\n\r\n\t\tfor (let i = upwardMoves; i < pathToAppend._components.length; ++i) {\r\n\t\t\tp._components.push(pathToAppend._components[i]);\r\n\t\t}\r\n\r\n\t\treturn p;\r\n\t}\r\n\tget componentsString(): string{\r\n\t\tif (this._componentsString == null) {\r\n\t\t\tthis._componentsString = this._components.join('.');\r\n\t\t\tif (this.isRelative) this._componentsString = '.' + this._componentsString;\r\n\t\t}\r\n\r\n\t\treturn this._componentsString;\r\n\t}\r\n\tset componentsString(value: string){\r\n\t\tthis._components.length = 0;\r\n\r\n\t\tthis._componentsString = value;\r\n\r\n\t\tif (this._componentsString == null || this._componentsString == '') return;\r\n\r\n\t\tif (this._componentsString[0] == '.') {\r\n\t\t\tthis._isRelative = true;\r\n\t\t\tthis._componentsString = this._componentsString.substring(1);\r\n\t\t}\r\n\r\n\t\tlet componentStrings = this._componentsString.split('.');\r\n\t\tfor (let str of componentStrings) {\r\n\t\t\t// we need to distinguish between named components that start with a number, eg \"42somewhere\", and indexed components\r\n\t\t\t// the normal parseInt won't do for the detection because it's too relaxed.\r\n\t\t\t// see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/parseInt\r\n\t\t\tif (/^(\\-|\\+)?([0-9]+|Infinity)$/.test(str)){\r\n\t\t\t\tthis._components.push(new Path.Component(parseInt(str)));\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\tthis._components.push(new Path.Component(str));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tpublic toString(): string{\r\n\t\treturn this.componentsString;\r\n\t}\r\n\tpublic Equals(otherPath: Path | null): boolean{\r\n\t\tif (otherPath == null)\r\n\t\t\treturn false;\r\n\r\n\t\tif (otherPath._components.length != this._components.length)\r\n\t\t\treturn false;\r\n\r\n\t\tif (otherPath.isRelative != this.isRelative)\r\n\t\t\treturn false;\r\n\r\n\t\t// the original code uses SequenceEqual here, so we need to iterate over the components manually.\r\n\t\tfor (let i = 0, l = otherPath._components.length; i < l; i++){\r\n\t\t\t// it's not quite clear whether this test should use Equals or a simple == operator,\r\n\t\t\t// see https://github.com/y-lohse/inkjs/issues/22\r\n\t\t\tif (!otherPath._components[i].Equals(this._components[i])) return false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t}\r\n\tpublic PathByAppendingComponent(c: Path.Component): Path{\r\n\t\tlet p = new Path();\r\n\t\tp._components.push.apply(p._components, this._components);\r\n\t\tp._components.push(c);\r\n\t\treturn p;\r\n\t}\r\n}\r\n\r\nexport namespace Path {\r\n\texport class Component{\r\n\t\tpublic readonly index: number;\r\n\t\tpublic readonly name: string | null;\r\n\r\n\t\tconstructor(indexOrName: string | number){\r\n\t\t\tthis.index = -1;\r\n\t\t\tthis.name = null;\r\n\t\t\tif (typeof indexOrName == 'string'){\r\n\t\t\t\tthis.name = indexOrName;\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\tthis.index = indexOrName;\r\n\t\t\t}\r\n\t\t}\r\n\t\tget isIndex(): boolean{\r\n\t\t\treturn this.index >= 0;\r\n\t\t}\r\n\t\tget isParent(): boolean{\r\n\t\t\treturn this.name == Path.parentId;\r\n\t\t}\r\n\r\n\t\tpublic static ToParent(): Component{\r\n\t\t\treturn new Component(Path.parentId);\r\n\t\t}\r\n\t\tpublic toString(): string | null{\r\n\t\t\tif (this.isIndex) {\r\n\t\t\t\treturn this.index.toString();\r\n\t\t\t} else {\r\n\t\t\t\treturn this.name;\r\n\t\t\t}\r\n\t\t}\r\n\t\tpublic Equals(otherComp: Component): boolean{\r\n\t\t\tif (otherComp != null && otherComp.isIndex == this.isIndex) {\r\n\t\t\t\tif (this.isIndex) {\r\n\t\t\t\t\treturn this.index == otherComp.index;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn this.name == otherComp.name;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n}\r\n","export namespace Debug {\r\n\t// tslint:disable no-string-throw\r\n\texport function AssertType<T>(variable: any, type: new () => T, message: string): void | never {\r\n\t\tAssert(variable instanceof type, message);\r\n\t}\r\n\r\n\texport function Assert(condition: boolean, message?: string): void | never {\r\n\t\tif (!condition) {\r\n\t\t\t// tslint:disable:no-console\r\n\t\t\tif (typeof message !== 'undefined') {\r\n\t\t\t\tconsole.warn(message);\r\n\t\t\t}\r\n\r\n\t\t\tif (console.trace) {\r\n\t\t\t\tconsole.trace();\r\n\t\t\t}\r\n\r\n\t\t\tthrow '';\r\n\t\t}\r\n\t}\r\n}\r\n","import {INamedContent} from './INamedContent';\r\n\r\n// tslint:disable ban-types\r\n\r\nexport function asOrNull<T>(obj: any, type: (new (...arg: any[]) => T) | Function & { prototype: T }): T | null{\r\n\tif (obj instanceof type) {\r\n\t\treturn unsafeTypeAssertion(obj, type);\r\n\t} else {\r\n\t\treturn null;\r\n\t}\r\n}\r\n\r\nexport function asOrThrows<T>(obj: any, type: (new (...arg: any[]) => T) | Function & { prototype: T }): T | never{\r\n\tif (obj instanceof type) {\r\n\t\treturn unsafeTypeAssertion(obj, type);\r\n\t} else {\r\n\t\tthrow new Error(`${obj} is not of type ${type}`);\r\n\t}\r\n}\r\n\r\nexport function asNumberOrThrows(obj: any){\r\n\tif (typeof obj === 'number') {\r\n\t\treturn obj as number;\r\n\t} else {\r\n\t\tthrow new Error(`${obj} is not a number`);\r\n\t}\r\n}\r\n\r\n// So here, in the reference implementation, contentObj is casted to an INamedContent\r\n// but here we use js-style duck typing: if it implements the same props as the interface,\r\n// we treat it as valid.\r\nexport function asINamedContentOrNull(obj: any): INamedContent | null {\r\n\tif (obj.hasValidName && obj.name) {\r\n\t\treturn obj as INamedContent;\r\n\t}\r\n\r\n\treturn null;\r\n}\r\n\r\nexport function nullIfUndefined<T>(obj: T | undefined): T | null {\r\n\tif (typeof obj === 'undefined') {\r\n\t\treturn null;\r\n\t}\r\n\r\n\treturn obj;\r\n}\r\n\r\nfunction unsafeTypeAssertion<T>(obj: any, type: (new () => T) | Function & { prototype: T }){\r\n\treturn obj as T;\r\n}\r\n","/**\r\n * In the original C# code, a SystemException would be thrown when passing\r\n * null to methods expected a valid instance. Javascript has no such\r\n * concept, but TypeScript will not allow `null` to be passed to methods\r\n * explicitely requiring a valid type.\r\n *\r\n * Whenever TypeScript complain about the possibility of a `null` value,\r\n * check the offending value and it it's null, throw this exception using\r\n * `throwNullException(name: string)`.\r\n */\r\nexport class NullException extends Error{}\r\n\r\n/**\r\n * Throw a NullException.\r\n * @param name a short description of the offending value (often its name within the code).\r\n */\r\nexport function throwNullException(name: string): never {\r\n\tthrow new NullException(`${name} is null or undefined`);\r\n}\r\n","import {Path} from './Path';\r\nimport {Container} from './Container';\r\nimport {Debug} from './Debug';\r\nimport {asOrNull, asINamedContentOrNull} from './TypeAssertion';\r\nimport { throwNullException } from './NullException';\r\nimport { SearchResult } from './SearchResult';\r\nimport { DebugMetadata } from './DebugMetadata';\r\n\r\nexport class InkObject{\r\n\r\n\tpublic parent: InkObject | null = null;\r\n\r\n\tget debugMetadata(): DebugMetadata | null {\r\n\t\tif (this._debugMetadata === null) {\r\n\t\t\tif (this.parent) {\r\n\t\t\t\treturn this.parent.debugMetadata;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this._debugMetadata;\r\n\t}\r\n\r\n\tset debugMetadata(value) {\r\n\t\tthis._debugMetadata = value;\r\n\t}\r\n\r\n\tget ownDebugMetadata() {\r\n\t\treturn this._debugMetadata;\r\n\t}\r\n\r\n\tprivate _debugMetadata: DebugMetadata | null = null;\r\n\r\n\tpublic DebugLineNumberOfPath(path: Path) {\r\n\t\tif (path === null)\r\n\t\t\treturn null;\r\n\r\n\t\t// Try to get a line number from debug metadata\r\n\t\tlet root = this.rootContentContainer;\r\n\t\tif (root) {\r\n\t\t\tlet targetContent = root.ContentAtPath(path).obj;\r\n\t\t\tif (targetContent) {\r\n\t\t\t\tlet dm = targetContent.debugMetadata;\r\n\t\t\t\tif (dm !== null) {\r\n\t\t\t\t\treturn dm.startLineNumber;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\tget path(){\r\n\t\tif (this._path == null) {\r\n\r\n\t\t\tif (this.parent == null) {\r\n\t\t\t\tthis._path = new Path();\r\n\t\t\t} else {\r\n\t\t\t\tlet comps: Path.Component[] = [];\r\n\r\n\t\t\t\tlet child: InkObject = this;\r\n\t\t\t\tlet container = asOrNull(child.parent, Container);\r\n\r\n\t\t\t\twhile (container !== null) {\r\n\r\n\t\t\t\t\tlet namedChild = asINamedContentOrNull(child);\r\n\t\t\t\t\tif (namedChild != null && namedChild.hasValidName) {\r\n\t\t\t\t\t\tcomps.unshift(new Path.Component(namedChild.name));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tcomps.unshift(new Path.Component(container.content.indexOf(child)));\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tchild = container;\r\n\t\t\t\t\tcontainer = asOrNull(container.parent, Container);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis._path = new Path(comps);\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn this._path;\r\n\t}\r\n\tprivate _path: Path | null = null;\r\n\r\n\tpublic ResolvePath(path: Path | null): SearchResult{\r\n\t\tif (path === null) return throwNullException('path');\r\n\t\tif (path.isRelative) {\r\n\t\t\tlet nearestContainer = asOrNull(this, Container);\r\n\r\n\t\t\tif (nearestContainer === null) {\r\n\t\t\t\tDebug.Assert(this.parent !== null, \"Can't resolve relative path because we don't have a parent\");\r\n\t\t\t\tnearestContainer = asOrNull(this.parent, Container);\r\n\t\t\t\tDebug.Assert(nearestContainer !== null, 'Expected parent to be a container');\r\n\t\t\t\tDebug.Assert(path.GetComponent(0).isParent);\r\n\t\t\t\tpath = path.tail;\r\n\t\t\t}\r\n\r\n\t\t\tif (nearestContainer === null) { return throwNullException('nearestContainer'); }\r\n\t\t\treturn nearestContainer.ContentAtPath(path);\r\n\t\t} else {\r\n\t\t\tlet contentContainer = this.rootContentContainer;\r\n\t\t\tif (contentContainer === null) { return throwNullException('contentContainer'); }\r\n\t\t\treturn contentContainer.ContentAtPath(path);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic ConvertPathToRelative(globalPath: Path){\r\n\t\tlet ownPath = this.path;\r\n\r\n\t\tlet minPathLength = Math.min(globalPath.length, ownPath.length);\r\n\t\tlet lastSharedPathCompIndex = -1;\r\n\r\n\t\tfor (let i = 0; i < minPathLength; ++i) {\r\n\t\t\tlet ownComp = ownPath.GetComponent(i);\r\n\t\t\tlet otherComp = globalPath.GetComponent(i);\r\n\r\n\t\t\tif (ownComp.Equals(otherComp)) {\r\n\t\t\t\tlastSharedPathCompIndex = i;\r\n\t\t\t} else {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// No shared path components, so just use global path\r\n\t\tif (lastSharedPathCompIndex == -1)\r\n\t\t\treturn globalPath;\r\n\r\n\t\tlet numUpwardsMoves = (ownPath.componentCount-1) - lastSharedPathCompIndex;\r\n\r\n\t\tlet newPathComps: Path.Component[] = [];\r\n\r\n\t\tfor(let up = 0; up < numUpwardsMoves; ++up)\r\n\t\t\tnewPathComps.push(Path.Component.ToParent());\r\n\r\n\t\tfor (let down = lastSharedPathCompIndex + 1; down < globalPath.componentCount; ++down)\r\n\t\t\tnewPathComps.push(globalPath.GetComponent(down));\r\n\r\n\t\tlet relativePath = new Path(newPathComps, true);\r\n\t\treturn relativePath;\r\n\t}\r\n\r\n\tpublic CompactPathString(otherPath: Path){\r\n\t\tlet globalPathStr = null;\r\n\t\tlet relativePathStr = null;\r\n\r\n\t\tif (otherPath.isRelative) {\r\n\t\t\trelativePathStr = otherPath.componentsString;\r\n\t\t\tglobalPathStr = this.path.PathByAppendingPath(otherPath).componentsString;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tlet relativePath = this.ConvertPathToRelative(otherPath);\r\n\t\t\trelativePathStr = relativePath.componentsString;\r\n\t\t\tglobalPathStr = otherPath.componentsString;\r\n\t\t}\r\n\r\n\t\tif (relativePathStr.length < globalPathStr.length)\r\n\t\t\treturn relativePathStr;\r\n\t\telse\r\n\t\t\treturn globalPathStr;\r\n\t}\r\n\r\n\tget rootContentContainer(){\r\n\t\tlet ancestor: InkObject = this;\r\n\t\twhile (ancestor.parent) {\r\n\t\t\tancestor = ancestor.parent;\r\n\t\t}\r\n\t\treturn asOrNull(ancestor, Container);\r\n\t}\r\n\r\n\tpublic Copy(): InkObject {\r\n\t\tthrow Error(\"Not Implemented: Doesn't support copying\");\r\n\t}\r\n\t// SetChild works slightly diferently in the js implementation.\r\n\t// Since we can't pass an objets property by reference, we instead pass\r\n\t// the object and the property string.\r\n\t// TODO: This method can probably be rewritten with type-safety in mind.\r\n\tpublic SetChild(obj: any, prop: any, value: any){\r\n\t\tif (obj[prop])\r\n\t\t\tobj[prop] = null;\r\n\r\n\t\tobj[prop] = value;\r\n\r\n\t\tif( obj[prop] )\r\n\t\t\tobj[prop].parent = this;\r\n\t}\r\n}\r\n","export class StringBuilder{\r\n\r\n\tprivate string: string;\r\n\r\n\tconstructor(str?: string){\r\n\t\tstr = (typeof str !== 'undefined') ? str.toString() : '';\r\n\t\tthis.string = str;\r\n\t}\r\n\tget Length(): number{\r\n\t\treturn this.string.length;\r\n\t}\r\n\tpublic Append(str: string | null){\r\n\t\tif (str !== null) {\r\n\t\t\tthis.string += str;\r\n\t\t}\r\n\t}\r\n\tpublic AppendLine(str?: string){\r\n\t\tif (typeof str !== 'undefined') this.Append(str);\r\n\t\tthis.string += '\\n';\r\n\t}\r\n\tpublic AppendFormat(format: string, ...args: any[]){\r\n\t\t// taken from http://stackoverflow.com/questions/610406/javascript-equivalent-to-printf-string-format\r\n\t\tthis.string += format.replace(/{(\\d+)}/g, (match: string, num: number) => {\r\n\t\t\treturn typeof args[num] != 'undefined' ? args[num] : match;\r\n\t\t});\r\n\t}\r\n\tpublic toString(): string{\r\n\t\treturn this.string;\r\n\t}\r\n}\r\n","import {throwNullException} from './NullException';\r\nimport {StringBuilder} from './StringBuilder';\r\nimport {ListDefinition} from './ListDefinition';\r\nimport {Story} from './Story';\r\n\r\nexport class InkListItem implements IInkListItem{ // InkListItem is a struct\r\n\r\n\tpublic readonly originName: string | null = null;\r\n\tpublic readonly itemName: string | null = null;\r\n\r\n\tconstructor(originName: string | null, itemName: string | null)\r\n\tconstructor(fullName: string | null)\r\n\tconstructor(){\r\n\t\tif (typeof arguments[1] !== 'undefined'){\r\n\t\t\tlet originName = arguments[0] as string | null;\r\n\t\t\tlet itemName = arguments[1] as string | null;\r\n\r\n\t\t\tthis.originName = originName;\r\n\t\t\tthis.itemName = itemName;\r\n\t\t}\r\n\t\telse if (arguments[0]){\r\n\t\t\tlet fullName = arguments[0] as string;\r\n\r\n\t\t\tlet nameParts = fullName.toString().split('.');\r\n\t\t\tthis.originName = nameParts[0];\r\n\t\t\tthis.itemName = nameParts[1];\r\n\t\t}\r\n\t}\r\n\tpublic static get Null(){\r\n\t\treturn new InkListItem(null, null);\r\n\t}\r\n\tpublic get isNull(){\r\n\t\treturn this.originName == null && this.itemName == null;\r\n\t}\r\n\tget fullName(){\r\n\t\treturn ((this.originName !== null) ? this.originName : '?') + '.' + this.itemName;\r\n\t}\r\n\tpublic toString(): string {\r\n\t\treturn this.fullName;\r\n\t}\r\n\tpublic Equals(obj: InkListItem){\r\n\t\tif (obj instanceof InkListItem) {\r\n\t\t\tlet otherItem = obj;\r\n\t\t\treturn otherItem.itemName == this.itemName\r\n\t\t\t\t&& otherItem.originName == this.originName;\r\n\t\t}\r\n\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// These methods did not exist in the original C# code. Their purpose is to\r\n\t// make `InkListItem` mimics the value-type semantics of the original\r\n\t// struct. Please refer to the end of this file, for a more in-depth\r\n\t// explanation.\r\n\r\n\t/**\r\n\t * Returns a shallow clone of the current instance.\r\n\t */\r\n\tpublic copy(){\r\n\t\treturn new InkListItem(this.originName, this.itemName);\r\n\t}\r\n\t/**\r\n\t * Returns a `SerializedInkListItem` representing the current\r\n\t * instance. The result is intended to be used as a key inside a Map.\r\n\t */\r\n\tpublic serialized(): SerializedInkListItem{\r\n\t\t// We are simply using a JSON representation as a value-typed key.\r\n\t\treturn JSON.stringify({originName: this.originName, itemName: this.itemName});\r\n\t}\r\n\r\n\t/**\r\n\t * Reconstructs a `InkListItem` from the given SerializedInkListItem.\r\n\t */\r\n\tpublic static fromSerializedKey(key: SerializedInkListItem): InkListItem {\r\n\t\tlet obj = JSON.parse(key);\r\n\t\tif (!InkListItem.isLikeInkListItem(obj)) return InkListItem.Null;\r\n\r\n\t\tlet inkListItem = obj as IInkListItem;\r\n\r\n\t\treturn new InkListItem(inkListItem.originName, inkListItem.itemName);\r\n\t}\r\n\r\n\t/**\r\n\t * Determines whether the given item is sufficiently `InkListItem`-like\r\n\t * to be used as a template when reconstructing the InkListItem.\r\n\t */\r\n\tprivate static isLikeInkListItem(item: any){\r\n\t\tif (typeof item !== 'object') return false;\r\n\t\tif (!item.hasOwnProperty('originName') || !item.hasOwnProperty('itemName')) return false;\r\n\t\tif (typeof item.originName !== 'string' && typeof item.originName !== null) return false;\r\n\t\tif (typeof item.itemName !== 'string' && typeof item.itemName !== null) return false;\r\n\r\n\t\treturn true;\r\n\t}\r\n}\r\n\r\nexport class InkList extends Map<SerializedInkListItem, number> {\r\n\tpublic origins: ListDefinition[] | null = null;\r\n\tpublic _originNames: string[] | null = [];\r\n\r\n\tconstructor()\r\n\tconstructor(otherList: InkList)\r\n\tconstructor(singleOriginListName: string, originStory: Story)\r\n\tconstructor(singleElement: KeyValuePair<InkListItem, number>)\r\n\tconstructor(){\r\n\t\t// Trying to be smart here, this emulates the constructor inheritance found\r\n\t\t// in the original code, but only if otherList is an InkList. IIFE FTW.\r\n\t\tsuper((() => {\r\n\t\t\tif (arguments[0] instanceof InkList){\r\n\t\t\t\treturn arguments[0];\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\treturn undefined;\r\n\t\t\t}\r\n\t\t})());\r\n\r\n\t\tif (arguments[0] instanceof InkList){\r\n\t\t\tlet otherList = arguments[0] as InkList;\r\n\r\n\t\t\tif (otherList._originNames) {\r\n\t\t\t\tthis._originNames = otherList._originNames.slice();\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (typeof arguments[0] === 'string'){\r\n\t\t\tlet singleOriginListName = arguments[0] as string;\r\n\t\t\tlet originStory = arguments[1] /* as Story */;\r\n\t\t\tthis.SetInitialOriginName(singleOriginListName);\r\n\r\n\t\t\tlet def = originStory.listDefinitions.TryListGetDefinition(singleOriginListName, null);\r\n\t\t\tif (def.exists){\r\n\t\t\t\tthis.origins = [def.result];\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\tthrow new Error('InkList origin could not be found in story when constructing new list: ' + singleOriginListName);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (typeof arguments[0] === 'object' && arguments[0].hasOwnProperty('Key') && arguments[0].hasOwnProperty('Value')){\r\n\t\t\tlet singleElement = arguments[0] as KeyValuePair<InkListItem, number>;\r\n\t\t\tthis.Add(singleElement.Key, singleElement.Value);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic AddItem(itemOrItemName: InkListItem | string | null){\r\n\t\tif (itemOrItemName instanceof InkListItem){\r\n\t\t\tlet item = itemOrItemName;\r\n\r\n\t\t\tif (item.originName == null) {\r\n\t\t\t\tthis.AddItem(item.itemName);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tif (this.origins === null) return throwNullException('this.origins');\r\n\r\n\t\t\tfor (let origin of this.origins) {\r\n\t\t\t\tif (origin.name == item.originName) {\r\n\t\t\t\t\tlet intVal = origin.TryGetValueForItem(item, 0);\r\n\t\t\t\t\tif (intVal.exists) {\r\n\t\t\t\t\t\tthis.Add(item, intVal.result);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthrow new Error('Could not add the item ' + item + \" to this list because it doesn't exist in the original list definition in ink.\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(\"Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.\");\r\n\t\t}\r\n\t\telse {\r\n\t\t\tlet itemName = itemOrItemName as string | null;\r\n\r\n\t\t\tlet foundListDef: ListDefinition | null = null;\r\n\r\n\t\t\tif (this.origins === null) return throwNullException('this.origins');\r\n\r\n\t\t\tfor (let origin of this.origins) {\r\n\t\t\t\tif (itemName === null) return throwNullException('itemName');\r\n\r\n\t\t\t\tif (origin.ContainsItemWithName(itemName)) {\r\n\t\t\t\t\t\tif (foundListDef != null) {\r\n\t\t\t\t\t\t\tthrow new Error('Could not add the item ' + itemName + ' to this list because it could come from either ' + origin.name + ' or ' + foundListDef.name);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tfoundListDef = origin;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (foundListDef == null)\r\n\t\t\t\tthrow new Error('Could not add the item ' + itemName + \" to this list because it isn't known to any list definitions previously associated with this list.\");\r\n\r\n\t\t\tlet item = new InkListItem(foundListDef.name, itemName);\r\n\t\t\tlet itemVal = foundListDef.ValueForItem(item);\r\n\t\t\tthis.Add(item, itemVal);\r\n\t\t}\r\n\t}\r\n\tpublic ContainsItemNamed(itemName: string | null){\r\n\t\tfor (let [key, value] of this) {\r\n\t\t\tlet item = InkListItem.fromSerializedKey(key);\r\n\t\t\tif (item.itemName == itemName) return true;\r\n\t\t}\r\n\r\n\t\treturn false;\r\n\t}\r\n\tpublic ContainsKey(key: InkListItem){\r\n\t\treturn this.has(key.serialized());\r\n\t}\r\n\tpublic Add(key: InkListItem, value: number){\r\n\t\tlet serializedKey = key.serialized();\r\n\t\tif (this.has(serializedKey)) {\r\n\t\t\t// Throw an exception to match the C# behavior.\r\n\t\t\tthrow new Error(`The Map already contains an entry for ${key}`);\r\n\t\t}\r\n\t\tthis.set(serializedKey, value);\r\n\t}\r\n\tpublic Remove(key: InkListItem){\r\n\t\treturn this.delete(key.serialized());\r\n\t}\r\n\tget Count(){\r\n\t\treturn this.size;\r\n\t}\r\n\tget originOfMaxItem(): ListDefinition | null{\r\n\t\tif (this.origins == null) return null;\r\n\r\n\t\tlet maxOriginName = this.maxItem.Key.originName;\r\n\t\tlet result = null;\r\n\t\tthis.origins.every((origin)=>{\r\n\t\t\tif (origin.name == maxOriginName){\r\n\t\t\t\tresult = origin;\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\telse return true;\r\n\t\t});\r\n\r\n\t\treturn result;\r\n\t}\r\n\tget originNames(): string[]{\r\n\t\tif (this.Count > 0) {\r\n\t\t\tif (this._originNames == null && this.Count > 0)\r\n\t\t\t\tthis._originNames = [];\r\n\t\t\telse {\r\n\t\t\t\tif (!this._originNames) this._originNames = [];\r\n\t\t\t\tthis._originNames.length = 0;\r\n\t\t\t}\r\n\r\n\t\t\tfor (let [key, value] of this) {\r\n\t\t\t\tlet item = InkListItem.fromSerializedKey(key);\r\n\t\t\t\tif (item.originName === null) return throwNullException('item.originName');\r\n\t\t\t\tthis._originNames.push(item.originName);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this._originNames as string[];\r\n\t}\r\n\tpublic SetInitialOriginName(initialOriginName: string){\r\n\t\tthis._originNames = [initialOriginName];\r\n\t}\r\n\tpublic SetInitialOriginNames(initialOriginNames: string[]){\r\n\t\tif (initialOriginNames == null)\r\n\t\t\tthis._originNames = null;\r\n\t\telse\r\n\t\t\tthis._originNames = initialOriginNames.slice();// store a copy\r\n\t}\r\n\tget maxItem(){\r\n\t\tlet max: KeyValuePair<InkListItem, number> = {\r\n\t\t\tKey: InkListItem.Null,\r\n\t\t\tValue: 0,\r\n\t\t};\r\n\t\tfor (let [key, value] of this) {\r\n\t\t\tlet item = InkListItem.fromSerializedKey(key);\r\n\t\t\tif (max.Key.isNull || value > max.Value)\r\n\t\t\t\tmax = { Key: item, Value: value };\r\n\t\t}\r\n\r\n\t\treturn max;\r\n\t}\r\n\tget minItem(){\r\n\t\tlet min: KeyValuePair<InkListItem, number> = {\r\n\t\t\tKey: InkListItem.Null,\r\n\t\t\tValue: 0,\r\n\t\t};\r\n\t\tfor (let [key, value] of this) {\r\n\t\t\tlet item = InkListItem.fromSerializedKey(key);\r\n\t\t\tif (min.Key.isNull || value < min.Value) {\r\n\t\t\t\tmin = { Key: item, Value: value };\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn min;\r\n\t}\r\n\tget inverse(){\r\n\t\tlet list = new InkList();\r\n\t\tif (this.origins != null) {\r\n\t\t\tfor (let origin of this.origins) {\r\n\t\t\t\tfor (let [key, value] of origin.items) {\r\n\t\t\t\t\tlet item = InkListItem.fromSerializedKey(key);\r\n\t\t\t\t\tif (!this.ContainsKey(item))\r\n\t\t\t\t\t\tlist.Add(item, value);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn list;\r\n\t}\r\n\tget all(){\r\n\t\tlet list = new InkList();\r\n\t\tif (this.origins != null) {\r\n\t\t\tfor(let origin of this.origins) {\r\n\t\t\t\tfor (let [key, value] of origin.items) {\r\n\t\t\t\t\tlet item = InkListItem.fromSerializedKey(key);\r\n\t\t\t\t\tlist.set(item.serialized(), value);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn list;\r\n\t}\r\n\tpublic Union(otherList: InkList){\r\n\t\tlet union = new InkList(this);\r\n\t\tfor(let [key, value] of otherList) {\r\n\t\t\tunion.set(key, value);\r\n\t\t}\r\n\t\treturn union;\r\n\t}\r\n\tpublic Intersect(otherList: InkList){\r\n\t\tlet intersection = new InkList();\r\n\t\tfor(let [key, value] of this) {\r\n\t\t\tif (otherList.has(key))\r\n\t\t\t\tintersection.set(key, value);\r\n\t\t}\r\n\r\n\t\treturn intersection;\r\n\t}\r\n\tpublic Without(listToRemove: InkList){\r\n\t\tlet result = new InkList(this);\r\n\t\tfor(let [key, value] of listToRemove) {\r\n\t\t\tresult.delete(key);\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\tpublic Contains(otherList: InkList){\r\n\t\tfor(let [key, value] of otherList) {\r\n\t\t\tif (!this.has(key)) return false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t}\r\n\tpublic GreaterThan(otherList: InkList){\r\n\t\tif (this.Count == 0) return false;\r\n\t\tif (otherList.Count == 0) return true;\r\n\r\n\t\treturn this.minItem.Value > otherList.maxItem.Value;\r\n\t}\r\n\tpublic GreaterThanOrEquals(otherList: InkList){\r\n\t\tif (this.Count == 0) return false;\r\n\t\tif (otherList.Count == 0) return true;\r\n\r\n\t\treturn this.minItem.Value >= otherList.minItem.Value\r\n\t\t\t&& this.maxItem.Value >= otherList.maxItem.Value;\r\n\t}\r\n\tpublic LessThan(otherList: InkList){\r\n\t\tif (otherList.Count == 0) return false;\r\n\t\tif (this.Count == 0) return true;\r\n\r\n\t\treturn this.maxItem.Value < otherList.minItem.Value;\r\n\t}\r\n\tpublic LessThanOrEquals(otherList: InkList){\r\n\t\tif (otherList.Count == 0) return false;\r\n\t\tif (this.Count == 0) return true;\r\n\r\n\t\treturn this.maxItem.Value <= otherList.maxItem.Value\r\n\t\t\t&& this.minItem.Value <= otherList.minItem.Value;\r\n\t}\r\n\tpublic MaxAsList(){\r\n\t\tif (this.Count > 0)\r\n\t\t\treturn new InkList(this.maxItem);\r\n\t\telse\r\n\t\t\treturn new InkList();\r\n\t}\r\n\tpublic MinAsList(){\r\n\t\tif (this.Count > 0)\r\n\t\t\treturn new InkList(this.minItem);\r\n\t\telse\r\n\t\t\treturn new InkList();\r\n\t}\r\n\tpublic ListWithSubRange(minBound: any, maxBound: any)\r\n\t{\r\n\t\tif (this.Count == 0) return new InkList();\r\n\r\n\t\tlet ordered = this.orderedItems;\r\n\r\n\t\tlet minValue = 0;\r\n\t\tlet maxValue = Number.MAX_SAFE_INTEGER;\r\n\r\n\t\tif (Number.isInteger(minBound)) {\r\n\t\t\tminValue = minBound;\r\n\t\t} else {\r\n\t\t\tif (minBound instanceof InkList && minBound.Count > 0 )\r\n\t\t\t\tminValue = minBound.minItem.Value;\r\n\t\t}\r\n\r\n\t\tif (Number.isInteger(maxBound)) {\r\n\t\t\tmaxValue = maxBound;\r\n\t\t} else {\r\n\t\t\tif (minBound instanceof InkList && (minBound).Count > 0)\r\n\t\t\t\tmaxValue = maxBound.maxItem.Value;\r\n\t\t}\r\n\r\n\t\tlet subList = new InkList();\r\n\t\tsubList.SetInitialOriginNames(this.originNames);\r\n\t\tfor (let item of ordered) {\r\n\t\t\tif (item.Value >= minValue && item.Value <= maxValue ) {\r\n\t\t\t\tsubList.Add(item.Key, item.Value);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn subList;\r\n\t}\r\n\tpublic Equals(otherInkList: InkList){\r\n\t\tif (otherInkList instanceof InkList === false) return false;\r\n\t\tif (otherInkList.Count != this.Count) return false;\r\n\r\n\t\tfor(let [key, value] of this) {\r\n\t\t\tif (!otherInkList.has(key))\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t}\r\n\t// GetHashCode not implemented\r\n\tget orderedItems() {\r\n\t\t// List<KeyValuePair<InkListItem, int>>\r\n\t\tlet ordered = new Array<KeyValuePair<InkListItem, number>>();\r\n\r\n\t\tfor(let [key, value] of this) {\r\n\t\t\tlet item = InkListItem.fromSerializedKey(key);\r\n\t\t\tordered.push({ Key: item, Value: value });\r\n\t\t}\r\n\r\n\t\tordered.sort((x, y) => {\r\n\t\t\tif (x.Key.originName === null) { return throwNullException('x.Key.originName'); }\r\n\t\t\tif (y.Key.originName === null) { return throwNullException('y.Key.originName'); }\r\n\r\n\t\t\tif (x.Value == y.Value) {\r\n\t\t\t\treturn x.Key.originName.localeCompare(y.Key.originName);\r\n\t\t\t} else {\r\n\t\t\t\t// TODO: refactor this bit into a numberCompareTo method?\r\n\t\t\t\tif (x.Value < y.Value)\r\n\t\t\t\t\treturn -1;\r\n\t\t\t\treturn x.Value > y.Value ? 1 : 0;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\treturn ordered;\r\n\t}\r\n\tpublic toString(){\r\n\t\tlet ordered = this.orderedItems;\r\n\r\n\t\tlet sb = new StringBuilder();\r\n\t\tfor (let i = 0; i < ordered.length; i++) {\r\n\t\t\tif (i > 0)\r\n\t\t\t\tsb.Append(', ');\r\n\r\n\t\t\tlet item = ordered[i].Key;\r\n\t\t\tif (item.itemName === null) return throwNullException('item.itemName');\r\n\t\t\tsb.Append(item.itemName);\r\n\t\t}\r\n\r\n\t\treturn sb.toString();\r\n\t}\r\n\t// casting a InkList to a Number, for somereason, actually gives a number.\r\n\t// This messes up the type detection when creating a Value from a InkList.\r\n\t// Returning NaN here prevents that.\r\n\tpublic valueOf(){\r\n\t\treturn NaN;\r\n\t}\r\n}\r\n\r\n/**\r\n * In the original C# code, `InkListItem` was defined as value type, meaning\r\n * that two `InkListItem` would be considered equal as long as they held the\r\n * same values. This doesn't hold true in Javascript, as `InkListItem` is a\r\n * reference type (Javascript doesn't allow the creation of custom value types).\r\n *\r\n * The key equality of Map objects is based on the \"SameValueZero\" algorithm;\r\n * since `InkListItem` is a value type, two keys will only be considered\r\n * equal if they are, in fact, the same object. As we are trying to emulate\r\n * the original behavior as close as possible, this will lead to unforeseen\r\n * side effects.\r\n *\r\n * In order to have a key equality based on value semantics, we'll convert\r\n * `InkListItem` to a valid string representation and use this representation\r\n * as a key (strings are value types in Javascript). Rather than using the\r\n * type `string` directly, we'll alias it to `SerializedInkListItem` and use\r\n * this type as the key for our Map-based `InkList`.\r\n *\r\n * Reducing `InkListItem` to a JSON representation would not be bulletproof\r\n * in the general case, but for our needs it works well. The major downside of\r\n * this method is that we will have to to reconstruct the original `InkListItem`\r\n * every time we'll need to access its properties.\r\n */\r\nexport type SerializedInkListItem = string;\r\n\r\n/**\r\n * An interface inherited by `InkListItem`, defining exposed\r\n * properties. It's mainly used when deserializing a `InkListItem` from its\r\n * key (`SerializedInkListItem`)\r\n */\r\ninterface IInkListItem{\r\n\treadonly originName: string | null;\r\n\treadonly itemName: string | null;\r\n}\r\nexport interface KeyValuePair<K, V> {\r\n\tKey: K;\r\n\tValue: V;\r\n}\r\n","export class StoryException extends Error{\r\n\r\n\tpublic useEndLineNumber: boolean;\r\n\tpublic message: string;\r\n\tpublic name: string;\r\n\r\n\tconstructor(message: string){\r\n\t\tsuper(message);\r\n\t\tthis.useEndLineNumber = false;\r\n\t\tthis.message = message;\r\n\t\tthis.name = 'StoryException';\r\n\t}\r\n}\r\n","// tslint:disable:jsdoc-format\r\n/**\r\n * This interface normalize the `TryGet` behavior found in the original\r\n * C# project. Any `TryGet` method will return a object conforming to this\r\n * interface.\r\n *\r\n * The original function returns a boolean and has a second parameter called\r\n * item that is an `out`. Both are needed and we can't just return the item\r\n * because it'll always be truthy. Instead, we return an object containing\r\n * whether the result exists (`exists`) and the result itself (`result`).\r\n *\r\n * For instance a `TryGet` prototype would look like this:\r\n```\r\nTryGetItemWithValue(val: number, item: InkListItem): TryGetResult<InkListItem>{\r\n```\r\n *\r\n * On the other hand, dealing with the result can be done in the following way:\r\n```\r\nvar item = item.TryGetItemWithValue(intVal, InkListItem.Null);\r\nif (item.exists) {\r\n\tconsole.log(item.result)\r\n}\r\n```\r\n *\r\n */\r\nexport interface TryGetResult<T> {\r\n\tresult: T;\r\n\texists: boolean;\r\n}\r\n\r\nexport function tryGetValueFromMap<K, V>(map: Map<K, V> | null, key: K, /* out */ value: V): TryGetResult<V> {\r\n\tif (map === null) {\r\n\t\treturn { result: value, exists: false };\r\n\t}\r\n\r\n\tlet val = map.get(key);\r\n\r\n\tif (val) {\r\n\t\treturn { result: val, exists: true };\r\n\t} else {\r\n\t\treturn { result: value, exists: false };\r\n\t}\r\n}\r\n\r\nexport function tryParseInt(value: any, /* out */ defaultValue: number = 0): TryGetResult<number> {\r\n\tlet val = parseInt(value);\r\n\r\n\tif (!Number.isNaN(val)) {\r\n\t\treturn { result: val, exists: true };\r\n\t} else {\r\n\t\treturn { result: defaultValue, exists: false };\r\n\t}\r\n}\r\n\r\nexport function tryParseFloat(value: any, /* out */ defaultValue: number = 0): TryGetResult<number> {\r\n\tlet val = parseFloat(value);\r\n\r\n\tif (!Number.isNaN(val)) {\r\n\t\treturn { result: val, exists: true };\r\n\t} else {\r\n\t\treturn { result: defaultValue, exists: false };\r\n\t}\r\n}\r\n","import {InkObject} from './Object';\r\nimport {Path} from './Path';\r\nimport {InkList, InkListItem} from './InkList';\r\nimport {StoryException} from './StoryException';\r\nimport {asOrNull, asOrThrows} from './TypeAssertion';\r\nimport {tryParseInt, tryParseFloat} from './TryGetResult';\r\nimport {throwNullException} from './NullException';\r\n\r\nexport abstract class AbstractValue extends InkObject{\r\n\tpublic abstract get valueType(): ValueType;\r\n\tpublic abstract get isTruthy(): boolean;\r\n\tpublic abstract get valueObject(): any;\r\n\r\n\tpublic abstract Cast(newType: ValueType): Value<any>;\r\n\r\n\tpublic static Create(val: any): Value<any> | null{\r\n\t\t// Implicitly convert bools into ints\r\n\t\tif (typeof val === 'boolean'){\r\n\t\t\tlet b = !!val;\r\n\t\t\tval = (b) ? 1 : 0;\r\n\t\t}\r\n\r\n\t\t// https://github.com/y-lohse/inkjs/issues/425\r\n\t\t// Changed condition sequence, because Number('') is\r\n\t\t// parsed to 0, which made setting string to empty\r\n\t\t// impossible\r\n\t\tif (typeof val === 'string') {\r\n\t\t\treturn new StringValue(String(val));\r\n\t\t} else if (Number.isInteger(Number(val))) {\r\n\t\t\treturn new IntValue(Number(val));\r\n\t\t} else if (!isNaN(val)) {\r\n\t\t\treturn new FloatValue(Number(val));\r\n\t\t} else if (val instanceof Path) {\r\n\t\t\treturn new DivertTargetValue(asOrThrows(val, Path));\r\n\t\t} else if (val instanceof InkList) {\r\n\t\t\treturn new ListValue(asOrThrows(val, InkList));\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\tpublic Copy() {\r\n\t\treturn asOrThrows(AbstractValue.Create(this), InkObject);\r\n\t}\r\n\tpublic BadCastException(targetType: ValueType) {\r\n\t\treturn new StoryException(\"Can't cast \"+this.valueObject+' from ' + this.valueType+' to '+targetType);\r\n\t}\r\n}\r\n\r\nexport abstract class Value<T extends { toString: () => string; }> extends AbstractValue{\r\n\tpublic value: T | null;\r\n\r\n\tconstructor(val: T | null){\r\n\t\tsuper();\r\n\t\tthis.value = val;\r\n\t}\r\n\tpublic get valueObject(){\r\n\t\treturn this.value;\r\n\t}\r\n\tpublic toString(){\r\n\t\tif (this.value === null) return throwNullException('Value.value');\r\n\t\treturn this.value.toString();\r\n\t}\r\n}\r\n\r\nexport class IntValue extends Value<number>{\r\n\tconstructor(val: number){\r\n\t\tsuper(val || 0);\r\n\t}\r\n\tpublic get isTruthy(){\r\n\t\treturn this.value != 0;\r\n\t}\r\n\tpublic get valueType() {\r\n\t\treturn ValueType.Int;\r\n\t}\r\n\r\n\tpublic Cast(newType: ValueType): Value<any>{\r\n\t\tif (this.value === null) return throwNullException('Value.value');\r\n\r\n\t\tif (newType == this.valueType) {\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tif (newType == ValueType.Float) {\r\n\t\t\treturn new FloatValue(this.value);\r\n\t\t}\r\n\r\n\t\tif (newType == ValueType.String) {\r\n\t\t\treturn new StringValue('' + this.value);\r\n\t\t}\r\n\r\n\t\tthrow this.BadCastException(newType);\r\n\t}\r\n}\r\n\r\nexport class FloatValue extends Value<number>{\r\n\tconstructor(val: number){\r\n\t\tsuper(val || 0.0);\r\n\t}\r\n\tpublic get isTruthy(){\r\n\t\treturn this.value != 0.0;\r\n\t}\r\n\tpublic get valueType(){\r\n\t\treturn ValueType.Float;\r\n\t}\r\n\r\n\tpublic Cast(newType: ValueType): Value<any>{\r\n\t\tif (this.value === null) return throwNullException('Value.value');\r\n\r\n\t\tif (newType == this.valueType) {\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tif (newType == ValueType.Int) {\r\n\t\t\treturn new IntValue(this.value);\r\n\t\t}\r\n\r\n\t\tif (newType == ValueType.String) {\r\n\t\t\treturn new StringValue('' + this.value);\r\n\t\t}\r\n\r\n\t\tthrow this.BadCastException(newType);\r\n\t}\r\n}\r\n\r\nexport class StringValue extends Value<string>{\r\n\tpublic _isNewline: boolean;\r\n\tpublic _isInlineWhitespace: boolean;\r\n\r\n\tconstructor(val: string){\r\n\t\tsuper(val || '');\r\n\r\n\t\tthis._isNewline = (this.value == '\\n');\r\n\t\tthis._isInlineWhitespace = true;\r\n\r\n\t\tif (this.value === null) return throwNullException('Value.value');\r\n\r\n\t\tif (this.value.length > 0) {\r\n\t\t\tthis.value.split('').every((c) => {\r\n\t\t\t\tif (c != ' ' && c != '\\t'){\r\n\t\t\t\t\tthis._isInlineWhitespace = false;\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn true;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\tpublic get valueType(){\r\n\t\treturn ValueType.String;\r\n\t}\r\n\tpublic get isTruthy(){\r\n\t\tif (this.value === null) return throwNullException('Value.value');\r\n\t\treturn this.value.length > 0;\r\n\t}\r\n\tpublic get isNewline(){\r\n\t\treturn this._isNewline;\r\n\t}\r\n\tpublic get isInlineWhitespace(){\r\n\t\treturn this._isInlineWhitespace;\r\n\t}\r\n\tpublic get isNonWhitespace(){\r\n\t\treturn !this.isNewline && !this.isInlineWhitespace;\r\n\t}\r\n\r\n\tpublic Cast(newType: ValueType): Value<any>{\r\n\t\tif (newType == this.valueType) {\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tif (newType == ValueType.Int) {\r\n\r\n\t\t\tlet parsedInt = tryParseInt(this.value);\r\n\t\t\tif (parsedInt.exists) {\r\n\t\t\t\treturn new IntValue(parsedInt.result);\r\n\t\t\t} else {\r\n\t\t\t\tthrow this.BadCastException(newType);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (newType == ValueType.Float) {\r\n\t\t\tlet parsedFloat = tryParseFloat(this.value);\r\n\t\t\tif (parsedFloat.exists) {\r\n\t\t\t\treturn new FloatValue(parsedFloat.result);\r\n\t\t\t} else {\r\n\t\t\t\tthrow this.BadCastException(newType);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthrow this.BadCastException(newType);\r\n\t}\r\n}\r\n\r\nexport class DivertTargetValue extends Value<Path>{\r\n\tconstructor(targetPath: Path){\r\n\t\tsuper(targetPath);\r\n\t}\r\n\tpublic get valueType() {\r\n\t\treturn ValueType.DivertTarget;\r\n\t}\r\n\tpublic get targetPath(){\r\n\t\tif (this.value === null) return throwNullException('Value.value');\r\n\t\treturn this.value;\r\n\t}\r\n\tpublic set targetPath(value: Path){\r\n\t\tthis.value = value;\r\n\t}\r\n\tpublic get isTruthy(): never{\r\n\t\tthrow new Error('Shouldn\\'t be checking the truthiness of a divert target');\r\n\t}\r\n\r\n\tpublic Cast(newType: ValueType): Value<any>{\r\n\t\tif (newType == this.valueType)\r\n\t\t\treturn this;\r\n\r\n\t\tthrow this.BadCastException(newType);\r\n\t}\r\n\tpublic toString(){\r\n\t\treturn 'DivertTargetValue(' + this.targetPath + ')';\r\n\t}\r\n}\r\n\r\nexport class VariablePointerValue extends Value<string>{\r\n\tpublic _contextIndex: number;\r\n\r\n\tconstructor(variableName: string, contextIndex: number = -1){\r\n\t\tsuper(variableName);\r\n\r\n\t\tthis._contextIndex = contextIndex;\r\n\t}\r\n\r\n\tpublic get contextIndex(){\r\n\t\treturn this._contextIndex;\r\n\t}\r\n\tpublic set contextIndex(value: number) {\r\n\t\tthis._contextIndex = value;\r\n\t}\r\n\tpublic get variableName(){\r\n\t\tif (this.value === null) return throwNullException('Value.value');\r\n\t\treturn this.value;\r\n\t}\r\n\tpublic set variableName(value: string){\r\n\t\tthis.value = value;\r\n\t}\r\n\tpublic get valueType() {\r\n\t\treturn ValueType.VariablePointer;\r\n\t}\r\n\r\n\tpublic get isTruthy(): never{\r\n\t\tthrow new Error(\"Shouldn't be checking the truthiness of a variable pointer\");\r\n\t}\r\n\r\n\tpublic Cast(newType: ValueType): Value<any>{\r\n\t\tif (newType == this.valueType)\r\n\t\t\treturn this;\r\n\r\n\t\tthrow this.BadCastException(newType);\r\n\t}\r\n\tpublic toString(){\r\n\t\treturn 'VariablePointerValue(' + this.variableName + ')';\r\n\t}\r\n\tpublic Copy(){\r\n\t\treturn new VariablePointerValue(this.variableName, this.contextIndex);\r\n\t}\r\n}\r\n\r\nexport class ListValue extends Value<InkList>{\r\n\tpublic get isTruthy(){\r\n\t\tif (this.value === null) { return throwNullException('this.value'); }\r\n\t\treturn this.value.Count > 0;\r\n\t}\r\n\tpublic get valueType() {\r\n\t\treturn ValueType.List;\r\n\t}\r\n\tpublic Cast(newType: ValueType): Value<any>{\r\n\t\tif (this.value === null) return throwNullException('Value.value');\r\n\r\n\t\tif (newType == ValueType.Int) {\r\n\t\t\tlet max = this.value.maxItem;\r\n\t\t\tif( max.Key.isNull )\r\n\t\t\treturn new IntValue(0);\r\n\t\t\telse\r\n\t\t\treturn new IntValue(max.Value);\r\n\t\t}\r\n\t\telse if (newType == ValueType.Float) {\r\n\t\t\tlet max = this.value.maxItem;\r\n\t\t\tif (max.Key.isNull)\r\n\t\t\treturn new FloatValue(0.0);\r\n\t\t\telse\r\n\t\t\treturn new FloatValue(max.Value);\r\n\t\t}\r\n\t\telse if (newType == ValueType.String) {\r\n\t\t\tlet max = this.value.maxItem;\r\n\t\t\tif (max.Key.isNull)\r\n\t\t\treturn new StringValue('');\r\n\t\t\telse {\r\n\t\t\t\treturn new StringValue(max.Key.toString());\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (newType == this.valueType) return this;\r\n\r\n\t\tthrow this.BadCastException(newType);\r\n\t}\r\n\tconstructor();\r\n\tconstructor(list: InkList);\r\n\tconstructor(listOrSingleItem: InkListItem, singleValue: number)\r\n\tconstructor(listOrSingleItem?: InkListItem | InkList, singleValue?: number){\r\n\t\tsuper(null);\r\n\r\n\t\tif (!listOrSingleItem && !singleValue) {\r\n\t\t\tthis.value = new InkList();\r\n\t\t}\r\n\t\telse if (listOrSingleItem instanceof InkList) {\r\n\t\t\tthis.value = new InkList(listOrSingleItem);\r\n\t\t}\r\n\t\telse if (listOrSingleItem instanceof InkListItem && typeof singleValue === 'number') {\r\n\t\t\tthis.value = new InkList({\r\n\t\t\t\tKey: listOrSingleItem,\r\n\t\t\t\tValue: singleValue,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\tpublic static RetainListOriginsForAssignment(oldValue: InkObject | null, newValue: InkObject){\r\n\t\tlet oldList = asOrNull(oldValue, ListValue);\r\n\t\tlet newList = asOrNull(newValue, ListValue);\r\n\r\n\t\tif (newList && newList.value === null) return throwNullException('newList.value');\r\n\t\tif (oldList && oldList.value === null) return throwNullException('oldList.value');\r\n\r\n\t\t// When assigning the empty list, try to retain any initial origin names\r\n\t\tif (oldList && newList && newList.value!.Count == 0)\r\n\t\t\tnewList.value!.SetInitialOriginNames(oldList.value!.originNames);\r\n\t}\r\n}\r\n\r\nexport enum ValueType {\r\n\tInt = 0,\r\n\tFloat = 1,\r\n\tList = 2,\r\n\tString = 3,\r\n\tDivertTarget = 4,\r\n\tVariablePointer = 5,\r\n}\r\n","import {InkObject} from './Object';\r\nimport {Container} from './Container';\r\n\r\nexport class SearchResult{\r\n\tpublic obj: InkObject | null = null;\r\n\tpublic approximate: boolean = false;\r\n\r\n\tget correctObj(){\r\n\t\treturn this.approximate ? null : this.obj;\r\n\t}\r\n\r\n\tget container(){\r\n\t\treturn (this.obj instanceof Container) ? this.obj : null;\r\n\t}\r\n\r\n\tpublic copy(){\r\n\t\tlet searchResult = new SearchResult();\r\n\t\tsearchResult.obj = this.obj;\r\n\t\tsearchResult.approximate = this.approximate;\r\n\r\n\t\treturn searchResult;\r\n\t}\r\n}\r\n","import {StringValue} from './Value';\r\nimport {throwNullException} from './NullException';\r\nimport {StringBuilder} from './StringBuilder';\r\nimport {INamedContent} from './INamedContent';\r\nimport {InkObject} from './Object';\r\nimport {SearchResult} from './SearchResult';\r\nimport {Path} from './Path';\r\nimport {Debug} from './Debug';\r\nimport {tryGetValueFromMap} from './TryGetResult';\r\nimport {asINamedContentOrNull, asOrNull, asOrThrows} from './TypeAssertion';\r\n\r\nexport class Container extends InkObject implements INamedContent{\r\n\tpublic name: string = '';\r\n\r\n\tpublic _content: InkObject[] = [];\r\n\tpublic namedContent: Map<string, INamedContent> = new Map();\r\n\r\n\tpublic visitsShouldBeCounted: boolean = false;\r\n\tpublic turnIndexShouldBeCounted: boolean = false;\r\n\tpublic countingAtStartOnly: boolean = false;\r\n\r\n\tpublic _pathToFirstLeafContent: Path | null = null;\r\n\r\n\tget hasValidName(){\r\n\t\treturn this.name != null && this.name.length > 0;\r\n\t}\r\n\tget content(){\r\n\t\treturn this._content;\r\n\t}\r\n\tset content(value: InkObject[]){\r\n\t\tthis.AddContent(value);\r\n\t}\r\n\tget namedOnlyContent(){\r\n\t\tlet namedOnlyContentDict: Map<string, InkObject> | null = new Map();\r\n\r\n\t\tfor (let [key, value] of this.namedContent){\r\n\t\t\tlet inkObject = asOrThrows(value, InkObject);\r\n\t\t\tnamedOnlyContentDict.set(key, inkObject);\r\n\t\t}\r\n\r\n\t\tfor (let c of this.content){\r\n\t\t\tlet named = asINamedContentOrNull(c);\r\n\t\t\tif (named != null && named.hasValidName) {\r\n\t\t\t\tnamedOnlyContentDict.delete(named.name);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (namedOnlyContentDict.size == 0)\r\n\t\t\tnamedOnlyContentDict = null;\r\n\r\n\t\treturn namedOnlyContentDict;\r\n\t}\r\n\tset namedOnlyContent(value: Map<string, InkObject> | null){\r\n\t\tlet existingNamedOnly = this.namedOnlyContent;\r\n\t\tif (existingNamedOnly != null) {\r\n\t\t\tfor (let [key, val] of existingNamedOnly){\r\n\t\t\t\tthis.namedContent.delete(key);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (value == null)\r\n\t\t\treturn;\r\n\r\n\t\tfor (let [key, val] of value){\r\n\t\t\tlet named = asINamedContentOrNull(val);\r\n\t\t\tif (named != null)\r\n\t\t\t\tthis.AddToNamedContentOnly(named);\r\n\t\t}\r\n\t}\r\n\tget countFlags(): number{\r\n\t\tlet flags: Container.CountFlags = 0;\r\n\t\tif (this.visitsShouldBeCounted)    flags |= Container.CountFlags.Visits;\r\n\t\tif (this.turnIndexShouldBeCounted) flags |= Container.CountFlags.Turns;\r\n\t\tif (this.countingAtStartOnly)      flags |= Container.CountFlags.CountStartOnly;\r\n\r\n\t\tif (flags == Container.CountFlags.CountStartOnly) {\r\n\t\t\tflags = 0;\r\n\t\t}\r\n\r\n\t\treturn flags;\r\n\t}\r\n\tset countFlags(value: number){\r\n\t\tlet flag: Container.CountFlags = value;\r\n\t\tif ((flag & Container.CountFlags.Visits) > 0) this.visitsShouldBeCounted = true;\r\n\t\tif ((flag & Container.CountFlags.Turns) > 0)  this.turnIndexShouldBeCounted = true;\r\n\t\tif ((flag & Container.CountFlags.CountStartOnly) > 0) this.countingAtStartOnly = true;\r\n\t}\r\n\tget pathToFirstLeafContent(){\r\n\t\tif( this._pathToFirstLeafContent == null )\r\n\t\t\tthis._pathToFirstLeafContent = this.path.PathByAppendingPath(this.internalPathToFirstLeafContent);\r\n\r\n\t\treturn this._pathToFirstLeafContent;\r\n\t}\r\n\tget internalPathToFirstLeafContent(){\r\n\t\tlet components: Path.Component[] = [];\r\n\t\tlet container: Container = this;\r\n\t\twhile (container instanceof Container) {\r\n\t\t\tif (container.content.length > 0) {\r\n\t\t\t\tcomponents.push(new Path.Component(0));\r\n\t\t\t\tcontainer = container.content[0] as Container;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn new Path(components);\r\n\t}\r\n\r\n\tpublic AddContent(contentObjOrList: InkObject | InkObject[]){\r\n\t\tif (contentObjOrList instanceof Array){\r\n\t\t\tlet contentList = contentObjOrList as InkObject[];\r\n\r\n\t\t\tfor (let c of contentList) {\r\n\t\t\t\tthis.AddContent(c);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse{\r\n\t\t\tlet contentObj = contentObjOrList as InkObject;\r\n\t\t\tthis._content.push(contentObj);\r\n\r\n\t\t\tif (contentObj.parent) {\r\n\t\t\t\tthrow new Error('content is already in ' + contentObj.parent);\r\n\t\t\t}\r\n\r\n\t\t\tcontentObj.parent = this;\r\n\r\n\t\t\tthis.TryAddNamedContent(contentObj);\r\n\t\t}\r\n\t}\r\n\tpublic TryAddNamedContent(contentObj: InkObject){\r\n\t\tlet namedContentObj = asINamedContentOrNull(contentObj);\r\n\t\tif (namedContentObj != null && namedContentObj.hasValidName){\r\n\t\t\tthis.AddToNamedContentOnly(namedContentObj);\r\n\t\t}\r\n\t}\r\n\tpublic AddToNamedContentOnly(namedContentObj: INamedContent){\r\n\t\tDebug.AssertType(namedContentObj, InkObject, 'Can only add Runtime.Objects to a Runtime.Container');\r\n\t\tlet runtimeObj = asOrThrows(namedContentObj, InkObject);\r\n\t\truntimeObj.parent = this;\r\n\r\n\t\tthis.namedContent.set(namedContentObj.name, namedContentObj);\r\n\t}\r\n\tpublic ContentAtPath(path: Path, partialPathStart: number = 0, partialPathLength: number = -1){\r\n\t\tif (partialPathLength == -1)\r\n\t\t\tpartialPathLength = path.length;\r\n\r\n\t\tlet result = new SearchResult();\r\n\t\tresult.approximate = false;\r\n\r\n\t\tlet currentContainer: Container | null = this;\r\n\t\tlet currentObj: InkObject = this;\r\n\r\n\t\tfor (let i = partialPathStart; i < partialPathLength; ++i) {\r\n\t\t\tlet comp = path.GetComponent(i);\r\n\t\t\tif (currentContainer == null) {\r\n\t\t\t\tresult.approximate = true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tlet foundObj: InkObject | null = currentContainer.ContentWithPathComponent(comp);\r\n\r\n\t\t\tif (foundObj == null) {\r\n\t\t\t\tresult.approximate = true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tcurrentObj = foundObj;\r\n\t\t\tcurrentContainer = asOrNull(foundObj, Container);\r\n\t\t}\r\n\r\n\t\tresult.obj = currentObj;\r\n\r\n\t\treturn result;\r\n\t}\r\n\tpublic InsertContent(contentObj: InkObject, index: number){\r\n\t\tthis.content[index] = contentObj;\r\n\r\n\t\tif (contentObj.parent) {\r\n\t\t\tthrow new Error('content is already in ' + contentObj.parent);\r\n\t\t}\r\n\r\n\t\tcontentObj.parent = this;\r\n\r\n\t\tthis.TryAddNamedContent(contentObj);\r\n\t}\r\n\tpublic AddContentsOfContainer(otherContainer: Container){\r\n\t\tthis.content = this.content.concat(otherContainer.content);\r\n\r\n\t\tfor (let obj of otherContainer.content) {\r\n\t\t\tobj.parent = this;\r\n\t\t\tthis.TryAddNamedContent(obj);\r\n\t\t}\r\n\t}\r\n\tpublic ContentWithPathComponent(component: Path.Component): InkObject | null{\r\n\t\tif (component.isIndex) {\r\n\r\n\t\t\tif (component.index >= 0 && component.index < this.content.length) {\r\n\t\t\t\treturn this.content[component.index];\r\n\t\t\t}\r\n\r\n\t\t\telse {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\telse if (component.isParent) {\r\n\t\t\treturn this.parent;\r\n\t\t}\r\n\r\n\t\telse {\r\n\t\t\tif (component.name === null) { return throwNullException('component.name'); }\r\n\t\t\tlet foundContent = tryGetValueFromMap(this.namedContent, component.name, null);\r\n\t\t\tif (foundContent.exists){\r\n\t\t\t\treturn asOrThrows(foundContent.result, InkObject);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tpublic BuildStringOfHierarchy(): string;\r\n\tpublic BuildStringOfHierarchy(sb: StringBuilder, indentation: number, pointedObj: InkObject | null): string;\r\n\tpublic BuildStringOfHierarchy(){\r\n\t\tlet sb: StringBuilder;\r\n\t\tif (arguments.length == 0){\r\n\t\t\tsb = new StringBuilder();\r\n\t\t\tthis.BuildStringOfHierarchy(sb, 0, null);\r\n\t\t\treturn sb.toString();\r\n\t\t}\r\n\r\n\t\tsb = arguments[0] as StringBuilder;\r\n\t\tlet indentation = arguments[1] as number;\r\n\t\tlet pointedObj = arguments[2] as InkObject | null;\r\n\r\n\t\tfunction appendIndentation(){\r\n\t\t\tconst spacesPerIndent = 4; // Truly const in the original code\r\n\t\t\tfor(let i = 0; i < spacesPerIndent*indentation; ++i) {\r\n\t\t\t\tsb.Append(' ');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tappendIndentation();\r\n\t\tsb.Append('[');\r\n\r\n\t\tif (this.hasValidName) {\r\n\t\t\tsb.AppendFormat(' ({0})', this.name);\r\n\t\t}\r\n\r\n\t\tif (this == pointedObj) {\r\n\t\t\tsb.Append('  <---');\r\n\t\t}\r\n\r\n\t\tsb.AppendLine();\r\n\r\n\t\tindentation++;\r\n\r\n\t\tfor (let i = 0; i < this.content.length; ++i) {\r\n\r\n\t\t\tlet obj = this.content[i];\r\n\r\n\t\t\tif (obj instanceof Container) {\r\n\r\n\t\t\t\tlet container = obj as Container;\r\n\r\n\t\t\t\tcontainer.BuildStringOfHierarchy(sb, indentation, pointedObj);\r\n\r\n\t\t\t} else {\r\n\t\t\t\tappendIndentation();\r\n\t\t\t\tif (obj instanceof StringValue) {\r\n\t\t\t\t\tsb.Append('\\\"');\r\n\t\t\t\t\tsb.Append(obj.toString().replace('\\n', '\\\\n'));\r\n\t\t\t\t\tsb.Append('\\\"');\r\n\t\t\t\t} else {\r\n\t\t\t\t\tsb.Append(obj.toString());\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (i != this.content.length - 1) {\r\n\t\t\t\tsb.Append(',');\r\n\t\t\t}\r\n\r\n\t\t\tif ( !(obj instanceof Container) && obj == pointedObj ) {\r\n\t\t\t\tsb.Append('  <---');\r\n\t\t\t}\r\n\r\n\t\t\tsb.AppendLine();\r\n\t\t}\r\n\r\n\t\tlet onlyNamed: Map<string, INamedContent> = new Map();\r\n\r\n\t\tfor (let [key, value] of this.namedContent){\r\n\t\t\tif (this.content.indexOf(asOrThrows(value, InkObject)) >= 0) {\r\n\t\t\t\tcontinue;\r\n\t\t\t} else {\r\n\t\t\t\tonlyNamed.set(key, value);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (onlyNamed.size > 0) {\r\n\t\t\tappendIndentation();\r\n\t\t\tsb.AppendLine('-- named: --');\r\n\r\n\t\t\tfor (let [key, value] of onlyNamed){\r\n\t\t\t\tDebug.AssertType(value, Container, 'Can only print out named Containers');\r\n\t\t\t\tlet container = value as Container;\r\n\t\t\t\tcontainer.BuildStringOfHierarchy(sb, indentation, pointedObj);\r\n\t\t\t\tsb.AppendLine();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tindentation--;\r\n\r\n\t\tappendIndentation();\r\n\t\tsb.Append(']');\r\n\t}\r\n}\r\n\r\nexport namespace Container{\r\n\texport enum CountFlags {\r\n\t\tVisits = 1,\r\n\t\tTurns = 2,\r\n\t\tCountStartOnly = 4,\r\n\t}\r\n}\r\n","import {InkObject} from './Object';\r\n\r\nexport class Glue extends InkObject{\r\n\tpublic toString(){\r\n\t\treturn 'Glue';\r\n\t}\r\n}\r\n","import {InkObject} from './Object';\r\n\r\nexport class ControlCommand extends InkObject{\r\n\r\n\tprivate _commandType: ControlCommand.CommandType;\r\n\r\n\tget commandType(): ControlCommand.CommandType{\r\n\t\treturn this._commandType;\r\n\t}\r\n\r\n\tconstructor(commandType: ControlCommand.CommandType = ControlCommand.CommandType.NotSet){\r\n\t\tsuper();\r\n\t\tthis._commandType = commandType;\r\n\t}\r\n\r\n\tpublic Copy(){\r\n\t\treturn new ControlCommand(this.commandType);\r\n\t}\r\n\tpublic static EvalStart(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.EvalStart);\r\n\t}\r\n\tpublic static EvalOutput(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.EvalOutput);\r\n\t}\r\n\tpublic static EvalEnd(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.EvalEnd);\r\n\t}\r\n\tpublic static Duplicate(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.Duplicate);\r\n\t}\r\n\tpublic static PopEvaluatedValue(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.PopEvaluatedValue);\r\n\t}\r\n\tpublic static PopFunction(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.PopFunction);\r\n\t}\r\n\tpublic static PopTunnel(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.PopTunnel);\r\n\t}\r\n\tpublic static BeginString(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.BeginString);\r\n\t}\r\n\tpublic static EndString(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.EndString);\r\n\t}\r\n\tpublic static NoOp(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.NoOp);\r\n\t}\r\n\tpublic static ChoiceCount(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.ChoiceCount);\r\n\t}\r\n\tpublic static Turns(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.Turns);\r\n\t}\r\n\tpublic static TurnsSince(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.TurnsSince);\r\n\t}\r\n\tpublic static ReadCount(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.ReadCount);\r\n\t}\r\n\tpublic static Random(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.Random);\r\n\t}\r\n\tpublic static SeedRandom(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.SeedRandom);\r\n\t}\r\n\tpublic static VisitIndex(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.VisitIndex);\r\n\t}\r\n\tpublic static SequenceShuffleIndex(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.SequenceShuffleIndex);\r\n\t}\r\n\tpublic static StartThread(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.StartThread);\r\n\t}\r\n\tpublic static Done(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.Done);\r\n\t}\r\n\tpublic static End(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.End);\r\n\t}\r\n\tpublic static ListFromInt(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.ListFromInt);\r\n\t}\r\n\tpublic static ListRange(){\r\n\t\treturn new ControlCommand(ControlCommand.CommandType.ListRange);\r\n\t}\r\n\tpublic static ListRandom(){\r\n\t\treturn new ControlCommand (ControlCommand.CommandType.ListRandom);\r\n\t}\r\n\tpublic toString(){\r\n\t\treturn this.commandType.toString();\r\n\t}\r\n}\r\n\r\nexport namespace ControlCommand {\r\n\texport enum CommandType {\r\n\t\tNotSet = -1,\r\n\t\tEvalStart,\r\n\t\tEvalOutput,\r\n\t\tEvalEnd,\r\n\t\tDuplicate,\r\n\t\tPopEvaluatedValue,\r\n\t\tPopFunction,\r\n\t\tPopTunnel,\r\n\t\tBeginString,\r\n\t\tEndString,\r\n\t\tNoOp,\r\n\t\tChoiceCount,\r\n\t\tTurns,\r\n\t\tTurnsSince,\r\n\t\tRandom,\r\n\t\tSeedRandom,\r\n\t\tVisitIndex,\r\n\t\tSequenceShuffleIndex,\r\n\t\tStartThread,\r\n\t\tDone,\r\n\t\tEnd,\r\n\t\tListFromInt,\r\n\t\tListRange,\r\n\t\tListRandom,\r\n\t\tReadCount,\r\n\r\n\t\tTOTAL_VALUES,\r\n\t}\r\n}\r\n","export enum PushPopType {\r\n\tTunnel = 0,\r\n\tFunction = 1,\r\n\tFunctionEvaluationFromGame = 2,\r\n}\r\n","import {Path} from './Path';\r\nimport {Container} from './Container';\r\nimport {InkObject} from './Object';\r\n\r\nexport class Pointer{\r\n  public container: Container | null = null;\r\n  public index: number = -1;\r\n\r\n\tconstructor();\r\n\tconstructor(container: Container | null, index: number)\r\n\tconstructor(){\r\n\t\tif (arguments.length === 2) {\r\n\t\t\tthis.container = arguments[0];\r\n\t\t\tthis.index = arguments[1];\r\n\t\t}\r\n\t}\r\n\r\n\tpublic Resolve(): InkObject | null{\r\n\t\tif (this.index < 0) return this.container;\r\n\t\tif (this.container == null) return null;\r\n\t\tif (this.container.content.length == 0) return this.container;\r\n\t\tif (this.index >= this.container.content.length) return null;\r\n\r\n\t\treturn this.container.content[this.index];\r\n\t}\r\n\r\n\tget isNull(): boolean{\r\n\t\treturn this.container == null;\r\n\t}\r\n\r\n\tget path(): Path | null{\r\n\t\tif (this.isNull) return null;\r\n\r\n\t\tif (this.index >= 0)\r\n\t\t\treturn this.container!.path.PathByAppendingComponent(new Path.Component(this.index));\r\n\t\telse\r\n\t\t\treturn this.container!.path;\r\n\t}\r\n\r\n\tpublic toString(): string{\r\n\t\tif (!this.container)\r\n\t\t\treturn 'Ink Pointer (null)';\r\n\r\n\t\treturn 'Ink Pointer -> ' + this.container.path.toString() + ' -- index ' + this.index;\r\n\t}\r\n\r\n\t// This method does not exist in the original C# code, but is here to maintain the\r\n\t// value semantics of Pointer.\r\n\tpublic copy(): Pointer{\r\n\t\treturn new Pointer(this.container, this.index);\r\n\t}\r\n\r\n\tpublic static StartOf(container: Container | null): Pointer{\r\n\t\treturn new Pointer(container, 0);\r\n\t}\r\n\r\n\tpublic static get Null(): Pointer {\r\n\t\treturn new Pointer(null, -1);\r\n\t}\r\n}\r\n","import {Path} from './Path';\r\nimport {PushPopType} from './PushPop';\r\nimport {StringBuilder} from './StringBuilder';\r\nimport {InkObject} from './Object';\r\nimport {Pointer} from './Pointer';\r\nimport {Container} from './Container';\r\nimport {throwNullException} from './NullException';\r\n\r\nexport class Divert extends InkObject{\r\n\tget targetPath(){\r\n\t\tif (this._targetPath != null && this._targetPath.isRelative) {\r\n\t\t\tlet targetObj = this.targetPointer.Resolve();\r\n\t\t\tif (targetObj) {\r\n\t\t\t\tthis._targetPath = targetObj.path;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this._targetPath;\r\n\t}\r\n\tset targetPath(value: Path | null){\r\n\t\tthis._targetPath = value;\r\n\t\tthis._targetPointer = Pointer.Null;\r\n\t}\r\n\r\n\tpublic _targetPath: Path | null = null;\r\n\r\n\tget targetPointer(){\r\n\t\tif (this._targetPointer.isNull) {\r\n\t\t\tlet targetObj = this.ResolvePath(this._targetPath).obj;\r\n\r\n\t\t\tif (this._targetPath === null) return throwNullException('this._targetPath');\r\n\t\t\tif (this._targetPath.lastComponent === null) return throwNullException('this._targetPath.lastComponent');\r\n\r\n\t\t\tif (this._targetPath.lastComponent.isIndex) {\r\n\t\t\t\tif (targetObj === null) return throwNullException('targetObj');\r\n\t\t\t\tthis._targetPointer.container = (targetObj.parent instanceof Container) ? targetObj.parent : null;\r\n\t\t\t\tthis._targetPointer.index = this._targetPath.lastComponent.index;\r\n\t\t\t} else {\r\n\t\t\t\tthis._targetPointer = Pointer.StartOf((targetObj instanceof Container) ? targetObj : null);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this._targetPointer.copy();\r\n\t}\r\n\r\n\tpublic _targetPointer: Pointer = Pointer.Null;\r\n\r\n\tget targetPathString(){\r\n\t\tif (this.targetPath == null)\r\n\t\t\treturn null;\r\n\r\n\t\treturn this.CompactPathString(this.targetPath);\r\n\t}\r\n\tset targetPathString(value: string | null){\r\n\t\tif (value == null) {\r\n\t\t\tthis.targetPath = null;\r\n\t\t} else {\r\n\t\t\tthis.targetPath = new Path(value);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic variableDivertName: string | null = null;\r\n\tget hasVariableTarget(){\r\n\t\treturn this.variableDivertName != null;\r\n\t}\r\n\r\n\tpublic pushesToStack: boolean = false;\r\n\tpublic stackPushType: PushPopType = 0;\r\n\r\n\tpublic isExternal: boolean = false;\r\n\tpublic externalArgs: number = 0;\r\n\r\n\tpublic isConditional: boolean = false;\r\n\r\n\tconstructor(stackPushType?: PushPopType){\r\n\t\tsuper();\r\n\t\tthis.pushesToStack = false;\r\n\r\n\t\tif (typeof stackPushType !== 'undefined') {\r\n\t\t\tthis.pushesToStack = true;\r\n\t\t\tthis.stackPushType = stackPushType;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic Equals(obj: Divert | null){\r\n\t\tlet otherDivert = obj;\r\n\t\tif (otherDivert instanceof Divert) {\r\n\t\t\tif (this.hasVariableTarget == otherDivert.hasVariableTarget) {\r\n\t\t\t\tif (this.hasVariableTarget) {\r\n\t\t\t\t\treturn this.variableDivertName == otherDivert.variableDivertName;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (this.targetPath === null) return throwNullException('this.targetPath');\r\n\t\t\t\t\treturn this.targetPath.Equals(otherDivert.targetPath);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tpublic toString(){\r\n\t\tif (this.hasVariableTarget) {\r\n\t\t\treturn 'Divert(variable: ' + this.variableDivertName + ')';\r\n\t\t}\r\n\t\telse if (this.targetPath == null) {\r\n\t\t\treturn 'Divert(null)';\r\n\t\t} else {\r\n\r\n\t\t\tlet sb = new StringBuilder();\r\n\r\n\t\t\tlet targetStr = this.targetPath.toString();\r\n\t\t\t// int? targetLineNum = DebugLineNumberOfPath (targetPath);\r\n\t\t\tlet targetLineNum = null;\r\n\t\t\tif (targetLineNum != null) {\r\n\t\t\t\ttargetStr = 'line ' + targetLineNum;\r\n\t\t\t}\r\n\r\n\t\t\tsb.Append('Divert');\r\n\r\n\t\t\tif (this.isConditional)\r\n\t\t\t\tsb.Append('?');\r\n\r\n\t\t\tif (this.pushesToStack) {\r\n\t\t\t\tif (this.stackPushType == PushPopType.Function) {\r\n\t\t\t\t\tsb.Append(' function');\r\n\t\t\t\t} else {\r\n\t\t\t\t\tsb.Append(' tunnel');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tsb.Append(' -> ');\r\n\t\t\tsb.Append(this.targetPathString);\r\n\r\n\t\t\tsb.Append(' (');\r\n\t\t\tsb.Append(targetStr);\r\n\t\t\tsb.Append(')');\r\n\r\n\t\t\treturn sb.toString();\r\n\t\t}\r\n\t}\r\n}\r\n","import {InkObject} from './Object';\r\nimport {Path} from './Path';\r\nimport {Container} from './Container';\r\nimport {throwNullException} from './NullException';\r\n\r\nexport class ChoicePoint extends InkObject{\r\n\tpublic _pathOnChoice: Path | null = null;\r\n\tpublic hasCondition: boolean = false;\r\n\tpublic hasStartContent: boolean = false;\r\n\tpublic hasChoiceOnlyContent: boolean = false;\r\n\tpublic isInvisibleDefault: boolean = false;\r\n\tpublic onceOnly: boolean = true;\r\n\r\n\tconstructor(onceOnly: boolean = true){\r\n\t\tsuper();\r\n\t\tthis.onceOnly = onceOnly;\r\n\t}\r\n\tget pathOnChoice(): Path | null{\r\n\t\tif (this._pathOnChoice != null && this._pathOnChoice.isRelative) {\r\n\t\t\tlet choiceTargetObj = this.choiceTarget;\r\n\t\t\tif (choiceTargetObj) {\r\n\t\t\t\tthis._pathOnChoice = choiceTargetObj.path;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn this._pathOnChoice;\r\n\t}\r\n\tset pathOnChoice(value: Path | null){\r\n\t\tthis._pathOnChoice = value;\r\n\t}\r\n\tget choiceTarget(): Container | null{\r\n\t\tif (this._pathOnChoice === null) return throwNullException('ChoicePoint._pathOnChoice');\r\n\t\treturn this.ResolvePath(this._pathOnChoice).container;\r\n\t}\r\n\tget pathStringOnChoice(): string{\r\n\t\tif (this.pathOnChoice === null) return throwNullException('ChoicePoint.pathOnChoice');\r\n\t\treturn this.CompactPathString(this.pathOnChoice);\r\n\t}\r\n\tset pathStringOnChoice(value: string){\r\n\t\tthis.pathOnChoice = new Path(value);\r\n\t}\r\n\tget flags(): number{\r\n\t\tlet flags = 0;\r\n\t\tif (this.hasCondition)         flags |= 1;\r\n\t\tif (this.hasStartContent)      flags |= 2;\r\n\t\tif (this.hasChoiceOnlyContent) flags |= 4;\r\n\t\tif (this.isInvisibleDefault)   flags |= 8;\r\n\t\tif (this.onceOnly)             flags |= 16;\r\n\t\treturn flags;\r\n\t}\r\n\tset flags(value: number){\r\n\t\tthis.hasCondition = (value & 1) > 0;\r\n\t\tthis.hasStartContent = (value & 2) > 0;\r\n\t\tthis.hasChoiceOnlyContent = (value & 4) > 0;\r\n\t\tthis.isInvisibleDefault = (value & 8) > 0;\r\n\t\tthis.onceOnly = (value & 16) > 0;\r\n\t}\r\n\tpublic toString(): string{\r\n\t\tif (this.pathOnChoice === null) return throwNullException('ChoicePoint.pathOnChoice');\r\n\t\t// int? targetLineNum = DebugLineNumberOfPath (pathOnChoice);\r\n\t\tlet targetLineNum = null;\r\n\t\tlet targetString = this.pathOnChoice.toString();\r\n\r\n\t\tif (targetLineNum != null) {\r\n\t\t\t targetString = ' line ' + targetLineNum + '('+targetString+')';\r\n\t\t}\r\n\r\n\t\treturn 'Choice: -> ' + targetString;\r\n\t}\r\n}\r\n","import {InkObject} from './Object';\r\nimport {Path} from './Path';\r\n\r\nexport class VariableReference extends InkObject{\r\n\r\n\tpublic name: string | null;\r\n\tpublic pathForCount: Path | null = null;\r\n\r\n\tget containerForCount(){\r\n\t\tif (this.pathForCount === null)\r\n\t\t\treturn null;\r\n\t\treturn this.ResolvePath(this.pathForCount).container;\r\n\t}\r\n\tget pathStringForCount(){\r\n\t\tif(this.pathForCount === null)\r\n\t\t\treturn null;\r\n\r\n\t\treturn this.CompactPathString(this.pathForCount);\r\n\t}\r\n\tset pathStringForCount(value: string | null){\r\n\t\tif (value === null)\r\n\t\t\tthis.pathForCount = null;\r\n\t\telse\r\n\t\t\tthis.pathForCount = new Path(value);\r\n\t}\r\n\r\n\tconstructor(name: string | null = null){\r\n\t\tsuper();\r\n\t\tthis.name = name;\r\n\t}\r\n\r\n\tpublic toString(){\r\n\t\tif (this.name != null) {\r\n\t\t\treturn 'var(' + this.name + ')';\r\n\t\t} else {\r\n\t\t\tlet pathStr = this.pathStringForCount;\r\n\t\t\treturn 'read_count(' + pathStr + ')';\r\n\t\t}\r\n\t}\r\n}\r\n","import {InkObject} from './Object';\r\n\r\nexport class VariableAssignment extends InkObject{\r\n\r\n\tpublic readonly variableName: string | null;\r\n\tpublic readonly isNewDeclaration: boolean;\r\n\tpublic isGlobal: boolean;\r\n\r\n\tconstructor(variableName: string | null, isNewDeclaration: boolean){\r\n\t\tsuper();\r\n\t\tthis.variableName = variableName || null;\r\n\t\tthis.isNewDeclaration = !!isNewDeclaration;\r\n\t\tthis.isGlobal = false;\r\n\t}\r\n\r\n\tpublic toString(): string{\r\n\t\treturn 'VarAssign to ' + this.variableName;\r\n\t}\r\n}\r\n","import {InkObject} from './Object';\r\n\r\nexport class Void extends InkObject{}\r\n","import {Value, ValueType, IntValue, ListValue} from './Value';\r\nimport {StoryException} from './StoryException';\r\nimport {Void} from './Void';\r\nimport {Path} from './Path';\r\nimport {InkList, InkListItem} from './InkList';\r\nimport {InkObject} from './Object';\r\nimport {asOrNull, asOrThrows} from './TypeAssertion';\r\nimport {throwNullException} from './NullException';\r\n\r\ntype BinaryOp<T> = (left: T, right: T) => any;\r\ntype UnaryOp<T> = (val: T) => any;\r\n\r\nexport class NativeFunctionCall extends InkObject{\r\n\t// tslint:disable:variable-name\r\n\tpublic static readonly Add: string \t\t= '+';\r\n\tpublic static readonly Subtract: string = '-';\r\n\tpublic static readonly Divide: string   = '/';\r\n\tpublic static readonly Multiply: string = '*';\r\n\tpublic static readonly Mod: string      = '%';\r\n\tpublic static readonly Negate: string   = '_';\r\n\tpublic static readonly Equal: string    = '==';\r\n\tpublic static readonly Greater: string  = '>';\r\n\tpublic static readonly Less: string     = '<';\r\n\tpublic static readonly GreaterThanOrEquals: string = '>=';\r\n\tpublic static readonly LessThanOrEquals: string = '<=';\r\n\tpublic static readonly NotEquals: string   = '!=';\r\n\tpublic static readonly Not: string      = '!';\r\n\tpublic static readonly And: string      = '&&';\r\n\tpublic static readonly Or: string       = '||';\r\n\tpublic static readonly Min: string      = 'MIN';\r\n\tpublic static readonly Max: string      = 'MAX';\r\n\tpublic static readonly Pow: string      = 'POW';\r\n\tpublic static readonly Floor: string    = 'FLOOR';\r\n\tpublic static readonly Ceiling: string  = 'CEILING';\r\n\tpublic static readonly Int: string      = 'INT';\r\n\tpublic static readonly Float: string    = 'FLOAT';\r\n\tpublic static readonly Has: string      = '?';\r\n\tpublic static readonly Hasnt: string    = '!?';\r\n\tpublic static readonly Intersect: string = '^';\r\n\tpublic static readonly ListMin: string   = 'LIST_MIN';\r\n\tpublic static readonly ListMax: string   = 'LIST_MAX';\r\n\tpublic static readonly All: string       = 'LIST_ALL';\r\n\tpublic static readonly Count: string     = 'LIST_COUNT';\r\n\tpublic static readonly ValueOfList: string = 'LIST_VALUE';\r\n\tpublic static readonly Invert: string    = 'LIST_INVERT';\r\n\t// tslint:enable:variable-name\r\n\r\n\tpublic static CallWithName(functionName: string){\r\n\t\treturn new NativeFunctionCall(functionName);\r\n\t}\r\n\r\n\tpublic static CallExistsWithName(functionName: string){\r\n\t\tthis.GenerateNativeFunctionsIfNecessary();\r\n\t\treturn this._nativeFunctions!.get(functionName);\r\n\t}\r\n\r\n\tget name(){\r\n\t\tif (this._name === null) return throwNullException('NativeFunctionCall._name');\r\n\t\treturn this._name;\r\n\t}\r\n\tset name(value: string){\r\n\t\tthis._name = value;\r\n\t\tif( !this._isPrototype ) {\r\n\t\t\tif (NativeFunctionCall._nativeFunctions === null) throwNullException('NativeFunctionCall._nativeFunctions');\r\n\t\t\telse this._prototype = NativeFunctionCall._nativeFunctions.get(this._name) || null;\r\n\t\t}\r\n\t}\r\n\tpublic _name: string | null = null;\r\n\r\n\tget numberOfParameters(){\r\n\t\tif (this._prototype) {\r\n\t\t\treturn this._prototype.numberOfParameters;\r\n\t\t} else {\r\n\t\t\treturn this._numberOfParameters;\r\n\t\t}\r\n\t}\r\n\tset numberOfParameters(value: number){\r\n\t\tthis._numberOfParameters = value;\r\n\t}\r\n\tpublic _numberOfParameters: number = 0;\r\n\r\n\tpublic Call(parameters: InkObject[]): InkObject | null{\r\n\t\tif (this._prototype) {\r\n\t\t\treturn this._prototype.Call(parameters);\r\n\t\t}\r\n\r\n\t\tif (this.numberOfParameters != parameters.length) {\r\n\t\t\tthrow new Error('Unexpected number of parameters');\r\n\t\t}\r\n\r\n\t\tlet hasList  = false;\r\n\t\tfor (let p of parameters) {\r\n\t\t\tif (p instanceof Void) throw new StoryException('Attempting to perform operation on a void value. Did you forget to \"return\" a value from a function you called here?');\r\n\t\t\tif (p instanceof ListValue)\r\n\t\t\t\thasList = true;\r\n\t\t}\r\n\r\n\t\tif (parameters.length == 2 && hasList){\r\n\t\t\treturn this.CallBinaryListOperation(parameters);\r\n\t\t}\r\n\r\n\t\tlet coercedParams = this.CoerceValuesToSingleType(parameters);\r\n\t\tlet coercedType = coercedParams[0].valueType;\r\n\r\n\t\tif (coercedType == ValueType.Int) {\r\n\t\t\treturn this.CallType<number>(coercedParams);\r\n\t\t} else if (coercedType == ValueType.Float) {\r\n\t\t\treturn this.CallType<number>(coercedParams);\r\n\t\t} else if (coercedType == ValueType.String) {\r\n\t\t\treturn this.CallType<string>(coercedParams);\r\n\t\t} else if (coercedType == ValueType.DivertTarget) {\r\n\t\t\treturn this.CallType<Path>(coercedParams);\r\n\t\t} else if (coercedType == ValueType.List) {\r\n\t\t\treturn this.CallType<InkList>(coercedParams);\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\tpublic CallType<T>(parametersOfSingleType: Array<Value<T>>){\r\n\t\tlet param1 = asOrThrows(parametersOfSingleType[0], Value);\r\n\t\tlet valType = param1.valueType;\r\n\r\n\t\tlet val1 = param1 as Value<T>;\r\n\r\n\t\tlet paramCount = parametersOfSingleType.length;\r\n\r\n\t\tif (paramCount == 2 || paramCount == 1) {\r\n\t\t\tif (this._operationFuncs === null) return throwNullException('NativeFunctionCall._operationFuncs');\r\n\t\t\tlet opForTypeObj = this._operationFuncs.get(valType);\r\n\t\t\tif (!opForTypeObj) {\r\n\t\t\t\tthrow new StoryException('Cannot perform operation '+this.name+' on '+valType);\r\n\t\t\t}\r\n\r\n\t\t\tif (paramCount == 2) {\r\n\t\t\t\tlet param2 = asOrThrows(parametersOfSingleType[1], Value);\r\n\r\n\t\t\t\tlet val2 = param2 as Value<T>;\r\n\r\n\t\t\t\tlet opForType = opForTypeObj as BinaryOp<T>;\r\n\r\n\t\t\t\tif (val1.value === null || val2.value === null) return throwNullException('NativeFunctionCall.Call BinaryOp values');\r\n\t\t\t\tlet resultVal = opForType(val1.value, val2.value);\r\n\r\n\t\t\t\treturn Value.Create(resultVal);\r\n\t\t\t}\r\n\r\n\t\t\telse {\r\n\r\n\t\t\t\tlet opForType = opForTypeObj as UnaryOp<T>;\r\n\r\n\t\t\t\tif (val1.value === null) return throwNullException('NativeFunctionCall.Call UnaryOp value');\r\n\t\t\t\tlet resultVal = opForType(val1.value);\r\n\r\n\t\t\t\treturn Value.Create(resultVal);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\telse {\r\n\t\t\tthrow new Error('Unexpected number of parameters to NativeFunctionCall: ' + parametersOfSingleType.length);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic CallBinaryListOperation(parameters: InkObject[]){\r\n\t\tif ((this.name == '+' || this.name == '-') && parameters[0] instanceof ListValue && parameters[1] instanceof IntValue)\r\n\t\t\treturn this.CallListIncrementOperation(parameters);\r\n\r\n\t\tlet v1 = asOrThrows(parameters[0], Value);\r\n\t\tlet v2 = asOrThrows(parameters[1], Value);\r\n\r\n\t\tif ((this.name == '&&' || this.name == '||') && (v1.valueType != ValueType.List || v2.valueType != ValueType.List)) {\r\n\t\t\tif (this._operationFuncs === null) return throwNullException('NativeFunctionCall._operationFuncs');\r\n\t\t\tlet op = this._operationFuncs.get(ValueType.Int) as BinaryOp<number>;\r\n\t\t\tif (op === null) return throwNullException('NativeFunctionCall.CallBinaryListOperation op');\r\n\t\t\tlet result = op(v1.isTruthy ? 1 : 0, v2.isTruthy ? 1 : 0);\r\n\t\t\treturn new IntValue(result);\r\n\t\t}\r\n\r\n\t\tif (v1.valueType == ValueType.List && v2.valueType == ValueType.List)\r\n\t\t\treturn this.CallType<InkList>([v1, v2]);\r\n\r\n\t\tthrow new StoryException('Can not call use ' + this.name + ' operation on ' + v1.valueType + ' and ' + v2.valueType);\r\n\t}\r\n\r\n\tpublic CallListIncrementOperation(listIntParams: InkObject[]){\r\n\t\tlet listVal = asOrThrows(listIntParams[0], ListValue);\r\n\t\tlet intVal = asOrThrows(listIntParams[1], IntValue);\r\n\r\n\t\tlet resultInkList = new InkList();\r\n\r\n\t\tif (listVal.value === null) return throwNullException('NativeFunctionCall.CallListIncrementOperation listVal.value');\r\n\t\tfor (let [listItemKey, listItemValue] of listVal.value) {\r\n\t\t\tlet listItem = InkListItem.fromSerializedKey(listItemKey);\r\n\r\n\t\t\tif (this._operationFuncs === null) return throwNullException('NativeFunctionCall._operationFuncs');\r\n\t\t\tlet intOp = this._operationFuncs.get(ValueType.Int) as BinaryOp<number>;\r\n\r\n\t\t\tif (intVal.value === null) return throwNullException('NativeFunctionCall.CallListIncrementOperation intVal.value');\r\n\t\t\tlet targetInt = intOp(listItemValue, intVal.value);\r\n\r\n\t\t\tlet itemOrigin = null;\r\n\t\t\tif (listVal.value.origins === null) return throwNullException('NativeFunctionCall.CallListIncrementOperation listVal.value.origins');\r\n\t\t\tfor (let origin of listVal.value.origins) {\r\n\t\t\t\tif (origin.name == listItem.originName) {\r\n\t\t\t\t\titemOrigin = origin;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (itemOrigin != null) {\r\n\t\t\t\tlet incrementedItem = itemOrigin.TryGetItemWithValue(targetInt, InkListItem.Null);\r\n\t\t\t\tif (incrementedItem.exists)\r\n\t\t\t\t\tresultInkList.Add(incrementedItem.result, targetInt);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn new ListValue(resultInkList);\r\n\t}\r\n\r\n\tpublic CoerceValuesToSingleType(parametersIn: InkObject[]){\r\n\t\tlet valType = ValueType.Int;\r\n\r\n\t\tlet specialCaseList: null | ListValue = null;\r\n\r\n\t\tfor (let obj of parametersIn) {\r\n\t\t\tlet val = asOrThrows(obj, Value);\r\n\t\t\tif (val.valueType > valType) {\r\n\t\t\t\tvalType = val.valueType;\r\n\t\t\t}\r\n\r\n\t\t\tif (val.valueType == ValueType.List) {\r\n\t\t\t\t specialCaseList = asOrNull(val, ListValue);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet parametersOut = [];\r\n\r\n\t\tif (ValueType[valType] == ValueType[ValueType.List]) {\r\n\t\t\tfor (let inkObjectVal of parametersIn){\r\n\t\t\t\tlet val = asOrThrows(inkObjectVal, Value);\r\n\t\t\t\tif (val.valueType == ValueType.List) {\r\n\t\t\t\t\tparametersOut.push(val);\r\n\t\t\t\t} else if (val.valueType == ValueType.Int) {\r\n\t\t\t\t\tlet intVal = parseInt(val.valueObject);\r\n\r\n\t\t\t\t\tspecialCaseList = asOrThrows(specialCaseList, ListValue);\r\n\t\t\t\t\tif (specialCaseList.value === null) return throwNullException('NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value');\r\n\t\t\t\t\tlet list = specialCaseList.value.originOfMaxItem;\r\n\r\n\t\t\t\t\tif (list === null) return throwNullException('NativeFunctionCall.CoerceValuesToSingleType list');\r\n\t\t\t\t\tlet item = list.TryGetItemWithValue(intVal, InkListItem.Null);\r\n\t\t\t\t\tif (item.exists) {\r\n\t\t\t\t\t\tlet castedValue = new ListValue(item.result, intVal);\r\n\t\t\t\t\t\tparametersOut.push(castedValue);\r\n\t\t\t\t\t} else\r\n\t\t\t\t\t\tthrow new StoryException('Could not find List item with the value ' + intVal + ' in ' + list.name);\r\n\t\t\t\t} else\r\n\t\t\t\t\tthrow new StoryException('Cannot mix Lists and ' + val.valueType + ' values in this operation');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\telse {\r\n\t\t\tfor (let inkObjectVal of parametersIn){\r\n\t\t\t\tlet val = asOrThrows(inkObjectVal, Value);\r\n\t\t\t\tlet castedValue = val.Cast(valType);\r\n\t\t\t\tparametersOut.push(castedValue);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn parametersOut;\r\n\t}\r\n\r\n\tconstructor(name: string);\r\n\tconstructor(name: string, numberOfParameters: number);\r\n\tconstructor();\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tif (arguments.length === 0) {\r\n\t\t\tNativeFunctionCall.GenerateNativeFunctionsIfNecessary();\r\n\t\t}\r\n\t\telse if (arguments.length === 1) {\r\n\t\t\tlet name = arguments[0];\r\n\t\t\tNativeFunctionCall.GenerateNativeFunctionsIfNecessary();\r\n\t\t\tthis.name = name;\r\n\t\t}\r\n\t\telse if (arguments.length === 2) {\r\n\t\t\tlet name = arguments[0];\r\n\t\t\tlet numberOfParameters = arguments[1];\r\n\r\n\t\t\tthis._isPrototype = true;\r\n\t\t\tthis.name = name;\r\n\t\t\tthis.numberOfParameters = numberOfParameters;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic static Identity<T>(t: T): any {\r\n\t\treturn t;\r\n\t}\r\n\r\n\tpublic static GenerateNativeFunctionsIfNecessary(){\r\n\t\tif (this._nativeFunctions == null) {\r\n\t\t\tthis._nativeFunctions = new Map();\r\n\r\n\t\t\t// Int operations\r\n\t\t\tthis.AddIntBinaryOp(this.Add,      (x, y) => x + y);\r\n\t\t\tthis.AddIntBinaryOp(this.Subtract, (x, y) => x - y);\r\n\t\t\tthis.AddIntBinaryOp(this.Multiply, (x, y) => x * y);\r\n\t\t\tthis.AddIntBinaryOp(this.Divide,   (x, y) => Math.round(x / y));\r\n\t\t\tthis.AddIntBinaryOp(this.Mod,      (x, y) => x % y);\r\n\t\t\tthis.AddIntUnaryOp(this.Negate,   (x) => -x);\r\n\r\n\t\t\tthis.AddIntBinaryOp(this.Equal,    (x, y) => x == y ? 1 : 0);\r\n\t\t\tthis.AddIntBinaryOp(this.Greater,  (x, y) => x > y  ? 1 : 0);\r\n\t\t\tthis.AddIntBinaryOp(this.Less,     (x, y) => x < y  ? 1 : 0);\r\n\t\t\tthis.AddIntBinaryOp(this.GreaterThanOrEquals, (x, y) => x >= y ? 1 : 0);\r\n\t\t\tthis.AddIntBinaryOp(this.LessThanOrEquals, (x, y) => x <= y ? 1 : 0);\r\n\t\t\tthis.AddIntBinaryOp(this.NotEquals, (x, y) => x != y ? 1 : 0);\r\n\t\t\tthis.AddIntUnaryOp(this.Not,       (x) => (x == 0) ? 1 : 0);\r\n\r\n\t\t\tthis.AddIntBinaryOp(this.And,      (x, y) => x != 0 && y != 0 ? 1 : 0);\r\n\t\t\tthis.AddIntBinaryOp(this.Or,       (x, y) => x != 0 || y != 0 ? 1 : 0);\r\n\r\n\t\t\tthis.AddIntBinaryOp(this.Max,      (x, y) => Math.max(x, y));\r\n\t\t\tthis.AddIntBinaryOp(this.Min,      (x, y) => Math.min(x, y));\r\n\r\n\t\t\tthis.AddIntBinaryOp(this.Pow,      (x, y) => Math.pow(x, y));\r\n\t\t\tthis.AddIntUnaryOp(this.Floor,     NativeFunctionCall.Identity);\r\n\t\t\tthis.AddIntUnaryOp(this.Ceiling,   NativeFunctionCall.Identity);\r\n\t\t\tthis.AddIntUnaryOp(this.Int,       NativeFunctionCall.Identity);\r\n\t\t\tthis.AddIntUnaryOp(this.Float,     (x) => x);\r\n\r\n\t\t\t// Float operations\r\n\t\t\tthis.AddFloatBinaryOp(this.Add,      (x, y) => x + y);\r\n\t\t\tthis.AddFloatBinaryOp(this.Subtract, (x, y) => x - y);\r\n\t\t\tthis.AddFloatBinaryOp(this.Multiply, (x, y) => x * y);\r\n\t\t\tthis.AddFloatBinaryOp(this.Divide,   (x, y) => x / y);\r\n\t\t\tthis.AddFloatBinaryOp(this.Mod,      (x, y) => x % y);\r\n\t\t\tthis.AddFloatUnaryOp(this.Negate,   (x) => -x);\r\n\r\n\t\t\tthis.AddFloatBinaryOp(this.Equal,    (x, y) => x == y ? 1 : 0);\r\n\t\t\tthis.AddFloatBinaryOp(this.Greater,  (x, y) => x > y  ? 1 : 0);\r\n\t\t\tthis.AddFloatBinaryOp(this.Less,     (x, y) => x < y  ? 1 : 0);\r\n\t\t\tthis.AddFloatBinaryOp(this.GreaterThanOrEquals, (x, y) => x >= y ? 1 : 0);\r\n\t\t\tthis.AddFloatBinaryOp(this.LessThanOrEquals, (x, y) => x <= y ? 1 : 0);\r\n\t\t\tthis.AddFloatBinaryOp(this.NotEquals, (x, y) => x != y ? 1 : 0);\r\n\t\t\tthis.AddFloatUnaryOp(this.Not,       (x) => (x == 0.0) ? 1 : 0);\r\n\r\n\t\t\tthis.AddFloatBinaryOp(this.And,      (x, y) => x != 0.0 && y != 0.0 ? 1 : 0);\r\n\t\t\tthis.AddFloatBinaryOp(this.Or,       (x, y) => x != 0.0 || y != 0.0 ? 1 : 0);\r\n\r\n\t\t\tthis.AddFloatBinaryOp(this.Max,      (x, y) => Math.max(x, y));\r\n\t\t\tthis.AddFloatBinaryOp(this.Min,      (x, y) => Math.min(x, y));\r\n\r\n\t\t\tthis.AddFloatBinaryOp(this.Pow,      (x, y) => Math.pow(x, y));\r\n\t\t\tthis.AddFloatUnaryOp(this.Floor,     (x) => Math.floor(x));\r\n\t\t\tthis.AddFloatUnaryOp(this.Ceiling,   (x) => Math.ceil(x));\r\n\t\t\tthis.AddFloatUnaryOp(this.Int,       (x) => Math.floor(x));\r\n\t\t\tthis.AddFloatUnaryOp(this.Float,     NativeFunctionCall.Identity);\r\n\r\n\t\t\t// String operations\r\n\t\t\tthis.AddStringBinaryOp(this.Add,     \t(x, y) => x + y); // concat\r\n\t\t\tthis.AddStringBinaryOp(this.Equal,   \t(x, y) => x === y ? 1 : 0);\r\n\t\t\tthis.AddStringBinaryOp(this.NotEquals,(x, y) => !(x === y) ? 1 : 0);\r\n\t\t\tthis.AddStringBinaryOp(this.Has,      (x, y) => x.includes(y) ? 1 : 0);\r\n\t\t\tthis.AddStringBinaryOp(this.Hasnt,      (x, y) => x.includes(y) ? 0 : 1);\r\n\r\n\t\t\tthis.AddListBinaryOp(this.Add, \t\t (x, y) => x.Union(y));\r\n\t\t\tthis.AddListBinaryOp(this.Subtract,  (x, y) => x.Without(y));\r\n\t\t\tthis.AddListBinaryOp(this.Has, \t\t (x, y) => x.Contains(y) ? 1 : 0);\r\n\t\t\tthis.AddListBinaryOp(this.Hasnt, \t (x, y) => x.Contains(y) ? 0 : 1);\r\n\t\t\tthis.AddListBinaryOp(this.Intersect, (x, y) => x.Intersect(y));\r\n\r\n\t\t\tthis.AddListBinaryOp(this.Equal, \t\t\t\t(x, y) => x.Equals(y) ? 1 : 0);\r\n\t\t\tthis.AddListBinaryOp(this.Greater, \t\t\t\t(x, y) => x.GreaterThan(y) ? 1 : 0);\r\n\t\t\tthis.AddListBinaryOp(this.Less, \t\t\t\t(x, y) => x.LessThan(y) ? 1 : 0);\r\n\t\t\tthis.AddListBinaryOp(this.GreaterThanOrEquals, \t(x, y) => x.GreaterThanOrEquals(y) ? 1 : 0);\r\n\t\t\tthis.AddListBinaryOp(this.LessThanOrEquals, \t(x, y) => x.LessThanOrEquals(y) ? 1 : 0);\r\n\t\t\tthis.AddListBinaryOp(this.NotEquals, \t\t\t(x, y) => !x.Equals(y) ? 1 : 0);\r\n\r\n\t\t\tthis.AddListBinaryOp (this.And, \t\t\t\t(x, y) => x.Count > 0 && y.Count > 0 ? 1 : 0);\r\n\t\t\tthis.AddListBinaryOp (this.Or,  \t\t\t\t(x, y) => x.Count > 0 || y.Count > 0 ? 1 : 0);\r\n\r\n\t\t\tthis.AddListUnaryOp(this.Not, (x) => x.Count == 0 ? 1 : 0);\r\n\r\n\t\t\tthis.AddListUnaryOp(this.Invert, (x) => x.inverse);\r\n\t\t\tthis.AddListUnaryOp(this.All, (x) => x.all);\r\n\t\t\tthis.AddListUnaryOp(this.ListMin, (x) => x.MinAsList());\r\n\t\t\tthis.AddListUnaryOp(this.ListMax, (x) => x.MaxAsList());\r\n\t\t\tthis.AddListUnaryOp(this.Count,  (x) => x.Count);\r\n\t\t\tthis.AddListUnaryOp(this.ValueOfList,  (x) => x.maxItem.Value);\r\n\r\n\t\t\tlet divertTargetsEqual = (d1: Path, d2: Path) => {\r\n\t\t\t\treturn d1.Equals(d2) ? 1 : 0;\r\n\t\t\t};\r\n\t\t\tlet divertTargetsNotEqual = (d1: Path, d2: Path) => {\r\n\t\t\t\treturn d1.Equals (d2) ? 0 : 1;\r\n\t\t\t};\r\n\t\t\tthis.AddOpToNativeFunc(this.Equal, 2, ValueType.DivertTarget, divertTargetsEqual);\r\n\t\t\tthis.AddOpToNativeFunc(this.NotEquals, 2, ValueType.DivertTarget, divertTargetsNotEqual);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic AddOpFuncForType(valType: ValueType, op: UnaryOp<number | InkList> | BinaryOp<number | string | InkList | Path>): void{\r\n\t\tif (this._operationFuncs == null) {\r\n\t\t\tthis._operationFuncs = new Map();\r\n\t\t}\r\n\r\n\t\tthis._operationFuncs.set(valType, op);\r\n\t}\r\n\r\n\tpublic static AddOpToNativeFunc(name: string, args: number, valType: ValueType, op: UnaryOp<any> | BinaryOp<any>): void{\r\n\t\tif (this._nativeFunctions === null) return throwNullException('NativeFunctionCall._nativeFunctions');\r\n\t\tlet nativeFunc = this._nativeFunctions.get(name);\r\n\t\tif (!nativeFunc) {\r\n\t\t\tnativeFunc = new NativeFunctionCall(name, args);\r\n\t\t\tthis._nativeFunctions.set(name, nativeFunc);\r\n\t\t}\r\n\r\n\t\tnativeFunc.AddOpFuncForType(valType, op);\r\n\t}\r\n\r\n\tpublic static AddIntBinaryOp(name: string, op: BinaryOp<number>){\r\n\t\tthis.AddOpToNativeFunc(name, 2, ValueType.Int, op);\r\n\t}\r\n\tpublic static AddIntUnaryOp(name: string, op: UnaryOp<number>){\r\n\t\tthis.AddOpToNativeFunc(name, 1, ValueType.Int, op);\r\n\t}\r\n\r\n\tpublic static AddFloatBinaryOp(name: string, op: BinaryOp<number>){\r\n\t\tthis.AddOpToNativeFunc(name, 2, ValueType.Float, op);\r\n\t}\r\n\tpublic static AddFloatUnaryOp(name: string, op: UnaryOp<number>){\r\n\t\tthis.AddOpToNativeFunc(name, 1, ValueType.Float, op);\r\n\t}\r\n\r\n\tpublic static AddStringBinaryOp(name: string, op: BinaryOp<string>){\r\n\t\tthis.AddOpToNativeFunc(name, 2, ValueType.String, op);\r\n\t}\r\n\r\n\tpublic static AddListBinaryOp(name: string, op: BinaryOp<InkList>){\r\n\t\tthis.AddOpToNativeFunc(name, 2, ValueType.List, op);\r\n\t}\r\n\tpublic static AddListUnaryOp(name: string, op: UnaryOp<InkList>){\r\n\t\tthis.AddOpToNativeFunc(name, 1, ValueType.List, op);\r\n\t}\r\n\r\n\tpublic toString(){\r\n\t\treturn 'Native \"' + this.name + '\"';\r\n\t}\r\n\r\n\tpublic _prototype: NativeFunctionCall | null = null;\r\n\tpublic _isPrototype: boolean = false;\r\n\tpublic _operationFuncs: Map<ValueType, BinaryOp<any> | UnaryOp<any>> | null = null;\r\n\tpublic static _nativeFunctions: Map<string, NativeFunctionCall> | null = null;\r\n\r\n}\r\n","import {InkObject} from './Object';\r\n\r\nexport class Tag extends InkObject{\r\n\r\n\tpublic readonly text: string;\r\n\r\n\tconstructor(tagText: string){\r\n\t\tsuper();\r\n\t\tthis.text = tagText.toString() || '';\r\n\t}\r\n\r\n\tpublic toString(): string{\r\n\t\treturn '# ' + this.text;\r\n\t}\r\n}\r\n","import {Path} from './Path';\r\nimport {CallStack} from './CallStack';\r\nimport {throwNullException} from './NullException';\r\nimport {InkObject} from './Object';\r\n\r\nexport class Choice extends InkObject{\r\n\tpublic text: string = '';\r\n\tpublic index: number = 0;\r\n\tpublic threadAtGeneration: CallStack.Thread | null = null;\r\n\tpublic sourcePath: string = '';\r\n\tpublic targetPath: Path | null = null;\r\n\tpublic isInvisibleDefault: boolean = false;\r\n\tpublic originalThreadIndex: number = 0;\r\n\r\n\tget pathStringOnChoice(): string{\r\n\t\tif (this.targetPath === null) return throwNullException('Choice.targetPath');\r\n\t\treturn this.targetPath.toString();\r\n\t}\r\n\tset pathStringOnChoice(value: string){\r\n\t\tthis.targetPath = new Path(value);\r\n\t}\r\n}\r\n","import {InkList, InkListItem, SerializedInkListItem} from './InkList';\r\nimport {ListValue} from './Value';\r\nimport {TryGetResult} from './TryGetResult';\r\n\r\nexport class ListDefinition{\r\n\tpublic _name: string;\r\n\tpublic _items: Map<SerializedInkListItem, number> | null;\r\n\tpublic _itemNameToValues: Map<string, number>;\r\n\r\n\tconstructor(name: string, items: Map<string, number> | null){\r\n\t\tthis._name = name || '';\r\n\t\tthis._items = null;\r\n\t\tthis._itemNameToValues = items || new Map();\r\n\t}\r\n\tget name(){\r\n\t\treturn this._name;\r\n\t}\r\n\tget items(){\r\n\t\tif (this._items == null){\r\n\t\t\tthis._items = new Map();\r\n\t\t\tfor (let [key, value] of this._itemNameToValues){\r\n\t\t\t\tlet item = new InkListItem(this.name, key);\r\n\t\t\t\tthis._items.set(item.serialized(), value);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this._items;\r\n\t}\r\n\r\n\tpublic ValueForItem(item: InkListItem){\r\n\t\tif (!item.itemName) return 0;\r\n\r\n\t\tlet intVal = this._itemNameToValues.get(item.itemName);\r\n\t\tif (typeof intVal !== 'undefined')\r\n\t\t\treturn intVal;\r\n\t\telse\r\n\t\t\treturn 0;\r\n\t}\r\n\tpublic ContainsItem(item: InkListItem){\r\n\t\tif (!item.itemName) return false;\r\n\t\tif (item.originName != this.name) return false;\r\n\r\n\t\treturn this._itemNameToValues.has(item.itemName);\r\n\t}\r\n\tpublic ContainsItemWithName(itemName: string){\r\n\t\treturn this._itemNameToValues.has(itemName);\r\n\t}\r\n\tpublic TryGetItemWithValue(val: number, /* out */ item: InkListItem): TryGetResult<InkListItem>{\r\n\t\tfor (let [key, value] of this._itemNameToValues){\r\n\t\t\tif (value == val) {\r\n\t\t\t\titem = new InkListItem(this.name, key);\r\n\t\t\t\treturn { result: item, exists: true };\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\titem = InkListItem.Null;\r\n\t\treturn { result: item, exists: false };\r\n\t}\r\n\tpublic TryGetValueForItem(item: InkListItem, /* out */ intVal: number): TryGetResult<number>{\r\n\t\tif (!item.itemName) return { result: 0, exists: false };\r\n\t\tlet value = this._itemNameToValues.get(item.itemName);\r\n\r\n\t\tif (!value) return { result: 0, exists: false };\r\n\t\treturn { result: value, exists: true };\r\n\t}\r\n}\r\n","import {InkListItem} from './InkList';\r\nimport {ListValue} from './Value';\r\nimport {ListDefinition} from './ListDefinition';\r\nimport {TryGetResult} from './TryGetResult';\r\nimport {throwNullException} from './NullException';\r\n\r\nexport class ListDefinitionsOrigin{\r\n\tprotected _lists: Map<string, ListDefinition>;\r\n\tprotected _allUnambiguousListValueCache: Map<string, ListValue>;\r\n\r\n\tconstructor(lists: ListDefinition[]){\r\n\t\tthis._lists = new Map();\r\n\t\tthis._allUnambiguousListValueCache = new Map();\r\n\r\n\t\tfor (let list of lists){\r\n\t\t\tthis._lists.set(list.name, list);\r\n\r\n\t\t\tfor (let [key, val] of list.items){\r\n\t\t\t\tlet item = InkListItem.fromSerializedKey(key);\r\n\t\t\t\tlet listValue = new ListValue(item, val);\r\n\r\n\t\t\t\tif (!item.itemName) { throw new Error('item.itemName is null or undefined.'); }\r\n\r\n\t\t\t\tthis._allUnambiguousListValueCache.set(item.itemName, listValue);\r\n\t\t\t\tthis._allUnambiguousListValueCache.set(item.fullName, listValue);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tget lists(): ListDefinition[]{\r\n\t\tlet listOfLists: ListDefinition[] = [];\r\n\r\n\t\tfor (let [key, value] of this._lists){\r\n\t\t\tlistOfLists.push(value);\r\n\t\t}\r\n\r\n\t\treturn listOfLists;\r\n\t}\r\n\tpublic TryListGetDefinition(name: string | null, /* out */ def: ListDefinition | null): TryGetResult<ListDefinition | null>{\r\n\t\tif (name === null) { return {result: def, exists: false}; }\r\n\t\t// initially, this function returns a boolean and the second parameter is an out.\r\n\t\tlet definition = this._lists.get(name);\r\n\t\tif (!definition) return { result: def, exists: false };\r\n\r\n\t\treturn { result: definition, exists: true };\r\n\t}\r\n\tpublic FindSingleItemListWithName(name: string | null){\r\n\t\tif (name === null) { return throwNullException('name'); }\r\n\t\tlet val = this._allUnambiguousListValueCache.get(name);\r\n\r\n\t\tif (typeof val !== 'undefined'){\r\n\t\t\treturn val;\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n}\r\n","import {Container} from './Container';\r\nimport {Value, IntValue, FloatValue, StringValue, DivertTargetValue, VariablePointerValue, ListValue} from './Value';\r\nimport {Glue} from './Glue';\r\nimport {ControlCommand} from './ControlCommand';\r\nimport {PushPopType} from './PushPop';\r\nimport {Divert} from './Divert';\r\nimport {ChoicePoint} from './ChoicePoint';\r\nimport {VariableReference} from './VariableReference';\r\nimport {VariableAssignment} from './VariableAssignment';\r\nimport {NativeFunctionCall} from './NativeFunctionCall';\r\nimport {Void} from './Void';\r\nimport {Tag} from './Tag';\r\nimport {Path} from './Path';\r\nimport {Choice} from './Choice';\r\nimport {ListDefinition} from './ListDefinition';\r\nimport {ListDefinitionsOrigin} from './ListDefinitionsOrigin';\r\nimport {InkListItem, InkList} from './InkList';\r\nimport {InkObject} from './Object';\r\nimport {JObject} from './JObject';\r\nimport {asOrNull, asNumberOrThrows} from './TypeAssertion';\r\nimport {throwNullException} from './NullException';\r\n\r\n// tslint:disable no-conditional-assignment\r\n\r\nexport class JsonSerialisation{\r\n\tpublic static ListToJArray(serialisables: InkObject[]){\r\n\t\tlet jArray: any[] = [];\r\n\t\tfor (let s of serialisables) {\r\n\t\t\tjArray.push(this.RuntimeObjectToJToken(s));\r\n\t\t}\r\n\t\treturn jArray;\r\n\t}\r\n\r\n\tpublic static JArrayToRuntimeObjList(jArray: any[], skipLast: boolean = false){\r\n\t\tlet count = jArray.length;\r\n\t\tif (skipLast)\r\n\t\t\tcount--;\r\n\r\n\t\tlet list: InkObject[] = [];\r\n\r\n\t\tfor (let i = 0; i < count; i++){\r\n\t\t\tlet jTok = jArray[i];\r\n\t\t\tlet runtimeObj = this.JTokenToRuntimeObject(jTok);\r\n\t\t\tif (runtimeObj === null) { return throwNullException('runtimeObj'); }\r\n\t\t\tlist.push(runtimeObj);\r\n\t\t}\r\n\r\n\t\treturn list;\r\n\t}\r\n\r\n\tpublic static DictionaryRuntimeObjsToJObject(dictionary: Map<string, InkObject>){\r\n\t\tlet jsonObj: JObject = {};\r\n\r\n\t\tfor (let [key, value] of dictionary){\r\n\t\t\tlet runtimeObj = asOrNull(value, InkObject);\r\n\t\t\tif (runtimeObj != null)\r\n\t\t\t\tjsonObj[key] = this.RuntimeObjectToJToken(runtimeObj);\r\n\t\t}\r\n\r\n\t\treturn jsonObj;\r\n\t}\r\n\r\n\tpublic static JObjectToDictionaryRuntimeObjs(jObject: JObject){\r\n\t\tlet dict: Map<string, InkObject> = new Map();\r\n\r\n\t\tfor (let key in jObject){\r\n\t\t\tif (jObject.hasOwnProperty(key)) {\r\n\t\t\t\tlet inkObject = this.JTokenToRuntimeObject(jObject[key]);\r\n\t\t\t\tif (inkObject === null) { return throwNullException('inkObject'); }\r\n\t\t\t\tdict.set(key, inkObject);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn dict;\r\n\t}\r\n\r\n\tpublic static JObjectToIntDictionary(jObject: JObject){\r\n\t\tlet dict: Map<string, number> = new Map();\r\n\t\tfor (let key in jObject){\r\n\t\t\tif (jObject.hasOwnProperty(key)) {\r\n\t\t\t\tdict.set(key, parseInt(jObject[key]));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn dict;\r\n\t}\r\n\tpublic static IntDictionaryToJObject(dict: Map<string, number>){\r\n\t\tlet jObj: JObject = {};\r\n\t\tfor (let [key, value] of dict){\r\n\t\t\tjObj[key] = asNumberOrThrows(value);\r\n\t\t}\r\n\t\treturn jObj;\r\n\t}\r\n\tpublic static JTokenToRuntimeObject(token: any): InkObject | null {\r\n\t\tif (typeof token === 'number' && !isNaN(token)){\r\n\t\t\treturn Value.Create(token);\r\n\t\t}\r\n\r\n\t\tif (typeof token === 'string'){\r\n\t\t\tlet str = token.toString();\r\n\r\n\t\t\t// String value\r\n\t\t\tlet firstChar = str[0];\r\n\t\t\tif (firstChar == '^')\r\n\t\t\t\treturn new StringValue(str.substring(1));\r\n\t\t\telse if(firstChar == '\\n' && str.length == 1)\r\n\t\t\t\treturn new StringValue('\\n');\r\n\r\n\t\t\t// Glue\r\n\t\t\tif (str == '<>') return new Glue();\r\n\r\n\t\t\t// Control commands (would looking up in a hash set be faster?)\r\n\t\t\tfor (let i = 0; i < JsonSerialisation._controlCommandNames.length; ++i) {\r\n\t\t\t\tlet cmdName = JsonSerialisation._controlCommandNames[i];\r\n\t\t\t\tif (str == cmdName) {\r\n\t\t\t\t\treturn new ControlCommand(i);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Native functions\r\n\t\t\tif (str == 'L^') str = '^';\r\n\t\t\tif( NativeFunctionCall.CallExistsWithName(str) )\r\n\t\t\t\treturn NativeFunctionCall.CallWithName(str);\r\n\r\n\t\t\t// Pop\r\n\t\t\tif (str == '->->')\r\n\t\t\t\treturn ControlCommand.PopTunnel();\r\n\t\t\telse if (str == '~ret')\r\n\t\t\t\treturn ControlCommand.PopFunction();\r\n\r\n\t\t\t// Void\r\n\t\t\tif (str == 'void')\r\n\t\t\t\treturn new Void ();\r\n\t\t}\r\n\r\n\t\tif (typeof token === 'object' && !Array.isArray(token)){\r\n\t\t\tlet obj: JObject = token;\r\n\t\t\tlet propValue;\r\n\r\n\t\t\t// Divert target value to path\r\n\t\t\tif (obj['^->']){\r\n\t\t\t\tpropValue = obj['^->'];\r\n\t\t\t\treturn new DivertTargetValue(new Path(propValue.toString()));\r\n\t\t\t}\r\n\r\n\t\t\t// VariablePointerValue\r\n\t\t\tif (obj['^var']) {\r\n\t\t\t\tpropValue = obj['^var'];\r\n\t\t\t\tlet varPtr = new VariablePointerValue(propValue.toString());\r\n\t\t\t\tif ('ci' in obj){\r\n\t\t\t\t\tpropValue = obj['ci'];\r\n\t\t\t\t\tvarPtr.contextIndex = parseInt(propValue);\r\n\t\t\t\t}\r\n\t\t\t\treturn varPtr;\r\n\t\t\t}\r\n\r\n\t\t\t// Divert\r\n\t\t\tlet isDivert = false;\r\n\t\t\tlet pushesToStack = false;\r\n\t\t\tlet divPushType = PushPopType.Function;\r\n\t\t\tlet external = false;\r\n\t\t\tif (propValue = obj['->']) {\r\n\t\t\t\tisDivert = true;\r\n\t\t\t}\r\n\t\t\telse if (propValue = obj['f()']) {\r\n\t\t\t\tisDivert = true;\r\n\t\t\t\tpushesToStack = true;\r\n\t\t\t\tdivPushType = PushPopType.Function;\r\n\t\t\t}\r\n\t\t\telse if (propValue = obj['->t->']) {\r\n\t\t\t\tisDivert = true;\r\n\t\t\t\tpushesToStack = true;\r\n\t\t\t\tdivPushType = PushPopType.Tunnel;\r\n\t\t\t}\r\n\t\t\telse if (propValue = obj['x()']) {\r\n\t\t\t\tisDivert = true;\r\n\t\t\t\texternal = true;\r\n\t\t\t\tpushesToStack = false;\r\n\t\t\t\tdivPushType = PushPopType.Function;\r\n\t\t\t}\r\n\r\n\t\t\tif (isDivert) {\r\n\t\t\t\tlet divert = new Divert();\r\n\t\t\t\tdivert.pushesToStack = pushesToStack;\r\n\t\t\t\tdivert.stackPushType = divPushType;\r\n\t\t\t\tdivert.isExternal = external;\r\n\r\n\t\t\t\tlet target = propValue.toString();\r\n\r\n\t\t\t\tif (propValue = obj['var'])\r\n\t\t\t\t\tdivert.variableDivertName = target;\r\n\t\t\t\telse\r\n\t\t\t\t\tdivert.targetPathString = target;\r\n\r\n\t\t\t\tdivert.isConditional = !!obj['c'];\r\n\r\n\t\t\t\tif (external) {\r\n\t\t\t\t\tif (propValue = obj['exArgs'])\r\n\t\t\t\t\t\tdivert.externalArgs = parseInt(propValue);\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn divert;\r\n\t\t\t}\r\n\r\n\t\t\t// Choice\r\n\t\t\tif (propValue = obj['*']) {\r\n\t\t\t\tlet choice = new ChoicePoint();\r\n\t\t\t\tchoice.pathStringOnChoice = propValue.toString();\r\n\r\n\t\t\t\tif (propValue = obj['flg'])\r\n\t\t\t\t\tchoice.flags = parseInt(propValue);\r\n\r\n\t\t\t\treturn choice;\r\n\t\t\t}\r\n\r\n\t\t\t// Variable reference\r\n\t\t\tif (propValue = obj['VAR?']) {\r\n\t\t\t\treturn new VariableReference(propValue.toString());\r\n\t\t\t} else if (propValue = obj['CNT?']) {\r\n\t\t\t\tlet readCountVarRef = new VariableReference();\r\n\t\t\t\treadCountVarRef.pathStringForCount = propValue.toString();\r\n\t\t\t\treturn readCountVarRef;\r\n\t\t\t}\r\n\r\n\t\t\t// Variable assignment\r\n\t\t\tlet isVarAss = false;\r\n\t\t\tlet isGlobalVar = false;\r\n\t\t\tif (propValue = obj['VAR=']) {\r\n\t\t\t\tisVarAss = true;\r\n\t\t\t\tisGlobalVar = true;\r\n\t\t\t} else if (propValue = obj['temp=']) {\r\n\t\t\t\tisVarAss = true;\r\n\t\t\t\tisGlobalVar = false;\r\n\t\t\t}\r\n\t\t\tif (isVarAss) {\r\n\t\t\t\tlet varName = propValue.toString();\r\n\t\t\t\tlet isNewDecl = !obj['re'];\r\n\t\t\t\tlet varAss = new VariableAssignment(varName, isNewDecl);\r\n\t\t\t\tvarAss.isGlobal = isGlobalVar;\r\n\t\t\t\treturn varAss;\r\n\t\t\t}\r\n\t\t\tif (obj['#'] !== undefined){\r\n\t\t\t\tpropValue = obj['#'];\r\n\t\t\t\treturn new Tag(propValue.toString());\r\n\t\t\t}\r\n\r\n\t\t\t// List value\r\n\t\t\tif (propValue = obj['list']) {\r\n\t\t\t\t// var listContent = (Dictionary<string, object>)propValue;\r\n\t\t\t\tlet listContent: JObject = propValue;\r\n\t\t\t\tlet rawList = new InkList();\r\n\t\t\t\tif (propValue = obj['origins']) {\r\n\t\t\t\t\t// var namesAsObjs = (List<object>)propValue;\r\n\t\t\t\t\tlet namesAsObjs = propValue as string[];\r\n\t\t\t\t\t// rawList.SetInitialOriginNames(namesAsObjs.Cast<string>().ToList());\r\n\t\t\t\t\trawList.SetInitialOriginNames(namesAsObjs);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor (let key in listContent){\r\n\t\t\t\t\tif (listContent.hasOwnProperty(key)) {\r\n\t\t\t\t\t\tlet nameToVal = listContent[key];\r\n\t\t\t\t\t\tlet item = new InkListItem(key);\r\n\t\t\t\t\t\tlet val = parseInt(nameToVal);\r\n\t\t\t\t\t\trawList.Add(item, val);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn new ListValue(rawList);\r\n\t\t\t}\r\n\r\n\t\t\tif (obj['originalChoicePath'] != null)\r\n\t\t\t\treturn this.JObjectToChoice(obj);\r\n\t\t}\r\n\r\n\t\t// Array is always a Runtime.Container\r\n\t\tif (Array.isArray(token)){\r\n\t\t\treturn this.JArrayToContainer(token);\r\n\t\t}\r\n\r\n\t\tif (token === null || token === undefined)\r\n\t\t\treturn null;\r\n\r\n\t\tthrow new Error('Failed to convert token to runtime object: ' + JSON.stringify(token));\r\n\t}\r\n\r\n\tpublic static RuntimeObjectToJToken(obj: InkObject){\r\n\t\t// var container = obj as Container;\r\n\t\tlet container = asOrNull(obj, Container);\r\n\t\tif (container) {\r\n\t\t\treturn this.ContainerToJArray(container);\r\n\t\t}\r\n\r\n\t\t// var divert = obj as Divert;\r\n\t\tlet divert = asOrNull(obj, Divert);\r\n\t\tif (divert) {\r\n\t\t\tlet divTypeKey = '->';\r\n\t\t\tif (divert.isExternal)\r\n\t\t\t\tdivTypeKey = 'x()';\r\n\t\t\telse if (divert.pushesToStack) {\r\n\t\t\t\tif (divert.stackPushType == PushPopType.Function)\r\n\t\t\t\t\tdivTypeKey = 'f()';\r\n\t\t\t\telse if (divert.stackPushType == PushPopType.Tunnel)\r\n\t\t\t\t\tdivTypeKey = '->t->';\r\n\t\t\t}\r\n\r\n\t\t\tlet targetStr;\r\n\t\t\tif (divert.hasVariableTarget)\r\n\t\t\t\ttargetStr = divert.variableDivertName;\r\n\t\t\telse\r\n\t\t\t\ttargetStr = divert.targetPathString;\r\n\r\n\t\t\tlet jObj: JObject = {};\r\n\t\t\tjObj[divTypeKey] = targetStr;\r\n\r\n\t\t\tif (divert.hasVariableTarget)\r\n\t\t\t\tjObj['var'] = true;\r\n\r\n\t\t\tif (divert.isConditional)\r\n\t\t\t\tjObj['c'] = true;\r\n\r\n\t\t\tif (divert.externalArgs > 0)\r\n\t\t\t\tjObj['exArgs'] = divert.externalArgs;\r\n\r\n\t\t\treturn jObj;\r\n\t\t}\r\n\r\n\t\t// var choicePoint = obj as ChoicePoint;\r\n\t\tlet choicePoint = asOrNull(obj, ChoicePoint);\r\n\t\tif (choicePoint) {\r\n\t\t\tlet jObj: JObject = {};\r\n\t\t\tjObj['*'] = choicePoint.pathStringOnChoice;\r\n\t\t\tjObj['flg'] = choicePoint.flags;\r\n\t\t\treturn jObj;\r\n\t\t}\r\n\r\n\t\t// var intVal = obj as IntValue;\r\n\t\tlet intVal = asOrNull(obj, IntValue);\r\n\t\tif (intVal)\r\n\t\t\treturn intVal.value;\r\n\r\n\t\t// var floatVal = obj as FloatValue;\r\n\t\tlet floatVal = asOrNull(obj, FloatValue);\r\n\t\tif (floatVal)\r\n\t\t\treturn floatVal.value;\r\n\r\n\t\t// var strVal = obj as StringValue;\r\n\t\tlet strVal = asOrNull(obj, StringValue);\r\n\t\tif (strVal) {\r\n\t\t\tif (strVal.isNewline)\r\n\t\t\t\treturn '\\n';\r\n\t\t\telse\r\n\t\t\t\treturn '^' + strVal.value;\r\n\t\t}\r\n\r\n\t\t// var listVal = obj as ListValue;\r\n\t\tlet listVal = asOrNull(obj, ListValue);\r\n\t\tif (listVal) {\r\n\t\t\treturn this.InkListToJObject(listVal);\r\n\t\t}\r\n\r\n\t\t// var divTargetVal = obj as DivertTargetValue;\r\n\t\tlet divTargetVal = asOrNull(obj, DivertTargetValue);\r\n\t\tif (divTargetVal) {\r\n\t\t\tlet divTargetJsonObj: JObject = {};\r\n\t\t\tif (divTargetVal.value === null) { return throwNullException('divTargetVal.value'); }\r\n\t\t\tdivTargetJsonObj['^->'] = divTargetVal.value.componentsString;\r\n\t\t\treturn divTargetJsonObj;\r\n\t\t}\r\n\r\n\t\t// var varPtrVal = obj as VariablePointerValue;\r\n\t\tlet varPtrVal = asOrNull(obj, VariablePointerValue);\r\n\t\tif (varPtrVal) {\r\n\t\t\tlet varPtrJsonObj: JObject = {};\r\n\t\t\tvarPtrJsonObj['^var'] = varPtrVal.value;\r\n\t\t\tvarPtrJsonObj['ci'] = varPtrVal.contextIndex;\r\n\t\t\treturn varPtrJsonObj;\r\n\t\t}\r\n\r\n\t\t// var glue = obj as Runtime.Glue;\r\n\t\tlet glue = asOrNull(obj, Glue);\r\n\t\tif (glue) return '<>';\r\n\r\n\t\t// var controlCmd = obj as ControlCommand;\r\n\t\tlet controlCmd = asOrNull(obj, ControlCommand);\r\n\t\tif (controlCmd) {\r\n\t\t\treturn JsonSerialisation._controlCommandNames[controlCmd.commandType];\r\n\t\t}\r\n\r\n\t\t// var nativeFunc = obj as Runtime.NativeFunctionCall;\r\n\t\tlet nativeFunc = asOrNull(obj, NativeFunctionCall);\r\n\t\tif (nativeFunc) {\r\n\t\t\tlet name = nativeFunc.name;\r\n\r\n\t\t\tif (name == '^') name = 'L^';\r\n\t\t\treturn name;\r\n\t\t}\r\n\r\n\t\t// Variable reference\r\n\t\t// var varRef = obj as VariableReference;\r\n\t\tlet varRef = asOrNull(obj, VariableReference);\r\n\t\tif (varRef) {\r\n\t\t\tlet jObj: JObject = {};\r\n\t\t\tlet readCountPath = varRef.pathStringForCount;\r\n\t\t\tif (readCountPath != null) {\r\n\t\t\t\tjObj['CNT?'] = readCountPath;\r\n\t\t\t} else {\r\n\t\t\t\tjObj['VAR?'] = varRef.name;\r\n\t\t\t}\r\n\r\n\t\t\treturn jObj;\r\n\t\t}\r\n\r\n\t\t// Variable assignment\r\n\t\t// var varAss = obj as VariableAssignment;\r\n\t\tlet varAss = asOrNull(obj, VariableAssignment);\r\n\t\tif (varAss) {\r\n\t\t\tlet key = varAss.isGlobal ? 'VAR=' : 'temp=';\r\n\t\t\tlet jObj: JObject = {};\r\n\t\t\tjObj[key] = varAss.variableName;\r\n\r\n\t\t\t// Reassignment?\r\n\t\t\tif (!varAss.isNewDeclaration)\r\n\t\t\t\tjObj['re'] = true;\r\n\r\n\t\t\treturn jObj;\r\n\t\t}\r\n\r\n\t\t// var voidObj = obj as Void;\r\n\t\tlet voidObj = asOrNull(obj, Void);\r\n\t\tif (voidObj)\r\n\t\t\treturn 'void';\r\n\r\n\t\t// var tag = obj as Tag;\r\n\t\tlet tag = asOrNull(obj, Tag);\r\n\t\tif (tag) {\r\n\t\t\tlet jObj: JObject = {};\r\n\t\t\tjObj['#'] = tag.text;\r\n\t\t\treturn jObj;\r\n\t\t}\r\n\r\n\t\t// Used when serialising save state only\r\n\t\t// var choice = obj as Choice;\r\n\t\tlet choice = asOrNull(obj, Choice);\r\n\t\tif (choice)\r\n\t\t\treturn this.ChoiceToJObject(choice);\r\n\r\n\t\tthrow new Error('Failed to convert runtime object to Json token: ' + obj);\r\n\t}\r\n\r\n\tpublic static ContainerToJArray(container: Container){\r\n\t\tlet jArray = this.ListToJArray(container.content);\r\n\r\n\t\tlet namedOnlyContent = container.namedOnlyContent;\r\n\t\tlet countFlags = container.countFlags;\r\n\t\tif (namedOnlyContent != null && namedOnlyContent.size > 0 || countFlags > 0 || container.name != null) {\r\n\r\n\t\t\tlet terminatingObj;\r\n\t\t\tif (namedOnlyContent != null) {\r\n\t\t\t\tterminatingObj = this.DictionaryRuntimeObjsToJObject(namedOnlyContent);\r\n\r\n\t\t\t\tfor (let key in terminatingObj){\r\n\t\t\t\t\tif (terminatingObj.hasOwnProperty(key)) {\r\n\t\t\t\t\t\t// var subContainerJArray = namedContentObj.Value as JArray;\r\n\t\t\t\t\t\tlet subContainerJArray = terminatingObj[key];\r\n\t\t\t\t\t\tif (subContainerJArray != null) {\r\n\t\t\t\t\t\t\t// var attrJObj = subContainerJArray [subContainerJArray.Count - 1] as JObject;\r\n\t\t\t\t\t\t\tlet attrJObj = subContainerJArray[subContainerJArray.length - 1] as JObject;\r\n\t\t\t\t\t\t\tif (attrJObj != null) {\r\n\t\t\t\t\t\t\t\tdelete attrJObj['#n'];\r\n\t\t\t\t\t\t\t\tif (Object.keys(attrJObj).length == 0)\r\n\t\t\t\t\t\t\t\t\tsubContainerJArray[subContainerJArray.length - 1] = null;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t} else\r\n\t\t\t\tterminatingObj = {};\r\n\r\n\t\t\tif( countFlags > 0 )\r\n\t\t\t\tterminatingObj['#f'] = countFlags;\r\n\r\n\t\t\tif( container.name != null )\r\n\t\t\t\tterminatingObj['#n'] = container.name;\r\n\r\n\t\t\tjArray.push(terminatingObj);\r\n\t\t}\r\n\r\n\t\t// Add null terminator to indicate that there's no dictionary\r\n\t\telse {\r\n\t\t\tjArray.push(null);\r\n\t\t}\r\n\r\n\t\treturn jArray;\r\n\t}\r\n\r\n\tpublic static JArrayToContainer(jArray: any[]){\r\n\t\tlet container = new Container();\r\n\t\tcontainer.content = this.JArrayToRuntimeObjList(jArray, true);\r\n\r\n\t\tlet terminatingObj = jArray[jArray.length - 1] as JObject;\r\n\t\tif (terminatingObj != null) {\r\n\r\n\t\t\tlet namedOnlyContent = new Map();\r\n\r\n\t\t\tfor (let key in terminatingObj){\r\n\t\t\t\tif (key == '#f') {\r\n\t\t\t\t\tcontainer.countFlags = parseInt(terminatingObj[key]);\r\n\t\t\t\t} else if (key == '#n') {\r\n\t\t\t\t\tcontainer.name = terminatingObj[key].toString();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tlet namedContentItem = this.JTokenToRuntimeObject(terminatingObj[key]);\r\n\t\t\t\t\t// var namedSubContainer = namedContentItem as Container;\r\n\t\t\t\t\tlet namedSubContainer = asOrNull(namedContentItem, Container);\r\n\t\t\t\t\tif (namedSubContainer)\r\n\t\t\t\t\t\tnamedSubContainer.name = key;\r\n\t\t\t\t\tnamedOnlyContent.set(key, namedContentItem);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tcontainer.namedOnlyContent = namedOnlyContent;\r\n\t\t}\r\n\r\n\t\treturn container;\r\n\t}\r\n\r\n\tpublic static JObjectToChoice(jObj: JObject){\r\n\t\tlet choice = new Choice();\r\n\t\tchoice.text = jObj['text'].toString();\r\n\t\tchoice.index = parseInt(jObj['index']);\r\n\t\tchoice.sourcePath = jObj['originalChoicePath'].toString();\r\n\t\tchoice.originalThreadIndex = parseInt(jObj['originalThreadIndex']);\r\n\t\tchoice.pathStringOnChoice = jObj['targetPath'].toString();\r\n\t\treturn choice;\r\n\t}\r\n\r\n\tpublic static ChoiceToJObject(choice: Choice){\r\n\t\tlet jObj: JObject = {};\r\n\t\tjObj['text'] = choice.text;\r\n\t\tjObj['index'] = choice.index;\r\n\t\tjObj['originalChoicePath'] = choice.sourcePath;\r\n\t\tjObj['originalThreadIndex'] = choice.originalThreadIndex;\r\n\t\tjObj['targetPath'] = choice.pathStringOnChoice;\r\n\t\treturn jObj;\r\n\t}\r\n\r\n\tpublic static InkListToJObject(listVal: ListValue){\r\n\t\tlet rawList = listVal.value;\r\n\t\tif (rawList === null) { return throwNullException('rawList'); }\r\n\r\n\t\tlet dict: JObject = {};\r\n\r\n\t\tlet content: JObject = {};\r\n\r\n\t\tfor (let [key, val] of rawList) {\r\n\t\t\tlet item = InkListItem.fromSerializedKey(key);\r\n\t\t\tcontent[item.toString()] = val;\r\n\t\t}\r\n\r\n\t\tdict['list'] = content;\r\n\r\n\t\tif (rawList.Count == 0 && rawList.originNames != null && rawList.originNames.length > 0) {\r\n\t\t\t// dict[\"origins\"] = rawList.originNames.Cast<object> ().ToList ();\r\n\t\t\tdict['origins'] = rawList.originNames;\r\n\t\t}\r\n\r\n\t\treturn dict;\r\n\t}\r\n\r\n\tpublic static ListDefinitionsToJToken(origin: ListDefinitionsOrigin){\r\n\t\tlet result: JObject = {};\r\n\r\n\t\tfor (let def of origin.lists) {\r\n\t\t\tlet listDefJson: JObject = {};\r\n\r\n\t\t\tfor (let [key, val] of def.items) {\r\n\t\t\t\tlet item = InkListItem.fromSerializedKey(key);\r\n\t\t\t\tif (item.itemName === null) { return throwNullException('item.itemName'); }\r\n\t\t\t\tlistDefJson[item.itemName] = val;\r\n\t\t\t}\r\n\r\n\t\t\tresult[def.name] = listDefJson;\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\tpublic static JTokenToListDefinitions(obj: JObject){\r\n\t\t// var defsObj = (Dictionary<string, object>)obj;\r\n\t\tlet defsObj = obj;\r\n\r\n\t\tlet allDefs: ListDefinition[] = [];\r\n\r\n\t\tfor (let key in defsObj){\r\n\t\t\tif (defsObj.hasOwnProperty(key)) {\r\n\t\t\t\tlet name = key.toString();\r\n\t\t\t\t// var listDefJson = (Dictionary<string, object>)kv.Value;\r\n\t\t\t\tlet listDefJson: JObject = defsObj[key];\r\n\r\n\t\t\t\t// Cast (string, object) to (string, int) for items\r\n\t\t\t\tlet items: Map<string, number> = new Map();\r\n\r\n\t\t\t\tfor (let nameValueKey in listDefJson){\r\n\t\t\t\t\tif (defsObj.hasOwnProperty(key)) {\r\n\t\t\t\t\t\tlet nameValue = listDefJson[nameValueKey];\r\n\t\t\t\t\t\titems.set(nameValueKey, parseInt(nameValue));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet def = new ListDefinition(name, items);\r\n\t\t\t\tallDefs.push(def);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn new ListDefinitionsOrigin(allDefs);\r\n\t}\r\n\r\n\tprivate static _controlCommandNames = (() => {\r\n\t\tlet _controlCommandNames: string[] = [];\r\n\r\n\t\t_controlCommandNames[ControlCommand.CommandType.EvalStart] = 'ev';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.EvalOutput] = 'out';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.EvalEnd] = '/ev';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.Duplicate] = 'du';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.PopEvaluatedValue] = 'pop';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.PopFunction] = '~ret';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.PopTunnel] = '->->';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.BeginString] = 'str';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.EndString] = '/str';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.NoOp] = 'nop';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.ChoiceCount] = 'choiceCnt';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.Turns] = 'turn';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.TurnsSince] = 'turns';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.ReadCount] = 'readc';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.Random] = 'rnd';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.SeedRandom] = 'srnd';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.VisitIndex] = 'visit';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.SequenceShuffleIndex] = 'seq';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.StartThread] = 'thread';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.Done] = 'done';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.End] = 'end';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.ListFromInt] = 'listInt';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.ListRange] = 'range';\r\n\t\t_controlCommandNames[ControlCommand.CommandType.ListRandom] = 'lrnd';\r\n\r\n\t\tfor (let i = 0; i < ControlCommand.CommandType.TOTAL_VALUES; ++i) {\r\n\t\t\tif (_controlCommandNames[i] == null)\r\n\t\t\t\tthrow new Error('Control command not accounted for in serialisation');\r\n\t\t}\r\n\r\n\t\treturn _controlCommandNames;\r\n\t})();\r\n}\r\n","// Taken from https://gist.github.com/blixt/f17b47c62508be59987b\r\n// Ink uses a seedable PRNG of which there is none in native javascript.\r\nexport class PRNG{\r\n\r\n\tprivate seed: number;\r\n\r\n\tconstructor(seed: number){\r\n\t\tthis.seed = seed % 2147483647;\r\n\t\tif (this.seed <= 0) this.seed += 2147483646;\r\n\t}\r\n\tpublic next(): number{\r\n\t\treturn this.seed = this.seed * 16807 % 2147483647;\r\n\t}\r\n\tpublic nextFloat(): number{\r\n\t\treturn (this.next() - 1) / 2147483646;\r\n\t}\r\n}\r\n","// This is simple replacement of the Stopwatch class from the .NET Framework.\r\n// The original class can count time with much more accuracy than the Javascript version.\r\n// It might be worth considering using `window.performance` in the browser\r\n// or `process.hrtime()` in node.\r\nexport class Stopwatch {\r\n\r\n\tprivate startTime: number | undefined;\r\n\r\n\tconstructor(){\r\n\t\tthis.startTime = undefined;\r\n\t}\r\n\r\n\tget ElapsedMilliseconds(): number{\r\n\t\tif (typeof this.startTime === 'undefined'){\r\n\t\t\treturn 0;\r\n\t\t}\r\n\t\treturn (new Date().getTime()) - this.startTime;\r\n\t}\r\n\r\n\tpublic Start(){\r\n\t\tthis.startTime = new Date().getTime();\r\n\t}\r\n\tpublic Stop(){\r\n\t\tthis.startTime = undefined;\r\n\t}\r\n}\r\n","import {Container} from './Container';\r\nimport {InkObject} from './Object';\r\nimport {JsonSerialisation} from './JsonSerialisation';\r\nimport {StoryState} from './StoryState';\r\nimport {ControlCommand} from './ControlCommand';\r\nimport {PushPopType} from './PushPop';\r\nimport {ChoicePoint} from './ChoicePoint';\r\nimport {Choice} from './Choice';\r\nimport {Divert} from './Divert';\r\nimport {Value, StringValue, IntValue, DivertTargetValue, VariablePointerValue, ListValue} from './Value';\r\nimport {Path} from './Path';\r\nimport {Void} from './Void';\r\nimport {Tag} from './Tag';\r\nimport {VariableAssignment} from './VariableAssignment';\r\nimport {VariableReference} from './VariableReference';\r\nimport {NativeFunctionCall} from './NativeFunctionCall';\r\nimport {StoryException} from './StoryException';\r\nimport {PRNG} from './PRNG';\r\nimport {StringBuilder} from './StringBuilder';\r\nimport {ListDefinitionsOrigin} from './ListDefinitionsOrigin';\r\nimport {ListDefinition} from './ListDefinition';\r\nimport {Stopwatch} from './StopWatch';\r\nimport {Pointer} from './Pointer';\r\nimport {InkList, InkListItem, KeyValuePair} from './InkList';\r\nimport {JObject} from './JObject';\r\nimport {asOrNull, asOrThrows} from './TypeAssertion';\r\nimport {DebugMetadata} from './DebugMetadata';\r\nimport {throwNullException} from './NullException';\r\n\r\nexport {InkList} from './InkList';\r\n\r\n// tslint:disable no-conditional-assignment\r\n\r\nif (!Number.isInteger) {\r\n\tNumber.isInteger = function isInteger(nVal: any) {\r\n\t\treturn typeof nVal === 'number' && isFinite(nVal) && nVal > -9007199254740992 && nVal < 9007199254740992 && Math.floor(nVal) === nVal;\r\n\t};\r\n}\r\n\r\nexport class Story extends InkObject{\r\n\r\n\tpublic inkVersionCurrent = 19;\r\n\r\n\tpublic inkVersionMinimumCompatible = 18;\r\n\r\n\tget currentChoices(){\r\n\t\tlet choices: Choice[] = [];\r\n\r\n\t\tif (this._state === null) { return throwNullException('this._state'); }\r\n\t\tfor(let c of this._state.currentChoices) {\r\n\t\t\tif (!c.isInvisibleDefault) {\r\n\t\t\t\tc.index = choices.length;\r\n\t\t\t\tchoices.push(c);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn choices;\r\n\t}\r\n\r\n\tget currentText(){\r\n\t\tthis.IfAsyncWeCant(\"call currentText since it's a work in progress\");\r\n\t\treturn this.state.currentText;\r\n\t}\r\n\r\n\tget currentTags(){\r\n\t\tthis.IfAsyncWeCant(\"call currentTags since it's a work in progress\");\r\n\t\treturn this.state.currentTags;\r\n\t}\r\n\r\n\tget currentErrors(){\r\n\t\treturn this.state.currentErrors;\r\n\t}\r\n\r\n\tget currentWarnings(){\r\n\t\treturn this.state.currentWarnings;\r\n\t}\r\n\r\n\tget hasError(){\r\n\t\treturn this.state.hasError;\r\n\t}\r\n\r\n\tget hasWarning(){\r\n\t\treturn this.state.hasWarning;\r\n\t}\r\n\r\n\tget variablesState(){\r\n\t\treturn this.state.variablesState;\r\n\t}\r\n\r\n\tget listDefinitions(){\r\n\t\treturn this._listDefinitions;\r\n\t}\r\n\r\n\tget state(){\r\n\t\treturn this._state;\r\n\t}\r\n\r\n\t// TODO: Implement Profiler\r\n\tpublic StartProfiling(){ /* */ }\r\n\tpublic EndProfiling(){ /* */ }\r\n\r\n\tconstructor(contentContainer: Container, lists: ListDefinition[] | null);\r\n\tconstructor(jsonString: string);\r\n\tconstructor(json: JObject);\r\n\tconstructor(){\r\n\t\tsuper();\r\n\r\n\t\t// Discrimination between constructors\r\n\t\tlet contentContainer: Container;\r\n\t\tlet lists: ListDefinition[] | null = null;\r\n\t\tlet json: JObject | null = null;\r\n\r\n\t\tif (arguments[0] instanceof Container) {\r\n\t\t\tcontentContainer = arguments[0] as Container;\r\n\r\n\t\t\tif (typeof arguments[1] !== 'undefined') {\r\n\t\t\t\tlists = arguments[1] as ListDefinition[];\r\n\t\t\t}\r\n\r\n\t\t\t// ------ Story (Container contentContainer, List<Runtime.ListDefinition> lists = null)\r\n\t\t\tthis._mainContentContainer = contentContainer;\r\n\t\t\t// ------\r\n\t\t} else {\r\n\t\t\tif (typeof arguments[0] === 'string') {\r\n\t\t\t\tlet jsonString = arguments[0] as string;\r\n\t\t\t\tjson = JSON.parse(jsonString);\r\n\t\t\t} else {\r\n\t\t\t\tjson = arguments[0] as JObject;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// ------ Story (Container contentContainer, List<Runtime.ListDefinition> lists = null)\r\n\t\tif (lists != null)\r\n\t\t\tthis._listDefinitions = new ListDefinitionsOrigin(lists);\r\n\r\n\t\tthis._externals = new Map();\r\n\t\t// ------\r\n\r\n\t\t// ------ Story(string jsonString) : this((Container)null)\r\n\t\tif (json !== null) {\r\n\t\t\tlet rootObject: JObject = json;\r\n\r\n\t\t\tlet versionObj = rootObject['inkVersion'];\r\n\t\t\tif (versionObj == null)\r\n\t\t\t\tthrow new Error(\"ink version number not found. Are you sure it's a valid .ink.json file?\");\r\n\r\n\t\t\tlet formatFromFile = parseInt(versionObj);\r\n\t\t\tif (formatFromFile > this.inkVersionCurrent){\r\n\t\t\t\tthrow new Error('Version of ink used to build story was newer than the current version of the engine');\r\n\t\t\t}\r\n\t\t\telse if (formatFromFile < this.inkVersionMinimumCompatible){\r\n\t\t\t\tthrow new Error('Version of ink used to build story is too old to be loaded by this version of the engine');\r\n\t\t\t}\r\n\t\t\telse if (formatFromFile != this.inkVersionCurrent){\r\n\t\t\t\tconsole.warn(\"WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.\");\r\n\t\t\t}\r\n\r\n\t\t\tlet rootToken = rootObject['root'];\r\n\t\t\tif (rootToken == null)\r\n\t\t\t\tthrow new Error(\"Root node for ink not found. Are you sure it's a valid .ink.json file?\");\r\n\r\n\t\t\tlet listDefsObj;\r\n\t\t\tif (listDefsObj = rootObject['listDefs']) {\r\n\t\t\t\tthis._listDefinitions = JsonSerialisation.JTokenToListDefinitions(listDefsObj);\r\n\t\t\t}\r\n\r\n\t\t\tthis._mainContentContainer = asOrThrows(JsonSerialisation.JTokenToRuntimeObject(rootToken), Container);\r\n\r\n\t\t\tthis.ResetState();\r\n\t\t}\r\n\t\t// ------\r\n\t}\r\n\r\n\tpublic ToJsonString(){\r\n\t\tlet rootContainerJsonList = JsonSerialisation.RuntimeObjectToJToken(this._mainContentContainer);\r\n\r\n\t\tlet  rootObject: JObject = {};\r\n\t\trootObject['inkVersion'] = this.inkVersionCurrent;\r\n\t\trootObject['root'] = rootContainerJsonList;\r\n\r\n\t\tif (this._listDefinitions != null)\r\n\t\t\trootObject['listDefs'] = JsonSerialisation.ListDefinitionsToJToken(this._listDefinitions);\r\n\r\n\t\treturn JSON.stringify(rootObject);\r\n\t}\r\n\r\n\tpublic ResetState(){\r\n\t\tthis.IfAsyncWeCant('ResetState');\r\n\r\n\t\tthis._state = new StoryState(this);\r\n\t\tthis._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this));\r\n\r\n\t\tthis.ResetGlobals();\r\n\t}\r\n\r\n\tpublic ResetErrors(){\r\n\t\tif (this._state === null) { return throwNullException('this._state'); }\r\n\t\tthis._state.ResetErrors();\r\n\t}\r\n\r\n\tpublic ResetCallstack(){\r\n\t\tthis.IfAsyncWeCant('ResetCallstack');\r\n\t\tif (this._state === null) { return throwNullException('this._state'); }\r\n\t\tthis._state.ForceEnd();\r\n\t}\r\n\r\n\tpublic ResetGlobals(){\r\n\t\tif (this._mainContentContainer.namedContent.get('global decl')){\r\n\t\t\tlet originalPointer = this.state.currentPointer.copy();\r\n\r\n\t\t\tthis.ChoosePath(new Path('global decl'), false);\r\n\r\n\t\t\tthis.ContinueInternal();\r\n\r\n\t\t\tthis.state.currentPointer = originalPointer;\r\n\t\t}\r\n\r\n\t\tthis.state.variablesState.SnapshotDefaultGlobals();\r\n\t}\r\n\r\n\tpublic Continue(){\r\n\t\tthis.ContinueAsync(0);\r\n\t\treturn this.currentText;\r\n\t}\r\n\r\n\tget canContinue(){\r\n\t\treturn this.state.canContinue;\r\n\t}\r\n\r\n\tget asyncContinueComplete(){\r\n\t\treturn !this._asyncContinueActive;\r\n\t}\r\n\r\n\tpublic ContinueAsync(millisecsLimitAsync: number){\r\n\t\tif (!this._hasValidatedExternals)\r\n\t\t\tthis.ValidateExternalBindings();\r\n\r\n\t\tthis.ContinueInternal(millisecsLimitAsync);\r\n\t}\r\n\r\n\tpublic ContinueInternal(millisecsLimitAsync = 0){\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PreContinue();\r\n\r\n\t\tlet isAsyncTimeLimited = millisecsLimitAsync > 0;\r\n\t\tthis._recursiveContinueCount++;\r\n\r\n\t\tif (!this._asyncContinueActive) {\r\n\t\t\tthis._asyncContinueActive = isAsyncTimeLimited;\r\n\r\n\t\t\tif (!this.canContinue) {\r\n\t\t\t\tthrow new StoryException(\"Can't continue - should check canContinue before calling Continue\");\r\n\t\t\t}\r\n\r\n\t\t\tthis._state.didSafeExit = false;\r\n\t\t\tthis._state.ResetOutput();\r\n\r\n\t\t\tif (this._recursiveContinueCount == 1)\r\n\t\t\t\tthis._state.variablesState.batchObservingVariableChanges = true;\r\n\t\t}\r\n\r\n\t\tlet durationStopwatch = new Stopwatch();\r\n\t\tdurationStopwatch.Start();\r\n\r\n\t\tlet outputStreamEndsInNewline = false;\r\n\t\tdo {\r\n\t\t\ttry {\r\n\t\t\t\toutputStreamEndsInNewline = this.ContinueSingleStep();\r\n\t\t\t} catch (e) {\r\n\t\t\t\tif (!(e instanceof StoryException)) throw e;\r\n\r\n\t\t\t\tthis.AddError(e.message, undefined, e.useEndLineNumber);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tif (outputStreamEndsInNewline)\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tif (this._asyncContinueActive && durationStopwatch.ElapsedMilliseconds > millisecsLimitAsync) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t} while(this.canContinue);\r\n\r\n\t\tdurationStopwatch.Stop();\r\n\r\n\t\tif (outputStreamEndsInNewline || !this.canContinue) {\r\n\t\t\tif (this._stateAtLastNewline != null) {\r\n\t\t\t\tthis.RestoreStateSnapshot(this._stateAtLastNewline);\r\n\t\t\t\tthis._stateAtLastNewline = null;\r\n\t\t\t}\r\n\r\n\t\t\tif (!this.canContinue) {\r\n\t\t\t\tif (this.state.callStack.canPopThread)\r\n\t\t\t\t\tthis.AddError('Thread available to pop, threads should always be flat by the end of evaluation?');\r\n\r\n\t\t\t\tif (this.state.generatedChoices.length == 0 && !this.state.didSafeExit && this._temporaryEvaluationContainer == null) {\r\n\t\t\t\t\tif (this.state.callStack.CanPop(PushPopType.Tunnel))\r\n\t\t\t\t\t\tthis.AddError (\"unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?\");\r\n\t\t\t\t\telse if (this.state.callStack.CanPop(PushPopType.Function))\r\n\t\t\t\t\t\tthis.AddError (\"unexpectedly reached end of content. Do you need a '~ return'?\");\r\n\t\t\t\t\telse if (!this.state.callStack.canPop)\r\n\t\t\t\t\t\tthis.AddError (\"ran out of content. Do you need a '-> DONE' or '-> END'?\");\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tthis.AddError ('unexpectedly reached end of content for unknown reason. Please debug compiler!');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthis.state.didSafeExit = false;\r\n\r\n\t\t\tif (this._recursiveContinueCount == 1)\r\n\t\t\t\tthis._state.variablesState.batchObservingVariableChanges = false;\r\n\r\n\t\t\tthis._asyncContinueActive = false;\r\n\t\t}\r\n\r\n\t\tthis._recursiveContinueCount--;\r\n\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PostContinue();\r\n\t}\r\n\r\n\tpublic ContinueSingleStep(){\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PreStep();\r\n\r\n\t\tthis.Step();\r\n\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PostStep();\r\n\r\n\t\tif (!this.canContinue && !this.state.callStack.elementIsEvaluateFromGame) {\r\n\t\t\tthis.TryFollowDefaultInvisibleChoice();\r\n\t\t}\r\n\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PreSnapshot();\r\n\r\n\t\tif (!this.state.inStringEvaluation) {\r\n\r\n\t\t\tif (this._stateAtLastNewline != null) {\r\n\r\n\t\t\t\tif (this._stateAtLastNewline.currentTags === null) { return throwNullException('this._stateAtLastNewline.currentTags'); }\r\n\t\t\t\tif (this.state.currentTags === null) { return throwNullException('this.state.currentTags'); }\r\n\r\n\t\t\t\tlet change = this.CalculateNewlineOutputStateChange (\r\n\t\t\t\t\tthis._stateAtLastNewline.currentText, this.state.currentText,\r\n\t\t\t\t\tthis._stateAtLastNewline.currentTags.length, this.state.currentTags.length,\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (change == Story.OutputStateChange.ExtendedBeyondNewline) {\r\n\r\n\t\t\t\t\tthis.RestoreStateSnapshot(this._stateAtLastNewline);\r\n\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse if (change == Story.OutputStateChange.NewlineRemoved) {\r\n\t\t\t\t\tthis._stateAtLastNewline = null;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (this.state.outputStreamEndsInNewline) {\r\n\t\t\t\tif (this.canContinue) {\r\n\t\t\t\t\tif (this._stateAtLastNewline == null)\r\n\t\t\t\t\t\tthis._stateAtLastNewline = this.StateSnapshot();\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis._stateAtLastNewline = null;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PostSnapshot();\r\n\r\n\t\treturn false;\r\n\t}\r\n\r\n\tpublic CalculateNewlineOutputStateChange(prevText: string | null, currText: string | null, prevTagCount: number, currTagCount: number){\r\n\t\tif (prevText === null) { return throwNullException('prevText'); }\r\n\t\tif (currText === null) { return throwNullException('currText'); }\r\n\r\n\t\tlet newlineStillExists = currText.length >= prevText.length && currText.charAt(prevText.length - 1) == '\\n';\r\n\t\tif (prevTagCount == currTagCount && prevText.length == currText.length && newlineStillExists)\r\n\t\t\treturn Story.OutputStateChange.NoChange;\r\n\r\n\t\tif (!newlineStillExists) {\r\n\t\t\treturn Story.OutputStateChange.NewlineRemoved;\r\n\t\t}\r\n\r\n\t\tif (currTagCount > prevTagCount)\r\n\t\t\treturn Story.OutputStateChange.ExtendedBeyondNewline;\r\n\r\n\t\tfor (let i = prevText.length; i < currText.length; i++) {\r\n\t\t\tlet c = currText.charAt(i);\r\n\t\t\tif (c != ' ' && c != '\\t') {\r\n\t\t\t\treturn Story.OutputStateChange.ExtendedBeyondNewline;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn Story.OutputStateChange.NoChange;\r\n\t}\r\n\r\n\tpublic ContinueMaximally(){\r\n\t\tthis.IfAsyncWeCant('ContinueMaximally');\r\n\r\n\t\tlet sb = new StringBuilder();\r\n\r\n\t\twhile (this.canContinue) {\r\n\t\t\tsb.Append(this.Continue());\r\n\t\t}\r\n\r\n\t\treturn sb.toString();\r\n\t}\r\n\r\n\tpublic ContentAtPath(path: Path){\r\n\t\treturn this.mainContentContainer.ContentAtPath(path);\r\n\t}\r\n\r\n\tpublic KnotContainerWithName(name: string){\r\n\t\tlet namedContainer = this.mainContentContainer.namedContent.get(name);\r\n\t\tif (namedContainer instanceof Container)\r\n\t\t\treturn namedContainer;\r\n\t\telse\r\n\t\t\treturn null;\r\n\t}\r\n\r\n\tpublic PointerAtPath(path: Path) {\r\n\t\tif (path.length == 0)\r\n\t\t\treturn Pointer.Null;\r\n\r\n\t\tlet p = new Pointer();\r\n\r\n\t\tlet pathLengthToUse = path.length;\r\n\r\n\t\tlet result = null;\r\n\t\tif (path.lastComponent === null) { return throwNullException('path.lastComponent'); }\r\n\r\n\t\tif (path.lastComponent.isIndex) {\r\n\t\t\tpathLengthToUse = path.length - 1;\r\n\t\t\tresult = this.mainContentContainer.ContentAtPath(path, undefined, pathLengthToUse);\r\n\t\t\tp.container = result.container;\r\n\t\t\tp.index = path.lastComponent.index;\r\n\t\t} else {\r\n\t\t\tresult = this.mainContentContainer.ContentAtPath(path);\r\n\t\t\tp.container = result.container;\r\n\t\t\tp.index = -1;\r\n\t\t}\r\n\r\n\t\tif (result.obj == null || result.obj == this.mainContentContainer && pathLengthToUse > 0) {\r\n\t\t\tthis.Error(\"Failed to find content at path '\" + path + \"', and no approximation of it was possible.\");\r\n\t\t} else if (result.approximate)\r\n\t\t\tthis.Warning(\"Failed to find content at path '\" + path + \"', so it was approximated to: '\"+result.obj.path+\"'.\");\r\n\r\n\t\treturn p;\r\n\t}\r\n\r\n\tpublic StateSnapshot(){\r\n\t\treturn this.state.Copy();\r\n\t}\r\n\r\n\tpublic RestoreStateSnapshot(state: StoryState){\r\n\t\tthis._state = state;\r\n\t}\r\n\r\n\tpublic Step(){\r\n\r\n\t\tlet shouldAddToStream = true;\r\n\r\n\t\tlet pointer = this.state.currentPointer.copy();\r\n\t\tif (pointer.isNull) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Container containerToEnter = pointer.Resolve () as Container;\r\n\t\tlet containerToEnter = asOrNull(pointer.Resolve(), Container);\r\n\r\n\t\twhile(containerToEnter) {\r\n\r\n\t\t\tthis.VisitContainer(containerToEnter, true);\r\n\r\n\t\t\t// No content? the most we can do is step past it\r\n\t\t\tif (containerToEnter.content.length == 0) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tpointer = Pointer.StartOf(containerToEnter);\r\n\t\t\t// containerToEnter = pointer.Resolve() as Container;\r\n\t\t\tcontainerToEnter = asOrNull(pointer.Resolve(), Container);\r\n\t\t}\r\n\r\n\t\tthis.state.currentPointer = pointer.copy();\r\n\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.Step(this.state.callStack);\r\n\r\n\t\t// Is the current content object:\r\n\t\t//  - Normal content\r\n\t\t//  - Or a logic/flow statement - if so, do it\r\n\t\t// Stop flow if we hit a stack pop when we're unable to pop (e.g. return/done statement in knot\r\n\t\t// that was diverted to rather than called as a function)\r\n\t\tlet currentContentObj = pointer.Resolve();\r\n\t\tlet isLogicOrFlowControl = this.PerformLogicAndFlowControl(currentContentObj);\r\n\r\n\t\t// Has flow been forced to end by flow control above?\r\n\t\tif (this.state.currentPointer.isNull) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (isLogicOrFlowControl) {\r\n\t\t\tshouldAddToStream = false;\r\n\t\t}\r\n\r\n\t\t// Choice with condition?\r\n\t\t// var choicePoint = currentContentObj as ChoicePoint;\r\n\t\tlet choicePoint = asOrNull(currentContentObj, ChoicePoint);\r\n\t\tif (choicePoint) {\r\n\t\t\tlet choice = this.ProcessChoice(choicePoint);\r\n\t\t\tif (choice) {\r\n\t\t\t\tthis.state.generatedChoices.push(choice);\r\n\t\t\t}\r\n\r\n\t\t\tcurrentContentObj = null;\r\n\t\t\tshouldAddToStream = false;\r\n\t\t}\r\n\r\n\t\t// If the container has no content, then it will be\r\n\t\t// the \"content\" itself, but we skip over it.\r\n\t\tif (currentContentObj instanceof Container) {\r\n\t\t\tshouldAddToStream = false;\r\n\t\t}\r\n\r\n\t\t// Content to add to evaluation stack or the output stream\r\n\t\tif (shouldAddToStream) {\r\n\r\n\t\t\t// If we're pushing a variable pointer onto the evaluation stack, ensure that it's specific\r\n\t\t\t// to our current (possibly temporary) context index. And make a copy of the pointer\r\n\t\t\t// so that we're not editing the original runtime object.\r\n\t\t\t// var varPointer = currentContentObj as VariablePointerValue;\r\n\t\t\tlet varPointer = asOrNull(currentContentObj, VariablePointerValue);\r\n\t\t\tif (varPointer && varPointer.contextIndex == -1) {\r\n\r\n\t\t\t\t// Create new object so we're not overwriting the story's own data\r\n\t\t\t\tlet contextIdx = this.state.callStack.ContextForVariableNamed(varPointer.variableName);\r\n\t\t\t\tcurrentContentObj = new VariablePointerValue(varPointer.variableName, contextIdx);\r\n\t\t\t}\r\n\r\n\t\t\t// Expression evaluation content\r\n\t\t\tif (this.state.inExpressionEvaluation) {\r\n\t\t\t\tthis.state.PushEvaluationStack(currentContentObj);\r\n\t\t\t}\r\n\t\t\t// Output stream content (i.e. not expression evaluation)\r\n\t\t\telse {\r\n\t\t\t\tthis.state.PushToOutputStream(currentContentObj);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Increment the content pointer, following diverts if necessary\r\n\t\tthis.NextContent();\r\n\r\n\t\t// Starting a thread should be done after the increment to the content pointer,\r\n\t\t// so that when returning from the thread, it returns to the content after this instruction.\r\n\t\t// var controlCmd = currentContentObj as ;\r\n\t\tlet controlCmd = asOrNull(currentContentObj, ControlCommand);\r\n\t\tif (controlCmd && controlCmd.commandType == ControlCommand.CommandType.StartThread) {\r\n\t\t\tthis.state.callStack.PushThread();\r\n\t\t}\r\n\t}\r\n\r\n\tpublic VisitContainer(container: Container, atStart: boolean){\r\n\t\tif (!container.countingAtStartOnly || atStart) {\r\n\t\t\tif (container.visitsShouldBeCounted)\r\n\t\t\t\tthis.IncrementVisitCountForContainer(container);\r\n\r\n\t\t\tif (container.turnIndexShouldBeCounted)\r\n\t\t\t\tthis.RecordTurnIndexVisitToContainer(container);\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _prevContainers: Container[] = [];\r\n\tpublic VisitChangedContainersDueToDivert(){\r\n\t\tlet previousPointer = this.state.previousPointer.copy();\r\n\t\tlet pointer = this.state.currentPointer.copy();\r\n\r\n\t\tif (pointer.isNull || pointer.index == -1)\r\n\t\t\treturn;\r\n\r\n\t\tthis._prevContainers.length = 0;\r\n\t\tif (!previousPointer.isNull) {\r\n\t\t\t// Container prevAncestor = previousPointer.Resolve() as Container ?? previousPointer.container as Container;\r\n\t\t\tlet resolvedPreviousAncestor = previousPointer.Resolve();\r\n\t\t\tlet prevAncestor = asOrNull(resolvedPreviousAncestor, Container) || asOrNull(previousPointer.container, Container);\r\n\t\t\twhile (prevAncestor) {\r\n\t\t\t\tthis._prevContainers.push(prevAncestor);\r\n\t\t\t\t// prevAncestor = prevAncestor.parent as Container;\r\n\t\t\t\tprevAncestor = asOrNull(prevAncestor.parent, Container);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet currentChildOfContainer = pointer.Resolve();\r\n\r\n\t\tif (currentChildOfContainer == null) return;\r\n\r\n\t\t// Container currentContainerAncestor = currentChildOfContainer.parent as Container;\r\n\t\tlet currentContainerAncestor = asOrNull(currentChildOfContainer.parent, Container);\r\n\t\twhile (currentContainerAncestor && (this._prevContainers.indexOf(currentContainerAncestor) < 0 || currentContainerAncestor.countingAtStartOnly)) {\r\n\r\n\t\t\t// Check whether this ancestor container is being entered at the start,\r\n\t\t\t// by checking whether the child object is the first.\r\n\t\t\tlet enteringAtStart = currentContainerAncestor.content.length > 0\r\n\t\t\t\t&& currentChildOfContainer == currentContainerAncestor.content[0];\r\n\r\n\t\t\t// Mark a visit to this container\r\n\t\t\tthis.VisitContainer(currentContainerAncestor, enteringAtStart);\r\n\r\n\t\t\tcurrentChildOfContainer = currentContainerAncestor;\r\n\t\t\t// currentContainerAncestor = currentContainerAncestor.parent as Container;\r\n\t\t\tcurrentContainerAncestor = asOrNull(currentContainerAncestor.parent, Container);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic ProcessChoice(choicePoint: ChoicePoint){\r\n\t\tlet showChoice = true;\r\n\r\n\t\t// Don't create choice if choice point doesn't pass conditional\r\n\t\tif (choicePoint.hasCondition) {\r\n\t\t\tlet conditionValue = this.state.PopEvaluationStack();\r\n\t\t\tif (!this.IsTruthy(conditionValue)) {\r\n\t\t\t\tshowChoice = false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet startText = '';\r\n\t\tlet choiceOnlyText = '';\r\n\r\n\t\tif (choicePoint.hasChoiceOnlyContent) {\r\n\t\t\t// var choiceOnlyStrVal = state.PopEvaluationStack () as StringValue;\r\n\t\t\tlet choiceOnlyStrVal = asOrThrows(this.state.PopEvaluationStack(), StringValue);\r\n\t\t\tchoiceOnlyText = choiceOnlyStrVal.value || '';\r\n\t\t}\r\n\r\n\t\tif (choicePoint.hasStartContent) {\r\n\t\t\t// var startStrVal = state.PopEvaluationStack () as StringValue;\r\n\t\t\tlet startStrVal = asOrThrows(this.state.PopEvaluationStack(), StringValue);\r\n\t\t\tstartText = startStrVal.value || '';\r\n\t\t}\r\n\r\n\t\t// Don't create choice if player has already read this content\r\n\t\tif (choicePoint.onceOnly) {\r\n\t\t\tlet visitCount = this.VisitCountForContainer(choicePoint.choiceTarget);\r\n\t\t\tif (visitCount > 0) {\r\n\t\t\t\tshowChoice = false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// We go through the full process of creating the choice above so\r\n\t\t// that we consume the content for it, since otherwise it'll\r\n\t\t// be shown on the output stream.\r\n\t\tif (!showChoice) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tlet choice = new Choice();\r\n\t\tchoice.targetPath = choicePoint.pathOnChoice;\r\n\t\tchoice.sourcePath = choicePoint.path.toString();\r\n\t\tchoice.isInvisibleDefault = choicePoint.isInvisibleDefault;\r\n\t\tchoice.threadAtGeneration = this.state.callStack.ForkThread();\r\n\r\n\t\tchoice.text = (startText + choiceOnlyText).replace(/^[ \\t]+|[ \\t]+$/g, '');\r\n\r\n\t\treturn choice;\r\n\t}\r\n\r\n\tpublic IsTruthy(obj: InkObject){\r\n\t\tlet truthy = false;\r\n\t\tif (obj instanceof Value) {\r\n\t\t\tlet val = obj;\r\n\r\n\t\t\tif (val instanceof DivertTargetValue) {\r\n\t\t\t\tlet divTarget = val;\r\n\t\t\t\tthis.Error(\"Shouldn't use a divert target (to \" + divTarget.targetPath + \") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)\");\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\r\n\t\t\treturn val.isTruthy;\r\n\t\t}\r\n\t\treturn truthy;\r\n\t}\r\n\r\n\tpublic PerformLogicAndFlowControl(contentObj: InkObject | null){\r\n\t\tif( contentObj == null ) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\t// Divert\r\n\t\tif (contentObj instanceof Divert) {\r\n\t\t\tlet currentDivert = contentObj;\r\n\r\n\t\t\tif (currentDivert.isConditional) {\r\n\t\t\t\tlet conditionValue = this.state.PopEvaluationStack();\r\n\r\n\t\t\t\t// False conditional? Cancel divert\r\n\t\t\t\tif (!this.IsTruthy(conditionValue))\r\n\t\t\t\t\treturn true;\r\n\t\t\t}\r\n\r\n\t\t\tif (currentDivert.hasVariableTarget) {\r\n\t\t\t\tlet varName = currentDivert.variableDivertName;\r\n\r\n\t\t\t\tlet varContents = this.state.variablesState.GetVariableWithName(varName);\r\n\r\n\t\t\t\tif (varContents == null) {\r\n\t\t\t\t\tthis.Error('Tried to divert using a target from a variable that could not be found (' + varName + ')');\r\n\t\t\t\t}\r\n\t\t\t\telse if (!(varContents instanceof DivertTargetValue)) {\r\n\r\n\t\t\t\t\t// var intContent = varContents as IntValue;\r\n\t\t\t\t\tlet intContent = asOrNull(varContents, IntValue);\r\n\r\n\t\t\t\t\tlet errorMessage = 'Tried to divert to a target from a variable, but the variable (' + varName + \") didn't contain a divert target, it \";\r\n\t\t\t\t\tif (intContent instanceof IntValue && intContent.value == 0) {\r\n\t\t\t\t\t\terrorMessage += 'was empty/null (the value 0).';\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\terrorMessage += \"contained '\" + varContents + \"'.\";\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tthis.Error(errorMessage);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet target = asOrThrows(varContents, DivertTargetValue);\r\n\t\t\t\tthis.state.divertedPointer = this.PointerAtPath(target.targetPath);\r\n\r\n\t\t\t} else if (currentDivert.isExternal) {\r\n\t\t\t\tthis.CallExternalFunction(currentDivert.targetPathString, currentDivert.externalArgs);\r\n\t\t\t\treturn true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.state.divertedPointer = currentDivert.targetPointer.copy();\r\n\t\t\t}\r\n\r\n\t\t\tif (currentDivert.pushesToStack) {\r\n\t\t\t\tthis.state.callStack.Push(\r\n\t\t\t\t\tcurrentDivert.stackPushType,\r\n\t\t\t\t\tundefined,\r\n\t\t\t\t\tthis.state.outputStream.length,\r\n\t\t\t\t);\r\n\t\t\t}\r\n\r\n\t\t\tif (this.state.divertedPointer.isNull && !currentDivert.isExternal) {\r\n\r\n\t\t\t\tif (currentDivert && currentDivert.debugMetadata && currentDivert.debugMetadata.sourceName != null) {\r\n\t\t\t\t\tthis.Error(\"Divert target doesn't exist: \" + currentDivert.debugMetadata.sourceName);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.Error('Divert resolution failed: ' + currentDivert);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// Start/end an expression evaluation? Or print out the result?\r\n\t\telse if( contentObj instanceof ControlCommand ) {\r\n\t\t\tlet evalCommand = contentObj;\r\n\r\n\t\t\tswitch (evalCommand.commandType) {\r\n\r\n\t\t\tcase ControlCommand.CommandType.EvalStart:\r\n\t\t\t\tthis.Assert(this.state.inExpressionEvaluation === false, 'Already in expression evaluation?');\r\n\t\t\t\tthis.state.inExpressionEvaluation = true;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.EvalEnd:\r\n\t\t\t\tthis.Assert(this.state.inExpressionEvaluation === true, 'Not in expression evaluation mode');\r\n\t\t\t\tthis.state.inExpressionEvaluation = false;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.EvalOutput:\r\n\r\n\t\t\t\t// If the expression turned out to be empty, there may not be anything on the stack\r\n\t\t\t\tif (this.state.evaluationStack.length > 0) {\r\n\r\n\t\t\t\t\tlet output = this.state.PopEvaluationStack();\r\n\r\n\t\t\t\t\t// Functions may evaluate to Void, in which case we skip output\r\n\t\t\t\t\tif (!(output instanceof Void)) {\r\n\t\t\t\t\t\t// TODO: Should we really always blanket convert to string?\r\n\t\t\t\t\t\t// It would be okay to have numbers in the output stream the\r\n\t\t\t\t\t\t// only problem is when exporting text for viewing, it skips over numbers etc.\r\n\t\t\t\t\t\tlet text = new StringValue(output.toString());\r\n\r\n\t\t\t\t\t\tthis.state.PushToOutputStream(text);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.NoOp:\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.Duplicate:\r\n\t\t\t\tthis.state.PushEvaluationStack(this.state.PeekEvaluationStack());\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.PopEvaluatedValue:\r\n\t\t\t\tthis.state.PopEvaluationStack();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.PopFunction:\r\n\t\t\tcase ControlCommand.CommandType.PopTunnel:\r\n\r\n\t\t\t\tlet popType = evalCommand.commandType == ControlCommand.CommandType.PopFunction ?\r\n\t\t\t\t\tPushPopType.Function : PushPopType.Tunnel;\r\n\r\n\t\t\t\tlet overrideTunnelReturnTarget: DivertTargetValue | null = null;\r\n\t\t\t\tif (popType == PushPopType.Tunnel) {\r\n\t\t\t\t\tlet popped = this.state.PopEvaluationStack();\r\n\t\t\t\t\t// overrideTunnelReturnTarget = popped as DivertTargetValue;\r\n\t\t\t\t\toverrideTunnelReturnTarget = asOrNull(popped, DivertTargetValue);\r\n\t\t\t\t\tif (overrideTunnelReturnTarget === null) {\r\n\t\t\t\t\t\tthis.Assert(popped instanceof Void, \"Expected void if ->-> doesn't override target\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (this.state.TryExitFunctionEvaluationFromGame()){\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\telse if (this.state.callStack.currentElement.type != popType || !this.state.callStack.canPop) {\r\n\r\n\t\t\t\t\tlet names: Map<PushPopType, string> = new Map();\r\n\t\t\t\t\tnames.set(PushPopType.Function, 'function return statement (~ return)');\r\n\t\t\t\t\tnames.set(PushPopType.Tunnel, 'tunnel onwards statement (->->)');\r\n\r\n\t\t\t\t\tlet expected = names.get(this.state.callStack.currentElement.type);\r\n\t\t\t\t\tif (!this.state.callStack.canPop) {\r\n\t\t\t\t\t\texpected = 'end of flow (-> END or choice)';\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tlet errorMsg = 'Found ' + names.get(popType) + ', when expected ' + expected;\r\n\r\n\t\t\t\t\tthis.Error(errorMsg);\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis.state.PopCallStack();\r\n\r\n\t\t\t\t\tif (overrideTunnelReturnTarget)\r\n\t\t\t\t\t\tthis.state.divertedPointer = this.PointerAtPath(overrideTunnelReturnTarget.targetPath);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.BeginString:\r\n\t\t\t\tthis.state.PushToOutputStream(evalCommand);\r\n\r\n\t\t\t\tthis.Assert(this.state.inExpressionEvaluation === true, 'Expected to be in an expression when evaluating a string');\r\n\t\t\t\tthis.state.inExpressionEvaluation = false;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.EndString:\r\n\r\n\t\t\t\tlet contentStackForString: InkObject[] = [];\r\n\r\n\t\t\t\tlet outputCountConsumed = 0;\r\n\t\t\t\tfor (let i = this.state.outputStream.length - 1; i >= 0; --i) {\r\n\t\t\t\t\tlet obj = this.state.outputStream[i];\r\n\r\n\t\t\t\t\toutputCountConsumed++;\r\n\r\n\t\t\t\t\t// var command = obj as ControlCommand;\r\n\t\t\t\t\tlet command = asOrNull(obj, ControlCommand);\r\n\t\t\t\t\tif (command && command.commandType == ControlCommand.CommandType.BeginString) {\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif( obj instanceof StringValue ) {\r\n\t\t\t\t\t\tcontentStackForString.push(obj);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Consume the content that was produced for this string\r\n\t\t\t\tthis.state.PopFromOutputStream(outputCountConsumed);\r\n\r\n\t\t\t\t// The C# version uses a Stack for contentStackForString, but we're\r\n\t\t\t\t// using a simple array, so we need to reverse it before using it\r\n\t\t\t\tcontentStackForString = contentStackForString.reverse();\r\n\r\n\t\t\t\t// Build string out of the content we collected\r\n\t\t\t\tlet sb = new StringBuilder();\r\n\t\t\t\tfor (let c of contentStackForString) {\r\n\t\t\t\t\tsb.Append(c.toString());\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Return to expression evaluation (from content mode)\r\n\t\t\t\tthis.state.inExpressionEvaluation = true;\r\n\t\t\t\tthis.state.PushEvaluationStack(new StringValue(sb.toString()));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.ChoiceCount:\r\n\t\t\t\tlet choiceCount = this.state.generatedChoices.length;\r\n\t\t\t\tthis.state.PushEvaluationStack(new IntValue(choiceCount));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.Turns:\r\n\t\t\t\tthis.state.PushEvaluationStack (new IntValue (this.state.currentTurnIndex+1));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.TurnsSince:\r\n\t\t\tcase ControlCommand.CommandType.ReadCount:\r\n\t\t\t\tlet target = this.state.PopEvaluationStack();\r\n\t\t\t\tif( !(target instanceof DivertTargetValue) ) {\r\n\t\t\t\t\tlet extraNote = '';\r\n\t\t\t\t\tif( target instanceof IntValue )\r\n\t\t\t\t\t\textraNote = \". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?\";\r\n\t\t\t\t\tthis.Error('TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw '+target+extraNote);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// var divertTarget = target as DivertTargetValue;\r\n\t\t\t\tlet divertTarget = asOrThrows(target, DivertTargetValue);\r\n\t\t\t\t// var container = ContentAtPath (divertTarget.targetPath).correctObj as Container;\r\n\t\t\t\tlet container = asOrNull(this.ContentAtPath(divertTarget.targetPath).correctObj, Container);\r\n\r\n\t\t\t\tlet eitherCount;\r\n\t\t\t\tif (container != null) {\r\n\t\t\t\t\tif (evalCommand.commandType == ControlCommand.CommandType.TurnsSince)\r\n\t\t\t\t\t\teitherCount = this.TurnsSinceForContainer(container);\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\teitherCount = this.VisitCountForContainer(container);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (evalCommand.commandType == ControlCommand.CommandType.TurnsSince)\r\n\t\t\t\t\t\teitherCount = -1;\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\teitherCount = 0;\r\n\r\n\t\t\t\t\tthis.Warning('Failed to find container for ' + evalCommand.toString() + ' lookup at ' + divertTarget.targetPath.toString());\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.state.PushEvaluationStack(new IntValue(eitherCount));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.Random: {\r\n\t\t\t\tlet maxInt = asOrNull(this.state.PopEvaluationStack(), IntValue);\r\n\t\t\t\tlet minInt = asOrNull(this.state.PopEvaluationStack(), IntValue);\r\n\r\n\t\t\t\tif (minInt == null || minInt instanceof IntValue === false)\r\n\t\t\t\t\treturn this.Error('Invalid value for minimum parameter of RANDOM(min, max)');\r\n\r\n\t\t\t\tif (maxInt == null || minInt instanceof IntValue === false)\r\n\t\t\t\t\treturn this.Error('Invalid value for maximum parameter of RANDOM(min, max)');\r\n\r\n\t\t\t\t// Originally a primitive type, but here, can be null.\r\n\t\t\t\t// TODO: Replace by default value?\r\n\t\t\t\tif (maxInt.value === null) { return throwNullException('maxInt.value'); }\r\n\t\t\t\tif (minInt.value === null) { return throwNullException('minInt.value'); }\r\n\r\n\t\t\t\tlet randomRange = maxInt.value - minInt.value + 1;\r\n\t\t\t\tif (randomRange <= 0)\r\n\t\t\t\t\tthis.Error('RANDOM was called with minimum as ' + minInt.value + ' and maximum as ' + maxInt.value + '. The maximum must be larger');\r\n\r\n\t\t\t\tlet resultSeed = this.state.storySeed + this.state.previousRandom;\r\n\t\t\t\tlet random = new PRNG(resultSeed);\r\n\r\n\t\t\t\tlet nextRandom = random.next();\r\n\t\t\t\tlet chosenValue = (nextRandom % randomRange) + minInt.value;\r\n\t\t\t\tthis.state.PushEvaluationStack(new IntValue(chosenValue));\r\n\r\n\t\t\t\t// Next random number (rather than keeping the Random object around)\r\n\t\t\t\tthis.state.previousRandom = nextRandom;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tcase ControlCommand.CommandType.SeedRandom:\r\n\t\t\t\tlet seed = asOrNull(this.state.PopEvaluationStack(), IntValue);\r\n\t\t\t\tif (seed == null || seed instanceof IntValue === false)\r\n\t\t\t\t\treturn this.Error('Invalid value passed to SEED_RANDOM');\r\n\r\n\t\t\t\t// Originally a primitive type, but here, can be null.\r\n\t\t\t\t// TODO: Replace by default value?\r\n\t\t\t\tif (seed.value === null) { return throwNullException('minInt.value'); }\r\n\r\n\t\t\t\tthis.state.storySeed = seed.value;\r\n\t\t\t\tthis.state.previousRandom = 0;\r\n\r\n\t\t\t\tthis.state.PushEvaluationStack(new Void());\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.VisitIndex:\r\n\t\t\t\tlet count = this.VisitCountForContainer(this.state.currentPointer.container) - 1; // index not count\r\n\t\t\t\tthis.state.PushEvaluationStack(new IntValue(count));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.SequenceShuffleIndex:\r\n\t\t\t\tlet shuffleIndex = this.NextSequenceShuffleIndex();\r\n\t\t\t\tthis.state.PushEvaluationStack(new IntValue(shuffleIndex));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.StartThread:\r\n\t\t\t\t// Handled in main step function\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.Done:\r\n\t\t\t\t// We may exist in the context of the initial\r\n\t\t\t\t// act of creating the thread, or in the context of\r\n\t\t\t\t// evaluating the content.\r\n\t\t\t\tif (this.state.callStack.canPopThread) {\r\n\t\t\t\t\tthis.state.callStack.PopThread();\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// In normal flow - allow safe exit without warning\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis.state.didSafeExit = true;\r\n\r\n\t\t\t\t\t// Stop flow in current thread\r\n\t\t\t\t\tthis.state.currentPointer = Pointer.Null;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\t// Force flow to end completely\r\n\t\t\tcase ControlCommand.CommandType.End:\r\n\t\t\t\tthis.state.ForceEnd();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.ListFromInt:\r\n\t\t\t\t// var intVal = state.PopEvaluationStack () as IntValue;\r\n\t\t\t\tlet intVal = asOrNull(this.state.PopEvaluationStack(), IntValue);\r\n\t\t\t\t// var listNameVal = state.PopEvaluationStack () as StringValue;\r\n\t\t\t\tlet listNameVal = asOrThrows(this.state.PopEvaluationStack(), StringValue);\r\n\r\n\t\t\t\tif (intVal === null) {\r\n\t\t\t\t\tthrow new StoryException('Passed non-integer when creating a list element from a numerical value.');\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet generatedListValue = null;\r\n\r\n\t\t\t\tif (this.listDefinitions === null) { return throwNullException('this.listDefinitions'); }\r\n\t\t\t\tlet foundListDef = this.listDefinitions.TryListGetDefinition(listNameVal.value, null);\r\n\t\t\t\tif (foundListDef.exists) {\r\n\t\t\t\t\t// Originally a primitive type, but here, can be null.\r\n\t\t\t\t\t// TODO: Replace by default value?\r\n\t\t\t\t\tif (intVal.value === null) { return throwNullException('minInt.value'); }\r\n\r\n\t\t\t\t\tlet foundItem = foundListDef.result!.TryGetItemWithValue(intVal.value, InkListItem.Null);\r\n\t\t\t\t\tif (foundItem.exists) {\r\n\t\t\t\t\t\tgeneratedListValue = new ListValue(foundItem.result!, intVal.value);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new StoryException('Failed to find LIST called ' + listNameVal.value);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (generatedListValue == null)\r\n\t\t\t\t\tgeneratedListValue = new ListValue();\r\n\r\n\t\t\t\tthis.state.PushEvaluationStack(generatedListValue);\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.ListRange:\r\n\t\t\t\tlet max = asOrNull(this.state.PopEvaluationStack(), Value);\r\n\t\t\t\tlet min = asOrNull(this.state.PopEvaluationStack(), Value);\r\n\r\n\t\t\t\t// var targetList = state.PopEvaluationStack () as ListValue;\r\n\t\t\t\tlet targetList = asOrNull(this.state.PopEvaluationStack(), ListValue);\r\n\r\n\t\t\t\tif (targetList === null || min === null || max === null)\r\n\t\t\t\t\tthrow new StoryException('Expected list, minimum and maximum for LIST_RANGE');\r\n\r\n\t\t\t\tif (targetList.value === null) { return throwNullException('targetList.value'); }\r\n\t\t\t\tlet result = targetList.value.ListWithSubRange(min.valueObject, max.valueObject);\r\n\r\n\t\t\t\tthis.state.PushEvaluationStack (new ListValue(result));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.ListRandom: {\r\n\t\t\t\tlet listVal = this.state.PopEvaluationStack() as ListValue;\r\n\t\t\t\tif (listVal === null)\r\n\t\t\t\t\tthrow new StoryException('Expected list for LIST_RANDOM');\r\n\r\n\t\t\t\tlet list = listVal.value;\r\n\r\n\t\t\t\tlet newList: InkList | null = null;\r\n\r\n\t\t\t\tif (list === null) { throw throwNullException('list'); }\r\n\t\t\t\tif (list.Count == 0) {\r\n\t\t\t\t\tnewList = new InkList();\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Generate a random index for the element to take\r\n\t\t\t\t\tlet resultSeed = this.state.storySeed + this.state.previousRandom;\r\n\t\t\t\t\tlet random = new PRNG(resultSeed);\r\n\r\n\t\t\t\t\tlet nextRandom = random.next();\r\n\t\t\t\t\tlet listItemIndex = nextRandom % list.Count;\r\n\r\n\t\t\t\t\t// This bit is a little different from the original\r\n\t\t\t\t\t// C# code, since iterators do not work in the same way.\r\n\t\t\t\t\t// First, we iterate listItemIndex - 1 times, calling next().\r\n\t\t\t\t\t// The listItemIndex-th time is made outside of the loop,\r\n\t\t\t\t\t// in order to retrieve the value.\r\n\t\t\t\t\tlet listEnumerator = list.entries();\r\n\t\t\t\t\tfor (let i = 0; i <= listItemIndex - 1; i++) {\r\n\t\t\t\t\t\tlistEnumerator.next();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlet value = listEnumerator.next().value;\r\n\t\t\t\t\tlet randomItem: KeyValuePair<InkListItem, number> = {\r\n\t\t\t\t\t\tKey: InkListItem.fromSerializedKey(value[0]),\r\n\t\t\t\t\t\tValue: value[1],\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\t// Origin list is simply the origin of the one element\r\n\t\t\t\t\tif (randomItem.Key.originName === null) { return throwNullException('randomItem.Key.originName'); }\r\n\t\t\t\t\tnewList = new InkList(randomItem.Key.originName, this);\r\n\t\t\t\t\tnewList.Add(randomItem.Key, randomItem.Value);\r\n\r\n\t\t\t\t\tthis.state.previousRandom = nextRandom;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.state.PushEvaluationStack(new ListValue(newList));\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tdefault:\r\n\t\t\t\tthis.Error('unhandled ControlCommand: ' + evalCommand);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// Variable assignment\r\n\t\telse if( contentObj instanceof VariableAssignment ) {\r\n\t\t\tlet varAss = contentObj;\r\n\t\t\tlet assignedVal = this.state.PopEvaluationStack();\r\n\r\n\t\t\tthis.state.variablesState.Assign(varAss, assignedVal);\r\n\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// Variable reference\r\n\t\telse if( contentObj instanceof VariableReference ) {\r\n\t\t\tlet varRef = contentObj;\r\n\t\t\tlet foundValue = null;\r\n\r\n\t\t\t// Explicit read count value\r\n\t\t\tif (varRef.pathForCount != null) {\r\n\r\n\t\t\t\tlet container = varRef.containerForCount;\r\n\t\t\t\tlet count = this.VisitCountForContainer(container);\r\n\t\t\t\tfoundValue = new IntValue(count);\r\n\t\t\t}\r\n\r\n\t\t\t// Normal variable reference\r\n\t\t\telse {\r\n\r\n\t\t\t\tfoundValue = this.state.variablesState.GetVariableWithName(varRef.name);\r\n\r\n\t\t\t\tif (foundValue == null) {\r\n\t\t\t\t\tlet defaultVal = this.state.variablesState.TryGetDefaultVariableValue (varRef.name);\r\n\t\t\t\t\tif (defaultVal != null) {\r\n\t\t\t\t\t\tthis.Warning(\"Variable not found in save state: '\" + varRef.name + \"', but seems to have been newly created. Assigning value from latest ink's declaration: \" + defaultVal);\r\n\t\t\t\t\t\tfoundValue = defaultVal;\r\n\r\n\t\t\t\t\t\t// Save for future usage, preventing future errors\r\n\t\t\t\t\t\t// Only do this for variables that are known to be globals, not those that may be missing temps.\r\n\t\t\t\t\t\tthis.state.variablesState.SetGlobal(varRef.name, foundValue);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.Warning (\"Variable not found: '\" + varRef.name + \"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit.\");\r\n\t\t\t\t\t\tfoundValue = new IntValue(0);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthis.state.PushEvaluationStack(foundValue);\r\n\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// Native function call\r\n\t\telse if (contentObj instanceof NativeFunctionCall) {\r\n\t\t\tlet func = contentObj;\r\n\t\t\tlet funcParams = this.state.PopEvaluationStack(func.numberOfParameters);\r\n\t\t\tlet result = func.Call(funcParams);\r\n\t\t\tthis.state.PushEvaluationStack(result);\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// No control content, must be ordinary content\r\n\t\treturn false;\r\n\t}\r\n\r\n\tpublic ChoosePathString(path: string, resetCallstack = true, args: any[] = []){\r\n\t\tthis.IfAsyncWeCant ('call ChoosePathString right now');\r\n\r\n\t\tif (resetCallstack) {\r\n\t\t\tthis.ResetCallstack();\r\n\t\t} else {\r\n\t\t\tif (this.state.callStack.currentElement.type == PushPopType.Function) {\r\n\t\t\t\tlet funcDetail = '';\r\n\t\t\t\tlet container = this.state.callStack.currentElement.currentPointer.container;\r\n\t\t\t\tif (container != null) {\r\n\t\t\t\t\tfuncDetail = '('+container.path.toString ()+') ';\r\n\t\t\t\t}\r\n\t\t\t\tthrow new Error('Story was running a function '+funcDetail+'when you called ChoosePathString('+path+') - this is almost certainly not not what you want! Full stack trace: \\n'+this.state.callStack.callStackTrace);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.state.PassArgumentsToEvaluationStack(args);\r\n\t\tthis.ChoosePath(new Path(path));\r\n\t}\r\n\r\n\tpublic IfAsyncWeCant(activityStr: string)\r\n\t{\r\n\t\tif (this._asyncContinueActive)\r\n\t\t\tthrow new Error(\"Can't \" + activityStr + '. Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.');\r\n\t}\r\n\r\n\tpublic ChoosePath(p: Path, incrementingTurnIndex: boolean = true){\r\n\t\tthis.state.SetChosenPath(p, incrementingTurnIndex);\r\n\r\n\t\t// Take a note of newly visited containers for read counts etc\r\n\t\tthis.VisitChangedContainersDueToDivert();\r\n\t}\r\n\r\n\tpublic ChooseChoiceIndex(choiceIdx: number){\r\n\t\tchoiceIdx = choiceIdx;\r\n\t\tlet choices = this.currentChoices;\r\n\t\tthis.Assert(choiceIdx >= 0 && choiceIdx < choices.length, 'choice out of range');\r\n\r\n\t\tlet choiceToChoose = choices[choiceIdx];\r\n\t\tif (choiceToChoose.threadAtGeneration === null) { return throwNullException('choiceToChoose.threadAtGeneration'); }\r\n\t\tif (choiceToChoose.targetPath === null) { return throwNullException('choiceToChoose.targetPath'); }\r\n\r\n\t\tthis.state.callStack.currentThread = choiceToChoose.threadAtGeneration;\r\n\r\n\t\tthis.ChoosePath(choiceToChoose.targetPath);\r\n\t}\r\n\r\n\tpublic HasFunction(functionName: string){\r\n\t\ttry {\r\n\t\t\treturn this.KnotContainerWithName(functionName) != null;\r\n\t\t} catch(e) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic EvaluateFunction(functionName: string, args: any[] = [], returnTextOutput: boolean = false): Story.EvaluateFunctionTextOutput | any{\r\n\t\t// EvaluateFunction behaves slightly differently than the C# version.\r\n\t\t// In C#, you can pass a (second) parameter `out textOutput` to get the\r\n\t\t// text outputted by the function. This is not possible in js. Instead,\r\n\t\t// we maintain the regular signature (functionName, args), plus an\r\n\t\t// optional third parameter returnTextOutput. If set to true, we will\r\n\t\t// return both the textOutput and the returned value, as an object.\r\n\r\n\t\tthis.IfAsyncWeCant('evaluate a function');\r\n\r\n\t\tif (functionName == null) {\r\n\t\t\tthrow new Error('Function is null');\r\n\t\t}\r\n\t\telse if (functionName == '' || functionName.trim() == '') {\r\n\t\t\tthrow new Error('Function is empty or white space.');\r\n\t\t}\r\n\r\n\t\tlet funcContainer = this.KnotContainerWithName(functionName);\r\n\t\tif (funcContainer == null) {\r\n\t\t\tthrow new Error(\"Function doesn't exist: '\" + functionName + \"'\");\r\n\t\t}\r\n\r\n\t\tlet outputStreamBefore: InkObject[] = [];\r\n\t\toutputStreamBefore.push.apply(outputStreamBefore, this.state.outputStream);\r\n\t\tthis._state.ResetOutput();\r\n\r\n\t\tthis.state.StartFunctionEvaluationFromGame(funcContainer, args);\r\n\r\n\t\t// Evaluate the function, and collect the string output\r\n\t\tlet stringOutput = new StringBuilder();\r\n\t\twhile (this.canContinue) {\r\n\t\t\tstringOutput.Append(this.Continue());\r\n\t\t}\r\n\t\tlet textOutput = stringOutput.toString();\r\n\r\n\t\tthis._state.ResetOutput(outputStreamBefore);\r\n\r\n\t\tlet result = this.state.CompleteFunctionEvaluationFromGame();\r\n\r\n\t\treturn (returnTextOutput) ? {returned: result, output: textOutput} : result;\r\n\t}\r\n\r\n\tpublic EvaluateExpression(exprContainer: Container){\r\n\t\tlet startCallStackHeight = this.state.callStack.elements.length;\r\n\r\n\t\tthis.state.callStack.Push(PushPopType.Tunnel);\r\n\r\n\t\tthis._temporaryEvaluationContainer = exprContainer;\r\n\r\n\t\tthis.state.GoToStart();\r\n\r\n\t\tlet evalStackHeight = this.state.evaluationStack.length;\r\n\r\n\t\tthis.Continue();\r\n\r\n\t\tthis._temporaryEvaluationContainer = null;\r\n\r\n\t\t// Should have fallen off the end of the Container, which should\r\n\t\t// have auto-popped, but just in case we didn't for some reason,\r\n\t\t// manually pop to restore the state (including currentPath).\r\n\t\tif (this.state.callStack.elements.length > startCallStackHeight) {\r\n\t\t\tthis.state.PopCallStack();\r\n\t\t}\r\n\r\n\t\tlet endStackHeight = this.state.evaluationStack.length;\r\n\t\tif (endStackHeight > evalStackHeight) {\r\n\t\t\treturn this.state.PopEvaluationStack();\r\n\t\t} else {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic allowExternalFunctionFallbacks: boolean = false;\r\n\r\n\tpublic CallExternalFunction(funcName: string | null, numberOfArguments: number){\r\n\t\tif (funcName === null) { return throwNullException('funcName'); }\r\n\t\tlet func = this._externals.get(funcName);\r\n\t\tlet fallbackFunctionContainer = null;\r\n\r\n\t\tlet foundExternal = typeof func !== 'undefined';\r\n\r\n\t\t// Try to use fallback function?\r\n\t\tif (!foundExternal) {\r\n\t\t\tif (this.allowExternalFunctionFallbacks) {\r\n\t\t\t\tfallbackFunctionContainer = this.KnotContainerWithName(funcName);\r\n\t\t\t\tthis.Assert(fallbackFunctionContainer !== null, \"Trying to call EXTERNAL function '\" + funcName + \"' which has not been bound, and fallback ink function could not be found.\");\r\n\r\n\t\t\t\t// Divert direct into fallback function and we're done\r\n\t\t\t\tthis.state.callStack.Push(\r\n\t\t\t\t\tPushPopType.Function,\r\n\t\t\t\t\tundefined,\r\n\t\t\t\t\tthis.state.outputStream.length,\r\n\t\t\t\t);\r\n\t\t\t\tthis.state.divertedPointer = Pointer.StartOf(fallbackFunctionContainer);\r\n\t\t\t\treturn;\r\n\r\n\t\t\t} else {\r\n\t\t\t\tthis.Assert(false, \"Trying to call EXTERNAL function '\" + funcName + \"' which has not been bound (and ink fallbacks disabled).\");\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Pop arguments\r\n\t\tlet args: any[] = [];\r\n\t\tfor (let i = 0; i < numberOfArguments; ++i) {\r\n\t\t\t// var poppedObj = state.PopEvaluationStack () as Value;\r\n\t\t\tlet poppedObj = asOrThrows(this.state.PopEvaluationStack(), Value);\r\n\t\t\tlet valueObj = poppedObj.valueObject;\r\n\t\t\targs.push(valueObj);\r\n\t\t}\r\n\r\n\t\t// Reverse arguments from the order they were popped,\r\n\t\t// so they're the right way round again.\r\n\t\targs.reverse();\r\n\r\n\t\t// Run the function!\r\n\t\tlet funcResult = func!(args);\r\n\r\n\t\t// Convert return value (if any) to the a type that the ink engine can use\r\n\t\tlet returnObj = null;\r\n\t\tif (funcResult != null) {\r\n\t\t\treturnObj = Value.Create(funcResult);\r\n\t\t\tthis.Assert(returnObj !== null, 'Could not create ink value from returned object of type ' + (typeof funcResult));\r\n\t\t} else {\r\n\t\t\treturnObj = new Void();\r\n\t\t}\r\n\r\n\t\tthis.state.PushEvaluationStack(returnObj);\r\n\t}\r\n\r\n\tpublic BindExternalFunctionGeneral(funcName: string, func: Story.ExternalFunction){\r\n\t\tthis.IfAsyncWeCant('bind an external function');\r\n\t\tthis.Assert(!this._externals.has(funcName), \"Function '\" + funcName + \"' has already been bound.\");\r\n\t\tthis._externals.set(funcName, func);\r\n\t}\r\n\r\n\tpublic TryCoerce(value: any){\r\n\t\t// We're skipping type coercition in this implementation. First of, js\r\n\t\t// is loosely typed, so it's not that important. Secondly, there is no\r\n\t\t// clean way (AFAIK) for the user to describe what type of parameters\r\n\t\t// they expect.\r\n\t\treturn value;\r\n\t}\r\n\r\n\tpublic BindExternalFunction(funcName: string, func: Story.ExternalFunction){\r\n\t\tthis.Assert(func != null, \"Can't bind a null function\");\r\n\r\n\t\tthis.BindExternalFunctionGeneral(funcName, (args: any) => {\r\n\t\t\tthis.Assert(args.length >= func.length, 'External function expected ' + func.length + ' arguments');\r\n\r\n\t\t\tlet coercedArgs = [];\r\n\t\t\tfor (let i = 0, l = args.length; i < l; i++){\r\n\t\t\t\tcoercedArgs[i] = this.TryCoerce(args[i]);\r\n\t\t\t}\r\n\t\t\treturn func.apply(null, coercedArgs);\r\n\t\t});\r\n\t}\r\n\r\n\tpublic UnbindExternalFunction(funcName: string){\r\n\t\tthis.IfAsyncWeCant('unbind an external a function');\r\n\t\tthis.Assert(this._externals.has(funcName), \"Function '\" + funcName + \"' has not been bound.\");\r\n\t\tthis._externals.delete(funcName);\r\n\t}\r\n\r\n\tpublic ValidateExternalBindings(): void;\r\n\tpublic ValidateExternalBindings(c: Container | null, missingExternals: Set<string>): void;\r\n\tpublic ValidateExternalBindings(o: InkObject | null, missingExternals: Set<string>): void;\r\n\tpublic ValidateExternalBindings(){\r\n\r\n\t\tlet c: Container | null = null;\r\n\t\tlet o: InkObject | null = null;\r\n\t\tlet missingExternals: Set<string> = arguments[1] || new Set();\r\n\r\n\t\tif (arguments[0] instanceof Container) {\r\n\t\t\tc = arguments[0];\r\n\t\t}\r\n\r\n\t\tif (arguments[0] instanceof InkObject) {\r\n\t\t\to = arguments[0];\r\n\t\t}\r\n\r\n\t\tif (c === null && o === null) {\r\n\t\t\tthis.ValidateExternalBindings(this._mainContentContainer, missingExternals);\r\n\t\t\tthis._hasValidatedExternals = true;\r\n\r\n\t\t\t// No problem! Validation complete\r\n\t\t\tif( missingExternals.size == 0 ) {\r\n\t\t\t\tthis._hasValidatedExternals = true;\r\n\t\t\t} else {\r\n\t\t\t\tlet message = 'Error: Missing function binding for external';\r\n\t\t\t\tmessage += (missingExternals.size > 1) ? 's' : '';\r\n\t\t\t\tmessage += \": '\";\r\n\t\t\t\tmessage += Array.from(missingExternals).join(\"', '\");\r\n\t\t\t\tmessage += \"' \";\r\n\t\t\t\tmessage += (this.allowExternalFunctionFallbacks) ? ', and no fallback ink function found.' : ' (ink fallbacks disabled)';\r\n\r\n\t\t\t\tthis.Error(message);\r\n\t\t\t}\r\n\t\t} else if (c != null) {\r\n\t\t\tfor (let innerContent of c.content) {\r\n\t\t\t\tlet container = innerContent as Container;\r\n\t\t\t\tif (container == null || !container.hasValidName)\r\n\t\t\t\t\tthis.ValidateExternalBindings (innerContent, missingExternals);\r\n\t\t\t}\r\n\t\t\tfor (let [key, value] of c.namedContent) {\r\n\t\t\t\tthis.ValidateExternalBindings (asOrNull(value, InkObject), missingExternals);\r\n\t\t\t}\r\n\t\t} else if (o != null) {\r\n\t\t\tlet divert = asOrNull(o, Divert);\r\n\t\t\tif (divert && divert.isExternal) {\r\n\t\t\t\tlet name = divert.targetPathString;\r\n\t\t\t\tif (name === null) { return throwNullException('name'); }\r\n\t\t\t\tif (!this._externals.has(name)) {\r\n\t\t\t\t\tif (this.allowExternalFunctionFallbacks) {\r\n\t\t\t\t\t\tlet fallbackFound = this.mainContentContainer.namedContent.has(name);\r\n\t\t\t\t\t\tif (!fallbackFound) {\r\n\t\t\t\t\t\t\tmissingExternals.add(name);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tmissingExternals.add(name);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic ObserveVariable(variableName: string, observer: Story.VariableObserver){\r\n\t\tthis.IfAsyncWeCant('observe a new variable');\r\n\r\n\t\tif (this._variableObservers === null)\r\n\t\t\tthis._variableObservers = new Map();\r\n\r\n\t\tif(!this.state.variablesState.GlobalVariableExistsWithName(variableName))\r\n\t\t\tthrow new StoryException(\"Cannot observe variable '\"+variableName+\"' because it wasn't declared in the ink story.\");\r\n\r\n\t\tif (this._variableObservers.has(variableName)) {\r\n\t\t\tthis._variableObservers.get(variableName)!.push(observer);\r\n\t\t} else {\r\n\t\t\tthis._variableObservers.set(variableName, [observer]);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic ObserveVariables(variableNames: string[], observers: Story.VariableObserver[]){\r\n\t\tfor (let i = 0, l = variableNames.length; i < l; i++){\r\n\t\t\tthis.ObserveVariable(variableNames[i], observers[i]);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic RemoveVariableObserver(observer: Story.VariableObserver, specificVariableName: string){\r\n\t\tthis.IfAsyncWeCant('remove a variable observer');\r\n\r\n\t\tif (this._variableObservers === null)\r\n\t\t\treturn;\r\n\r\n\t\tif (typeof specificVariableName !== 'undefined') {\r\n\t\t\tif (this._variableObservers.has(specificVariableName)) {\r\n\t\t\t\tlet observers = this._variableObservers.get(specificVariableName)!;\r\n\t\t\t\tobservers.splice(observers.indexOf(observer), 1);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tlet keys = this._variableObservers.keys();\r\n\r\n\t\t\tfor (let varName of keys){\r\n\t\t\t\tlet observers = this._variableObservers.get(varName)!;\r\n\t\t\t\tobservers.splice(observers.indexOf(observer), 1);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic VariableStateDidChangeEvent(variableName: string, newValueObj: InkObject){\r\n\t\tif (this._variableObservers === null)\r\n\t\t\treturn;\r\n\r\n\t\tlet observers = this._variableObservers.get(variableName);\r\n\t\tif (typeof observers !== 'undefined') {\r\n\t\t\tif (!(newValueObj instanceof Value)) {\r\n\t\t\t\tthrow new Error(\"Tried to get the value of a variable that isn't a standard type\");\r\n\t\t\t}\r\n\t\t\t// var val = newValueObj as Value;\r\n\t\t\tlet val = asOrThrows(newValueObj, Value);\r\n\r\n\t\t\tfor (let observer of observers) {\r\n\t\t\t\tobserver(variableName, val.valueObject);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget globalTags(){\r\n\t\treturn this.TagsAtStartOfFlowContainerWithPathString('');\r\n\t}\r\n\r\n\tpublic TagsForContentAtPath(path: string){\r\n\t\treturn this.TagsAtStartOfFlowContainerWithPathString(path);\r\n\t}\r\n\r\n\tpublic TagsAtStartOfFlowContainerWithPathString(pathString: string){\r\n\t\tlet path = new Path(pathString);\r\n\r\n\t\tlet flowContainer = this.ContentAtPath(path).container;\r\n\t\tif (flowContainer === null) { return throwNullException('flowContainer'); }\r\n\t\twhile(true) {\r\n\t\t\tlet firstContent: InkObject = flowContainer.content[0];\r\n\t\t\tif (firstContent instanceof Container)\r\n\t\t\t\tflowContainer = firstContent;\r\n\t\t\telse break;\r\n\t\t}\r\n\r\n\t\tlet tags: string[] | null = null;\r\n\r\n\t\tfor(let c of flowContainer.content) {\r\n\t\t\t// var tag = c as Runtime.Tag;\r\n\t\t\tlet tag = asOrNull(c, Tag);\r\n\t\t\tif (tag) {\r\n\t\t\t\tif (tags == null) tags = [];\r\n\t\t\t\ttags.push(tag.text);\r\n\t\t\t} else break;\r\n\t\t}\r\n\r\n\t\treturn tags;\r\n\t}\r\n\r\n\tpublic BuildStringOfHierarchy(){\r\n\t\tlet sb = new StringBuilder();\r\n\r\n\t\tthis.mainContentContainer.BuildStringOfHierarchy(sb, 0, this.state.currentPointer.Resolve());\r\n\r\n\t\treturn sb.toString();\r\n\t}\r\n\r\n\tpublic BuildStringOfContainer(container: Container){\r\n\t\tlet sb = new StringBuilder();\r\n\t\tcontainer.BuildStringOfHierarchy(sb, 0, this.state.currentPointer.Resolve());\r\n\t\treturn sb.toString();\r\n\t}\r\n\r\n\tpublic NextContent(){\r\n\t\tthis.state.previousPointer = this.state.currentPointer.copy();\r\n\r\n\t\tif (!this.state.divertedPointer.isNull) {\r\n\r\n\t\t\tthis.state.currentPointer = this.state.divertedPointer.copy();\r\n\t\t\tthis.state.divertedPointer = Pointer.Null;\r\n\r\n\t\t\tthis.VisitChangedContainersDueToDivert();\r\n\r\n\t\t\tif (!this.state.currentPointer.isNull) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet successfulPointerIncrement = this.IncrementContentPointer();\r\n\r\n\t\tif (!successfulPointerIncrement) {\r\n\r\n\t\t\tlet didPop = false;\r\n\r\n\t\t\tif (this.state.callStack.CanPop(PushPopType.Function)) {\r\n\r\n\t\t\t\tthis.state.PopCallStack(PushPopType.Function);\r\n\r\n\t\t\t\tif (this.state.inExpressionEvaluation) {\r\n\t\t\t\t\tthis.state.PushEvaluationStack(new Void());\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdidPop = true;\r\n\t\t\t} else if (this.state.callStack.canPopThread) {\r\n\t\t\t\tthis.state.callStack.PopThread();\r\n\r\n\t\t\t\tdidPop = true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.state.TryExitFunctionEvaluationFromGame();\r\n\t\t\t}\r\n\r\n\t\t\tif (didPop && !this.state.currentPointer.isNull) {\r\n\t\t\t\tthis.NextContent();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic IncrementContentPointer(){\r\n\t\tlet successfulIncrement = true;\r\n\r\n\t\tlet pointer = this.state.callStack.currentElement.currentPointer.copy();\r\n\t\tpointer.index++;\r\n\r\n\t\tif (pointer.container === null) { return throwNullException('pointer.container'); }\r\n\t\twhile (pointer.index >= pointer.container.content.length) {\r\n\r\n\t\t\tsuccessfulIncrement = false;\r\n\r\n\t\t\t// Container nextAncestor = pointer.container.parent as Container;\r\n\t\t\tlet nextAncestor = asOrNull(pointer.container.parent, Container);\r\n\t\t\tif (nextAncestor instanceof Container === false) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tlet indexInAncestor = nextAncestor!.content.indexOf(pointer.container);\r\n\t\t\tif (indexInAncestor == -1) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tpointer = new Pointer(nextAncestor, indexInAncestor);\r\n\r\n\t\t\tpointer.index++;\r\n\r\n\t\t\tsuccessfulIncrement = true;\r\n\t\t\tif (pointer.container === null) { return throwNullException('pointer.container'); }\r\n\t\t}\r\n\r\n\t\tif (!successfulIncrement) pointer = Pointer.Null;\r\n\r\n\t\tthis.state.callStack.currentElement.currentPointer = pointer.copy();\r\n\r\n\t\treturn successfulIncrement;\r\n\t}\r\n\r\n\tpublic TryFollowDefaultInvisibleChoice(){\r\n\t\tlet allChoices = this._state.currentChoices;\r\n\r\n\t\tlet invisibleChoices = allChoices.filter((c) => {\r\n\t\t\treturn c.isInvisibleDefault;\r\n\t\t});\r\n\r\n\t\tif (invisibleChoices.length == 0 || allChoices.length > invisibleChoices.length)\r\n\t\t\treturn false;\r\n\r\n\t\tlet choice = invisibleChoices[0];\r\n\r\n\t\tif (choice.targetPath === null) { return throwNullException('choice.targetPath'); }\r\n\r\n\t\tif (choice.threadAtGeneration === null) { return throwNullException('choice.threadAtGeneration'); }\r\n\r\n\t\tthis.state.callStack.currentThread = choice.threadAtGeneration;\r\n\r\n\t\tthis.ChoosePath(choice.targetPath, false);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\tpublic VisitCountForContainer(container: Container | null){\r\n\t\tif (container === null) { return throwNullException('container'); }\r\n\t\tif( !container.visitsShouldBeCounted ) {\r\n\t\t\tconsole.warn('Read count for target ('+container.name+' - on '+container.debugMetadata+') unknown. The story may need to be compiled with countAllVisits flag (-c).');\r\n\t\t\treturn 0;\r\n\t\t}\r\n\r\n\t\tlet count = 0;\r\n\t\tlet containerPathStr = container.path.toString();\r\n\t\tcount = this.state.visitCounts.get(containerPathStr) || count;\r\n\t\treturn count;\r\n\t}\r\n\r\n\tpublic IncrementVisitCountForContainer(container: Container){\r\n\t\tlet count = 0;\r\n\t\tlet containerPathStr = container.path.toString();\r\n\t\tif (this.state.visitCounts.has(containerPathStr)) count = this.state.visitCounts.get(containerPathStr)!;\r\n\t\tcount++;\r\n\t\tthis.state.visitCounts.set(containerPathStr, count);\r\n\t}\r\n\r\n\tpublic RecordTurnIndexVisitToContainer(container: Container){\r\n\t\tlet containerPathStr = container.path.toString();\r\n\t\tthis.state.turnIndices.set(containerPathStr, this.state.currentTurnIndex);\r\n\t}\r\n\r\n\tpublic TurnsSinceForContainer(container: Container){\r\n\t\tif( !container.turnIndexShouldBeCounted ) {\r\n\t\t\tthis.Error('TURNS_SINCE() for target ('+container.name+' - on '+container.debugMetadata+') unknown. The story may need to be compiled with countAllVisits flag (-c).');\r\n\t\t}\r\n\r\n\t\tlet containerPathStr = container.path.toString();\r\n\t\tlet index = this.state.turnIndices.get(containerPathStr);\r\n\t\tif (typeof index !== 'undefined') {\r\n\t\t\treturn this.state.currentTurnIndex - index;\r\n\t\t} else {\r\n\t\t\treturn -1;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic NextSequenceShuffleIndex(){\r\n\t\t// var numElementsIntVal = state.PopEvaluationStack () as IntValue;\r\n\t\tlet numElementsIntVal = asOrNull(this.state.PopEvaluationStack(), IntValue);\r\n\t\tif (!(numElementsIntVal instanceof IntValue)) {\r\n\t\t\tthis.Error('expected number of elements in sequence for shuffle index');\r\n\t\t\treturn 0;\r\n\t\t}\r\n\r\n\t\tlet seqContainer = this.state.currentPointer.container;\r\n\t\tif (seqContainer === null) { return throwNullException('seqContainer'); }\r\n\r\n\t\t// Originally a primitive type, but here, can be null.\r\n\t\t// TODO: Replace by default value?\r\n\t\tif (numElementsIntVal.value === null) { return throwNullException('numElementsIntVal.value'); }\r\n\t\tlet numElements = numElementsIntVal.value;\r\n\r\n\t\t// var seqCountVal = state.PopEvaluationStack () as IntValue;\r\n\t\tlet seqCountVal = asOrThrows(this.state.PopEvaluationStack(), IntValue);\r\n\t\tlet seqCount = seqCountVal.value;\r\n\r\n\t\t// Originally a primitive type, but here, can be null.\r\n\t\t// TODO: Replace by default value?\r\n\t\tif (seqCount === null) { return throwNullException('seqCount'); }\r\n\r\n\t\tlet loopIndex = seqCount / numElements;\r\n\t\tlet iterationIndex = seqCount % numElements;\r\n\r\n\t\tlet seqPathStr = seqContainer.path.toString();\r\n\t\tlet sequenceHash = 0;\r\n\t\tfor (let i = 0, l = seqPathStr.length; i < l; i++){\r\n\t\t\tsequenceHash += seqPathStr.charCodeAt(i) || 0;\r\n\t\t}\r\n\t\tlet randomSeed = sequenceHash + loopIndex + this.state.storySeed;\r\n\t\tlet random = new PRNG(Math.floor(randomSeed));\r\n\r\n\t\tlet unpickedIndices = [];\r\n\t\tfor (let i = 0; i < numElements; ++i) {\r\n\t\t\tunpickedIndices.push(i);\r\n\t\t}\r\n\r\n\t\tfor (let i = 0; i <= iterationIndex; ++i) {\r\n\t\t\tlet chosen = random.next() % unpickedIndices.length;\r\n\t\t\tlet chosenIndex = unpickedIndices[chosen];\r\n\t\t\tunpickedIndices.splice(chosen, 1);\r\n\r\n\t\t\tif (i == iterationIndex) {\r\n\t\t\t\treturn chosenIndex;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthrow new Error('Should never reach here');\r\n\t}\r\n\r\n\tpublic Error(message: string, useEndLineNumber = false): never{\r\n\t\tlet e = new StoryException(message);\r\n\t\te.useEndLineNumber = useEndLineNumber;\r\n\t\tthrow e;\r\n\t}\r\n\r\n\tpublic Warning(message: string){\r\n\t\tthis.AddError(message, true);\r\n\t}\r\n\r\n\tpublic AddError(message: string, isWarning = false, useEndLineNumber = false){\r\n\t\tlet dm = this.currentDebugMetadata;\r\n\r\n\t\tlet errorTypeStr = isWarning ? 'WARNING' : 'ERROR';\r\n\r\n\t\tif (dm != null) {\r\n\t\t\tlet lineNum = useEndLineNumber ? dm.endLineNumber : dm.startLineNumber;\r\n\t\t\tmessage = 'RUNTIME ' + errorTypeStr + \": '\" + dm.fileName + \"' line \" + lineNum + ': ' + message;\r\n\t\t}\r\n\t\telse if(!this.state.currentPointer.isNull) {\r\n\t\t\tmessage = 'RUNTIME ' + errorTypeStr + ': (' + this.state.currentPointer + '): ' + message;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tmessage = 'RUNTIME ' + errorTypeStr + ': ' + message;\r\n\t\t}\r\n\r\n\t\tthis.state.AddError(message, isWarning);\r\n\r\n\t\t// In a broken state don't need to know about any other errors.\r\n\t\tif (!isWarning)\r\n\t\t\tthis.state.ForceEnd();\r\n\t}\r\n\r\n\tpublic Assert(condition: boolean, message: string | null = null) {\r\n\t\tif (condition == false) {\r\n\t\t\tif (message == null) {\r\n\t\t\t\tmessage = 'Story assert';\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(message + ' ' + this.currentDebugMetadata);\r\n\t\t}\r\n\t}\r\n\r\n\tget currentDebugMetadata(): DebugMetadata | null {\r\n\t\tlet dm: DebugMetadata | null;\r\n\r\n\t\tlet pointer = this.state.currentPointer;\r\n\t\tif (!pointer.isNull && pointer.Resolve() !== null) {\r\n\t\t\tdm = pointer.Resolve()!.debugMetadata;\r\n\t\t\tif (dm !== null) {\r\n\t\t\t\treturn dm;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (let i = this.state.callStack.elements.length - 1; i >= 0; --i) {\r\n\t\t\tpointer = this.state.callStack.elements [i].currentPointer;\r\n\t\t\tif (!pointer.isNull && pointer.Resolve() !== null) {\r\n\t\t\t\tdm = pointer.Resolve()!.debugMetadata;\r\n\t\t\t\tif (dm !== null) {\r\n\t\t\t\t\treturn dm;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (let i = this.state.outputStream.length - 1; i >= 0; --i) {\r\n\t\t\tlet outputObj = this.state.outputStream [i];\r\n\t\t\tdm = outputObj.debugMetadata;\r\n\t\t\tif (dm !== null) {\r\n\t\t\t\treturn dm;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\tget mainContentContainer(){\r\n\t\tif (this._temporaryEvaluationContainer) {\r\n\t\t\treturn this._temporaryEvaluationContainer;\r\n\t\t} else {\r\n\t\t\treturn this._mainContentContainer;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * `_mainContentContainer` is almost guaranteed to be set in the\r\n\t * constructor, unless the json is malformed.\r\n\t */\r\n\tprivate _mainContentContainer!: Container;\r\n\tprivate _listDefinitions: ListDefinitionsOrigin | null = null;\r\n\r\n\tprivate _externals: Map<string, Story.ExternalFunction>;\r\n\tprivate _variableObservers: Map<string, Story.VariableObserver[]> | null = null;\r\n\tprivate _hasValidatedExternals: boolean = false;\r\n\r\n\tprivate _temporaryEvaluationContainer: Container | null = null;\r\n\r\n\t/**\r\n\t * `state` is almost guaranteed to be set in the constructor, unless\r\n\t * using the compiler-specific constructor which will likely not be used in\r\n\t * the real world.\r\n\t */\r\n\tprivate _state!: StoryState;\r\n\r\n\tprivate _asyncContinueActive: boolean = false;\r\n\tprivate _stateAtLastNewline: StoryState | null = null;\r\n\r\n\tprivate _recursiveContinueCount: number = 0;\r\n\r\n\tprivate _profiler: any | null = null; // TODO: Profiler\r\n}\r\n\r\nexport namespace Story{\r\n\texport enum OutputStateChange {\r\n\t\tNoChange = 0,\r\n\t\tExtendedBeyondNewline = 1,\r\n\t\tNewlineRemoved = 2,\r\n\t}\r\n\r\n\texport interface EvaluateFunctionTextOutput {\r\n\t\treturned: any;\r\n\t\toutput: string;\r\n\t}\r\n\r\n\texport type VariableObserver = (variableName: string, newValue: any) => void;\r\n\texport type ExternalFunction = (...args: any) => any;\r\n}\r\n","import {PushPopType} from './PushPop';\r\nimport {Path} from './Path';\r\nimport {Story} from './Story';\r\nimport {StoryException} from './StoryException';\r\nimport {JsonSerialisation} from './JsonSerialisation';\r\nimport {ListValue} from './Value';\r\nimport {StringBuilder} from './StringBuilder';\r\nimport {Pointer} from './Pointer';\r\nimport {InkObject} from './Object';\r\nimport {Container} from './Container';\r\nimport {Debug} from './Debug';\r\nimport {tryGetValueFromMap} from './TryGetResult';\r\nimport {throwNullException} from './NullException';\r\n\r\nexport class CallStack{\r\n\tget elements(){\r\n\t\treturn this.callStack;\r\n\t}\r\n\r\n\tget depth(){\r\n\t\treturn this.elements.length;\r\n\t}\r\n\r\n\tget currentElement(){\r\n\t\tlet thread = this._threads[this._threads.length - 1];\r\n\t\tlet cs = thread.callstack;\r\n\t\treturn cs[cs.length - 1];\r\n\t}\r\n\r\n\tget currentElementIndex(){\r\n\t\treturn this.callStack.length - 1;\r\n\t}\r\n\r\n\tget currentThread(): CallStack.Thread {\r\n\t\treturn this._threads[this._threads.length - 1];\r\n\t}\r\n\tset currentThread(value: CallStack.Thread){\r\n\t\tDebug.Assert(this._threads.length == 1, \"Shouldn't be directly setting the current thread when we have a stack of them\");\r\n\r\n\t\tthis._threads.length = 0;\r\n\t\tthis._threads.push(value);\r\n\t}\r\n\r\n\tget canPop(){\r\n\t\treturn this.callStack.length > 1;\r\n\t}\r\n\r\n\tconstructor(storyContext: Story)\r\n\tconstructor(toCopy: CallStack)\r\n\tconstructor(){\r\n\t\tif (arguments[0] instanceof Story) {\r\n\t\t\tlet storyContext = arguments[0] as Story;\r\n\r\n\t\t\tthis._startOfRoot = Pointer.StartOf(storyContext.rootContentContainer);\r\n\t\t\tthis.Reset();\r\n\t\t} else {\r\n\t\t\tlet toCopy = arguments[0] as CallStack;\r\n\r\n\t\t\tthis._threads = [];\r\n\t\t\tfor (let otherThread of toCopy._threads) {\r\n\t\t\t\tthis._threads.push(otherThread.Copy());\r\n\t\t\t}\r\n\t\t\tthis._startOfRoot = toCopy._startOfRoot;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic Reset() {\r\n\t\tthis._threads = [];\r\n\t\tthis._threads.push(new CallStack.Thread());\r\n\r\n\t\tthis._threads[0].callstack.push(new CallStack.Element(PushPopType.Tunnel, this._startOfRoot));\r\n\t}\r\n\r\n\tpublic SetJsonToken(jObject: any, storyContext: Story){\r\n\t\tthis._threads.length = 0;\r\n\r\n\t\t// TODO: (List<object>) jObject [\"threads\"];\r\n\t\tlet jThreads: any[] = jObject['threads'];\r\n\r\n\t\tfor (let jThreadTok of jThreads) {\r\n\t\t\t// TODO: var jThreadObj = (Dictionary<string, object>)jThreadTok;\r\n\t\t\tlet jThreadObj = jThreadTok;\r\n\t\t\tlet thread = new CallStack.Thread(jThreadObj, storyContext);\r\n\t\t\tthis._threads.push(thread);\r\n\t\t}\r\n\r\n\t\t// TODO: (int)jObject [\"threadCounter\"];\r\n\t\tthis._threadCounter = parseInt(jObject['threadCounter']);\r\n\t\tthis._startOfRoot = Pointer.StartOf(storyContext.rootContentContainer);\r\n\t}\r\n\tpublic GetJsonToken(){\r\n\t\tlet jObject: any = {};\r\n\r\n\t\tlet jThreads: any[] = [];\r\n\r\n\t\tfor (let thread of this._threads) {\r\n\t\t\tjThreads.push(thread.jsonToken);\r\n\t\t}\r\n\r\n\t\tjObject['threads'] = jThreads;\r\n\t\tjObject['threadCounter'] = this._threadCounter;\r\n\r\n\t\treturn jObject;\r\n\t}\r\n\r\n\tpublic PushThread(){\r\n\t\tlet newThread = this.currentThread.Copy();\r\n\t\tthis._threadCounter++;\r\n\t\tnewThread.threadIndex = this._threadCounter;\r\n\t\tthis._threads.push(newThread);\r\n\t}\r\n\r\n\tpublic ForkThread(){\r\n\t\tlet forkedThread = this.currentThread.Copy();\r\n\t\tthis._threadCounter++;\r\n\t\tforkedThread.threadIndex = this._threadCounter;\r\n\t\treturn forkedThread;\r\n\t}\r\n\r\n\tpublic PopThread(){\r\n\t\tif (this.canPopThread) {\r\n\t\t\tthis._threads.splice(this._threads.indexOf(this.currentThread), 1);// should be equivalent to a pop()\r\n\t\t} else {\r\n\t\t\tthrow new Error(\"Can't pop thread\");\r\n\t\t}\r\n\t}\r\n\r\n\tget canPopThread(){\r\n\t\treturn this._threads.length > 1 && !this.elementIsEvaluateFromGame;\r\n\t}\r\n\r\n\tget elementIsEvaluateFromGame(){\r\n\t\treturn this.currentElement.type == PushPopType.FunctionEvaluationFromGame;\r\n\t}\r\n\r\n\tpublic Push(type: PushPopType, externalEvaluationStackHeight: number = 0, outputStreamLengthWithPushed: number = 0){\r\n\t\tlet element = new CallStack.Element(\r\n\t\t\ttype,\r\n\t\t\tthis.currentElement.currentPointer,\r\n\t\t\tfalse,\r\n\t\t);\r\n\r\n\t\telement.evaluationStackHeightWhenPushed = externalEvaluationStackHeight;\r\n\t\telement.functionStartInOutputStream = outputStreamLengthWithPushed;\r\n\r\n\t\tthis.callStack.push (element);\r\n\t}\r\n\r\n\tpublic CanPop(type: PushPopType | null = null){\r\n\t\tif (!this.canPop)\r\n\t\t\treturn false;\r\n\r\n\t\tif (type == null)\r\n\t\t\treturn true;\r\n\r\n\t\treturn this.currentElement.type == type;\r\n\t}\r\n\r\n\tpublic Pop(type: PushPopType | null = null){\r\n\t\tif (this.CanPop(type)) {\r\n\t\t\tthis.callStack.pop();\r\n\t\t\treturn;\r\n\t\t} else {\r\n\t\t\tthrow new Error('Mismatched push/pop in Callstack');\r\n\t\t}\r\n\t}\r\n\r\n\tpublic GetTemporaryVariableWithName(name: string | null, contextIndex: number = -1){\r\n\r\n\t\tif (contextIndex == -1)\r\n\t\t\tcontextIndex = this.currentElementIndex + 1;\r\n\r\n\t\tlet contextElement = this.callStack[contextIndex - 1];\r\n\r\n\t\tlet varValue = tryGetValueFromMap(contextElement.temporaryVariables, name, null);\r\n\t\tif (varValue.exists) {\r\n\t\t\treturn varValue.result;\r\n\t\t} else {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic SetTemporaryVariable(name: string, value: any, declareNew: boolean, contextIndex: number = -1){\r\n\r\n\t\tif (contextIndex == -1)\r\n\t\t\tcontextIndex = this.currentElementIndex + 1;\r\n\r\n\t\tlet contextElement = this.callStack[contextIndex - 1];\r\n\r\n\t\tif (!declareNew && !contextElement.temporaryVariables.get(name)) {\r\n\t\t\tthrow new StoryException('Could not find temporary variable to set: ' + name);\r\n\t\t}\r\n\r\n\t\tlet oldValue = tryGetValueFromMap(contextElement.temporaryVariables, name, null);\r\n\t\tif (oldValue.exists)\r\n\t\t\tListValue.RetainListOriginsForAssignment(oldValue.result, value);\r\n\r\n\t\tcontextElement.temporaryVariables.set(name, value);\r\n\t}\r\n\r\n\tpublic ContextForVariableNamed(name: string){\r\n\r\n\t\tif (this.currentElement.temporaryVariables.get(name)) {\r\n\t\t\treturn this.currentElementIndex + 1;\r\n\t\t}\r\n\r\n\t\telse {\r\n\t\t\treturn 0;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic ThreadWithIndex(index: number){\r\n\t\tlet filtered = this._threads.filter((t) => {\r\n\t\t\tif (t.threadIndex == index) return t;\r\n\t\t});\r\n\r\n\t\treturn filtered[0];\r\n\t}\r\n\r\n\tget callStack(){\r\n\t\treturn this.currentThread.callstack;\r\n\t}\r\n\r\n\tget callStackTrace(){\r\n\t\tlet sb = new StringBuilder();\r\n\r\n\t\tfor (let t = 0; t < this._threads.length; t++) {\r\n\t\t\tlet thread = this._threads[t];\r\n\t\t\tlet isCurrent = (t == this._threads.length - 1);\r\n\t\t\tsb.AppendFormat('=== THREAD {0}/{1} {2}===\\n', (t+1), this._threads.length, (isCurrent ? '(current) ' : ''));\r\n\r\n\t\t\tfor (let i = 0; i < thread.callstack.length; i++) {\r\n\r\n\t\t\t\tif (thread.callstack[i].type == PushPopType.Function)\r\n\t\t\t\t\tsb.Append('  [FUNCTION] ');\r\n\t\t\t\telse\r\n\t\t\t\t\tsb.Append('  [TUNNEL] ');\r\n\r\n\t\t\t\tlet pointer = thread.callstack[i].currentPointer;\r\n\t\t\t\tif(!pointer.isNull) {\r\n\t\t\t\t\tsb.Append('<SOMEWHERE IN ');\r\n\t\t\t\t\tif (pointer.container === null) { return throwNullException('pointer.container'); }\r\n\t\t\t\t\tsb.Append(pointer.container.path.toString());\r\n\t\t\t\t\tsb.AppendLine('>');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn sb.toString();\r\n\t}\r\n\r\n\tpublic _threads!: CallStack.Thread[]; // Banged because it's initialized in Reset().\r\n\tpublic _threadCounter: number = 0;\r\n\tpublic _startOfRoot: Pointer = Pointer.Null;\r\n}\r\n\r\nexport namespace CallStack {\r\n\texport class Element{\r\n\t\tpublic currentPointer: Pointer;\r\n\t\tpublic inExpressionEvaluation: boolean;\r\n\t\tpublic temporaryVariables: Map<string, InkObject>;\r\n\t\tpublic type: PushPopType;\r\n\r\n\t\tpublic evaluationStackHeightWhenPushed: number = 0;\r\n\t\tpublic functionStartInOutputStream: number = 0;\r\n\r\n\t\tconstructor(type: PushPopType, pointer: Pointer, inExpressionEvaluation: boolean = false){\r\n\t\t\tthis.currentPointer = pointer.copy();\r\n\t\t\tthis.inExpressionEvaluation = inExpressionEvaluation;\r\n\t\t\tthis.temporaryVariables = new Map();\r\n\t\t\tthis.type = type;\r\n\t\t}\r\n\r\n\t\tpublic Copy(){\r\n\t\t\tlet copy = new Element(this.type, this.currentPointer, this.inExpressionEvaluation);\r\n\t\t\tcopy.temporaryVariables = new Map(this.temporaryVariables);\r\n\t\t\tcopy.evaluationStackHeightWhenPushed = this.evaluationStackHeightWhenPushed;\r\n\t\t\tcopy.functionStartInOutputStream = this.functionStartInOutputStream;\r\n\t\t\treturn copy;\r\n\t\t}\r\n\t}\r\n\r\n\texport class Thread{\r\n\t\tpublic callstack: Element[];\r\n\t\tpublic threadIndex: number = 0;\r\n\t\tpublic previousPointer: Pointer = Pointer.Null;\r\n\r\n\t\tconstructor();\r\n\t\tconstructor(jThreadObj: any, storyContext: Story);\r\n\t\tconstructor(){\r\n\t\t\tthis.callstack = [];\r\n\r\n\t\t\tif (arguments[0] && arguments[1]){\r\n\t\t\t\tlet jThreadObj = arguments[0];\r\n\t\t\t\tlet storyContext = arguments[1];\r\n\r\n\t\t\t\t// TODO: (int) jThreadObj['threadIndex'] can raise;\r\n\t\t\t\tthis.threadIndex = parseInt(jThreadObj['threadIndex']);\r\n\r\n\t\t\t\tlet jThreadCallstack = jThreadObj['callstack'];\r\n\r\n\t\t\t\tfor (let jElTok of jThreadCallstack) {\r\n\t\t\t\t\tlet jElementObj = jElTok;\r\n\r\n\t\t\t\t\t// TODO: (int) jElementObj['type'] can raise;\r\n\t\t\t\t\tlet pushPopType: PushPopType = parseInt(jElementObj['type']);\r\n\r\n\t\t\t\t\tlet pointer = Pointer.Null;\r\n\r\n\t\t\t\t\tlet currentContainerPathStr: string;\r\n\t\t\t\t\t// TODO: jElementObj.TryGetValue (\"cPath\", out currentContainerPathStrToken);\r\n\t\t\t\t\tlet currentContainerPathStrToken = jElementObj['cPath'];\r\n\t\t\t\t\tif (typeof currentContainerPathStrToken !== 'undefined') {\r\n\t\t\t\t\t\tcurrentContainerPathStr = currentContainerPathStrToken.toString();\r\n\r\n\t\t\t\t\t\tlet threadPointerResult = storyContext.ContentAtPath(new Path(currentContainerPathStr));\r\n\t\t\t\t\t\tpointer.container = threadPointerResult.container;\r\n\t\t\t\t\t\tpointer.index = parseInt(jElementObj['idx']);\r\n\r\n\t\t\t\t\t\tif (threadPointerResult.obj == null)\r\n\t\t\t\t\t\t\tthrow new Error('When loading state, internal story location couldn\\'t be found: ' + currentContainerPathStr + '. Has the story changed since this save data was created?');\r\n\t\t\t\t\t\telse if (threadPointerResult.approximate) {\r\n\t\t\t\t\t\t\tif (pointer.container === null) { return throwNullException('pointer.container'); }\r\n\t\t\t\t\t\t\tstoryContext.Warning(\"When loading state, exact internal story location couldn't be found: '\" + currentContainerPathStr + \"', so it was approximated to '\"+pointer.container.path.toString()+\"' to recover. Has the story changed since this save data was created?\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tlet inExpressionEvaluation = !!jElementObj['exp'];\r\n\r\n\t\t\t\t\tlet el = new Element(pushPopType, pointer, inExpressionEvaluation);\r\n\r\n\t\t\t\t\tlet jObjTemps = jElementObj['temp'];\r\n\t\t\t\t\tel.temporaryVariables = JsonSerialisation.JObjectToDictionaryRuntimeObjs(jObjTemps);\r\n\r\n\t\t\t\t\tthis.callstack.push(el);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet prevContentObjPath = jThreadObj['previousContentObject'];\r\n\t\t\t\tif(typeof prevContentObjPath !== 'undefined') {\r\n\t\t\t\t\tlet prevPath = new Path(prevContentObjPath.toString());\r\n\t\t\t\t\tthis.previousPointer = storyContext.PointerAtPath(prevPath);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tpublic Copy(){\r\n\t\t\tlet copy = new Thread();\r\n\t\t\tcopy.threadIndex = this.threadIndex;\r\n\t\t\tfor (let e of this.callstack) {\r\n\t\t\t\tcopy.callstack.push(e.Copy());\r\n\t\t\t}\r\n\t\t\tcopy.previousPointer = this.previousPointer.copy();\r\n\t\t\treturn copy;\r\n\t\t}\r\n\r\n\t\tget jsonToken(){\r\n\t\t\tlet threadJObj: any = {};\r\n\r\n\t\t\tlet jThreadCallstack: any[] = [];\r\n\t\t\tfor (let el of this.callstack) {\r\n\t\t\t\tlet jObj: any = {};\r\n\t\t\t\tif (!el.currentPointer.isNull) {\r\n\t\t\t\t\tif (el.currentPointer.container === null) { return throwNullException('el.currentPointer.container'); }\r\n\t\t\t\t\tjObj['cPath'] = el.currentPointer.container.path.componentsString;\r\n\t\t\t\t\tjObj['idx'] = el.currentPointer.index;\r\n\t\t\t\t}\r\n\t\t\t\tjObj['exp'] = el.inExpressionEvaluation;\r\n\t\t\t\tjObj['type'] = el.type;\r\n\t\t\t\tjObj['temp'] = JsonSerialisation.DictionaryRuntimeObjsToJObject(el.temporaryVariables);\r\n\t\t\t\tjThreadCallstack.push(jObj);\r\n\t\t\t}\r\n\r\n\t\t\tthreadJObj['callstack'] = jThreadCallstack;\r\n\t\t\tthreadJObj['threadIndex'] = this.threadIndex;\r\n\r\n\t\t\tif (!this.previousPointer.isNull) {\r\n\t\t\t\tlet resolvedPointer = this.previousPointer.Resolve();\r\n\t\t\t\tif (resolvedPointer === null) { return throwNullException('this.previousPointer.Resolve()'); }\r\n\t\t\t\tthreadJObj['previousContentObject'] = resolvedPointer.path.toString();\r\n\t\t\t}\r\n\r\n\t\t\treturn threadJObj;\r\n\t\t}\r\n\t}\r\n}\r\n","import {AbstractValue, Value, VariablePointerValue, ListValue} from './Value';\r\nimport {VariableAssignment} from './VariableAssignment';\r\nimport {InkObject} from './Object';\r\nimport {ListDefinitionsOrigin} from './ListDefinitionsOrigin';\r\nimport {StoryException} from './StoryException';\r\nimport {JsonSerialisation} from './JsonSerialisation';\r\nimport {asOrThrows, asOrNull} from './TypeAssertion';\r\nimport {tryGetValueFromMap} from './TryGetResult';\r\nimport {throwNullException} from './NullException';\r\nimport {CallStack} from './CallStack';\r\n\r\nexport class VariablesState{\r\n\t// The way variableChangedEvent is a bit different than the reference implementation.\r\n\t// Originally it uses the C# += operator to add delegates, but in js we need to maintain\r\n\t// an actual collection of delegates (ie. callbacks) to register a new one, there is a\r\n\t// special ObserveVariableChange method below.\r\n\tpublic variableChangedEventCallbacks: Array<(variableName: string, newValue: InkObject) => void> = [];\r\n\tpublic variableChangedEvent(variableName: string, newValue: InkObject): void {\r\n\t\tfor (let callback of this.variableChangedEventCallbacks) {\r\n\t\t\tcallback(variableName, newValue);\r\n\t\t}\r\n\t}\r\n\r\n\tget batchObservingVariableChanges(){\r\n\t\treturn this._batchObservingVariableChanges;\r\n\t}\r\n\tset batchObservingVariableChanges(value: boolean){\r\n\t\tthis._batchObservingVariableChanges = value;\r\n\t\tif (value) {\r\n\t\t\tthis._changedVariables = new Set();\r\n\t\t}\r\n\r\n\t\telse {\r\n\t\t\tif (this._changedVariables != null) {\r\n\t\t\t\tfor (let variableName of this._changedVariables) {\r\n\t\t\t\t\tlet currentValue = this._globalVariables.get(variableName);\r\n\t\t\t\t\tif (!currentValue) {\r\n\t\t\t\t\t\tthrowNullException('currentValue');\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.variableChangedEvent(variableName, currentValue);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget callStack(){\r\n\t\treturn this._callStack;\r\n\t}\r\n\tset callStack(callStack){\r\n\t\tthis._callStack = callStack;\r\n\t}\r\n\r\n\tprivate _batchObservingVariableChanges: boolean = false;\r\n\r\n\t// the original code uses a magic getter and setter for global variables,\r\n\t// allowing things like variableState['varname]. This is not quite possible\r\n\t// in js without a Proxy, so it is replaced with this $ function.\r\n\tpublic $(variableName: string, value: InkObject){\r\n\t\tif (typeof value === 'undefined'){\r\n\t\t\tlet varContents = this._globalVariables.get(variableName);\r\n\r\n\t\t\tif ( typeof varContents === 'undefined' ) {\r\n\t\t\t\tvarContents = this._defaultGlobalVariables.get(variableName);\r\n\t\t\t}\r\n\r\n\t\t\tif ( typeof varContents !== 'undefined' )\r\n\t\t\t\treturn (varContents as AbstractValue).valueObject;\r\n\t\t\telse\r\n\t\t\t\treturn null;\r\n\t\t}\r\n\t\telse{\r\n\t\t\tif (typeof this._defaultGlobalVariables.get(variableName) === 'undefined')\r\n\t\t\t\tthrow new StoryException('Cannot assign to a variable ('+variableName+\") that hasn't been declared in the story\");\r\n\r\n\t\t\tlet val = Value.Create(value);\r\n\t\t\tif (val == null) {\r\n\t\t\t\tif (value == null) {\r\n\t\t\t\t\tthrow new StoryException('Cannot pass null to VariableState');\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new StoryException('Invalid value passed to VariableState: '+value.toString());\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthis.SetGlobal(variableName, val);\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(callStack: CallStack, listDefsOrigin: ListDefinitionsOrigin | null){\r\n\t\tthis._globalVariables = new Map();\r\n\t\tthis._callStack = callStack;\r\n\t\tthis._listDefsOrigin = listDefsOrigin;\r\n\r\n\t\t// if es6 proxies are available, use them.\r\n\t\ttry{\r\n\t\t\t// the proxy is used to allow direct manipulation of global variables.\r\n\t\t\t// It first tries to access the objects own property, and if none is\r\n\t\t\t// found it delegates the call to the $ method, defined below\r\n\t\t\tlet p = new Proxy(this, {\r\n\t\t\t\tget(target: any, name){\r\n\t\t\t\t\treturn (name in target) ? target[name] : target.$(name);\r\n\t\t\t\t},\r\n\t\t\t\tset(target: any, name, value){\r\n\t\t\t\t\tif (name in target) target[name] = value;\r\n\t\t\t\t\telse target.$(name, value);\r\n\t\t\t\t\treturn true; // returning a falsy value make the trap fail\r\n\t\t\t\t},\r\n\t\t\t});\r\n\r\n\t\t\treturn p;\r\n\t\t}\r\n\t\tcatch(e){\r\n\t\t\t// thr proxy object is not available in this context. we should warn the\r\n\t\t\t// dev but writting to the console feels a bit intrusive.\r\n\t\t\t// console.log(\"ES6 Proxy not available - direct manipulation of global variables can't work, use $() instead.\");\r\n\t\t}\r\n\t}\r\n\r\n\tpublic CopyFrom(toCopy: VariablesState){\r\n\t\tthis._globalVariables = new Map(toCopy._globalVariables);\r\n\t\tthis._defaultGlobalVariables = new Map(toCopy._defaultGlobalVariables);\r\n\r\n\t\tthis.variableChangedEvent = toCopy.variableChangedEvent;\r\n\t\tthis.variableChangedEventCallbacks = toCopy.variableChangedEventCallbacks; // inkjs specificity that has to be copied along the rest of the structure\r\n\r\n\t\tif (toCopy.batchObservingVariableChanges != this.batchObservingVariableChanges) {\r\n\r\n\t\t\tif (toCopy.batchObservingVariableChanges) {\r\n\t\t\t\tthis._batchObservingVariableChanges = true;\r\n\t\t\t\tif (toCopy._changedVariables === null) { return throwNullException('toCopy._changedVariables'); }\r\n\t\t\t\tthis._changedVariables = new Set(toCopy._changedVariables);\r\n\t\t\t} else {\r\n\t\t\t\tthis._batchObservingVariableChanges = false;\r\n\t\t\t\tthis._changedVariables = null;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget jsonToken(){\r\n\t\treturn JsonSerialisation.DictionaryRuntimeObjsToJObject(this._globalVariables);\r\n\t}\r\n\tset jsonToken(value){\r\n\t\tthis._globalVariables = JsonSerialisation.JObjectToDictionaryRuntimeObjs(value);\r\n\t}\r\n\r\n\tpublic TryGetDefaultVariableValue(name: string | null): InkObject | null\r\n\t{\r\n\t\tlet val = tryGetValueFromMap(this._defaultGlobalVariables, name, null);\r\n\t\treturn val.exists ? val.result : null;\r\n\t}\r\n\r\n\tpublic GlobalVariableExistsWithName(name: string){\r\n\t\treturn this._globalVariables.has(name);\r\n\t}\r\n\r\n\tpublic GetVariableWithName(name: string | null, contextIndex: number = -1): InkObject | null {\r\n\t\tlet varValue = this.GetRawVariableWithName(name, contextIndex);\r\n\r\n\t\t// var varPointer = varValue as VariablePointerValue;\r\n\t\tlet varPointer = asOrNull(varValue, VariablePointerValue);\r\n\t\tif (varPointer !== null) {\r\n\t\t\tvarValue = this.ValueAtVariablePointer(varPointer);\r\n\t\t}\r\n\r\n\t\treturn varValue;\r\n\t}\r\n\r\n\tpublic GetRawVariableWithName(name: string | null, contextIndex: number) {\r\n\t\tlet varValue: InkObject | null = null;\r\n\r\n\t\tif (contextIndex == 0 || contextIndex == -1) {\r\n\t\t\t// this is a conditional assignment\r\n\t\t\tlet variableValue = tryGetValueFromMap(this._globalVariables, name, null);\r\n\t\t\tif (variableValue.exists)\r\n\t\t\t\treturn variableValue.result;\r\n\r\n\t\t\tif (this._listDefsOrigin === null) return throwNullException('VariablesState._listDefsOrigin');\r\n\t\t\tlet listItemValue = this._listDefsOrigin.FindSingleItemListWithName(name);\r\n\t\t\tif (listItemValue)\r\n\t\t\t\treturn listItemValue;\r\n\t\t}\r\n\r\n\t\tvarValue = this._callStack.GetTemporaryVariableWithName(name, contextIndex);\r\n\r\n\t\treturn varValue;\r\n\t}\r\n\r\n\tpublic ValueAtVariablePointer(pointer: VariablePointerValue){\r\n\t\t return this.GetVariableWithName(pointer.variableName, pointer.contextIndex);\r\n\t}\r\n\r\n\tpublic Assign(varAss: VariableAssignment, value: InkObject){\r\n\t\tlet name = varAss.variableName;\r\n\t\tif (name === null) { return throwNullException('name'); }\r\n\t\tlet contextIndex = -1;\r\n\r\n\t\tlet setGlobal = false;\r\n\t\tif (varAss.isNewDeclaration) {\r\n\t\t\tsetGlobal = varAss.isGlobal;\r\n\t\t} else {\r\n\t\t\tsetGlobal = this._globalVariables.has(name);\r\n\t\t}\r\n\r\n\t\tif (varAss.isNewDeclaration) {\r\n\t\t\t// var varPointer = value as VariablePointerValue;\r\n\t\t\tlet varPointer = asOrNull(value, VariablePointerValue);\r\n\t\t\tif (varPointer !== null) {\r\n\t\t\t\tlet fullyResolvedVariablePointer = this.ResolveVariablePointer(varPointer);\r\n\t\t\t\tvalue = fullyResolvedVariablePointer;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\telse {\r\n\r\n\t\t\tlet existingPointer = null;\r\n\t\t\tdo {\r\n\t\t\t\t// existingPointer = GetRawVariableWithName (name, contextIndex) as VariablePointerValue;\r\n\t\t\t\texistingPointer = asOrNull(this.GetRawVariableWithName(name, contextIndex), VariablePointerValue);\r\n\t\t\t\tif (existingPointer != null) {\r\n\t\t\t\t\tname = existingPointer.variableName;\r\n\t\t\t\t\tcontextIndex = existingPointer.contextIndex;\r\n\t\t\t\t\tsetGlobal = (contextIndex == 0);\r\n\t\t\t\t}\r\n\t\t\t} while(existingPointer != null);\r\n\t\t}\r\n\r\n\t\tif (setGlobal) {\r\n\t\t\tthis.SetGlobal(name, value);\r\n\t\t} else {\r\n\t\t\tthis._callStack.SetTemporaryVariable(name, value, varAss.isNewDeclaration, contextIndex);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic SnapshotDefaultGlobals(){\r\n\t\tthis._defaultGlobalVariables = new Map(this._globalVariables);\r\n\t}\r\n\r\n\tpublic RetainListOriginsForAssignment(oldValue: InkObject, newValue: InkObject){\r\n\t\tlet oldList = asOrThrows(oldValue, ListValue);\r\n\t\tlet newList = asOrThrows(newValue, ListValue);\r\n\r\n\t\tif (oldList.value && newList.value && newList.value.Count == 0) {\r\n\t\t\tnewList.value.SetInitialOriginNames(oldList.value.originNames);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic SetGlobal(variableName: string | null, value: InkObject){\r\n\t\tlet oldValue = tryGetValueFromMap(this._globalVariables, variableName, null);\r\n\r\n\t\tif (oldValue.exists) {\r\n\t\t\tListValue.RetainListOriginsForAssignment(oldValue.result!, value);\r\n\t\t}\r\n\r\n\t\tif (variableName === null) { return throwNullException('variableName'); }\r\n\t\tthis._globalVariables.set(variableName, value);\r\n\r\n\t\t// TODO: Not sure !== is equivalent to !value.Equals(oldValue)\r\n\t\tif (this.variableChangedEvent != null && value !== oldValue.result) {\r\n\r\n\t\t\tif (this.batchObservingVariableChanges) {\r\n\t\t\t\tif (this._changedVariables === null) { return throwNullException('this._changedVariables'); }\r\n\t\t\t\tthis._changedVariables.add(variableName);\r\n\t\t\t} else {\r\n\t\t\t\tthis.variableChangedEvent(variableName, value);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic ResolveVariablePointer(varPointer: VariablePointerValue){\r\n\t\tlet contextIndex = varPointer.contextIndex;\r\n\r\n\t\tif( contextIndex == -1 )\r\n\t\t\tcontextIndex = this.GetContextIndexOfVariableNamed(varPointer.variableName);\r\n\r\n\t\tlet valueOfVariablePointedTo = this.GetRawVariableWithName(varPointer.variableName, contextIndex);\r\n\r\n\t\t// var doubleRedirectionPointer = valueOfVariablePointedTo as VariablePointerValue;\r\n\t\tlet doubleRedirectionPointer = asOrNull(valueOfVariablePointedTo, VariablePointerValue);\r\n\t\tif (doubleRedirectionPointer != null) {\r\n\t\t\treturn doubleRedirectionPointer;\r\n\t\t}\r\n\r\n\t\telse {\r\n\t\t\treturn new VariablePointerValue(varPointer.variableName, contextIndex);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic GetContextIndexOfVariableNamed(varName: string){\r\n\t\tif (this._globalVariables.get(varName))\r\n\t\t\treturn 0;\r\n\r\n\t\treturn this._callStack.currentElementIndex;\r\n\t}\r\n\r\n\t\t/**\r\n\t\t * This function is specific to the js version of ink. It allows to register a\r\n\t\t * callback that will be called when a variable changes. The original code uses\r\n\t\t * `state.variableChangedEvent += callback` instead.\r\n\t\t * @param {function} callback\r\n\t\t */\r\n\tpublic ObserveVariableChange(callback: (variableName: string, newValue: InkObject) => void){\r\n\t\tthis.variableChangedEventCallbacks.push(callback);\r\n\t}\r\n\r\n\tprivate _globalVariables: Map<string, InkObject>;\r\n\tprivate _defaultGlobalVariables: Map<string, InkObject> = new Map();\r\n\r\n\tprivate _callStack: CallStack;\r\n\tprivate _changedVariables: Set<string> | null = new Set();\r\n\tprivate _listDefsOrigin: ListDefinitionsOrigin | null;\r\n}\r\n","import {CallStack} from './CallStack';\r\nimport {VariablesState} from './VariablesState';\r\nimport {ValueType, Value, StringValue, ListValue} from './Value';\r\nimport {PushPopType} from './PushPop';\r\nimport {Tag} from './Tag';\r\nimport {Glue} from './Glue';\r\nimport {Path} from './Path';\r\nimport {ControlCommand} from './ControlCommand';\r\nimport {StoryException} from './StoryException';\r\nimport {StringBuilder} from './StringBuilder';\r\nimport {JsonSerialisation} from './JsonSerialisation';\r\nimport {PRNG} from './PRNG';\r\nimport {Void} from './Void';\r\nimport {Pointer} from './Pointer';\r\nimport {tryGetValueFromMap} from './TryGetResult';\r\nimport {Choice} from './Choice';\r\nimport {asOrNull, asOrThrows, nullIfUndefined} from './TypeAssertion';\r\nimport {JObject} from './JObject';\r\nimport {Debug} from './Debug';\r\nimport {Container} from './Container';\r\nimport {InkObject} from './Object';\r\nimport { throwNullException } from './NullException';\r\nimport { Story } from './Story';\r\n\r\nexport class StoryState{\r\n\r\n\tpublic readonly kInkSaveStateVersion = 8;\r\n\tpublic readonly kMinCompatibleLoadVersion = 8;\r\n\r\n\tpublic ToJson(indented: boolean = false){\r\n\t\treturn JSON.stringify(this.jsonToken, null, (indented) ? 2 : 0);\r\n\t}\r\n\tpublic toJson(indented: boolean = false){\r\n\t\treturn this.ToJson(indented);\r\n\t}\r\n\r\n\tpublic LoadJson(json: string){\r\n\t\tthis.jsonToken = JSON.parse(json);\r\n\t}\r\n\r\n\tpublic VisitCountAtPathString(pathString: string){\r\n\t\tlet visitCountOut = tryGetValueFromMap(this.visitCounts, pathString, null);\r\n\t\tif (visitCountOut.exists)\r\n\t\t\treturn visitCountOut.result;\r\n\r\n\t\treturn 0;\r\n\t}\r\n\r\n\tget callstackDepth(){\r\n\t\treturn this.callStack.depth;\r\n\t}\r\n\r\n\tget outputStream(){\r\n\t\treturn this._outputStream;\r\n\t}\r\n\r\n\tget currentChoices(){\r\n\t\t// If we can continue generating text content rather than choices,\r\n\t\t// then we reflect the choice list as being empty, since choices\r\n\t\t// should always come at the end.\r\n\t\tif ( this.canContinue ) return [];\r\n\t\treturn this._currentChoices;\r\n\t}\r\n\r\n\tget generatedChoices(){\r\n\t\treturn this._currentChoices;\r\n\t}\r\n\r\n\tget currentErrors(){\r\n\t\treturn this._currentErrors;\r\n\t}\r\n\tprivate _currentErrors: string[] | null = null;\r\n\r\n\tget currentWarnings(){\r\n\t\treturn this._currentWarnings;\r\n\t}\r\n\tprivate _currentWarnings: string[] | null = null;\r\n\r\n\tget variablesState(){\r\n\t\treturn this._variablesState;\r\n\t}\r\n\tprivate _variablesState: VariablesState;\r\n\r\n\tpublic callStack: CallStack;\r\n\r\n\tget evaluationStack(){\r\n\t\treturn this._evaluationStack;\r\n\t}\r\n\tprivate _evaluationStack: InkObject[];\r\n\r\n\tpublic divertedPointer: Pointer = Pointer.Null;\r\n\r\n\tget visitCounts(){\r\n\t\treturn this._visitCounts;\r\n\t}\r\n\tprivate _visitCounts: Map<string, number>;\r\n\r\n\tget turnIndices(){\r\n\t\treturn this._turnIndices;\r\n\t}\r\n\tprivate _turnIndices: Map<string, number>;\r\n\r\n\tget currentTurnIndex(){\r\n\t\treturn this._currentTurnIndex;\r\n\t}\r\n\tprivate _currentTurnIndex: number = 0;\r\n\r\n\tpublic storySeed: number = 0;\r\n\tpublic previousRandom: number = 0;\r\n\tpublic didSafeExit: boolean = false;\r\n\r\n\tpublic story: Story;\r\n\r\n\tget currentPathString(){\r\n\t\tlet pointer = this.currentPointer;\r\n\t\tif (pointer.isNull) {\r\n\t\t\treturn null;\r\n\t\t} else {\r\n\t\t\tif (pointer.path === null) { return throwNullException('pointer.path'); }\r\n\t\t\treturn pointer.path.toString();\r\n\t\t}\r\n\t}\r\n\r\n\tget currentPointer(){\r\n\t\treturn this.callStack.currentElement.currentPointer.copy();\r\n\t}\r\n\r\n\tset currentPointer(value){\r\n\t\tthis.callStack.currentElement.currentPointer = value.copy();\r\n\t}\r\n\r\n\tget previousPointer(){\r\n\t\treturn this.callStack.currentThread.previousPointer.copy();\r\n\t}\r\n\r\n\tset previousPointer(value){\r\n\t\tthis.callStack.currentThread.previousPointer = value.copy();\r\n\t}\r\n\r\n\tget canContinue(){\r\n\t\treturn !this.currentPointer.isNull && !this.hasError;\r\n\t}\r\n\r\n\tget hasError(){\r\n\t\treturn this.currentErrors != null && this.currentErrors.length > 0;\r\n\t}\r\n\r\n\tget hasWarning(){\r\n\t\treturn this.currentWarnings != null && this.currentWarnings.length > 0;\r\n\t}\r\n\r\n\tget currentText(){\r\n\t\tif( this._outputStreamTextDirty ) {\r\n\t\t\tlet sb = new StringBuilder();\r\n\r\n\t\t\tfor (let outputObj of this._outputStream) {\r\n\t\t\t\t// var textContent = outputObj as StringValue;\r\n\t\t\t\tlet textContent = asOrNull(outputObj, StringValue);\r\n\t\t\t\tif (textContent !== null) {\r\n\t\t\t\t\tsb.Append(textContent.value);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthis._currentText = this.CleanOutputWhitespace(sb.toString());\r\n\t\t\tthis._outputStreamTextDirty = false;\r\n\t\t}\r\n\r\n\t\treturn this._currentText;\r\n\t}\r\n\tprivate _currentText: string | null = null;\r\n\r\n\tpublic CleanOutputWhitespace(str: string){\r\n\t\tlet sb = new StringBuilder();\r\n\r\n\t\tlet currentWhitespaceStart = -1;\r\n\t\tlet startOfLine = 0;\r\n\r\n\t\tfor (let i = 0; i < str.length; i++) {\r\n\t\t\tlet c = str.charAt(i);\r\n\r\n\t\t\tlet isInlineWhitespace = (c == ' ') || (c == '\\t');\r\n\r\n\t\t\tif (isInlineWhitespace && currentWhitespaceStart == -1)\r\n\t\t\t\tcurrentWhitespaceStart = i;\r\n\r\n\t\t\tif (!isInlineWhitespace) {\r\n\t\t\t\tif (c != '\\n' && currentWhitespaceStart > 0 && currentWhitespaceStart != startOfLine) {\r\n\t\t\t\t\tsb.Append(' ');\r\n\t\t\t\t}\r\n\t\t\t\tcurrentWhitespaceStart = -1;\r\n\t\t\t}\r\n\r\n\t\t\tif (c == '\\n')\r\n\t\t\t\tstartOfLine = i + 1;\r\n\r\n\t\t\tif (!isInlineWhitespace)\r\n\t\t\t\tsb.Append(c);\r\n\t\t}\r\n\r\n\t\treturn sb.toString();\r\n\t}\r\n\r\n\tget currentTags(){\r\n\t\tif( this._outputStreamTagsDirty ) {\r\n\t\t\tthis._currentTags = [];\r\n\r\n\t\t\tfor(let outputObj of this._outputStream) {\r\n\t\t\t\t// var tag = outputObj as Tag;\r\n\t\t\t\tlet tag = asOrNull(outputObj, Tag);\r\n\t\t\t\tif (tag !== null) {\r\n\t\t\t\t\tthis._currentTags.push(tag.text);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthis._outputStreamTagsDirty = false;\r\n\t\t}\r\n\r\n\t\treturn this._currentTags;\r\n\t}\r\n\tprivate _currentTags: string[] | null = null;\r\n\r\n\tget inExpressionEvaluation(){\r\n\t\treturn this.callStack.currentElement.inExpressionEvaluation;\r\n\t}\r\n\tset inExpressionEvaluation(value){\r\n\t\tthis.callStack.currentElement.inExpressionEvaluation = value;\r\n\t}\r\n\r\n\tconstructor(story: Story){\r\n\t\tthis.story = story;\r\n\r\n\t\tthis._outputStream = [];\r\n\t\tthis.OutputStreamDirty();\r\n\r\n\t\tthis._evaluationStack = [];\r\n\r\n\t\tthis.callStack = new CallStack(story);\r\n\t\tthis._variablesState = new VariablesState(this.callStack, story.listDefinitions);\r\n\r\n\t\tthis._visitCounts = new Map();\r\n\t\tthis._turnIndices = new Map();\r\n\t\tthis._currentTurnIndex = -1;\r\n\r\n\t\tlet timeSeed = (new Date()).getTime();\r\n\t\tthis.storySeed = (new PRNG(timeSeed)).next() % 100;\r\n\t\tthis.previousRandom = 0;\r\n\r\n\t\tthis._currentChoices = [];\r\n\r\n\t\tthis.GoToStart();\r\n\t}\r\n\r\n\tpublic GoToStart(){\r\n\t\tthis.callStack.currentElement.currentPointer = Pointer.StartOf(this.story.mainContentContainer);\r\n\t}\r\n\r\n\tpublic Copy(){\r\n\t\tlet copy = new StoryState(this.story);\r\n\r\n\t\tcopy.outputStream.push.apply(copy.outputStream, this._outputStream);\r\n\t\tthis.OutputStreamDirty();\r\n\r\n\t\tcopy._currentChoices.push.apply(copy._currentChoices, this._currentChoices);\r\n\r\n\t\tif (this.hasError) {\r\n\t\t\tcopy._currentErrors = [];\r\n\t\t\tcopy._currentErrors.push.apply(copy._currentErrors, this.currentErrors || []);\r\n\t\t}\r\n\r\n\t\tif (this.hasWarning) {\r\n\t\t\tcopy._currentWarnings = [];\r\n\t\t\tcopy._currentWarnings.push.apply(copy._currentWarnings, this.currentWarnings || []);\r\n\t\t}\r\n\r\n\t\tcopy.callStack = new CallStack(this.callStack);\r\n\r\n\t\tcopy._variablesState = new VariablesState(copy.callStack, this.story.listDefinitions);\r\n\t\tcopy.variablesState.CopyFrom(this.variablesState);\r\n\r\n\t\tcopy.evaluationStack.push.apply(copy.evaluationStack, this.evaluationStack);\r\n\r\n\t\tif (!this.divertedPointer.isNull)\r\n\t\t\tcopy.divertedPointer = this.divertedPointer.copy();\r\n\r\n\t\tcopy.previousPointer = this.previousPointer.copy();\r\n\r\n\t\tcopy._visitCounts = new Map(this.visitCounts);\r\n\t\tcopy._turnIndices = new Map(this.turnIndices);\r\n\r\n\t\tcopy._currentTurnIndex = this.currentTurnIndex;\r\n\t\tcopy.storySeed = this.storySeed;\r\n\t\tcopy.previousRandom = this.previousRandom;\r\n\r\n\t\tcopy.didSafeExit = this.didSafeExit;\r\n\r\n\t\treturn copy;\r\n\t}\r\n\r\n\tget jsonToken(){\r\n\t\tlet obj: JObject = {};\r\n\r\n\t\tlet choiceThreads: JObject | undefined;\r\n\t\tfor (let c of this._currentChoices) {\r\n\t\t\tif (c.threadAtGeneration === null) { return throwNullException('c.threadAtGeneration'); }\r\n\t\t\tc.originalThreadIndex = c.threadAtGeneration.threadIndex;\r\n\r\n\t\t\tif( this.callStack.ThreadWithIndex(c.originalThreadIndex) == null ) {\r\n\t\t\t\tif( choiceThreads == null )\r\n\t\t\t\t\tchoiceThreads = new Map();\r\n\r\n\t\t\t\tchoiceThreads[c.originalThreadIndex.toString()] = c.threadAtGeneration.jsonToken;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (choiceThreads != null)\r\n\t\t\tobj['choiceThreads'] = choiceThreads;\r\n\r\n\t\tobj['callstackThreads'] = this.callStack.GetJsonToken();\r\n\t\tobj['variablesState'] = this.variablesState.jsonToken;\r\n\r\n\t\tobj['evalStack'] = JsonSerialisation.ListToJArray(this.evaluationStack);\r\n\r\n\t\tobj['outputStream'] = JsonSerialisation.ListToJArray(this._outputStream);\r\n\r\n\t\tobj['currentChoices'] = JsonSerialisation.ListToJArray(this._currentChoices);\r\n\r\n\t\tif(!this.divertedPointer.isNull) {\r\n\t\t\tif (this.divertedPointer.path === null) { return throwNullException('this.divertedPointer.path'); }\r\n\t\t\tobj['currentDivertTarget'] = this.divertedPointer.path.componentsString;\r\n\t\t}\r\n\r\n\t\tobj['visitCounts'] = JsonSerialisation.IntDictionaryToJObject(this.visitCounts);\r\n\t\tobj['turnIndices'] = JsonSerialisation.IntDictionaryToJObject(this.turnIndices);\r\n\t\tobj['turnIdx'] = this.currentTurnIndex;\r\n\t\tobj['storySeed'] = this.storySeed;\r\n\t\tobj['previousRandom'] = this.previousRandom;\r\n\r\n\t\tobj['inkSaveVersion'] = this.kInkSaveStateVersion;\r\n\r\n\t\t// Not using this right now, but could do in future.\r\n\t\tobj['inkFormatVersion'] = this.story.inkVersionCurrent;\r\n\r\n\t\treturn obj;\r\n\t}\r\n\tset jsonToken(value: JObject){\r\n\t\tlet jObject = value;\r\n\r\n\t\tlet jSaveVersion = jObject['inkSaveVersion'];\r\n\t\tif (jSaveVersion == null) {\r\n\t\t\tthrow new StoryException(\"ink save format incorrect, can't load.\");\r\n\t\t}\r\n\t\telse if (parseInt(jSaveVersion) < this.kMinCompatibleLoadVersion) {\r\n\t\t\tthrow new StoryException(\"Ink save format isn't compatible with the current version (saw '\"+jSaveVersion+\"', but minimum is \"+this.kMinCompatibleLoadVersion+\"), so can't load.\");\r\n\t\t}\r\n\r\n\t\tthis.callStack.SetJsonToken(jObject['callstackThreads'], this.story);\r\n\t\tthis.variablesState.jsonToken = jObject['variablesState'];\r\n\r\n\t\tthis._evaluationStack = JsonSerialisation.JArrayToRuntimeObjList(jObject['evalStack']);\r\n\r\n\t\tthis._outputStream = JsonSerialisation.JArrayToRuntimeObjList(jObject['outputStream']);\r\n\t\tthis.OutputStreamDirty();\r\n\r\n\t\t// currentChoices = Json.JArrayToRuntimeObjList<Choice>((JArray)jObject [\"currentChoices\"]);\r\n\t\tthis._currentChoices = JsonSerialisation.JArrayToRuntimeObjList(jObject['currentChoices']) as Choice[];\r\n\r\n\t\tlet currentDivertTargetPath = jObject['currentDivertTarget'];\r\n\t\tif (currentDivertTargetPath != null) {\r\n\t\t\tlet divertPath = new Path(currentDivertTargetPath.toString());\r\n\t\t\tthis.divertedPointer = this.story.PointerAtPath(divertPath);\r\n\t\t}\r\n\r\n\t\tthis._visitCounts = JsonSerialisation.JObjectToIntDictionary(jObject['visitCounts']) as Map<string, number>;\r\n\t\tthis._turnIndices = JsonSerialisation.JObjectToIntDictionary(jObject['turnIndices']) as Map<string, number>;\r\n\t\tthis._currentTurnIndex = parseInt(jObject['turnIdx']);\r\n\t\tthis.storySeed = parseInt(jObject['storySeed']);\r\n\t\tthis.previousRandom = parseInt(jObject['previousRandom']);\r\n\r\n\t\t// var jChoiceThreads = jObject[\"choiceThreads\"] as JObject;\r\n\t\tlet jChoiceThreads = jObject['choiceThreads'];\r\n\r\n\t\tfor(let c of this._currentChoices) {\r\n\t\t\tlet foundActiveThread = this.callStack.ThreadWithIndex(c.originalThreadIndex);\r\n\t\t\tif( foundActiveThread != null ) {\r\n\t\t\t\tc.threadAtGeneration = foundActiveThread.Copy();\r\n\t\t\t} else {\r\n\t\t\t\tlet jSavedChoiceThread = jChoiceThreads[c.originalThreadIndex.toString()];\r\n\t\t\t\tc.threadAtGeneration = new CallStack.Thread(jSavedChoiceThread, this.story);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic ResetErrors(){\r\n\t\tthis._currentErrors = null;\r\n\t\tthis._currentWarnings = null;\r\n\t}\r\n\tpublic ResetOutput(objs: InkObject[] | null = null){\r\n\t\tthis._outputStream.length = 0;\r\n\t\tif (objs !== null) this._outputStream.push.apply(this._outputStream, objs);\r\n\t\tthis.OutputStreamDirty();\r\n\t}\r\n\r\n\tpublic PushToOutputStream(obj: InkObject | null){\r\n\t\t// var text = obj as StringValue;\r\n\t\tlet text = asOrNull(obj, StringValue);\r\n\t\tif (text !== null) {\r\n\t\t\tlet listText = this.TrySplittingHeadTailWhitespace(text);\r\n\t\t\tif (listText !== null) {\r\n\t\t\t\tfor(let textObj of listText) {\r\n\t\t\t\t\tthis.PushToOutputStreamIndividual(textObj);\r\n\t\t\t\t}\r\n\t\t\t\tthis.OutputStreamDirty();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.PushToOutputStreamIndividual(obj);\r\n\t\tthis.OutputStreamDirty();\r\n\t}\r\n\r\n\tpublic PopFromOutputStream(count: number){\r\n\t\tthis.outputStream.splice(this.outputStream.length - count, count);\r\n\t\tthis.OutputStreamDirty();\r\n\t}\r\n\r\n\tpublic TrySplittingHeadTailWhitespace(single: StringValue) {\r\n\t\tlet str = single.value;\r\n\t\tif (str === null) { return throwNullException('single.value'); }\r\n\r\n\t\tlet headFirstNewlineIdx = -1;\r\n\t\tlet headLastNewlineIdx = -1;\r\n\t\tfor (let i = 0; i < str.length; ++i) {\r\n\t\t\tlet c = str[i];\r\n\t\t\tif (c == '\\n') {\r\n\t\t\t\tif (headFirstNewlineIdx == -1)\r\n\t\t\t\t\theadFirstNewlineIdx = i;\r\n\t\t\t\theadLastNewlineIdx = i;\r\n\t\t\t}\r\n\t\t\telse if (c == ' ' || c == '\\t')\r\n\t\t\t\tcontinue;\r\n\t\t\telse\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\r\n\t\tlet tailLastNewlineIdx = -1;\r\n\t\tlet tailFirstNewlineIdx = -1;\r\n\t\tfor (let i = 0; i < str.length; ++i) {\r\n\t\t\tlet c = str[i];\r\n\t\t\tif (c == '\\n') {\r\n\t\t\t\tif (tailLastNewlineIdx == -1)\r\n\t\t\t\t\ttailLastNewlineIdx = i;\r\n\t\t\t\ttailFirstNewlineIdx = i;\r\n\t\t\t}\r\n\t\t\telse if (c == ' ' || c == '\\t')\r\n\t\t\t\tcontinue;\r\n\t\t\telse\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\r\n\t\t// No splitting to be done?\r\n\t\tif (headFirstNewlineIdx == -1 && tailLastNewlineIdx == -1)\r\n\t\t\treturn null;\r\n\r\n\t\tlet listTexts: StringValue[] = [];\r\n\t\tlet innerStrStart = 0;\r\n\t\tlet innerStrEnd = str.length;\r\n\r\n\t\tif (headFirstNewlineIdx != -1) {\r\n\t\t\tif (headFirstNewlineIdx > 0) {\r\n\t\t\t\tlet leadingSpaces = new StringValue(str.substring(0, headFirstNewlineIdx));\r\n\t\t\t\tlistTexts.push(leadingSpaces);\r\n\t\t\t}\r\n\t\t\tlistTexts.push(new StringValue('\\n'));\r\n\t\t\tinnerStrStart = headLastNewlineIdx + 1;\r\n\t\t}\r\n\r\n\t\tif (tailLastNewlineIdx != -1) {\r\n\t\t\tinnerStrEnd = tailFirstNewlineIdx;\r\n\t\t}\r\n\r\n\t\tif (innerStrEnd > innerStrStart) {\r\n\t\t\tlet innerStrText = str.substring(innerStrStart, innerStrEnd - innerStrStart);\r\n\t\t\tlistTexts.push(new StringValue(innerStrText));\r\n\t\t}\r\n\r\n\t\tif (tailLastNewlineIdx != -1 && tailFirstNewlineIdx > headLastNewlineIdx) {\r\n\t\t\tlistTexts.push(new StringValue('\\n'));\r\n\t\t\tif (tailLastNewlineIdx < str.length - 1) {\r\n\t\t\t\tlet numSpaces = (str.length - tailLastNewlineIdx) - 1;\r\n\t\t\t\tlet trailingSpaces = new StringValue(str.substring(tailLastNewlineIdx + 1, numSpaces));\r\n\t\t\t\tlistTexts.push(trailingSpaces);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn listTexts;\r\n\t}\r\n\r\n\tpublic PushToOutputStreamIndividual(obj: InkObject | null){\r\n\t\tlet glue = asOrNull(obj, Glue);\r\n\t\tlet text = asOrNull(obj, StringValue);\r\n\r\n\t\tlet includeInOutput = true;\r\n\r\n\t\tif (glue) {\r\n\t\t\tthis.TrimNewlinesFromOutputStream();\r\n\t\t\tincludeInOutput = true;\r\n\t\t}\r\n\r\n\t\telse if( text ) {\r\n\r\n\t\t\tlet functionTrimIndex = -1;\r\n\t\t\tlet currEl = this.callStack.currentElement;\r\n\t\t\tif (currEl.type == PushPopType.Function) {\r\n\t\t\t\tfunctionTrimIndex = currEl.functionStartInOutputStream;\r\n\t\t\t}\r\n\r\n\t\t\tlet glueTrimIndex = -1;\r\n\t\t\tfor (let i = this._outputStream.length - 1; i >= 0; i--) {\r\n\t\t\t\tlet o = this._outputStream[i];\r\n\t\t\t\tlet c = (o instanceof ControlCommand) ? o : null;\r\n\t\t\t\tlet g = (o instanceof Glue) ? o : null;\r\n\r\n\t\t\t\tif (g != null) {\r\n\t\t\t\t\tglueTrimIndex = i;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse if (c != null && c.commandType == ControlCommand.CommandType.BeginString) {\r\n\t\t\t\t\tif (i >= functionTrimIndex) {\r\n\t\t\t\t\t\tfunctionTrimIndex = -1;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tlet trimIndex = -1;\r\n\t\t\tif (glueTrimIndex != -1 && functionTrimIndex != -1)\r\n\t\t\t\ttrimIndex = Math.min(functionTrimIndex, glueTrimIndex);\r\n\t\t\telse if (glueTrimIndex != -1)\r\n\t\t\t\ttrimIndex = glueTrimIndex;\r\n\t\t\telse\r\n\t\t\t\ttrimIndex = functionTrimIndex;\r\n\r\n\t\t\tif (trimIndex != -1) {\r\n\r\n\t\t\t\tif (text.isNewline) {\r\n\t\t\t\t\tincludeInOutput = false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse if (text.isNonWhitespace) {\r\n\r\n\t\t\t\t\tif (glueTrimIndex > -1)\r\n\t\t\t\t\t\tthis.RemoveExistingGlue();\r\n\r\n\t\t\t\t\tif (functionTrimIndex > -1) {\r\n\t\t\t\t\t\tlet callStackElements = this.callStack.elements;\r\n\t\t\t\t\t\tfor (let i = callStackElements.length - 1; i >= 0; i--) {\r\n\t\t\t\t\t\t\tlet el = callStackElements[i];\r\n\t\t\t\t\t\t\tif (el.type == PushPopType.Function) {\r\n\t\t\t\t\t\t\t\tel.functionStartInOutputStream = -1;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\telse if (text.isNewline) {\r\n\t\t\t\tif (this.outputStreamEndsInNewline || !this.outputStreamContainsContent)\r\n\t\t\t\t\tincludeInOutput = false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (includeInOutput) {\r\n\t\t\tif (obj === null) { return throwNullException('obj'); }\r\n\t\t\tthis._outputStream.push(obj);\r\n\t\t\tthis.OutputStreamDirty();\r\n\t\t}\r\n\t}\r\n\r\n\tpublic TrimNewlinesFromOutputStream(){\r\n\t\tlet removeWhitespaceFrom = -1;\r\n\r\n\t\tlet i = this._outputStream.length-1;\r\n\t\twhile (i >= 0) {\r\n\t\t\tlet obj = this._outputStream[i];\r\n\t\t\tlet cmd = asOrNull(obj, ControlCommand);\r\n\t\t\tlet txt = asOrNull(obj, StringValue);\r\n\r\n\t\t\tif (cmd != null || (txt != null && txt.isNonWhitespace)) {\r\n\t\t\t\tbreak;\r\n\t\t\t} else if (txt != null && txt.isNewline) {\r\n\t\t\t\tremoveWhitespaceFrom = i;\r\n\t\t\t}\r\n\t\t\ti--;\r\n\t\t}\r\n\r\n\t\t// Remove the whitespace\r\n\t\tif (removeWhitespaceFrom >= 0) {\r\n\t\t\ti=removeWhitespaceFrom;\r\n\t\t\twhile(i < this._outputStream.length) {\r\n\t\t\t\tlet text = asOrNull(this._outputStream[i], StringValue);\r\n\t\t\t\tif (text) {\r\n\t\t\t\t\tthis._outputStream.splice(i, 1);\r\n\t\t\t\t} else {\r\n\t\t\t\t\ti++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.OutputStreamDirty();\r\n\t}\r\n\r\n\tpublic RemoveExistingGlue(){\r\n\t\tfor (let i = this._outputStream.length - 1; i >= 0; i--) {\r\n\t\t\tlet c = this._outputStream[i];\r\n\t\t\tif (c instanceof Glue) {\r\n\t\t\t\tthis._outputStream.splice(i, 1);\r\n\t\t\t} else if( c instanceof ControlCommand ) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.OutputStreamDirty();\r\n\t}\r\n\r\n\tget outputStreamEndsInNewline(){\r\n\t\tif (this._outputStream.length > 0) {\r\n\r\n\t\t\tfor (let i = this._outputStream.length - 1; i >= 0; i--) {\r\n\t\t\t\tlet obj = this._outputStream[i];\r\n\t\t\t\tif (obj instanceof ControlCommand)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tlet text = this._outputStream[i];\r\n\t\t\t\tif (text instanceof StringValue) {\r\n\t\t\t\t\tif (text.isNewline)\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\telse if (text.isNonWhitespace)\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn false;\r\n\t}\r\n\r\n\tget outputStreamContainsContent(){\r\n\t\tfor (let i = 0; i < this._outputStream.length; i++){\r\n\t\t\tif (this._outputStream[i] instanceof StringValue)\r\n\t\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tget inStringEvaluation(){\r\n\t\tfor (let i = this._outputStream.length - 1; i >= 0; i--) {\r\n\t\t\t// var cmd = this._outputStream[i] as ControlCommand;\r\n\t\t\tlet cmd = asOrNull(this._outputStream[i], ControlCommand);\r\n\t\t\tif (cmd instanceof ControlCommand && cmd.commandType == ControlCommand.CommandType.BeginString) {\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn false;\r\n\t}\r\n\r\n\tpublic PushEvaluationStack(obj: InkObject | null){\r\n\t\t// var listValue = obj as ListValue;\r\n\t\tlet listValue = asOrNull(obj, ListValue);\r\n\t\tif (listValue) {\r\n\r\n\t\t\t// Update origin when list is has something to indicate the list origin\r\n\t\t\tlet rawList = listValue.value;\r\n\t\t\tif (rawList === null) { return throwNullException('rawList'); }\r\n\r\n\t\t\tif (rawList.originNames != null) {\r\n\t\t\t\tif (!rawList.origins) rawList.origins = [];\r\n\t\t\t\trawList.origins.length = 0;\r\n\r\n\t\t\t\tfor (let n of rawList.originNames) {\r\n\t\t\t\t\tif (this.story.listDefinitions === null) return throwNullException('StoryState.story.listDefinitions');\r\n\t\t\t\t\tlet def = this.story.listDefinitions.TryListGetDefinition(n, null);\r\n\t\t\t\t\tif (def.result === null) return throwNullException('StoryState def.result');\r\n\t\t\t\t\tif (rawList.origins.indexOf(def.result) < 0) rawList.origins.push(def.result);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (obj === null) { return throwNullException('obj'); }\r\n\t\tthis.evaluationStack.push(obj);\r\n\t}\r\n\r\n\tpublic PopEvaluationStack(): InkObject;\r\n\tpublic PopEvaluationStack(numberOfObjects: number): InkObject[];\r\n\tpublic PopEvaluationStack(numberOfObjects?: number){\r\n\t\tif (typeof numberOfObjects === 'undefined'){\r\n\t\t\tlet obj = this.evaluationStack.pop();\r\n\t\t\treturn nullIfUndefined(obj);\r\n\t\t} else {\r\n\t\t\tif(numberOfObjects > this.evaluationStack.length) {\r\n\t\t\t\tthrow new Error('trying to pop too many objects');\r\n\t\t\t}\r\n\r\n\t\t\tlet popped = this.evaluationStack.splice(this.evaluationStack.length - numberOfObjects, numberOfObjects);\r\n\t\t\treturn nullIfUndefined(popped);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic PeekEvaluationStack(){\r\n\t\t return this.evaluationStack[this.evaluationStack.length - 1];\r\n\t}\r\n\r\n\tpublic ForceEnd(){\r\n\t\tthis.callStack.Reset();\r\n\r\n\t\tthis._currentChoices.length = 0;\r\n\r\n\t\tthis.currentPointer = Pointer.Null;\r\n\t\tthis.previousPointer = Pointer.Null;\r\n\r\n\t\tthis.didSafeExit = true;\r\n\t}\r\n\r\n\tpublic TrimWhitespaceFromFunctionEnd(){\r\n\t\tDebug.Assert (this.callStack.currentElement.type == PushPopType.Function);\r\n\t\tlet functionStartPoint = this.callStack.currentElement.functionStartInOutputStream;\r\n\r\n\t\tif (functionStartPoint == -1) {\r\n\t\t\tfunctionStartPoint = 0;\r\n\t\t}\r\n\r\n\t\tfor (let i = this._outputStream.length - 1; i >= functionStartPoint; i--) {\r\n\t\t\tlet obj = this._outputStream[i];\r\n\t\t\tlet txt = asOrNull(obj, StringValue);\r\n\t\t\tlet cmd = asOrNull(obj, ControlCommand);\r\n\r\n\t\t\tif (txt == null) continue;\r\n\t\t\tif (cmd) break;\r\n\r\n\t\t\tif (txt.isNewline || txt.isInlineWhitespace) {\r\n\t\t\t\tthis._outputStream.splice(i, 1);\r\n\t\t\t\tthis.OutputStreamDirty();\r\n\t\t\t} else {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic PopCallStack(popType: PushPopType | null = null) {\r\n\t\tif (this.callStack.currentElement.type == PushPopType.Function)\r\n\t\t\tthis.TrimWhitespaceFromFunctionEnd();\r\n\r\n\t\tthis.callStack.Pop(popType);\r\n\t}\r\n\r\n\tpublic SetChosenPath(path: Path, incrementingTurnIndex: boolean){\r\n\t\t// Changing direction, assume we need to clear current set of choices\r\n\t\tthis._currentChoices.length = 0;\r\n\r\n\t\tlet newPointer = this.story.PointerAtPath(path);\r\n\t\tif (!newPointer.isNull && newPointer.index == -1)\r\n\t\t\tnewPointer.index = 0;\r\n\r\n\t\tthis.currentPointer = newPointer;\r\n\r\n\t\tif (incrementingTurnIndex)\r\n\t\t\tthis._currentTurnIndex++;\r\n\t}\r\n\r\n\tpublic StartFunctionEvaluationFromGame(funcContainer: Container, args: any[]){\r\n\t\tthis.callStack.Push(PushPopType.FunctionEvaluationFromGame, this.evaluationStack.length);\r\n\t\tthis.callStack.currentElement.currentPointer = Pointer.StartOf(funcContainer);\r\n\r\n\t\tthis.PassArgumentsToEvaluationStack(args);\r\n\t}\r\n\r\n\tpublic PassArgumentsToEvaluationStack(args: any[]){\r\n\t\t// Pass arguments onto the evaluation stack\r\n\t\tif (args != null) {\r\n\t\t\tfor (let i = 0; i < args.length; i++) {\r\n\t\t\t\tif (!(typeof args[i] === 'number' || typeof args[i] === 'string')) {\r\n\t\t\t\t\tthrow new Error('ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string');\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.PushEvaluationStack(Value.Create(args[i]));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic TryExitFunctionEvaluationFromGame(){\r\n\t\tif (this.callStack.currentElement.type == PushPopType.FunctionEvaluationFromGame) {\r\n\t\t\tthis.currentPointer = Pointer.Null;\r\n\t\t\tthis.didSafeExit = true;\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\treturn false;\r\n\t}\r\n\r\n\tpublic CompleteFunctionEvaluationFromGame(){\r\n\t\tif (this.callStack.currentElement.type != PushPopType.FunctionEvaluationFromGame) {\r\n\t\t\tthrow new StoryException('Expected external function evaluation to be complete. Stack trace: '+this.callStack.callStackTrace);\r\n\t\t}\r\n\r\n\t\tlet originalEvaluationStackHeight = this.callStack.currentElement.evaluationStackHeightWhenPushed;\r\n\r\n\t\tlet returnedObj: InkObject | null = null;\r\n\t\twhile (this.evaluationStack.length > originalEvaluationStackHeight) {\r\n\t\t\tlet poppedObj = this.PopEvaluationStack();\r\n\t\t\tif (returnedObj === null)\r\n\t\t\t\treturnedObj = poppedObj;\r\n\t\t}\r\n\r\n\t\tthis.PopCallStack(PushPopType.FunctionEvaluationFromGame);\r\n\r\n\t\tif (returnedObj) {\r\n\t\t\tif (returnedObj instanceof Void)\r\n\t\t\t\treturn null;\r\n\r\n\t\t\t// Some kind of value, if not void\r\n\t\t\t// var returnVal = returnedObj as Runtime.Value;\r\n\t\t\tlet returnVal = asOrThrows(returnedObj, Value);\r\n\r\n\t\t\t// DivertTargets get returned as the string of components\r\n\t\t\t// (rather than a Path, which isn't public)\r\n\t\t\tif (returnVal.valueType == ValueType.DivertTarget) {\r\n\t\t\t\treturn returnVal.valueObject.toString();\r\n\t\t\t}\r\n\r\n\t\t\t// Other types can just have their exact object type:\r\n\t\t\t// int, float, string. VariablePointers get returned as strings.\r\n\t\t\treturn returnVal.valueObject;\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\tpublic AddError(message: string, isWarning: boolean){\r\n\t\tif (!isWarning) {\r\n\t\t\tif (this._currentErrors == null) this._currentErrors = [];\r\n\t\t\tthis._currentErrors.push(message);\r\n\t\t} else {\r\n\t\t\tif (this._currentWarnings == null) this._currentWarnings = [];\r\n\t\t\tthis._currentWarnings.push(message);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic OutputStreamDirty(){\r\n\t\tthis._outputStreamTextDirty = true;\r\n\t\tthis._outputStreamTagsDirty = true;\r\n\t}\r\n\r\n\tprivate _outputStream: InkObject[];\r\n\tprivate _outputStreamTextDirty = true;\r\n\tprivate _outputStreamTagsDirty = true;\r\n\tprivate _currentChoices: Choice[];\r\n}\r\n","import {Container} from './Container';\r\nimport {InkObject} from './Object';\r\nimport {JsonSerialisation} from './JsonSerialisation';\r\nimport {StoryState} from './StoryState';\r\nimport {ControlCommand} from './ControlCommand';\r\nimport {PushPopType} from './PushPop';\r\nimport {ChoicePoint} from './ChoicePoint';\r\nimport {Choice} from './Choice';\r\nimport {Divert} from './Divert';\r\nimport {Value, StringValue, IntValue, DivertTargetValue, VariablePointerValue, ListValue} from './Value';\r\nimport {Path} from './Path';\r\nimport {Void} from './Void';\r\nimport {Tag} from './Tag';\r\nimport {VariableAssignment} from './VariableAssignment';\r\nimport {VariableReference} from './VariableReference';\r\nimport {NativeFunctionCall} from './NativeFunctionCall';\r\nimport {StoryException} from './StoryException';\r\nimport {PRNG} from './PRNG';\r\nimport {StringBuilder} from './StringBuilder';\r\nimport {ListDefinitionsOrigin} from './ListDefinitionsOrigin';\r\nimport {ListDefinition} from './ListDefinition';\r\nimport {Stopwatch} from './StopWatch';\r\nimport {Pointer} from './Pointer';\r\nimport {InkList, InkListItem, KeyValuePair} from './InkList';\r\nimport {JObject} from './JObject';\r\nimport {asOrNull, asOrThrows} from './TypeAssertion';\r\nimport {DebugMetadata} from './DebugMetadata';\r\nimport {throwNullException} from './NullException';\r\n\r\nexport {InkList} from './InkList';\r\n\r\n// tslint:disable no-conditional-assignment\r\n\r\nif (!Number.isInteger) {\r\n\tNumber.isInteger = function isInteger(nVal: any) {\r\n\t\treturn typeof nVal === 'number' && isFinite(nVal) && nVal > -9007199254740992 && nVal < 9007199254740992 && Math.floor(nVal) === nVal;\r\n\t};\r\n}\r\n\r\nexport class Story extends InkObject{\r\n\r\n\tpublic inkVersionCurrent = 19;\r\n\r\n\tpublic inkVersionMinimumCompatible = 18;\r\n\r\n\tget currentChoices(){\r\n\t\tlet choices: Choice[] = [];\r\n\r\n\t\tif (this._state === null) { return throwNullException('this._state'); }\r\n\t\tfor(let c of this._state.currentChoices) {\r\n\t\t\tif (!c.isInvisibleDefault) {\r\n\t\t\t\tc.index = choices.length;\r\n\t\t\t\tchoices.push(c);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn choices;\r\n\t}\r\n\r\n\tget currentText(){\r\n\t\tthis.IfAsyncWeCant(\"call currentText since it's a work in progress\");\r\n\t\treturn this.state.currentText;\r\n\t}\r\n\r\n\tget currentTags(){\r\n\t\tthis.IfAsyncWeCant(\"call currentTags since it's a work in progress\");\r\n\t\treturn this.state.currentTags;\r\n\t}\r\n\r\n\tget currentErrors(){\r\n\t\treturn this.state.currentErrors;\r\n\t}\r\n\r\n\tget currentWarnings(){\r\n\t\treturn this.state.currentWarnings;\r\n\t}\r\n\r\n\tget hasError(){\r\n\t\treturn this.state.hasError;\r\n\t}\r\n\r\n\tget hasWarning(){\r\n\t\treturn this.state.hasWarning;\r\n\t}\r\n\r\n\tget variablesState(){\r\n\t\treturn this.state.variablesState;\r\n\t}\r\n\r\n\tget listDefinitions(){\r\n\t\treturn this._listDefinitions;\r\n\t}\r\n\r\n\tget state(){\r\n\t\treturn this._state;\r\n\t}\r\n\r\n\t// TODO: Implement Profiler\r\n\tpublic StartProfiling(){ /* */ }\r\n\tpublic EndProfiling(){ /* */ }\r\n\r\n\tconstructor(contentContainer: Container, lists: ListDefinition[] | null);\r\n\tconstructor(jsonString: string);\r\n\tconstructor(json: JObject);\r\n\tconstructor(){\r\n\t\tsuper();\r\n\r\n\t\t// Discrimination between constructors\r\n\t\tlet contentContainer: Container;\r\n\t\tlet lists: ListDefinition[] | null = null;\r\n\t\tlet json: JObject | null = null;\r\n\r\n\t\tif (arguments[0] instanceof Container) {\r\n\t\t\tcontentContainer = arguments[0] as Container;\r\n\r\n\t\t\tif (typeof arguments[1] !== 'undefined') {\r\n\t\t\t\tlists = arguments[1] as ListDefinition[];\r\n\t\t\t}\r\n\r\n\t\t\t// ------ Story (Container contentContainer, List<Runtime.ListDefinition> lists = null)\r\n\t\t\tthis._mainContentContainer = contentContainer;\r\n\t\t\t// ------\r\n\t\t} else {\r\n\t\t\tif (typeof arguments[0] === 'string') {\r\n\t\t\t\tlet jsonString = arguments[0] as string;\r\n\t\t\t\tjson = JSON.parse(jsonString);\r\n\t\t\t} else {\r\n\t\t\t\tjson = arguments[0] as JObject;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// ------ Story (Container contentContainer, List<Runtime.ListDefinition> lists = null)\r\n\t\tif (lists != null)\r\n\t\t\tthis._listDefinitions = new ListDefinitionsOrigin(lists);\r\n\r\n\t\tthis._externals = new Map();\r\n\t\t// ------\r\n\r\n\t\t// ------ Story(string jsonString) : this((Container)null)\r\n\t\tif (json !== null) {\r\n\t\t\tlet rootObject: JObject = json;\r\n\r\n\t\t\tlet versionObj = rootObject['inkVersion'];\r\n\t\t\tif (versionObj == null)\r\n\t\t\t\tthrow new Error(\"ink version number not found. Are you sure it's a valid .ink.json file?\");\r\n\r\n\t\t\tlet formatFromFile = parseInt(versionObj);\r\n\t\t\tif (formatFromFile > this.inkVersionCurrent){\r\n\t\t\t\tthrow new Error('Version of ink used to build story was newer than the current version of the engine');\r\n\t\t\t}\r\n\t\t\telse if (formatFromFile < this.inkVersionMinimumCompatible){\r\n\t\t\t\tthrow new Error('Version of ink used to build story is too old to be loaded by this version of the engine');\r\n\t\t\t}\r\n\t\t\telse if (formatFromFile != this.inkVersionCurrent){\r\n\t\t\t\tconsole.warn(\"WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.\");\r\n\t\t\t}\r\n\r\n\t\t\tlet rootToken = rootObject['root'];\r\n\t\t\tif (rootToken == null)\r\n\t\t\t\tthrow new Error(\"Root node for ink not found. Are you sure it's a valid .ink.json file?\");\r\n\r\n\t\t\tlet listDefsObj;\r\n\t\t\tif (listDefsObj = rootObject['listDefs']) {\r\n\t\t\t\tthis._listDefinitions = JsonSerialisation.JTokenToListDefinitions(listDefsObj);\r\n\t\t\t}\r\n\r\n\t\t\tthis._mainContentContainer = asOrThrows(JsonSerialisation.JTokenToRuntimeObject(rootToken), Container);\r\n\r\n\t\t\tthis.ResetState();\r\n\t\t}\r\n\t\t// ------\r\n\t}\r\n\r\n\tpublic ToJsonString(){\r\n\t\tlet rootContainerJsonList = JsonSerialisation.RuntimeObjectToJToken(this._mainContentContainer);\r\n\r\n\t\tlet  rootObject: JObject = {};\r\n\t\trootObject['inkVersion'] = this.inkVersionCurrent;\r\n\t\trootObject['root'] = rootContainerJsonList;\r\n\r\n\t\tif (this._listDefinitions != null)\r\n\t\t\trootObject['listDefs'] = JsonSerialisation.ListDefinitionsToJToken(this._listDefinitions);\r\n\r\n\t\treturn JSON.stringify(rootObject);\r\n\t}\r\n\r\n\tpublic ResetState(){\r\n\t\tthis.IfAsyncWeCant('ResetState');\r\n\r\n\t\tthis._state = new StoryState(this);\r\n\t\tthis._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this));\r\n\r\n\t\tthis.ResetGlobals();\r\n\t}\r\n\r\n\tpublic ResetErrors(){\r\n\t\tif (this._state === null) { return throwNullException('this._state'); }\r\n\t\tthis._state.ResetErrors();\r\n\t}\r\n\r\n\tpublic ResetCallstack(){\r\n\t\tthis.IfAsyncWeCant('ResetCallstack');\r\n\t\tif (this._state === null) { return throwNullException('this._state'); }\r\n\t\tthis._state.ForceEnd();\r\n\t}\r\n\r\n\tpublic ResetGlobals(){\r\n\t\tif (this._mainContentContainer.namedContent.get('global decl')){\r\n\t\t\tlet originalPointer = this.state.currentPointer.copy();\r\n\r\n\t\t\tthis.ChoosePath(new Path('global decl'), false);\r\n\r\n\t\t\tthis.ContinueInternal();\r\n\r\n\t\t\tthis.state.currentPointer = originalPointer;\r\n\t\t}\r\n\r\n\t\tthis.state.variablesState.SnapshotDefaultGlobals();\r\n\t}\r\n\r\n\tpublic Continue(){\r\n\t\tthis.ContinueAsync(0);\r\n\t\treturn this.currentText;\r\n\t}\r\n\r\n\tget canContinue(){\r\n\t\treturn this.state.canContinue;\r\n\t}\r\n\r\n\tget asyncContinueComplete(){\r\n\t\treturn !this._asyncContinueActive;\r\n\t}\r\n\r\n\tpublic ContinueAsync(millisecsLimitAsync: number){\r\n\t\tif (!this._hasValidatedExternals)\r\n\t\t\tthis.ValidateExternalBindings();\r\n\r\n\t\tthis.ContinueInternal(millisecsLimitAsync);\r\n\t}\r\n\r\n\tpublic ContinueInternal(millisecsLimitAsync = 0){\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PreContinue();\r\n\r\n\t\tlet isAsyncTimeLimited = millisecsLimitAsync > 0;\r\n\t\tthis._recursiveContinueCount++;\r\n\r\n\t\tif (!this._asyncContinueActive) {\r\n\t\t\tthis._asyncContinueActive = isAsyncTimeLimited;\r\n\r\n\t\t\tif (!this.canContinue) {\r\n\t\t\t\tthrow new StoryException(\"Can't continue - should check canContinue before calling Continue\");\r\n\t\t\t}\r\n\r\n\t\t\tthis._state.didSafeExit = false;\r\n\t\t\tthis._state.ResetOutput();\r\n\r\n\t\t\tif (this._recursiveContinueCount == 1)\r\n\t\t\t\tthis._state.variablesState.batchObservingVariableChanges = true;\r\n\t\t}\r\n\r\n\t\tlet durationStopwatch = new Stopwatch();\r\n\t\tdurationStopwatch.Start();\r\n\r\n\t\tlet outputStreamEndsInNewline = false;\r\n\t\tdo {\r\n\t\t\ttry {\r\n\t\t\t\toutputStreamEndsInNewline = this.ContinueSingleStep();\r\n\t\t\t} catch (e) {\r\n\t\t\t\tif (!(e instanceof StoryException)) throw e;\r\n\r\n\t\t\t\tthis.AddError(e.message, undefined, e.useEndLineNumber);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tif (outputStreamEndsInNewline)\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tif (this._asyncContinueActive && durationStopwatch.ElapsedMilliseconds > millisecsLimitAsync) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t} while(this.canContinue);\r\n\r\n\t\tdurationStopwatch.Stop();\r\n\r\n\t\tif (outputStreamEndsInNewline || !this.canContinue) {\r\n\t\t\tif (this._stateAtLastNewline != null) {\r\n\t\t\t\tthis.RestoreStateSnapshot(this._stateAtLastNewline);\r\n\t\t\t\tthis._stateAtLastNewline = null;\r\n\t\t\t}\r\n\r\n\t\t\tif (!this.canContinue) {\r\n\t\t\t\tif (this.state.callStack.canPopThread)\r\n\t\t\t\t\tthis.AddError('Thread available to pop, threads should always be flat by the end of evaluation?');\r\n\r\n\t\t\t\tif (this.state.generatedChoices.length == 0 && !this.state.didSafeExit && this._temporaryEvaluationContainer == null) {\r\n\t\t\t\t\tif (this.state.callStack.CanPop(PushPopType.Tunnel))\r\n\t\t\t\t\t\tthis.AddError (\"unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?\");\r\n\t\t\t\t\telse if (this.state.callStack.CanPop(PushPopType.Function))\r\n\t\t\t\t\t\tthis.AddError (\"unexpectedly reached end of content. Do you need a '~ return'?\");\r\n\t\t\t\t\telse if (!this.state.callStack.canPop)\r\n\t\t\t\t\t\tthis.AddError (\"ran out of content. Do you need a '-> DONE' or '-> END'?\");\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tthis.AddError ('unexpectedly reached end of content for unknown reason. Please debug compiler!');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthis.state.didSafeExit = false;\r\n\r\n\t\t\tif (this._recursiveContinueCount == 1)\r\n\t\t\t\tthis._state.variablesState.batchObservingVariableChanges = false;\r\n\r\n\t\t\tthis._asyncContinueActive = false;\r\n\t\t}\r\n\r\n\t\tthis._recursiveContinueCount--;\r\n\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PostContinue();\r\n\t}\r\n\r\n\tpublic ContinueSingleStep(){\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PreStep();\r\n\r\n\t\tthis.Step();\r\n\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PostStep();\r\n\r\n\t\tif (!this.canContinue && !this.state.callStack.elementIsEvaluateFromGame) {\r\n\t\t\tthis.TryFollowDefaultInvisibleChoice();\r\n\t\t}\r\n\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PreSnapshot();\r\n\r\n\t\tif (!this.state.inStringEvaluation) {\r\n\r\n\t\t\tif (this._stateAtLastNewline != null) {\r\n\r\n\t\t\t\tif (this._stateAtLastNewline.currentTags === null) { return throwNullException('this._stateAtLastNewline.currentTags'); }\r\n\t\t\t\tif (this.state.currentTags === null) { return throwNullException('this.state.currentTags'); }\r\n\r\n\t\t\t\tlet change = this.CalculateNewlineOutputStateChange (\r\n\t\t\t\t\tthis._stateAtLastNewline.currentText, this.state.currentText,\r\n\t\t\t\t\tthis._stateAtLastNewline.currentTags.length, this.state.currentTags.length,\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (change == Story.OutputStateChange.ExtendedBeyondNewline) {\r\n\r\n\t\t\t\t\tthis.RestoreStateSnapshot(this._stateAtLastNewline);\r\n\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse if (change == Story.OutputStateChange.NewlineRemoved) {\r\n\t\t\t\t\tthis._stateAtLastNewline = null;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (this.state.outputStreamEndsInNewline) {\r\n\t\t\t\tif (this.canContinue) {\r\n\t\t\t\t\tif (this._stateAtLastNewline == null)\r\n\t\t\t\t\t\tthis._stateAtLastNewline = this.StateSnapshot();\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis._stateAtLastNewline = null;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.PostSnapshot();\r\n\r\n\t\treturn false;\r\n\t}\r\n\r\n\tpublic CalculateNewlineOutputStateChange(prevText: string | null, currText: string | null, prevTagCount: number, currTagCount: number){\r\n\t\tif (prevText === null) { return throwNullException('prevText'); }\r\n\t\tif (currText === null) { return throwNullException('currText'); }\r\n\r\n\t\tlet newlineStillExists = currText.length >= prevText.length && currText.charAt(prevText.length - 1) == '\\n';\r\n\t\tif (prevTagCount == currTagCount && prevText.length == currText.length && newlineStillExists)\r\n\t\t\treturn Story.OutputStateChange.NoChange;\r\n\r\n\t\tif (!newlineStillExists) {\r\n\t\t\treturn Story.OutputStateChange.NewlineRemoved;\r\n\t\t}\r\n\r\n\t\tif (currTagCount > prevTagCount)\r\n\t\t\treturn Story.OutputStateChange.ExtendedBeyondNewline;\r\n\r\n\t\tfor (let i = prevText.length; i < currText.length; i++) {\r\n\t\t\tlet c = currText.charAt(i);\r\n\t\t\tif (c != ' ' && c != '\\t') {\r\n\t\t\t\treturn Story.OutputStateChange.ExtendedBeyondNewline;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn Story.OutputStateChange.NoChange;\r\n\t}\r\n\r\n\tpublic ContinueMaximally(){\r\n\t\tthis.IfAsyncWeCant('ContinueMaximally');\r\n\r\n\t\tlet sb = new StringBuilder();\r\n\r\n\t\twhile (this.canContinue) {\r\n\t\t\tsb.Append(this.Continue());\r\n\t\t}\r\n\r\n\t\treturn sb.toString();\r\n\t}\r\n\r\n\tpublic ContentAtPath(path: Path){\r\n\t\treturn this.mainContentContainer.ContentAtPath(path);\r\n\t}\r\n\r\n\tpublic KnotContainerWithName(name: string){\r\n\t\tlet namedContainer = this.mainContentContainer.namedContent.get(name);\r\n\t\tif (namedContainer instanceof Container)\r\n\t\t\treturn namedContainer;\r\n\t\telse\r\n\t\t\treturn null;\r\n\t}\r\n\r\n\tpublic PointerAtPath(path: Path) {\r\n\t\tif (path.length == 0)\r\n\t\t\treturn Pointer.Null;\r\n\r\n\t\tlet p = new Pointer();\r\n\r\n\t\tlet pathLengthToUse = path.length;\r\n\r\n\t\tlet result = null;\r\n\t\tif (path.lastComponent === null) { return throwNullException('path.lastComponent'); }\r\n\r\n\t\tif (path.lastComponent.isIndex) {\r\n\t\t\tpathLengthToUse = path.length - 1;\r\n\t\t\tresult = this.mainContentContainer.ContentAtPath(path, undefined, pathLengthToUse);\r\n\t\t\tp.container = result.container;\r\n\t\t\tp.index = path.lastComponent.index;\r\n\t\t} else {\r\n\t\t\tresult = this.mainContentContainer.ContentAtPath(path);\r\n\t\t\tp.container = result.container;\r\n\t\t\tp.index = -1;\r\n\t\t}\r\n\r\n\t\tif (result.obj == null || result.obj == this.mainContentContainer && pathLengthToUse > 0) {\r\n\t\t\tthis.Error(\"Failed to find content at path '\" + path + \"', and no approximation of it was possible.\");\r\n\t\t} else if (result.approximate)\r\n\t\t\tthis.Warning(\"Failed to find content at path '\" + path + \"', so it was approximated to: '\"+result.obj.path+\"'.\");\r\n\r\n\t\treturn p;\r\n\t}\r\n\r\n\tpublic StateSnapshot(){\r\n\t\treturn this.state.Copy();\r\n\t}\r\n\r\n\tpublic RestoreStateSnapshot(state: StoryState){\r\n\t\tthis._state = state;\r\n\t}\r\n\r\n\tpublic Step(){\r\n\r\n\t\tlet shouldAddToStream = true;\r\n\r\n\t\tlet pointer = this.state.currentPointer.copy();\r\n\t\tif (pointer.isNull) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Container containerToEnter = pointer.Resolve () as Container;\r\n\t\tlet containerToEnter = asOrNull(pointer.Resolve(), Container);\r\n\r\n\t\twhile(containerToEnter) {\r\n\r\n\t\t\tthis.VisitContainer(containerToEnter, true);\r\n\r\n\t\t\t// No content? the most we can do is step past it\r\n\t\t\tif (containerToEnter.content.length == 0) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tpointer = Pointer.StartOf(containerToEnter);\r\n\t\t\t// containerToEnter = pointer.Resolve() as Container;\r\n\t\t\tcontainerToEnter = asOrNull(pointer.Resolve(), Container);\r\n\t\t}\r\n\r\n\t\tthis.state.currentPointer = pointer.copy();\r\n\r\n\t\tif (this._profiler != null)\r\n\t\t\tthis._profiler.Step(this.state.callStack);\r\n\r\n\t\t// Is the current content object:\r\n\t\t//  - Normal content\r\n\t\t//  - Or a logic/flow statement - if so, do it\r\n\t\t// Stop flow if we hit a stack pop when we're unable to pop (e.g. return/done statement in knot\r\n\t\t// that was diverted to rather than called as a function)\r\n\t\tlet currentContentObj = pointer.Resolve();\r\n\t\tlet isLogicOrFlowControl = this.PerformLogicAndFlowControl(currentContentObj);\r\n\r\n\t\t// Has flow been forced to end by flow control above?\r\n\t\tif (this.state.currentPointer.isNull) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (isLogicOrFlowControl) {\r\n\t\t\tshouldAddToStream = false;\r\n\t\t}\r\n\r\n\t\t// Choice with condition?\r\n\t\t// var choicePoint = currentContentObj as ChoicePoint;\r\n\t\tlet choicePoint = asOrNull(currentContentObj, ChoicePoint);\r\n\t\tif (choicePoint) {\r\n\t\t\tlet choice = this.ProcessChoice(choicePoint);\r\n\t\t\tif (choice) {\r\n\t\t\t\tthis.state.generatedChoices.push(choice);\r\n\t\t\t}\r\n\r\n\t\t\tcurrentContentObj = null;\r\n\t\t\tshouldAddToStream = false;\r\n\t\t}\r\n\r\n\t\t// If the container has no content, then it will be\r\n\t\t// the \"content\" itself, but we skip over it.\r\n\t\tif (currentContentObj instanceof Container) {\r\n\t\t\tshouldAddToStream = false;\r\n\t\t}\r\n\r\n\t\t// Content to add to evaluation stack or the output stream\r\n\t\tif (shouldAddToStream) {\r\n\r\n\t\t\t// If we're pushing a variable pointer onto the evaluation stack, ensure that it's specific\r\n\t\t\t// to our current (possibly temporary) context index. And make a copy of the pointer\r\n\t\t\t// so that we're not editing the original runtime object.\r\n\t\t\t// var varPointer = currentContentObj as VariablePointerValue;\r\n\t\t\tlet varPointer = asOrNull(currentContentObj, VariablePointerValue);\r\n\t\t\tif (varPointer && varPointer.contextIndex == -1) {\r\n\r\n\t\t\t\t// Create new object so we're not overwriting the story's own data\r\n\t\t\t\tlet contextIdx = this.state.callStack.ContextForVariableNamed(varPointer.variableName);\r\n\t\t\t\tcurrentContentObj = new VariablePointerValue(varPointer.variableName, contextIdx);\r\n\t\t\t}\r\n\r\n\t\t\t// Expression evaluation content\r\n\t\t\tif (this.state.inExpressionEvaluation) {\r\n\t\t\t\tthis.state.PushEvaluationStack(currentContentObj);\r\n\t\t\t}\r\n\t\t\t// Output stream content (i.e. not expression evaluation)\r\n\t\t\telse {\r\n\t\t\t\tthis.state.PushToOutputStream(currentContentObj);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Increment the content pointer, following diverts if necessary\r\n\t\tthis.NextContent();\r\n\r\n\t\t// Starting a thread should be done after the increment to the content pointer,\r\n\t\t// so that when returning from the thread, it returns to the content after this instruction.\r\n\t\t// var controlCmd = currentContentObj as ;\r\n\t\tlet controlCmd = asOrNull(currentContentObj, ControlCommand);\r\n\t\tif (controlCmd && controlCmd.commandType == ControlCommand.CommandType.StartThread) {\r\n\t\t\tthis.state.callStack.PushThread();\r\n\t\t}\r\n\t}\r\n\r\n\tpublic VisitContainer(container: Container, atStart: boolean){\r\n\t\tif (!container.countingAtStartOnly || atStart) {\r\n\t\t\tif (container.visitsShouldBeCounted)\r\n\t\t\t\tthis.IncrementVisitCountForContainer(container);\r\n\r\n\t\t\tif (container.turnIndexShouldBeCounted)\r\n\t\t\t\tthis.RecordTurnIndexVisitToContainer(container);\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _prevContainers: Container[] = [];\r\n\tpublic VisitChangedContainersDueToDivert(){\r\n\t\tlet previousPointer = this.state.previousPointer.copy();\r\n\t\tlet pointer = this.state.currentPointer.copy();\r\n\r\n\t\tif (pointer.isNull || pointer.index == -1)\r\n\t\t\treturn;\r\n\r\n\t\tthis._prevContainers.length = 0;\r\n\t\tif (!previousPointer.isNull) {\r\n\t\t\t// Container prevAncestor = previousPointer.Resolve() as Container ?? previousPointer.container as Container;\r\n\t\t\tlet resolvedPreviousAncestor = previousPointer.Resolve();\r\n\t\t\tlet prevAncestor = asOrNull(resolvedPreviousAncestor, Container) || asOrNull(previousPointer.container, Container);\r\n\t\t\twhile (prevAncestor) {\r\n\t\t\t\tthis._prevContainers.push(prevAncestor);\r\n\t\t\t\t// prevAncestor = prevAncestor.parent as Container;\r\n\t\t\t\tprevAncestor = asOrNull(prevAncestor.parent, Container);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet currentChildOfContainer = pointer.Resolve();\r\n\r\n\t\tif (currentChildOfContainer == null) return;\r\n\r\n\t\t// Container currentContainerAncestor = currentChildOfContainer.parent as Container;\r\n\t\tlet currentContainerAncestor = asOrNull(currentChildOfContainer.parent, Container);\r\n\t\twhile (currentContainerAncestor && (this._prevContainers.indexOf(currentContainerAncestor) < 0 || currentContainerAncestor.countingAtStartOnly)) {\r\n\r\n\t\t\t// Check whether this ancestor container is being entered at the start,\r\n\t\t\t// by checking whether the child object is the first.\r\n\t\t\tlet enteringAtStart = currentContainerAncestor.content.length > 0\r\n\t\t\t\t&& currentChildOfContainer == currentContainerAncestor.content[0];\r\n\r\n\t\t\t// Mark a visit to this container\r\n\t\t\tthis.VisitContainer(currentContainerAncestor, enteringAtStart);\r\n\r\n\t\t\tcurrentChildOfContainer = currentContainerAncestor;\r\n\t\t\t// currentContainerAncestor = currentContainerAncestor.parent as Container;\r\n\t\t\tcurrentContainerAncestor = asOrNull(currentContainerAncestor.parent, Container);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic ProcessChoice(choicePoint: ChoicePoint){\r\n\t\tlet showChoice = true;\r\n\r\n\t\t// Don't create choice if choice point doesn't pass conditional\r\n\t\tif (choicePoint.hasCondition) {\r\n\t\t\tlet conditionValue = this.state.PopEvaluationStack();\r\n\t\t\tif (!this.IsTruthy(conditionValue)) {\r\n\t\t\t\tshowChoice = false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet startText = '';\r\n\t\tlet choiceOnlyText = '';\r\n\r\n\t\tif (choicePoint.hasChoiceOnlyContent) {\r\n\t\t\t// var choiceOnlyStrVal = state.PopEvaluationStack () as StringValue;\r\n\t\t\tlet choiceOnlyStrVal = asOrThrows(this.state.PopEvaluationStack(), StringValue);\r\n\t\t\tchoiceOnlyText = choiceOnlyStrVal.value || '';\r\n\t\t}\r\n\r\n\t\tif (choicePoint.hasStartContent) {\r\n\t\t\t// var startStrVal = state.PopEvaluationStack () as StringValue;\r\n\t\t\tlet startStrVal = asOrThrows(this.state.PopEvaluationStack(), StringValue);\r\n\t\t\tstartText = startStrVal.value || '';\r\n\t\t}\r\n\r\n\t\t// Don't create choice if player has already read this content\r\n\t\tif (choicePoint.onceOnly) {\r\n\t\t\tlet visitCount = this.VisitCountForContainer(choicePoint.choiceTarget);\r\n\t\t\tif (visitCount > 0) {\r\n\t\t\t\tshowChoice = false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// We go through the full process of creating the choice above so\r\n\t\t// that we consume the content for it, since otherwise it'll\r\n\t\t// be shown on the output stream.\r\n\t\tif (!showChoice) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tlet choice = new Choice();\r\n\t\tchoice.targetPath = choicePoint.pathOnChoice;\r\n\t\tchoice.sourcePath = choicePoint.path.toString();\r\n\t\tchoice.isInvisibleDefault = choicePoint.isInvisibleDefault;\r\n\t\tchoice.threadAtGeneration = this.state.callStack.ForkThread();\r\n\r\n\t\tchoice.text = (startText + choiceOnlyText).replace(/^[ \\t]+|[ \\t]+$/g, '');\r\n\r\n\t\treturn choice;\r\n\t}\r\n\r\n\tpublic IsTruthy(obj: InkObject){\r\n\t\tlet truthy = false;\r\n\t\tif (obj instanceof Value) {\r\n\t\t\tlet val = obj;\r\n\r\n\t\t\tif (val instanceof DivertTargetValue) {\r\n\t\t\t\tlet divTarget = val;\r\n\t\t\t\tthis.Error(\"Shouldn't use a divert target (to \" + divTarget.targetPath + \") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)\");\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\r\n\t\t\treturn val.isTruthy;\r\n\t\t}\r\n\t\treturn truthy;\r\n\t}\r\n\r\n\tpublic PerformLogicAndFlowControl(contentObj: InkObject | null){\r\n\t\tif( contentObj == null ) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\t// Divert\r\n\t\tif (contentObj instanceof Divert) {\r\n\t\t\tlet currentDivert = contentObj;\r\n\r\n\t\t\tif (currentDivert.isConditional) {\r\n\t\t\t\tlet conditionValue = this.state.PopEvaluationStack();\r\n\r\n\t\t\t\t// False conditional? Cancel divert\r\n\t\t\t\tif (!this.IsTruthy(conditionValue))\r\n\t\t\t\t\treturn true;\r\n\t\t\t}\r\n\r\n\t\t\tif (currentDivert.hasVariableTarget) {\r\n\t\t\t\tlet varName = currentDivert.variableDivertName;\r\n\r\n\t\t\t\tlet varContents = this.state.variablesState.GetVariableWithName(varName);\r\n\r\n\t\t\t\tif (varContents == null) {\r\n\t\t\t\t\tthis.Error('Tried to divert using a target from a variable that could not be found (' + varName + ')');\r\n\t\t\t\t}\r\n\t\t\t\telse if (!(varContents instanceof DivertTargetValue)) {\r\n\r\n\t\t\t\t\t// var intContent = varContents as IntValue;\r\n\t\t\t\t\tlet intContent = asOrNull(varContents, IntValue);\r\n\r\n\t\t\t\t\tlet errorMessage = 'Tried to divert to a target from a variable, but the variable (' + varName + \") didn't contain a divert target, it \";\r\n\t\t\t\t\tif (intContent instanceof IntValue && intContent.value == 0) {\r\n\t\t\t\t\t\terrorMessage += 'was empty/null (the value 0).';\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\terrorMessage += \"contained '\" + varContents + \"'.\";\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tthis.Error(errorMessage);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet target = asOrThrows(varContents, DivertTargetValue);\r\n\t\t\t\tthis.state.divertedPointer = this.PointerAtPath(target.targetPath);\r\n\r\n\t\t\t} else if (currentDivert.isExternal) {\r\n\t\t\t\tthis.CallExternalFunction(currentDivert.targetPathString, currentDivert.externalArgs);\r\n\t\t\t\treturn true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.state.divertedPointer = currentDivert.targetPointer.copy();\r\n\t\t\t}\r\n\r\n\t\t\tif (currentDivert.pushesToStack) {\r\n\t\t\t\tthis.state.callStack.Push(\r\n\t\t\t\t\tcurrentDivert.stackPushType,\r\n\t\t\t\t\tundefined,\r\n\t\t\t\t\tthis.state.outputStream.length,\r\n\t\t\t\t);\r\n\t\t\t}\r\n\r\n\t\t\tif (this.state.divertedPointer.isNull && !currentDivert.isExternal) {\r\n\r\n\t\t\t\tif (currentDivert && currentDivert.debugMetadata && currentDivert.debugMetadata.sourceName != null) {\r\n\t\t\t\t\tthis.Error(\"Divert target doesn't exist: \" + currentDivert.debugMetadata.sourceName);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.Error('Divert resolution failed: ' + currentDivert);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// Start/end an expression evaluation? Or print out the result?\r\n\t\telse if( contentObj instanceof ControlCommand ) {\r\n\t\t\tlet evalCommand = contentObj;\r\n\r\n\t\t\tswitch (evalCommand.commandType) {\r\n\r\n\t\t\tcase ControlCommand.CommandType.EvalStart:\r\n\t\t\t\tthis.Assert(this.state.inExpressionEvaluation === false, 'Already in expression evaluation?');\r\n\t\t\t\tthis.state.inExpressionEvaluation = true;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.EvalEnd:\r\n\t\t\t\tthis.Assert(this.state.inExpressionEvaluation === true, 'Not in expression evaluation mode');\r\n\t\t\t\tthis.state.inExpressionEvaluation = false;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.EvalOutput:\r\n\r\n\t\t\t\t// If the expression turned out to be empty, there may not be anything on the stack\r\n\t\t\t\tif (this.state.evaluationStack.length > 0) {\r\n\r\n\t\t\t\t\tlet output = this.state.PopEvaluationStack();\r\n\r\n\t\t\t\t\t// Functions may evaluate to Void, in which case we skip output\r\n\t\t\t\t\tif (!(output instanceof Void)) {\r\n\t\t\t\t\t\t// TODO: Should we really always blanket convert to string?\r\n\t\t\t\t\t\t// It would be okay to have numbers in the output stream the\r\n\t\t\t\t\t\t// only problem is when exporting text for viewing, it skips over numbers etc.\r\n\t\t\t\t\t\tlet text = new StringValue(output.toString());\r\n\r\n\t\t\t\t\t\tthis.state.PushToOutputStream(text);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.NoOp:\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.Duplicate:\r\n\t\t\t\tthis.state.PushEvaluationStack(this.state.PeekEvaluationStack());\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.PopEvaluatedValue:\r\n\t\t\t\tthis.state.PopEvaluationStack();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.PopFunction:\r\n\t\t\tcase ControlCommand.CommandType.PopTunnel:\r\n\r\n\t\t\t\tlet popType = evalCommand.commandType == ControlCommand.CommandType.PopFunction ?\r\n\t\t\t\t\tPushPopType.Function : PushPopType.Tunnel;\r\n\r\n\t\t\t\tlet overrideTunnelReturnTarget: DivertTargetValue | null = null;\r\n\t\t\t\tif (popType == PushPopType.Tunnel) {\r\n\t\t\t\t\tlet popped = this.state.PopEvaluationStack();\r\n\t\t\t\t\t// overrideTunnelReturnTarget = popped as DivertTargetValue;\r\n\t\t\t\t\toverrideTunnelReturnTarget = asOrNull(popped, DivertTargetValue);\r\n\t\t\t\t\tif (overrideTunnelReturnTarget === null) {\r\n\t\t\t\t\t\tthis.Assert(popped instanceof Void, \"Expected void if ->-> doesn't override target\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (this.state.TryExitFunctionEvaluationFromGame()){\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\telse if (this.state.callStack.currentElement.type != popType || !this.state.callStack.canPop) {\r\n\r\n\t\t\t\t\tlet names: Map<PushPopType, string> = new Map();\r\n\t\t\t\t\tnames.set(PushPopType.Function, 'function return statement (~ return)');\r\n\t\t\t\t\tnames.set(PushPopType.Tunnel, 'tunnel onwards statement (->->)');\r\n\r\n\t\t\t\t\tlet expected = names.get(this.state.callStack.currentElement.type);\r\n\t\t\t\t\tif (!this.state.callStack.canPop) {\r\n\t\t\t\t\t\texpected = 'end of flow (-> END or choice)';\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tlet errorMsg = 'Found ' + names.get(popType) + ', when expected ' + expected;\r\n\r\n\t\t\t\t\tthis.Error(errorMsg);\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis.state.PopCallStack();\r\n\r\n\t\t\t\t\tif (overrideTunnelReturnTarget)\r\n\t\t\t\t\t\tthis.state.divertedPointer = this.PointerAtPath(overrideTunnelReturnTarget.targetPath);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.BeginString:\r\n\t\t\t\tthis.state.PushToOutputStream(evalCommand);\r\n\r\n\t\t\t\tthis.Assert(this.state.inExpressionEvaluation === true, 'Expected to be in an expression when evaluating a string');\r\n\t\t\t\tthis.state.inExpressionEvaluation = false;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.EndString:\r\n\r\n\t\t\t\tlet contentStackForString: InkObject[] = [];\r\n\r\n\t\t\t\tlet outputCountConsumed = 0;\r\n\t\t\t\tfor (let i = this.state.outputStream.length - 1; i >= 0; --i) {\r\n\t\t\t\t\tlet obj = this.state.outputStream[i];\r\n\r\n\t\t\t\t\toutputCountConsumed++;\r\n\r\n\t\t\t\t\t// var command = obj as ControlCommand;\r\n\t\t\t\t\tlet command = asOrNull(obj, ControlCommand);\r\n\t\t\t\t\tif (command && command.commandType == ControlCommand.CommandType.BeginString) {\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif( obj instanceof StringValue ) {\r\n\t\t\t\t\t\tcontentStackForString.push(obj);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Consume the content that was produced for this string\r\n\t\t\t\tthis.state.PopFromOutputStream(outputCountConsumed);\r\n\r\n\t\t\t\t// The C# version uses a Stack for contentStackForString, but we're\r\n\t\t\t\t// using a simple array, so we need to reverse it before using it\r\n\t\t\t\tcontentStackForString = contentStackForString.reverse();\r\n\r\n\t\t\t\t// Build string out of the content we collected\r\n\t\t\t\tlet sb = new StringBuilder();\r\n\t\t\t\tfor (let c of contentStackForString) {\r\n\t\t\t\t\tsb.Append(c.toString());\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Return to expression evaluation (from content mode)\r\n\t\t\t\tthis.state.inExpressionEvaluation = true;\r\n\t\t\t\tthis.state.PushEvaluationStack(new StringValue(sb.toString()));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.ChoiceCount:\r\n\t\t\t\tlet choiceCount = this.state.generatedChoices.length;\r\n\t\t\t\tthis.state.PushEvaluationStack(new IntValue(choiceCount));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.Turns:\r\n\t\t\t\tthis.state.PushEvaluationStack (new IntValue (this.state.currentTurnIndex+1));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.TurnsSince:\r\n\t\t\tcase ControlCommand.CommandType.ReadCount:\r\n\t\t\t\tlet target = this.state.PopEvaluationStack();\r\n\t\t\t\tif( !(target instanceof DivertTargetValue) ) {\r\n\t\t\t\t\tlet extraNote = '';\r\n\t\t\t\t\tif( target instanceof IntValue )\r\n\t\t\t\t\t\textraNote = \". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?\";\r\n\t\t\t\t\tthis.Error('TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw '+target+extraNote);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// var divertTarget = target as DivertTargetValue;\r\n\t\t\t\tlet divertTarget = asOrThrows(target, DivertTargetValue);\r\n\t\t\t\t// var container = ContentAtPath (divertTarget.targetPath).correctObj as Container;\r\n\t\t\t\tlet container = asOrNull(this.ContentAtPath(divertTarget.targetPath).correctObj, Container);\r\n\r\n\t\t\t\tlet eitherCount;\r\n\t\t\t\tif (container != null) {\r\n\t\t\t\t\tif (evalCommand.commandType == ControlCommand.CommandType.TurnsSince)\r\n\t\t\t\t\t\teitherCount = this.TurnsSinceForContainer(container);\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\teitherCount = this.VisitCountForContainer(container);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (evalCommand.commandType == ControlCommand.CommandType.TurnsSince)\r\n\t\t\t\t\t\teitherCount = -1;\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\teitherCount = 0;\r\n\r\n\t\t\t\t\tthis.Warning('Failed to find container for ' + evalCommand.toString() + ' lookup at ' + divertTarget.targetPath.toString());\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.state.PushEvaluationStack(new IntValue(eitherCount));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.Random: {\r\n\t\t\t\tlet maxInt = asOrNull(this.state.PopEvaluationStack(), IntValue);\r\n\t\t\t\tlet minInt = asOrNull(this.state.PopEvaluationStack(), IntValue);\r\n\r\n\t\t\t\tif (minInt == null || minInt instanceof IntValue === false)\r\n\t\t\t\t\treturn this.Error('Invalid value for minimum parameter of RANDOM(min, max)');\r\n\r\n\t\t\t\tif (maxInt == null || minInt instanceof IntValue === false)\r\n\t\t\t\t\treturn this.Error('Invalid value for maximum parameter of RANDOM(min, max)');\r\n\r\n\t\t\t\t// Originally a primitive type, but here, can be null.\r\n\t\t\t\t// TODO: Replace by default value?\r\n\t\t\t\tif (maxInt.value === null) { return throwNullException('maxInt.value'); }\r\n\t\t\t\tif (minInt.value === null) { return throwNullException('minInt.value'); }\r\n\r\n\t\t\t\tlet randomRange = maxInt.value - minInt.value + 1;\r\n\t\t\t\tif (randomRange <= 0)\r\n\t\t\t\t\tthis.Error('RANDOM was called with minimum as ' + minInt.value + ' and maximum as ' + maxInt.value + '. The maximum must be larger');\r\n\r\n\t\t\t\tlet resultSeed = this.state.storySeed + this.state.previousRandom;\r\n\t\t\t\tlet random = new PRNG(resultSeed);\r\n\r\n\t\t\t\tlet nextRandom = random.next();\r\n\t\t\t\tlet chosenValue = (nextRandom % randomRange) + minInt.value;\r\n\t\t\t\tthis.state.PushEvaluationStack(new IntValue(chosenValue));\r\n\r\n\t\t\t\t// Next random number (rather than keeping the Random object around)\r\n\t\t\t\tthis.state.previousRandom = nextRandom;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tcase ControlCommand.CommandType.SeedRandom:\r\n\t\t\t\tlet seed = asOrNull(this.state.PopEvaluationStack(), IntValue);\r\n\t\t\t\tif (seed == null || seed instanceof IntValue === false)\r\n\t\t\t\t\treturn this.Error('Invalid value passed to SEED_RANDOM');\r\n\r\n\t\t\t\t// Originally a primitive type, but here, can be null.\r\n\t\t\t\t// TODO: Replace by default value?\r\n\t\t\t\tif (seed.value === null) { return throwNullException('minInt.value'); }\r\n\r\n\t\t\t\tthis.state.storySeed = seed.value;\r\n\t\t\t\tthis.state.previousRandom = 0;\r\n\r\n\t\t\t\tthis.state.PushEvaluationStack(new Void());\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.VisitIndex:\r\n\t\t\t\tlet count = this.VisitCountForContainer(this.state.currentPointer.container) - 1; // index not count\r\n\t\t\t\tthis.state.PushEvaluationStack(new IntValue(count));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.SequenceShuffleIndex:\r\n\t\t\t\tlet shuffleIndex = this.NextSequenceShuffleIndex();\r\n\t\t\t\tthis.state.PushEvaluationStack(new IntValue(shuffleIndex));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.StartThread:\r\n\t\t\t\t// Handled in main step function\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.Done:\r\n\t\t\t\t// We may exist in the context of the initial\r\n\t\t\t\t// act of creating the thread, or in the context of\r\n\t\t\t\t// evaluating the content.\r\n\t\t\t\tif (this.state.callStack.canPopThread) {\r\n\t\t\t\t\tthis.state.callStack.PopThread();\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// In normal flow - allow safe exit without warning\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis.state.didSafeExit = true;\r\n\r\n\t\t\t\t\t// Stop flow in current thread\r\n\t\t\t\t\tthis.state.currentPointer = Pointer.Null;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\t// Force flow to end completely\r\n\t\t\tcase ControlCommand.CommandType.End:\r\n\t\t\t\tthis.state.ForceEnd();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.ListFromInt:\r\n\t\t\t\t// var intVal = state.PopEvaluationStack () as IntValue;\r\n\t\t\t\tlet intVal = asOrNull(this.state.PopEvaluationStack(), IntValue);\r\n\t\t\t\t// var listNameVal = state.PopEvaluationStack () as StringValue;\r\n\t\t\t\tlet listNameVal = asOrThrows(this.state.PopEvaluationStack(), StringValue);\r\n\r\n\t\t\t\tif (intVal === null) {\r\n\t\t\t\t\tthrow new StoryException('Passed non-integer when creating a list element from a numerical value.');\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet generatedListValue = null;\r\n\r\n\t\t\t\tif (this.listDefinitions === null) { return throwNullException('this.listDefinitions'); }\r\n\t\t\t\tlet foundListDef = this.listDefinitions.TryListGetDefinition(listNameVal.value, null);\r\n\t\t\t\tif (foundListDef.exists) {\r\n\t\t\t\t\t// Originally a primitive type, but here, can be null.\r\n\t\t\t\t\t// TODO: Replace by default value?\r\n\t\t\t\t\tif (intVal.value === null) { return throwNullException('minInt.value'); }\r\n\r\n\t\t\t\t\tlet foundItem = foundListDef.result!.TryGetItemWithValue(intVal.value, InkListItem.Null);\r\n\t\t\t\t\tif (foundItem.exists) {\r\n\t\t\t\t\t\tgeneratedListValue = new ListValue(foundItem.result!, intVal.value);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new StoryException('Failed to find LIST called ' + listNameVal.value);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (generatedListValue == null)\r\n\t\t\t\t\tgeneratedListValue = new ListValue();\r\n\r\n\t\t\t\tthis.state.PushEvaluationStack(generatedListValue);\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.ListRange:\r\n\t\t\t\tlet max = asOrNull(this.state.PopEvaluationStack(), Value);\r\n\t\t\t\tlet min = asOrNull(this.state.PopEvaluationStack(), Value);\r\n\r\n\t\t\t\t// var targetList = state.PopEvaluationStack () as ListValue;\r\n\t\t\t\tlet targetList = asOrNull(this.state.PopEvaluationStack(), ListValue);\r\n\r\n\t\t\t\tif (targetList === null || min === null || max === null)\r\n\t\t\t\t\tthrow new StoryException('Expected list, minimum and maximum for LIST_RANGE');\r\n\r\n\t\t\t\tif (targetList.value === null) { return throwNullException('targetList.value'); }\r\n\t\t\t\tlet result = targetList.value.ListWithSubRange(min.valueObject, max.valueObject);\r\n\r\n\t\t\t\tthis.state.PushEvaluationStack (new ListValue(result));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase ControlCommand.CommandType.ListRandom: {\r\n\t\t\t\tlet listVal = this.state.PopEvaluationStack() as ListValue;\r\n\t\t\t\tif (listVal === null)\r\n\t\t\t\t\tthrow new StoryException('Expected list for LIST_RANDOM');\r\n\r\n\t\t\t\tlet list = listVal.value;\r\n\r\n\t\t\t\tlet newList: InkList | null = null;\r\n\r\n\t\t\t\tif (list === null) { throw throwNullException('list'); }\r\n\t\t\t\tif (list.Count == 0) {\r\n\t\t\t\t\tnewList = new InkList();\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Generate a random index for the element to take\r\n\t\t\t\t\tlet resultSeed = this.state.storySeed + this.state.previousRandom;\r\n\t\t\t\t\tlet random = new PRNG(resultSeed);\r\n\r\n\t\t\t\t\tlet nextRandom = random.next();\r\n\t\t\t\t\tlet listItemIndex = nextRandom % list.Count;\r\n\r\n\t\t\t\t\t// This bit is a little different from the original\r\n\t\t\t\t\t// C# code, since iterators do not work in the same way.\r\n\t\t\t\t\t// First, we iterate listItemIndex - 1 times, calling next().\r\n\t\t\t\t\t// The listItemIndex-th time is made outside of the loop,\r\n\t\t\t\t\t// in order to retrieve the value.\r\n\t\t\t\t\tlet listEnumerator = list.entries();\r\n\t\t\t\t\tfor (let i = 0; i <= listItemIndex - 1; i++) {\r\n\t\t\t\t\t\tlistEnumerator.next();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlet value = listEnumerator.next().value;\r\n\t\t\t\t\tlet randomItem: KeyValuePair<InkListItem, number> = {\r\n\t\t\t\t\t\tKey: InkListItem.fromSerializedKey(value[0]),\r\n\t\t\t\t\t\tValue: value[1],\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\t// Origin list is simply the origin of the one element\r\n\t\t\t\t\tif (randomItem.Key.originName === null) { return throwNullException('randomItem.Key.originName'); }\r\n\t\t\t\t\tnewList = new InkList(randomItem.Key.originName, this);\r\n\t\t\t\t\tnewList.Add(randomItem.Key, randomItem.Value);\r\n\r\n\t\t\t\t\tthis.state.previousRandom = nextRandom;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.state.PushEvaluationStack(new ListValue(newList));\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tdefault:\r\n\t\t\t\tthis.Error('unhandled ControlCommand: ' + evalCommand);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// Variable assignment\r\n\t\telse if( contentObj instanceof VariableAssignment ) {\r\n\t\t\tlet varAss = contentObj;\r\n\t\t\tlet assignedVal = this.state.PopEvaluationStack();\r\n\r\n\t\t\tthis.state.variablesState.Assign(varAss, assignedVal);\r\n\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// Variable reference\r\n\t\telse if( contentObj instanceof VariableReference ) {\r\n\t\t\tlet varRef = contentObj;\r\n\t\t\tlet foundValue = null;\r\n\r\n\t\t\t// Explicit read count value\r\n\t\t\tif (varRef.pathForCount != null) {\r\n\r\n\t\t\t\tlet container = varRef.containerForCount;\r\n\t\t\t\tlet count = this.VisitCountForContainer(container);\r\n\t\t\t\tfoundValue = new IntValue(count);\r\n\t\t\t}\r\n\r\n\t\t\t// Normal variable reference\r\n\t\t\telse {\r\n\r\n\t\t\t\tfoundValue = this.state.variablesState.GetVariableWithName(varRef.name);\r\n\r\n\t\t\t\tif (foundValue == null) {\r\n\t\t\t\t\tlet defaultVal = this.state.variablesState.TryGetDefaultVariableValue (varRef.name);\r\n\t\t\t\t\tif (defaultVal != null) {\r\n\t\t\t\t\t\tthis.Warning(\"Variable not found in save state: '\" + varRef.name + \"', but seems to have been newly created. Assigning value from latest ink's declaration: \" + defaultVal);\r\n\t\t\t\t\t\tfoundValue = defaultVal;\r\n\r\n\t\t\t\t\t\t// Save for future usage, preventing future errors\r\n\t\t\t\t\t\t// Only do this for variables that are known to be globals, not those that may be missing temps.\r\n\t\t\t\t\t\tthis.state.variablesState.SetGlobal(varRef.name, foundValue);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.Warning (\"Variable not found: '\" + varRef.name + \"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit.\");\r\n\t\t\t\t\t\tfoundValue = new IntValue(0);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthis.state.PushEvaluationStack(foundValue);\r\n\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// Native function call\r\n\t\telse if (contentObj instanceof NativeFunctionCall) {\r\n\t\t\tlet func = contentObj;\r\n\t\t\tlet funcParams = this.state.PopEvaluationStack(func.numberOfParameters);\r\n\t\t\tlet result = func.Call(funcParams);\r\n\t\t\tthis.state.PushEvaluationStack(result);\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// No control content, must be ordinary content\r\n\t\treturn false;\r\n\t}\r\n\r\n\tpublic ChoosePathString(path: string, resetCallstack = true, args: any[] = []){\r\n\t\tthis.IfAsyncWeCant ('call ChoosePathString right now');\r\n\r\n\t\tif (resetCallstack) {\r\n\t\t\tthis.ResetCallstack();\r\n\t\t} else {\r\n\t\t\tif (this.state.callStack.currentElement.type == PushPopType.Function) {\r\n\t\t\t\tlet funcDetail = '';\r\n\t\t\t\tlet container = this.state.callStack.currentElement.currentPointer.container;\r\n\t\t\t\tif (container != null) {\r\n\t\t\t\t\tfuncDetail = '('+container.path.toString ()+') ';\r\n\t\t\t\t}\r\n\t\t\t\tthrow new Error('Story was running a function '+funcDetail+'when you called ChoosePathString('+path+') - this is almost certainly not not what you want! Full stack trace: \\n'+this.state.callStack.callStackTrace);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.state.PassArgumentsToEvaluationStack(args);\r\n\t\tthis.ChoosePath(new Path(path));\r\n\t}\r\n\r\n\tpublic IfAsyncWeCant(activityStr: string)\r\n\t{\r\n\t\tif (this._asyncContinueActive)\r\n\t\t\tthrow new Error(\"Can't \" + activityStr + '. Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.');\r\n\t}\r\n\r\n\tpublic ChoosePath(p: Path, incrementingTurnIndex: boolean = true){\r\n\t\tthis.state.SetChosenPath(p, incrementingTurnIndex);\r\n\r\n\t\t// Take a note of newly visited containers for read counts etc\r\n\t\tthis.VisitChangedContainersDueToDivert();\r\n\t}\r\n\r\n\tpublic ChooseChoiceIndex(choiceIdx: number){\r\n\t\tchoiceIdx = choiceIdx;\r\n\t\tlet choices = this.currentChoices;\r\n\t\tthis.Assert(choiceIdx >= 0 && choiceIdx < choices.length, 'choice out of range');\r\n\r\n\t\tlet choiceToChoose = choices[choiceIdx];\r\n\t\tif (choiceToChoose.threadAtGeneration === null) { return throwNullException('choiceToChoose.threadAtGeneration'); }\r\n\t\tif (choiceToChoose.targetPath === null) { return throwNullException('choiceToChoose.targetPath'); }\r\n\r\n\t\tthis.state.callStack.currentThread = choiceToChoose.threadAtGeneration;\r\n\r\n\t\tthis.ChoosePath(choiceToChoose.targetPath);\r\n\t}\r\n\r\n\tpublic HasFunction(functionName: string){\r\n\t\ttry {\r\n\t\t\treturn this.KnotContainerWithName(functionName) != null;\r\n\t\t} catch(e) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic EvaluateFunction(functionName: string, args: any[] = [], returnTextOutput: boolean = false): Story.EvaluateFunctionTextOutput | any{\r\n\t\t// EvaluateFunction behaves slightly differently than the C# version.\r\n\t\t// In C#, you can pass a (second) parameter `out textOutput` to get the\r\n\t\t// text outputted by the function. This is not possible in js. Instead,\r\n\t\t// we maintain the regular signature (functionName, args), plus an\r\n\t\t// optional third parameter returnTextOutput. If set to true, we will\r\n\t\t// return both the textOutput and the returned value, as an object.\r\n\r\n\t\tthis.IfAsyncWeCant('evaluate a function');\r\n\r\n\t\tif (functionName == null) {\r\n\t\t\tthrow new Error('Function is null');\r\n\t\t}\r\n\t\telse if (functionName == '' || functionName.trim() == '') {\r\n\t\t\tthrow new Error('Function is empty or white space.');\r\n\t\t}\r\n\r\n\t\tlet funcContainer = this.KnotContainerWithName(functionName);\r\n\t\tif (funcContainer == null) {\r\n\t\t\tthrow new Error(\"Function doesn't exist: '\" + functionName + \"'\");\r\n\t\t}\r\n\r\n\t\tlet outputStreamBefore: InkObject[] = [];\r\n\t\toutputStreamBefore.push.apply(outputStreamBefore, this.state.outputStream);\r\n\t\tthis._state.ResetOutput();\r\n\r\n\t\tthis.state.StartFunctionEvaluationFromGame(funcContainer, args);\r\n\r\n\t\t// Evaluate the function, and collect the string output\r\n\t\tlet stringOutput = new StringBuilder();\r\n\t\twhile (this.canContinue) {\r\n\t\t\tstringOutput.Append(this.Continue());\r\n\t\t}\r\n\t\tlet textOutput = stringOutput.toString();\r\n\r\n\t\tthis._state.ResetOutput(outputStreamBefore);\r\n\r\n\t\tlet result = this.state.CompleteFunctionEvaluationFromGame();\r\n\r\n\t\treturn (returnTextOutput) ? {returned: result, output: textOutput} : result;\r\n\t}\r\n\r\n\tpublic EvaluateExpression(exprContainer: Container){\r\n\t\tlet startCallStackHeight = this.state.callStack.elements.length;\r\n\r\n\t\tthis.state.callStack.Push(PushPopType.Tunnel);\r\n\r\n\t\tthis._temporaryEvaluationContainer = exprContainer;\r\n\r\n\t\tthis.state.GoToStart();\r\n\r\n\t\tlet evalStackHeight = this.state.evaluationStack.length;\r\n\r\n\t\tthis.Continue();\r\n\r\n\t\tthis._temporaryEvaluationContainer = null;\r\n\r\n\t\t// Should have fallen off the end of the Container, which should\r\n\t\t// have auto-popped, but just in case we didn't for some reason,\r\n\t\t// manually pop to restore the state (including currentPath).\r\n\t\tif (this.state.callStack.elements.length > startCallStackHeight) {\r\n\t\t\tthis.state.PopCallStack();\r\n\t\t}\r\n\r\n\t\tlet endStackHeight = this.state.evaluationStack.length;\r\n\t\tif (endStackHeight > evalStackHeight) {\r\n\t\t\treturn this.state.PopEvaluationStack();\r\n\t\t} else {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic allowExternalFunctionFallbacks: boolean = false;\r\n\r\n\tpublic CallExternalFunction(funcName: string | null, numberOfArguments: number){\r\n\t\tif (funcName === null) { return throwNullException('funcName'); }\r\n\t\tlet func = this._externals.get(funcName);\r\n\t\tlet fallbackFunctionContainer = null;\r\n\r\n\t\tlet foundExternal = typeof func !== 'undefined';\r\n\r\n\t\t// Try to use fallback function?\r\n\t\tif (!foundExternal) {\r\n\t\t\tif (this.allowExternalFunctionFallbacks) {\r\n\t\t\t\tfallbackFunctionContainer = this.KnotContainerWithName(funcName);\r\n\t\t\t\tthis.Assert(fallbackFunctionContainer !== null, \"Trying to call EXTERNAL function '\" + funcName + \"' which has not been bound, and fallback ink function could not be found.\");\r\n\r\n\t\t\t\t// Divert direct into fallback function and we're done\r\n\t\t\t\tthis.state.callStack.Push(\r\n\t\t\t\t\tPushPopType.Function,\r\n\t\t\t\t\tundefined,\r\n\t\t\t\t\tthis.state.outputStream.length,\r\n\t\t\t\t);\r\n\t\t\t\tthis.state.divertedPointer = Pointer.StartOf(fallbackFunctionContainer);\r\n\t\t\t\treturn;\r\n\r\n\t\t\t} else {\r\n\t\t\t\tthis.Assert(false, \"Trying to call EXTERNAL function '\" + funcName + \"' which has not been bound (and ink fallbacks disabled).\");\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Pop arguments\r\n\t\tlet args: any[] = [];\r\n\t\tfor (let i = 0; i < numberOfArguments; ++i) {\r\n\t\t\t// var poppedObj = state.PopEvaluationStack () as Value;\r\n\t\t\tlet poppedObj = asOrThrows(this.state.PopEvaluationStack(), Value);\r\n\t\t\tlet valueObj = poppedObj.valueObject;\r\n\t\t\targs.push(valueObj);\r\n\t\t}\r\n\r\n\t\t// Reverse arguments from the order they were popped,\r\n\t\t// so they're the right way round again.\r\n\t\targs.reverse();\r\n\r\n\t\t// Run the function!\r\n\t\tlet funcResult = func!(args);\r\n\r\n\t\t// Convert return value (if any) to the a type that the ink engine can use\r\n\t\tlet returnObj = null;\r\n\t\tif (funcResult != null) {\r\n\t\t\treturnObj = Value.Create(funcResult);\r\n\t\t\tthis.Assert(returnObj !== null, 'Could not create ink value from returned object of type ' + (typeof funcResult));\r\n\t\t} else {\r\n\t\t\treturnObj = new Void();\r\n\t\t}\r\n\r\n\t\tthis.state.PushEvaluationStack(returnObj);\r\n\t}\r\n\r\n\tpublic BindExternalFunctionGeneral(funcName: string, func: Story.ExternalFunction){\r\n\t\tthis.IfAsyncWeCant('bind an external function');\r\n\t\tthis.Assert(!this._externals.has(funcName), \"Function '\" + funcName + \"' has already been bound.\");\r\n\t\tthis._externals.set(funcName, func);\r\n\t}\r\n\r\n\tpublic TryCoerce(value: any){\r\n\t\t// We're skipping type coercition in this implementation. First of, js\r\n\t\t// is loosely typed, so it's not that important. Secondly, there is no\r\n\t\t// clean way (AFAIK) for the user to describe what type of parameters\r\n\t\t// they expect.\r\n\t\treturn value;\r\n\t}\r\n\r\n\tpublic BindExternalFunction(funcName: string, func: Story.ExternalFunction){\r\n\t\tthis.Assert(func != null, \"Can't bind a null function\");\r\n\r\n\t\tthis.BindExternalFunctionGeneral(funcName, (args: any) => {\r\n\t\t\tthis.Assert(args.length >= func.length, 'External function expected ' + func.length + ' arguments');\r\n\r\n\t\t\tlet coercedArgs = [];\r\n\t\t\tfor (let i = 0, l = args.length; i < l; i++){\r\n\t\t\t\tcoercedArgs[i] = this.TryCoerce(args[i]);\r\n\t\t\t}\r\n\t\t\treturn func.apply(null, coercedArgs);\r\n\t\t});\r\n\t}\r\n\r\n\tpublic UnbindExternalFunction(funcName: string){\r\n\t\tthis.IfAsyncWeCant('unbind an external a function');\r\n\t\tthis.Assert(this._externals.has(funcName), \"Function '\" + funcName + \"' has not been bound.\");\r\n\t\tthis._externals.delete(funcName);\r\n\t}\r\n\r\n\tpublic ValidateExternalBindings(): void;\r\n\tpublic ValidateExternalBindings(c: Container | null, missingExternals: Set<string>): void;\r\n\tpublic ValidateExternalBindings(o: InkObject | null, missingExternals: Set<string>): void;\r\n\tpublic ValidateExternalBindings(){\r\n\r\n\t\tlet c: Container | null = null;\r\n\t\tlet o: InkObject | null = null;\r\n\t\tlet missingExternals: Set<string> = arguments[1] || new Set();\r\n\r\n\t\tif (arguments[0] instanceof Container) {\r\n\t\t\tc = arguments[0];\r\n\t\t}\r\n\r\n\t\tif (arguments[0] instanceof InkObject) {\r\n\t\t\to = arguments[0];\r\n\t\t}\r\n\r\n\t\tif (c === null && o === null) {\r\n\t\t\tthis.ValidateExternalBindings(this._mainContentContainer, missingExternals);\r\n\t\t\tthis._hasValidatedExternals = true;\r\n\r\n\t\t\t// No problem! Validation complete\r\n\t\t\tif( missingExternals.size == 0 ) {\r\n\t\t\t\tthis._hasValidatedExternals = true;\r\n\t\t\t} else {\r\n\t\t\t\tlet message = 'Error: Missing function binding for external';\r\n\t\t\t\tmessage += (missingExternals.size > 1) ? 's' : '';\r\n\t\t\t\tmessage += \": '\";\r\n\t\t\t\tmessage += Array.from(missingExternals).join(\"', '\");\r\n\t\t\t\tmessage += \"' \";\r\n\t\t\t\tmessage += (this.allowExternalFunctionFallbacks) ? ', and no fallback ink function found.' : ' (ink fallbacks disabled)';\r\n\r\n\t\t\t\tthis.Error(message);\r\n\t\t\t}\r\n\t\t} else if (c != null) {\r\n\t\t\tfor (let innerContent of c.content) {\r\n\t\t\t\tlet container = innerContent as Container;\r\n\t\t\t\tif (container == null || !container.hasValidName)\r\n\t\t\t\t\tthis.ValidateExternalBindings (innerContent, missingExternals);\r\n\t\t\t}\r\n\t\t\tfor (let [key, value] of c.namedContent) {\r\n\t\t\t\tthis.ValidateExternalBindings (asOrNull(value, InkObject), missingExternals);\r\n\t\t\t}\r\n\t\t} else if (o != null) {\r\n\t\t\tlet divert = asOrNull(o, Divert);\r\n\t\t\tif (divert && divert.isExternal) {\r\n\t\t\t\tlet name = divert.targetPathString;\r\n\t\t\t\tif (name === null) { return throwNullException('name'); }\r\n\t\t\t\tif (!this._externals.has(name)) {\r\n\t\t\t\t\tif (this.allowExternalFunctionFallbacks) {\r\n\t\t\t\t\t\tlet fallbackFound = this.mainContentContainer.namedContent.has(name);\r\n\t\t\t\t\t\tif (!fallbackFound) {\r\n\t\t\t\t\t\t\tmissingExternals.add(name);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tmissingExternals.add(name);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic ObserveVariable(variableName: string, observer: Story.VariableObserver){\r\n\t\tthis.IfAsyncWeCant('observe a new variable');\r\n\r\n\t\tif (this._variableObservers === null)\r\n\t\t\tthis._variableObservers = new Map();\r\n\r\n\t\tif(!this.state.variablesState.GlobalVariableExistsWithName(variableName))\r\n\t\t\tthrow new StoryException(\"Cannot observe variable '\"+variableName+\"' because it wasn't declared in the ink story.\");\r\n\r\n\t\tif (this._variableObservers.has(variableName)) {\r\n\t\t\tthis._variableObservers.get(variableName)!.push(observer);\r\n\t\t} else {\r\n\t\t\tthis._variableObservers.set(variableName, [observer]);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic ObserveVariables(variableNames: string[], observers: Story.VariableObserver[]){\r\n\t\tfor (let i = 0, l = variableNames.length; i < l; i++){\r\n\t\t\tthis.ObserveVariable(variableNames[i], observers[i]);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic RemoveVariableObserver(observer: Story.VariableObserver, specificVariableName: string){\r\n\t\tthis.IfAsyncWeCant('remove a variable observer');\r\n\r\n\t\tif (this._variableObservers === null)\r\n\t\t\treturn;\r\n\r\n\t\tif (typeof specificVariableName !== 'undefined') {\r\n\t\t\tif (this._variableObservers.has(specificVariableName)) {\r\n\t\t\t\tlet observers = this._variableObservers.get(specificVariableName)!;\r\n\t\t\t\tobservers.splice(observers.indexOf(observer), 1);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tlet keys = this._variableObservers.keys();\r\n\r\n\t\t\tfor (let varName of keys){\r\n\t\t\t\tlet observers = this._variableObservers.get(varName)!;\r\n\t\t\t\tobservers.splice(observers.indexOf(observer), 1);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic VariableStateDidChangeEvent(variableName: string, newValueObj: InkObject){\r\n\t\tif (this._variableObservers === null)\r\n\t\t\treturn;\r\n\r\n\t\tlet observers = this._variableObservers.get(variableName);\r\n\t\tif (typeof observers !== 'undefined') {\r\n\t\t\tif (!(newValueObj instanceof Value)) {\r\n\t\t\t\tthrow new Error(\"Tried to get the value of a variable that isn't a standard type\");\r\n\t\t\t}\r\n\t\t\t// var val = newValueObj as Value;\r\n\t\t\tlet val = asOrThrows(newValueObj, Value);\r\n\r\n\t\t\tfor (let observer of observers) {\r\n\t\t\t\tobserver(variableName, val.valueObject);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget globalTags(){\r\n\t\treturn this.TagsAtStartOfFlowContainerWithPathString('');\r\n\t}\r\n\r\n\tpublic TagsForContentAtPath(path: string){\r\n\t\treturn this.TagsAtStartOfFlowContainerWithPathString(path);\r\n\t}\r\n\r\n\tpublic TagsAtStartOfFlowContainerWithPathString(pathString: string){\r\n\t\tlet path = new Path(pathString);\r\n\r\n\t\tlet flowContainer = this.ContentAtPath(path).container;\r\n\t\tif (flowContainer === null) { return throwNullException('flowContainer'); }\r\n\t\twhile(true) {\r\n\t\t\tlet firstContent: InkObject = flowContainer.content[0];\r\n\t\t\tif (firstContent instanceof Container)\r\n\t\t\t\tflowContainer = firstContent;\r\n\t\t\telse break;\r\n\t\t}\r\n\r\n\t\tlet tags: string[] | null = null;\r\n\r\n\t\tfor(let c of flowContainer.content) {\r\n\t\t\t// var tag = c as Runtime.Tag;\r\n\t\t\tlet tag = asOrNull(c, Tag);\r\n\t\t\tif (tag) {\r\n\t\t\t\tif (tags == null) tags = [];\r\n\t\t\t\ttags.push(tag.text);\r\n\t\t\t} else break;\r\n\t\t}\r\n\r\n\t\treturn tags;\r\n\t}\r\n\r\n\tpublic BuildStringOfHierarchy(){\r\n\t\tlet sb = new StringBuilder();\r\n\r\n\t\tthis.mainContentContainer.BuildStringOfHierarchy(sb, 0, this.state.currentPointer.Resolve());\r\n\r\n\t\treturn sb.toString();\r\n\t}\r\n\r\n\tpublic BuildStringOfContainer(container: Container){\r\n\t\tlet sb = new StringBuilder();\r\n\t\tcontainer.BuildStringOfHierarchy(sb, 0, this.state.currentPointer.Resolve());\r\n\t\treturn sb.toString();\r\n\t}\r\n\r\n\tpublic NextContent(){\r\n\t\tthis.state.previousPointer = this.state.currentPointer.copy();\r\n\r\n\t\tif (!this.state.divertedPointer.isNull) {\r\n\r\n\t\t\tthis.state.currentPointer = this.state.divertedPointer.copy();\r\n\t\t\tthis.state.divertedPointer = Pointer.Null;\r\n\r\n\t\t\tthis.VisitChangedContainersDueToDivert();\r\n\r\n\t\t\tif (!this.state.currentPointer.isNull) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet successfulPointerIncrement = this.IncrementContentPointer();\r\n\r\n\t\tif (!successfulPointerIncrement) {\r\n\r\n\t\t\tlet didPop = false;\r\n\r\n\t\t\tif (this.state.callStack.CanPop(PushPopType.Function)) {\r\n\r\n\t\t\t\tthis.state.PopCallStack(PushPopType.Function);\r\n\r\n\t\t\t\tif (this.state.inExpressionEvaluation) {\r\n\t\t\t\t\tthis.state.PushEvaluationStack(new Void());\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdidPop = true;\r\n\t\t\t} else if (this.state.callStack.canPopThread) {\r\n\t\t\t\tthis.state.callStack.PopThread();\r\n\r\n\t\t\t\tdidPop = true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.state.TryExitFunctionEvaluationFromGame();\r\n\t\t\t}\r\n\r\n\t\t\tif (didPop && !this.state.currentPointer.isNull) {\r\n\t\t\t\tthis.NextContent();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic IncrementContentPointer(){\r\n\t\tlet successfulIncrement = true;\r\n\r\n\t\tlet pointer = this.state.callStack.currentElement.currentPointer.copy();\r\n\t\tpointer.index++;\r\n\r\n\t\tif (pointer.container === null) { return throwNullException('pointer.container'); }\r\n\t\twhile (pointer.index >= pointer.container.content.length) {\r\n\r\n\t\t\tsuccessfulIncrement = false;\r\n\r\n\t\t\t// Container nextAncestor = pointer.container.parent as Container;\r\n\t\t\tlet nextAncestor = asOrNull(pointer.container.parent, Container);\r\n\t\t\tif (nextAncestor instanceof Container === false) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tlet indexInAncestor = nextAncestor!.content.indexOf(pointer.container);\r\n\t\t\tif (indexInAncestor == -1) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tpointer = new Pointer(nextAncestor, indexInAncestor);\r\n\r\n\t\t\tpointer.index++;\r\n\r\n\t\t\tsuccessfulIncrement = true;\r\n\t\t\tif (pointer.container === null) { return throwNullException('pointer.container'); }\r\n\t\t}\r\n\r\n\t\tif (!successfulIncrement) pointer = Pointer.Null;\r\n\r\n\t\tthis.state.callStack.currentElement.currentPointer = pointer.copy();\r\n\r\n\t\treturn successfulIncrement;\r\n\t}\r\n\r\n\tpublic TryFollowDefaultInvisibleChoice(){\r\n\t\tlet allChoices = this._state.currentChoices;\r\n\r\n\t\tlet invisibleChoices = allChoices.filter((c) => {\r\n\t\t\treturn c.isInvisibleDefault;\r\n\t\t});\r\n\r\n\t\tif (invisibleChoices.length == 0 || allChoices.length > invisibleChoices.length)\r\n\t\t\treturn false;\r\n\r\n\t\tlet choice = invisibleChoices[0];\r\n\r\n\t\tif (choice.targetPath === null) { return throwNullException('choice.targetPath'); }\r\n\r\n\t\tif (choice.threadAtGeneration === null) { return throwNullException('choice.threadAtGeneration'); }\r\n\r\n\t\tthis.state.callStack.currentThread = choice.threadAtGeneration;\r\n\r\n\t\tthis.ChoosePath(choice.targetPath, false);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\tpublic VisitCountForContainer(container: Container | null){\r\n\t\tif (container === null) { return throwNullException('container'); }\r\n\t\tif( !container.visitsShouldBeCounted ) {\r\n\t\t\tconsole.warn('Read count for target ('+container.name+' - on '+container.debugMetadata+') unknown. The story may need to be compiled with countAllVisits flag (-c).');\r\n\t\t\treturn 0;\r\n\t\t}\r\n\r\n\t\tlet count = 0;\r\n\t\tlet containerPathStr = container.path.toString();\r\n\t\tcount = this.state.visitCounts.get(containerPathStr) || count;\r\n\t\treturn count;\r\n\t}\r\n\r\n\tpublic IncrementVisitCountForContainer(container: Container){\r\n\t\tlet count = 0;\r\n\t\tlet containerPathStr = container.path.toString();\r\n\t\tif (this.state.visitCounts.has(containerPathStr)) count = this.state.visitCounts.get(containerPathStr)!;\r\n\t\tcount++;\r\n\t\tthis.state.visitCounts.set(containerPathStr, count);\r\n\t}\r\n\r\n\tpublic RecordTurnIndexVisitToContainer(container: Container){\r\n\t\tlet containerPathStr = container.path.toString();\r\n\t\tthis.state.turnIndices.set(containerPathStr, this.state.currentTurnIndex);\r\n\t}\r\n\r\n\tpublic TurnsSinceForContainer(container: Container){\r\n\t\tif( !container.turnIndexShouldBeCounted ) {\r\n\t\t\tthis.Error('TURNS_SINCE() for target ('+container.name+' - on '+container.debugMetadata+') unknown. The story may need to be compiled with countAllVisits flag (-c).');\r\n\t\t}\r\n\r\n\t\tlet containerPathStr = container.path.toString();\r\n\t\tlet index = this.state.turnIndices.get(containerPathStr);\r\n\t\tif (typeof index !== 'undefined') {\r\n\t\t\treturn this.state.currentTurnIndex - index;\r\n\t\t} else {\r\n\t\t\treturn -1;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic NextSequenceShuffleIndex(){\r\n\t\t// var numElementsIntVal = state.PopEvaluationStack () as IntValue;\r\n\t\tlet numElementsIntVal = asOrNull(this.state.PopEvaluationStack(), IntValue);\r\n\t\tif (!(numElementsIntVal instanceof IntValue)) {\r\n\t\t\tthis.Error('expected number of elements in sequence for shuffle index');\r\n\t\t\treturn 0;\r\n\t\t}\r\n\r\n\t\tlet seqContainer = this.state.currentPointer.container;\r\n\t\tif (seqContainer === null) { return throwNullException('seqContainer'); }\r\n\r\n\t\t// Originally a primitive type, but here, can be null.\r\n\t\t// TODO: Replace by default value?\r\n\t\tif (numElementsIntVal.value === null) { return throwNullException('numElementsIntVal.value'); }\r\n\t\tlet numElements = numElementsIntVal.value;\r\n\r\n\t\t// var seqCountVal = state.PopEvaluationStack () as IntValue;\r\n\t\tlet seqCountVal = asOrThrows(this.state.PopEvaluationStack(), IntValue);\r\n\t\tlet seqCount = seqCountVal.value;\r\n\r\n\t\t// Originally a primitive type, but here, can be null.\r\n\t\t// TODO: Replace by default value?\r\n\t\tif (seqCount === null) { return throwNullException('seqCount'); }\r\n\r\n\t\tlet loopIndex = seqCount / numElements;\r\n\t\tlet iterationIndex = seqCount % numElements;\r\n\r\n\t\tlet seqPathStr = seqContainer.path.toString();\r\n\t\tlet sequenceHash = 0;\r\n\t\tfor (let i = 0, l = seqPathStr.length; i < l; i++){\r\n\t\t\tsequenceHash += seqPathStr.charCodeAt(i) || 0;\r\n\t\t}\r\n\t\tlet randomSeed = sequenceHash + loopIndex + this.state.storySeed;\r\n\t\tlet random = new PRNG(Math.floor(randomSeed));\r\n\r\n\t\tlet unpickedIndices = [];\r\n\t\tfor (let i = 0; i < numElements; ++i) {\r\n\t\t\tunpickedIndices.push(i);\r\n\t\t}\r\n\r\n\t\tfor (let i = 0; i <= iterationIndex; ++i) {\r\n\t\t\tlet chosen = random.next() % unpickedIndices.length;\r\n\t\t\tlet chosenIndex = unpickedIndices[chosen];\r\n\t\t\tunpickedIndices.splice(chosen, 1);\r\n\r\n\t\t\tif (i == iterationIndex) {\r\n\t\t\t\treturn chosenIndex;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthrow new Error('Should never reach here');\r\n\t}\r\n\r\n\tpublic Error(message: string, useEndLineNumber = false): never{\r\n\t\tlet e = new StoryException(message);\r\n\t\te.useEndLineNumber = useEndLineNumber;\r\n\t\tthrow e;\r\n\t}\r\n\r\n\tpublic Warning(message: string){\r\n\t\tthis.AddError(message, true);\r\n\t}\r\n\r\n\tpublic AddError(message: string, isWarning = false, useEndLineNumber = false){\r\n\t\tlet dm = this.currentDebugMetadata;\r\n\r\n\t\tlet errorTypeStr = isWarning ? 'WARNING' : 'ERROR';\r\n\r\n\t\tif (dm != null) {\r\n\t\t\tlet lineNum = useEndLineNumber ? dm.endLineNumber : dm.startLineNumber;\r\n\t\t\tmessage = 'RUNTIME ' + errorTypeStr + \": '\" + dm.fileName + \"' line \" + lineNum + ': ' + message;\r\n\t\t}\r\n\t\telse if(!this.state.currentPointer.isNull) {\r\n\t\t\tmessage = 'RUNTIME ' + errorTypeStr + ': (' + this.state.currentPointer + '): ' + message;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tmessage = 'RUNTIME ' + errorTypeStr + ': ' + message;\r\n\t\t}\r\n\r\n\t\tthis.state.AddError(message, isWarning);\r\n\r\n\t\t// In a broken state don't need to know about any other errors.\r\n\t\tif (!isWarning)\r\n\t\t\tthis.state.ForceEnd();\r\n\t}\r\n\r\n\tpublic Assert(condition: boolean, message: string | null = null) {\r\n\t\tif (condition == false) {\r\n\t\t\tif (message == null) {\r\n\t\t\t\tmessage = 'Story assert';\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(message + ' ' + this.currentDebugMetadata);\r\n\t\t}\r\n\t}\r\n\r\n\tget currentDebugMetadata(): DebugMetadata | null {\r\n\t\tlet dm: DebugMetadata | null;\r\n\r\n\t\tlet pointer = this.state.currentPointer;\r\n\t\tif (!pointer.isNull && pointer.Resolve() !== null) {\r\n\t\t\tdm = pointer.Resolve()!.debugMetadata;\r\n\t\t\tif (dm !== null) {\r\n\t\t\t\treturn dm;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (let i = this.state.callStack.elements.length - 1; i >= 0; --i) {\r\n\t\t\tpointer = this.state.callStack.elements [i].currentPointer;\r\n\t\t\tif (!pointer.isNull && pointer.Resolve() !== null) {\r\n\t\t\t\tdm = pointer.Resolve()!.debugMetadata;\r\n\t\t\t\tif (dm !== null) {\r\n\t\t\t\t\treturn dm;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (let i = this.state.outputStream.length - 1; i >= 0; --i) {\r\n\t\t\tlet outputObj = this.state.outputStream [i];\r\n\t\t\tdm = outputObj.debugMetadata;\r\n\t\t\tif (dm !== null) {\r\n\t\t\t\treturn dm;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\tget mainContentContainer(){\r\n\t\tif (this._temporaryEvaluationContainer) {\r\n\t\t\treturn this._temporaryEvaluationContainer;\r\n\t\t} else {\r\n\t\t\treturn this._mainContentContainer;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * `_mainContentContainer` is almost guaranteed to be set in the\r\n\t * constructor, unless the json is malformed.\r\n\t */\r\n\tprivate _mainContentContainer!: Container;\r\n\tprivate _listDefinitions: ListDefinitionsOrigin | null = null;\r\n\r\n\tprivate _externals: Map<string, Story.ExternalFunction>;\r\n\tprivate _variableObservers: Map<string, Story.VariableObserver[]> | null = null;\r\n\tprivate _hasValidatedExternals: boolean = false;\r\n\r\n\tprivate _temporaryEvaluationContainer: Container | null = null;\r\n\r\n\t/**\r\n\t * `state` is almost guaranteed to be set in the constructor, unless\r\n\t * using the compiler-specific constructor which will likely not be used in\r\n\t * the real world.\r\n\t */\r\n\tprivate _state!: StoryState;\r\n\r\n\tprivate _asyncContinueActive: boolean = false;\r\n\tprivate _stateAtLastNewline: StoryState | null = null;\r\n\r\n\tprivate _recursiveContinueCount: number = 0;\r\n\r\n\tprivate _profiler: any | null = null; // TODO: Profiler\r\n}\r\n\r\nexport namespace Story{\r\n\texport enum OutputStateChange {\r\n\t\tNoChange = 0,\r\n\t\tExtendedBeyondNewline = 1,\r\n\t\tNewlineRemoved = 2,\r\n\t}\r\n\r\n\texport interface EvaluateFunctionTextOutput {\r\n\t\treturned: any;\r\n\t\toutput: string;\r\n\t}\r\n\r\n\texport type VariableObserver = (variableName: string, newValue: any) => void;\r\n\texport type ExternalFunction = (...args: any) => any;\r\n}\r\n"],"names":["Path","_components","_componentsString","_isRelative","arguments","componentsString","Component","head","tail","push","concat","Array","relative","index","pathToAppend","p","upwardMoves","i","length","isParent","otherPath","isRelative","l","Equals","c","apply","tailComps","slice","self","lastComponentIdx","isIndex","join","value","substring","componentStrings","split","str","test","parseInt","path","indexOrName","name","toString","otherComp","parentId","Debug","AssertType","variable","type","message","Assert","condition","console","warn","trace","asOrNull","obj","unsafeTypeAssertion","asOrThrows","Error","asNumberOrThrows","asINamedContentOrNull","hasValidName","nullIfUndefined","NullException","throwNullException","InkObject","root","rootContentContainer","targetContent","ContentAtPath","dm","debugMetadata","startLineNumber","nearestContainer","Container","parent","GetComponent","contentContainer","globalPath","ownPath","minPathLength","Math","min","lastSharedPathCompIndex","ownComp","numUpwardsMoves","componentCount","newPathComps","up","ToParent","down","relativePath","globalPathStr","relativePathStr","PathByAppendingPath","ConvertPathToRelative","prop","_debugMetadata","_path","comps","child","container","namedChild","unshift","content","indexOf","ancestor","StringBuilder","string","Append","format","args","replace","match","num","InkListItem","originName","itemName","fullName","nameParts","otherItem","JSON","stringify","key","parse","isLikeInkListItem","Null","inkListItem","item","hasOwnProperty","InkList","undefined","otherList","_originNames","singleOriginListName","originStory","SetInitialOriginName","def","listDefinitions","TryListGetDefinition","exists","origins","result","singleElement","Add","Key","Value","itemOrItemName","AddItem","origin","intVal","TryGetValueForItem","foundListDef","ContainsItemWithName","itemVal","ValueForItem","fromSerializedKey","has","serialized","serializedKey","set","initialOriginName","initialOriginNames","union","intersection","listToRemove","Count","minItem","maxItem","minBound","maxBound","ordered","orderedItems","minValue","maxValue","Number","MAX_SAFE_INTEGER","isInteger","subList","SetInitialOriginNames","originNames","otherInkList","sb","NaN","size","maxOriginName","every","max","isNull","list","items","ContainsKey","sort","x","y","localeCompare","Map","StoryException","useEndLineNumber","tryGetValueFromMap","map","val","get","tryParseInt","defaultValue","isNaN","tryParseFloat","parseFloat","AbstractValue","Create","targetType","valueObject","valueType","b","StringValue","String","IntValue","FloatValue","DivertTargetValue","ListValue","newType","ValueType","Float","BadCastException","Int","_isNewline","_isInlineWhitespace","parsedInt","parsedFloat","isNewline","isInlineWhitespace","targetPath","DivertTarget","VariablePointerValue","variableName","contextIndex","_contextIndex","VariablePointer","List","listOrSingleItem","singleValue","oldValue","newValue","oldList","newList","SearchResult","searchResult","approximate","contentObjOrList","contentList","AddContent","contentObj","_content","TryAddNamedContent","namedContentObj","AddToNamedContentOnly","runtimeObj","namedContent","partialPathStart","partialPathLength","currentContainer","currentObj","comp","foundObj","ContentWithPathComponent","otherContainer","component","foundContent","BuildStringOfHierarchy","indentation","pointedObj","appendIndentation","spacesPerIndent","AppendFormat","AppendLine","onlyNamed","namedOnlyContentDict","inkObject","named","existingNamedOnly","namedOnlyContent","flags","visitsShouldBeCounted","CountFlags","Visits","turnIndexShouldBeCounted","Turns","countingAtStartOnly","CountStartOnly","flag","_pathToFirstLeafContent","internalPathToFirstLeafContent","components","Glue","ControlCommand","_commandType","commandType","CommandType","NotSet","EvalStart","EvalOutput","EvalEnd","Duplicate","PopEvaluatedValue","PopFunction","PopTunnel","BeginString","EndString","NoOp","ChoiceCount","TurnsSince","ReadCount","Random","SeedRandom","VisitIndex","SequenceShuffleIndex","StartThread","Done","End","ListFromInt","ListRange","ListRandom","PushPopType","Pointer","PathByAppendingComponent","Divert","stackPushType","pushesToStack","otherDivert","hasVariableTarget","variableDivertName","targetStr","targetLineNum","isConditional","Function","targetPathString","_targetPath","targetObj","targetPointer","Resolve","_targetPointer","ResolvePath","lastComponent","StartOf","copy","CompactPathString","ChoicePoint","onceOnly","pathOnChoice","targetString","_pathOnChoice","choiceTargetObj","choiceTarget","hasCondition","hasStartContent","hasChoiceOnlyContent","isInvisibleDefault","VariableReference","pathStr","pathStringForCount","pathForCount","VariableAssignment","isNewDeclaration","isGlobal","Void","NativeFunctionCall","GenerateNativeFunctionsIfNecessary","numberOfParameters","_isPrototype","parameters","_prototype","Call","hasList","CallBinaryListOperation","coercedParams","CoerceValuesToSingleType","coercedType","CallType","parametersOfSingleType","param1","valType","val1","paramCount","_operationFuncs","opForTypeObj","param2","val2","opForType","resultVal","CallListIncrementOperation","v1","v2","op","isTruthy","listIntParams","listVal","resultInkList","listItemKey","listItemValue","listItem","intOp","targetInt","itemOrigin","incrementedItem","TryGetItemWithValue","parametersIn","specialCaseList","parametersOut","inkObjectVal","originOfMaxItem","castedValue","Cast","_name","_nativeFunctions","_numberOfParameters","functionName","t","AddIntBinaryOp","Subtract","Multiply","Divide","round","Mod","AddIntUnaryOp","Negate","Equal","Greater","Less","GreaterThanOrEquals","LessThanOrEquals","NotEquals","Not","And","Or","Max","Min","Pow","pow","Floor","Identity","Ceiling","AddFloatBinaryOp","AddFloatUnaryOp","floor","ceil","AddStringBinaryOp","Has","includes","Hasnt","AddListBinaryOp","Union","Without","Contains","Intersect","GreaterThan","LessThan","AddListUnaryOp","Invert","inverse","All","all","ListMin","MinAsList","ListMax","MaxAsList","ValueOfList","divertTargetsEqual","d1","d2","divertTargetsNotEqual","AddOpToNativeFunc","nativeFunc","AddOpFuncForType","Tag","tagText","text","Choice","ListDefinition","_items","_itemNameToValues","ListDefinitionsOrigin","lists","_lists","_allUnambiguousListValueCache","listValue","definition","listOfLists","JsonSerialisation","serialisables","jArray","s","RuntimeObjectToJToken","skipLast","count","jTok","JTokenToRuntimeObject","dictionary","jsonObj","jObject","dict","jObj","token","firstChar","_controlCommandNames","cmdName","CallExistsWithName","CallWithName","isArray","propValue","varPtr","isDivert","divPushType","external","Tunnel","divert","isExternal","target","externalArgs","choice","pathStringOnChoice","readCountVarRef","isVarAss","isGlobalVar","varName","isNewDecl","varAss","listContent","rawList","namesAsObjs","nameToVal","JObjectToChoice","JArrayToContainer","ContainerToJArray","divTypeKey","choicePoint","floatVal","strVal","InkListToJObject","divTargetVal","divTargetJsonObj","varPtrVal","varPtrJsonObj","glue","controlCmd","varRef","readCountPath","voidObj","tag","ChoiceToJObject","ListToJArray","countFlags","terminatingObj","DictionaryRuntimeObjsToJObject","subContainerJArray","attrJObj","Object","keys","JArrayToRuntimeObjList","namedContentItem","namedSubContainer","sourcePath","originalThreadIndex","listDefJson","defsObj","allDefs","nameValueKey","nameValue","TOTAL_VALUES","PRNG","seed","next","Stopwatch","startTime","Date","getTime","nVal","isFinite","Story","json","_mainContentContainer","jsonString","_listDefinitions","_externals","rootObject","versionObj","formatFromFile","inkVersionCurrent","inkVersionMinimumCompatible","rootToken","listDefsObj","JTokenToListDefinitions","ResetState","rootContainerJsonList","ListDefinitionsToJToken","IfAsyncWeCant","_state","StoryState","variablesState","ObserveVariableChange","VariableStateDidChangeEvent","bind","ResetGlobals","ResetErrors","ForceEnd","originalPointer","state","currentPointer","ChoosePath","ContinueInternal","SnapshotDefaultGlobals","ContinueAsync","currentText","millisecsLimitAsync","_hasValidatedExternals","ValidateExternalBindings","_profiler","PreContinue","isAsyncTimeLimited","_recursiveContinueCount","_asyncContinueActive","canContinue","didSafeExit","ResetOutput","batchObservingVariableChanges","durationStopwatch","Start","outputStreamEndsInNewline","ContinueSingleStep","e","AddError","ElapsedMilliseconds","Stop","_stateAtLastNewline","RestoreStateSnapshot","callStack","canPopThread","generatedChoices","_temporaryEvaluationContainer","CanPop","canPop","PostContinue","PreStep","Step","PostStep","elementIsEvaluateFromGame","TryFollowDefaultInvisibleChoice","PreSnapshot","inStringEvaluation","currentTags","change","CalculateNewlineOutputStateChange","OutputStateChange","ExtendedBeyondNewline","NewlineRemoved","StateSnapshot","PostSnapshot","prevText","currText","prevTagCount","currTagCount","newlineStillExists","charAt","NoChange","Continue","mainContentContainer","namedContainer","pathLengthToUse","Warning","Copy","shouldAddToStream","pointer","containerToEnter","VisitContainer","currentContentObj","isLogicOrFlowControl","PerformLogicAndFlowControl","ProcessChoice","varPointer","contextIdx","ContextForVariableNamed","inExpressionEvaluation","PushEvaluationStack","PushToOutputStream","NextContent","PushThread","atStart","IncrementVisitCountForContainer","RecordTurnIndexVisitToContainer","previousPointer","_prevContainers","resolvedPreviousAncestor","prevAncestor","currentChildOfContainer","currentContainerAncestor","enteringAtStart","showChoice","conditionValue","PopEvaluationStack","IsTruthy","startText","choiceOnlyText","choiceOnlyStrVal","startStrVal","visitCount","VisitCountForContainer","threadAtGeneration","ForkThread","truthy","divTarget","currentDivert","varContents","GetVariableWithName","intContent","errorMessage","divertedPointer","PointerAtPath","CallExternalFunction","Push","outputStream","sourceName","evalCommand","evaluationStack","output","PeekEvaluationStack","popType","overrideTunnelReturnTarget","popped","TryExitFunctionEvaluationFromGame","currentElement","names","expected","errorMsg","PopCallStack","contentStackForString","outputCountConsumed","command","PopFromOutputStream","reverse","choiceCount","currentTurnIndex","extraNote","divertTarget","correctObj","eitherCount","TurnsSinceForContainer","maxInt","minInt","randomRange","resultSeed","storySeed","previousRandom","random","nextRandom","chosenValue","shuffleIndex","NextSequenceShuffleIndex","PopThread","listNameVal","generatedListValue","foundItem","targetList","ListWithSubRange","listItemIndex","listEnumerator","entries","randomItem","assignedVal","Assign","foundValue","containerForCount","defaultVal","TryGetDefaultVariableValue","SetGlobal","func","funcParams","resetCallstack","ResetCallstack","funcDetail","callStackTrace","PassArgumentsToEvaluationStack","activityStr","incrementingTurnIndex","SetChosenPath","VisitChangedContainersDueToDivert","choiceIdx","choices","currentChoices","choiceToChoose","currentThread","KnotContainerWithName","returnTextOutput","trim","funcContainer","outputStreamBefore","StartFunctionEvaluationFromGame","stringOutput","textOutput","CompleteFunctionEvaluationFromGame","returned","exprContainer","startCallStackHeight","elements","GoToStart","evalStackHeight","endStackHeight","funcName","numberOfArguments","fallbackFunctionContainer","foundExternal","allowExternalFunctionFallbacks","poppedObj","valueObj","funcResult","returnObj","BindExternalFunctionGeneral","coercedArgs","TryCoerce","o","missingExternals","Set","from","innerContent","fallbackFound","add","observer","_variableObservers","GlobalVariableExistsWithName","variableNames","observers","ObserveVariable","specificVariableName","splice","newValueObj","TagsAtStartOfFlowContainerWithPathString","pathString","flowContainer","firstContent","tags","successfulPointerIncrement","IncrementContentPointer","didPop","successfulIncrement","nextAncestor","indexInAncestor","allChoices","invisibleChoices","filter","containerPathStr","visitCounts","turnIndices","numElementsIntVal","seqContainer","numElements","seqCountVal","seqCount","loopIndex","iterationIndex","seqPathStr","sequenceHash","charCodeAt","randomSeed","unpickedIndices","chosen","chosenIndex","isWarning","currentDebugMetadata","errorTypeStr","lineNum","endLineNumber","fileName","currentErrors","currentWarnings","hasError","hasWarning","outputObj","CallStack","storyContext","_startOfRoot","Reset","toCopy","_threads","otherThread","Thread","callstack","Element","jThreads","jThreadTok","jThreadObj","thread","_threadCounter","jsonToken","newThread","threadIndex","forkedThread","externalEvaluationStackHeight","outputStreamLengthWithPushed","element","evaluationStackHeightWhenPushed","functionStartInOutputStream","pop","currentElementIndex","contextElement","varValue","temporaryVariables","declareNew","RetainListOriginsForAssignment","filtered","cs","FunctionEvaluationFromGame","isCurrent","jThreadCallstack","jElTok","jElementObj","pushPopType","currentContainerPathStr","currentContainerPathStrToken","threadPointerResult","el","jObjTemps","JObjectToDictionaryRuntimeObjs","prevContentObjPath","prevPath","threadJObj","resolvedPointer","VariablesState","listDefsOrigin","_globalVariables","_callStack","_listDefsOrigin","Proxy","$","variableChangedEventCallbacks","callback","_defaultGlobalVariables","variableChangedEvent","_batchObservingVariableChanges","_changedVariables","GetRawVariableWithName","ValueAtVariablePointer","variableValue","FindSingleItemListWithName","GetTemporaryVariableWithName","setGlobal","fullyResolvedVariablePointer","ResolveVariablePointer","existingPointer","SetTemporaryVariable","GetContextIndexOfVariableNamed","valueOfVariablePointedTo","doubleRedirectionPointer","currentValue","story","_outputStream","OutputStreamDirty","_evaluationStack","_variablesState","_visitCounts","_turnIndices","_currentTurnIndex","timeSeed","_currentChoices","indented","ToJson","visitCountOut","currentWhitespaceStart","startOfLine","_currentErrors","_currentWarnings","CopyFrom","objs","listText","TrySplittingHeadTailWhitespace","textObj","PushToOutputStreamIndividual","single","headFirstNewlineIdx","headLastNewlineIdx","tailLastNewlineIdx","tailFirstNewlineIdx","listTexts","innerStrStart","innerStrEnd","leadingSpaces","innerStrText","numSpaces","trailingSpaces","includeInOutput","TrimNewlinesFromOutputStream","functionTrimIndex","currEl","glueTrimIndex","g","trimIndex","isNonWhitespace","RemoveExistingGlue","callStackElements","outputStreamContainsContent","removeWhitespaceFrom","cmd","txt","n","numberOfObjects","functionStartPoint","TrimWhitespaceFromFunctionEnd","Pop","newPointer","originalEvaluationStackHeight","returnedObj","returnVal","_outputStreamTextDirty","_outputStreamTagsDirty","depth","textContent","_currentText","CleanOutputWhitespace","_currentTags","choiceThreads","ThreadWithIndex","GetJsonToken","IntDictionaryToJObject","kInkSaveStateVersion","jSaveVersion","kMinCompatibleLoadVersion","SetJsonToken","currentDivertTargetPath","divertPath","JObjectToIntDictionary","jChoiceThreads","foundActiveThread","jSavedChoiceThread"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAAaA,IAAb;;AAAA;;;;SAYOC,WAAL,GAAmB,EAAnB;SACKC,iBAAL,GAAyB,IAAzB;SACKC,WAAL,GAAmB,KAAnB;;QAEI,OAAOC,SAAS,CAAC,CAAD,CAAhB,IAAuB,QAA3B,EAAoC;UAC/BC,gBAAgB,GAAGD,SAAS,CAAC,CAAD,CAAhC;WACKC,gBAAL,GAAwBA,gBAAxB;KAFD,MAIK,IAAID,SAAS,CAAC,CAAD,CAAT,YAAwBJ,IAAI,CAACM,SAA7B,IAA0CF,SAAS,CAAC,CAAD,CAAT,YAAwBJ,IAAtE,EAA2E;UAC3EO,IAAI,GAAGH,SAAS,CAAC,CAAD,CAApB;UACII,IAAI,GAAGJ,SAAS,CAAC,CAAD,CAApB;;WACKH,WAAL,CAAiBQ,IAAjB,CAAsBF,IAAtB;;WACKN,WAAL,GAAmB,KAAKA,WAAL,CAAiBS,MAAjB,CAAwBF,IAAI,CAACP,WAA7B,CAAnB;KAJI,MAMA,IAAIG,SAAS,CAAC,CAAD,CAAT,YAAwBO,KAA5B,EAAkC;UAClCJ,KAAI,GAAGH,SAAS,CAAC,CAAD,CAApB;UACIQ,QAAQ,GAAG,CAAC,CAACR,SAAS,CAAC,CAAD,CAA1B;WACKH,WAAL,GAAmB,KAAKA,WAAL,CAAiBS,MAAjB,CAAwBH,KAAxB,CAAnB;WACKJ,WAAL,GAAmBS,QAAnB;;;;;;iCAoDkBC,KAlFrB;aAmFS,KAAKZ,WAAL,CAAiBY,KAAjB,CAAP;;;;wCAE0BC,YArF5B;UAsFMC,CAAC,GAAG,IAAIf,IAAJ,EAAR;UAEIgB,WAAW,GAAG,CAAlB;;WACK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGH,YAAY,CAACb,WAAb,CAAyBiB,MAA7C,EAAqD,EAAED,CAAvD,EAA0D;YACrDH,YAAY,CAACb,WAAb,CAAyBgB,CAAzB,EAA4BE,QAAhC,EAA0C;UACzCH,WAAW;SADZ,MAEO;;;;;WAKH,IAAIC,EAAC,GAAG,CAAb,EAAgBA,EAAC,GAAG,KAAKhB,WAAL,CAAiBiB,MAAjB,GAA0BF,WAA9C,EAA2D,EAAEC,EAA7D,EAAgE;QAC/DF,CAAC,CAACd,WAAF,CAAcQ,IAAd,CAAmB,KAAKR,WAAL,CAAiBgB,EAAjB,CAAnB;;;WAGI,IAAIA,GAAC,GAAGD,WAAb,EAA0BC,GAAC,GAAGH,YAAY,CAACb,WAAb,CAAyBiB,MAAvD,EAA+D,EAAED,GAAjE,EAAoE;QACnEF,CAAC,CAACd,WAAF,CAAcQ,IAAd,CAAmBK,YAAY,CAACb,WAAb,CAAyBgB,GAAzB,CAAnB;;;aAGMF,CAAP;;;;;aAoCO,KAAKV,gBAAZ;;;;2BAEae,SA/If;UAgJMA,SAAS,IAAI,IAAjB,EACC,OAAO,KAAP;UAEGA,SAAS,CAACnB,WAAV,CAAsBiB,MAAtB,IAAgC,KAAKjB,WAAL,CAAiBiB,MAArD,EACC,OAAO,KAAP;UAEGE,SAAS,CAACC,UAAV,IAAwB,KAAKA,UAAjC,EACC,OAAO,KAAP;;WAGI,IAAIJ,CAAC,GAAG,CAAR,EAAWK,CAAC,GAAGF,SAAS,CAACnB,WAAV,CAAsBiB,MAA1C,EAAkDD,CAAC,GAAGK,CAAtD,EAAyDL,CAAC,EAA1D,EAA6D;;;YAGxD,CAACG,SAAS,CAACnB,WAAV,CAAsBgB,CAAtB,EAAyBM,MAAzB,CAAgC,KAAKtB,WAAL,CAAiBgB,CAAjB,CAAhC,CAAL,EAA2D,OAAO,KAAP;;;aAGrD,IAAP;;;;6CAE+BO,CAlKjC;UAmKMT,CAAC,GAAG,IAAIf,IAAJ,EAAR;;MACAe,CAAC,CAACd,WAAF,CAAcQ,IAAd,CAAmBgB,KAAnB,CAAyBV,CAAC,CAACd,WAA3B,EAAwC,KAAKA,WAA7C;;MACAc,CAAC,CAACd,WAAF,CAAcQ,IAAd,CAAmBe,CAAnB;;aACOT,CAAP;;;;;aApIO,KAAKZ,WAAZ;;;;;aAGO,KAAKF,WAAL,CAAiBiB,MAAxB;;;;;UAGI,KAAKjB,WAAL,CAAiBiB,MAAjB,GAA0B,CAA9B,EAAiC;eACzB,KAAKjB,WAAL,CAAiB,CAAjB,CAAP;OADD,MAEO;eACC,IAAP;;;;;;UAIG,KAAKA,WAAL,CAAiBiB,MAAjB,IAA2B,CAA/B,EAAkC;;;YAG7BQ,SAAS,GAAG,KAAKzB,WAAL,CAAiB0B,KAAjB,CAAuB,CAAvB,EAA0B,KAAK1B,WAAL,CAAiBiB,MAA3C,CAAhB;;eACO,IAAIlB,IAAJ,CAAS0B,SAAT,CAAP;OAJD,MAMK;eACG1B,IAAI,CAAC4B,IAAZ;;;;;;aAIM,KAAK3B,WAAL,CAAiBiB,MAAxB;;;;;UAGIW,gBAAgB,GAAG,KAAK5B,WAAL,CAAiBiB,MAAjB,GAA0B,CAAjD;;UACIW,gBAAgB,IAAI,CAAxB,EAA2B;eACnB,KAAK5B,WAAL,CAAiB4B,gBAAjB,CAAP;OADD,MAEO;eACC,IAAP;;;;;;WAII,IAAIZ,CAAC,GAAG,CAAR,EAAWK,CAAC,GAAG,KAAKrB,WAAL,CAAiBiB,MAArC,EAA6CD,CAAC,GAAGK,CAAjD,EAAoDL,CAAC,EAArD,EAAwD;YACnD,CAAC,KAAKhB,WAAL,CAAiBgB,CAAjB,EAAoBa,OAAzB,EAAiC;iBACzB,IAAP;;;;aAGK,KAAP;;;;;UAkCI,KAAK5B,iBAAL,IAA0B,IAA9B,EAAoC;aAC9BA,iBAAL,GAAyB,KAAKD,WAAL,CAAiB8B,IAAjB,CAAsB,GAAtB,CAAzB;YACI,KAAKV,UAAT,EAAqB,KAAKnB,iBAAL,GAAyB,MAAM,KAAKA,iBAApC;;;aAGf,KAAKA,iBAAZ;KAjHF;sBAmHsB8B,KAnHtB;WAoHO/B,WAAL,CAAiBiB,MAAjB,GAA0B,CAA1B;WAEKhB,iBAAL,GAAyB8B,KAAzB;UAEI,KAAK9B,iBAAL,IAA0B,IAA1B,IAAkC,KAAKA,iBAAL,IAA0B,EAAhE,EAAoE;;UAEhE,KAAKA,iBAAL,CAAuB,CAAvB,KAA6B,GAAjC,EAAsC;aAChCC,WAAL,GAAmB,IAAnB;aACKD,iBAAL,GAAyB,KAAKA,iBAAL,CAAuB+B,SAAvB,CAAiC,CAAjC,CAAzB;;;UAGGC,gBAAgB,GAAG,KAAKhC,iBAAL,CAAuBiC,KAAvB,CAA6B,GAA7B,CAAvB;;;;;;;6BACgBD,gBAAhB,8HAAkC;cAAzBE,GAAyB;;;;;cAI7B,8BAA8BC,IAA9B,CAAmCD,GAAnC,CAAJ,EAA4C;iBACtCnC,WAAL,CAAiBQ,IAAjB,CAAsB,IAAIT,IAAI,CAACM,SAAT,CAAmBgC,QAAQ,CAACF,GAAD,CAA3B,CAAtB;WADD,MAGI;iBACEnC,WAAL,CAAiBQ,IAAjB,CAAsB,IAAIT,IAAI,CAACM,SAAT,CAAmB8B,GAAnB,CAAtB;;;;;;;;;;;;;;;;;;;;;UA3DEG,IAAI,GAAG,IAAIvC,IAAJ,EAAX;MACAuC,IAAI,CAACpC,WAAL,GAAmB,IAAnB;aACOoC,IAAP;;;;;;AA9EavC,aAAA,GAAW,GAAX;;AAyKf,WAAiBA;MACHM;;;uBAIAkC,WAAZ;;;WACM3B,KAAL,GAAa,CAAC,CAAd;WACK4B,IAAL,GAAY,IAAZ;;UACI,OAAOD,WAAP,IAAsB,QAA1B,EAAmC;aAC7BC,IAAL,GAAYD,WAAZ;OADD,MAGI;aACE3B,KAAL,GAAa2B,WAAb;;;;;;;YAcG,KAAKV,OAAT,EAAkB;iBACV,KAAKjB,KAAL,CAAW6B,QAAX,EAAP;SADD,MAEO;iBACC,KAAKD,IAAZ;;;;;6BAGYE;YACTA,SAAS,IAAI,IAAb,IAAqBA,SAAS,CAACb,OAAV,IAAqB,KAAKA,OAAnD,EAA4D;cACvD,KAAKA,OAAT,EAAkB;mBACV,KAAKjB,KAAL,IAAc8B,SAAS,CAAC9B,KAA/B;WADD,MAEO;mBACC,KAAK4B,IAAL,IAAaE,SAAS,CAACF,IAA9B;;;;eAIK,KAAP;;;;;eAzBO,KAAK5B,KAAL,IAAc,CAArB;;;;;eAGO,KAAK4B,IAAL,IAAazC,IAAI,CAAC4C,QAAzB;;;;;eAIO,IAAItC,SAAJ,CAAcN,IAAI,CAAC4C,QAAnB,CAAP;;;;;;;EAtBW5C,cAAA,YAAA;CADd,EAAiBA,IAAI,KAAJA,IAAI,KAAA,CAArB;;IC1KiB6C;;AAAjB,WAAiBA;;WAEAC,UAAhB,CAA8BC,QAA9B,EAA6CC,IAA7C,EAAgEC,OAAhE;IACCC,MAAM,CAACH,QAAQ,YAAYC,IAArB,EAA2BC,OAA3B,CAAN;;;EADeJ,gBAAA,aAAA;;WAIAK,MAAhB,CAAuBC,SAAvB,EAA2CF,OAA3C;QACK,CAACE,SAAL,EAAgB;;UAEX,OAAOF,OAAP,KAAmB,WAAvB,EAAoC;QACnCG,OAAO,CAACC,IAAR,CAAaJ,OAAb;;;UAGGG,OAAO,CAACE,KAAZ,EAAmB;QAClBF,OAAO,CAACE,KAAR;;;YAGK,EAAN;;;;EAXcT,YAAA,SAAA;CANjB,EAAiBA,KAAK,KAALA,KAAK,KAAA,CAAtB;;ACEA;AAEA,SAAgBU,SAAYC,KAAUR;MACjCQ,GAAG,YAAYR,IAAnB,EAAyB;WACjBS,mBAAmB,CAACD,GAAD,AAAA,CAA1B;GADD,MAEO;WACC,IAAP;;;AAIF,SAAgBE,WAAcF,KAAUR;MACnCQ,GAAG,YAAYR,IAAnB,EAAyB;WACjBS,mBAAmB,CAACD,GAAD,AAAA,CAA1B;GADD,MAEO;UACA,IAAIG,KAAJ,WAAaH,GAAb,6BAAmCR,IAAnC,EAAN;;;AAIF,SAAgBY,iBAAiBJ;MAC5B,OAAOA,GAAP,KAAe,QAAnB,EAA6B;WACrBA,GAAP;GADD,MAEO;UACA,IAAIG,KAAJ,WAAaH,GAAb,sBAAN;;;;;;AAOF,SAAgBK,sBAAsBL;MACjCA,GAAG,CAACM,YAAJ,IAAoBN,GAAG,CAACf,IAA5B,EAAkC;WAC1Be,GAAP;;;SAGM,IAAP;;AAGD,SAAgBO,gBAAmBP;MAC9B,OAAOA,GAAP,KAAe,WAAnB,EAAgC;WACxB,IAAP;;;SAGMA,GAAP;;;AAGD,SAASC,mBAAT,CAAgCD,GAAhC,EAA0CR,IAA1C;SACQQ,GAAP;;;AChDD;;;;;;;;;;AAUA,IAAaQ,aAAb;;AAAA;;;;;;;;;;mBAAmCL,KAAnC;;;;;;AAMA,SAAgBM,mBAAmBxB;QAC5B,IAAIuB,aAAJ,WAAqBvB,IAArB,2BAAN;;;ICTYyB,SAAb;;AAAA;;;;eAEQ,GAA2B,IAA3B;uBAoBC,GAAuC,IAAvC;cAoDA,GAAqB,IAArB;;;;;0CAlDqB3B,IAxB9B;UAyBMA,IAAI,KAAK,IAAb,EACC,OAAO,IAAP;;UAGG4B,IAAI,GAAG,KAAKC,oBAAhB;;UACID,IAAJ,EAAU;YACLE,aAAa,GAAGF,IAAI,CAACG,aAAL,CAAmB/B,IAAnB,EAAyBiB,GAA7C;;YACIa,aAAJ,EAAmB;cACdE,EAAE,GAAGF,aAAa,CAACG,aAAvB;;cACID,EAAE,KAAK,IAAX,EAAiB;mBACTA,EAAE,CAACE,eAAV;;;;;aAKI,IAAP;;;;gCAoCkBlC,IA5EpB;UA6EMA,IAAI,KAAK,IAAb,EAAmB,OAAO0B,kBAAkB,CAAC,MAAD,CAAzB;;UACf1B,IAAI,CAAClB,UAAT,EAAqB;YAChBqD,gBAAgB,GAAGnB,QAAQ,CAAC,IAAD,EAAOoB,SAAP,CAA/B;;YAEID,gBAAgB,KAAK,IAAzB,EAA+B;UAC9B7B,KAAK,CAACK,MAAN,CAAa,KAAK0B,MAAL,KAAgB,IAA7B,EAAmC,4DAAnC;UACAF,gBAAgB,GAAGnB,QAAQ,CAAC,KAAKqB,MAAN,EAAcD,SAAd,CAA3B;UACA9B,KAAK,CAACK,MAAN,CAAawB,gBAAgB,KAAK,IAAlC,EAAwC,mCAAxC;UACA7B,KAAK,CAACK,MAAN,CAAaX,IAAI,CAACsC,YAAL,CAAkB,CAAlB,EAAqB1D,QAAlC;UACAoB,IAAI,GAAGA,IAAI,CAAC/B,IAAZ;;;YAGGkE,gBAAgB,KAAK,IAAzB,EAA+B;iBAAST,kBAAkB,CAAC,kBAAD,CAAzB;;;eAC1BS,gBAAgB,CAACJ,aAAjB,CAA+B/B,IAA/B,CAAP;OAZD,MAaO;YACFuC,gBAAgB,GAAG,KAAKV,oBAA5B;;YACIU,gBAAgB,KAAK,IAAzB,EAA+B;iBAASb,kBAAkB,CAAC,kBAAD,CAAzB;;;eAC1Ba,gBAAgB,CAACR,aAAjB,CAA+B/B,IAA/B,CAAP;;;;;0CAI2BwC,UAlG9B;UAmGMC,OAAO,GAAG,KAAKzC,IAAnB;UAEI0C,aAAa,GAAGC,IAAI,CAACC,GAAL,CAASJ,UAAU,CAAC7D,MAApB,EAA4B8D,OAAO,CAAC9D,MAApC,CAApB;UACIkE,uBAAuB,GAAG,CAAC,CAA/B;;WAEK,IAAInE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGgE,aAApB,EAAmC,EAAEhE,CAArC,EAAwC;YACnCoE,OAAO,GAAGL,OAAO,CAACH,YAAR,CAAqB5D,CAArB,CAAd;YACI0B,SAAS,GAAGoC,UAAU,CAACF,YAAX,CAAwB5D,CAAxB,CAAhB;;YAEIoE,OAAO,CAAC9D,MAAR,CAAeoB,SAAf,CAAJ,EAA+B;UAC9ByC,uBAAuB,GAAGnE,CAA1B;SADD,MAEO;;;;;;UAMJmE,uBAAuB,IAAI,CAAC,CAAhC,EACC,OAAOL,UAAP;UAEGO,eAAe,GAAIN,OAAO,CAACO,cAAR,GAAuB,CAAxB,GAA6BH,uBAAnD;UAEII,YAAY,GAAqB,EAArC;;WAEI,IAAIC,EAAE,GAAG,CAAb,EAAgBA,EAAE,GAAGH,eAArB,EAAsC,EAAEG,EAAxC;QACCD,YAAY,CAAC/E,IAAb,CAAkBT,IAAI,CAACM,SAAL,CAAeoF,QAAf,EAAlB;;;WAEI,IAAIC,IAAI,GAAGP,uBAAuB,GAAG,CAA1C,EAA6CO,IAAI,GAAGZ,UAAU,CAACQ,cAA/D,EAA+E,EAAEI,IAAjF;QACCH,YAAY,CAAC/E,IAAb,CAAkBsE,UAAU,CAACF,YAAX,CAAwBc,IAAxB,CAAlB;;;UAEGC,YAAY,GAAG,IAAI5F,IAAJ,CAASwF,YAAT,EAAuB,IAAvB,CAAnB;aACOI,YAAP;;;;sCAGwBxE,SArI1B;UAsIMyE,aAAa,GAAG,IAApB;UACIC,eAAe,GAAG,IAAtB;;UAEI1E,SAAS,CAACC,UAAd,EAA0B;QACzByE,eAAe,GAAG1E,SAAS,CAACf,gBAA5B;QACAwF,aAAa,GAAG,KAAKtD,IAAL,CAAUwD,mBAAV,CAA8B3E,SAA9B,EAAyCf,gBAAzD;OAFD,MAIK;YACAuF,YAAY,GAAG,KAAKI,qBAAL,CAA2B5E,SAA3B,CAAnB;QACA0E,eAAe,GAAGF,YAAY,CAACvF,gBAA/B;QACAwF,aAAa,GAAGzE,SAAS,CAACf,gBAA1B;;;UAGGyF,eAAe,CAAC5E,MAAhB,GAAyB2E,aAAa,CAAC3E,MAA3C,EACC,OAAO4E,eAAP,CADD,KAGC,OAAOD,aAAP;;;;;YAYKlC,KAAK,CAAC,0CAAD,CAAX;KAlKF;;;;;;;6BAwKiBH,GAxKjB,EAwK2ByC,IAxK3B,EAwKsCjE,KAxKtC;UAyKMwB,GAAG,CAACyC,IAAD,CAAP,EACCzC,GAAG,CAACyC,IAAD,CAAH,GAAY,IAAZ;MAEDzC,GAAG,CAACyC,IAAD,CAAH,GAAYjE,KAAZ;UAEIwB,GAAG,CAACyC,IAAD,CAAP,EACCzC,GAAG,CAACyC,IAAD,CAAH,CAAUrB,MAAV,GAAmB,IAAnB;;;;;UA1KG,KAAKsB,cAAL,KAAwB,IAA5B,EAAkC;YAC7B,KAAKtB,MAAT,EAAiB;iBACT,KAAKA,MAAL,CAAYJ,aAAnB;;;;aAIK,KAAK0B,cAAZ;KAXF;sBAcmBlE,KAdnB;WAeOkE,cAAL,GAAsBlE,KAAtB;;;;;aAIO,KAAKkE,cAAZ;;;;;UAyBI,KAAKC,KAAL,IAAc,IAAlB,EAAwB;YAEnB,KAAKvB,MAAL,IAAe,IAAnB,EAAyB;eACnBuB,KAAL,GAAa,IAAInG,IAAJ,EAAb;SADD,MAEO;cACFoG,KAAK,GAAqB,EAA9B;cAEIC,KAAK,GAAc,IAAvB;cACIC,SAAS,GAAG/C,QAAQ,CAAC8C,KAAK,CAACzB,MAAP,EAAeD,SAAf,CAAxB;;iBAEO2B,SAAS,KAAK,IAArB,EAA2B;gBAEtBC,UAAU,GAAG1C,qBAAqB,CAACwC,KAAD,CAAtC;;gBACIE,UAAU,IAAI,IAAd,IAAsBA,UAAU,CAACzC,YAArC,EAAmD;cAClDsC,KAAK,CAACI,OAAN,CAAc,IAAIxG,IAAI,CAACM,SAAT,CAAmBiG,UAAU,CAAC9D,IAA9B,CAAd;aADD,MAEO;cACN2D,KAAK,CAACI,OAAN,CAAc,IAAIxG,IAAI,CAACM,SAAT,CAAmBgG,SAAS,CAACG,OAAV,CAAkBC,OAAlB,CAA0BL,KAA1B,CAAnB,CAAd;;;YAGDA,KAAK,GAAGC,SAAR;YACAA,SAAS,GAAG/C,QAAQ,CAAC+C,SAAS,CAAC1B,MAAX,EAAmBD,SAAnB,CAApB;;;eAGIwB,KAAL,GAAa,IAAInG,IAAJ,CAASoG,KAAT,CAAb;;;;aAKK,KAAKD,KAAZ;;;;;UAkFIQ,QAAQ,GAAc,IAA1B;;aACOA,QAAQ,CAAC/B,MAAhB,EAAwB;QACvB+B,QAAQ,GAAGA,QAAQ,CAAC/B,MAApB;;;aAEMrB,QAAQ,CAACoD,QAAD,EAAWhC,SAAX,CAAf;;;;;;;ICtKWiC,aAAb;;AAAA;yBAIaxE,GAAZ;;;IACCA,GAAG,GAAI,OAAOA,GAAP,KAAe,WAAhB,GAA+BA,GAAG,CAACM,QAAJ,EAA/B,GAAgD,EAAtD;SACKmE,MAAL,GAAczE,GAAd;;;;;2BAKaA,GAXf;UAYMA,GAAG,KAAK,IAAZ,EAAkB;aACZyE,MAAL,IAAezE,GAAf;;;;;+BAGgBA,GAhBnB;UAiBM,OAAOA,GAAP,KAAe,WAAnB,EAAgC,KAAK0E,MAAL,CAAY1E,GAAZ;WAC3ByE,MAAL,IAAe,IAAf;;;;iCAEmBE,MApBrB;wCAoBwCC;QAAAA;;;;WAEjCH,MAAL,IAAeE,MAAM,CAACE,OAAP,CAAe,UAAf,EAA2B,UAACC,KAAD,EAAgBC,GAAhB;eAClC,OAAOH,IAAI,CAACG,GAAD,CAAX,IAAoB,WAApB,GAAkCH,IAAI,CAACG,GAAD,CAAtC,GAA8CD,KAArD;OADc,CAAf;;;;;aAKO,KAAKL,MAAZ;;;;;aAlBO,KAAKA,MAAL,CAAY3F,MAAnB;;;;;;;ICJWkG,WAAb;;AAAA;;;;mBAEiB,GAA4B,IAA5B;iBACA,GAA0B,IAA1B;;QAKX,OAAOhH,SAAS,CAAC,CAAD,CAAhB,KAAwB,WAA5B,EAAwC;UACnCiH,UAAU,GAAGjH,SAAS,CAAC,CAAD,CAA1B;UACIkH,QAAQ,GAAGlH,SAAS,CAAC,CAAD,CAAxB;WAEKiH,UAAL,GAAkBA,UAAlB;WACKC,QAAL,GAAgBA,QAAhB;KALD,MAOK,IAAIlH,SAAS,CAAC,CAAD,CAAb,EAAiB;UACjBmH,QAAQ,GAAGnH,SAAS,CAAC,CAAD,CAAxB;UAEIoH,SAAS,GAAGD,QAAQ,CAAC7E,QAAT,GAAoBP,KAApB,CAA0B,GAA1B,CAAhB;WACKkF,UAAL,GAAkBG,SAAS,CAAC,CAAD,CAA3B;WACKF,QAAL,GAAgBE,SAAS,CAAC,CAAD,CAAzB;;;;;;;aAaM,KAAKD,QAAZ;;;;2BAEa/D,GAnCf;UAoCMA,GAAG,YAAY4D,WAAnB,EAAgC;YAC3BK,SAAS,GAAGjE,GAAhB;eACOiE,SAAS,CAACH,QAAV,IAAsB,KAAKA,QAA3B,IACHG,SAAS,CAACJ,UAAV,IAAwB,KAAKA,UADjC;;;aAIM,KAAP;KA1CF;;;;;;;;;;;;aAsDS,IAAID,WAAJ,CAAgB,KAAKC,UAArB,EAAiC,KAAKC,QAAtC,CAAP;;;;;;;;;;;aAQOI,IAAI,CAACC,SAAL,CAAe;QAACN,UAAU,EAAE,KAAKA,UAAlB;QAA8BC,QAAQ,EAAE,KAAKA;OAA5D,CAAP;;;;;;;;;aAnCO,KAAKD,UAAL,IAAmB,IAAnB,IAA2B,KAAKC,QAAL,IAAiB,IAAnD;;;;;aAGO,CAAE,KAAKD,UAAL,KAAoB,IAArB,GAA6B,KAAKA,UAAlC,GAA+C,GAAhD,IAAuD,GAAvD,GAA6D,KAAKC,QAAzE;;;;sCAsC+BM,GApEjC;UAqEMpE,GAAG,GAAGkE,IAAI,CAACG,KAAL,CAAWD,GAAX,CAAV;UACI,CAACR,WAAW,CAACU,iBAAZ,CAA8BtE,GAA9B,CAAL,EAAyC,OAAO4D,WAAW,CAACW,IAAnB;UAErCC,WAAW,GAAGxE,GAAlB;aAEO,IAAI4D,WAAJ,CAAgBY,WAAW,CAACX,UAA5B,EAAwCW,WAAW,CAACV,QAApD,CAAP;;;;;;;;;sCAOgCW,IAjFlC;UAkFM,QAAOA,IAAP,MAAgB,QAApB,EAA8B,OAAO,KAAP;UAC1B,CAACA,IAAI,CAACC,cAAL,CAAoB,YAApB,CAAD,IAAsC,CAACD,IAAI,CAACC,cAAL,CAAoB,UAApB,CAA3C,EAA4E,OAAO,KAAP;UACxE,OAAOD,IAAI,CAACZ,UAAZ,KAA2B,QAA3B,IAAuC,OAAOY,IAAI,CAACZ,UAAZ,KAA2B,IAAtE,EAA4E,OAAO,KAAP;UACxE,OAAOY,IAAI,CAACX,QAAZ,KAAyB,QAAzB,IAAqC,OAAOW,IAAI,CAACX,QAAZ,KAAyB,IAAlE,EAAwE,OAAO,KAAP;aAEjE,IAAP;;;;;aA/DO,IAAIF,WAAJ,CAAgB,IAAhB,EAAsB,IAAtB,CAAP;;;;;;AAmEF,IAAae,OAAb;;AAAA;;;;;;;;;;;;iFAWS;UACF/H,UAAS,CAAC,CAAD,CAAT,YAAwB+H,OAA5B,EAAoC;eAC5B/H,UAAS,CAAC,CAAD,CAAhB;OADD,MAGI;eACIgI,SAAP;;KALI,EAAN;iBAVM,GAAmC,IAAnC;sBACA,GAAgC,EAAhC;;QAkBFhI,SAAS,CAAC,CAAD,CAAT,YAAwB+H,OAA5B,EAAoC;UAC/BE,SAAS,GAAGjI,SAAS,CAAC,CAAD,CAAzB;;UAEIiI,SAAS,CAACC,YAAd,EAA4B;cACtBA,YAAL,GAAoBD,SAAS,CAACC,YAAV,CAAuB3G,KAAvB,EAApB;;KAJF,MAOK,IAAI,OAAOvB,SAAS,CAAC,CAAD,CAAhB,KAAwB,QAA5B,EAAqC;UACrCmI,oBAAoB,GAAGnI,SAAS,CAAC,CAAD,CAApC;UACIoI,WAAW,GAAGpI,SAAS,CAAC,CAAD;;;;YACtBqI,oBAAL,CAA0BF,oBAA1B;;UAEIG,GAAG,GAAGF,WAAW,CAACG,eAAZ,CAA4BC,oBAA5B,CAAiDL,oBAAjD,EAAuE,IAAvE,CAAV;;UACIG,GAAG,CAACG,MAAR,EAAe;cACTC,OAAL,GAAe,CAACJ,GAAG,CAACK,MAAL,CAAf;OADD,MAGI;cACG,IAAIpF,KAAJ,CAAU,4EAA4E4E,oBAAtF,CAAN;;KAVG,MAaA,IAAI,QAAOnI,SAAS,CAAC,CAAD,CAAhB,MAAwB,QAAxB,IAAoCA,SAAS,CAAC,CAAD,CAAT,CAAa8H,cAAb,CAA4B,KAA5B,CAApC,IAA0E9H,SAAS,CAAC,CAAD,CAAT,CAAa8H,cAAb,CAA4B,OAA5B,CAA9E,EAAmH;UACnHc,aAAa,GAAG5I,SAAS,CAAC,CAAD,CAA7B;;YACK6I,GAAL,CAASD,aAAa,CAACE,GAAvB,EAA4BF,aAAa,CAACG,KAA1C;;;;;;;;4BAIaC,cA9ChB;UA+CMA,cAAc,YAAYhC,WAA9B,EAA0C;YACrCa,IAAI,GAAGmB,cAAX;;YAEInB,IAAI,CAACZ,UAAL,IAAmB,IAAvB,EAA6B;eACvBgC,OAAL,CAAapB,IAAI,CAACX,QAAlB;;;;YAIG,KAAKwB,OAAL,KAAiB,IAArB,EAA2B,OAAO7E,kBAAkB,CAAC,cAAD,CAAzB;;;;;;+BAER,KAAK6E,OAAxB,8HAAiC;gBAAxBQ,MAAwB;;gBAC5BA,MAAM,CAAC7G,IAAP,IAAewF,IAAI,CAACZ,UAAxB,EAAoC;kBAC/BkC,MAAM,GAAGD,MAAM,CAACE,kBAAP,CAA0BvB,IAA1B,EAAgC,CAAhC,CAAb;;kBACIsB,MAAM,CAACV,MAAX,EAAmB;qBACbI,GAAL,CAAShB,IAAT,EAAesB,MAAM,CAACR,MAAtB;;eADD,MAGO;sBACA,IAAIpF,KAAJ,CAAU,4BAA4BsE,IAA5B,GAAmC,gFAA7C,CAAN;;;;;;;;;;;;;;;;;;;cAKG,IAAItE,KAAJ,CAAU,+MAAV,CAAN;OAtBD,MAwBK;YACA2D,QAAQ,GAAG8B,cAAf;YAEIK,YAAY,GAA0B,IAA1C;YAEI,KAAKX,OAAL,KAAiB,IAArB,EAA2B,OAAO7E,kBAAkB,CAAC,cAAD,CAAzB;;;;;;gCAER,KAAK6E,OAAxB,mIAAiC;gBAAxBQ,OAAwB;gBAC5BhC,QAAQ,KAAK,IAAjB,EAAuB,OAAOrD,kBAAkB,CAAC,UAAD,CAAzB;;gBAEnBqF,OAAM,CAACI,oBAAP,CAA4BpC,QAA5B,CAAJ,EAA2C;kBACrCmC,YAAY,IAAI,IAApB,EAA0B;sBACnB,IAAI9F,KAAJ,CAAU,4BAA4B2D,QAA5B,GAAuC,kDAAvC,GAA4FgC,OAAM,CAAC7G,IAAnG,GAA0G,MAA1G,GAAmHgH,YAAY,CAAChH,IAA1I,CAAN;eADD,MAEO;gBACNgH,YAAY,GAAGH,OAAf;;;;;;;;;;;;;;;;;;;YAKAG,YAAY,IAAI,IAApB,EACC,MAAM,IAAI9F,KAAJ,CAAU,4BAA4B2D,QAA5B,GAAuC,oGAAjD,CAAN;;YAEGW,KAAI,GAAG,IAAIb,WAAJ,CAAgBqC,YAAY,CAAChH,IAA7B,EAAmC6E,QAAnC,CAAX;;YACIqC,OAAO,GAAGF,YAAY,CAACG,YAAb,CAA0B3B,KAA1B,CAAd;aACKgB,GAAL,CAAShB,KAAT,EAAe0B,OAAf;;;;;sCAGuBrC,QAlG1B;;;;;;8BAmG2B,IAAzB,mIAA+B;;cAArBM,GAAqB;cAAhB5F,KAAgB;;cAC1BiG,IAAI,GAAGb,WAAW,CAACyC,iBAAZ,CAA8BjC,GAA9B,CAAX;cACIK,IAAI,CAACX,QAAL,IAAiBA,QAArB,EAA+B,OAAO,IAAP;;;;;;;;;;;;;;;;;aAGzB,KAAP;;;;gCAEkBM,GA1GpB;aA2GS,KAAKkC,GAAL,CAASlC,GAAG,CAACmC,UAAJ,EAAT,CAAP;;;;wBAEUnC,GA7GZ,EA6G8B5F,KA7G9B;UA8GMgI,aAAa,GAAGpC,GAAG,CAACmC,UAAJ,EAApB;;UACI,KAAKD,GAAL,CAASE,aAAT,CAAJ,EAA6B;;cAEtB,IAAIrG,KAAJ,iDAAmDiE,GAAnD,EAAN;;;WAEIqC,GAAL,CAASD,aAAT,EAAwBhI,KAAxB;;;;2BAEa4F,GArHf;aAsHS,eAAYA,GAAG,CAACmC,UAAJ,EAAZ,CAAP;;;;yCAsC2BG,iBA5J7B;WA6JO5B,YAAL,GAAoB,CAAC4B,iBAAD,CAApB;;;;0CAE4BC,kBA/J9B;UAgKMA,kBAAkB,IAAI,IAA1B,EACC,KAAK7B,YAAL,GAAoB,IAApB,CADD,KAGC,KAAKA,YAAL,GAAoB6B,kBAAkB,CAACxI,KAAnB,EAApB;;;;0BAqDW0G,SAxNd;UAyNM+B,KAAK,GAAG,IAAIjC,OAAJ,CAAY,IAAZ,CAAZ;;;;;;8BACwBE,SAAxB,mIAAmC;;cAA1BT,GAA0B;cAArB5F,KAAqB;;UAClCoI,KAAK,CAACH,GAAN,CAAUrC,GAAV,EAAe5F,KAAf;;;;;;;;;;;;;;;;;aAEMoI,KAAP;;;;8BAEgB/B,SA/NlB;UAgOMgC,YAAY,GAAG,IAAIlC,OAAJ,EAAnB;;;;;;8BACwB,IAAxB,mIAA8B;;cAArBP,GAAqB;cAAhB5F,KAAgB;;cACzBqG,SAAS,CAACyB,GAAV,CAAclC,GAAd,CAAJ,EACCyC,YAAY,CAACJ,GAAb,CAAiBrC,GAAjB,EAAsB5F,KAAtB;;;;;;;;;;;;;;;;;aAGKqI,YAAP;;;;4BAEcC,YAxOhB;UAyOMvB,MAAM,GAAG,IAAIZ,OAAJ,CAAY,IAAZ,CAAb;;;;;;8BACwBmC,YAAxB,mIAAsC;;cAA7B1C,GAA6B;cAAxB5F,KAAwB;;UACrC+G,MAAM,UAAN,CAAcnB,GAAd;;;;;;;;;;;;;;;;;aAGMmB,MAAP;;;;6BAEeV,SAhPjB;;;;;;8BAiP0BA,SAAxB,mIAAmC;;cAA1BT,GAA0B;cAArB5F,KAAqB;;cAC9B,CAAC,KAAK8H,GAAL,CAASlC,GAAT,CAAL,EAAoB,OAAO,KAAP;;;;;;;;;;;;;;;;;aAGd,IAAP;;;;gCAEkBS,SAvPpB;UAwPM,KAAKkC,KAAL,IAAc,CAAlB,EAAqB,OAAO,KAAP;UACjBlC,SAAS,CAACkC,KAAV,IAAmB,CAAvB,EAA0B,OAAO,IAAP;aAEnB,KAAKC,OAAL,CAAarB,KAAb,GAAqBd,SAAS,CAACoC,OAAV,CAAkBtB,KAA9C;;;;wCAE0Bd,SA7P5B;UA8PM,KAAKkC,KAAL,IAAc,CAAlB,EAAqB,OAAO,KAAP;UACjBlC,SAAS,CAACkC,KAAV,IAAmB,CAAvB,EAA0B,OAAO,IAAP;aAEnB,KAAKC,OAAL,CAAarB,KAAb,IAAsBd,SAAS,CAACmC,OAAV,CAAkBrB,KAAxC,IACH,KAAKsB,OAAL,CAAatB,KAAb,IAAsBd,SAAS,CAACoC,OAAV,CAAkBtB,KAD5C;;;;6BAGed,SApQjB;UAqQMA,SAAS,CAACkC,KAAV,IAAmB,CAAvB,EAA0B,OAAO,KAAP;UACtB,KAAKA,KAAL,IAAc,CAAlB,EAAqB,OAAO,IAAP;aAEd,KAAKE,OAAL,CAAatB,KAAb,GAAqBd,SAAS,CAACmC,OAAV,CAAkBrB,KAA9C;;;;qCAEuBd,SA1QzB;UA2QMA,SAAS,CAACkC,KAAV,IAAmB,CAAvB,EAA0B,OAAO,KAAP;UACtB,KAAKA,KAAL,IAAc,CAAlB,EAAqB,OAAO,IAAP;aAEd,KAAKE,OAAL,CAAatB,KAAb,IAAsBd,SAAS,CAACoC,OAAV,CAAkBtB,KAAxC,IACH,KAAKqB,OAAL,CAAarB,KAAb,IAAsBd,SAAS,CAACmC,OAAV,CAAkBrB,KAD5C;;;;;UAII,KAAKoB,KAAL,GAAa,CAAjB,EACC,OAAO,IAAIpC,OAAJ,CAAY,KAAKsC,OAAjB,CAAP,CADD,KAGC,OAAO,IAAItC,OAAJ,EAAP;;;;;UAGG,KAAKoC,KAAL,GAAa,CAAjB,EACC,OAAO,IAAIpC,OAAJ,CAAY,KAAKqC,OAAjB,CAAP,CADD,KAGC,OAAO,IAAIrC,OAAJ,EAAP;;;;qCAEsBuC,QA7RzB,EA6RwCC,QA7RxC;UA+RM,KAAKJ,KAAL,IAAc,CAAlB,EAAqB,OAAO,IAAIpC,OAAJ,EAAP;UAEjByC,OAAO,GAAG,KAAKC,YAAnB;UAEIC,QAAQ,GAAG,CAAf;UACIC,QAAQ,GAAGC,MAAM,CAACC,gBAAtB;;UAEID,MAAM,CAACE,SAAP,CAAiBR,QAAjB,CAAJ,EAAgC;QAC/BI,QAAQ,GAAGJ,QAAX;OADD,MAEO;YACFA,QAAQ,YAAYvC,OAApB,IAA+BuC,QAAQ,CAACH,KAAT,GAAiB,CAApD,EACCO,QAAQ,GAAGJ,QAAQ,CAACF,OAAT,CAAiBrB,KAA5B;;;UAGE6B,MAAM,CAACE,SAAP,CAAiBP,QAAjB,CAAJ,EAAgC;QAC/BI,QAAQ,GAAGJ,QAAX;OADD,MAEO;YACFD,QAAQ,YAAYvC,OAApB,IAAgCuC,QAAD,CAAWH,KAAX,GAAmB,CAAtD,EACCQ,QAAQ,GAAGJ,QAAQ,CAACF,OAAT,CAAiBtB,KAA5B;;;UAGEgC,OAAO,GAAG,IAAIhD,OAAJ,EAAd;MACAgD,OAAO,CAACC,qBAAR,CAA8B,KAAKC,WAAnC;;;;;;8BACiBT,OAAjB,mIAA0B;cAAjB3C,IAAiB;;cACrBA,IAAI,CAACkB,KAAL,IAAc2B,QAAd,IAA0B7C,IAAI,CAACkB,KAAL,IAAc4B,QAA5C,EAAuD;YACtDI,OAAO,CAAClC,GAAR,CAAYhB,IAAI,CAACiB,GAAjB,EAAsBjB,IAAI,CAACkB,KAA3B;;;;;;;;;;;;;;;;;;aAIKgC,OAAP;;;;2BAEaG,YA9Tf;UA+TMA,YAAY,YAAYnD,OAAxB,KAAoC,KAAxC,EAA+C,OAAO,KAAP;UAC3CmD,YAAY,CAACf,KAAb,IAAsB,KAAKA,KAA/B,EAAsC,OAAO,KAAP;;;;;;8BAEd,IAAxB,mIAA8B;;cAArB3C,GAAqB;cAAhB5F,KAAgB;;cACzB,CAACsJ,YAAY,CAACxB,GAAb,CAAiBlC,GAAjB,CAAL,EACC,OAAO,KAAP;;;;;;;;;;;;;;;;;aAGK,IAAP;KAvUF;;;;;UAoWMgD,OAAO,GAAG,KAAKC,YAAnB;UAEIU,EAAE,GAAG,IAAI3E,aAAJ,EAAT;;WACK,IAAI3F,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG2J,OAAO,CAAC1J,MAA5B,EAAoCD,CAAC,EAArC,EAAyC;YACpCA,CAAC,GAAG,CAAR,EACCsK,EAAE,CAACzE,MAAH,CAAU,IAAV;YAEGmB,IAAI,GAAG2C,OAAO,CAAC3J,CAAD,CAAP,CAAWiI,GAAtB;YACIjB,IAAI,CAACX,QAAL,KAAkB,IAAtB,EAA4B,OAAOrD,kBAAkB,CAAC,eAAD,CAAzB;QAC5BsH,EAAE,CAACzE,MAAH,CAAUmB,IAAI,CAACX,QAAf;;;aAGMiE,EAAE,CAAC7I,QAAH,EAAP;KAhXF;;;;;;;aAsXS8I,GAAP;;;;;aA7PO,KAAKC,IAAZ;;;;;UAGI,KAAK3C,OAAL,IAAgB,IAApB,EAA0B,OAAO,IAAP;UAEtB4C,aAAa,GAAG,KAAKjB,OAAL,CAAavB,GAAb,CAAiB7B,UAArC;UACI0B,MAAM,GAAG,IAAb;WACKD,OAAL,CAAa6C,KAAb,CAAmB,UAACrC,MAAD;YACdA,MAAM,CAAC7G,IAAP,IAAeiJ,aAAnB,EAAiC;UAChC3C,MAAM,GAAGO,MAAT;iBACO,KAAP;SAFD,MAIK,OAAO,IAAP;OALN;aAQOP,MAAP;;;;;UAGI,KAAKwB,KAAL,GAAa,CAAjB,EAAoB;YACf,KAAKjC,YAAL,IAAqB,IAArB,IAA6B,KAAKiC,KAAL,GAAa,CAA9C,EACC,KAAKjC,YAAL,GAAoB,EAApB,CADD,KAEK;cACA,CAAC,KAAKA,YAAV,EAAwB,KAAKA,YAAL,GAAoB,EAApB;eACnBA,YAAL,CAAkBpH,MAAlB,GAA2B,CAA3B;;;;;;;iCAGwB,IAAzB,wIAA+B;;gBAArB0G,GAAqB;gBAAhB5F,KAAgB;;gBAC1BiG,IAAI,GAAGb,WAAW,CAACyC,iBAAZ,CAA8BjC,GAA9B,CAAX;gBACIK,IAAI,CAACZ,UAAL,KAAoB,IAAxB,EAA8B,OAAOpD,kBAAkB,CAAC,iBAAD,CAAzB;;iBACzBqE,YAAL,CAAkB7H,IAAlB,CAAuBwH,IAAI,CAACZ,UAA5B;;;;;;;;;;;;;;;;;;aAIK,KAAKiB,YAAZ;;;;;UAYIsD,GAAG,GAAsC;QAC5C1C,GAAG,EAAE9B,WAAW,CAACW,IAD2B;QAE5CoB,KAAK,EAAE;OAFR;;;;;;+BAIyB,IAAzB,wIAA+B;;cAArBvB,GAAqB;cAAhB5F,KAAgB;;cAC1BiG,IAAI,GAAGb,WAAW,CAACyC,iBAAZ,CAA8BjC,GAA9B,CAAX;cACIgE,GAAG,CAAC1C,GAAJ,CAAQ2C,MAAR,IAAkB7J,KAAK,GAAG4J,GAAG,CAACzC,KAAlC,EACCyC,GAAG,GAAG;YAAE1C,GAAG,EAAEjB,IAAP;YAAakB,KAAK,EAAEnH;WAA1B;;;;;;;;;;;;;;;;;aAGK4J,GAAP;;;;;UAGIzG,GAAG,GAAsC;QAC5C+D,GAAG,EAAE9B,WAAW,CAACW,IAD2B;QAE5CoB,KAAK,EAAE;OAFR;;;;;;+BAIyB,IAAzB,wIAA+B;;cAArBvB,GAAqB;cAAhB5F,KAAgB;;cAC1BiG,IAAI,GAAGb,WAAW,CAACyC,iBAAZ,CAA8BjC,GAA9B,CAAX;;cACIzC,GAAG,CAAC+D,GAAJ,CAAQ2C,MAAR,IAAkB7J,KAAK,GAAGmD,GAAG,CAACgE,KAAlC,EAAyC;YACxChE,GAAG,GAAG;cAAE+D,GAAG,EAAEjB,IAAP;cAAakB,KAAK,EAAEnH;aAA1B;;;;;;;;;;;;;;;;;;aAGKmD,GAAP;;;;;UAGI2G,IAAI,GAAG,IAAI3D,OAAJ,EAAX;;UACI,KAAKW,OAAL,IAAgB,IAApB,EAA0B;;;;;;iCACN,KAAKA,OAAxB,wIAAiC;gBAAxBQ,MAAwB;;;;;;qCACPA,MAAM,CAACyC,KAAhC,wIAAuC;;oBAA7BnE,GAA6B;oBAAxB5F,KAAwB;;oBAClCiG,IAAI,GAAGb,WAAW,CAACyC,iBAAZ,CAA8BjC,GAA9B,CAAX;oBACI,CAAC,KAAKoE,WAAL,CAAiB/D,IAAjB,CAAL,EACC6D,IAAI,CAAC7C,GAAL,CAAShB,IAAT,EAAejG,KAAf;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;aAIG8J,IAAP;;;;;UAGIA,IAAI,GAAG,IAAI3D,OAAJ,EAAX;;UACI,KAAKW,OAAL,IAAgB,IAApB,EAA0B;;;;;;iCACP,KAAKA,OAAvB,wIAAgC;gBAAxBQ,MAAwB;;;;;;qCACNA,MAAM,CAACyC,KAAhC,wIAAuC;;oBAA7BnE,GAA6B;oBAAxB5F,KAAwB;;oBAClCiG,IAAI,GAAGb,WAAW,CAACyC,iBAAZ,CAA8BjC,GAA9B,CAAX;gBACAkE,IAAI,CAAC7B,GAAL,CAAShC,IAAI,CAAC8B,UAAL,EAAT,EAA4B/H,KAA5B;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;aAII8J,IAAP;;;;;;UAsHIlB,OAAO,GAAG,IAAIjK,KAAJ,EAAd;;;;;;+BAEwB,IAAxB,wIAA8B;;cAArBiH,GAAqB;cAAhB5F,KAAgB;;cACzBiG,IAAI,GAAGb,WAAW,CAACyC,iBAAZ,CAA8BjC,GAA9B,CAAX;UACAgD,OAAO,CAACnK,IAAR,CAAa;YAAEyI,GAAG,EAAEjB,IAAP;YAAakB,KAAK,EAAEnH;WAAjC;;;;;;;;;;;;;;;;;MAGD4I,OAAO,CAACqB,IAAR,CAAa,UAACC,CAAD,EAAIC,CAAJ;YACRD,CAAC,CAAChD,GAAF,CAAM7B,UAAN,KAAqB,IAAzB,EAA+B;iBAASpD,kBAAkB,CAAC,kBAAD,CAAzB;;;YAC7BkI,CAAC,CAACjD,GAAF,CAAM7B,UAAN,KAAqB,IAAzB,EAA+B;iBAASpD,kBAAkB,CAAC,kBAAD,CAAzB;;;YAE7BiI,CAAC,CAAC/C,KAAF,IAAWgD,CAAC,CAAChD,KAAjB,EAAwB;iBAChB+C,CAAC,CAAChD,GAAF,CAAM7B,UAAN,CAAiB+E,aAAjB,CAA+BD,CAAC,CAACjD,GAAF,CAAM7B,UAArC,CAAP;SADD,MAEO;;cAEF6E,CAAC,CAAC/C,KAAF,GAAUgD,CAAC,CAAChD,KAAhB,EACC,OAAO,CAAC,CAAR;iBACM+C,CAAC,CAAC/C,KAAF,GAAUgD,CAAC,CAAChD,KAAZ,GAAoB,CAApB,GAAwB,CAA/B;;OAVF;aAcOyB,OAAP;;;;;mBAjW2ByB,GAA7B;;IChGaC,cAAb;;AAAA;;;0BAMarJ,OAAZ;;;;;wFACOA,OAAN;UACKsJ,gBAAL,GAAwB,KAAxB;UACKtJ,OAAL,GAAeA,OAAf;UACKR,IAAL,GAAY,gBAAZ;;;;;mBAVkCkB,KAApC;;SC8BgB6I,mBAAyBC,KAAuB7E;;AAAkB5F;MAC7EyK,GAAG,KAAK,IAAZ,EAAkB;WACV;MAAE1D,MAAM,EAAE/G,KAAV;MAAiB6G,MAAM,EAAE;KAAhC;;;MAGG6D,GAAG,GAAGD,GAAG,CAACE,GAAJ,CAAQ/E,GAAR,CAAV;;MAEI8E,GAAJ,EAAS;WACD;MAAE3D,MAAM,EAAE2D,GAAV;MAAe7D,MAAM,EAAE;KAA9B;GADD,MAEO;WACC;MAAEE,MAAM,EAAE/G,KAAV;MAAiB6G,MAAM,EAAE;KAAhC;;;AAIF,SAAgB+D,YAAY5K;MAAsB6K,mFAAuB;MACpEH,GAAG,GAAGpK,QAAQ,CAACN,KAAD,CAAlB;;MAEI,CAACgJ,MAAM,CAAC8B,KAAP,CAAaJ,GAAb,CAAL,EAAwB;WAChB;MAAE3D,MAAM,EAAE2D,GAAV;MAAe7D,MAAM,EAAE;KAA9B;GADD,MAEO;WACC;MAAEE,MAAM,EAAE8D,YAAV;MAAwBhE,MAAM,EAAE;KAAvC;;;AAIF,SAAgBkE,cAAc/K;MAAsB6K,mFAAuB;MACtEH,GAAG,GAAGM,UAAU,CAAChL,KAAD,CAApB;;MAEI,CAACgJ,MAAM,CAAC8B,KAAP,CAAaJ,GAAb,CAAL,EAAwB;WAChB;MAAE3D,MAAM,EAAE2D,GAAV;MAAe7D,MAAM,EAAE;KAA9B;GADD,MAEO;WACC;MAAEE,MAAM,EAAE8D,YAAV;MAAwBhE,MAAM,EAAE;KAAvC;;;;ICpDoBoE,aAAtB;;AAAA;;;;;;;;;;;;aAiCSvJ,UAAU,CAACuJ,aAAa,CAACC,MAAd,CAAqB,IAArB,CAAD,EAA6BhJ,SAA7B,CAAjB;;;;qCAEuBiJ,UAnCzB;aAoCS,IAAIb,cAAJ,CAAmB,gBAAc,KAAKc,WAAnB,GAA+B,QAA/B,GAA0C,KAAKC,SAA/C,GAAyD,MAAzD,GAAgEF,UAAnF,CAAP;;;;2BA7BoBT,GAPtB;;UASM,OAAOA,GAAP,KAAe,SAAnB,EAA6B;YACxBY,CAAC,GAAG,CAAC,CAACZ,GAAV;QACAA,GAAG,GAAIY,CAAD,GAAM,CAAN,GAAU,CAAhB;;;;;;;UAOG,OAAOZ,GAAP,KAAe,QAAnB,EAA6B;eACrB,IAAIa,WAAJ,CAAgBC,MAAM,CAACd,GAAD,CAAtB,CAAP;OADD,MAEO,IAAI1B,MAAM,CAACE,SAAP,CAAiBF,MAAM,CAAC0B,GAAD,CAAvB,CAAJ,EAAmC;eAClC,IAAIe,QAAJ,CAAazC,MAAM,CAAC0B,GAAD,CAAnB,CAAP;OADM,MAEA,IAAI,CAACI,KAAK,CAACJ,GAAD,CAAV,EAAiB;eAChB,IAAIgB,UAAJ,CAAe1C,MAAM,CAAC0B,GAAD,CAArB,CAAP;OADM,MAEA,IAAIA,GAAG,YAAY1M,IAAnB,EAAyB;eACxB,IAAI2N,iBAAJ,CAAsBjK,UAAU,CAACgJ,GAAD,EAAM1M,IAAN,CAAhC,CAAP;OADM,MAEA,IAAI0M,GAAG,YAAYvE,OAAnB,EAA4B;eAC3B,IAAIyF,SAAJ,CAAclK,UAAU,CAACgJ,GAAD,EAAMvE,OAAN,CAAxB,CAAP;;;aAGM,IAAP;;;;;EA9B0CjE,SAA5C;AAwCA,IAAsBiF,KAAtB;;AAAA;;;iBAGauD,GAAZ;;;;;;UAEM1K,KAAL,GAAa0K,GAAb;;;;;;;UAMI,KAAK1K,KAAL,KAAe,IAAnB,EAAyB,OAAOiC,kBAAkB,CAAC,aAAD,CAAzB;aAClB,KAAKjC,KAAL,CAAWU,QAAX,EAAP;;;;;aAJO,KAAKV,KAAZ;;;;;EARyEiL,aAA3E;AAgBA,IAAaQ,QAAb;;AAAA;;;oBACaf,GAAZ;;;iFACOA,GAAG,IAAI;;;;;yBASFmB,OAXb;UAYM,KAAK7L,KAAL,KAAe,IAAnB,EAAyB,OAAOiC,kBAAkB,CAAC,aAAD,CAAzB;;UAErB4J,OAAO,IAAI,KAAKR,SAApB,EAA+B;eACvB,IAAP;;;UAGGQ,OAAO,IAAIC,SAAS,CAACC,KAAzB,EAAgC;eACxB,IAAIL,UAAJ,CAAe,KAAK1L,KAApB,CAAP;;;UAGG6L,OAAO,IAAIC,SAAS,CAACN,MAAzB,EAAiC;eACzB,IAAID,WAAJ,CAAgB,KAAK,KAAKvL,KAA1B,CAAP;;;YAGK,KAAKgM,gBAAL,CAAsBH,OAAtB,CAAN;;;;;aArBO,KAAK7L,KAAL,IAAc,CAArB;;;;;aAGO8L,SAAS,CAACG,GAAjB;;;;;EAR4B9E,KAA9B;AA8BA,IAAauE,UAAb;;AAAA;;;sBACahB,GAAZ;;;mFACOA,GAAG,IAAI;;;;;yBASFmB,OAXb;UAYM,KAAK7L,KAAL,KAAe,IAAnB,EAAyB,OAAOiC,kBAAkB,CAAC,aAAD,CAAzB;;UAErB4J,OAAO,IAAI,KAAKR,SAApB,EAA+B;eACvB,IAAP;;;UAGGQ,OAAO,IAAIC,SAAS,CAACG,GAAzB,EAA8B;eACtB,IAAIR,QAAJ,CAAa,KAAKzL,KAAlB,CAAP;;;UAGG6L,OAAO,IAAIC,SAAS,CAACN,MAAzB,EAAiC;eACzB,IAAID,WAAJ,CAAgB,KAAK,KAAKvL,KAA1B,CAAP;;;YAGK,KAAKgM,gBAAL,CAAsBH,OAAtB,CAAN;;;;;aArBO,KAAK7L,KAAL,IAAc,GAArB;;;;;aAGO8L,SAAS,CAACC,KAAjB;;;;;EAR8B5E,KAAhC;AA8BA,IAAaoE,WAAb;;AAAA;;;uBAIab,GAAZ;;;;;sFACOA,GAAG,IAAI,EAAb;WAEKwB,UAAL,GAAmB,OAAKlM,KAAL,IAAc,IAAjC;WACKmM,mBAAL,GAA2B,IAA3B;QAEI,OAAKnM,KAAL,KAAe,IAAnB,EAAyB,0CAAOiC,kBAAkB,CAAC,aAAD,CAAzB;;QAErB,OAAKjC,KAAL,CAAWd,MAAX,GAAoB,CAAxB,EAA2B;aACrBc,KAAL,CAAWG,KAAX,CAAiB,EAAjB,EAAqBwJ,KAArB,CAA2B,UAACnK,CAAD;YACtBA,CAAC,IAAI,GAAL,IAAYA,CAAC,IAAI,IAArB,EAA0B;iBACpB2M,mBAAL,GAA2B,KAA3B;iBACO,KAAP;;;eAGM,IAAP;OAND;;;;;;;;yBA2BUN,OAxCb;UAyCMA,OAAO,IAAI,KAAKR,SAApB,EAA+B;eACvB,IAAP;;;UAGGQ,OAAO,IAAIC,SAAS,CAACG,GAAzB,EAA8B;YAEzBG,SAAS,GAAGxB,WAAW,CAAC,KAAK5K,KAAN,CAA3B;;YACIoM,SAAS,CAACvF,MAAd,EAAsB;iBACd,IAAI4E,QAAJ,CAAaW,SAAS,CAACrF,MAAvB,CAAP;SADD,MAEO;gBACA,KAAKiF,gBAAL,CAAsBH,OAAtB,CAAN;;;;UAIEA,OAAO,IAAIC,SAAS,CAACC,KAAzB,EAAgC;YAC3BM,WAAW,GAAGtB,aAAa,CAAC,KAAK/K,KAAN,CAA/B;;YACIqM,WAAW,CAACxF,MAAhB,EAAwB;iBAChB,IAAI6E,UAAJ,CAAeW,WAAW,CAACtF,MAA3B,CAAP;SADD,MAEO;gBACA,KAAKiF,gBAAL,CAAsBH,OAAtB,CAAN;;;;YAII,KAAKG,gBAAL,CAAsBH,OAAtB,CAAN;;;;;aAxCOC,SAAS,CAACN,MAAjB;;;;;UAGI,KAAKxL,KAAL,KAAe,IAAnB,EAAyB,OAAOiC,kBAAkB,CAAC,aAAD,CAAzB;aAClB,KAAKjC,KAAL,CAAWd,MAAX,GAAoB,CAA3B;;;;;aAGO,KAAKgN,UAAZ;;;;;aAGO,KAAKC,mBAAZ;;;;;aAGO,CAAC,KAAKG,SAAN,IAAmB,CAAC,KAAKC,kBAAhC;;;;;EArC+BpF,KAAjC;AAoEA,IAAawE,iBAAb;;AAAA;;;6BACaa,UAAZ;;;0FACOA;;;;;yBAgBKX,OAlBb;UAmBMA,OAAO,IAAI,KAAKR,SAApB,EACC,OAAO,IAAP;YAEK,KAAKW,gBAAL,CAAsBH,OAAtB,CAAN;;;;;aAGO,uBAAuB,KAAKW,UAA5B,GAAyC,GAAhD;;;;;aApBOV,SAAS,CAACW,YAAjB;;;;;UAGI,KAAKzM,KAAL,KAAe,IAAnB,EAAyB,OAAOiC,kBAAkB,CAAC,aAAD,CAAzB;aAClB,KAAKjC,KAAZ;KATF;sBAWuBA,KAXvB;WAYOA,KAAL,GAAaA,KAAb;;;;;YAGM,IAAI2B,KAAJ,CAAU,0DAAV,CAAN;;;;;EAfqCwF,KAAvC;AA6BA,IAAauF,oBAAb;;AAAA;;;gCAGaC,YAAZ;;;QAAkCC,mFAAuB,CAAC;;;;+FACnDD,YAAN;WAEKE,aAAL,GAAqBD,YAArB;;;;;;yBAwBWf,OA9Bb;UA+BMA,OAAO,IAAI,KAAKR,SAApB,EACC,OAAO,IAAP;YAEK,KAAKW,gBAAL,CAAsBH,OAAtB,CAAN;;;;;aAGO,0BAA0B,KAAKc,YAA/B,GAA8C,GAArD;;;;;aAGO,IAAID,oBAAJ,CAAyB,KAAKC,YAA9B,EAA4C,KAAKC,YAAjD,CAAP;;;;;aA9BO,KAAKC,aAAZ;KAVF;sBAYyB7M,KAZzB;WAaO6M,aAAL,GAAqB7M,KAArB;;;;;UAGI,KAAKA,KAAL,KAAe,IAAnB,EAAyB,OAAOiC,kBAAkB,CAAC,aAAD,CAAzB;aAClB,KAAKjC,KAAZ;KAjBF;sBAmByBA,KAnBzB;WAoBOA,KAAL,GAAaA,KAAb;;;;;aAGO8L,SAAS,CAACgB,eAAjB;;;;;YAIM,IAAInL,KAAJ,CAAU,4DAAV,CAAN;;;;;EA3BwCwF,KAA1C;AA4CA,IAAayE,SAAb;;AAAA;;;;;yBAQaC,OARb;UASM,KAAK7L,KAAL,KAAe,IAAnB,EAAyB,OAAOiC,kBAAkB,CAAC,aAAD,CAAzB;;UAErB4J,OAAO,IAAIC,SAAS,CAACG,GAAzB,EAA8B;YACzBrC,GAAG,GAAG,KAAK5J,KAAL,CAAWyI,OAArB;YACImB,GAAG,CAAC1C,GAAJ,CAAQ2C,MAAZ,EACA,OAAO,IAAI4B,QAAJ,CAAa,CAAb,CAAP,CADA,KAGA,OAAO,IAAIA,QAAJ,CAAa7B,GAAG,CAACzC,KAAjB,CAAP;OALD,MAOK,IAAI0E,OAAO,IAAIC,SAAS,CAACC,KAAzB,EAAgC;YAChCnC,IAAG,GAAG,KAAK5J,KAAL,CAAWyI,OAArB;YACImB,IAAG,CAAC1C,GAAJ,CAAQ2C,MAAZ,EACA,OAAO,IAAI6B,UAAJ,CAAe,GAAf,CAAP,CADA,KAGA,OAAO,IAAIA,UAAJ,CAAe9B,IAAG,CAACzC,KAAnB,CAAP;OALI,MAOA,IAAI0E,OAAO,IAAIC,SAAS,CAACN,MAAzB,EAAiC;YACjC5B,KAAG,GAAG,KAAK5J,KAAL,CAAWyI,OAArB;YACImB,KAAG,CAAC1C,GAAJ,CAAQ2C,MAAZ,EACA,OAAO,IAAI0B,WAAJ,CAAgB,EAAhB,CAAP,CADA,KAEK;iBACG,IAAIA,WAAJ,CAAgB3B,KAAG,CAAC1C,GAAJ,CAAQxG,QAAR,EAAhB,CAAP;;;;UAIEmL,OAAO,IAAI,KAAKR,SAApB,EAA+B,OAAO,IAAP;YAEzB,KAAKW,gBAAL,CAAsBH,OAAtB,CAAN;;;;;UAlCI,KAAK7L,KAAL,KAAe,IAAnB,EAAyB;eAASiC,kBAAkB,CAAC,YAAD,CAAzB;;;aACpB,KAAKjC,KAAL,CAAWuI,KAAX,GAAmB,CAA1B;;;;;aAGOuD,SAAS,CAACiB,IAAjB;;;;qBAmCWC,gBAAZ,EAAsDC,WAAtD;;;;;oFACO,IAAN;;QAEI,CAACD,gBAAD,IAAqB,CAACC,WAA1B,EAAuC;aACjCjN,KAAL,GAAa,IAAImG,OAAJ,EAAb;KADD,MAGK,IAAI6G,gBAAgB,YAAY7G,OAAhC,EAAyC;aACxCnG,KAAL,GAAa,IAAImG,OAAJ,CAAY6G,gBAAZ,CAAb;KADI,MAGA,IAAIA,gBAAgB,YAAY5H,WAA5B,IAA2C,OAAO6H,WAAP,KAAuB,QAAtE,EAAgF;aAC/EjN,KAAL,GAAa,IAAImG,OAAJ,CAAY;QACxBe,GAAG,EAAE8F,gBADmB;QAExB7F,KAAK,EAAE8F;OAFK,CAAb;;;;;;;;mDAM2CC,QAzD9C,EAyD0EC,QAzD1E;UA0DMC,OAAO,GAAG7L,QAAQ,CAAC2L,QAAD,EAAWtB,SAAX,CAAtB;UACIyB,OAAO,GAAG9L,QAAQ,CAAC4L,QAAD,EAAWvB,SAAX,CAAtB;UAEIyB,OAAO,IAAIA,OAAO,CAACrN,KAAR,KAAkB,IAAjC,EAAuC,OAAOiC,kBAAkB,CAAC,eAAD,CAAzB;UACnCmL,OAAO,IAAIA,OAAO,CAACpN,KAAR,KAAkB,IAAjC,EAAuC,OAAOiC,kBAAkB,CAAC,eAAD,CAAzB;;UAGnCmL,OAAO,IAAIC,OAAX,IAAsBA,OAAO,CAACrN,KAAR,CAAeuI,KAAf,IAAwB,CAAlD,EACC8E,OAAO,CAACrN,KAAR,CAAeoJ,qBAAf,CAAqCgE,OAAO,CAACpN,KAAR,CAAeqJ,WAApD;;;;;EAlE4BlC,KAA/B;AAsEA,AAAA,IAAY2E,SAAZ;;AAAA,WAAYA;EACXA,+BAAA,QAAA;EACAA,iCAAA,UAAA;EACAA,gCAAA,SAAA;EACAA,kCAAA,WAAA;EACAA,wCAAA,iBAAA;EACAA,2CAAA,oBAAA;CAND,EAAYA,SAAS,KAATA,SAAS,KAAA,CAArB;;IC5UawB,YAAb;;AAAA;;;;YACQ,GAAwB,IAAxB;oBACA,GAAuB,KAAvB;;;;;;UAWFC,YAAY,GAAG,IAAID,YAAJ,EAAnB;MACAC,YAAY,CAAC/L,GAAb,GAAmB,KAAKA,GAAxB;MACA+L,YAAY,CAACC,WAAb,GAA2B,KAAKA,WAAhC;aAEOD,YAAP;;;;;aAZO,KAAKC,WAAL,GAAmB,IAAnB,GAA0B,KAAKhM,GAAtC;;;;;aAIQ,KAAKA,GAAL,YAAoBmB,SAArB,GAAkC,KAAKnB,GAAvC,GAA6C,IAApD;;;;;;;ICDWmB,SAAb;;AAAA;;;;;;;;;cACQ,GAAe,EAAf;kBAEA,GAAwB,EAAxB;sBACA,GAA2C,IAAI0H,GAAJ,EAA3C;+BAEA,GAAiC,KAAjC;kCACA,GAAoC,KAApC;6BACA,GAA+B,KAA/B;iCAEA,GAAuC,IAAvC;;;;;;+BAoFWoD,gBA9FnB;UA+FMA,gBAAgB,YAAY9O,KAAhC,EAAsC;YACjC+O,WAAW,GAAGD,gBAAlB;;;;;;+BAEcC,WAAd,8HAA2B;gBAAlBlO,CAAkB;iBACrBmO,UAAL,CAAgBnO,CAAhB;;;;;;;;;;;;;;;;OAJF,MAOI;YACCoO,UAAU,GAAGH,gBAAjB;;aACKI,QAAL,CAAcpP,IAAd,CAAmBmP,UAAnB;;YAEIA,UAAU,CAAChL,MAAf,EAAuB;gBAChB,IAAIjB,KAAJ,CAAU,2BAA2BiM,UAAU,CAAChL,MAAhD,CAAN;;;QAGDgL,UAAU,CAAChL,MAAX,GAAoB,IAApB;aAEKkL,kBAAL,CAAwBF,UAAxB;;;;;uCAGwBA,UAnH3B;UAoHMG,eAAe,GAAGlM,qBAAqB,CAAC+L,UAAD,CAA3C;;UACIG,eAAe,IAAI,IAAnB,IAA2BA,eAAe,CAACjM,YAA/C,EAA4D;aACtDkM,qBAAL,CAA2BD,eAA3B;;;;;0CAG2BA,eAzH9B;MA0HElN,KAAK,CAACC,UAAN,CAAiBiN,eAAjB,EAAkC7L,SAAlC,EAA6C,qDAA7C;UACI+L,UAAU,GAAGvM,UAAU,CAACqM,eAAD,EAAkB7L,SAAlB,CAA3B;MACA+L,UAAU,CAACrL,MAAX,GAAoB,IAApB;WAEKsL,YAAL,CAAkBjG,GAAlB,CAAsB8F,eAAe,CAACtN,IAAtC,EAA4CsN,eAA5C;;;;kCAEoBxN,IAhItB;UAgIkC4N,uFAA2B;UAAGC,wFAA4B,CAAC;UACvFA,iBAAiB,IAAI,CAAC,CAA1B,EACCA,iBAAiB,GAAG7N,IAAI,CAACrB,MAAzB;UAEG6H,MAAM,GAAG,IAAIuG,YAAJ,EAAb;MACAvG,MAAM,CAACyG,WAAP,GAAqB,KAArB;UAEIa,gBAAgB,GAAqB,IAAzC;UACIC,UAAU,GAAc,IAA5B;;WAEK,IAAIrP,CAAC,GAAGkP,gBAAb,EAA+BlP,CAAC,GAAGmP,iBAAnC,EAAsD,EAAEnP,CAAxD,EAA2D;YACtDsP,IAAI,GAAGhO,IAAI,CAACsC,YAAL,CAAkB5D,CAAlB,CAAX;;YACIoP,gBAAgB,IAAI,IAAxB,EAA8B;UAC7BtH,MAAM,CAACyG,WAAP,GAAqB,IAArB;;;;YAIGgB,QAAQ,GAAqBH,gBAAgB,CAACI,wBAAjB,CAA0CF,IAA1C,CAAjC;;YAEIC,QAAQ,IAAI,IAAhB,EAAsB;UACrBzH,MAAM,CAACyG,WAAP,GAAqB,IAArB;;;;QAIDc,UAAU,GAAGE,QAAb;QACAH,gBAAgB,GAAG9M,QAAQ,CAACiN,QAAD,EAAW7L,SAAX,CAA3B;;;MAGDoE,MAAM,CAACvF,GAAP,GAAa8M,UAAb;aAEOvH,MAAP;;;;kCAEoB6G,UAhKtB,EAgK6C/O,KAhK7C;WAiKO4F,OAAL,CAAa5F,KAAb,IAAsB+O,UAAtB;;UAEIA,UAAU,CAAChL,MAAf,EAAuB;cAChB,IAAIjB,KAAJ,CAAU,2BAA2BiM,UAAU,CAAChL,MAAhD,CAAN;;;MAGDgL,UAAU,CAAChL,MAAX,GAAoB,IAApB;WAEKkL,kBAAL,CAAwBF,UAAxB;;;;2CAE6Bc,cA3K/B;WA4KOjK,OAAL,GAAe,KAAKA,OAAL,CAAa/F,MAAb,CAAoBgQ,cAAc,CAACjK,OAAnC,CAAf;;;;;;8BAEgBiK,cAAc,CAACjK,OAA/B,mIAAwC;cAA/BjD,GAA+B;UACvCA,GAAG,CAACoB,MAAJ,GAAa,IAAb;eACKkL,kBAAL,CAAwBtM,GAAxB;;;;;;;;;;;;;;;;;;;6CAG8BmN,SAnLjC;UAoLMA,SAAS,CAAC7O,OAAd,EAAuB;YAElB6O,SAAS,CAAC9P,KAAV,IAAmB,CAAnB,IAAwB8P,SAAS,CAAC9P,KAAV,GAAkB,KAAK4F,OAAL,CAAavF,MAA3D,EAAmE;iBAC3D,KAAKuF,OAAL,CAAakK,SAAS,CAAC9P,KAAvB,CAAP;SADD,MAIK;iBACG,IAAP;;OAPF,MAYK,IAAI8P,SAAS,CAACxP,QAAd,EAAwB;eACrB,KAAKyD,MAAZ;OADI,MAIA;YACA+L,SAAS,CAAClO,IAAV,KAAmB,IAAvB,EAA6B;iBAASwB,kBAAkB,CAAC,gBAAD,CAAzB;;;YAC3B2M,YAAY,GAAGpE,kBAAkB,CAAC,KAAK0D,YAAN,EAAoBS,SAAS,CAAClO,IAA9B,EAAoC,IAApC,CAArC;;YACImO,YAAY,CAAC/H,MAAjB,EAAwB;iBAChBnF,UAAU,CAACkN,YAAY,CAAC7H,MAAd,EAAsB7E,SAAtB,CAAjB;SADD,MAGK;iBACG,IAAP;;;;;;;UAOEqH,EAAJ;;UACInL,SAAS,CAACc,MAAV,IAAoB,CAAxB,EAA0B;QACzBqK,EAAE,GAAG,IAAI3E,aAAJ,EAAL;aACKiK,sBAAL,CAA4BtF,EAA5B,EAAgC,CAAhC,EAAmC,IAAnC;eACOA,EAAE,CAAC7I,QAAH,EAAP;;;MAGD6I,EAAE,GAAGnL,SAAS,CAAC,CAAD,CAAd;UACI0Q,WAAW,GAAG1Q,SAAS,CAAC,CAAD,CAA3B;UACI2Q,UAAU,GAAG3Q,SAAS,CAAC,CAAD,CAA1B;;eAES4Q,iBAAT;YACOC,eAAe,GAAG,CAAxB;;aACI,IAAIhQ,CAAC,GAAG,CAAZ,EAAeA,CAAC,GAAGgQ,eAAe,GAACH,WAAnC,EAAgD,EAAE7P,CAAlD,EAAqD;UACpDsK,EAAE,CAACzE,MAAH,CAAU,GAAV;;;;MAIFkK,iBAAiB;MACjBzF,EAAE,CAACzE,MAAH,CAAU,GAAV;;UAEI,KAAKhD,YAAT,EAAuB;QACtByH,EAAE,CAAC2F,YAAH,CAAgB,QAAhB,EAA0B,KAAKzO,IAA/B;;;UAGG,QAAQsO,UAAZ,EAAwB;QACvBxF,EAAE,CAACzE,MAAH,CAAU,QAAV;;;MAGDyE,EAAE,CAAC4F,UAAH;MAEAL,WAAW;;WAEN,IAAI7P,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKwF,OAAL,CAAavF,MAAjC,EAAyC,EAAED,CAA3C,EAA8C;YAEzCuC,GAAG,GAAG,KAAKiD,OAAL,CAAaxF,CAAb,CAAV;;YAEIuC,GAAG,YAAYmB,SAAnB,EAA8B;cAEzB2B,SAAS,GAAG9C,GAAhB;UAEA8C,SAAS,CAACuK,sBAAV,CAAiCtF,EAAjC,EAAqCuF,WAArC,EAAkDC,UAAlD;SAJD,MAMO;UACNC,iBAAiB;;cACbxN,GAAG,YAAY+J,WAAnB,EAAgC;YAC/BhC,EAAE,CAACzE,MAAH,CAAU,IAAV;YACAyE,EAAE,CAACzE,MAAH,CAAUtD,GAAG,CAACd,QAAJ,GAAeuE,OAAf,CAAuB,IAAvB,EAA6B,KAA7B,CAAV;YACAsE,EAAE,CAACzE,MAAH,CAAU,IAAV;WAHD,MAIO;YACNyE,EAAE,CAACzE,MAAH,CAAUtD,GAAG,CAACd,QAAJ,EAAV;;;;YAIEzB,CAAC,IAAI,KAAKwF,OAAL,CAAavF,MAAb,GAAsB,CAA/B,EAAkC;UACjCqK,EAAE,CAACzE,MAAH,CAAU,GAAV;;;YAGI,EAAEtD,GAAG,YAAYmB,SAAjB,KAA+BnB,GAAG,IAAIuN,UAA3C,EAAwD;UACvDxF,EAAE,CAACzE,MAAH,CAAU,QAAV;;;QAGDyE,EAAE,CAAC4F,UAAH;;;UAGGC,SAAS,GAA+B,IAAI/E,GAAJ,EAA5C;;;;;;8BAEyB,KAAK6D,YAA9B,mIAA2C;;cAAjCtI,IAAiC;cAA5B5F,MAA4B;;cACtC,KAAKyE,OAAL,CAAaC,OAAb,CAAqBhD,UAAU,CAAC1B,MAAD,EAAQkC,SAAR,CAA/B,KAAsD,CAA1D,EAA6D;;WAA7D,MAEO;YACNkN,SAAS,CAACnH,GAAV,CAAcrC,IAAd,EAAmB5F,MAAnB;;;;;;;;;;;;;;;;;;UAIEoP,SAAS,CAAC3F,IAAV,GAAiB,CAArB,EAAwB;QACvBuF,iBAAiB;QACjBzF,EAAE,CAAC4F,UAAH,CAAc,cAAd;;;;;;gCAEyBC,SAAzB,mIAAmC;;gBAAzBxJ,GAAyB;gBAApB5F,KAAoB;;YAClCa,KAAK,CAACC,UAAN,CAAiBd,KAAjB,EAAwB2C,SAAxB,EAAmC,qCAAnC;gBACI2B,UAAS,GAAGtE,KAAhB;;YACAsE,UAAS,CAACuK,sBAAV,CAAiCtF,EAAjC,EAAqCuF,WAArC,EAAkDC,UAAlD;;YACAxF,EAAE,CAAC4F,UAAH;;;;;;;;;;;;;;;;;;MAIFL,WAAW;MAEXE,iBAAiB;MACjBzF,EAAE,CAACzE,MAAH,CAAU,GAAV;;;;;aA/RO,KAAKrE,IAAL,IAAa,IAAb,IAAqB,KAAKA,IAAL,CAAUvB,MAAV,GAAmB,CAA/C;;;;;aAGO,KAAK2O,QAAZ;KAhBF;sBAkBa7N,KAlBb;WAmBO2N,UAAL,CAAgB3N,KAAhB;;;;;UAGIqP,oBAAoB,GAAkC,IAAIhF,GAAJ,EAA1D;;;;;;8BAEyB,KAAK6D,YAA9B,mIAA2C;;cAAjCtI,GAAiC;cAA5B5F,KAA4B;;cACtCsP,SAAS,GAAG5N,UAAU,CAAC1B,KAAD,EAAQkC,SAAR,CAA1B;UACAmN,oBAAoB,CAACpH,GAArB,CAAyBrC,GAAzB,EAA8B0J,SAA9B;;;;;;;;;;;;;;;;;;;;;;8BAGa,KAAK7K,OAAnB,mIAA2B;cAAlBjF,CAAkB;cACtB+P,KAAK,GAAG1N,qBAAqB,CAACrC,CAAD,CAAjC;;cACI+P,KAAK,IAAI,IAAT,IAAiBA,KAAK,CAACzN,YAA3B,EAAyC;YACxCuN,oBAAoB,UAApB,CAA4BE,KAAK,CAAC9O,IAAlC;;;;;;;;;;;;;;;;;;UAIE4O,oBAAoB,CAAC5F,IAArB,IAA6B,CAAjC,EACC4F,oBAAoB,GAAG,IAAvB;aAEMA,oBAAP;KAvCF;sBAyCsBrP,KAzCtB;UA0CMwP,iBAAiB,GAAG,KAAKC,gBAA7B;;UACID,iBAAiB,IAAI,IAAzB,EAA+B;;;;;;gCACPA,iBAAvB,mIAAyC;;gBAA/B5J,GAA+B;gBAA1B8E,GAA0B;;iBACnCwD,YAAL,WAAyBtI,GAAzB;;;;;;;;;;;;;;;;;;UAIE5F,KAAK,IAAI,IAAb,EACC;;;;;;8BAEsBA,KAAvB,mIAA6B;;cAAnB4F,KAAmB;cAAd8E,IAAc;;cACxB6E,KAAK,GAAG1N,qBAAqB,CAAC6I,IAAD,CAAjC;cACI6E,KAAK,IAAI,IAAb,EACC,KAAKvB,qBAAL,CAA2BuB,KAA3B;;;;;;;;;;;;;;;;;;;;UAIEG,KAAK,GAAyB,CAAlC;UACI,KAAKC,qBAAT,EAAmCD,KAAK,IAAI/M,SAAS,CAACiN,UAAV,CAAqBC,MAA9B;UAC/B,KAAKC,wBAAT,EAAmCJ,KAAK,IAAI/M,SAAS,CAACiN,UAAV,CAAqBG,KAA9B;UAC/B,KAAKC,mBAAT,EAAmCN,KAAK,IAAI/M,SAAS,CAACiN,UAAV,CAAqBK,cAA9B;;UAE/BP,KAAK,IAAI/M,SAAS,CAACiN,UAAV,CAAqBK,cAAlC,EAAkD;QACjDP,KAAK,GAAG,CAAR;;;aAGMA,KAAP;KApEF;sBAsEgB1P,KAtEhB;UAuEMkQ,IAAI,GAAyBlQ,KAAjC;UACI,CAACkQ,IAAI,GAAGvN,SAAS,CAACiN,UAAV,CAAqBC,MAA7B,IAAuC,CAA3C,EAA8C,KAAKF,qBAAL,GAA6B,IAA7B;UAC1C,CAACO,IAAI,GAAGvN,SAAS,CAACiN,UAAV,CAAqBG,KAA7B,IAAsC,CAA1C,EAA8C,KAAKD,wBAAL,GAAgC,IAAhC;UAC1C,CAACI,IAAI,GAAGvN,SAAS,CAACiN,UAAV,CAAqBK,cAA7B,IAA+C,CAAnD,EAAsD,KAAKD,mBAAL,GAA2B,IAA3B;;;;;UAGlD,KAAKG,uBAAL,IAAgC,IAApC,EACC,KAAKA,uBAAL,GAA+B,KAAK5P,IAAL,CAAUwD,mBAAV,CAA8B,KAAKqM,8BAAnC,CAA/B;aAEM,KAAKD,uBAAZ;;;;;UAGIE,UAAU,GAAqB,EAAnC;UACI/L,SAAS,GAAc,IAA3B;;aACOA,SAAS,YAAY3B,SAA5B,EAAuC;YAClC2B,SAAS,CAACG,OAAV,CAAkBvF,MAAlB,GAA2B,CAA/B,EAAkC;UACjCmR,UAAU,CAAC5R,IAAX,CAAgB,IAAIT,IAAI,CAACM,SAAT,CAAmB,CAAnB,CAAhB;UACAgG,SAAS,GAAGA,SAAS,CAACG,OAAV,CAAkB,CAAlB,CAAZ;;;;aAGK,IAAIzG,IAAJ,CAASqS,UAAT,CAAP;;;;;EA3F6BnO,SAA/B;;AAgTA,WAAiBS;MACJiN,UAAZ;;aAAYA;IACXA,oCAAA,WAAA;IACAA,mCAAA,UAAA;IACAA,4CAAA,mBAAA;GAHD,EAAYA,UAAU,GAAVjN,oBAAA,KAAAA,oBAAA,KAAA,CAAZ;CADD,EAAiBA,SAAS,KAATA,SAAS,KAAA,CAA1B;;ICzTa2N,IAAb;;AAAA;;;;;;;;;;;;aAES,MAAP;;;;;EAFwBpO,SAA1B;;ICAaqO,cAAb;;AAAA;;;;;;aAKS,KAAKC,YAAZ;;;;;;;QAGWC,kFAA0CF,cAAc,CAACG,WAAf,CAA2BC;;;;;UAE3EH,YAAL,GAAoBC,WAApB;;;;;;;aAIO,IAAIF,cAAJ,CAAmB,KAAKE,WAAxB,CAAP;;;;;aA2EO,KAAKA,WAAL,CAAiB/P,QAAjB,EAAP;;;;;aAxEO,IAAI6P,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BE,SAA9C,CAAP;;;;;aAGO,IAAIL,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BG,UAA9C,CAAP;;;;;aAGO,IAAIN,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BI,OAA9C,CAAP;;;;;aAGO,IAAIP,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BK,SAA9C,CAAP;;;;;aAGO,IAAIR,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BM,iBAA9C,CAAP;;;;;aAGO,IAAIT,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BO,WAA9C,CAAP;;;;;aAGO,IAAIV,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BQ,SAA9C,CAAP;;;;;aAGO,IAAIX,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BS,WAA9C,CAAP;;;;;aAGO,IAAIZ,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BU,SAA9C,CAAP;;;;;aAGO,IAAIb,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BW,IAA9C,CAAP;;;;;aAGO,IAAId,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BY,WAA9C,CAAP;;;;;aAGO,IAAIf,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BX,KAA9C,CAAP;;;;;aAGO,IAAIQ,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2Ba,UAA9C,CAAP;;;;;aAGO,IAAIhB,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2Bc,SAA9C,CAAP;;;;;aAGO,IAAIjB,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2Be,MAA9C,CAAP;;;;;aAGO,IAAIlB,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BgB,UAA9C,CAAP;;;;;aAGO,IAAInB,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BiB,UAA9C,CAAP;;;;;aAGO,IAAIpB,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BkB,oBAA9C,CAAP;;;;;aAGO,IAAIrB,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BmB,WAA9C,CAAP;;;;;aAGO,IAAItB,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BoB,IAA9C,CAAP;;;;;aAGO,IAAIvB,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BqB,GAA9C,CAAP;;;;;aAGO,IAAIxB,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BsB,WAA9C,CAAP;;;;;aAGO,IAAIzB,cAAJ,CAAmBA,cAAc,CAACG,WAAf,CAA2BuB,SAA9C,CAAP;;;;;aAGO,IAAI1B,cAAJ,CAAoBA,cAAc,CAACG,WAAf,CAA2BwB,UAA/C,CAAP;;;;;EAtFkChQ,SAApC;;AA6FA,WAAiBqO;MACJG,WAAZ;;aAAYA;IACXA,uCAAA,WAAA;IACAA,yCAAA,cAAA;IACAA,0CAAA,eAAA;IACAA,uCAAA,YAAA;IACAA,yCAAA,cAAA;IACAA,iDAAA,sBAAA;IACAA,2CAAA,gBAAA;IACAA,yCAAA,cAAA;IACAA,2CAAA,gBAAA;IACAA,yCAAA,cAAA;IACAA,oCAAA,SAAA;IACAA,4CAAA,gBAAA;IACAA,sCAAA,UAAA;IACAA,2CAAA,eAAA;IACAA,uCAAA,WAAA;IACAA,2CAAA,eAAA;IACAA,2CAAA,eAAA;IACAA,qDAAA,yBAAA;IACAA,4CAAA,gBAAA;IACAA,qCAAA,SAAA;IACAA,oCAAA,QAAA;IACAA,4CAAA,gBAAA;IACAA,0CAAA,cAAA;IACAA,2CAAA,eAAA;IACAA,0CAAA,cAAA;IAEAA,6CAAA,iBAAA;GA3BD,EAAYA,WAAW,GAAXH,0BAAA,KAAAA,0BAAA,KAAA,CAAZ;CADD,EAAiBA,cAAc,KAAdA,cAAc,KAAA,CAA/B;;AC/FA,IAAY4B,WAAZ;;AAAA,WAAYA;EACXA,sCAAA,WAAA;EACAA,wCAAA,aAAA;EACAA,0DAAA,+BAAA;CAHD,EAAYA,WAAW,KAAXA,WAAW,KAAA,CAAvB;;ICIaC,OAAb;;AAAA;;;;kBACS,GAA8B,IAA9B;cACA,GAAgB,CAAC,CAAjB;;QAKHhU,SAAS,CAACc,MAAV,KAAqB,CAAzB,EAA4B;WACtBoF,SAAL,GAAiBlG,SAAS,CAAC,CAAD,CAA1B;WACKS,KAAL,GAAaT,SAAS,CAAC,CAAD,CAAtB;;;;;;;UAKG,KAAKS,KAAL,GAAa,CAAjB,EAAoB,OAAO,KAAKyF,SAAZ;UAChB,KAAKA,SAAL,IAAkB,IAAtB,EAA4B,OAAO,IAAP;UACxB,KAAKA,SAAL,CAAeG,OAAf,CAAuBvF,MAAvB,IAAiC,CAArC,EAAwC,OAAO,KAAKoF,SAAZ;UACpC,KAAKzF,KAAL,IAAc,KAAKyF,SAAL,CAAeG,OAAf,CAAuBvF,MAAzC,EAAiD,OAAO,IAAP;aAE1C,KAAKoF,SAAL,CAAeG,OAAf,CAAuB,KAAK5F,KAA5B,CAAP;;;;;UAiBI,CAAC,KAAKyF,SAAV,EACC,OAAO,oBAAP;aAEM,oBAAoB,KAAKA,SAAL,CAAe/D,IAAf,CAAoBG,QAApB,EAApB,GAAqD,YAArD,GAAoE,KAAK7B,KAAhF;KAvCF;;;;;;aA6CS,IAAIuT,OAAJ,CAAY,KAAK9N,SAAjB,EAA4B,KAAKzF,KAAjC,CAAP;;;;;aAtBO,KAAKyF,SAAL,IAAkB,IAAzB;;;;;UAII,KAAKuF,MAAT,EAAiB,OAAO,IAAP;UAEb,KAAKhL,KAAL,IAAc,CAAlB,EACC,OAAO,KAAKyF,SAAL,CAAgB/D,IAAhB,CAAqB8R,wBAArB,CAA8C,IAAIrU,IAAI,CAACM,SAAT,CAAmB,KAAKO,KAAxB,CAA9C,CAAP,CADD,KAGC,OAAO,KAAKyF,SAAL,CAAgB/D,IAAvB;;;;4BAgBoB+D,SAhDvB;aAiDS,IAAI8N,OAAJ,CAAY9N,SAAZ,EAAuB,CAAvB,CAAP;;;;;aAIO,IAAI8N,OAAJ,CAAY,IAAZ,EAAkB,CAAC,CAAnB,CAAP;;;;;;;ICjDWE,MAAb;;AAAA;;;kBAkEaC,aAAZ;;;;;;qBAlDO,GAA2B,IAA3B;wBAqBA,GAA0BH,OAAO,CAACrM,IAAlC;4BAgBA,GAAoC,IAApC;uBAKA,GAAyB,KAAzB;uBACA,GAA6B,CAA7B;oBAEA,GAAsB,KAAtB;sBACA,GAAuB,CAAvB;uBAEA,GAAyB,KAAzB;UAIDyM,aAAL,GAAqB,KAArB;;QAEI,OAAOD,aAAP,KAAyB,WAA7B,EAA0C;YACpCC,aAAL,GAAqB,IAArB;YACKD,aAAL,GAAqBA,aAArB;;;;;;;;2BAIY/Q,GA5Ef;UA6EMiR,WAAW,GAAGjR,GAAlB;;UACIiR,WAAW,YAAYH,MAA3B,EAAmC;YAC9B,KAAKI,iBAAL,IAA0BD,WAAW,CAACC,iBAA1C,EAA6D;cACxD,KAAKA,iBAAT,EAA4B;mBACpB,KAAKC,kBAAL,IAA2BF,WAAW,CAACE,kBAA9C;WADD,MAEO;gBACF,KAAKnG,UAAL,KAAoB,IAAxB,EAA8B,OAAOvK,kBAAkB,CAAC,iBAAD,CAAzB;mBACvB,KAAKuK,UAAL,CAAgBjN,MAAhB,CAAuBkT,WAAW,CAACjG,UAAnC,CAAP;;;;;aAII,KAAP;;;;;UAII,KAAKkG,iBAAT,EAA4B;eACpB,sBAAsB,KAAKC,kBAA3B,GAAgD,GAAvD;OADD,MAGK,IAAI,KAAKnG,UAAL,IAAmB,IAAvB,EAA6B;eAC1B,cAAP;OADI,MAEE;YAEFjD,EAAE,GAAG,IAAI3E,aAAJ,EAAT;YAEIgO,SAAS,GAAG,KAAKpG,UAAL,CAAgB9L,QAAhB,EAAhB,CAJM;;YAMFmS,aAAa,GAAG,IAApB;;YACIA,aAAa,IAAI,IAArB,EAA2B;UAC1BD,SAAS,GAAG,UAAUC,aAAtB;;;QAGDtJ,EAAE,CAACzE,MAAH,CAAU,QAAV;YAEI,KAAKgO,aAAT,EACCvJ,EAAE,CAACzE,MAAH,CAAU,GAAV;;YAEG,KAAK0N,aAAT,EAAwB;cACnB,KAAKD,aAAL,IAAsBJ,WAAW,CAACY,QAAtC,EAAgD;YAC/CxJ,EAAE,CAACzE,MAAH,CAAU,WAAV;WADD,MAEO;YACNyE,EAAE,CAACzE,MAAH,CAAU,SAAV;;;;QAIFyE,EAAE,CAACzE,MAAH,CAAU,MAAV;QACAyE,EAAE,CAACzE,MAAH,CAAU,KAAKkO,gBAAf;QAEAzJ,EAAE,CAACzE,MAAH,CAAU,IAAV;QACAyE,EAAE,CAACzE,MAAH,CAAU8N,SAAV;QACArJ,EAAE,CAACzE,MAAH,CAAU,GAAV;eAEOyE,EAAE,CAAC7I,QAAH,EAAP;;;;;;UA9HG,KAAKuS,WAAL,IAAoB,IAApB,IAA4B,KAAKA,WAAL,CAAiB5T,UAAjD,EAA6D;YACxD6T,SAAS,GAAG,KAAKC,aAAL,CAAmBC,OAAnB,EAAhB;;YACIF,SAAJ,EAAe;eACTD,WAAL,GAAmBC,SAAS,CAAC3S,IAA7B;;;;aAIK,KAAK0S,WAAZ;KATF;sBAWgBjT,KAXhB;WAYOiT,WAAL,GAAmBjT,KAAnB;WACKqT,cAAL,GAAsBjB,OAAO,CAACrM,IAA9B;;;;;UAMI,KAAKsN,cAAL,CAAoBxJ,MAAxB,EAAgC;YAC3BqJ,SAAS,GAAG,KAAKI,WAAL,CAAiB,KAAKL,WAAtB,EAAmCzR,GAAnD;YAEI,KAAKyR,WAAL,KAAqB,IAAzB,EAA+B,OAAOhR,kBAAkB,CAAC,kBAAD,CAAzB;YAC3B,KAAKgR,WAAL,CAAiBM,aAAjB,KAAmC,IAAvC,EAA6C,OAAOtR,kBAAkB,CAAC,gCAAD,CAAzB;;YAEzC,KAAKgR,WAAL,CAAiBM,aAAjB,CAA+BzT,OAAnC,EAA4C;cACvCoT,SAAS,KAAK,IAAlB,EAAwB,OAAOjR,kBAAkB,CAAC,WAAD,CAAzB;eACnBoR,cAAL,CAAoB/O,SAApB,GAAiC4O,SAAS,CAACtQ,MAAV,YAA4BD,SAA7B,GAA0CuQ,SAAS,CAACtQ,MAApD,GAA6D,IAA7F;eACKyQ,cAAL,CAAoBxU,KAApB,GAA4B,KAAKoU,WAAL,CAAiBM,aAAjB,CAA+B1U,KAA3D;SAHD,MAIO;eACDwU,cAAL,GAAsBjB,OAAO,CAACoB,OAAR,CAAiBN,SAAS,YAAYvQ,SAAtB,GAAmCuQ,SAAnC,GAA+C,IAA/D,CAAtB;;;;aAIK,KAAKG,cAAL,CAAoBI,IAApB,EAAP;;;;;UAMI,KAAKjH,UAAL,IAAmB,IAAvB,EACC,OAAO,IAAP;aAEM,KAAKkH,iBAAL,CAAuB,KAAKlH,UAA5B,CAAP;KA3CF;sBA6CsBxM,KA7CtB;UA8CMA,KAAK,IAAI,IAAb,EAAmB;aACbwM,UAAL,GAAkB,IAAlB;OADD,MAEO;aACDA,UAAL,GAAkB,IAAIxO,IAAJ,CAASgC,KAAT,CAAlB;;;;;;aAMM,KAAK2S,kBAAL,IAA2B,IAAlC;;;;;EAvD0BzQ,SAA5B;;ICHayR,WAAb;;AAAA;;;;;;QAQaC,+EAAoB;;;;;uBAPzB,GAA6B,IAA7B;sBACA,GAAwB,KAAxB;yBACA,GAA2B,KAA3B;8BACA,GAAgC,KAAhC;4BACA,GAA8B,KAA9B;kBACA,GAAoB,IAApB;UAIDA,QAAL,GAAgBA,QAAhB;;;;;;;UA0CI,KAAKC,YAAL,KAAsB,IAA1B,EAAgC,OAAO5R,kBAAkB,CAAC,0BAAD,CAAzB;AAGhC,UAAI6R,YAAY,GAAG,KAAKD,YAAL,CAAkBnT,QAAlB,EAAnB;;aAMO,gBAAgBoT,YAAvB;;;;;UAhDI,KAAKC,aAAL,IAAsB,IAAtB,IAA8B,KAAKA,aAAL,CAAmB1U,UAArD,EAAiE;YAC5D2U,eAAe,GAAG,KAAKC,YAA3B;;YACID,eAAJ,EAAqB;eACfD,aAAL,GAAqBC,eAAe,CAACzT,IAArC;;;;aAGK,KAAKwT,aAAZ;KAnBF;sBAqBkB/T,KArBlB;WAsBO+T,aAAL,GAAqB/T,KAArB;;;;;UAGI,KAAK+T,aAAL,KAAuB,IAA3B,EAAiC,OAAO9R,kBAAkB,CAAC,2BAAD,CAAzB;aAC1B,KAAKqR,WAAL,CAAiB,KAAKS,aAAtB,EAAqCzP,SAA5C;;;;;UAGI,KAAKuP,YAAL,KAAsB,IAA1B,EAAgC,OAAO5R,kBAAkB,CAAC,0BAAD,CAAzB;aACzB,KAAKyR,iBAAL,CAAuB,KAAKG,YAA5B,CAAP;KA9BF;sBAgCwB7T,KAhCxB;WAiCO6T,YAAL,GAAoB,IAAI7V,IAAJ,CAASgC,KAAT,CAApB;;;;;UAGI0P,KAAK,GAAG,CAAZ;UACI,KAAKwE,YAAT,EAA+BxE,KAAK,IAAI,CAAT;UAC3B,KAAKyE,eAAT,EAA+BzE,KAAK,IAAI,CAAT;UAC3B,KAAK0E,oBAAT,EAA+B1E,KAAK,IAAI,CAAT;UAC3B,KAAK2E,kBAAT,EAA+B3E,KAAK,IAAI,CAAT;UAC3B,KAAKkE,QAAT,EAA+BlE,KAAK,IAAI,EAAT;aACxBA,KAAP;KA1CF;sBA4CW1P,KA5CX;WA6COkU,YAAL,GAAoB,CAAClU,KAAK,GAAG,CAAT,IAAc,CAAlC;WACKmU,eAAL,GAAuB,CAACnU,KAAK,GAAG,CAAT,IAAc,CAArC;WACKoU,oBAAL,GAA4B,CAACpU,KAAK,GAAG,CAAT,IAAc,CAA1C;WACKqU,kBAAL,GAA0B,CAACrU,KAAK,GAAG,CAAT,IAAc,CAAxC;WACK4T,QAAL,GAAgB,CAAC5T,KAAK,GAAG,EAAT,IAAe,CAA/B;;;;;EAjD+BkC,SAAjC;;ICFaoS,iBAAb;;AAAA;;;;;;QAuBa7T,2EAAsB;;;;;sBApB3B,GAA4B,IAA5B;UAsBDA,IAAL,GAAYA,IAAZ;;;;;;;UAII,KAAKA,IAAL,IAAa,IAAjB,EAAuB;eACf,SAAS,KAAKA,IAAd,GAAqB,GAA5B;OADD,MAEO;YACF8T,OAAO,GAAG,KAAKC,kBAAnB;eACO,gBAAgBD,OAAhB,GAA0B,GAAjC;;;;;;UA3BG,KAAKE,YAAL,KAAsB,IAA1B,EACC,OAAO,IAAP;aACM,KAAKnB,WAAL,CAAiB,KAAKmB,YAAtB,EAAoCnQ,SAA3C;;;;;UAGG,KAAKmQ,YAAL,KAAsB,IAAzB,EACC,OAAO,IAAP;aAEM,KAAKf,iBAAL,CAAuB,KAAKe,YAA5B,CAAP;KAdF;sBAgBwBzU,KAhBxB;UAiBMA,KAAK,KAAK,IAAd,EACC,KAAKyU,YAAL,GAAoB,IAApB,CADD,KAGC,KAAKA,YAAL,GAAoB,IAAIzW,IAAJ,CAASgC,KAAT,CAApB;;;;;EApBoCkC,SAAvC;;ICDawS,kBAAb;;AAAA;;;8BAMa/H,YAAZ,EAAyCgI,gBAAzC;;;;;;UAEMhI,YAAL,GAAoBA,YAAY,IAAI,IAApC;UACKgI,gBAAL,GAAwB,CAAC,CAACA,gBAA1B;UACKC,QAAL,GAAgB,KAAhB;;;;;;;aAIO,kBAAkB,KAAKjI,YAA9B;;;;;EAdsCzK,SAAxC;;ICAa2S,IAAb;;AAAA;;;;;;;;;;EAA0B3S,SAA1B;;ICUa4S,kBAAb;;AAAA;;;;;;;;;eAuDQ,GAAuB,IAAvB;6BAYA,GAA8B,CAA9B;oBAmXA,GAAwC,IAAxC;sBACA,GAAwB,KAAxB;yBACA,GAAuE,IAAvE;;QA/KF1W,SAAS,CAACc,MAAV,KAAqB,CAAzB,EAA4B;MAC3B4V,kBAAkB,CAACC,kCAAnB;KADD,MAGK,IAAI3W,SAAS,CAACc,MAAV,KAAqB,CAAzB,EAA4B;UAC5BuB,IAAI,GAAGrC,SAAS,CAAC,CAAD,CAApB;MACA0W,kBAAkB,CAACC,kCAAnB;YACKtU,IAAL,GAAYA,IAAZ;KAHI,MAKA,IAAIrC,SAAS,CAACc,MAAV,KAAqB,CAAzB,EAA4B;UAC5BuB,KAAI,GAAGrC,SAAS,CAAC,CAAD,CAApB;UACI4W,kBAAkB,GAAG5W,SAAS,CAAC,CAAD,CAAlC;YAEK6W,YAAL,GAAoB,IAApB;YACKxU,IAAL,GAAYA,KAAZ;YACKuU,kBAAL,GAA0BA,kBAA1B;;;;GAvRH;;;;;yBAqEaE,UArEb;UAsEM,KAAKC,UAAT,EAAqB;eACb,KAAKA,UAAL,CAAgBC,IAAhB,CAAqBF,UAArB,CAAP;;;UAGG,KAAKF,kBAAL,IAA2BE,UAAU,CAAChW,MAA1C,EAAkD;cAC3C,IAAIyC,KAAJ,CAAU,iCAAV,CAAN;;;UAGG0T,OAAO,GAAI,KAAf;;;;;;6BACcH,UAAd,8HAA0B;cAAjBnW,CAAiB;cACrBA,CAAC,YAAY8V,IAAjB,EAAuB,MAAM,IAAIvK,cAAJ,CAAmB,sHAAnB,CAAN;cACnBvL,CAAC,YAAY6M,SAAjB,EACCyJ,OAAO,GAAG,IAAV;;;;;;;;;;;;;;;;;UAGEH,UAAU,CAAChW,MAAX,IAAqB,CAArB,IAA0BmW,OAA9B,EAAsC;eAC9B,KAAKC,uBAAL,CAA6BJ,UAA7B,CAAP;;;UAGGK,aAAa,GAAG,KAAKC,wBAAL,CAA8BN,UAA9B,CAApB;UACIO,WAAW,GAAGF,aAAa,CAAC,CAAD,CAAb,CAAiBlK,SAAnC;;UAEIoK,WAAW,IAAI3J,SAAS,CAACG,GAA7B,EAAkC;eAC1B,KAAKyJ,QAAL,CAAsBH,aAAtB,CAAP;OADD,MAEO,IAAIE,WAAW,IAAI3J,SAAS,CAACC,KAA7B,EAAoC;eACnC,KAAK2J,QAAL,CAAsBH,aAAtB,CAAP;OADM,MAEA,IAAIE,WAAW,IAAI3J,SAAS,CAACN,MAA7B,EAAqC;eACpC,KAAKkK,QAAL,CAAsBH,aAAtB,CAAP;OADM,MAEA,IAAIE,WAAW,IAAI3J,SAAS,CAACW,YAA7B,EAA2C;eAC1C,KAAKiJ,QAAL,CAAoBH,aAApB,CAAP;OADM,MAEA,IAAIE,WAAW,IAAI3J,SAAS,CAACiB,IAA7B,EAAmC;eAClC,KAAK2I,QAAL,CAAuBH,aAAvB,CAAP;;;aAGM,IAAP;;;;6BAGkBI,sBA3GpB;UA4GMC,MAAM,GAAGlU,UAAU,CAACiU,sBAAsB,CAAC,CAAD,CAAvB,EAA4BxO,KAA5B,CAAvB;UACI0O,OAAO,GAAGD,MAAM,CAACvK,SAArB;UAEIyK,IAAI,GAAGF,MAAX;UAEIG,UAAU,GAAGJ,sBAAsB,CAACzW,MAAxC;;UAEI6W,UAAU,IAAI,CAAd,IAAmBA,UAAU,IAAI,CAArC,EAAwC;YACnC,KAAKC,eAAL,KAAyB,IAA7B,EAAmC,OAAO/T,kBAAkB,CAAC,oCAAD,CAAzB;;YAC/BgU,YAAY,GAAG,KAAKD,eAAL,CAAqBrL,GAArB,CAAyBkL,OAAzB,CAAnB;;YACI,CAACI,YAAL,EAAmB;gBACZ,IAAI3L,cAAJ,CAAmB,8BAA4B,KAAK7J,IAAjC,GAAsC,MAAtC,GAA6CoV,OAAhE,CAAN;;;YAGGE,UAAU,IAAI,CAAlB,EAAqB;cAChBG,MAAM,GAAGxU,UAAU,CAACiU,sBAAsB,CAAC,CAAD,CAAvB,EAA4BxO,KAA5B,CAAvB;cAEIgP,IAAI,GAAGD,MAAX;cAEIE,SAAS,GAAGH,YAAhB;cAEIH,IAAI,CAAC9V,KAAL,KAAe,IAAf,IAAuBmW,IAAI,CAACnW,KAAL,KAAe,IAA1C,EAAgD,OAAOiC,kBAAkB,CAAC,yCAAD,CAAzB;cAC5CoU,SAAS,GAAGD,SAAS,CAACN,IAAI,CAAC9V,KAAN,EAAamW,IAAI,CAACnW,KAAlB,CAAzB;iBAEOmH,KAAK,CAAC+D,MAAN,CAAamL,SAAb,CAAP;SAVD,MAaK;cAEAD,UAAS,GAAGH,YAAhB;cAEIH,IAAI,CAAC9V,KAAL,KAAe,IAAnB,EAAyB,OAAOiC,kBAAkB,CAAC,uCAAD,CAAzB;;cACrBoU,UAAS,GAAGD,UAAS,CAACN,IAAI,CAAC9V,KAAN,CAAzB;;iBAEOmH,KAAK,CAAC+D,MAAN,CAAamL,UAAb,CAAP;;OA3BF,MA+BK;cACE,IAAI1U,KAAJ,CAAU,4DAA4DgU,sBAAsB,CAACzW,MAA7F,CAAN;;;;;4CAI6BgW,UAvJhC;UAwJM,CAAC,KAAKzU,IAAL,IAAa,GAAb,IAAoB,KAAKA,IAAL,IAAa,GAAlC,KAA0CyU,UAAU,CAAC,CAAD,CAAV,YAAyBtJ,SAAnE,IAAgFsJ,UAAU,CAAC,CAAD,CAAV,YAAyBzJ,QAA7G,EACC,OAAO,KAAK6K,0BAAL,CAAgCpB,UAAhC,CAAP;UAEGqB,EAAE,GAAG7U,UAAU,CAACwT,UAAU,CAAC,CAAD,CAAX,EAAgB/N,KAAhB,CAAnB;UACIqP,EAAE,GAAG9U,UAAU,CAACwT,UAAU,CAAC,CAAD,CAAX,EAAgB/N,KAAhB,CAAnB;;UAEI,CAAC,KAAK1G,IAAL,IAAa,IAAb,IAAqB,KAAKA,IAAL,IAAa,IAAnC,MAA6C8V,EAAE,CAAClL,SAAH,IAAgBS,SAAS,CAACiB,IAA1B,IAAkCyJ,EAAE,CAACnL,SAAH,IAAgBS,SAAS,CAACiB,IAAzG,CAAJ,EAAoH;YAC/G,KAAKiJ,eAAL,KAAyB,IAA7B,EAAmC,OAAO/T,kBAAkB,CAAC,oCAAD,CAAzB;;YAC/BwU,EAAE,GAAG,KAAKT,eAAL,CAAqBrL,GAArB,CAAyBmB,SAAS,CAACG,GAAnC,CAAT;;YACIwK,EAAE,KAAK,IAAX,EAAiB,OAAOxU,kBAAkB,CAAC,+CAAD,CAAzB;YACb8E,MAAM,GAAG0P,EAAE,CAACF,EAAE,CAACG,QAAH,GAAc,CAAd,GAAkB,CAAnB,EAAsBF,EAAE,CAACE,QAAH,GAAc,CAAd,GAAkB,CAAxC,CAAf;eACO,IAAIjL,QAAJ,CAAa1E,MAAb,CAAP;;;UAGGwP,EAAE,CAAClL,SAAH,IAAgBS,SAAS,CAACiB,IAA1B,IAAkCyJ,EAAE,CAACnL,SAAH,IAAgBS,SAAS,CAACiB,IAAhE,EACC,OAAO,KAAK2I,QAAL,CAAuB,CAACa,EAAD,EAAKC,EAAL,CAAvB,CAAP;YAEK,IAAIlM,cAAJ,CAAmB,sBAAsB,KAAK7J,IAA3B,GAAkC,gBAAlC,GAAqD8V,EAAE,CAAClL,SAAxD,GAAoE,OAApE,GAA8EmL,EAAE,CAACnL,SAApG,CAAN;;;;+CAGiCsL,aA5KnC;UA6KMC,OAAO,GAAGlV,UAAU,CAACiV,aAAa,CAAC,CAAD,CAAd,EAAmB/K,SAAnB,CAAxB;UACIrE,MAAM,GAAG7F,UAAU,CAACiV,aAAa,CAAC,CAAD,CAAd,EAAmBlL,QAAnB,CAAvB;UAEIoL,aAAa,GAAG,IAAI1Q,OAAJ,EAApB;UAEIyQ,OAAO,CAAC5W,KAAR,KAAkB,IAAtB,EAA4B,OAAOiC,kBAAkB,CAAC,6DAAD,CAAzB;;;;;;8BACa2U,OAAO,CAAC5W,KAAjD,mIAAwD;;cAA9C8W,WAA8C;cAAjCC,aAAiC;;cACnDC,QAAQ,GAAG5R,WAAW,CAACyC,iBAAZ,CAA8BiP,WAA9B,CAAf;cAEI,KAAKd,eAAL,KAAyB,IAA7B,EAAmC,OAAO/T,kBAAkB,CAAC,oCAAD,CAAzB;;cAC/BgV,KAAK,GAAG,KAAKjB,eAAL,CAAqBrL,GAArB,CAAyBmB,SAAS,CAACG,GAAnC,CAAZ;;cAEI1E,MAAM,CAACvH,KAAP,KAAiB,IAArB,EAA2B,OAAOiC,kBAAkB,CAAC,4DAAD,CAAzB;cACvBiV,SAAS,GAAGD,KAAK,CAACF,aAAD,EAAgBxP,MAAM,CAACvH,KAAvB,CAArB;cAEImX,UAAU,GAAG,IAAjB;cACIP,OAAO,CAAC5W,KAAR,CAAc8G,OAAd,KAA0B,IAA9B,EAAoC,OAAO7E,kBAAkB,CAAC,qEAAD,CAAzB;;;;;;kCACjB2U,OAAO,CAAC5W,KAAR,CAAc8G,OAAjC,mIAA0C;kBAAjCQ,MAAiC;;kBACrCA,MAAM,CAAC7G,IAAP,IAAeuW,QAAQ,CAAC3R,UAA5B,EAAwC;gBACvC8R,UAAU,GAAG7P,MAAb;;;;;;;;;;;;;;;;;;;cAIE6P,UAAU,IAAI,IAAlB,EAAwB;gBACnBC,eAAe,GAAGD,UAAU,CAACE,mBAAX,CAA+BH,SAA/B,EAA0C9R,WAAW,CAACW,IAAtD,CAAtB;gBACIqR,eAAe,CAACvQ,MAApB,EACCgQ,aAAa,CAAC5P,GAAd,CAAkBmQ,eAAe,CAACrQ,MAAlC,EAA0CmQ,SAA1C;;;;;;;;;;;;;;;;;;aAII,IAAItL,SAAJ,CAAciL,aAAd,CAAP;;;;6CAG+BS,YA9MjC;UA+MMzB,OAAO,GAAG/J,SAAS,CAACG,GAAxB;UAEIsL,eAAe,GAAqB,IAAxC;;;;;;8BAEgBD,YAAhB,mIAA8B;cAArB9V,GAAqB;;cACzBkJ,KAAG,GAAGhJ,UAAU,CAACF,GAAD,EAAM2F,KAAN,CAApB;;cACIuD,KAAG,CAACW,SAAJ,GAAgBwK,OAApB,EAA6B;YAC5BA,OAAO,GAAGnL,KAAG,CAACW,SAAd;;;cAGGX,KAAG,CAACW,SAAJ,IAAiBS,SAAS,CAACiB,IAA/B,EAAqC;YACnCwK,eAAe,GAAGhW,QAAQ,CAACmJ,KAAD,EAAMkB,SAAN,CAA1B;;;;;;;;;;;;;;;;;;UAIC4L,aAAa,GAAG,EAApB;;UAEI1L,SAAS,CAAC+J,OAAD,CAAT,IAAsB/J,SAAS,CAACA,SAAS,CAACiB,IAAX,CAAnC,EAAqD;;;;;;gCAC3BuK,YAAzB,mIAAsC;gBAA7BG,YAA6B;gBACjC/M,GAAG,GAAGhJ,UAAU,CAAC+V,YAAD,EAAetQ,KAAf,CAApB;;gBACIuD,GAAG,CAACW,SAAJ,IAAiBS,SAAS,CAACiB,IAA/B,EAAqC;cACpCyK,aAAa,CAAC/Y,IAAd,CAAmBiM,GAAnB;aADD,MAEO,IAAIA,GAAG,CAACW,SAAJ,IAAiBS,SAAS,CAACG,GAA/B,EAAoC;kBACtC1E,MAAM,GAAGjH,QAAQ,CAACoK,GAAG,CAACU,WAAL,CAArB;cAEAmM,eAAe,GAAG7V,UAAU,CAAC6V,eAAD,EAAkB3L,SAAlB,CAA5B;kBACI2L,eAAe,CAACvX,KAAhB,KAA0B,IAA9B,EAAoC,OAAOiC,kBAAkB,CAAC,mEAAD,CAAzB;kBAChC6H,IAAI,GAAGyN,eAAe,CAACvX,KAAhB,CAAsB0X,eAAjC;kBAEI5N,IAAI,KAAK,IAAb,EAAmB,OAAO7H,kBAAkB,CAAC,kDAAD,CAAzB;kBACfgE,IAAI,GAAG6D,IAAI,CAACuN,mBAAL,CAAyB9P,MAAzB,EAAiCnC,WAAW,CAACW,IAA7C,CAAX;;kBACIE,IAAI,CAACY,MAAT,EAAiB;oBACZ8Q,WAAW,GAAG,IAAI/L,SAAJ,CAAc3F,IAAI,CAACc,MAAnB,EAA2BQ,MAA3B,CAAlB;gBACAiQ,aAAa,CAAC/Y,IAAd,CAAmBkZ,WAAnB;eAFD,MAIC,MAAM,IAAIrN,cAAJ,CAAmB,6CAA6C/C,MAA7C,GAAsD,MAAtD,GAA+DuC,IAAI,CAACrJ,IAAvF,CAAN;aAbK,MAeN,MAAM,IAAI6J,cAAJ,CAAmB,0BAA0BI,GAAG,CAACW,SAA9B,GAA0C,2BAA7D,CAAN;;;;;;;;;;;;;;;;OApBH,MAwBK;;;;;;gCACqBiM,YAAzB,mIAAsC;gBAA7BG,aAA6B;;gBACjC/M,IAAG,GAAGhJ,UAAU,CAAC+V,aAAD,EAAetQ,KAAf,CAApB;;gBACIwQ,YAAW,GAAGjN,IAAG,CAACkN,IAAJ,CAAS/B,OAAT,CAAlB;;YACA2B,aAAa,CAAC/Y,IAAd,CAAmBkZ,YAAnB;;;;;;;;;;;;;;;;;;aAIKH,aAAP;;;;qCAsIuB3B,OAtYzB,EAsY6CY,EAtY7C;UAuYM,KAAKT,eAAL,IAAwB,IAA5B,EAAkC;aAC5BA,eAAL,GAAuB,IAAI3L,GAAJ,EAAvB;;;WAGI2L,eAAL,CAAqB/N,GAArB,CAAyB4N,OAAzB,EAAkCY,EAAlC;;;;;aAwCO,aAAa,KAAKhW,IAAlB,GAAyB,GAAhC;;;;;UAtYI,KAAKoX,KAAL,KAAe,IAAnB,EAAyB,OAAO5V,kBAAkB,CAAC,0BAAD,CAAzB;aAClB,KAAK4V,KAAZ;KA9CF;sBAgDU7X,KAhDV;WAiDO6X,KAAL,GAAa7X,KAAb;;UACI,CAAC,KAAKiV,YAAV,EAAyB;YACpBH,kBAAkB,CAACgD,gBAAnB,KAAwC,IAA5C,EAAkD7V,kBAAkB,CAAC,qCAAD,CAAlB,CAAlD,KACK,KAAKkT,UAAL,GAAkBL,kBAAkB,CAACgD,gBAAnB,CAAoCnN,GAApC,CAAwC,KAAKkN,KAA7C,KAAuD,IAAzE;;;;;;UAMF,KAAK1C,UAAT,EAAqB;eACb,KAAKA,UAAL,CAAgBH,kBAAvB;OADD,MAEO;eACC,KAAK+C,mBAAZ;;KA7DH;sBAgEwB/X,KAhExB;WAiEO+X,mBAAL,GAA2B/X,KAA3B;;;;iCA9B0BgY,YAnC5B;aAoCS,IAAIlD,kBAAJ,CAAuBkD,YAAvB,CAAP;;;;uCAGgCA,YAvClC;WAwCOjD,kCAAL;aACO,KAAK+C,gBAAL,CAAuBnN,GAAvB,CAA2BqN,YAA3B,CAAP;;;;6BAkPyBC,CA3R3B;aA4RSA,CAAP;;;;;UAII,KAAKH,gBAAL,IAAyB,IAA7B,EAAmC;aAC7BA,gBAAL,GAAwB,IAAIzN,GAAJ,EAAxB,CADkC;;aAI7B6N,cAAL,CAAoB,KAAKjR,GAAzB,EAAmC,UAACiD,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAd;SAAnC;aACK+N,cAAL,CAAoB,KAAKC,QAAzB,EAAmC,UAACjO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAd;SAAnC;aACK+N,cAAL,CAAoB,KAAKE,QAAzB,EAAmC,UAAClO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAd;SAAnC;aACK+N,cAAL,CAAoB,KAAKG,MAAzB,EAAmC,UAACnO,CAAD,EAAIC,CAAJ;iBAAUjH,IAAI,CAACoV,KAAL,CAAWpO,CAAC,GAAGC,CAAf,CAAV;SAAnC;aACK+N,cAAL,CAAoB,KAAKK,GAAzB,EAAmC,UAACrO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAd;SAAnC;aACKqO,aAAL,CAAmB,KAAKC,MAAxB,EAAkC,UAACvO,CAAD;iBAAO,CAACA,CAAR;SAAlC;aAEKgO,cAAL,CAAoB,KAAKQ,KAAzB,EAAmC,UAACxO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAIC,CAAL,GAAS,CAAT,GAAa,CAAvB;SAAnC;aACK+N,cAAL,CAAoB,KAAKS,OAAzB,EAAmC,UAACzO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAJ,GAAS,CAAT,GAAa,CAAvB;SAAnC;aACK+N,cAAL,CAAoB,KAAKU,IAAzB,EAAmC,UAAC1O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAJ,GAAS,CAAT,GAAa,CAAvB;SAAnC;aACK+N,cAAL,CAAoB,KAAKW,mBAAzB,EAA8C,UAAC3O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAIC,CAAL,GAAS,CAAT,GAAa,CAAvB;SAA9C;aACK+N,cAAL,CAAoB,KAAKY,gBAAzB,EAA2C,UAAC5O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAIC,CAAL,GAAS,CAAT,GAAa,CAAvB;SAA3C;aACK+N,cAAL,CAAoB,KAAKa,SAAzB,EAAoC,UAAC7O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAIC,CAAL,GAAS,CAAT,GAAa,CAAvB;SAApC;aACKqO,aAAL,CAAmB,KAAKQ,GAAxB,EAAmC,UAAC9O,CAAD;iBAAQA,CAAC,IAAI,CAAN,GAAW,CAAX,GAAe,CAAtB;SAAnC;aAEKgO,cAAL,CAAoB,KAAKe,GAAzB,EAAmC,UAAC/O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAI,CAAL,IAAUC,CAAC,IAAI,CAAf,GAAmB,CAAnB,GAAuB,CAAjC;SAAnC;aACK+N,cAAL,CAAoB,KAAKgB,EAAzB,EAAmC,UAAChP,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAI,CAAL,IAAUC,CAAC,IAAI,CAAf,GAAmB,CAAnB,GAAuB,CAAjC;SAAnC;aAEK+N,cAAL,CAAoB,KAAKiB,GAAzB,EAAmC,UAACjP,CAAD,EAAIC,CAAJ;iBAAUjH,IAAI,CAAC0G,GAAL,CAASM,CAAT,EAAYC,CAAZ,CAAV;SAAnC;aACK+N,cAAL,CAAoB,KAAKkB,GAAzB,EAAmC,UAAClP,CAAD,EAAIC,CAAJ;iBAAUjH,IAAI,CAACC,GAAL,CAAS+G,CAAT,EAAYC,CAAZ,CAAV;SAAnC;aAEK+N,cAAL,CAAoB,KAAKmB,GAAzB,EAAmC,UAACnP,CAAD,EAAIC,CAAJ;iBAAUjH,IAAI,CAACoW,GAAL,CAASpP,CAAT,EAAYC,CAAZ,CAAV;SAAnC;aACKqO,aAAL,CAAmB,KAAKe,KAAxB,EAAmCzE,kBAAkB,CAAC0E,QAAtD;aACKhB,aAAL,CAAmB,KAAKiB,OAAxB,EAAmC3E,kBAAkB,CAAC0E,QAAtD;aACKhB,aAAL,CAAmB,KAAKvM,GAAxB,EAAmC6I,kBAAkB,CAAC0E,QAAtD;aACKhB,aAAL,CAAmB,KAAKzM,KAAxB,EAAmC,UAAC7B,CAAD;iBAAOA,CAAP;SAAnC,EA7BkC;;aAgC7BwP,gBAAL,CAAsB,KAAKzS,GAA3B,EAAqC,UAACiD,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAd;SAArC;aACKuP,gBAAL,CAAsB,KAAKvB,QAA3B,EAAqC,UAACjO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAd;SAArC;aACKuP,gBAAL,CAAsB,KAAKtB,QAA3B,EAAqC,UAAClO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAd;SAArC;aACKuP,gBAAL,CAAsB,KAAKrB,MAA3B,EAAqC,UAACnO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAd;SAArC;aACKuP,gBAAL,CAAsB,KAAKnB,GAA3B,EAAqC,UAACrO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAd;SAArC;aACKwP,eAAL,CAAqB,KAAKlB,MAA1B,EAAoC,UAACvO,CAAD;iBAAO,CAACA,CAAR;SAApC;aAEKwP,gBAAL,CAAsB,KAAKhB,KAA3B,EAAqC,UAACxO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAIC,CAAL,GAAS,CAAT,GAAa,CAAvB;SAArC;aACKuP,gBAAL,CAAsB,KAAKf,OAA3B,EAAqC,UAACzO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAJ,GAAS,CAAT,GAAa,CAAvB;SAArC;aACKuP,gBAAL,CAAsB,KAAKd,IAA3B,EAAqC,UAAC1O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAJ,GAAS,CAAT,GAAa,CAAvB;SAArC;aACKuP,gBAAL,CAAsB,KAAKb,mBAA3B,EAAgD,UAAC3O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAIC,CAAL,GAAS,CAAT,GAAa,CAAvB;SAAhD;aACKuP,gBAAL,CAAsB,KAAKZ,gBAA3B,EAA6C,UAAC5O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAIC,CAAL,GAAS,CAAT,GAAa,CAAvB;SAA7C;aACKuP,gBAAL,CAAsB,KAAKX,SAA3B,EAAsC,UAAC7O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAIC,CAAL,GAAS,CAAT,GAAa,CAAvB;SAAtC;aACKwP,eAAL,CAAqB,KAAKX,GAA1B,EAAqC,UAAC9O,CAAD;iBAAQA,CAAC,IAAI,GAAN,GAAa,CAAb,GAAiB,CAAxB;SAArC;aAEKwP,gBAAL,CAAsB,KAAKT,GAA3B,EAAqC,UAAC/O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAI,GAAL,IAAYC,CAAC,IAAI,GAAjB,GAAuB,CAAvB,GAA2B,CAArC;SAArC;aACKuP,gBAAL,CAAsB,KAAKR,EAA3B,EAAqC,UAAChP,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,IAAI,GAAL,IAAYC,CAAC,IAAI,GAAjB,GAAuB,CAAvB,GAA2B,CAArC;SAArC;aAEKuP,gBAAL,CAAsB,KAAKP,GAA3B,EAAqC,UAACjP,CAAD,EAAIC,CAAJ;iBAAUjH,IAAI,CAAC0G,GAAL,CAASM,CAAT,EAAYC,CAAZ,CAAV;SAArC;aACKuP,gBAAL,CAAsB,KAAKN,GAA3B,EAAqC,UAAClP,CAAD,EAAIC,CAAJ;iBAAUjH,IAAI,CAACC,GAAL,CAAS+G,CAAT,EAAYC,CAAZ,CAAV;SAArC;aAEKuP,gBAAL,CAAsB,KAAKL,GAA3B,EAAqC,UAACnP,CAAD,EAAIC,CAAJ;iBAAUjH,IAAI,CAACoW,GAAL,CAASpP,CAAT,EAAYC,CAAZ,CAAV;SAArC;aACKwP,eAAL,CAAqB,KAAKJ,KAA1B,EAAqC,UAACrP,CAAD;iBAAOhH,IAAI,CAAC0W,KAAL,CAAW1P,CAAX,CAAP;SAArC;aACKyP,eAAL,CAAqB,KAAKF,OAA1B,EAAqC,UAACvP,CAAD;iBAAOhH,IAAI,CAAC2W,IAAL,CAAU3P,CAAV,CAAP;SAArC;aACKyP,eAAL,CAAqB,KAAK1N,GAA1B,EAAqC,UAAC/B,CAAD;iBAAOhH,IAAI,CAAC0W,KAAL,CAAW1P,CAAX,CAAP;SAArC;aACKyP,eAAL,CAAqB,KAAK5N,KAA1B,EAAqC+I,kBAAkB,CAAC0E,QAAxD,EAzDkC;;aA4D7BM,iBAAL,CAAuB,KAAK7S,GAA5B,EAAsC,UAACiD,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,GAAGC,CAAd;SAAtC,EA5DkC;;aA6D7B2P,iBAAL,CAAuB,KAAKpB,KAA5B,EAAsC,UAACxO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,KAAKC,CAAN,GAAU,CAAV,GAAc,CAAxB;SAAtC;aACK2P,iBAAL,CAAuB,KAAKf,SAA5B,EAAsC,UAAC7O,CAAD,EAAIC,CAAJ;iBAAU,EAAED,CAAC,KAAKC,CAAR,IAAa,CAAb,GAAiB,CAA3B;SAAtC;aACK2P,iBAAL,CAAuB,KAAKC,GAA5B,EAAsC,UAAC7P,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAAC8P,QAAF,CAAW7P,CAAX,IAAgB,CAAhB,GAAoB,CAA9B;SAAtC;aACK2P,iBAAL,CAAuB,KAAKG,KAA5B,EAAwC,UAAC/P,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAAC8P,QAAF,CAAW7P,CAAX,IAAgB,CAAhB,GAAoB,CAA9B;SAAxC;aAEK+P,eAAL,CAAqB,KAAKjT,GAA1B,EAAkC,UAACiD,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAACiQ,KAAF,CAAQhQ,CAAR,CAAV;SAAlC;aACK+P,eAAL,CAAqB,KAAK/B,QAA1B,EAAqC,UAACjO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAACkQ,OAAF,CAAUjQ,CAAV,CAAV;SAArC;aACK+P,eAAL,CAAqB,KAAKH,GAA1B,EAAkC,UAAC7P,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAACmQ,QAAF,CAAWlQ,CAAX,IAAgB,CAAhB,GAAoB,CAA9B;SAAlC;aACK+P,eAAL,CAAqB,KAAKD,KAA1B,EAAmC,UAAC/P,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAACmQ,QAAF,CAAWlQ,CAAX,IAAgB,CAAhB,GAAoB,CAA9B;SAAnC;aACK+P,eAAL,CAAqB,KAAKI,SAA1B,EAAqC,UAACpQ,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAACoQ,SAAF,CAAYnQ,CAAZ,CAAV;SAArC;aAEK+P,eAAL,CAAqB,KAAKxB,KAA1B,EAAqC,UAACxO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAAC3K,MAAF,CAAS4K,CAAT,IAAc,CAAd,GAAkB,CAA5B;SAArC;aACK+P,eAAL,CAAqB,KAAKvB,OAA1B,EAAuC,UAACzO,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAACqQ,WAAF,CAAcpQ,CAAd,IAAmB,CAAnB,GAAuB,CAAjC;SAAvC;aACK+P,eAAL,CAAqB,KAAKtB,IAA1B,EAAoC,UAAC1O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAACsQ,QAAF,CAAWrQ,CAAX,IAAgB,CAAhB,GAAoB,CAA9B;SAApC;aACK+P,eAAL,CAAqB,KAAKrB,mBAA1B,EAAgD,UAAC3O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAAC2O,mBAAF,CAAsB1O,CAAtB,IAA2B,CAA3B,GAA+B,CAAzC;SAAhD;aACK+P,eAAL,CAAqB,KAAKpB,gBAA1B,EAA6C,UAAC5O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAAC4O,gBAAF,CAAmB3O,CAAnB,IAAwB,CAAxB,GAA4B,CAAtC;SAA7C;aACK+P,eAAL,CAAqB,KAAKnB,SAA1B,EAAwC,UAAC7O,CAAD,EAAIC,CAAJ;iBAAU,CAACD,CAAC,CAAC3K,MAAF,CAAS4K,CAAT,CAAD,GAAe,CAAf,GAAmB,CAA7B;SAAxC;aAEK+P,eAAL,CAAsB,KAAKjB,GAA3B,EAAoC,UAAC/O,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAAC3B,KAAF,GAAU,CAAV,IAAe4B,CAAC,CAAC5B,KAAF,GAAU,CAAzB,GAA6B,CAA7B,GAAiC,CAA3C;SAApC;aACK2R,eAAL,CAAsB,KAAKhB,EAA3B,EAAoC,UAAChP,CAAD,EAAIC,CAAJ;iBAAUD,CAAC,CAAC3B,KAAF,GAAU,CAAV,IAAe4B,CAAC,CAAC5B,KAAF,GAAU,CAAzB,GAA6B,CAA7B,GAAiC,CAA3C;SAApC;aAEKkS,cAAL,CAAoB,KAAKzB,GAAzB,EAA8B,UAAC9O,CAAD;iBAAOA,CAAC,CAAC3B,KAAF,IAAW,CAAX,GAAe,CAAf,GAAmB,CAA1B;SAA9B;aAEKkS,cAAL,CAAoB,KAAKC,MAAzB,EAAiC,UAACxQ,CAAD;iBAAOA,CAAC,CAACyQ,OAAT;SAAjC;aACKF,cAAL,CAAoB,KAAKG,GAAzB,EAA8B,UAAC1Q,CAAD;iBAAOA,CAAC,CAAC2Q,GAAT;SAA9B;aACKJ,cAAL,CAAoB,KAAKK,OAAzB,EAAkC,UAAC5Q,CAAD;iBAAOA,CAAC,CAAC6Q,SAAF,EAAP;SAAlC;aACKN,cAAL,CAAoB,KAAKO,OAAzB,EAAkC,UAAC9Q,CAAD;iBAAOA,CAAC,CAAC+Q,SAAF,EAAP;SAAlC;aACKR,cAAL,CAAoB,KAAKlS,KAAzB,EAAiC,UAAC2B,CAAD;iBAAOA,CAAC,CAAC3B,KAAT;SAAjC;aACKkS,cAAL,CAAoB,KAAKS,WAAzB,EAAuC,UAAChR,CAAD;iBAAOA,CAAC,CAACzB,OAAF,CAAUtB,KAAjB;SAAvC;;YAEIgU,kBAAkB,GAAG,SAArBA,kBAAqB,CAACC,EAAD,EAAWC,EAAX;iBACjBD,EAAE,CAAC7b,MAAH,CAAU8b,EAAV,IAAgB,CAAhB,GAAoB,CAA3B;SADD;;YAGIC,qBAAqB,GAAG,SAAxBA,qBAAwB,CAACF,EAAD,EAAWC,EAAX;iBACpBD,EAAE,CAAC7b,MAAH,CAAW8b,EAAX,IAAiB,CAAjB,GAAqB,CAA5B;SADD;;aAGKE,iBAAL,CAAuB,KAAK7C,KAA5B,EAAmC,CAAnC,EAAsC5M,SAAS,CAACW,YAAhD,EAA8D0O,kBAA9D;aACKI,iBAAL,CAAuB,KAAKxC,SAA5B,EAAuC,CAAvC,EAA0CjN,SAAS,CAACW,YAApD,EAAkE6O,qBAAlE;;;;;sCAY8B7a,IA9YjC,EA8Y+CuE,IA9Y/C,EA8Y6D6Q,OA9Y7D,EA8YiFY,EA9YjF;UA+YM,KAAKqB,gBAAL,KAA0B,IAA9B,EAAoC,OAAO7V,kBAAkB,CAAC,qCAAD,CAAzB;;UAChCuZ,UAAU,GAAG,KAAK1D,gBAAL,CAAsBnN,GAAtB,CAA0BlK,IAA1B,CAAjB;;UACI,CAAC+a,UAAL,EAAiB;QAChBA,UAAU,GAAG,IAAI1G,kBAAJ,CAAuBrU,IAAvB,EAA6BuE,IAA7B,CAAb;;aACK8S,gBAAL,CAAsB7P,GAAtB,CAA0BxH,IAA1B,EAAgC+a,UAAhC;;;MAGDA,UAAU,CAACC,gBAAX,CAA4B5F,OAA5B,EAAqCY,EAArC;;;;mCAG4BhW,IAzZ9B,EAyZ4CgW,EAzZ5C;WA0ZO8E,iBAAL,CAAuB9a,IAAvB,EAA6B,CAA7B,EAAgCqL,SAAS,CAACG,GAA1C,EAA+CwK,EAA/C;;;;kCAE2BhW,IA5Z7B,EA4Z2CgW,EA5Z3C;WA6ZO8E,iBAAL,CAAuB9a,IAAvB,EAA6B,CAA7B,EAAgCqL,SAAS,CAACG,GAA1C,EAA+CwK,EAA/C;;;;qCAG8BhW,IAhahC,EAga8CgW,EAha9C;WAiaO8E,iBAAL,CAAuB9a,IAAvB,EAA6B,CAA7B,EAAgCqL,SAAS,CAACC,KAA1C,EAAiD0K,EAAjD;;;;oCAE6BhW,IAna/B,EAma6CgW,EAna7C;WAoaO8E,iBAAL,CAAuB9a,IAAvB,EAA6B,CAA7B,EAAgCqL,SAAS,CAACC,KAA1C,EAAiD0K,EAAjD;;;;sCAG+BhW,IAvajC,EAua+CgW,EAva/C;WAwaO8E,iBAAL,CAAuB9a,IAAvB,EAA6B,CAA7B,EAAgCqL,SAAS,CAACN,MAA1C,EAAkDiL,EAAlD;;;;oCAG6BhW,IA3a/B,EA2a6CgW,EA3a7C;WA4aO8E,iBAAL,CAAuB9a,IAAvB,EAA6B,CAA7B,EAAgCqL,SAAS,CAACiB,IAA1C,EAAgD0J,EAAhD;;;;mCAE4BhW,IA9a9B,EA8a4CgW,EA9a5C;WA+aO8E,iBAAL,CAAuB9a,IAAvB,EAA6B,CAA7B,EAAgCqL,SAAS,CAACiB,IAA1C,EAAgD0J,EAAhD;;;;;EA/asCvU,SAAxC;;AAEwB4S,sBAAA,GAAgB,GAAhB;AACAA,2BAAA,GAAmB,GAAnB;AACAA,yBAAA,GAAmB,GAAnB;AACAA,2BAAA,GAAmB,GAAnB;AACAA,sBAAA,GAAmB,GAAnB;AACAA,yBAAA,GAAmB,GAAnB;AACAA,wBAAA,GAAmB,IAAnB;AACAA,0BAAA,GAAmB,GAAnB;AACAA,uBAAA,GAAmB,GAAnB;AACAA,sCAAA,GAA8B,IAA9B;AACAA,mCAAA,GAA2B,IAA3B;AACAA,4BAAA,GAAsB,IAAtB;AACAA,sBAAA,GAAmB,GAAnB;AACAA,sBAAA,GAAmB,IAAnB;AACAA,qBAAA,GAAmB,IAAnB;AACAA,sBAAA,GAAmB,KAAnB;AACAA,sBAAA,GAAmB,KAAnB;AACAA,sBAAA,GAAmB,KAAnB;AACAA,wBAAA,GAAmB,OAAnB;AACAA,0BAAA,GAAmB,SAAnB;AACAA,sBAAA,GAAmB,KAAnB;AACAA,wBAAA,GAAmB,OAAnB;AACAA,sBAAA,GAAmB,GAAnB;AACAA,wBAAA,GAAmB,IAAnB;AACAA,4BAAA,GAAoB,GAApB;AACAA,0BAAA,GAAoB,UAApB;AACAA,0BAAA,GAAoB,UAApB;AACAA,sBAAA,GAAoB,UAApB;AACAA,wBAAA,GAAoB,YAApB;AACAA,8BAAA,GAAsB,YAAtB;AACAA,yBAAA,GAAoB,aAApB;AAyZTA,mCAAA,GAA2D,IAA3D;;ICncF4G,GAAb;;AAAA;;;eAIaC,OAAZ;;;;;;UAEMC,IAAL,GAAYD,OAAO,CAACjb,QAAR,MAAsB,EAAlC;;;;;;;aAIO,OAAO,KAAKkb,IAAnB;;;;;EAVuB1Z,SAAzB;;ICGa2Z,MAAb;;AAAA;;;;;;;;;cACQ,GAAe,EAAf;eACA,GAAgB,CAAhB;4BACA,GAA8C,IAA9C;oBACA,GAAqB,EAArB;oBACA,GAA0B,IAA1B;4BACA,GAA8B,KAA9B;6BACA,GAA8B,CAA9B;;;;;;;UAGF,KAAKrP,UAAL,KAAoB,IAAxB,EAA8B,OAAOvK,kBAAkB,CAAC,mBAAD,CAAzB;aACvB,KAAKuK,UAAL,CAAgB9L,QAAhB,EAAP;KAXF;sBAawBV,KAbxB;WAcOwM,UAAL,GAAkB,IAAIxO,IAAJ,CAASgC,KAAT,CAAlB;;;;;EAd0BkC,SAA5B;;ICDa4Z,cAAb;;AAAA;0BAKarb,IAAZ,EAA0BsJ,KAA1B;;;SACM8N,KAAL,GAAapX,IAAI,IAAI,EAArB;SACKsb,MAAL,GAAc,IAAd;SACKC,iBAAL,GAAyBjS,KAAK,IAAI,IAAIM,GAAJ,EAAlC;;;;;iCAiBmBpE,IAzBrB;UA0BM,CAACA,IAAI,CAACX,QAAV,EAAoB,OAAO,CAAP;;UAEhBiC,MAAM,GAAG,KAAKyU,iBAAL,CAAuBrR,GAAvB,CAA2B1E,IAAI,CAACX,QAAhC,CAAb;;UACI,OAAOiC,MAAP,KAAkB,WAAtB,EACC,OAAOA,MAAP,CADD,KAGC,OAAO,CAAP;;;;iCAEkBtB,IAlCrB;UAmCM,CAACA,IAAI,CAACX,QAAV,EAAoB,OAAO,KAAP;UAChBW,IAAI,CAACZ,UAAL,IAAmB,KAAK5E,IAA5B,EAAkC,OAAO,KAAP;aAE3B,KAAKub,iBAAL,CAAuBlU,GAAvB,CAA2B7B,IAAI,CAACX,QAAhC,CAAP;;;;yCAE2BA,QAxC7B;aAyCS,KAAK0W,iBAAL,CAAuBlU,GAAvB,CAA2BxC,QAA3B,CAAP;;;;wCAE0BoF,GA3C5B;;IA2CmDzE,IA3CnD;;;;;;6BA4C2B,KAAK+V,iBAA9B,8HAAgD;;cAAtCpW,GAAsC;cAAjC5F,KAAiC;;cAC3CA,KAAK,IAAI0K,GAAb,EAAkB;YACjBzE,IAAI,GAAG,IAAIb,WAAJ,CAAgB,KAAK3E,IAArB,EAA2BmF,GAA3B,CAAP;mBACO;cAAEmB,MAAM,EAAEd,IAAV;cAAgBY,MAAM,EAAE;aAA/B;;;;;;;;;;;;;;;;;;MAIFZ,IAAI,GAAGb,WAAW,CAACW,IAAnB;aACO;QAAEgB,MAAM,EAAEd,IAAV;QAAgBY,MAAM,EAAE;OAA/B;;;;uCAEyBZ,IAtD3B;;IAsDwDsB,MAtDxD;UAuDM,CAACtB,IAAI,CAACX,QAAV,EAAoB,OAAO;QAAEyB,MAAM,EAAE,CAAV;QAAaF,MAAM,EAAE;OAA5B;;UAChB7G,KAAK,GAAG,KAAKgc,iBAAL,CAAuBrR,GAAvB,CAA2B1E,IAAI,CAACX,QAAhC,CAAZ;;UAEI,CAACtF,KAAL,EAAY,OAAO;QAAE+G,MAAM,EAAE,CAAV;QAAaF,MAAM,EAAE;OAA5B;aACL;QAAEE,MAAM,EAAE/G,KAAV;QAAiB6G,MAAM,EAAE;OAAhC;;;;;aAhDO,KAAKgR,KAAZ;;;;;UAGI,KAAKkE,MAAL,IAAe,IAAnB,EAAwB;aAClBA,MAAL,GAAc,IAAI1R,GAAJ,EAAd;;;;;;gCACyB,KAAK2R,iBAA9B,mIAAgD;;gBAAtCpW,GAAsC;gBAAjC5F,KAAiC;;gBAC3CiG,IAAI,GAAG,IAAIb,WAAJ,CAAgB,KAAK3E,IAArB,EAA2BmF,GAA3B,CAAX;;iBACKmW,MAAL,CAAY9T,GAAZ,CAAgBhC,IAAI,CAAC8B,UAAL,EAAhB,EAAmC/H,KAAnC;;;;;;;;;;;;;;;;;;aAIK,KAAK+b,MAAZ;;;;;;;ICpBWE,qBAAb;;AAAA;iCAIaC,KAAZ;;;SACMC,MAAL,GAAc,IAAI9R,GAAJ,EAAd;SACK+R,6BAAL,GAAqC,IAAI/R,GAAJ,EAArC;;;;;;2BAEiB6R,KAAjB,8HAAuB;YAAdpS,IAAc;;aACjBqS,MAAL,CAAYlU,GAAZ,CAAgB6B,IAAI,CAACrJ,IAArB,EAA2BqJ,IAA3B;;;;;;;gCAEuBA,IAAI,CAACC,KAA5B,mIAAkC;;gBAAxBnE,GAAwB;gBAAnB8E,GAAmB;;gBAC7BzE,IAAI,GAAGb,WAAW,CAACyC,iBAAZ,CAA8BjC,GAA9B,CAAX;gBACIyW,SAAS,GAAG,IAAIzQ,SAAJ,CAAc3F,IAAd,EAAoByE,GAApB,CAAhB;;gBAEI,CAACzE,IAAI,CAACX,QAAV,EAAoB;oBAAQ,IAAI3D,KAAJ,CAAU,qCAAV,CAAN;;;iBAEjBya,6BAAL,CAAmCnU,GAAnC,CAAuChC,IAAI,CAACX,QAA5C,EAAsD+W,SAAtD;;iBACKD,6BAAL,CAAmCnU,GAAnC,CAAuChC,IAAI,CAACV,QAA5C,EAAsD8W,SAAtD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;yCAayB5b,IA/B7B;;IA+B4DiG,GA/B5D;UAgCMjG,IAAI,KAAK,IAAb,EAAmB;eAAS;UAACsG,MAAM,EAAEL,GAAT;UAAcG,MAAM,EAAE;SAA7B;;;;UAEjByV,UAAU,GAAG,KAAKH,MAAL,CAAYxR,GAAZ,CAAgBlK,IAAhB,CAAjB;;UACI,CAAC6b,UAAL,EAAiB,OAAO;QAAEvV,MAAM,EAAEL,GAAV;QAAeG,MAAM,EAAE;OAA9B;aAEV;QAAEE,MAAM,EAAEuV,UAAV;QAAsBzV,MAAM,EAAE;OAArC;;;;+CAEiCpG,IAvCnC;UAwCMA,IAAI,KAAK,IAAb,EAAmB;eAASwB,kBAAkB,CAAC,MAAD,CAAzB;;;UACjByI,GAAG,GAAG,KAAK0R,6BAAL,CAAmCzR,GAAnC,CAAuClK,IAAvC,CAAV;;UAEI,OAAOiK,GAAP,KAAe,WAAnB,EAA+B;eACvBA,GAAP;;;aAGM,IAAP;;;;;UAxBI6R,WAAW,GAAqB,EAApC;;;;;;8BAEyB,KAAKJ,MAA9B,mIAAqC;;cAA3BvW,GAA2B;cAAtB5F,KAAsB;;UACpCuc,WAAW,CAAC9d,IAAZ,CAAiBuB,KAAjB;;;;;;;;;;;;;;;;;aAGMuc,WAAP;;;;;;;ICXWC,iBAAb;;AAAA;;;;;;;iCAC4BC,aAD5B;UAEMC,MAAM,GAAU,EAApB;;;;;;6BACcD,aAAd,8HAA6B;cAApBE,CAAoB;UAC5BD,MAAM,CAACje,IAAP,CAAY,KAAKme,qBAAL,CAA2BD,CAA3B,CAAZ;;;;;;;;;;;;;;;;;aAEMD,MAAP;;;;2CAGoCA,MATtC;UASqDG,+EAAoB;UACnEC,KAAK,GAAGJ,MAAM,CAACxd,MAAnB;UACI2d,QAAJ,EACCC,KAAK;UAEFhT,IAAI,GAAgB,EAAxB;;WAEK,IAAI7K,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG6d,KAApB,EAA2B7d,CAAC,EAA5B,EAA+B;YAC1B8d,IAAI,GAAGL,MAAM,CAACzd,CAAD,CAAjB;YACIgP,UAAU,GAAG,KAAK+O,qBAAL,CAA2BD,IAA3B,CAAjB;;YACI9O,UAAU,KAAK,IAAnB,EAAyB;iBAAShM,kBAAkB,CAAC,YAAD,CAAzB;;;QAC3B6H,IAAI,CAACrL,IAAL,CAAUwP,UAAV;;;aAGMnE,IAAP;;;;mDAG4CmT,UA1B9C;UA2BMC,OAAO,GAAY,EAAvB;;;;;;8BAEyBD,UAAzB,mIAAoC;;cAA1BrX,GAA0B;cAArB5F,KAAqB;;cAC/BiO,UAAU,GAAG1M,QAAQ,CAACvB,KAAD,EAAQkC,SAAR,CAAzB;cACI+L,UAAU,IAAI,IAAlB,EACCiP,OAAO,CAACtX,GAAD,CAAP,GAAe,KAAKgX,qBAAL,CAA2B3O,UAA3B,CAAf;;;;;;;;;;;;;;;;;aAGKiP,OAAP;;;;mDAG4CC,OAtC9C;UAuCMC,IAAI,GAA2B,IAAI/S,GAAJ,EAAnC;;WAEK,IAAIzE,GAAT,IAAgBuX,OAAhB,EAAwB;YACnBA,OAAO,CAACjX,cAAR,CAAuBN,GAAvB,CAAJ,EAAiC;cAC5B0J,SAAS,GAAG,KAAK0N,qBAAL,CAA2BG,OAAO,CAACvX,GAAD,CAAlC,CAAhB;;cACI0J,SAAS,KAAK,IAAlB,EAAwB;mBAASrN,kBAAkB,CAAC,WAAD,CAAzB;;;UAC1Bmb,IAAI,CAACnV,GAAL,CAASrC,GAAT,EAAc0J,SAAd;;;;aAIK8N,IAAP;;;;2CAGoCD,OApDtC;UAqDMC,IAAI,GAAwB,IAAI/S,GAAJ,EAAhC;;WACK,IAAIzE,GAAT,IAAgBuX,OAAhB,EAAwB;YACnBA,OAAO,CAACjX,cAAR,CAAuBN,GAAvB,CAAJ,EAAiC;UAChCwX,IAAI,CAACnV,GAAL,CAASrC,GAAT,EAActF,QAAQ,CAAC6c,OAAO,CAACvX,GAAD,CAAR,CAAtB;;;;aAGKwX,IAAP;;;;2CAEoCA,IA7DtC;UA8DMC,IAAI,GAAY,EAApB;;;;;;8BACyBD,IAAzB,mIAA8B;;cAApBxX,GAAoB;cAAf5F,KAAe;;UAC7Bqd,IAAI,CAACzX,GAAD,CAAJ,GAAYhE,gBAAgB,CAAC5B,KAAD,CAA5B;;;;;;;;;;;;;;;;;aAEMqd,IAAP;;;;0CAEmCC,KApErC;UAqEM,OAAOA,KAAP,KAAiB,QAAjB,IAA6B,CAACxS,KAAK,CAACwS,KAAD,CAAvC,EAA+C;eACvCnW,KAAK,CAAC+D,MAAN,CAAaoS,KAAb,CAAP;;;UAGG,OAAOA,KAAP,KAAiB,QAArB,EAA8B;YACzBld,GAAG,GAAGkd,KAAK,CAAC5c,QAAN,EAAV,CAD6B;;YAIzB6c,SAAS,GAAGnd,GAAG,CAAC,CAAD,CAAnB;YACImd,SAAS,IAAI,GAAjB,EACC,OAAO,IAAIhS,WAAJ,CAAgBnL,GAAG,CAACH,SAAJ,CAAc,CAAd,CAAhB,CAAP,CADD,KAEK,IAAGsd,SAAS,IAAI,IAAb,IAAqBnd,GAAG,CAAClB,MAAJ,IAAc,CAAtC,EACJ,OAAO,IAAIqM,WAAJ,CAAgB,IAAhB,CAAP,CAR4B;;YAWzBnL,GAAG,IAAI,IAAX,EAAiB,OAAO,IAAIkQ,IAAJ,EAAP,CAXY;;aAcxB,IAAIrR,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGud,iBAAiB,CAACgB,oBAAlB,CAAuCte,MAA3D,EAAmE,EAAED,CAArE,EAAwE;cACnEwe,OAAO,GAAGjB,iBAAiB,CAACgB,oBAAlB,CAAuCve,CAAvC,CAAd;;cACImB,GAAG,IAAIqd,OAAX,EAAoB;mBACZ,IAAIlN,cAAJ,CAAmBtR,CAAnB,CAAP;;SAjB2B;;;YAsBzBmB,GAAG,IAAI,IAAX,EAAiBA,GAAG,GAAG,GAAN;YACb0U,kBAAkB,CAAC4I,kBAAnB,CAAsCtd,GAAtC,CAAJ,EACC,OAAO0U,kBAAkB,CAAC6I,YAAnB,CAAgCvd,GAAhC,CAAP,CAxB4B;;YA2BzBA,GAAG,IAAI,MAAX,EACC,OAAOmQ,cAAc,CAACW,SAAf,EAAP,CADD,KAEK,IAAI9Q,GAAG,IAAI,MAAX,EACJ,OAAOmQ,cAAc,CAACU,WAAf,EAAP,CA9B4B;;YAiCzB7Q,GAAG,IAAI,MAAX,EACC,OAAO,IAAIyU,IAAJ,EAAP;;;UAGE,QAAOyI,KAAP,MAAiB,QAAjB,IAA6B,CAAC3e,KAAK,CAACif,OAAN,CAAcN,KAAd,CAAlC,EAAuD;YAClD9b,GAAG,GAAY8b,KAAnB;YACIO,SAAJ,CAFsD;;YAKlDrc,GAAG,CAAC,KAAD,CAAP,EAAe;UACdqc,SAAS,GAAGrc,GAAG,CAAC,KAAD,CAAf;iBACO,IAAImK,iBAAJ,CAAsB,IAAI3N,IAAJ,CAAS6f,SAAS,CAACnd,QAAV,EAAT,CAAtB,CAAP;SAPqD;;;YAWlDc,GAAG,CAAC,MAAD,CAAP,EAAiB;UAChBqc,SAAS,GAAGrc,GAAG,CAAC,MAAD,CAAf;cACIsc,MAAM,GAAG,IAAIpR,oBAAJ,CAAyBmR,SAAS,CAACnd,QAAV,EAAzB,CAAb;;cACI,QAAQc,GAAZ,EAAgB;YACfqc,SAAS,GAAGrc,GAAG,CAAC,IAAD,CAAf;YACAsc,MAAM,CAAClR,YAAP,GAAsBtM,QAAQ,CAACud,SAAD,CAA9B;;;iBAEMC,MAAP;SAlBqD;;;YAsBlDC,QAAQ,GAAG,KAAf;YACIvL,aAAa,GAAG,KAApB;YACIwL,WAAW,GAAG7L,WAAW,CAACY,QAA9B;YACIkL,QAAQ,GAAG,KAAf;;YACIJ,SAAS,GAAGrc,GAAG,CAAC,IAAD,CAAnB,EAA2B;UAC1Buc,QAAQ,GAAG,IAAX;SADD,MAGK,IAAIF,SAAS,GAAGrc,GAAG,CAAC,KAAD,CAAnB,EAA4B;UAChCuc,QAAQ,GAAG,IAAX;UACAvL,aAAa,GAAG,IAAhB;UACAwL,WAAW,GAAG7L,WAAW,CAACY,QAA1B;SAHI,MAKA,IAAI8K,SAAS,GAAGrc,GAAG,CAAC,OAAD,CAAnB,EAA8B;UAClCuc,QAAQ,GAAG,IAAX;UACAvL,aAAa,GAAG,IAAhB;UACAwL,WAAW,GAAG7L,WAAW,CAAC+L,MAA1B;SAHI,MAKA,IAAIL,SAAS,GAAGrc,GAAG,CAAC,KAAD,CAAnB,EAA4B;UAChCuc,QAAQ,GAAG,IAAX;UACAE,QAAQ,GAAG,IAAX;UACAzL,aAAa,GAAG,KAAhB;UACAwL,WAAW,GAAG7L,WAAW,CAACY,QAA1B;;;YAGGgL,QAAJ,EAAc;cACTI,MAAM,GAAG,IAAI7L,MAAJ,EAAb;UACA6L,MAAM,CAAC3L,aAAP,GAAuBA,aAAvB;UACA2L,MAAM,CAAC5L,aAAP,GAAuByL,WAAvB;UACAG,MAAM,CAACC,UAAP,GAAoBH,QAApB;cAEII,MAAM,GAAGR,SAAS,CAACnd,QAAV,EAAb;cAEImd,SAAS,GAAGrc,GAAG,CAAC,KAAD,CAAnB,EACC2c,MAAM,CAACxL,kBAAP,GAA4B0L,MAA5B,CADD,KAGCF,MAAM,CAACnL,gBAAP,GAA0BqL,MAA1B;UAEDF,MAAM,CAACrL,aAAP,GAAuB,CAAC,CAACtR,GAAG,CAAC,GAAD,CAA5B;;cAEIyc,QAAJ,EAAc;gBACTJ,SAAS,GAAGrc,GAAG,CAAC,QAAD,CAAnB,EACC2c,MAAM,CAACG,YAAP,GAAsBhe,QAAQ,CAACud,SAAD,CAA9B;;;iBAGKM,MAAP;SAlEqD;;;YAsElDN,SAAS,GAAGrc,GAAG,CAAC,GAAD,CAAnB,EAA0B;cACrB+c,MAAM,GAAG,IAAI5K,WAAJ,EAAb;UACA4K,MAAM,CAACC,kBAAP,GAA4BX,SAAS,CAACnd,QAAV,EAA5B;cAEImd,SAAS,GAAGrc,GAAG,CAAC,KAAD,CAAnB,EACC+c,MAAM,CAAC7O,KAAP,GAAepP,QAAQ,CAACud,SAAD,CAAvB;iBAEMU,MAAP;SA7EqD;;;YAiFlDV,SAAS,GAAGrc,GAAG,CAAC,MAAD,CAAnB,EAA6B;iBACrB,IAAI8S,iBAAJ,CAAsBuJ,SAAS,CAACnd,QAAV,EAAtB,CAAP;SADD,MAEO,IAAImd,SAAS,GAAGrc,GAAG,CAAC,MAAD,CAAnB,EAA6B;cAC/Bid,eAAe,GAAG,IAAInK,iBAAJ,EAAtB;UACAmK,eAAe,CAACjK,kBAAhB,GAAqCqJ,SAAS,CAACnd,QAAV,EAArC;iBACO+d,eAAP;SAtFqD;;;YA0FlDC,QAAQ,GAAG,KAAf;YACIC,WAAW,GAAG,KAAlB;;YACId,SAAS,GAAGrc,GAAG,CAAC,MAAD,CAAnB,EAA6B;UAC5Bkd,QAAQ,GAAG,IAAX;UACAC,WAAW,GAAG,IAAd;SAFD,MAGO,IAAId,SAAS,GAAGrc,GAAG,CAAC,OAAD,CAAnB,EAA8B;UACpCkd,QAAQ,GAAG,IAAX;UACAC,WAAW,GAAG,KAAd;;;YAEGD,QAAJ,EAAc;cACTE,OAAO,GAAGf,SAAS,CAACnd,QAAV,EAAd;cACIme,SAAS,GAAG,CAACrd,GAAG,CAAC,IAAD,CAApB;cACIsd,MAAM,GAAG,IAAIpK,kBAAJ,CAAuBkK,OAAvB,EAAgCC,SAAhC,CAAb;UACAC,MAAM,CAAClK,QAAP,GAAkB+J,WAAlB;iBACOG,MAAP;;;YAEGtd,GAAG,CAAC,GAAD,CAAH,KAAa4E,SAAjB,EAA2B;UAC1ByX,SAAS,GAAGrc,GAAG,CAAC,GAAD,CAAf;iBACO,IAAIka,GAAJ,CAAQmC,SAAS,CAACnd,QAAV,EAAR,CAAP;SA5GqD;;;YAgHlDmd,SAAS,GAAGrc,GAAG,CAAC,MAAD,CAAnB,EAA6B;;cAExBud,WAAW,GAAYlB,SAA3B;cACImB,OAAO,GAAG,IAAI7Y,OAAJ,EAAd;;cACI0X,SAAS,GAAGrc,GAAG,CAAC,SAAD,CAAnB,EAAgC;;gBAE3Byd,WAAW,GAAGpB,SAAlB,CAF+B;;YAI/BmB,OAAO,CAAC5V,qBAAR,CAA8B6V,WAA9B;;;eAGI,IAAIrZ,GAAT,IAAgBmZ,WAAhB,EAA4B;gBACvBA,WAAW,CAAC7Y,cAAZ,CAA2BN,GAA3B,CAAJ,EAAqC;kBAChCsZ,SAAS,GAAGH,WAAW,CAACnZ,GAAD,CAA3B;kBACIK,IAAI,GAAG,IAAIb,WAAJ,CAAgBQ,GAAhB,CAAX;kBACI8E,GAAG,GAAGpK,QAAQ,CAAC4e,SAAD,CAAlB;cACAF,OAAO,CAAC/X,GAAR,CAAYhB,IAAZ,EAAkByE,GAAlB;;;;iBAIK,IAAIkB,SAAJ,CAAcoT,OAAd,CAAP;;;YAGGxd,GAAG,CAAC,oBAAD,CAAH,IAA6B,IAAjC,EACC,OAAO,KAAK2d,eAAL,CAAqB3d,GAArB,CAAP;;;;UAIE7C,KAAK,CAACif,OAAN,CAAcN,KAAd,CAAJ,EAAyB;eACjB,KAAK8B,iBAAL,CAAuB9B,KAAvB,CAAP;;;UAGGA,KAAK,KAAK,IAAV,IAAkBA,KAAK,KAAKlX,SAAhC,EACC,OAAO,IAAP;YAEK,IAAIzE,KAAJ,CAAU,gDAAgD+D,IAAI,CAACC,SAAL,CAAe2X,KAAf,CAA1D,CAAN;;;;0CAGmC9b,GApQrC;;UAsQM8C,SAAS,GAAG/C,QAAQ,CAACC,GAAD,EAAMmB,SAAN,CAAxB;;UACI2B,SAAJ,EAAe;eACP,KAAK+a,iBAAL,CAAuB/a,SAAvB,CAAP;;;;UAIG6Z,MAAM,GAAG5c,QAAQ,CAACC,GAAD,EAAM8Q,MAAN,CAArB;;UACI6L,MAAJ,EAAY;YACPmB,UAAU,GAAG,IAAjB;YACInB,MAAM,CAACC,UAAX,EACCkB,UAAU,GAAG,KAAb,CADD,KAEK,IAAInB,MAAM,CAAC3L,aAAX,EAA0B;cAC1B2L,MAAM,CAAC5L,aAAP,IAAwBJ,WAAW,CAACY,QAAxC,EACCuM,UAAU,GAAG,KAAb,CADD,KAEK,IAAInB,MAAM,CAAC5L,aAAP,IAAwBJ,WAAW,CAAC+L,MAAxC,EACJoB,UAAU,GAAG,OAAb;;YAGE1M,SAAJ;YACIuL,MAAM,CAACzL,iBAAX,EACCE,SAAS,GAAGuL,MAAM,CAACxL,kBAAnB,CADD,KAGCC,SAAS,GAAGuL,MAAM,CAACnL,gBAAnB;YAEGqK,IAAI,GAAY,EAApB;QACAA,IAAI,CAACiC,UAAD,CAAJ,GAAmB1M,SAAnB;YAEIuL,MAAM,CAACzL,iBAAX,EACC2K,IAAI,CAAC,KAAD,CAAJ,GAAc,IAAd;YAEGc,MAAM,CAACrL,aAAX,EACCuK,IAAI,CAAC,GAAD,CAAJ,GAAY,IAAZ;YAEGc,MAAM,CAACG,YAAP,GAAsB,CAA1B,EACCjB,IAAI,CAAC,QAAD,CAAJ,GAAiBc,MAAM,CAACG,YAAxB;eAEMjB,IAAP;;;;UAIGkC,WAAW,GAAGhe,QAAQ,CAACC,GAAD,EAAMmS,WAAN,CAA1B;;UACI4L,WAAJ,EAAiB;YACZlC,KAAI,GAAY,EAApB;QACAA,KAAI,CAAC,GAAD,CAAJ,GAAYkC,WAAW,CAACf,kBAAxB;QACAnB,KAAI,CAAC,KAAD,CAAJ,GAAckC,WAAW,CAAC7P,KAA1B;eACO2N,KAAP;;;;UAIG9V,MAAM,GAAGhG,QAAQ,CAACC,GAAD,EAAMiK,QAAN,CAArB;UACIlE,MAAJ,EACC,OAAOA,MAAM,CAACvH,KAAd;;UAGGwf,QAAQ,GAAGje,QAAQ,CAACC,GAAD,EAAMkK,UAAN,CAAvB;UACI8T,QAAJ,EACC,OAAOA,QAAQ,CAACxf,KAAhB;;UAGGyf,MAAM,GAAGle,QAAQ,CAACC,GAAD,EAAM+J,WAAN,CAArB;;UACIkU,MAAJ,EAAY;YACPA,MAAM,CAACnT,SAAX,EACC,OAAO,IAAP,CADD,KAGC,OAAO,MAAMmT,MAAM,CAACzf,KAApB;;;;UAIE4W,OAAO,GAAGrV,QAAQ,CAACC,GAAD,EAAMoK,SAAN,CAAtB;;UACIgL,OAAJ,EAAa;eACL,KAAK8I,gBAAL,CAAsB9I,OAAtB,CAAP;;;;UAIG+I,YAAY,GAAGpe,QAAQ,CAACC,GAAD,EAAMmK,iBAAN,CAA3B;;UACIgU,YAAJ,EAAkB;YACbC,gBAAgB,GAAY,EAAhC;;YACID,YAAY,CAAC3f,KAAb,KAAuB,IAA3B,EAAiC;iBAASiC,kBAAkB,CAAC,oBAAD,CAAzB;;;QACnC2d,gBAAgB,CAAC,KAAD,CAAhB,GAA0BD,YAAY,CAAC3f,KAAb,CAAmB3B,gBAA7C;eACOuhB,gBAAP;;;;UAIGC,SAAS,GAAGte,QAAQ,CAACC,GAAD,EAAMkL,oBAAN,CAAxB;;UACImT,SAAJ,EAAe;YACVC,aAAa,GAAY,EAA7B;QACAA,aAAa,CAAC,MAAD,CAAb,GAAwBD,SAAS,CAAC7f,KAAlC;QACA8f,aAAa,CAAC,IAAD,CAAb,GAAsBD,SAAS,CAACjT,YAAhC;eACOkT,aAAP;;;;UAIGC,IAAI,GAAGxe,QAAQ,CAACC,GAAD,EAAM8O,IAAN,CAAnB;UACIyP,IAAJ,EAAU,OAAO,IAAP;;UAGNC,UAAU,GAAGze,QAAQ,CAACC,GAAD,EAAM+O,cAAN,CAAzB;;UACIyP,UAAJ,EAAgB;eACRxD,iBAAiB,CAACgB,oBAAlB,CAAuCwC,UAAU,CAACvP,WAAlD,CAAP;;;;UAIG+K,UAAU,GAAGja,QAAQ,CAACC,GAAD,EAAMsT,kBAAN,CAAzB;;UACI0G,UAAJ,EAAgB;YACX/a,IAAI,GAAG+a,UAAU,CAAC/a,IAAtB;YAEIA,IAAI,IAAI,GAAZ,EAAiBA,IAAI,GAAG,IAAP;eACVA,IAAP;;;;;UAKGwf,MAAM,GAAG1e,QAAQ,CAACC,GAAD,EAAM8S,iBAAN,CAArB;;UACI2L,MAAJ,EAAY;YACP5C,MAAI,GAAY,EAApB;YACI6C,aAAa,GAAGD,MAAM,CAACzL,kBAA3B;;YACI0L,aAAa,IAAI,IAArB,EAA2B;UAC1B7C,MAAI,CAAC,MAAD,CAAJ,GAAe6C,aAAf;SADD,MAEO;UACN7C,MAAI,CAAC,MAAD,CAAJ,GAAe4C,MAAM,CAACxf,IAAtB;;;eAGM4c,MAAP;;;;;UAKGyB,MAAM,GAAGvd,QAAQ,CAACC,GAAD,EAAMkT,kBAAN,CAArB;;UACIoK,MAAJ,EAAY;YACPlZ,GAAG,GAAGkZ,MAAM,CAAClK,QAAP,GAAkB,MAAlB,GAA2B,OAArC;YACIyI,MAAI,GAAY,EAApB;QACAA,MAAI,CAACzX,GAAD,CAAJ,GAAYkZ,MAAM,CAACnS,YAAnB,CAHW;;YAMP,CAACmS,MAAM,CAACnK,gBAAZ,EACC0I,MAAI,CAAC,IAAD,CAAJ,GAAa,IAAb;eAEMA,MAAP;;;;UAIG8C,OAAO,GAAG5e,QAAQ,CAACC,GAAD,EAAMqT,IAAN,CAAtB;UACIsL,OAAJ,EACC,OAAO,MAAP;;UAGGC,GAAG,GAAG7e,QAAQ,CAACC,GAAD,EAAMka,GAAN,CAAlB;;UACI0E,GAAJ,EAAS;YACJ/C,MAAI,GAAY,EAApB;QACAA,MAAI,CAAC,GAAD,CAAJ,GAAY+C,GAAG,CAACxE,IAAhB;eACOyB,MAAP;;;;;UAKGkB,MAAM,GAAGhd,QAAQ,CAACC,GAAD,EAAMqa,MAAN,CAArB;UACI0C,MAAJ,EACC,OAAO,KAAK8B,eAAL,CAAqB9B,MAArB,CAAP;YAEK,IAAI5c,KAAJ,CAAU,qDAAqDH,GAA/D,CAAN;;;;sCAG+B8C,SAxajC;UAyaMoY,MAAM,GAAG,KAAK4D,YAAL,CAAkBhc,SAAS,CAACG,OAA5B,CAAb;UAEIgL,gBAAgB,GAAGnL,SAAS,CAACmL,gBAAjC;UACI8Q,UAAU,GAAGjc,SAAS,CAACic,UAA3B;;UACI9Q,gBAAgB,IAAI,IAApB,IAA4BA,gBAAgB,CAAChG,IAAjB,GAAwB,CAApD,IAAyD8W,UAAU,GAAG,CAAtE,IAA2Ejc,SAAS,CAAC7D,IAAV,IAAkB,IAAjG,EAAuG;YAElG+f,cAAJ;;YACI/Q,gBAAgB,IAAI,IAAxB,EAA8B;UAC7B+Q,cAAc,GAAG,KAAKC,8BAAL,CAAoChR,gBAApC,CAAjB;;eAEK,IAAI7J,GAAT,IAAgB4a,cAAhB,EAA+B;gBAC1BA,cAAc,CAACta,cAAf,CAA8BN,GAA9B,CAAJ,EAAwC;;kBAEnC8a,kBAAkB,GAAGF,cAAc,CAAC5a,GAAD,CAAvC;;kBACI8a,kBAAkB,IAAI,IAA1B,EAAgC;;oBAE3BC,QAAQ,GAAGD,kBAAkB,CAACA,kBAAkB,CAACxhB,MAAnB,GAA4B,CAA7B,CAAjC;;oBACIyhB,QAAQ,IAAI,IAAhB,EAAsB;yBACdA,QAAQ,CAAC,IAAD,CAAf;sBACIC,MAAM,CAACC,IAAP,CAAYF,QAAZ,EAAsBzhB,MAAtB,IAAgC,CAApC,EACCwhB,kBAAkB,CAACA,kBAAkB,CAACxhB,MAAnB,GAA4B,CAA7B,CAAlB,GAAoD,IAApD;;;;;SAbN,MAoBCshB,cAAc,GAAG,EAAjB;;YAEGD,UAAU,GAAG,CAAjB,EACCC,cAAc,CAAC,IAAD,CAAd,GAAuBD,UAAvB;YAEGjc,SAAS,CAAC7D,IAAV,IAAkB,IAAtB,EACC+f,cAAc,CAAC,IAAD,CAAd,GAAuBlc,SAAS,CAAC7D,IAAjC;QAEDic,MAAM,CAACje,IAAP,CAAY+hB,cAAZ;OA/BD;WAmCK;UACJ9D,MAAM,CAACje,IAAP,CAAY,IAAZ;;;aAGMie,MAAP;;;;sCAG+BA,MAvdjC;UAwdMpY,SAAS,GAAG,IAAI3B,SAAJ,EAAhB;MACA2B,SAAS,CAACG,OAAV,GAAoB,KAAKqc,sBAAL,CAA4BpE,MAA5B,EAAoC,IAApC,CAApB;UAEI8D,cAAc,GAAG9D,MAAM,CAACA,MAAM,CAACxd,MAAP,GAAgB,CAAjB,CAA3B;;UACIshB,cAAc,IAAI,IAAtB,EAA4B;YAEvB/Q,gBAAgB,GAAG,IAAIpF,GAAJ,EAAvB;;aAEK,IAAIzE,GAAT,IAAgB4a,cAAhB,EAA+B;cAC1B5a,GAAG,IAAI,IAAX,EAAiB;YAChBtB,SAAS,CAACic,UAAV,GAAuBjgB,QAAQ,CAACkgB,cAAc,CAAC5a,GAAD,CAAf,CAA/B;WADD,MAEO,IAAIA,GAAG,IAAI,IAAX,EAAiB;YACvBtB,SAAS,CAAC7D,IAAV,GAAiB+f,cAAc,CAAC5a,GAAD,CAAd,CAAoBlF,QAApB,EAAjB;WADM,MAEA;gBACFqgB,gBAAgB,GAAG,KAAK/D,qBAAL,CAA2BwD,cAAc,CAAC5a,GAAD,CAAzC,CAAvB,CADM;;gBAGFob,iBAAiB,GAAGzf,QAAQ,CAACwf,gBAAD,EAAmBpe,SAAnB,CAAhC;gBACIqe,iBAAJ,EACCA,iBAAiB,CAACvgB,IAAlB,GAAyBmF,GAAzB;YACD6J,gBAAgB,CAACxH,GAAjB,CAAqBrC,GAArB,EAA0Bmb,gBAA1B;;;;QAIFzc,SAAS,CAACmL,gBAAV,GAA6BA,gBAA7B;;;aAGMnL,SAAP;;;;oCAG6B+Y,IArf/B;UAsfMkB,MAAM,GAAG,IAAI1C,MAAJ,EAAb;MACA0C,MAAM,CAAC3C,IAAP,GAAcyB,IAAI,CAAC,MAAD,CAAJ,CAAa3c,QAAb,EAAd;MACA6d,MAAM,CAAC1f,KAAP,GAAeyB,QAAQ,CAAC+c,IAAI,CAAC,OAAD,CAAL,CAAvB;MACAkB,MAAM,CAAC0C,UAAP,GAAoB5D,IAAI,CAAC,oBAAD,CAAJ,CAA2B3c,QAA3B,EAApB;MACA6d,MAAM,CAAC2C,mBAAP,GAA6B5gB,QAAQ,CAAC+c,IAAI,CAAC,qBAAD,CAAL,CAArC;MACAkB,MAAM,CAACC,kBAAP,GAA4BnB,IAAI,CAAC,YAAD,CAAJ,CAAmB3c,QAAnB,EAA5B;aACO6d,MAAP;;;;oCAG6BA,MA/f/B;UAggBMlB,IAAI,GAAY,EAApB;MACAA,IAAI,CAAC,MAAD,CAAJ,GAAekB,MAAM,CAAC3C,IAAtB;MACAyB,IAAI,CAAC,OAAD,CAAJ,GAAgBkB,MAAM,CAAC1f,KAAvB;MACAwe,IAAI,CAAC,oBAAD,CAAJ,GAA6BkB,MAAM,CAAC0C,UAApC;MACA5D,IAAI,CAAC,qBAAD,CAAJ,GAA8BkB,MAAM,CAAC2C,mBAArC;MACA7D,IAAI,CAAC,YAAD,CAAJ,GAAqBkB,MAAM,CAACC,kBAA5B;aACOnB,IAAP;;;;qCAG8BzG,OAzgBhC;UA0gBMoI,OAAO,GAAGpI,OAAO,CAAC5W,KAAtB;;UACIgf,OAAO,KAAK,IAAhB,EAAsB;eAAS/c,kBAAkB,CAAC,SAAD,CAAzB;;;UAEpBmb,IAAI,GAAY,EAApB;UAEI3Y,OAAO,GAAY,EAAvB;;;;;;8BAEuBua,OAAvB,mIAAgC;;cAAtBpZ,GAAsB;cAAjB8E,GAAiB;;cAC3BzE,IAAI,GAAGb,WAAW,CAACyC,iBAAZ,CAA8BjC,GAA9B,CAAX;UACAnB,OAAO,CAACwB,IAAI,CAACvF,QAAL,EAAD,CAAP,GAA2BgK,GAA3B;;;;;;;;;;;;;;;;;MAGD0S,IAAI,CAAC,MAAD,CAAJ,GAAe3Y,OAAf;;UAEIua,OAAO,CAACzW,KAAR,IAAiB,CAAjB,IAAsByW,OAAO,CAAC3V,WAAR,IAAuB,IAA7C,IAAqD2V,OAAO,CAAC3V,WAAR,CAAoBnK,MAApB,GAA6B,CAAtF,EAAyF;;QAExFke,IAAI,CAAC,SAAD,CAAJ,GAAkB4B,OAAO,CAAC3V,WAA1B;;;aAGM+T,IAAP;;;;4CAGqC9V,MAhiBvC;UAiiBMP,MAAM,GAAY,EAAtB;;;;;;8BAEgBO,MAAM,CAAC4U,KAAvB,mIAA8B;cAArBxV,GAAqB;cACzBya,WAAW,GAAY,EAA3B;;;;;;kCAEuBza,GAAG,CAACqD,KAA3B,mIAAkC;;kBAAxBnE,GAAwB;kBAAnB8E,GAAmB;;kBAC7BzE,IAAI,GAAGb,WAAW,CAACyC,iBAAZ,CAA8BjC,GAA9B,CAAX;;kBACIK,IAAI,CAACX,QAAL,KAAkB,IAAtB,EAA4B;uBAASrD,kBAAkB,CAAC,eAAD,CAAzB;;;cAC9Bkf,WAAW,CAAClb,IAAI,CAACX,QAAN,CAAX,GAA6BoF,GAA7B;;;;;;;;;;;;;;;;;UAGD3D,MAAM,CAACL,GAAG,CAACjG,IAAL,CAAN,GAAmB0gB,WAAnB;;;;;;;;;;;;;;;;;aAGMpa,MAAP;;;;4CAGqCvF,GAljBvC;;UAojBM4f,OAAO,GAAG5f,GAAd;UAEI6f,OAAO,GAAqB,EAAhC;;WAEK,IAAIzb,GAAT,IAAgBwb,OAAhB,EAAwB;YACnBA,OAAO,CAAClb,cAAR,CAAuBN,GAAvB,CAAJ,EAAiC;cAC5BnF,IAAI,GAAGmF,GAAG,CAAClF,QAAJ,EAAX,CADgC;;cAG5BygB,WAAW,GAAYC,OAAO,CAACxb,GAAD,CAAlC,CAHgC;;cAM5BmE,KAAK,GAAwB,IAAIM,GAAJ,EAAjC;;eAEK,IAAIiX,YAAT,IAAyBH,WAAzB,EAAqC;gBAChCC,OAAO,CAAClb,cAAR,CAAuBN,GAAvB,CAAJ,EAAiC;kBAC5B2b,SAAS,GAAGJ,WAAW,CAACG,YAAD,CAA3B;cACAvX,KAAK,CAAC9B,GAAN,CAAUqZ,YAAV,EAAwBhhB,QAAQ,CAACihB,SAAD,CAAhC;;;;cAIE7a,GAAG,GAAG,IAAIoV,cAAJ,CAAmBrb,IAAnB,EAAyBsJ,KAAzB,CAAV;UACAsX,OAAO,CAAC5iB,IAAR,CAAaiI,GAAb;;;;aAIK,IAAIuV,qBAAJ,CAA0BoF,OAA1B,CAAP;;;;;;;AAGc7E,sCAAA,GAAwB;MAClCgB,oBAAoB,GAAa,EAArC;EAEAA,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BE,SAA5B,CAApB,GAA6D,IAA7D;EACA4M,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BG,UAA5B,CAApB,GAA8D,KAA9D;EACA2M,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BI,OAA5B,CAApB,GAA2D,KAA3D;EACA0M,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BK,SAA5B,CAApB,GAA6D,IAA7D;EACAyM,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BM,iBAA5B,CAApB,GAAqE,KAArE;EACAwM,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BO,WAA5B,CAApB,GAA+D,MAA/D;EACAuM,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BQ,SAA5B,CAApB,GAA6D,MAA7D;EACAsM,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BS,WAA5B,CAApB,GAA+D,KAA/D;EACAqM,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BU,SAA5B,CAApB,GAA6D,MAA7D;EACAoM,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BW,IAA5B,CAApB,GAAwD,KAAxD;EACAmM,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BY,WAA5B,CAApB,GAA+D,WAA/D;EACAkM,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BX,KAA5B,CAApB,GAAyD,MAAzD;EACAyN,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2Ba,UAA5B,CAApB,GAA8D,OAA9D;EACAiM,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2Bc,SAA5B,CAApB,GAA6D,OAA7D;EACAgM,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2Be,MAA5B,CAApB,GAA0D,KAA1D;EACA+L,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BgB,UAA5B,CAApB,GAA8D,MAA9D;EACA8L,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BiB,UAA5B,CAApB,GAA8D,OAA9D;EACA6L,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BkB,oBAA5B,CAApB,GAAwE,KAAxE;EACA4L,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BmB,WAA5B,CAApB,GAA+D,QAA/D;EACA2L,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BoB,IAA5B,CAApB,GAAwD,MAAxD;EACA0L,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BqB,GAA5B,CAApB,GAAuD,KAAvD;EACAyL,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BsB,WAA5B,CAApB,GAA+D,SAA/D;EACAwL,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BuB,SAA5B,CAApB,GAA6D,OAA7D;EACAuL,oBAAoB,CAACjN,cAAc,CAACG,WAAf,CAA2BwB,UAA5B,CAApB,GAA8D,MAA9D;;OAEK,IAAIjT,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGsR,cAAc,CAACG,WAAf,CAA2B8Q,YAA/C,EAA6D,EAAEviB,CAA/D,EAAkE;QAC7Due,oBAAoB,CAACve,CAAD,CAApB,IAA2B,IAA/B,EACC,MAAM,IAAI0C,KAAJ,CAAU,oDAAV,CAAN;;;SAGK6b,oBAAP;CAjCqC,EAAvB;;ACxmBhB;;AAEA,IAAaiE,IAAb;;AAAA;gBAIaC,IAAZ;;;SACMA,IAAL,GAAYA,IAAI,GAAG,UAAnB;QACI,KAAKA,IAAL,IAAa,CAAjB,EAAoB,KAAKA,IAAL,IAAa,UAAb;;;;;;aAGb,KAAKA,IAAL,GAAY,KAAKA,IAAL,GAAY,KAAZ,GAAoB,UAAvC;;;;;aAGO,CAAC,KAAKC,IAAL,KAAc,CAAf,IAAoB,UAA3B;;;;;;;ACdF;;;;AAIA,IAAaC,SAAb;;AAAA;;;;SAKOC,SAAL,GAAiBzb,SAAjB;;;;;;WAWKyb,SAAL,GAAiB,IAAIC,IAAJ,GAAWC,OAAX,EAAjB;;;;;WAGKF,SAAL,GAAiBzb,SAAjB;;;;;UAVI,OAAO,KAAKyb,SAAZ,KAA0B,WAA9B,EAA0C;eAClC,CAAP;;;aAEO,IAAIC,IAAJ,GAAWC,OAAX,EAAD,GAAyB,KAAKF,SAArC;;;;;;;ACiBF,IAAI,CAAC7Y,MAAM,CAACE,SAAZ,EAAuB;EACtBF,MAAM,CAACE,SAAP,GAAmB,SAASA,SAAT,CAAmB8Y,IAAnB;WACX,OAAOA,IAAP,KAAgB,QAAhB,IAA4BC,QAAQ,CAACD,IAAD,CAApC,IAA8CA,IAAI,GAAG,CAAC,gBAAtD,IAA0EA,IAAI,GAAG,gBAAjF,IAAqG9e,IAAI,CAAC0W,KAAL,CAAWoI,IAAX,MAAqBA,IAAjI;GADD;;;AAKD,IAAaE,KAAb;;AAAA;;;;;;;;;2BAEQ,GAAoB,EAApB;qCAEA,GAA8B,EAA9B;yBA0hBC,GAA+B,EAA/B;wCA+tBD,GAA0C,KAA1C;0BAmiBC,GAAiD,IAAjD;4BAGA,GAAmE,IAAnE;gCACA,GAAkC,KAAlC;uCAEA,GAAkD,IAAlD;8BASA,GAAgC,KAAhC;6BACA,GAAyC,IAAzC;iCAEA,GAAkC,CAAlC;mBAEA,GAAwB,IAAxB;;;QA/uDHpf,gBAAJ;QACIoZ,KAAK,GAA4B,IAArC;QACIiG,IAAI,GAAmB,IAA3B;;QAEI/jB,SAAS,CAAC,CAAD,CAAT,YAAwBuE,SAA5B,EAAuC;MACtCG,gBAAgB,GAAG1E,SAAS,CAAC,CAAD,CAA5B;;UAEI,OAAOA,SAAS,CAAC,CAAD,CAAhB,KAAwB,WAA5B,EAAyC;QACxC8d,KAAK,GAAG9d,SAAS,CAAC,CAAD,CAAjB;OAJqC;;;YAQjCgkB,qBAAL,GAA6Btf,gBAA7B,CARsC;KAAvC,MAUO;UACF,OAAO1E,SAAS,CAAC,CAAD,CAAhB,KAAwB,QAA5B,EAAsC;YACjCikB,UAAU,GAAGjkB,SAAS,CAAC,CAAD,CAA1B;QACA+jB,IAAI,GAAGzc,IAAI,CAACG,KAAL,CAAWwc,UAAX,CAAP;OAFD,MAGO;QACNF,IAAI,GAAG/jB,SAAS,CAAC,CAAD,CAAhB;;;;;QAKE8d,KAAK,IAAI,IAAb,EACC,MAAKoG,gBAAL,GAAwB,IAAIrG,qBAAJ,CAA0BC,KAA1B,CAAxB;UAEIqG,UAAL,GAAkB,IAAIlY,GAAJ,EAAlB;;;QAII8X,IAAI,KAAK,IAAb,EAAmB;UACdK,UAAU,GAAYL,IAA1B;UAEIM,UAAU,GAAGD,UAAU,CAAC,YAAD,CAA3B;UACIC,UAAU,IAAI,IAAlB,EACC,MAAM,IAAI9gB,KAAJ,CAAU,yEAAV,CAAN;UAEG+gB,cAAc,GAAGpiB,QAAQ,CAACmiB,UAAD,CAA7B;;UACIC,cAAc,GAAG,MAAKC,iBAA1B,EAA4C;cACrC,IAAIhhB,KAAJ,CAAU,qFAAV,CAAN;OADD,MAGK,IAAI+gB,cAAc,GAAG,MAAKE,2BAA1B,EAAsD;cACpD,IAAIjhB,KAAJ,CAAU,0FAAV,CAAN;OADI,MAGA,IAAI+gB,cAAc,IAAI,MAAKC,iBAA3B,EAA6C;QACjDvhB,OAAO,CAACC,IAAR,CAAa,iIAAb;;;UAGGwhB,SAAS,GAAGL,UAAU,CAAC,MAAD,CAA1B;UACIK,SAAS,IAAI,IAAjB,EACC,MAAM,IAAIlhB,KAAJ,CAAU,wEAAV,CAAN;UAEGmhB,WAAJ;;UACIA,WAAW,GAAGN,UAAU,CAAC,UAAD,CAA5B,EAA0C;cACpCF,gBAAL,GAAwB9F,iBAAiB,CAACuG,uBAAlB,CAA0CD,WAA1C,CAAxB;;;YAGIV,qBAAL,GAA6B1gB,UAAU,CAAC8a,iBAAiB,CAACQ,qBAAlB,CAAwC6F,SAAxC,CAAD,EAAqDlgB,SAArD,CAAvC;;YAEKqgB,UAAL;;;;;;;;;;;;;;;;;UAMGC,qBAAqB,GAAGzG,iBAAiB,CAACI,qBAAlB,CAAwC,KAAKwF,qBAA7C,CAA5B;UAEKI,UAAU,GAAY,EAA3B;MACAA,UAAU,CAAC,YAAD,CAAV,GAA2B,KAAKG,iBAAhC;MACAH,UAAU,CAAC,MAAD,CAAV,GAAqBS,qBAArB;UAEI,KAAKX,gBAAL,IAAyB,IAA7B,EACCE,UAAU,CAAC,UAAD,CAAV,GAAyBhG,iBAAiB,CAAC0G,uBAAlB,CAA0C,KAAKZ,gBAA/C,CAAzB;aAEM5c,IAAI,CAACC,SAAL,CAAe6c,UAAf,CAAP;;;;;WAIKW,aAAL,CAAmB,YAAnB;WAEKC,MAAL,GAAc,IAAIC,UAAJ,CAAe,IAAf,CAAd;;WACKD,MAAL,CAAYE,cAAZ,CAA2BC,qBAA3B,CAAiD,KAAKC,2BAAL,CAAiCC,IAAjC,CAAsC,IAAtC,CAAjD;;WAEKC,YAAL;;;;;UAII,KAAKN,MAAL,KAAgB,IAApB,EAA0B;eAASnhB,kBAAkB,CAAC,aAAD,CAAzB;;;WACvBmhB,MAAL,CAAYO,WAAZ;;;;;WAIKR,aAAL,CAAmB,gBAAnB;;UACI,KAAKC,MAAL,KAAgB,IAApB,EAA0B;eAASnhB,kBAAkB,CAAC,aAAD,CAAzB;;;WACvBmhB,MAAL,CAAYQ,QAAZ;;;;;UAII,KAAKxB,qBAAL,CAA2BlU,YAA3B,CAAwCvD,GAAxC,CAA4C,aAA5C,CAAJ,EAA+D;YAC1DkZ,eAAe,GAAG,KAAKC,KAAL,CAAWC,cAAX,CAA0BtQ,IAA1B,EAAtB;aAEKuQ,UAAL,CAAgB,IAAIhmB,IAAJ,CAAS,aAAT,CAAhB,EAAyC,KAAzC;aAEKimB,gBAAL;aAEKH,KAAL,CAAWC,cAAX,GAA4BF,eAA5B;;;WAGIC,KAAL,CAAWR,cAAX,CAA0BY,sBAA1B;;;;;WAIKC,aAAL,CAAmB,CAAnB;aACO,KAAKC,WAAZ;;;;kCAWoBC,mBAlMtB;UAmMM,CAAC,KAAKC,sBAAV,EACC,KAAKC,wBAAL;WAEIN,gBAAL,CAAsBI,mBAAtB;;;;;UAGuBA,0FAAsB;UACzC,KAAKG,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAeC,WAAf;UAEGC,kBAAkB,GAAGL,mBAAmB,GAAG,CAA/C;WACKM,uBAAL;;UAEI,CAAC,KAAKC,oBAAV,EAAgC;aAC1BA,oBAAL,GAA4BF,kBAA5B;;YAEI,CAAC,KAAKG,WAAV,EAAuB;gBAChB,IAAIva,cAAJ,CAAmB,mEAAnB,CAAN;;;aAGI8Y,MAAL,CAAY0B,WAAZ,GAA0B,KAA1B;;aACK1B,MAAL,CAAY2B,WAAZ;;YAEI,KAAKJ,uBAAL,IAAgC,CAApC,EACC,KAAKvB,MAAL,CAAYE,cAAZ,CAA2B0B,6BAA3B,GAA2D,IAA3D;;;UAGEC,iBAAiB,GAAG,IAAIrD,SAAJ,EAAxB;MACAqD,iBAAiB,CAACC,KAAlB;UAEIC,yBAAyB,GAAG,KAAhC;;SACG;YACE;UACHA,yBAAyB,GAAG,KAAKC,kBAAL,EAA5B;SADD,CAEE,OAAOC,CAAP,EAAU;cACP,EAAEA,CAAC,YAAY/a,cAAf,CAAJ,EAAoC,MAAM+a,CAAN;eAE/BC,QAAL,CAAcD,CAAC,CAACpkB,OAAhB,EAAyBmF,SAAzB,EAAoCif,CAAC,CAAC9a,gBAAtC;;;;YAIG4a,yBAAJ,EACC;;YAEG,KAAKP,oBAAL,IAA6BK,iBAAiB,CAACM,mBAAlB,GAAwClB,mBAAzE,EAA8F;;;OAb/F,QAiBQ,KAAKQ,WAjBb;;MAmBAI,iBAAiB,CAACO,IAAlB;;UAEIL,yBAAyB,IAAI,CAAC,KAAKN,WAAvC,EAAoD;YAC/C,KAAKY,mBAAL,IAA4B,IAAhC,EAAsC;eAChCC,oBAAL,CAA0B,KAAKD,mBAA/B;eACKA,mBAAL,GAA2B,IAA3B;;;YAGG,CAAC,KAAKZ,WAAV,EAAuB;cAClB,KAAKf,KAAL,CAAW6B,SAAX,CAAqBC,YAAzB,EACC,KAAKN,QAAL,CAAc,kFAAd;;cAEG,KAAKxB,KAAL,CAAW+B,gBAAX,CAA4B3mB,MAA5B,IAAsC,CAAtC,IAA2C,CAAC,KAAK4kB,KAAL,CAAWgB,WAAvD,IAAsE,KAAKgB,6BAAL,IAAsC,IAAhH,EAAsH;gBACjH,KAAKhC,KAAL,CAAW6B,SAAX,CAAqBI,MAArB,CAA4B5T,WAAW,CAAC+L,MAAxC,CAAJ,EACC,KAAKoH,QAAL,CAAe,oFAAf,EADD,KAEK,IAAI,KAAKxB,KAAL,CAAW6B,SAAX,CAAqBI,MAArB,CAA4B5T,WAAW,CAACY,QAAxC,CAAJ,EACJ,KAAKuS,QAAL,CAAe,gEAAf,EADI,KAEA,IAAI,CAAC,KAAKxB,KAAL,CAAW6B,SAAX,CAAqBK,MAA1B,EACJ,KAAKV,QAAL,CAAe,0DAAf,EADI,KAGJ,KAAKA,QAAL,CAAe,gFAAf;;;;aAIExB,KAAL,CAAWgB,WAAX,GAAyB,KAAzB;YAEI,KAAKH,uBAAL,IAAgC,CAApC,EACC,KAAKvB,MAAL,CAAYE,cAAZ,CAA2B0B,6BAA3B,GAA2D,KAA3D;aAEIJ,oBAAL,GAA4B,KAA5B;;;WAGID,uBAAL;UAEI,KAAKH,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAeyB,YAAf;;;;;UAIG,KAAKzB,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAe0B,OAAf;WAEIC,IAAL;UAEI,KAAK3B,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAe4B,QAAf;;UAEG,CAAC,KAAKvB,WAAN,IAAqB,CAAC,KAAKf,KAAL,CAAW6B,SAAX,CAAqBU,yBAA/C,EAA0E;aACpEC,+BAAL;;;UAGG,KAAK9B,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAe+B,WAAf;;UAEG,CAAC,KAAKzC,KAAL,CAAW0C,kBAAhB,EAAoC;YAE/B,KAAKf,mBAAL,IAA4B,IAAhC,EAAsC;cAEjC,KAAKA,mBAAL,CAAyBgB,WAAzB,KAAyC,IAA7C,EAAmD;mBAASxkB,kBAAkB,CAAC,sCAAD,CAAzB;;;cACjD,KAAK6hB,KAAL,CAAW2C,WAAX,KAA2B,IAA/B,EAAqC;mBAASxkB,kBAAkB,CAAC,wBAAD,CAAzB;;;cAEnCykB,MAAM,GAAG,KAAKC,iCAAL,CACZ,KAAKlB,mBAAL,CAAyBrB,WADb,EAC0B,KAAKN,KAAL,CAAWM,WADrC,EAEZ,KAAKqB,mBAAL,CAAyBgB,WAAzB,CAAqCvnB,MAFzB,EAEiC,KAAK4kB,KAAL,CAAW2C,WAAX,CAAuBvnB,MAFxD,CAAb;;cAKIwnB,MAAM,IAAIxE,KAAK,CAAC0E,iBAAN,CAAwBC,qBAAtC,EAA6D;iBAEvDnB,oBAAL,CAA0B,KAAKD,mBAA/B;mBAEO,IAAP;WAJD,MAOK,IAAIiB,MAAM,IAAIxE,KAAK,CAAC0E,iBAAN,CAAwBE,cAAtC,EAAsD;iBACrDrB,mBAAL,GAA2B,IAA3B;;;;YAIE,KAAK3B,KAAL,CAAWqB,yBAAf,EAA0C;cACrC,KAAKN,WAAT,EAAsB;gBACjB,KAAKY,mBAAL,IAA4B,IAAhC,EACC,KAAKA,mBAAL,GAA2B,KAAKsB,aAAL,EAA3B;WAFF,MAKK;iBACCtB,mBAAL,GAA2B,IAA3B;;;;;UAKC,KAAKjB,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAewC,YAAf;aAEM,KAAP;;;;sDAGwCC,QArV1C,EAqVmEC,QArVnE,EAqV4FC,YArV5F,EAqVkHC,YArVlH;UAsVMH,QAAQ,KAAK,IAAjB,EAAuB;eAAShlB,kBAAkB,CAAC,UAAD,CAAzB;;;UACrBilB,QAAQ,KAAK,IAAjB,EAAuB;eAASjlB,kBAAkB,CAAC,UAAD,CAAzB;;;UAErBolB,kBAAkB,GAAGH,QAAQ,CAAChoB,MAAT,IAAmB+nB,QAAQ,CAAC/nB,MAA5B,IAAsCgoB,QAAQ,CAACI,MAAT,CAAgBL,QAAQ,CAAC/nB,MAAT,GAAkB,CAAlC,KAAwC,IAAvG;UACIioB,YAAY,IAAIC,YAAhB,IAAgCH,QAAQ,CAAC/nB,MAAT,IAAmBgoB,QAAQ,CAAChoB,MAA5D,IAAsEmoB,kBAA1E,EACC,OAAOnF,KAAK,CAAC0E,iBAAN,CAAwBW,QAA/B;;UAEG,CAACF,kBAAL,EAAyB;eACjBnF,KAAK,CAAC0E,iBAAN,CAAwBE,cAA/B;;;UAGGM,YAAY,GAAGD,YAAnB,EACC,OAAOjF,KAAK,CAAC0E,iBAAN,CAAwBC,qBAA/B;;WAEI,IAAI5nB,CAAC,GAAGgoB,QAAQ,CAAC/nB,MAAtB,EAA8BD,CAAC,GAAGioB,QAAQ,CAAChoB,MAA3C,EAAmDD,CAAC,EAApD,EAAwD;YACnDO,CAAC,GAAG0nB,QAAQ,CAACI,MAAT,CAAgBroB,CAAhB,CAAR;;YACIO,CAAC,IAAI,GAAL,IAAYA,CAAC,IAAI,IAArB,EAA2B;iBACnB0iB,KAAK,CAAC0E,iBAAN,CAAwBC,qBAA/B;;;;aAIK3E,KAAK,CAAC0E,iBAAN,CAAwBW,QAA/B;;;;;WAIKpE,aAAL,CAAmB,mBAAnB;UAEI5Z,EAAE,GAAG,IAAI3E,aAAJ,EAAT;;aAEO,KAAKigB,WAAZ,EAAyB;QACxBtb,EAAE,CAACzE,MAAH,CAAU,KAAK0iB,QAAL,EAAV;;;aAGMje,EAAE,CAAC7I,QAAH,EAAP;;;;kCAGoBH,IA1XtB;aA2XS,KAAKknB,oBAAL,CAA0BnlB,aAA1B,CAAwC/B,IAAxC,CAAP;;;;0CAG4BE,IA9X9B;UA+XMinB,cAAc,GAAG,KAAKD,oBAAL,CAA0BvZ,YAA1B,CAAuCvD,GAAvC,CAA2ClK,IAA3C,CAArB;UACIinB,cAAc,YAAY/kB,SAA9B,EACC,OAAO+kB,cAAP,CADD,KAGC,OAAO,IAAP;;;;kCAGmBnnB,IAtYtB;UAuYMA,IAAI,CAACrB,MAAL,IAAe,CAAnB,EACC,OAAOkT,OAAO,CAACrM,IAAf;UAEGhH,CAAC,GAAG,IAAIqT,OAAJ,EAAR;UAEIuV,eAAe,GAAGpnB,IAAI,CAACrB,MAA3B;UAEI6H,MAAM,GAAG,IAAb;;UACIxG,IAAI,CAACgT,aAAL,KAAuB,IAA3B,EAAiC;eAAStR,kBAAkB,CAAC,oBAAD,CAAzB;;;UAE/B1B,IAAI,CAACgT,aAAL,CAAmBzT,OAAvB,EAAgC;QAC/B6nB,eAAe,GAAGpnB,IAAI,CAACrB,MAAL,GAAc,CAAhC;QACA6H,MAAM,GAAG,KAAK0gB,oBAAL,CAA0BnlB,aAA1B,CAAwC/B,IAAxC,EAA8C6F,SAA9C,EAAyDuhB,eAAzD,CAAT;QACA5oB,CAAC,CAACuF,SAAF,GAAcyC,MAAM,CAACzC,SAArB;QACAvF,CAAC,CAACF,KAAF,GAAU0B,IAAI,CAACgT,aAAL,CAAmB1U,KAA7B;OAJD,MAKO;QACNkI,MAAM,GAAG,KAAK0gB,oBAAL,CAA0BnlB,aAA1B,CAAwC/B,IAAxC,CAAT;QACAxB,CAAC,CAACuF,SAAF,GAAcyC,MAAM,CAACzC,SAArB;QACAvF,CAAC,CAACF,KAAF,GAAU,CAAC,CAAX;;;UAGGkI,MAAM,CAACvF,GAAP,IAAc,IAAd,IAAsBuF,MAAM,CAACvF,GAAP,IAAc,KAAKimB,oBAAnB,IAA2CE,eAAe,GAAG,CAAvF,EAA0F;aACpFhmB,KAAL,CAAW,qCAAqCpB,IAArC,GAA4C,6CAAvD;OADD,MAEO,IAAIwG,MAAM,CAACyG,WAAX,EACN,KAAKoa,OAAL,CAAa,qCAAqCrnB,IAArC,GAA4C,iCAA5C,GAA8EwG,MAAM,CAACvF,GAAP,CAAWjB,IAAzF,GAA8F,IAA3G;;aAEMxB,CAAP;;;;;aAIO,KAAK+kB,KAAL,CAAW+D,IAAX,EAAP;;;;yCAG2B/D,KAxa7B;WAyaOV,MAAL,GAAcU,KAAd;;;;;UAKIgE,iBAAiB,GAAG,IAAxB;UAEIC,OAAO,GAAG,KAAKjE,KAAL,CAAWC,cAAX,CAA0BtQ,IAA1B,EAAd;;UACIsU,OAAO,CAACle,MAAZ,EAAoB;;;;;UAKhBme,gBAAgB,GAAGzmB,QAAQ,CAACwmB,OAAO,CAAC3U,OAAR,EAAD,EAAoBzQ,SAApB,CAA/B;;aAEMqlB,gBAAN,EAAwB;aAElBC,cAAL,CAAoBD,gBAApB,EAAsC,IAAtC,EAFuB;;YAKnBA,gBAAgB,CAACvjB,OAAjB,CAAyBvF,MAAzB,IAAmC,CAAvC,EAA0C;;;;QAI1C6oB,OAAO,GAAG3V,OAAO,CAACoB,OAAR,CAAgBwU,gBAAhB,CAAV,CATuB;;QAWvBA,gBAAgB,GAAGzmB,QAAQ,CAACwmB,OAAO,CAAC3U,OAAR,EAAD,EAAoBzQ,SAApB,CAA3B;;;WAGImhB,KAAL,CAAWC,cAAX,GAA4BgE,OAAO,CAACtU,IAAR,EAA5B;UAEI,KAAK+Q,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAe2B,IAAf,CAAoB,KAAKrC,KAAL,CAAW6B,SAA/B;;;;;;UAOGuC,iBAAiB,GAAGH,OAAO,CAAC3U,OAAR,EAAxB;UACI+U,oBAAoB,GAAG,KAAKC,0BAAL,CAAgCF,iBAAhC,CAA3B;;UAGI,KAAKpE,KAAL,CAAWC,cAAX,CAA0Bla,MAA9B,EAAsC;;;;UAIlCse,oBAAJ,EAA0B;QACzBL,iBAAiB,GAAG,KAApB;;;;;UAKGvI,WAAW,GAAGhe,QAAQ,CAAC2mB,iBAAD,EAAoBvU,WAApB,CAA1B;;UACI4L,WAAJ,EAAiB;YACZhB,MAAM,GAAG,KAAK8J,aAAL,CAAmB9I,WAAnB,CAAb;;YACIhB,MAAJ,EAAY;eACNuF,KAAL,CAAW+B,gBAAX,CAA4BpnB,IAA5B,CAAiC8f,MAAjC;;;QAGD2J,iBAAiB,GAAG,IAApB;QACAJ,iBAAiB,GAAG,KAApB;;;;;UAKGI,iBAAiB,YAAYvlB,SAAjC,EAA4C;QAC3CmlB,iBAAiB,GAAG,KAApB;;;;UAIGA,iBAAJ,EAAuB;;;;;YAMlBQ,UAAU,GAAG/mB,QAAQ,CAAC2mB,iBAAD,EAAoBxb,oBAApB,CAAzB;;YACI4b,UAAU,IAAIA,UAAU,CAAC1b,YAAX,IAA2B,CAAC,CAA9C,EAAiD;;cAG5C2b,UAAU,GAAG,KAAKzE,KAAL,CAAW6B,SAAX,CAAqB6C,uBAArB,CAA6CF,UAAU,CAAC3b,YAAxD,CAAjB;UACAub,iBAAiB,GAAG,IAAIxb,oBAAJ,CAAyB4b,UAAU,CAAC3b,YAApC,EAAkD4b,UAAlD,CAApB;SAXqB;;;YAelB,KAAKzE,KAAL,CAAW2E,sBAAf,EAAuC;eACjC3E,KAAL,CAAW4E,mBAAX,CAA+BR,iBAA/B;SADD;aAIK;iBACCpE,KAAL,CAAW6E,kBAAX,CAA8BT,iBAA9B;;;;;WAKGU,WAAL;;;;UAKI5I,UAAU,GAAGze,QAAQ,CAAC2mB,iBAAD,EAAoB3X,cAApB,CAAzB;;UACIyP,UAAU,IAAIA,UAAU,CAACvP,WAAX,IAA0BF,cAAc,CAACG,WAAf,CAA2BmB,WAAvE,EAAoF;aAC9EiS,KAAL,CAAW6B,SAAX,CAAqBkD,UAArB;;;;;mCAIoBvkB,SAphBvB,EAohB6CwkB,OAphB7C;UAqhBM,CAACxkB,SAAS,CAAC0L,mBAAX,IAAkC8Y,OAAtC,EAA+C;YAC1CxkB,SAAS,CAACqL,qBAAd,EACC,KAAKoZ,+BAAL,CAAqCzkB,SAArC;YAEGA,SAAS,CAACwL,wBAAd,EACC,KAAKkZ,+BAAL,CAAqC1kB,SAArC;;;;;;UAME2kB,eAAe,GAAG,KAAKnF,KAAL,CAAWmF,eAAX,CAA2BxV,IAA3B,EAAtB;UACIsU,OAAO,GAAG,KAAKjE,KAAL,CAAWC,cAAX,CAA0BtQ,IAA1B,EAAd;UAEIsU,OAAO,CAACle,MAAR,IAAkBke,OAAO,CAAClpB,KAAR,IAAiB,CAAC,CAAxC,EACC;WAEIqqB,eAAL,CAAqBhqB,MAArB,GAA8B,CAA9B;;UACI,CAAC+pB,eAAe,CAACpf,MAArB,EAA6B;;YAExBsf,wBAAwB,GAAGF,eAAe,CAAC7V,OAAhB,EAA/B;YACIgW,YAAY,GAAG7nB,QAAQ,CAAC4nB,wBAAD,EAA2BxmB,SAA3B,CAAR,IAAiDpB,QAAQ,CAAC0nB,eAAe,CAAC3kB,SAAjB,EAA4B3B,SAA5B,CAA5E;;eACOymB,YAAP,EAAqB;eACfF,eAAL,CAAqBzqB,IAArB,CAA0B2qB,YAA1B,EADoB;;;UAGpBA,YAAY,GAAG7nB,QAAQ,CAAC6nB,YAAY,CAACxmB,MAAd,EAAsBD,SAAtB,CAAvB;;;;UAIE0mB,uBAAuB,GAAGtB,OAAO,CAAC3U,OAAR,EAA9B;UAEIiW,uBAAuB,IAAI,IAA/B,EAAqC;;UAGjCC,wBAAwB,GAAG/nB,QAAQ,CAAC8nB,uBAAuB,CAACzmB,MAAzB,EAAiCD,SAAjC,CAAvC;;aACO2mB,wBAAwB,KAAK,KAAKJ,eAAL,CAAqBxkB,OAArB,CAA6B4kB,wBAA7B,IAAyD,CAAzD,IAA8DA,wBAAwB,CAACtZ,mBAA5F,CAA/B,EAAiJ;;;YAI5IuZ,eAAe,GAAGD,wBAAwB,CAAC7kB,OAAzB,CAAiCvF,MAAjC,GAA0C,CAA1C,IAClBmqB,uBAAuB,IAAIC,wBAAwB,CAAC7kB,OAAzB,CAAiC,CAAjC,CAD/B,CAJgJ;;aAQ3IwjB,cAAL,CAAoBqB,wBAApB,EAA8CC,eAA9C;QAEAF,uBAAuB,GAAGC,wBAA1B,CAVgJ;;QAYhJA,wBAAwB,GAAG/nB,QAAQ,CAAC+nB,wBAAwB,CAAC1mB,MAA1B,EAAkCD,SAAlC,CAAnC;;;;;kCAImB4c,WAxkBtB;UAykBMiK,UAAU,GAAG,IAAjB;;UAGIjK,WAAW,CAACrL,YAAhB,EAA8B;YACzBuV,cAAc,GAAG,KAAK3F,KAAL,CAAW4F,kBAAX,EAArB;;YACI,CAAC,KAAKC,QAAL,CAAcF,cAAd,CAAL,EAAoC;UACnCD,UAAU,GAAG,KAAb;;;;UAIEI,SAAS,GAAG,EAAhB;UACIC,cAAc,GAAG,EAArB;;UAEItK,WAAW,CAACnL,oBAAhB,EAAsC;;YAEjC0V,gBAAgB,GAAGpoB,UAAU,CAAC,KAAKoiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCne,WAAlC,CAAjC;QACAse,cAAc,GAAGC,gBAAgB,CAAC9pB,KAAjB,IAA0B,EAA3C;;;UAGGuf,WAAW,CAACpL,eAAhB,EAAiC;;YAE5B4V,WAAW,GAAGroB,UAAU,CAAC,KAAKoiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCne,WAAlC,CAA5B;QACAqe,SAAS,GAAGG,WAAW,CAAC/pB,KAAZ,IAAqB,EAAjC;;;;UAIGuf,WAAW,CAAC3L,QAAhB,EAA0B;YACrBoW,UAAU,GAAG,KAAKC,sBAAL,CAA4B1K,WAAW,CAACtL,YAAxC,CAAjB;;YACI+V,UAAU,GAAG,CAAjB,EAAoB;UACnBR,UAAU,GAAG,KAAb;;;;;;;UAOE,CAACA,UAAL,EAAiB;eACT,IAAP;;;UAGGjL,MAAM,GAAG,IAAI1C,MAAJ,EAAb;MACA0C,MAAM,CAAC/R,UAAP,GAAoB+S,WAAW,CAAC1L,YAAhC;MACA0K,MAAM,CAAC0C,UAAP,GAAoB1B,WAAW,CAAChf,IAAZ,CAAiBG,QAAjB,EAApB;MACA6d,MAAM,CAAClK,kBAAP,GAA4BkL,WAAW,CAAClL,kBAAxC;MACAkK,MAAM,CAAC2L,kBAAP,GAA4B,KAAKpG,KAAL,CAAW6B,SAAX,CAAqBwE,UAArB,EAA5B;MAEA5L,MAAM,CAAC3C,IAAP,GAAc,CAACgO,SAAS,GAAGC,cAAb,EAA6B5kB,OAA7B,CAAqC,kBAArC,EAAyD,EAAzD,CAAd;aAEOsZ,MAAP;;;;6BAGe/c,GA5nBjB;UA6nBM4oB,MAAM,GAAG,KAAb;;UACI5oB,GAAG,YAAY2F,KAAnB,EAA0B;YACrBuD,GAAG,GAAGlJ,GAAV;;YAEIkJ,GAAG,YAAYiB,iBAAnB,EAAsC;cACjC0e,SAAS,GAAG3f,GAAhB;eACK/I,KAAL,CAAW,uCAAuC0oB,SAAS,CAAC7d,UAAjD,GAA8D,qHAAzE;iBACO,KAAP;;;eAGM9B,GAAG,CAACgM,QAAX;;;aAEM0T,MAAP;;;;+CAGiCxc,UA5oBnC;UA6oBMA,UAAU,IAAI,IAAlB,EAAyB;eACjB,KAAP;;;;UAIGA,UAAU,YAAY0E,MAA1B,EAAkC;YAC7BgY,aAAa,GAAG1c,UAApB;;YAEI0c,aAAa,CAACxX,aAAlB,EAAiC;cAC5B2W,cAAc,GAAG,KAAK3F,KAAL,CAAW4F,kBAAX,EAArB,CADgC;;cAI5B,CAAC,KAAKC,QAAL,CAAcF,cAAd,CAAL,EACC,OAAO,IAAP;;;YAGEa,aAAa,CAAC5X,iBAAlB,EAAqC;cAChCkM,OAAO,GAAG0L,aAAa,CAAC3X,kBAA5B;cAEI4X,WAAW,GAAG,KAAKzG,KAAL,CAAWR,cAAX,CAA0BkH,mBAA1B,CAA8C5L,OAA9C,CAAlB;;cAEI2L,WAAW,IAAI,IAAnB,EAAyB;iBACnB5oB,KAAL,CAAW,6EAA6Eid,OAA7E,GAAuF,GAAlG;WADD,MAGK,IAAI,EAAE2L,WAAW,YAAY5e,iBAAzB,CAAJ,EAAiD;;gBAGjD8e,UAAU,GAAGlpB,QAAQ,CAACgpB,WAAD,EAAc9e,QAAd,CAAzB;gBAEIif,YAAY,GAAG,oEAAoE9L,OAApE,GAA8E,uCAAjG;;gBACI6L,UAAU,YAAYhf,QAAtB,IAAkCgf,UAAU,CAACzqB,KAAX,IAAoB,CAA1D,EAA6D;cAC5D0qB,YAAY,IAAI,+BAAhB;aADD,MAEO;cACNA,YAAY,IAAI,gBAAgBH,WAAhB,GAA8B,IAA9C;;;iBAGI5oB,KAAL,CAAW+oB,YAAX;;;cAGGrM,MAAM,GAAG3c,UAAU,CAAC6oB,WAAD,EAAc5e,iBAAd,CAAvB;eACKmY,KAAL,CAAW6G,eAAX,GAA6B,KAAKC,aAAL,CAAmBvM,MAAM,CAAC7R,UAA1B,CAA7B;SAxBD,MA0BO,IAAI8d,aAAa,CAAClM,UAAlB,EAA8B;eAC/ByM,oBAAL,CAA0BP,aAAa,CAACtX,gBAAxC,EAA0DsX,aAAa,CAAChM,YAAxE;iBACO,IAAP;SAFM,MAGA;eACDwF,KAAL,CAAW6G,eAAX,GAA6BL,aAAa,CAACnX,aAAd,CAA4BM,IAA5B,EAA7B;;;YAGG6W,aAAa,CAAC9X,aAAlB,EAAiC;eAC3BsR,KAAL,CAAW6B,SAAX,CAAqBmF,IAArB,CACCR,aAAa,CAAC/X,aADf,EAECnM,SAFD,EAGC,KAAK0d,KAAL,CAAWiH,YAAX,CAAwB7rB,MAHzB;;;YAOG,KAAK4kB,KAAL,CAAW6G,eAAX,CAA2B9gB,MAA3B,IAAqC,CAACygB,aAAa,CAAClM,UAAxD,EAAoE;cAE/DkM,aAAa,IAAIA,aAAa,CAAC9nB,aAA/B,IAAgD8nB,aAAa,CAAC9nB,aAAd,CAA4BwoB,UAA5B,IAA0C,IAA9F,EAAoG;iBAC9FrpB,KAAL,CAAW,kCAAkC2oB,aAAa,CAAC9nB,aAAd,CAA4BwoB,UAAzE;WADD,MAEO;iBACDrpB,KAAL,CAAW,+BAA+B2oB,aAA1C;;;;eAIK,IAAP;OA7DD;WAiEK,IAAI1c,UAAU,YAAY2C,cAA1B,EAA2C;cAC3C0a,WAAW,GAAGrd,UAAlB;;kBAEQqd,WAAW,CAACxa,WAApB;iBAEKF,cAAc,CAACG,WAAf,CAA2BE,SAAhC;mBACM1P,MAAL,CAAY,KAAK4iB,KAAL,CAAW2E,sBAAX,KAAsC,KAAlD,EAAyD,mCAAzD;mBACK3E,KAAL,CAAW2E,sBAAX,GAAoC,IAApC;;;iBAGIlY,cAAc,CAACG,WAAf,CAA2BI,OAAhC;mBACM5P,MAAL,CAAY,KAAK4iB,KAAL,CAAW2E,sBAAX,KAAsC,IAAlD,EAAwD,mCAAxD;mBACK3E,KAAL,CAAW2E,sBAAX,GAAoC,KAApC;;;iBAGIlY,cAAc,CAACG,WAAf,CAA2BG,UAAhC;;kBAGK,KAAKiT,KAAL,CAAWoH,eAAX,CAA2BhsB,MAA3B,GAAoC,CAAxC,EAA2C;oBAEtCisB,MAAM,GAAG,KAAKrH,KAAL,CAAW4F,kBAAX,EAAb,CAF0C;;oBAKtC,EAAEyB,MAAM,YAAYtW,IAApB,CAAJ,EAA+B;;;;sBAI1B+G,IAAI,GAAG,IAAIrQ,WAAJ,CAAgB4f,MAAM,CAACzqB,QAAP,EAAhB,CAAX;uBAEKojB,KAAL,CAAW6E,kBAAX,CAA8B/M,IAA9B;;;;;;iBAMErL,cAAc,CAACG,WAAf,CAA2BW,IAAhC;;;iBAGKd,cAAc,CAACG,WAAf,CAA2BK,SAAhC;mBACM+S,KAAL,CAAW4E,mBAAX,CAA+B,KAAK5E,KAAL,CAAWsH,mBAAX,EAA/B;;;iBAGI7a,cAAc,CAACG,WAAf,CAA2BM,iBAAhC;mBACM8S,KAAL,CAAW4F,kBAAX;;;iBAGInZ,cAAc,CAACG,WAAf,CAA2BO,WAAhC;iBACKV,cAAc,CAACG,WAAf,CAA2BQ,SAAhC;kBAEKma,OAAO,GAAGJ,WAAW,CAACxa,WAAZ,IAA2BF,cAAc,CAACG,WAAf,CAA2BO,WAAtD,GACbkB,WAAW,CAACY,QADC,GACUZ,WAAW,CAAC+L,MADpC;kBAGIoN,0BAA0B,GAA6B,IAA3D;;kBACID,OAAO,IAAIlZ,WAAW,CAAC+L,MAA3B,EAAmC;oBAC9BqN,MAAM,GAAG,KAAKzH,KAAL,CAAW4F,kBAAX,EAAb,CADkC;;gBAGlC4B,0BAA0B,GAAG/pB,QAAQ,CAACgqB,MAAD,EAAS5f,iBAAT,CAArC;;oBACI2f,0BAA0B,KAAK,IAAnC,EAAyC;uBACnCpqB,MAAL,CAAYqqB,MAAM,YAAY1W,IAA9B,EAAoC,+CAApC;;;;kBAIE,KAAKiP,KAAL,CAAW0H,iCAAX,EAAJ,EAAmD;;eAAnD,MAGK,IAAI,KAAK1H,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoCzqB,IAApC,IAA4CqqB,OAA5C,IAAuD,CAAC,KAAKvH,KAAL,CAAW6B,SAAX,CAAqBK,MAAjF,EAAyF;oBAEzF0F,KAAK,GAA6B,IAAIrhB,GAAJ,EAAtC;gBACAqhB,KAAK,CAACzjB,GAAN,CAAUkK,WAAW,CAACY,QAAtB,EAAgC,sCAAhC;gBACA2Y,KAAK,CAACzjB,GAAN,CAAUkK,WAAW,CAAC+L,MAAtB,EAA8B,iCAA9B;oBAEIyN,QAAQ,GAAGD,KAAK,CAAC/gB,GAAN,CAAU,KAAKmZ,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoCzqB,IAA9C,CAAf;;oBACI,CAAC,KAAK8iB,KAAL,CAAW6B,SAAX,CAAqBK,MAA1B,EAAkC;kBACjC2F,QAAQ,GAAG,gCAAX;;;oBAGGC,QAAQ,GAAG,WAAWF,KAAK,CAAC/gB,GAAN,CAAU0gB,OAAV,CAAX,GAAgC,kBAAhC,GAAqDM,QAApE;qBAEKhqB,KAAL,CAAWiqB,QAAX;eAbI,MAgBA;qBACC9H,KAAL,CAAW+H,YAAX;oBAEIP,0BAAJ,EACC,KAAKxH,KAAL,CAAW6G,eAAX,GAA6B,KAAKC,aAAL,CAAmBU,0BAA0B,CAAC9e,UAA9C,CAA7B;;;;;iBAIE+D,cAAc,CAACG,WAAf,CAA2BS,WAAhC;mBACM2S,KAAL,CAAW6E,kBAAX,CAA8BsC,WAA9B;mBAEK/pB,MAAL,CAAY,KAAK4iB,KAAL,CAAW2E,sBAAX,KAAsC,IAAlD,EAAwD,0DAAxD;mBACK3E,KAAL,CAAW2E,sBAAX,GAAoC,KAApC;;;iBAGIlY,cAAc,CAACG,WAAf,CAA2BU,SAAhC;kBAEK0a,qBAAqB,GAAgB,EAAzC;kBAEIC,mBAAmB,GAAG,CAA1B;;mBACK,IAAI9sB,CAAC,GAAG,KAAK6kB,KAAL,CAAWiH,YAAX,CAAwB7rB,MAAxB,GAAiC,CAA9C,EAAiDD,CAAC,IAAI,CAAtD,EAAyD,EAAEA,CAA3D,EAA8D;oBACzDuC,GAAG,GAAG,KAAKsiB,KAAL,CAAWiH,YAAX,CAAwB9rB,CAAxB,CAAV;gBAEA8sB,mBAAmB,GAH0C;;oBAMzDC,OAAO,GAAGzqB,QAAQ,CAACC,GAAD,EAAM+O,cAAN,CAAtB;;oBACIyb,OAAO,IAAIA,OAAO,CAACvb,WAAR,IAAuBF,cAAc,CAACG,WAAf,CAA2BS,WAAjE,EAA8E;;;;oBAI1E3P,GAAG,YAAY+J,WAAnB,EAAiC;kBAChCugB,qBAAqB,CAACrtB,IAAtB,CAA2B+C,GAA3B;;eAjBH;;;mBAsBMsiB,KAAL,CAAWmI,mBAAX,CAA+BF,mBAA/B,EAtBD;;;cA0BCD,qBAAqB,GAAGA,qBAAqB,CAACI,OAAtB,EAAxB,CA1BD;;kBA6BK3iB,EAAE,GAAG,IAAI3E,aAAJ,EAAT;;;;;;qCACcknB,qBAAd,8HAAqC;sBAA5BtsB,CAA4B;kBACpC+J,EAAE,CAACzE,MAAH,CAAUtF,CAAC,CAACkB,QAAF,EAAV;iBA/BF;;;;;;;;;;;;;;;;;mBAmCMojB,KAAL,CAAW2E,sBAAX,GAAoC,IAApC;mBACK3E,KAAL,CAAW4E,mBAAX,CAA+B,IAAInd,WAAJ,CAAgBhC,EAAE,CAAC7I,QAAH,EAAhB,CAA/B;;;iBAGI6P,cAAc,CAACG,WAAf,CAA2BY,WAAhC;kBACK6a,WAAW,GAAG,KAAKrI,KAAL,CAAW+B,gBAAX,CAA4B3mB,MAA9C;mBACK4kB,KAAL,CAAW4E,mBAAX,CAA+B,IAAIjd,QAAJ,CAAa0gB,WAAb,CAA/B;;;iBAGI5b,cAAc,CAACG,WAAf,CAA2BX,KAAhC;mBACM+T,KAAL,CAAW4E,mBAAX,CAAgC,IAAIjd,QAAJ,CAAc,KAAKqY,KAAL,CAAWsI,gBAAX,GAA4B,CAA1C,CAAhC;;;iBAGI7b,cAAc,CAACG,WAAf,CAA2Ba,UAAhC;iBACKhB,cAAc,CAACG,WAAf,CAA2Bc,SAAhC;kBACK6M,OAAM,GAAG,KAAKyF,KAAL,CAAW4F,kBAAX,EAAb;;kBACI,EAAErL,OAAM,YAAY1S,iBAApB,CAAJ,EAA6C;oBACxC0gB,SAAS,GAAG,EAAhB;oBACIhO,OAAM,YAAY5S,QAAtB,EACC4gB,SAAS,GAAG,8FAAZ;qBACI1qB,KAAL,CAAW,2FAAyF0c,OAAzF,GAAgGgO,SAA3G;;eANF;;;kBAWKC,YAAY,GAAG5qB,UAAU,CAAC2c,OAAD,EAAS1S,iBAAT,CAA7B,CAXD;;kBAaKrH,SAAS,GAAG/C,QAAQ,CAAC,KAAKe,aAAL,CAAmBgqB,YAAY,CAAC9f,UAAhC,EAA4C+f,UAA7C,EAAyD5pB,SAAzD,CAAxB;kBAEI6pB,WAAJ;;kBACIloB,SAAS,IAAI,IAAjB,EAAuB;oBAClB2mB,WAAW,CAACxa,WAAZ,IAA2BF,cAAc,CAACG,WAAf,CAA2Ba,UAA1D,EACCib,WAAW,GAAG,KAAKC,sBAAL,CAA4BnoB,SAA5B,CAAd,CADD,KAGCkoB,WAAW,GAAG,KAAKvC,sBAAL,CAA4B3lB,SAA5B,CAAd;eAJF,MAKO;oBACF2mB,WAAW,CAACxa,WAAZ,IAA2BF,cAAc,CAACG,WAAf,CAA2Ba,UAA1D,EACCib,WAAW,GAAG,CAAC,CAAf,CADD,KAGCA,WAAW,GAAG,CAAd;qBAEI5E,OAAL,CAAa,kCAAkCqD,WAAW,CAACvqB,QAAZ,EAAlC,GAA2D,aAA3D,GAA2E4rB,YAAY,CAAC9f,UAAb,CAAwB9L,QAAxB,EAAxF;;;mBAGIojB,KAAL,CAAW4E,mBAAX,CAA+B,IAAIjd,QAAJ,CAAa+gB,WAAb,CAA/B;;;iBAGIjc,cAAc,CAACG,WAAf,CAA2Be,MAAhC;;oBACKib,MAAM,GAAGnrB,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAArB;oBACIkhB,MAAM,GAAGprB,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAArB;oBAEIkhB,MAAM,IAAI,IAAV,IAAkBA,MAAM,YAAYlhB,QAAlB,KAA+B,KAArD,EACC,OAAO,KAAK9J,KAAL,CAAW,yDAAX,CAAP;oBAEG+qB,MAAM,IAAI,IAAV,IAAkBC,MAAM,YAAYlhB,QAAlB,KAA+B,KAArD,EACC,OAAO,KAAK9J,KAAL,CAAW,yDAAX,CAAP,CARsC;;;oBAYnC+qB,MAAM,CAAC1sB,KAAP,KAAiB,IAArB,EAA2B;yBAASiC,kBAAkB,CAAC,cAAD,CAAzB;;;oBACzB0qB,MAAM,CAAC3sB,KAAP,KAAiB,IAArB,EAA2B;yBAASiC,kBAAkB,CAAC,cAAD,CAAzB;;;oBAEzB2qB,WAAW,GAAGF,MAAM,CAAC1sB,KAAP,GAAe2sB,MAAM,CAAC3sB,KAAtB,GAA8B,CAAhD;oBACI4sB,WAAW,IAAI,CAAnB,EACC,KAAKjrB,KAAL,CAAW,uCAAuCgrB,MAAM,CAAC3sB,KAA9C,GAAsD,kBAAtD,GAA2E0sB,MAAM,CAAC1sB,KAAlF,GAA0F,8BAArG;oBAEG6sB,UAAU,GAAG,KAAK/I,KAAL,CAAWgJ,SAAX,GAAuB,KAAKhJ,KAAL,CAAWiJ,cAAnD;oBACIC,MAAM,GAAG,IAAIvL,IAAJ,CAASoL,UAAT,CAAb;oBAEII,UAAU,GAAGD,MAAM,CAACrL,IAAP,EAAjB;oBACIuL,WAAW,GAAID,UAAU,GAAGL,WAAd,GAA6BD,MAAM,CAAC3sB,KAAtD;qBACK8jB,KAAL,CAAW4E,mBAAX,CAA+B,IAAIjd,QAAJ,CAAayhB,WAAb,CAA/B,EAxBuC;;qBA2BlCpJ,KAAL,CAAWiJ,cAAX,GAA4BE,UAA5B;;;;iBAII1c,cAAc,CAACG,WAAf,CAA2BgB,UAAhC;kBACKgQ,IAAI,GAAGngB,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAAnB;kBACIiW,IAAI,IAAI,IAAR,IAAgBA,IAAI,YAAYjW,QAAhB,KAA6B,KAAjD,EACC,OAAO,KAAK9J,KAAL,CAAW,qCAAX,CAAP,CAHF;;;kBAOK+f,IAAI,CAAC1hB,KAAL,KAAe,IAAnB,EAAyB;uBAASiC,kBAAkB,CAAC,cAAD,CAAzB;;;mBAEtB6hB,KAAL,CAAWgJ,SAAX,GAAuBpL,IAAI,CAAC1hB,KAA5B;mBACK8jB,KAAL,CAAWiJ,cAAX,GAA4B,CAA5B;mBAEKjJ,KAAL,CAAW4E,mBAAX,CAA+B,IAAI7T,IAAJ,EAA/B;;;iBAGItE,cAAc,CAACG,WAAf,CAA2BiB,UAAhC;kBACKmL,KAAK,GAAG,KAAKmN,sBAAL,CAA4B,KAAKnG,KAAL,CAAWC,cAAX,CAA0Bzf,SAAtD,IAAmE,CAA/E,CADD;;mBAEMwf,KAAL,CAAW4E,mBAAX,CAA+B,IAAIjd,QAAJ,CAAaqR,KAAb,CAA/B;;;iBAGIvM,cAAc,CAACG,WAAf,CAA2BkB,oBAAhC;kBACKub,YAAY,GAAG,KAAKC,wBAAL,EAAnB;mBACKtJ,KAAL,CAAW4E,mBAAX,CAA+B,IAAIjd,QAAJ,CAAa0hB,YAAb,CAA/B;;;iBAGI5c,cAAc,CAACG,WAAf,CAA2BmB,WAAhC;;;;iBAIKtB,cAAc,CAACG,WAAf,CAA2BoB,IAAhC;;;;kBAIK,KAAKgS,KAAL,CAAW6B,SAAX,CAAqBC,YAAzB,EAAuC;qBACjC9B,KAAL,CAAW6B,SAAX,CAAqB0H,SAArB;eADD;mBAKK;uBACCvJ,KAAL,CAAWgB,WAAX,GAAyB,IAAzB,CADI;;uBAIChB,KAAL,CAAWC,cAAX,GAA4B3R,OAAO,CAACrM,IAApC;;;;;;iBAMGwK,cAAc,CAACG,WAAf,CAA2BqB,GAAhC;mBACM+R,KAAL,CAAWF,QAAX;;;iBAGIrT,cAAc,CAACG,WAAf,CAA2BsB,WAAhC;;kBAEKzK,MAAM,GAAGhG,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAArB,CAFD;;kBAIK6hB,WAAW,GAAG5rB,UAAU,CAAC,KAAKoiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCne,WAAlC,CAA5B;;kBAEIhE,MAAM,KAAK,IAAf,EAAqB;sBACd,IAAI+C,cAAJ,CAAmB,yEAAnB,CAAN;;;kBAGGijB,kBAAkB,GAAG,IAAzB;;kBAEI,KAAK5mB,eAAL,KAAyB,IAA7B,EAAmC;uBAAS1E,kBAAkB,CAAC,sBAAD,CAAzB;;;kBACjCwF,YAAY,GAAG,KAAKd,eAAL,CAAqBC,oBAArB,CAA0C0mB,WAAW,CAACttB,KAAtD,EAA6D,IAA7D,CAAnB;;kBACIyH,YAAY,CAACZ,MAAjB,EAAyB;;;oBAGpBU,MAAM,CAACvH,KAAP,KAAiB,IAArB,EAA2B;yBAASiC,kBAAkB,CAAC,cAAD,CAAzB;;;oBAEzBurB,SAAS,GAAG/lB,YAAY,CAACV,MAAb,CAAqBsQ,mBAArB,CAAyC9P,MAAM,CAACvH,KAAhD,EAAuDoF,WAAW,CAACW,IAAnE,CAAhB;;oBACIynB,SAAS,CAAC3mB,MAAd,EAAsB;kBACrB0mB,kBAAkB,GAAG,IAAI3hB,SAAJ,CAAc4hB,SAAS,CAACzmB,MAAxB,EAAiCQ,MAAM,CAACvH,KAAxC,CAArB;;eAPF,MASO;sBACA,IAAIsK,cAAJ,CAAmB,gCAAgCgjB,WAAW,CAACttB,KAA/D,CAAN;;;kBAGGutB,kBAAkB,IAAI,IAA1B,EACCA,kBAAkB,GAAG,IAAI3hB,SAAJ,EAArB;mBAEIkY,KAAL,CAAW4E,mBAAX,CAA+B6E,kBAA/B;;;iBAGIhd,cAAc,CAACG,WAAf,CAA2BuB,SAAhC;kBACKrI,GAAG,GAAGrI,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCviB,KAAlC,CAAlB;kBACIhE,GAAG,GAAG5B,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCviB,KAAlC,CAAlB,CAFD;;kBAKKsmB,UAAU,GAAGlsB,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkC9d,SAAlC,CAAzB;kBAEI6hB,UAAU,KAAK,IAAf,IAAuBtqB,GAAG,KAAK,IAA/B,IAAuCyG,GAAG,KAAK,IAAnD,EACC,MAAM,IAAIU,cAAJ,CAAmB,mDAAnB,CAAN;;kBAEGmjB,UAAU,CAACztB,KAAX,KAAqB,IAAzB,EAA+B;uBAASiC,kBAAkB,CAAC,kBAAD,CAAzB;;;kBAC7B8E,MAAM,GAAG0mB,UAAU,CAACztB,KAAX,CAAiB0tB,gBAAjB,CAAkCvqB,GAAG,CAACiI,WAAtC,EAAmDxB,GAAG,CAACwB,WAAvD,CAAb;mBAEK0Y,KAAL,CAAW4E,mBAAX,CAAgC,IAAI9c,SAAJ,CAAc7E,MAAd,CAAhC;;;iBAGIwJ,cAAc,CAACG,WAAf,CAA2BwB,UAAhC;;oBACK0E,OAAO,GAAG,KAAKkN,KAAL,CAAW4F,kBAAX,EAAd;oBACI9S,OAAO,KAAK,IAAhB,EACC,MAAM,IAAItM,cAAJ,CAAmB,+BAAnB,CAAN;oBAEGR,IAAI,GAAG8M,OAAO,CAAC5W,KAAnB;oBAEIqN,OAAO,GAAmB,IAA9B;;oBAEIvD,IAAI,KAAK,IAAb,EAAmB;wBAAQ7H,kBAAkB,CAAC,MAAD,CAAxB;;;oBACjB6H,IAAI,CAACvB,KAAL,IAAc,CAAlB,EAAqB;kBACpB8E,OAAO,GAAG,IAAIlH,OAAJ,EAAV;iBADD,MAEO;;sBAEF0mB,WAAU,GAAG,KAAK/I,KAAL,CAAWgJ,SAAX,GAAuB,KAAKhJ,KAAL,CAAWiJ,cAAnD;;sBACIC,OAAM,GAAG,IAAIvL,IAAJ,CAASoL,WAAT,CAAb;;sBAEII,WAAU,GAAGD,OAAM,CAACrL,IAAP,EAAjB;;sBACIgM,aAAa,GAAGV,WAAU,GAAGnjB,IAAI,CAACvB,KAAtC,CANM;;;;;;sBAaFqlB,cAAc,GAAG9jB,IAAI,CAAC+jB,OAAL,EAArB;;uBACK,IAAI5uB,EAAC,GAAG,CAAb,EAAgBA,EAAC,IAAI0uB,aAAa,GAAG,CAArC,EAAwC1uB,EAAC,EAAzC,EAA6C;oBAC5C2uB,cAAc,CAACjM,IAAf;;;sBAEG3hB,KAAK,GAAG4tB,cAAc,CAACjM,IAAf,GAAsB3hB,KAAlC;sBACI8tB,UAAU,GAAsC;oBACnD5mB,GAAG,EAAE9B,WAAW,CAACyC,iBAAZ,CAA8B7H,KAAK,CAAC,CAAD,CAAnC,CAD8C;oBAEnDmH,KAAK,EAAEnH,KAAK,CAAC,CAAD;mBAFb,CAlBM;;sBAwBF8tB,UAAU,CAAC5mB,GAAX,CAAe7B,UAAf,KAA8B,IAAlC,EAAwC;2BAASpD,kBAAkB,CAAC,2BAAD,CAAzB;;;kBAC1CoL,OAAO,GAAG,IAAIlH,OAAJ,CAAY2nB,UAAU,CAAC5mB,GAAX,CAAe7B,UAA3B,EAAuC,IAAvC,CAAV;kBACAgI,OAAO,CAACpG,GAAR,CAAY6mB,UAAU,CAAC5mB,GAAvB,EAA4B4mB,UAAU,CAAC3mB,KAAvC;uBAEK2c,KAAL,CAAWiJ,cAAX,GAA4BE,WAA5B;;;qBAGInJ,KAAL,CAAW4E,mBAAX,CAA+B,IAAI9c,SAAJ,CAAcyB,OAAd,CAA/B;;;;;mBAKK1L,KAAL,CAAW,+BAA+BspB,WAA1C;;;;iBAIM,IAAP;SA1WI;aA8WA,IAAIrd,UAAU,YAAY8G,kBAA1B,EAA+C;gBAC/CoK,MAAM,GAAGlR,UAAb;gBACImgB,WAAW,GAAG,KAAKjK,KAAL,CAAW4F,kBAAX,EAAlB;iBAEK5F,KAAL,CAAWR,cAAX,CAA0B0K,MAA1B,CAAiClP,MAAjC,EAAyCiP,WAAzC;mBAEO,IAAP;WANI;eAUA,IAAIngB,UAAU,YAAY0G,iBAA1B,EAA8C;kBAC9C2L,MAAM,GAAGrS,UAAb;kBACIqgB,UAAU,GAAG,IAAjB,CAFkD;;kBAK9ChO,MAAM,CAACxL,YAAP,IAAuB,IAA3B,EAAiC;oBAE5BnQ,UAAS,GAAG2b,MAAM,CAACiO,iBAAvB;;oBACIpR,MAAK,GAAG,KAAKmN,sBAAL,CAA4B3lB,UAA5B,CAAZ;;gBACA2pB,UAAU,GAAG,IAAIxiB,QAAJ,CAAaqR,MAAb,CAAb;eAJD;mBAQK;kBAEJmR,UAAU,GAAG,KAAKnK,KAAL,CAAWR,cAAX,CAA0BkH,mBAA1B,CAA8CvK,MAAM,CAACxf,IAArD,CAAb;;sBAEIwtB,UAAU,IAAI,IAAlB,EAAwB;wBACnBE,UAAU,GAAG,KAAKrK,KAAL,CAAWR,cAAX,CAA0B8K,0BAA1B,CAAsDnO,MAAM,CAACxf,IAA7D,CAAjB;;wBACI0tB,UAAU,IAAI,IAAlB,EAAwB;2BAClBvG,OAAL,CAAa,wCAAwC3H,MAAM,CAACxf,IAA/C,GAAsD,0FAAtD,GAAmJ0tB,UAAhK;sBACAF,UAAU,GAAGE,UAAb,CAFuB;;;2BAMlBrK,KAAL,CAAWR,cAAX,CAA0B+K,SAA1B,CAAoCpO,MAAM,CAACxf,IAA3C,EAAiDwtB,UAAjD;qBAND,MAOO;2BACDrG,OAAL,CAAc,0BAA0B3H,MAAM,CAACxf,IAAjC,GAAwC,uHAAtD;sBACAwtB,UAAU,GAAG,IAAIxiB,QAAJ,CAAa,CAAb,CAAb;;;;;mBAKEqY,KAAL,CAAW4E,mBAAX,CAA+BuF,UAA/B;qBAEO,IAAP;aAnCI;iBAuCA,IAAIrgB,UAAU,YAAYkH,kBAA1B,EAA8C;oBAC9CwZ,IAAI,GAAG1gB,UAAX;oBACI2gB,UAAU,GAAG,KAAKzK,KAAL,CAAW4F,kBAAX,CAA8B4E,IAAI,CAACtZ,kBAAnC,CAAjB;;oBACIjO,OAAM,GAAGunB,IAAI,CAAClZ,IAAL,CAAUmZ,UAAV,CAAb;;qBACKzK,KAAL,CAAW4E,mBAAX,CAA+B3hB,OAA/B;uBACO,IAAP;;;;aAIM,KAAP;;;;qCAGuBxG,IA9nCzB;UA8nCuCiuB,qFAAiB;UAAMxpB,2EAAc;WACrEme,aAAL,CAAoB,iCAApB;;UAEIqL,cAAJ,EAAoB;aACdC,cAAL;OADD,MAEO;YACF,KAAK3K,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoCzqB,IAApC,IAA4CmR,WAAW,CAACY,QAA5D,EAAsE;cACjE2b,UAAU,GAAG,EAAjB;cACIpqB,SAAS,GAAG,KAAKwf,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoC1H,cAApC,CAAmDzf,SAAnE;;cACIA,SAAS,IAAI,IAAjB,EAAuB;YACtBoqB,UAAU,GAAG,MAAIpqB,SAAS,CAAC/D,IAAV,CAAeG,QAAf,EAAJ,GAA+B,IAA5C;;;gBAEK,IAAIiB,KAAJ,CAAU,kCAAgC+sB,UAAhC,GAA2C,mCAA3C,GAA+EnuB,IAA/E,GAAoF,0EAApF,GAA+J,KAAKujB,KAAL,CAAW6B,SAAX,CAAqBgJ,cAA9L,CAAN;;;;WAIG7K,KAAL,CAAW8K,8BAAX,CAA0C5pB,IAA1C;WACKgf,UAAL,CAAgB,IAAIhmB,IAAJ,CAASuC,IAAT,CAAhB;;;;kCAGoBsuB,WAlpCtB;UAopCM,KAAKjK,oBAAT,EACC,MAAM,IAAIjjB,KAAJ,CAAU,WAAWktB,WAAX,GAAyB,wHAAnC,CAAN;;;;+BAGgB9vB,CAxpCnB;UAwpC4B+vB,4FAAiC;WACtDhL,KAAL,CAAWiL,aAAX,CAAyBhwB,CAAzB,EAA4B+vB,qBAA5B;;WAGKE,iCAAL;;;;sCAGwBC,SA/pC1B;MAgqCEA,SAAS,GAAGA,SAAZ;UACIC,OAAO,GAAG,KAAKC,cAAnB;WACKjuB,MAAL,CAAY+tB,SAAS,IAAI,CAAb,IAAkBA,SAAS,GAAGC,OAAO,CAAChwB,MAAlD,EAA0D,qBAA1D;UAEIkwB,cAAc,GAAGF,OAAO,CAACD,SAAD,CAA5B;;UACIG,cAAc,CAAClF,kBAAf,KAAsC,IAA1C,EAAgD;eAASjoB,kBAAkB,CAAC,mCAAD,CAAzB;;;UAC9CmtB,cAAc,CAAC5iB,UAAf,KAA8B,IAAlC,EAAwC;eAASvK,kBAAkB,CAAC,2BAAD,CAAzB;;;WAErC6hB,KAAL,CAAW6B,SAAX,CAAqB0J,aAArB,GAAqCD,cAAc,CAAClF,kBAApD;WAEKlG,UAAL,CAAgBoL,cAAc,CAAC5iB,UAA/B;;;;gCAGkBwL,YA7qCpB;UA8qCM;eACI,KAAKsX,qBAAL,CAA2BtX,YAA3B,KAA4C,IAAnD;OADD,CAEE,OAAMqN,CAAN,EAAS;eACH,KAAP;;;;;qCAIsBrN,YArrCzB;UAqrC+ChT,2EAAc;UAAIuqB,uFAA4B;;;;;;;WAQtFpM,aAAL,CAAmB,qBAAnB;;UAEInL,YAAY,IAAI,IAApB,EAA0B;cACnB,IAAIrW,KAAJ,CAAU,kBAAV,CAAN;OADD,MAGK,IAAIqW,YAAY,IAAI,EAAhB,IAAsBA,YAAY,CAACwX,IAAb,MAAuB,EAAjD,EAAqD;cACnD,IAAI7tB,KAAJ,CAAU,mCAAV,CAAN;;;UAGG8tB,aAAa,GAAG,KAAKH,qBAAL,CAA2BtX,YAA3B,CAApB;;UACIyX,aAAa,IAAI,IAArB,EAA2B;cACpB,IAAI9tB,KAAJ,CAAU,8BAA8BqW,YAA9B,GAA6C,GAAvD,CAAN;;;UAGG0X,kBAAkB,GAAgB,EAAtC;MACAA,kBAAkB,CAACjxB,IAAnB,CAAwBgB,KAAxB,CAA8BiwB,kBAA9B,EAAkD,KAAK5L,KAAL,CAAWiH,YAA7D;;WACK3H,MAAL,CAAY2B,WAAZ;;WAEKjB,KAAL,CAAW6L,+BAAX,CAA2CF,aAA3C,EAA0DzqB,IAA1D;;UAGI4qB,YAAY,GAAG,IAAIhrB,aAAJ,EAAnB;;aACO,KAAKigB,WAAZ,EAAyB;QACxB+K,YAAY,CAAC9qB,MAAb,CAAoB,KAAK0iB,QAAL,EAApB;;;UAEGqI,UAAU,GAAGD,YAAY,CAAClvB,QAAb,EAAjB;;WAEK0iB,MAAL,CAAY2B,WAAZ,CAAwB2K,kBAAxB;;UAEI3oB,MAAM,GAAG,KAAK+c,KAAL,CAAWgM,kCAAX,EAAb;aAEQP,gBAAD,GAAqB;QAACQ,QAAQ,EAAEhpB,MAAX;QAAmBokB,MAAM,EAAE0E;OAAhD,GAA8D9oB,MAArE;;;;uCAGyBipB,aA/tC3B;UAguCMC,oBAAoB,GAAG,KAAKnM,KAAL,CAAW6B,SAAX,CAAqBuK,QAArB,CAA8BhxB,MAAzD;WAEK4kB,KAAL,CAAW6B,SAAX,CAAqBmF,IAArB,CAA0B3Y,WAAW,CAAC+L,MAAtC;WAEK4H,6BAAL,GAAqCkK,aAArC;WAEKlM,KAAL,CAAWqM,SAAX;UAEIC,eAAe,GAAG,KAAKtM,KAAL,CAAWoH,eAAX,CAA2BhsB,MAAjD;WAEKsoB,QAAL;WAEK1B,6BAAL,GAAqC,IAArC;;;;UAKI,KAAKhC,KAAL,CAAW6B,SAAX,CAAqBuK,QAArB,CAA8BhxB,MAA9B,GAAuC+wB,oBAA3C,EAAiE;aAC3DnM,KAAL,CAAW+H,YAAX;;;UAGGwE,cAAc,GAAG,KAAKvM,KAAL,CAAWoH,eAAX,CAA2BhsB,MAAhD;;UACImxB,cAAc,GAAGD,eAArB,EAAsC;eAC9B,KAAKtM,KAAL,CAAW4F,kBAAX,EAAP;OADD,MAEO;eACC,IAAP;;;;;yCAM0B4G,QA/vC7B,EA+vCsDC,iBA/vCtD;UAgwCMD,QAAQ,KAAK,IAAjB,EAAuB;eAASruB,kBAAkB,CAAC,UAAD,CAAzB;;;UACrBqsB,IAAI,GAAG,KAAK/L,UAAL,CAAgB5X,GAAhB,CAAoB2lB,QAApB,CAAX;;UACIE,yBAAyB,GAAG,IAAhC;UAEIC,aAAa,GAAG,OAAOnC,IAAP,KAAgB,WAApC;;UAGI,CAACmC,aAAL,EAAoB;YACf,KAAKC,8BAAT,EAAyC;UACxCF,yBAAyB,GAAG,KAAKlB,qBAAL,CAA2BgB,QAA3B,CAA5B;eACKpvB,MAAL,CAAYsvB,yBAAyB,KAAK,IAA1C,EAAgD,uCAAuCF,QAAvC,GAAkD,2EAAlG,EAFwC;;eAKnCxM,KAAL,CAAW6B,SAAX,CAAqBmF,IAArB,CACC3Y,WAAW,CAACY,QADb,EAEC3M,SAFD,EAGC,KAAK0d,KAAL,CAAWiH,YAAX,CAAwB7rB,MAHzB;eAKK4kB,KAAL,CAAW6G,eAAX,GAA6BvY,OAAO,CAACoB,OAAR,CAAgBgd,yBAAhB,CAA7B;;SAVD,MAaO;eACDtvB,MAAL,CAAY,KAAZ,EAAmB,uCAAuCovB,QAAvC,GAAkD,0DAArE;;;;;UAKEtrB,IAAI,GAAU,EAAlB;;WACK,IAAI/F,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGsxB,iBAApB,EAAuC,EAAEtxB,CAAzC,EAA4C;;YAEvC0xB,SAAS,GAAGjvB,UAAU,CAAC,KAAKoiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCviB,KAAlC,CAA1B;YACIypB,QAAQ,GAAGD,SAAS,CAACvlB,WAAzB;QACApG,IAAI,CAACvG,IAAL,CAAUmyB,QAAV;;;;;MAKD5rB,IAAI,CAACknB,OAAL;;UAGI2E,UAAU,GAAGvC,IAAK,CAACtpB,IAAD,CAAtB;;UAGI8rB,SAAS,GAAG,IAAhB;;UACID,UAAU,IAAI,IAAlB,EAAwB;QACvBC,SAAS,GAAG3pB,KAAK,CAAC+D,MAAN,CAAa2lB,UAAb,CAAZ;aACK3vB,MAAL,CAAY4vB,SAAS,KAAK,IAA1B,EAAgC,qEAAqED,UAArE,CAAhC;OAFD,MAGO;QACNC,SAAS,GAAG,IAAIjc,IAAJ,EAAZ;;;WAGIiP,KAAL,CAAW4E,mBAAX,CAA+BoI,SAA/B;;;;gDAGkCR,QAtzCpC,EAszCsDhC,IAtzCtD;WAuzCOnL,aAAL,CAAmB,2BAAnB;WACKjiB,MAAL,CAAY,CAAC,KAAKqhB,UAAL,CAAgBza,GAAhB,CAAoBwoB,QAApB,CAAb,EAA4C,eAAeA,QAAf,GAA0B,2BAAtE;;WACK/N,UAAL,CAAgBta,GAAhB,CAAoBqoB,QAApB,EAA8BhC,IAA9B;;;;8BAGgBtuB,KA5zClB;;;;;aAi0CSA,KAAP;;;;yCAG2BswB,QAp0C7B,EAo0C+ChC,IAp0C/C;;;WAq0COptB,MAAL,CAAYotB,IAAI,IAAI,IAApB,EAA0B,4BAA1B;WAEKyC,2BAAL,CAAiCT,QAAjC,EAA2C,UAACtrB,IAAD;QAC1C,MAAI,CAAC9D,MAAL,CAAY8D,IAAI,CAAC9F,MAAL,IAAeovB,IAAI,CAACpvB,MAAhC,EAAwC,gCAAgCovB,IAAI,CAACpvB,MAArC,GAA8C,YAAtF;;YAEI8xB,WAAW,GAAG,EAAlB;;aACK,IAAI/xB,CAAC,GAAG,CAAR,EAAWK,CAAC,GAAG0F,IAAI,CAAC9F,MAAzB,EAAiCD,CAAC,GAAGK,CAArC,EAAwCL,CAAC,EAAzC,EAA4C;UAC3C+xB,WAAW,CAAC/xB,CAAD,CAAX,GAAiB,MAAI,CAACgyB,SAAL,CAAejsB,IAAI,CAAC/F,CAAD,CAAnB,CAAjB;;;eAEMqvB,IAAI,CAAC7uB,KAAL,CAAW,IAAX,EAAiBuxB,WAAjB,CAAP;OAPD;;;;2CAW6BV,QAl1C/B;WAm1COnN,aAAL,CAAmB,+BAAnB;WACKjiB,MAAL,CAAY,KAAKqhB,UAAL,CAAgBza,GAAhB,CAAoBwoB,QAApB,CAAZ,EAA2C,eAAeA,QAAf,GAA0B,uBAArE;;WACK/N,UAAL,WAAuB+N,QAAvB;;;;;UAQI9wB,CAAC,GAAqB,IAA1B;UACI0xB,CAAC,GAAqB,IAA1B;UACIC,gBAAgB,GAAgB/yB,SAAS,CAAC,CAAD,CAAT,IAAgB,IAAIgzB,GAAJ,EAApD;;UAEIhzB,SAAS,CAAC,CAAD,CAAT,YAAwBuE,SAA5B,EAAuC;QACtCnD,CAAC,GAAGpB,SAAS,CAAC,CAAD,CAAb;;;UAGGA,SAAS,CAAC,CAAD,CAAT,YAAwB8D,SAA5B,EAAuC;QACtCgvB,CAAC,GAAG9yB,SAAS,CAAC,CAAD,CAAb;;;UAGGoB,CAAC,KAAK,IAAN,IAAc0xB,CAAC,KAAK,IAAxB,EAA8B;aACxB3M,wBAAL,CAA8B,KAAKnC,qBAAnC,EAA0D+O,gBAA1D;aACK7M,sBAAL,GAA8B,IAA9B,CAF6B;;YAKzB6M,gBAAgB,CAAC1nB,IAAjB,IAAyB,CAA7B,EAAiC;eAC3B6a,sBAAL,GAA8B,IAA9B;SADD,MAEO;cACFrjB,OAAO,GAAG,8CAAd;UACAA,OAAO,IAAKkwB,gBAAgB,CAAC1nB,IAAjB,GAAwB,CAAzB,GAA8B,GAA9B,GAAoC,EAA/C;UACAxI,OAAO,IAAI,KAAX;UACAA,OAAO,IAAItC,KAAK,CAAC0yB,IAAN,CAAWF,gBAAX,EAA6BpxB,IAA7B,CAAkC,MAAlC,CAAX;UACAkB,OAAO,IAAI,IAAX;UACAA,OAAO,IAAK,KAAKyvB,8BAAN,GAAwC,uCAAxC,GAAkF,2BAA7F;eAEK/uB,KAAL,CAAWV,OAAX;;OAfF,MAiBO,IAAIzB,CAAC,IAAI,IAAT,EAAe;;;;;;gCACIA,CAAC,CAACiF,OAA3B,mIAAoC;gBAA3B6sB,YAA2B;gBAC/BhtB,SAAS,GAAGgtB,YAAhB;gBACIhtB,SAAS,IAAI,IAAb,IAAqB,CAACA,SAAS,CAACxC,YAApC,EACC,KAAKyiB,wBAAL,CAA+B+M,YAA/B,EAA6CH,gBAA7C;;;;;;;;;;;;;;;;;;;;;;gCAEuB3xB,CAAC,CAAC0O,YAA3B,mIAAyC;;gBAA/BtI,GAA+B;gBAA1B5F,KAA0B;;iBACnCukB,wBAAL,CAA+BhjB,QAAQ,CAACvB,KAAD,EAAQkC,SAAR,CAAvC,EAA2DivB,gBAA3D;;;;;;;;;;;;;;;;OAPK,MASA,IAAID,CAAC,IAAI,IAAT,EAAe;YACjB/S,MAAM,GAAG5c,QAAQ,CAAC2vB,CAAD,EAAI5e,MAAJ,CAArB;;YACI6L,MAAM,IAAIA,MAAM,CAACC,UAArB,EAAiC;cAC5B3d,IAAI,GAAG0d,MAAM,CAACnL,gBAAlB;;cACIvS,IAAI,KAAK,IAAb,EAAmB;mBAASwB,kBAAkB,CAAC,MAAD,CAAzB;;;cACjB,CAAC,KAAKsgB,UAAL,CAAgBza,GAAhB,CAAoBrH,IAApB,CAAL,EAAgC;gBAC3B,KAAKiwB,8BAAT,EAAyC;kBACpCa,aAAa,GAAG,KAAK9J,oBAAL,CAA0BvZ,YAA1B,CAAuCpG,GAAvC,CAA2CrH,IAA3C,CAApB;;kBACI,CAAC8wB,aAAL,EAAoB;gBACnBJ,gBAAgB,CAACK,GAAjB,CAAqB/wB,IAArB;;aAHF,MAKO;cACN0wB,gBAAgB,CAACK,GAAjB,CAAqB/wB,IAArB;;;;;;;;oCAOkBkM,YAt5CxB,EAs5C8C8kB,QAt5C9C;WAu5COtO,aAAL,CAAmB,wBAAnB;UAEI,KAAKuO,kBAAL,KAA4B,IAAhC,EACC,KAAKA,kBAAL,GAA0B,IAAIrnB,GAAJ,EAA1B;UAEE,CAAC,KAAKyZ,KAAL,CAAWR,cAAX,CAA0BqO,4BAA1B,CAAuDhlB,YAAvD,CAAJ,EACC,MAAM,IAAIrC,cAAJ,CAAmB,8BAA4BqC,YAA5B,GAAyC,gDAA5D,CAAN;;UAEG,KAAK+kB,kBAAL,CAAwB5pB,GAAxB,CAA4B6E,YAA5B,CAAJ,EAA+C;aACzC+kB,kBAAL,CAAwB/mB,GAAxB,CAA4BgC,YAA5B,EAA2ClO,IAA3C,CAAgDgzB,QAAhD;OADD,MAEO;aACDC,kBAAL,CAAwBzpB,GAAxB,CAA4B0E,YAA5B,EAA0C,CAAC8kB,QAAD,CAA1C;;;;;qCAIsBG,aAt6CzB,EAs6CkDC,SAt6ClD;WAu6CO,IAAI5yB,CAAC,GAAG,CAAR,EAAWK,CAAC,GAAGsyB,aAAa,CAAC1yB,MAAlC,EAA0CD,CAAC,GAAGK,CAA9C,EAAiDL,CAAC,EAAlD,EAAqD;aAC/C6yB,eAAL,CAAqBF,aAAa,CAAC3yB,CAAD,CAAlC,EAAuC4yB,SAAS,CAAC5yB,CAAD,CAAhD;;;;;2CAI4BwyB,QA56C/B,EA46CiEM,oBA56CjE;WA66CO5O,aAAL,CAAmB,4BAAnB;UAEI,KAAKuO,kBAAL,KAA4B,IAAhC,EACC;;UAEG,OAAOK,oBAAP,KAAgC,WAApC,EAAiD;YAC5C,KAAKL,kBAAL,CAAwB5pB,GAAxB,CAA4BiqB,oBAA5B,CAAJ,EAAuD;cAClDF,SAAS,GAAG,KAAKH,kBAAL,CAAwB/mB,GAAxB,CAA4BonB,oBAA5B,CAAhB;;UACAF,SAAS,CAACG,MAAV,CAAiBH,SAAS,CAACntB,OAAV,CAAkB+sB,QAAlB,CAAjB,EAA8C,CAA9C;;OAHF,MAKO;YACF5Q,IAAI,GAAG,KAAK6Q,kBAAL,CAAwB7Q,IAAxB,EAAX;;;;;;;gCAEoBA,IAApB,mIAAyB;gBAAhBjC,OAAgB;;gBACpBiT,UAAS,GAAG,KAAKH,kBAAL,CAAwB/mB,GAAxB,CAA4BiU,OAA5B,CAAhB;;YACAiT,UAAS,CAACG,MAAV,CAAiBH,UAAS,CAACntB,OAAV,CAAkB+sB,QAAlB,CAAjB,EAA8C,CAA9C;;;;;;;;;;;;;;;;;;;;gDAKgC9kB,YAj8CpC,EAi8C0DslB,WAj8C1D;UAk8CM,KAAKP,kBAAL,KAA4B,IAAhC,EACC;;UAEGG,SAAS,GAAG,KAAKH,kBAAL,CAAwB/mB,GAAxB,CAA4BgC,YAA5B,CAAhB;;UACI,OAAOklB,SAAP,KAAqB,WAAzB,EAAsC;YACjC,EAAEI,WAAW,YAAY9qB,KAAzB,CAAJ,EAAqC;gBAC9B,IAAIxF,KAAJ,CAAU,iEAAV,CAAN;SAFoC;;;YAKjC+I,GAAG,GAAGhJ,UAAU,CAACuwB,WAAD,EAAc9qB,KAAd,CAApB;;;;;;gCAEqB0qB,SAArB,mIAAgC;gBAAvBJ,QAAuB;YAC/BA,QAAQ,CAAC9kB,YAAD,EAAejC,GAAG,CAACU,WAAnB,CAAR;;;;;;;;;;;;;;;;;;;;yCASyB7K,IAv9C7B;aAw9CS,KAAK2xB,wCAAL,CAA8C3xB,IAA9C,CAAP;;;;6DAG+C4xB,UA39CjD;UA49CM5xB,IAAI,GAAG,IAAIvC,IAAJ,CAASm0B,UAAT,CAAX;UAEIC,aAAa,GAAG,KAAK9vB,aAAL,CAAmB/B,IAAnB,EAAyB+D,SAA7C;;UACI8tB,aAAa,KAAK,IAAtB,EAA4B;eAASnwB,kBAAkB,CAAC,eAAD,CAAzB;;;aACxB,IAAN,EAAY;YACPowB,YAAY,GAAcD,aAAa,CAAC3tB,OAAd,CAAsB,CAAtB,CAA9B;YACI4tB,YAAY,YAAY1vB,SAA5B,EACCyvB,aAAa,GAAGC,YAAhB,CADD,KAEK;;;UAGFC,IAAI,GAAoB,IAA5B;;;;;;8BAEaF,aAAa,CAAC3tB,OAA3B,mIAAoC;cAA5BjF,CAA4B;;cAE/B4gB,GAAG,GAAG7e,QAAQ,CAAC/B,CAAD,EAAIkc,GAAJ,CAAlB;;cACI0E,GAAJ,EAAS;gBACJkS,IAAI,IAAI,IAAZ,EAAkBA,IAAI,GAAG,EAAP;YAClBA,IAAI,CAAC7zB,IAAL,CAAU2hB,GAAG,CAACxE,IAAd;WAFD,MAGO;;;;;;;;;;;;;;;;;aAGD0W,IAAP;;;;;UAII/oB,EAAE,GAAG,IAAI3E,aAAJ,EAAT;WAEK6iB,oBAAL,CAA0B5Y,sBAA1B,CAAiDtF,EAAjD,EAAqD,CAArD,EAAwD,KAAKua,KAAL,CAAWC,cAAX,CAA0B3Q,OAA1B,EAAxD;aAEO7J,EAAE,CAAC7I,QAAH,EAAP;;;;2CAG6B4D,SA7/C/B;UA8/CMiF,EAAE,GAAG,IAAI3E,aAAJ,EAAT;MACAN,SAAS,CAACuK,sBAAV,CAAiCtF,EAAjC,EAAqC,CAArC,EAAwC,KAAKua,KAAL,CAAWC,cAAX,CAA0B3Q,OAA1B,EAAxC;aACO7J,EAAE,CAAC7I,QAAH,EAAP;;;;;WAIKojB,KAAL,CAAWmF,eAAX,GAA6B,KAAKnF,KAAL,CAAWC,cAAX,CAA0BtQ,IAA1B,EAA7B;;UAEI,CAAC,KAAKqQ,KAAL,CAAW6G,eAAX,CAA2B9gB,MAAhC,EAAwC;aAElCia,KAAL,CAAWC,cAAX,GAA4B,KAAKD,KAAL,CAAW6G,eAAX,CAA2BlX,IAA3B,EAA5B;aACKqQ,KAAL,CAAW6G,eAAX,GAA6BvY,OAAO,CAACrM,IAArC;aAEKipB,iCAAL;;YAEI,CAAC,KAAKlL,KAAL,CAAWC,cAAX,CAA0Bla,MAA/B,EAAuC;;;;;UAKpC0oB,0BAA0B,GAAG,KAAKC,uBAAL,EAAjC;;UAEI,CAACD,0BAAL,EAAiC;YAE5BE,MAAM,GAAG,KAAb;;YAEI,KAAK3O,KAAL,CAAW6B,SAAX,CAAqBI,MAArB,CAA4B5T,WAAW,CAACY,QAAxC,CAAJ,EAAuD;eAEjD+Q,KAAL,CAAW+H,YAAX,CAAwB1Z,WAAW,CAACY,QAApC;;cAEI,KAAK+Q,KAAL,CAAW2E,sBAAf,EAAuC;iBACjC3E,KAAL,CAAW4E,mBAAX,CAA+B,IAAI7T,IAAJ,EAA/B;;;UAGD4d,MAAM,GAAG,IAAT;SARD,MASO,IAAI,KAAK3O,KAAL,CAAW6B,SAAX,CAAqBC,YAAzB,EAAuC;eACxC9B,KAAL,CAAW6B,SAAX,CAAqB0H,SAArB;UAEAoF,MAAM,GAAG,IAAT;SAHM,MAIA;eACD3O,KAAL,CAAW0H,iCAAX;;;YAGGiH,MAAM,IAAI,CAAC,KAAK3O,KAAL,CAAWC,cAAX,CAA0Bla,MAAzC,EAAiD;eAC3C+e,WAAL;;;;;;;UAME8J,mBAAmB,GAAG,IAA1B;UAEI3K,OAAO,GAAG,KAAKjE,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoC1H,cAApC,CAAmDtQ,IAAnD,EAAd;MACAsU,OAAO,CAAClpB,KAAR;;UAEIkpB,OAAO,CAACzjB,SAAR,KAAsB,IAA1B,EAAgC;eAASrC,kBAAkB,CAAC,mBAAD,CAAzB;;;aAC3B8lB,OAAO,CAAClpB,KAAR,IAAiBkpB,OAAO,CAACzjB,SAAR,CAAkBG,OAAlB,CAA0BvF,MAAlD,EAA0D;QAEzDwzB,mBAAmB,GAAG,KAAtB,CAFyD;;YAKrDC,YAAY,GAAGpxB,QAAQ,CAACwmB,OAAO,CAACzjB,SAAR,CAAkB1B,MAAnB,EAA2BD,SAA3B,CAA3B;;YACIgwB,YAAY,YAAYhwB,SAAxB,KAAsC,KAA1C,EAAiD;;;;YAI7CiwB,eAAe,GAAGD,YAAa,CAACluB,OAAd,CAAsBC,OAAtB,CAA8BqjB,OAAO,CAACzjB,SAAtC,CAAtB;;YACIsuB,eAAe,IAAI,CAAC,CAAxB,EAA2B;;;;QAI3B7K,OAAO,GAAG,IAAI3V,OAAJ,CAAYugB,YAAZ,EAA0BC,eAA1B,CAAV;QAEA7K,OAAO,CAAClpB,KAAR;QAEA6zB,mBAAmB,GAAG,IAAtB;;YACI3K,OAAO,CAACzjB,SAAR,KAAsB,IAA1B,EAAgC;iBAASrC,kBAAkB,CAAC,mBAAD,CAAzB;;;;UAG/B,CAACywB,mBAAL,EAA0B3K,OAAO,GAAG3V,OAAO,CAACrM,IAAlB;WAErB+d,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoC1H,cAApC,GAAqDgE,OAAO,CAACtU,IAAR,EAArD;aAEOif,mBAAP;;;;;UAIIG,UAAU,GAAG,KAAKzP,MAAL,CAAY+L,cAA7B;UAEI2D,gBAAgB,GAAGD,UAAU,CAACE,MAAX,CAAkB,UAACvzB,CAAD;eACjCA,CAAC,CAAC6U,kBAAT;OADsB,CAAvB;UAIIye,gBAAgB,CAAC5zB,MAAjB,IAA2B,CAA3B,IAAgC2zB,UAAU,CAAC3zB,MAAX,GAAoB4zB,gBAAgB,CAAC5zB,MAAzE,EACC,OAAO,KAAP;UAEGqf,MAAM,GAAGuU,gBAAgB,CAAC,CAAD,CAA7B;;UAEIvU,MAAM,CAAC/R,UAAP,KAAsB,IAA1B,EAAgC;eAASvK,kBAAkB,CAAC,mBAAD,CAAzB;;;UAE9Bsc,MAAM,CAAC2L,kBAAP,KAA8B,IAAlC,EAAwC;eAASjoB,kBAAkB,CAAC,2BAAD,CAAzB;;;WAErC6hB,KAAL,CAAW6B,SAAX,CAAqB0J,aAArB,GAAqC9Q,MAAM,CAAC2L,kBAA5C;WAEKlG,UAAL,CAAgBzF,MAAM,CAAC/R,UAAvB,EAAmC,KAAnC;aAEO,IAAP;;;;2CAG6BlI,SA3mD/B;UA4mDMA,SAAS,KAAK,IAAlB,EAAwB;eAASrC,kBAAkB,CAAC,WAAD,CAAzB;;;UACtB,CAACqC,SAAS,CAACqL,qBAAf,EAAuC;QACtCvO,OAAO,CAACC,IAAR,CAAa,4BAA0BiD,SAAS,CAAC7D,IAApC,GAAyC,QAAzC,GAAkD6D,SAAS,CAAC9B,aAA5D,GAA0E,6EAAvF;eACO,CAAP;;;UAGGsa,KAAK,GAAG,CAAZ;UACIkW,gBAAgB,GAAG1uB,SAAS,CAAC/D,IAAV,CAAeG,QAAf,EAAvB;MACAoc,KAAK,GAAG,KAAKgH,KAAL,CAAWmP,WAAX,CAAuBtoB,GAAvB,CAA2BqoB,gBAA3B,KAAgDlW,KAAxD;aACOA,KAAP;;;;oDAGsCxY,SAxnDxC;UAynDMwY,KAAK,GAAG,CAAZ;UACIkW,gBAAgB,GAAG1uB,SAAS,CAAC/D,IAAV,CAAeG,QAAf,EAAvB;UACI,KAAKojB,KAAL,CAAWmP,WAAX,CAAuBnrB,GAAvB,CAA2BkrB,gBAA3B,CAAJ,EAAkDlW,KAAK,GAAG,KAAKgH,KAAL,CAAWmP,WAAX,CAAuBtoB,GAAvB,CAA2BqoB,gBAA3B,CAAR;MAClDlW,KAAK;WACAgH,KAAL,CAAWmP,WAAX,CAAuBhrB,GAAvB,CAA2B+qB,gBAA3B,EAA6ClW,KAA7C;;;;oDAGsCxY,SAhoDxC;UAioDM0uB,gBAAgB,GAAG1uB,SAAS,CAAC/D,IAAV,CAAeG,QAAf,EAAvB;WACKojB,KAAL,CAAWoP,WAAX,CAAuBjrB,GAAvB,CAA2B+qB,gBAA3B,EAA6C,KAAKlP,KAAL,CAAWsI,gBAAxD;;;;2CAG6B9nB,SAroD/B;UAsoDM,CAACA,SAAS,CAACwL,wBAAf,EAA0C;aACpCnO,KAAL,CAAW,+BAA6B2C,SAAS,CAAC7D,IAAvC,GAA4C,QAA5C,GAAqD6D,SAAS,CAAC9B,aAA/D,GAA6E,6EAAxF;;;UAGGwwB,gBAAgB,GAAG1uB,SAAS,CAAC/D,IAAV,CAAeG,QAAf,EAAvB;UACI7B,KAAK,GAAG,KAAKilB,KAAL,CAAWoP,WAAX,CAAuBvoB,GAAvB,CAA2BqoB,gBAA3B,CAAZ;;UACI,OAAOn0B,KAAP,KAAiB,WAArB,EAAkC;eAC1B,KAAKilB,KAAL,CAAWsI,gBAAX,GAA8BvtB,KAArC;OADD,MAEO;eACC,CAAC,CAAR;;;;;;;UAMGs0B,iBAAiB,GAAG5xB,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAAhC;;UACI,EAAE0nB,iBAAiB,YAAY1nB,QAA/B,CAAJ,EAA8C;aACxC9J,KAAL,CAAW,2DAAX;eACO,CAAP;;;UAGGyxB,YAAY,GAAG,KAAKtP,KAAL,CAAWC,cAAX,CAA0Bzf,SAA7C;;UACI8uB,YAAY,KAAK,IAArB,EAA2B;eAASnxB,kBAAkB,CAAC,cAAD,CAAzB;;;;;UAIzBkxB,iBAAiB,CAACnzB,KAAlB,KAA4B,IAAhC,EAAsC;eAASiC,kBAAkB,CAAC,yBAAD,CAAzB;;;UACpCoxB,WAAW,GAAGF,iBAAiB,CAACnzB,KAApC;;UAGIszB,WAAW,GAAG5xB,UAAU,CAAC,KAAKoiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAA5B;UACI8nB,QAAQ,GAAGD,WAAW,CAACtzB,KAA3B;;;UAIIuzB,QAAQ,KAAK,IAAjB,EAAuB;eAAStxB,kBAAkB,CAAC,UAAD,CAAzB;;;UAErBuxB,SAAS,GAAGD,QAAQ,GAAGF,WAA3B;UACII,cAAc,GAAGF,QAAQ,GAAGF,WAAhC;UAEIK,UAAU,GAAGN,YAAY,CAAC7yB,IAAb,CAAkBG,QAAlB,EAAjB;UACIizB,YAAY,GAAG,CAAnB;;WACK,IAAI10B,CAAC,GAAG,CAAR,EAAWK,CAAC,GAAGo0B,UAAU,CAACx0B,MAA/B,EAAuCD,CAAC,GAAGK,CAA3C,EAA8CL,CAAC,EAA/C,EAAkD;QACjD00B,YAAY,IAAID,UAAU,CAACE,UAAX,CAAsB30B,CAAtB,KAA4B,CAA5C;;;UAEG40B,UAAU,GAAGF,YAAY,GAAGH,SAAf,GAA2B,KAAK1P,KAAL,CAAWgJ,SAAvD;UACIE,MAAM,GAAG,IAAIvL,IAAJ,CAASve,IAAI,CAAC0W,KAAL,CAAWia,UAAX,CAAT,CAAb;UAEIC,eAAe,GAAG,EAAtB;;WACK,IAAI70B,GAAC,GAAG,CAAb,EAAgBA,GAAC,GAAGo0B,WAApB,EAAiC,EAAEp0B,GAAnC,EAAsC;QACrC60B,eAAe,CAACr1B,IAAhB,CAAqBQ,GAArB;;;WAGI,IAAIA,GAAC,GAAG,CAAb,EAAgBA,GAAC,IAAIw0B,cAArB,EAAqC,EAAEx0B,GAAvC,EAA0C;YACrC80B,MAAM,GAAG/G,MAAM,CAACrL,IAAP,KAAgBmS,eAAe,CAAC50B,MAA7C;YACI80B,WAAW,GAAGF,eAAe,CAACC,MAAD,CAAjC;QACAD,eAAe,CAAC9B,MAAhB,CAAuB+B,MAAvB,EAA+B,CAA/B;;YAEI90B,GAAC,IAAIw0B,cAAT,EAAyB;iBACjBO,WAAP;;;;YAII,IAAIryB,KAAJ,CAAU,yBAAV,CAAN;;;;0BAGYV,OAxsDd;UAwsD+BsJ,uFAAmB;UAC5C8a,CAAC,GAAG,IAAI/a,cAAJ,CAAmBrJ,OAAnB,CAAR;MACAokB,CAAC,CAAC9a,gBAAF,GAAqBA,gBAArB;YACM8a,CAAN;;;;4BAGcpkB,OA9sDhB;WA+sDOqkB,QAAL,CAAcrkB,OAAd,EAAuB,IAAvB;;;;6BAGeA,OAltDjB;UAktDkCgzB,gFAAY;UAAO1pB,uFAAmB;UAClEhI,EAAE,GAAG,KAAK2xB,oBAAd;UAEIC,YAAY,GAAGF,SAAS,GAAG,SAAH,GAAe,OAA3C;;UAEI1xB,EAAE,IAAI,IAAV,EAAgB;YACX6xB,OAAO,GAAG7pB,gBAAgB,GAAGhI,EAAE,CAAC8xB,aAAN,GAAsB9xB,EAAE,CAACE,eAAvD;QACAxB,OAAO,GAAG,aAAakzB,YAAb,GAA4B,KAA5B,GAAoC5xB,EAAE,CAAC+xB,QAAvC,GAAkD,SAAlD,GAA8DF,OAA9D,GAAwE,IAAxE,GAA+EnzB,OAAzF;OAFD,MAIK,IAAG,CAAC,KAAK6iB,KAAL,CAAWC,cAAX,CAA0Bla,MAA9B,EAAsC;QAC1C5I,OAAO,GAAG,aAAakzB,YAAb,GAA4B,KAA5B,GAAoC,KAAKrQ,KAAL,CAAWC,cAA/C,GAAgE,KAAhE,GAAwE9iB,OAAlF;OADI,MAGA;QACJA,OAAO,GAAG,aAAakzB,YAAb,GAA4B,IAA5B,GAAmClzB,OAA7C;;;WAGI6iB,KAAL,CAAWwB,QAAX,CAAoBrkB,OAApB,EAA6BgzB,SAA7B;;UAGI,CAACA,SAAL,EACC,KAAKnQ,KAAL,CAAWF,QAAX;;;;2BAGYziB,SAzuDf;UAyuDmCF,8EAAyB;;UACtDE,SAAS,IAAI,KAAjB,EAAwB;YACnBF,OAAO,IAAI,IAAf,EAAqB;UACpBA,OAAO,GAAG,cAAV;;;cAGK,IAAIU,KAAJ,CAAUV,OAAO,GAAG,GAAV,GAAgB,KAAKizB,oBAA/B,CAAN;;;;;;UAxuDGhF,OAAO,GAAa,EAAxB;;UAEI,KAAK9L,MAAL,KAAgB,IAApB,EAA0B;eAASnhB,kBAAkB,CAAC,aAAD,CAAzB;;;;;;;;8BACf,KAAKmhB,MAAL,CAAY+L,cAAzB,mIAAyC;cAAjC3vB,CAAiC;;cACpC,CAACA,CAAC,CAAC6U,kBAAP,EAA2B;YAC1B7U,CAAC,CAACX,KAAF,GAAUqwB,OAAO,CAAChwB,MAAlB;YACAgwB,OAAO,CAACzwB,IAAR,CAAae,CAAb;;;;;;;;;;;;;;;;;;aAIK0vB,OAAP;;;;;WAIK/L,aAAL,CAAmB,gDAAnB;aACO,KAAKW,KAAL,CAAWM,WAAlB;;;;;WAIKjB,aAAL,CAAmB,gDAAnB;aACO,KAAKW,KAAL,CAAW2C,WAAlB;;;;;aAIO,KAAK3C,KAAL,CAAWyQ,aAAlB;;;;;aAIO,KAAKzQ,KAAL,CAAW0Q,eAAlB;;;;;aAIO,KAAK1Q,KAAL,CAAW2Q,QAAlB;;;;;aAIO,KAAK3Q,KAAL,CAAW4Q,UAAlB;;;;;aAIO,KAAK5Q,KAAL,CAAWR,cAAlB;;;;;aAIO,KAAKhB,gBAAZ;;;;;aAIO,KAAKc,MAAZ;;;;;aAoIO,KAAKU,KAAL,CAAWe,WAAlB;;;;;aAIO,CAAC,KAAKD,oBAAb;;;;;aAqxCO,KAAKsN,wCAAL,CAA8C,EAA9C,CAAP;;;;;UAgSI3vB,EAAJ;UAEIwlB,OAAO,GAAG,KAAKjE,KAAL,CAAWC,cAAzB;;UACI,CAACgE,OAAO,CAACle,MAAT,IAAmBke,OAAO,CAAC3U,OAAR,OAAsB,IAA7C,EAAmD;QAClD7Q,EAAE,GAAGwlB,OAAO,CAAC3U,OAAR,GAAmB5Q,aAAxB;;YACID,EAAE,KAAK,IAAX,EAAiB;iBACTA,EAAP;;;;WAIG,IAAItD,CAAC,GAAG,KAAK6kB,KAAL,CAAW6B,SAAX,CAAqBuK,QAArB,CAA8BhxB,MAA9B,GAAuC,CAApD,EAAuDD,CAAC,IAAI,CAA5D,EAA+D,EAAEA,CAAjE,EAAoE;QACnE8oB,OAAO,GAAG,KAAKjE,KAAL,CAAW6B,SAAX,CAAqBuK,QAArB,CAA+BjxB,CAA/B,EAAkC8kB,cAA5C;;YACI,CAACgE,OAAO,CAACle,MAAT,IAAmBke,OAAO,CAAC3U,OAAR,OAAsB,IAA7C,EAAmD;UAClD7Q,EAAE,GAAGwlB,OAAO,CAAC3U,OAAR,GAAmB5Q,aAAxB;;cACID,EAAE,KAAK,IAAX,EAAiB;mBACTA,EAAP;;;;;WAKE,IAAItD,GAAC,GAAG,KAAK6kB,KAAL,CAAWiH,YAAX,CAAwB7rB,MAAxB,GAAiC,CAA9C,EAAiDD,GAAC,IAAI,CAAtD,EAAyD,EAAEA,GAA3D,EAA8D;YACzD01B,SAAS,GAAG,KAAK7Q,KAAL,CAAWiH,YAAX,CAAyB9rB,GAAzB,CAAhB;QACAsD,EAAE,GAAGoyB,SAAS,CAACnyB,aAAf;;YACID,EAAE,KAAK,IAAX,EAAiB;iBACTA,EAAP;;;;aAIK,IAAP;;;;;UAII,KAAKujB,6BAAT,EAAwC;eAChC,KAAKA,6BAAZ;OADD,MAEO;eACC,KAAK1D,qBAAZ;;;;;;EAvxDwBlgB,SAA3B;;AAuzDA,WAAiBggB;MACJ0E,iBAAZ;;aAAYA;IACXA,oDAAA,aAAA;IACAA,iEAAA,0BAAA;IACAA,0DAAA,mBAAA;GAHD,EAAYA,iBAAiB,GAAjB1E,uBAAA,KAAAA,uBAAA,KAAA,CAAZ;CADD,EAAiBA,KAAK,KAALA,KAAK,KAAA,CAAtB;;ICh1Da0S,SAAb;;AAAA;;;;uBA8OQ,GAAyB,CAAzB;qBACA,GAAwBxiB,OAAO,CAACrM,IAAhC;;QA3MF3H,SAAS,CAAC,CAAD,CAAT,YAAwB8jB,KAA5B,EAAmC;UAC9B2S,YAAY,GAAGz2B,SAAS,CAAC,CAAD,CAA5B;WAEK02B,YAAL,GAAoB1iB,OAAO,CAACoB,OAAR,CAAgBqhB,YAAY,CAACzyB,oBAA7B,CAApB;WACK2yB,KAAL;KAJD,MAKO;UACFC,MAAM,GAAG52B,SAAS,CAAC,CAAD,CAAtB;WAEK62B,QAAL,GAAgB,EAAhB;;;;;;6BACwBD,MAAM,CAACC,QAA/B,8HAAyC;cAAhCC,WAAgC;;eACnCD,QAAL,CAAcx2B,IAAd,CAAmBy2B,WAAW,CAACrN,IAAZ,EAAnB;;;;;;;;;;;;;;;;;WAEIiN,YAAL,GAAoBE,MAAM,CAACF,YAA3B;;;;;;;WAKIG,QAAL,GAAgB,EAAhB;;WACKA,QAAL,CAAcx2B,IAAd,CAAmB,IAAIm2B,SAAS,CAACO,MAAd,EAAnB;;WAEKF,QAAL,CAAc,CAAd,EAAiBG,SAAjB,CAA2B32B,IAA3B,CAAgC,IAAIm2B,SAAS,CAACS,OAAd,CAAsBljB,WAAW,CAAC+L,MAAlC,EAA0C,KAAK4W,YAA/C,CAAhC;;;;iCAGmB3X,OA3DrB,EA2DmC0X,YA3DnC;WA4DOI,QAAL,CAAc/1B,MAAd,GAAuB,CAAvB;;UAGIo2B,QAAQ,GAAUnY,OAAO,CAAC,SAAD,CAA7B;;;;;;8BAEuBmY,QAAvB,mIAAiC;cAAxBC,UAAwB;;cAE5BC,UAAU,GAAGD,UAAjB;cACIE,MAAM,GAAG,IAAIb,SAAS,CAACO,MAAd,CAAqBK,UAArB,EAAiCX,YAAjC,CAAb;;eACKI,QAAL,CAAcx2B,IAAd,CAAmBg3B,MAAnB;;;;;;;;;;;;;;;;;;WAIIC,cAAL,GAAsBp1B,QAAQ,CAAC6c,OAAO,CAAC,eAAD,CAAR,CAA9B;WACK2X,YAAL,GAAoB1iB,OAAO,CAACoB,OAAR,CAAgBqhB,YAAY,CAACzyB,oBAA7B,CAApB;;;;;UAGI+a,OAAO,GAAQ,EAAnB;UAEImY,QAAQ,GAAU,EAAtB;;;;;;8BAEmB,KAAKL,QAAxB,mIAAkC;cAAzBQ,MAAyB;UACjCH,QAAQ,CAAC72B,IAAT,CAAcg3B,MAAM,CAACE,SAArB;;;;;;;;;;;;;;;;;MAGDxY,OAAO,CAAC,SAAD,CAAP,GAAqBmY,QAArB;MACAnY,OAAO,CAAC,eAAD,CAAP,GAA2B,KAAKuY,cAAhC;aAEOvY,OAAP;;;;;UAIIyY,SAAS,GAAG,KAAKvG,aAAL,CAAmBxH,IAAnB,EAAhB;WACK6N,cAAL;MACAE,SAAS,CAACC,WAAV,GAAwB,KAAKH,cAA7B;;WACKT,QAAL,CAAcx2B,IAAd,CAAmBm3B,SAAnB;;;;;UAIIE,YAAY,GAAG,KAAKzG,aAAL,CAAmBxH,IAAnB,EAAnB;WACK6N,cAAL;MACAI,YAAY,CAACD,WAAb,GAA2B,KAAKH,cAAhC;aACOI,YAAP;;;;;UAII,KAAKlQ,YAAT,EAAuB;aACjBqP,QAAL,CAAcjD,MAAd,CAAqB,KAAKiD,QAAL,CAAcvwB,OAAd,CAAsB,KAAK2qB,aAA3B,CAArB,EAAgE,CAAhE,EADsB;;OAAvB,MAEO;cACA,IAAI1tB,KAAJ,CAAU,kBAAV,CAAN;;;;;yBAYUX,IAzHb;UAyHgC+0B,oGAAwC;UAAGC,mGAAuC;UAC5GC,OAAO,GAAG,IAAIrB,SAAS,CAACS,OAAd,CACbr0B,IADa,EAEb,KAAKyqB,cAAL,CAAoB1H,cAFP,EAGb,KAHa,CAAd;MAMAkS,OAAO,CAACC,+BAAR,GAA0CH,6BAA1C;MACAE,OAAO,CAACE,2BAAR,GAAsCH,4BAAtC;WAEKrQ,SAAL,CAAelnB,IAAf,CAAqBw3B,OAArB;;;;;UAGaj1B,2EAA2B;UACpC,CAAC,KAAKglB,MAAV,EACC,OAAO,KAAP;UAEGhlB,IAAI,IAAI,IAAZ,EACC,OAAO,IAAP;aAEM,KAAKyqB,cAAL,CAAoBzqB,IAApB,IAA4BA,IAAnC;;;;;UAGUA,2EAA2B;;UACjC,KAAK+kB,MAAL,CAAY/kB,IAAZ,CAAJ,EAAuB;aACjB2kB,SAAL,CAAeyQ,GAAf;;OADD,MAGO;cACA,IAAIz0B,KAAJ,CAAU,kCAAV,CAAN;;;;;iDAIkClB,IAzJrC;UAyJ0DmM,mFAAuB,CAAC;UAE5EA,YAAY,IAAI,CAAC,CAArB,EACCA,YAAY,GAAG,KAAKypB,mBAAL,GAA2B,CAA1C;UAEGC,cAAc,GAAG,KAAK3Q,SAAL,CAAe/Y,YAAY,GAAG,CAA9B,CAArB;UAEI2pB,QAAQ,GAAG/rB,kBAAkB,CAAC8rB,cAAc,CAACE,kBAAhB,EAAoC/1B,IAApC,EAA0C,IAA1C,CAAjC;;UACI81B,QAAQ,CAAC1vB,MAAb,EAAqB;eACb0vB,QAAQ,CAACxvB,MAAhB;OADD,MAEO;eACC,IAAP;;;;;yCAI0BtG,IAxK7B,EAwK2CT,KAxK3C,EAwKuDy2B,UAxKvD;UAwK4E7pB,mFAAuB,CAAC;UAE9FA,YAAY,IAAI,CAAC,CAArB,EACCA,YAAY,GAAG,KAAKypB,mBAAL,GAA2B,CAA1C;UAEGC,cAAc,GAAG,KAAK3Q,SAAL,CAAe/Y,YAAY,GAAG,CAA9B,CAArB;;UAEI,CAAC6pB,UAAD,IAAe,CAACH,cAAc,CAACE,kBAAf,CAAkC7rB,GAAlC,CAAsClK,IAAtC,CAApB,EAAiE;cAC1D,IAAI6J,cAAJ,CAAmB,+CAA+C7J,IAAlE,CAAN;;;UAGGyM,QAAQ,GAAG1C,kBAAkB,CAAC8rB,cAAc,CAACE,kBAAhB,EAAoC/1B,IAApC,EAA0C,IAA1C,CAAjC;UACIyM,QAAQ,CAACrG,MAAb,EACC+E,SAAS,CAAC8qB,8BAAV,CAAyCxpB,QAAQ,CAACnG,MAAlD,EAA0D/G,KAA1D;MAEDs2B,cAAc,CAACE,kBAAf,CAAkCvuB,GAAlC,CAAsCxH,IAAtC,EAA4CT,KAA5C;;;;4CAG8BS,IA1LhC;UA4LM,KAAKgrB,cAAL,CAAoB+K,kBAApB,CAAuC7rB,GAAvC,CAA2ClK,IAA3C,CAAJ,EAAsD;eAC9C,KAAK41B,mBAAL,GAA2B,CAAlC;OADD,MAIK;eACG,CAAP;;;;;oCAIqBx3B,KArMxB;UAsMM83B,QAAQ,GAAG,KAAK1B,QAAL,CAAclC,MAAd,CAAqB,UAAC9a,CAAD;YAC/BA,CAAC,CAAC4d,WAAF,IAAiBh3B,KAArB,EAA4B,OAAOoZ,CAAP;OADd,CAAf;;aAIO0e,QAAQ,CAAC,CAAD,CAAf;;;;;aAxMO,KAAKhR,SAAZ;;;;;aAIO,KAAKuK,QAAL,CAAchxB,MAArB;;;;;UAIIu2B,MAAM,GAAG,KAAKR,QAAL,CAAc,KAAKA,QAAL,CAAc/1B,MAAd,GAAuB,CAArC,CAAb;UACI03B,EAAE,GAAGnB,MAAM,CAACL,SAAhB;aACOwB,EAAE,CAACA,EAAE,CAAC13B,MAAH,GAAY,CAAb,CAAT;;;;;aAIO,KAAKymB,SAAL,CAAezmB,MAAf,GAAwB,CAA/B;;;;;aAIO,KAAK+1B,QAAL,CAAc,KAAKA,QAAL,CAAc/1B,MAAd,GAAuB,CAArC,CAAP;KApBF;sBAsBmBc,KAtBnB;MAuBEa,KAAK,CAACK,MAAN,CAAa,KAAK+zB,QAAL,CAAc/1B,MAAd,IAAwB,CAArC,EAAwC,+EAAxC;WAEK+1B,QAAL,CAAc/1B,MAAd,GAAuB,CAAvB;;WACK+1B,QAAL,CAAcx2B,IAAd,CAAmBuB,KAAnB;;;;;aAIO,KAAK2lB,SAAL,CAAezmB,MAAf,GAAwB,CAA/B;;;;;aAoFO,KAAK+1B,QAAL,CAAc/1B,MAAd,GAAuB,CAAvB,IAA4B,CAAC,KAAKmnB,yBAAzC;;;;;aAIO,KAAKoF,cAAL,CAAoBzqB,IAApB,IAA4BmR,WAAW,CAAC0kB,0BAA/C;;;;;aAwFO,KAAKxH,aAAL,CAAmB+F,SAA1B;;;;;UAII7rB,EAAE,GAAG,IAAI3E,aAAJ,EAAT;;WAEK,IAAIqT,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKgd,QAAL,CAAc/1B,MAAlC,EAA0C+Y,CAAC,EAA3C,EAA+C;YAC1Cwd,MAAM,GAAG,KAAKR,QAAL,CAAchd,CAAd,CAAb;YACI6e,SAAS,GAAI7e,CAAC,IAAI,KAAKgd,QAAL,CAAc/1B,MAAd,GAAuB,CAA7C;QACAqK,EAAE,CAAC2F,YAAH,CAAgB,6BAAhB,EAAgD+I,CAAC,GAAC,CAAlD,EAAsD,KAAKgd,QAAL,CAAc/1B,MAApE,EAA6E43B,SAAS,GAAG,YAAH,GAAkB,EAAxG;;aAEK,IAAI73B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGw2B,MAAM,CAACL,SAAP,CAAiBl2B,MAArC,EAA6CD,CAAC,EAA9C,EAAkD;cAE7Cw2B,MAAM,CAACL,SAAP,CAAiBn2B,CAAjB,EAAoB+B,IAApB,IAA4BmR,WAAW,CAACY,QAA5C,EACCxJ,EAAE,CAACzE,MAAH,CAAU,eAAV,EADD,KAGCyE,EAAE,CAACzE,MAAH,CAAU,aAAV;cAEGijB,OAAO,GAAG0N,MAAM,CAACL,SAAP,CAAiBn2B,CAAjB,EAAoB8kB,cAAlC;;cACG,CAACgE,OAAO,CAACle,MAAZ,EAAoB;YACnBN,EAAE,CAACzE,MAAH,CAAU,gBAAV;;gBACIijB,OAAO,CAACzjB,SAAR,KAAsB,IAA1B,EAAgC;qBAASrC,kBAAkB,CAAC,mBAAD,CAAzB;;;YAClCsH,EAAE,CAACzE,MAAH,CAAUijB,OAAO,CAACzjB,SAAR,CAAkB/D,IAAlB,CAAuBG,QAAvB,EAAV;YACA6I,EAAE,CAAC4F,UAAH,CAAc,GAAd;;;;;aAKI5F,EAAE,CAAC7I,QAAH,EAAP;;;;;;;AAQF,WAAiBk0B;MACHS;;;qBASAr0B,IAAZ,EAA+B+mB,OAA/B;UAAiDU,6FAAkC;;;;0CAH5E,GAA0C,CAA1C;sCACA,GAAsC,CAAtC;WAGD1E,cAAL,GAAsBgE,OAAO,CAACtU,IAAR,EAAtB;WACKgV,sBAAL,GAA8BA,sBAA9B;WACK+N,kBAAL,GAA0B,IAAInsB,GAAJ,EAA1B;WACKrJ,IAAL,GAAYA,IAAZ;;;;;;YAIIyS,IAAI,GAAG,IAAI4hB,OAAJ,CAAY,KAAKr0B,IAAjB,EAAuB,KAAK+iB,cAA5B,EAA4C,KAAK0E,sBAAjD,CAAX;QACAhV,IAAI,CAAC+iB,kBAAL,GAA0B,IAAInsB,GAAJ,CAAQ,KAAKmsB,kBAAb,CAA1B;QACA/iB,IAAI,CAACyiB,+BAAL,GAAuC,KAAKA,+BAA5C;QACAziB,IAAI,CAAC0iB,2BAAL,GAAmC,KAAKA,2BAAxC;eACO1iB,IAAP;;;;;;;EArBWmhB,iBAAA,UAAA;;MAyBAO;;;;;;sBAEL,GAAsB,CAAtB;0BACA,GAA2B/iB,OAAO,CAACrM,IAAnC;WAKDqvB,SAAL,GAAiB,EAAjB;;UAEIh3B,SAAS,CAAC,CAAD,CAAT,IAAgBA,SAAS,CAAC,CAAD,CAA7B,EAAiC;YAC5Bo3B,UAAU,GAAGp3B,SAAS,CAAC,CAAD,CAA1B;YACIy2B,YAAY,GAAGz2B,SAAS,CAAC,CAAD,CAA5B,CAFgC;;aAK3By3B,WAAL,GAAmBv1B,QAAQ,CAACk1B,UAAU,CAAC,aAAD,CAAX,CAA3B;YAEIuB,gBAAgB,GAAGvB,UAAU,CAAC,WAAD,CAAjC;;;;;;gCAEmBuB,gBAAnB,mIAAqC;gBAA5BC,MAA4B;gBAChCC,WAAW,GAAGD,MAAlB,CADoC;;gBAIhCE,WAAW,GAAgB52B,QAAQ,CAAC22B,WAAW,CAAC,MAAD,CAAZ,CAAvC;gBAEIlP,OAAO,GAAG3V,OAAO,CAACrM,IAAtB;gBAEIoxB,uBAA+B,SAAnC,CARoC;;gBAUhCC,4BAA4B,GAAGH,WAAW,CAAC,OAAD,CAA9C;;gBACI,OAAOG,4BAAP,KAAwC,WAA5C,EAAyD;cACxDD,uBAAuB,GAAGC,4BAA4B,CAAC12B,QAA7B,EAA1B;kBAEI22B,mBAAmB,GAAGxC,YAAY,CAACvyB,aAAb,CAA2B,IAAItE,IAAJ,CAASm5B,uBAAT,CAA3B,CAA1B;cACApP,OAAO,CAACzjB,SAAR,GAAoB+yB,mBAAmB,CAAC/yB,SAAxC;cACAyjB,OAAO,CAAClpB,KAAR,GAAgByB,QAAQ,CAAC22B,WAAW,CAAC,KAAD,CAAZ,CAAxB;kBAEII,mBAAmB,CAAC71B,GAApB,IAA2B,IAA/B,EACC,MAAM,IAAIG,KAAJ,CAAU,qEAAqEw1B,uBAArE,GAA+F,2DAAzG,CAAN,CADD,KAEK,IAAIE,mBAAmB,CAAC7pB,WAAxB,EAAqC;oBACrCua,OAAO,CAACzjB,SAAR,KAAsB,IAA1B,EAAgC;yBAASrC,kBAAkB,CAAC,mBAAD,CAAzB;;;gBAClC4yB,YAAY,CAACjN,OAAb,CAAqB,2EAA2EuP,uBAA3E,GAAqG,gCAArG,GAAsIpP,OAAO,CAACzjB,SAAR,CAAkB/D,IAAlB,CAAuBG,QAAvB,EAAtI,GAAwK,uEAA7L;;;;gBAIE+nB,sBAAsB,GAAG,CAAC,CAACwO,WAAW,CAAC,KAAD,CAA1C;gBAEIK,EAAE,GAAG,IAAIjC,OAAJ,CAAY6B,WAAZ,EAAyBnP,OAAzB,EAAkCU,sBAAlC,CAAT;gBAEI8O,SAAS,GAAGN,WAAW,CAAC,MAAD,CAA3B;YACAK,EAAE,CAACd,kBAAH,GAAwBha,iBAAiB,CAACgb,8BAAlB,CAAiDD,SAAjD,CAAxB;iBAEKnC,SAAL,CAAe32B,IAAf,CAAoB64B,EAApB;;;;;;;;;;;;;;;;;YAGGG,kBAAkB,GAAGjC,UAAU,CAAC,uBAAD,CAAnC;;YACG,OAAOiC,kBAAP,KAA8B,WAAjC,EAA8C;cACzCC,QAAQ,GAAG,IAAI15B,IAAJ,CAASy5B,kBAAkB,CAAC/2B,QAAnB,EAAT,CAAf;eACKuoB,eAAL,GAAuB4L,YAAY,CAACjK,aAAb,CAA2B8M,QAA3B,CAAvB;;;;;;;;YAMEjkB,IAAI,GAAG,IAAI0hB,MAAJ,EAAX;QACA1hB,IAAI,CAACoiB,WAAL,GAAmB,KAAKA,WAAxB;;;;;;gCACc,KAAKT,SAAnB,mIAA8B;gBAArB/P,CAAqB;YAC7B5R,IAAI,CAAC2hB,SAAL,CAAe32B,IAAf,CAAoB4mB,CAAC,CAACwC,IAAF,EAApB;;;;;;;;;;;;;;;;;QAEDpU,IAAI,CAACwV,eAAL,GAAuB,KAAKA,eAAL,CAAqBxV,IAArB,EAAvB;eACOA,IAAP;;;;;YAIIkkB,UAAU,GAAQ,EAAtB;YAEIZ,gBAAgB,GAAU,EAA9B;;;;;;gCACe,KAAK3B,SAApB,mIAA+B;gBAAtBkC,EAAsB;gBAC1Bja,IAAI,GAAQ,EAAhB;;gBACI,CAACia,EAAE,CAACvT,cAAH,CAAkBla,MAAvB,EAA+B;kBAC1BytB,EAAE,CAACvT,cAAH,CAAkBzf,SAAlB,KAAgC,IAApC,EAA0C;uBAASrC,kBAAkB,CAAC,6BAAD,CAAzB;;;cAC5Cob,IAAI,CAAC,OAAD,CAAJ,GAAgBia,EAAE,CAACvT,cAAH,CAAkBzf,SAAlB,CAA4B/D,IAA5B,CAAiClC,gBAAjD;cACAgf,IAAI,CAAC,KAAD,CAAJ,GAAcia,EAAE,CAACvT,cAAH,CAAkBllB,KAAhC;;;YAEDwe,IAAI,CAAC,KAAD,CAAJ,GAAcia,EAAE,CAAC7O,sBAAjB;YACApL,IAAI,CAAC,MAAD,CAAJ,GAAeia,EAAE,CAACt2B,IAAlB;YACAqc,IAAI,CAAC,MAAD,CAAJ,GAAeb,iBAAiB,CAACiE,8BAAlB,CAAiD6W,EAAE,CAACd,kBAApD,CAAf;YACAO,gBAAgB,CAACt4B,IAAjB,CAAsB4e,IAAtB;;;;;;;;;;;;;;;;;QAGDsa,UAAU,CAAC,WAAD,CAAV,GAA0BZ,gBAA1B;QACAY,UAAU,CAAC,aAAD,CAAV,GAA4B,KAAK9B,WAAjC;;YAEI,CAAC,KAAK5M,eAAL,CAAqBpf,MAA1B,EAAkC;cAC7B+tB,eAAe,GAAG,KAAK3O,eAAL,CAAqB7V,OAArB,EAAtB;;cACIwkB,eAAe,KAAK,IAAxB,EAA8B;mBAAS31B,kBAAkB,CAAC,gCAAD,CAAzB;;;UAChC01B,UAAU,CAAC,uBAAD,CAAV,GAAsCC,eAAe,CAACr3B,IAAhB,CAAqBG,QAArB,EAAtC;;;eAGMi3B,UAAP;;;;;;;EAnGW/C,gBAAA,SAAA;CA1Bd,EAAiBA,SAAS,KAATA,SAAS,KAAA,CAA1B;;ICrPaiD,cAAb;;AAAA;0BA6EalS,SAAZ,EAAkCmS,cAAlC;;;;;;;sCAxEO,GAA4F,EAA5F;uCAqCC,GAA0C,KAA1C;gCA6PA,GAAkD,IAAIztB,GAAJ,EAAlD;0BAGA,GAAwC,IAAI+mB,GAAJ,EAAxC;SA5NF2G,gBAAL,GAAwB,IAAI1tB,GAAJ,EAAxB;SACK2tB,UAAL,GAAkBrS,SAAlB;SACKsS,eAAL,GAAuBH,cAAvB;;QAGG;;;;UAIE/4B,CAAC,GAAG,IAAIm5B,KAAJ,CAAU,IAAV,EAAgB;QACvBvtB,GADuB,eACnB0T,MADmB,EACN5d,IADM;iBAEdA,IAAI,IAAI4d,MAAT,GAAmBA,MAAM,CAAC5d,IAAD,CAAzB,GAAkC4d,MAAM,CAAC8Z,CAAP,CAAS13B,IAAT,CAAzC;SAFsB;QAIvBwH,GAJuB,eAInBoW,MAJmB,EAIN5d,IAJM,EAIAT,KAJA;cAKlBS,IAAI,IAAI4d,MAAZ,EAAoBA,MAAM,CAAC5d,IAAD,CAAN,GAAeT,KAAf,CAApB,KACKqe,MAAM,CAAC8Z,CAAP,CAAS13B,IAAT,EAAeT,KAAf;iBACE,IAAP;;OAPM,CAAR;aAWOjB,CAAP;KAfD,CAiBA,OAAMsmB,CAAN,EAAQ;;;;;;;;yCA9FmB1Y,YAN7B,EAMmDQ,QANnD;;;;;;6BAOuB,KAAKirB,6BAA1B,8HAAyD;cAAhDC,QAAgD;UACxDA,QAAQ,CAAC1rB,YAAD,EAAeQ,QAAf,CAAR;;;;;;;;;;;;;;;;;;;;;;sBAuCOR,YA/CV,EA+CgC3M,KA/ChC;UAgDM,OAAOA,KAAP,KAAiB,WAArB,EAAiC;YAC5BuqB,WAAW,GAAG,KAAKwN,gBAAL,CAAsBptB,GAAtB,CAA0BgC,YAA1B,CAAlB;;YAEK,OAAO4d,WAAP,KAAuB,WAA5B,EAA0C;UACzCA,WAAW,GAAG,KAAK+N,uBAAL,CAA6B3tB,GAA7B,CAAiCgC,YAAjC,CAAd;;;YAGI,OAAO4d,WAAP,KAAuB,WAA5B,EACC,OAAQA,WAA6B,CAACnf,WAAtC,CADD,KAGC,OAAO,IAAP;OAVF,MAYI;YACC,OAAO,KAAKktB,uBAAL,CAA6B3tB,GAA7B,CAAiCgC,YAAjC,CAAP,KAA0D,WAA9D,EACC,MAAM,IAAIrC,cAAJ,CAAmB,kCAAgCqC,YAAhC,GAA6C,0CAAhE,CAAN;YAEGjC,GAAG,GAAGvD,KAAK,CAAC+D,MAAN,CAAalL,KAAb,CAAV;;YACI0K,GAAG,IAAI,IAAX,EAAiB;cACZ1K,KAAK,IAAI,IAAb,EAAmB;kBACZ,IAAIsK,cAAJ,CAAmB,mCAAnB,CAAN;WADD,MAEO;kBACA,IAAIA,cAAJ,CAAmB,4CAA0CtK,KAAK,CAACU,QAAN,EAA7D,CAAN;;;;aAIG2tB,SAAL,CAAe1hB,YAAf,EAA6BjC,GAA7B;;;;;6BAkCcsqB,MA3GjB;WA4GO+C,gBAAL,GAAwB,IAAI1tB,GAAJ,CAAQ2qB,MAAM,CAAC+C,gBAAf,CAAxB;WACKO,uBAAL,GAA+B,IAAIjuB,GAAJ,CAAQ2qB,MAAM,CAACsD,uBAAf,CAA/B;WAEKC,oBAAL,GAA4BvD,MAAM,CAACuD,oBAAnC;WACKH,6BAAL,GAAqCpD,MAAM,CAACoD,6BAA5C;;UAEIpD,MAAM,CAAChQ,6BAAP,IAAwC,KAAKA,6BAAjD,EAAgF;YAE3EgQ,MAAM,CAAChQ,6BAAX,EAA0C;eACpCwT,8BAAL,GAAsC,IAAtC;;cACIxD,MAAM,CAACyD,iBAAP,KAA6B,IAAjC,EAAuC;mBAASx2B,kBAAkB,CAAC,0BAAD,CAAzB;;;eACpCw2B,iBAAL,GAAyB,IAAIrH,GAAJ,CAAQ4D,MAAM,CAACyD,iBAAf,CAAzB;SAHD,MAIO;eACDD,8BAAL,GAAsC,KAAtC;eACKC,iBAAL,GAAyB,IAAzB;;;;;;+CAY+Bh4B,IAtInC;UAwIMiK,GAAG,GAAGF,kBAAkB,CAAC,KAAK8tB,uBAAN,EAA+B73B,IAA/B,EAAqC,IAArC,CAA5B;aACOiK,GAAG,CAAC7D,MAAJ,GAAa6D,GAAG,CAAC3D,MAAjB,GAA0B,IAAjC;;;;iDAGmCtG,IA5IrC;aA6IS,KAAKs3B,gBAAL,CAAsBjwB,GAAtB,CAA0BrH,IAA1B,CAAP;;;;wCAG0BA,IAhJ5B;UAgJiDmM,mFAAuB,CAAC;UACnE2pB,QAAQ,GAAG,KAAKmC,sBAAL,CAA4Bj4B,IAA5B,EAAkCmM,YAAlC,CAAf;;UAGI0b,UAAU,GAAG/mB,QAAQ,CAACg1B,QAAD,EAAW7pB,oBAAX,CAAzB;;UACI4b,UAAU,KAAK,IAAnB,EAAyB;QACxBiO,QAAQ,GAAG,KAAKoC,sBAAL,CAA4BrQ,UAA5B,CAAX;;;aAGMiO,QAAP;;;;2CAG6B91B,IA5J/B,EA4JoDmM,YA5JpD;UA6JM2pB,QAAQ,GAAqB,IAAjC;;UAEI3pB,YAAY,IAAI,CAAhB,IAAqBA,YAAY,IAAI,CAAC,CAA1C,EAA6C;;YAExCgsB,aAAa,GAAGpuB,kBAAkB,CAAC,KAAKutB,gBAAN,EAAwBt3B,IAAxB,EAA8B,IAA9B,CAAtC;YACIm4B,aAAa,CAAC/xB,MAAlB,EACC,OAAO+xB,aAAa,CAAC7xB,MAArB;YAEG,KAAKkxB,eAAL,KAAyB,IAA7B,EAAmC,OAAOh2B,kBAAkB,CAAC,gCAAD,CAAzB;;YAC/B8U,aAAa,GAAG,KAAKkhB,eAAL,CAAqBY,0BAArB,CAAgDp4B,IAAhD,CAApB;;YACIsW,aAAJ,EACC,OAAOA,aAAP;;;MAGFwf,QAAQ,GAAG,KAAKyB,UAAL,CAAgBc,4BAAhB,CAA6Cr4B,IAA7C,EAAmDmM,YAAnD,CAAX;aAEO2pB,QAAP;;;;2CAG6BxO,OAhL/B;aAiLU,KAAKyC,mBAAL,CAAyBzC,OAAO,CAACpb,YAAjC,EAA+Cob,OAAO,CAACnb,YAAvD,CAAP;;;;2BAGYkS,MApLf,EAoL2C9e,KApL3C;UAqLMS,IAAI,GAAGqe,MAAM,CAACnS,YAAlB;;UACIlM,IAAI,KAAK,IAAb,EAAmB;eAASwB,kBAAkB,CAAC,MAAD,CAAzB;;;UACjB2K,YAAY,GAAG,CAAC,CAApB;UAEImsB,SAAS,GAAG,KAAhB;;UACIja,MAAM,CAACnK,gBAAX,EAA6B;QAC5BokB,SAAS,GAAGja,MAAM,CAAClK,QAAnB;OADD,MAEO;QACNmkB,SAAS,GAAG,KAAKhB,gBAAL,CAAsBjwB,GAAtB,CAA0BrH,IAA1B,CAAZ;;;UAGGqe,MAAM,CAACnK,gBAAX,EAA6B;;YAExB2T,UAAU,GAAG/mB,QAAQ,CAACvB,KAAD,EAAQ0M,oBAAR,CAAzB;;YACI4b,UAAU,KAAK,IAAnB,EAAyB;cACpB0Q,4BAA4B,GAAG,KAAKC,sBAAL,CAA4B3Q,UAA5B,CAAnC;UACAtoB,KAAK,GAAGg5B,4BAAR;;OALF,MAUK;YAEAE,eAAe,GAAG,IAAtB;;WACG;;UAEFA,eAAe,GAAG33B,QAAQ,CAAC,KAAKm3B,sBAAL,CAA4Bj4B,IAA5B,EAAkCmM,YAAlC,CAAD,EAAkDF,oBAAlD,CAA1B;;cACIwsB,eAAe,IAAI,IAAvB,EAA6B;YAC5Bz4B,IAAI,GAAGy4B,eAAe,CAACvsB,YAAvB;YACAC,YAAY,GAAGssB,eAAe,CAACtsB,YAA/B;YACAmsB,SAAS,GAAInsB,YAAY,IAAI,CAA7B;;SANF,QAQQssB,eAAe,IAAI,IAR3B;;;UAWGH,SAAJ,EAAe;aACT1K,SAAL,CAAe5tB,IAAf,EAAqBT,KAArB;OADD,MAEO;aACDg4B,UAAL,CAAgBmB,oBAAhB,CAAqC14B,IAArC,EAA2CT,KAA3C,EAAkD8e,MAAM,CAACnK,gBAAzD,EAA2E/H,YAA3E;;;;;;WAKI0rB,uBAAL,GAA+B,IAAIjuB,GAAJ,CAAQ,KAAK0tB,gBAAb,CAA/B;;;;mDAGqC7qB,QAnOvC,EAmO4DC,QAnO5D;UAoOMC,OAAO,GAAG1L,UAAU,CAACwL,QAAD,EAAWtB,SAAX,CAAxB;UACIyB,OAAO,GAAG3L,UAAU,CAACyL,QAAD,EAAWvB,SAAX,CAAxB;;UAEIwB,OAAO,CAACpN,KAAR,IAAiBqN,OAAO,CAACrN,KAAzB,IAAkCqN,OAAO,CAACrN,KAAR,CAAcuI,KAAd,IAAuB,CAA7D,EAAgE;QAC/D8E,OAAO,CAACrN,KAAR,CAAcoJ,qBAAd,CAAoCgE,OAAO,CAACpN,KAAR,CAAcqJ,WAAlD;;;;;8BAIesD,YA5OlB,EA4O+C3M,KA5O/C;UA6OMkN,QAAQ,GAAG1C,kBAAkB,CAAC,KAAKutB,gBAAN,EAAwBprB,YAAxB,EAAsC,IAAtC,CAAjC;;UAEIO,QAAQ,CAACrG,MAAb,EAAqB;QACpB+E,SAAS,CAAC8qB,8BAAV,CAAyCxpB,QAAQ,CAACnG,MAAlD,EAA2D/G,KAA3D;;;UAGG2M,YAAY,KAAK,IAArB,EAA2B;eAAS1K,kBAAkB,CAAC,cAAD,CAAzB;;;WACxB81B,gBAAL,CAAsB9vB,GAAtB,CAA0B0E,YAA1B,EAAwC3M,KAAxC;;;UAGI,KAAKu4B,oBAAL,IAA6B,IAA7B,IAAqCv4B,KAAK,KAAKkN,QAAQ,CAACnG,MAA5D,EAAoE;YAE/D,KAAKie,6BAAT,EAAwC;cACnC,KAAKyT,iBAAL,KAA2B,IAA/B,EAAqC;mBAASx2B,kBAAkB,CAAC,wBAAD,CAAzB;;;eAClCw2B,iBAAL,CAAuBjH,GAAvB,CAA2B7kB,YAA3B;SAFD,MAGO;eACD4rB,oBAAL,CAA0B5rB,YAA1B,EAAwC3M,KAAxC;;;;;;2CAK2BsoB,UAlQ/B;UAmQM1b,YAAY,GAAG0b,UAAU,CAAC1b,YAA9B;UAEIA,YAAY,IAAI,CAAC,CAArB,EACCA,YAAY,GAAG,KAAKwsB,8BAAL,CAAoC9Q,UAAU,CAAC3b,YAA/C,CAAf;UAEG0sB,wBAAwB,GAAG,KAAKX,sBAAL,CAA4BpQ,UAAU,CAAC3b,YAAvC,EAAqDC,YAArD,CAA/B;;UAGI0sB,wBAAwB,GAAG/3B,QAAQ,CAAC83B,wBAAD,EAA2B3sB,oBAA3B,CAAvC;;UACI4sB,wBAAwB,IAAI,IAAhC,EAAsC;eAC9BA,wBAAP;OADD,MAIK;eACG,IAAI5sB,oBAAJ,CAAyB4b,UAAU,CAAC3b,YAApC,EAAkDC,YAAlD,CAAP;;;;;mDAIoCgS,OArRvC;UAsRM,KAAKmZ,gBAAL,CAAsBptB,GAAtB,CAA0BiU,OAA1B,CAAJ,EACC,OAAO,CAAP;aAEM,KAAKoZ,UAAL,CAAgB3B,mBAAvB;;;;;;;;;;;0CAS4BgC,QAlS9B;WAmSOD,6BAAL,CAAmC35B,IAAnC,CAAwC45B,QAAxC;;;;;aAtRO,KAAKG,8BAAZ;KAbF;sBAemCx4B,KAfnC;WAgBOw4B,8BAAL,GAAsCx4B,KAAtC;;UACIA,KAAJ,EAAW;aACLy4B,iBAAL,GAAyB,IAAIrH,GAAJ,EAAzB;OADD,MAIK;YACA,KAAKqH,iBAAL,IAA0B,IAA9B,EAAoC;;;;;;kCACV,KAAKA,iBAA9B,mIAAiD;kBAAxC9rB,YAAwC;;kBAC5C4sB,YAAY,GAAG,KAAKxB,gBAAL,CAAsBptB,GAAtB,CAA0BgC,YAA1B,CAAnB;;kBACI,CAAC4sB,YAAL,EAAmB;gBAClBt3B,kBAAkB,CAAC,cAAD,CAAlB;eADD,MAEO;qBACDs2B,oBAAL,CAA0B5rB,YAA1B,EAAwC4sB,YAAxC;;;;;;;;;;;;;;;;;;;;;;;aAQG,KAAKvB,UAAZ;KApCF;sBAsCerS,SAtCf;WAuCOqS,UAAL,GAAkBrS,SAAlB;;;;;aAyFOnJ,iBAAiB,CAACiE,8BAAlB,CAAiD,KAAKsX,gBAAtD,CAAP;KAhIF;sBAkIe/3B,KAlIf;WAmIO+3B,gBAAL,GAAwBvb,iBAAiB,CAACgb,8BAAlB,CAAiDx3B,KAAjD,CAAxB;;;;;;;ICtHWqjB,UAAb;;AAAA;sBA4MamW,KAAZ;;;6BA1MgB,GAAuB,CAAvB;kCACA,GAA4B,CAA5B;uBA4CR,GAAkC,IAAlC;yBAKA,GAAoC,IAApC;wBAcD,GAA2BpnB,OAAO,CAACrM,IAAnC;0BAeC,GAA4B,CAA5B;kBAED,GAAoB,CAApB;uBACA,GAAyB,CAAzB;oBACA,GAAuB,KAAvB;qBA4DC,GAA8B,IAA9B;qBAkDA,GAAgC,IAAhC;+BA2nBA,GAAyB,IAAzB;+BACA,GAAyB,IAAzB;SAlnBFyzB,KAAL,GAAaA,KAAb;SAEKC,aAAL,GAAqB,EAArB;SACKC,iBAAL;SAEKC,gBAAL,GAAwB,EAAxB;SAEKhU,SAAL,GAAiB,IAAIiP,SAAJ,CAAc4E,KAAd,CAAjB;SACKI,eAAL,GAAuB,IAAI/B,cAAJ,CAAmB,KAAKlS,SAAxB,EAAmC6T,KAAK,CAAC7yB,eAAzC,CAAvB;SAEKkzB,YAAL,GAAoB,IAAIxvB,GAAJ,EAApB;SACKyvB,YAAL,GAAoB,IAAIzvB,GAAJ,EAApB;SACK0vB,iBAAL,GAAyB,CAAC,CAA1B;QAEIC,QAAQ,GAAI,IAAIlY,IAAJ,EAAD,CAAaC,OAAb,EAAf;SACK+K,SAAL,GAAkB,IAAIrL,IAAJ,CAASuY,QAAT,CAAD,CAAqBrY,IAArB,KAA8B,GAA/C;SACKoL,cAAL,GAAsB,CAAtB;SAEKkN,eAAL,GAAuB,EAAvB;SAEK9J,SAAL;;;;;;UA5Na+J,+EAAoB;aAC1Bx0B,IAAI,CAACC,SAAL,CAAe,KAAKgwB,SAApB,EAA+B,IAA/B,EAAsCuE,QAAD,GAAa,CAAb,GAAiB,CAAtD,CAAP;;;;;UAEaA,+EAAoB;aAC1B,KAAKC,MAAL,CAAYD,QAAZ,CAAP;;;;6BAGe/X,IAZjB;WAaOwT,SAAL,GAAiBjwB,IAAI,CAACG,KAAL,CAAWsc,IAAX,CAAjB;;;;2CAG6BgQ,UAhB/B;UAiBMiI,aAAa,GAAG5vB,kBAAkB,CAAC,KAAKyoB,WAAN,EAAmBd,UAAnB,EAA+B,IAA/B,CAAtC;UACIiI,aAAa,CAACvzB,MAAlB,EACC,OAAOuzB,aAAa,CAACrzB,MAArB;aAEM,CAAP;;;;0CA8H4B3G,GAnJ9B;UAoJMmJ,EAAE,GAAG,IAAI3E,aAAJ,EAAT;UAEIy1B,sBAAsB,GAAG,CAAC,CAA9B;UACIC,WAAW,GAAG,CAAlB;;WAEK,IAAIr7B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGmB,GAAG,CAAClB,MAAxB,EAAgCD,CAAC,EAAjC,EAAqC;YAChCO,CAAC,GAAGY,GAAG,CAACknB,MAAJ,CAAWroB,CAAX,CAAR;YAEIsN,kBAAkB,GAAI/M,CAAC,IAAI,GAAN,IAAeA,CAAC,IAAI,IAA7C;YAEI+M,kBAAkB,IAAI8tB,sBAAsB,IAAI,CAAC,CAArD,EACCA,sBAAsB,GAAGp7B,CAAzB;;YAEG,CAACsN,kBAAL,EAAyB;cACpB/M,CAAC,IAAI,IAAL,IAAa66B,sBAAsB,GAAG,CAAtC,IAA2CA,sBAAsB,IAAIC,WAAzE,EAAsF;YACrF/wB,EAAE,CAACzE,MAAH,CAAU,GAAV;;;UAEDu1B,sBAAsB,GAAG,CAAC,CAA1B;;;YAGG76B,CAAC,IAAI,IAAT,EACC86B,WAAW,GAAGr7B,CAAC,GAAG,CAAlB;YAEG,CAACsN,kBAAL,EACChD,EAAE,CAACzE,MAAH,CAAUtF,CAAV;;;aAGK+J,EAAE,CAAC7I,QAAH,EAAP;;;;;WAsDKilB,SAAL,CAAe8F,cAAf,CAA8B1H,cAA9B,GAA+C3R,OAAO,CAACoB,OAAR,CAAgB,KAAKgmB,KAAL,CAAW/R,oBAA3B,CAA/C;;;;;UAIIhU,IAAI,GAAG,IAAI4P,UAAJ,CAAe,KAAKmW,KAApB,CAAX;MAEA/lB,IAAI,CAACsX,YAAL,CAAkBtsB,IAAlB,CAAuBgB,KAAvB,CAA6BgU,IAAI,CAACsX,YAAlC,EAAgD,KAAK0O,aAArD;WACKC,iBAAL;;MAEAjmB,IAAI,CAACwmB,eAAL,CAAqBx7B,IAArB,CAA0BgB,KAA1B,CAAgCgU,IAAI,CAACwmB,eAArC,EAAsD,KAAKA,eAA3D;;UAEI,KAAKxF,QAAT,EAAmB;QAClBhhB,IAAI,CAAC8mB,cAAL,GAAsB,EAAtB;;QACA9mB,IAAI,CAAC8mB,cAAL,CAAoB97B,IAApB,CAAyBgB,KAAzB,CAA+BgU,IAAI,CAAC8mB,cAApC,EAAoD,KAAKhG,aAAL,IAAsB,EAA1E;;;UAGG,KAAKG,UAAT,EAAqB;QACpBjhB,IAAI,CAAC+mB,gBAAL,GAAwB,EAAxB;;QACA/mB,IAAI,CAAC+mB,gBAAL,CAAsB/7B,IAAtB,CAA2BgB,KAA3B,CAAiCgU,IAAI,CAAC+mB,gBAAtC,EAAwD,KAAKhG,eAAL,IAAwB,EAAhF;;;MAGD/gB,IAAI,CAACkS,SAAL,GAAiB,IAAIiP,SAAJ,CAAc,KAAKjP,SAAnB,CAAjB;MAEAlS,IAAI,CAACmmB,eAAL,GAAuB,IAAI/B,cAAJ,CAAmBpkB,IAAI,CAACkS,SAAxB,EAAmC,KAAK6T,KAAL,CAAW7yB,eAA9C,CAAvB;MACA8M,IAAI,CAAC6P,cAAL,CAAoBmX,QAApB,CAA6B,KAAKnX,cAAlC;MAEA7P,IAAI,CAACyX,eAAL,CAAqBzsB,IAArB,CAA0BgB,KAA1B,CAAgCgU,IAAI,CAACyX,eAArC,EAAsD,KAAKA,eAA3D;UAEI,CAAC,KAAKP,eAAL,CAAqB9gB,MAA1B,EACC4J,IAAI,CAACkX,eAAL,GAAuB,KAAKA,eAAL,CAAqBlX,IAArB,EAAvB;MAEDA,IAAI,CAACwV,eAAL,GAAuB,KAAKA,eAAL,CAAqBxV,IAArB,EAAvB;MAEAA,IAAI,CAAComB,YAAL,GAAoB,IAAIxvB,GAAJ,CAAQ,KAAK4oB,WAAb,CAApB;MACAxf,IAAI,CAACqmB,YAAL,GAAoB,IAAIzvB,GAAJ,CAAQ,KAAK6oB,WAAb,CAApB;MAEAzf,IAAI,CAACsmB,iBAAL,GAAyB,KAAK3N,gBAA9B;MACA3Y,IAAI,CAACqZ,SAAL,GAAiB,KAAKA,SAAtB;MACArZ,IAAI,CAACsZ,cAAL,GAAsB,KAAKA,cAA3B;MAEAtZ,IAAI,CAACqR,WAAL,GAAmB,KAAKA,WAAxB;aAEOrR,IAAP;;;;;WAkGK8mB,cAAL,GAAsB,IAAtB;WACKC,gBAAL,GAAwB,IAAxB;;;;;UAEkBE,2EAA2B;WACxCjB,aAAL,CAAmBv6B,MAAnB,GAA4B,CAA5B;UACIw7B,IAAI,KAAK,IAAb,EAAmB,KAAKjB,aAAL,CAAmBh7B,IAAnB,CAAwBgB,KAAxB,CAA8B,KAAKg6B,aAAnC,EAAkDiB,IAAlD;WACdhB,iBAAL;;;;uCAGyBl4B,GA1X3B;;UA4XMoa,IAAI,GAAGra,QAAQ,CAACC,GAAD,EAAM+J,WAAN,CAAnB;;UACIqQ,IAAI,KAAK,IAAb,EAAmB;YACd+e,QAAQ,GAAG,KAAKC,8BAAL,CAAoChf,IAApC,CAAf;;YACI+e,QAAQ,KAAK,IAAjB,EAAuB;;;;;;iCACHA,QAAnB,8HAA6B;kBAArBE,OAAqB;mBACvBC,4BAAL,CAAkCD,OAAlC;;;;;;;;;;;;;;;;;eAEInB,iBAAL;;;;;WAKGoB,4BAAL,CAAkCt5B,GAAlC;WACKk4B,iBAAL;;;;wCAG0B5c,KA5Y5B;WA6YOiO,YAAL,CAAkBiH,MAAlB,CAAyB,KAAKjH,YAAL,CAAkB7rB,MAAlB,GAA2B4d,KAApD,EAA2DA,KAA3D;WACK4c,iBAAL;;;;mDAGqCqB,MAjZvC;UAkZM36B,GAAG,GAAG26B,MAAM,CAAC/6B,KAAjB;;UACII,GAAG,KAAK,IAAZ,EAAkB;eAAS6B,kBAAkB,CAAC,cAAD,CAAzB;;;UAEhB+4B,mBAAmB,GAAG,CAAC,CAA3B;UACIC,kBAAkB,GAAG,CAAC,CAA1B;;WACK,IAAIh8B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGmB,GAAG,CAAClB,MAAxB,EAAgC,EAAED,CAAlC,EAAqC;YAChCO,CAAC,GAAGY,GAAG,CAACnB,CAAD,CAAX;;YACIO,CAAC,IAAI,IAAT,EAAe;cACVw7B,mBAAmB,IAAI,CAAC,CAA5B,EACCA,mBAAmB,GAAG/7B,CAAtB;UACDg8B,kBAAkB,GAAGh8B,CAArB;SAHD,MAKK,IAAIO,CAAC,IAAI,GAAL,IAAYA,CAAC,IAAI,IAArB,EACJ,SADI,KAGJ;;;UAGE07B,kBAAkB,GAAG,CAAC,CAA1B;UACIC,mBAAmB,GAAG,CAAC,CAA3B;;WACK,IAAIl8B,EAAC,GAAG,CAAb,EAAgBA,EAAC,GAAGmB,GAAG,CAAClB,MAAxB,EAAgC,EAAED,EAAlC,EAAqC;YAChCO,EAAC,GAAGY,GAAG,CAACnB,EAAD,CAAX;;YACIO,EAAC,IAAI,IAAT,EAAe;cACV07B,kBAAkB,IAAI,CAAC,CAA3B,EACCA,kBAAkB,GAAGj8B,EAArB;UACDk8B,mBAAmB,GAAGl8B,EAAtB;SAHD,MAKK,IAAIO,EAAC,IAAI,GAAL,IAAYA,EAAC,IAAI,IAArB,EACJ,SADI,KAGJ;;;;UAIEw7B,mBAAmB,IAAI,CAAC,CAAxB,IAA6BE,kBAAkB,IAAI,CAAC,CAAxD,EACC,OAAO,IAAP;UAEGE,SAAS,GAAkB,EAA/B;UACIC,aAAa,GAAG,CAApB;UACIC,WAAW,GAAGl7B,GAAG,CAAClB,MAAtB;;UAEI87B,mBAAmB,IAAI,CAAC,CAA5B,EAA+B;YAC1BA,mBAAmB,GAAG,CAA1B,EAA6B;cACxBO,aAAa,GAAG,IAAIhwB,WAAJ,CAAgBnL,GAAG,CAACH,SAAJ,CAAc,CAAd,EAAiB+6B,mBAAjB,CAAhB,CAApB;UACAI,SAAS,CAAC38B,IAAV,CAAe88B,aAAf;;;QAEDH,SAAS,CAAC38B,IAAV,CAAe,IAAI8M,WAAJ,CAAgB,IAAhB,CAAf;QACA8vB,aAAa,GAAGJ,kBAAkB,GAAG,CAArC;;;UAGGC,kBAAkB,IAAI,CAAC,CAA3B,EAA8B;QAC7BI,WAAW,GAAGH,mBAAd;;;UAGGG,WAAW,GAAGD,aAAlB,EAAiC;YAC5BG,YAAY,GAAGp7B,GAAG,CAACH,SAAJ,CAAco7B,aAAd,EAA6BC,WAAW,GAAGD,aAA3C,CAAnB;QACAD,SAAS,CAAC38B,IAAV,CAAe,IAAI8M,WAAJ,CAAgBiwB,YAAhB,CAAf;;;UAGGN,kBAAkB,IAAI,CAAC,CAAvB,IAA4BC,mBAAmB,GAAGF,kBAAtD,EAA0E;QACzEG,SAAS,CAAC38B,IAAV,CAAe,IAAI8M,WAAJ,CAAgB,IAAhB,CAAf;;YACI2vB,kBAAkB,GAAG96B,GAAG,CAAClB,MAAJ,GAAa,CAAtC,EAAyC;cACpCu8B,SAAS,GAAIr7B,GAAG,CAAClB,MAAJ,GAAag8B,kBAAd,GAAoC,CAApD;cACIQ,cAAc,GAAG,IAAInwB,WAAJ,CAAgBnL,GAAG,CAACH,SAAJ,CAAci7B,kBAAkB,GAAG,CAAnC,EAAsCO,SAAtC,CAAhB,CAArB;UACAL,SAAS,CAAC38B,IAAV,CAAei9B,cAAf;;;;aAIKN,SAAP;;;;iDAGmC55B,GAzdrC;UA0dMue,IAAI,GAAGxe,QAAQ,CAACC,GAAD,EAAM8O,IAAN,CAAnB;UACIsL,IAAI,GAAGra,QAAQ,CAACC,GAAD,EAAM+J,WAAN,CAAnB;UAEIowB,eAAe,GAAG,IAAtB;;UAEI5b,IAAJ,EAAU;aACJ6b,4BAAL;QACAD,eAAe,GAAG,IAAlB;OAFD,MAKK,IAAI/f,IAAJ,EAAW;YAEXigB,iBAAiB,GAAG,CAAC,CAAzB;YACIC,MAAM,GAAG,KAAKnW,SAAL,CAAe8F,cAA5B;;YACIqQ,MAAM,CAAC96B,IAAP,IAAemR,WAAW,CAACY,QAA/B,EAAyC;UACxC8oB,iBAAiB,GAAGC,MAAM,CAAC3F,2BAA3B;;;YAGG4F,aAAa,GAAG,CAAC,CAArB;;aACK,IAAI98B,CAAC,GAAG,KAAKw6B,aAAL,CAAmBv6B,MAAnB,GAA4B,CAAzC,EAA4CD,CAAC,IAAI,CAAjD,EAAoDA,CAAC,EAArD,EAAyD;cACpDiyB,CAAC,GAAG,KAAKuI,aAAL,CAAmBx6B,CAAnB,CAAR;cACIO,CAAC,GAAI0xB,CAAC,YAAY3gB,cAAd,GAAgC2gB,CAAhC,GAAoC,IAA5C;cACI8K,CAAC,GAAI9K,CAAC,YAAY5gB,IAAd,GAAsB4gB,CAAtB,GAA0B,IAAlC;;cAEI8K,CAAC,IAAI,IAAT,EAAe;YACdD,aAAa,GAAG98B,CAAhB;;WADD,MAKK,IAAIO,CAAC,IAAI,IAAL,IAAaA,CAAC,CAACiR,WAAF,IAAiBF,cAAc,CAACG,WAAf,CAA2BS,WAA7D,EAA0E;gBAC1ElS,CAAC,IAAI48B,iBAAT,EAA4B;cAC3BA,iBAAiB,GAAG,CAAC,CAArB;;;;;;;YAMCI,SAAS,GAAG,CAAC,CAAjB;YACIF,aAAa,IAAI,CAAC,CAAlB,IAAuBF,iBAAiB,IAAI,CAAC,CAAjD,EACCI,SAAS,GAAG/4B,IAAI,CAACC,GAAL,CAAS04B,iBAAT,EAA4BE,aAA5B,CAAZ,CADD,KAEK,IAAIA,aAAa,IAAI,CAAC,CAAtB,EACJE,SAAS,GAAGF,aAAZ,CADI,KAGJE,SAAS,GAAGJ,iBAAZ;;YAEGI,SAAS,IAAI,CAAC,CAAlB,EAAqB;cAEhBrgB,IAAI,CAACtP,SAAT,EAAoB;YACnBqvB,eAAe,GAAG,KAAlB;WADD,MAIK,IAAI/f,IAAI,CAACsgB,eAAT,EAA0B;gBAE1BH,aAAa,GAAG,CAAC,CAArB,EACC,KAAKI,kBAAL;;gBAEGN,iBAAiB,GAAG,CAAC,CAAzB,EAA4B;kBACvBO,iBAAiB,GAAG,KAAKzW,SAAL,CAAeuK,QAAvC;;mBACK,IAAIjxB,GAAC,GAAGm9B,iBAAiB,CAACl9B,MAAlB,GAA2B,CAAxC,EAA2CD,GAAC,IAAI,CAAhD,EAAmDA,GAAC,EAApD,EAAwD;oBACnDq4B,EAAE,GAAG8E,iBAAiB,CAACn9B,GAAD,CAA1B;;oBACIq4B,EAAE,CAACt2B,IAAH,IAAWmR,WAAW,CAACY,QAA3B,EAAqC;kBACpCukB,EAAE,CAACnB,2BAAH,GAAiC,CAAC,CAAlC;iBADD,MAEO;;;;;;SAjBX,MAyBK,IAAIva,IAAI,CAACtP,SAAT,EAAoB;cACpB,KAAK6Y,yBAAL,IAAkC,CAAC,KAAKkX,2BAA5C,EACCV,eAAe,GAAG,KAAlB;;;;UAICA,eAAJ,EAAqB;YAChBn6B,GAAG,KAAK,IAAZ,EAAkB;iBAASS,kBAAkB,CAAC,KAAD,CAAzB;;;aACfw3B,aAAL,CAAmBh7B,IAAnB,CAAwB+C,GAAxB;;aACKk4B,iBAAL;;;;;;UAKG4C,oBAAoB,GAAG,CAAC,CAA5B;UAEIr9B,CAAC,GAAG,KAAKw6B,aAAL,CAAmBv6B,MAAnB,GAA0B,CAAlC;;aACOD,CAAC,IAAI,CAAZ,EAAe;YACVuC,GAAG,GAAG,KAAKi4B,aAAL,CAAmBx6B,CAAnB,CAAV;YACIs9B,GAAG,GAAGh7B,QAAQ,CAACC,GAAD,EAAM+O,cAAN,CAAlB;YACIisB,GAAG,GAAGj7B,QAAQ,CAACC,GAAD,EAAM+J,WAAN,CAAlB;;YAEIgxB,GAAG,IAAI,IAAP,IAAgBC,GAAG,IAAI,IAAP,IAAeA,GAAG,CAACN,eAAvC,EAAyD;;SAAzD,MAEO,IAAIM,GAAG,IAAI,IAAP,IAAeA,GAAG,CAAClwB,SAAvB,EAAkC;UACxCgwB,oBAAoB,GAAGr9B,CAAvB;;;QAEDA,CAAC;;;;UAIEq9B,oBAAoB,IAAI,CAA5B,EAA+B;QAC9Br9B,CAAC,GAACq9B,oBAAF;;eACMr9B,CAAC,GAAG,KAAKw6B,aAAL,CAAmBv6B,MAA7B,EAAqC;cAChC0c,IAAI,GAAGra,QAAQ,CAAC,KAAKk4B,aAAL,CAAmBx6B,CAAnB,CAAD,EAAwBsM,WAAxB,CAAnB;;cACIqQ,IAAJ,EAAU;iBACJ6d,aAAL,CAAmBzH,MAAnB,CAA0B/yB,CAA1B,EAA6B,CAA7B;WADD,MAEO;YACNA,CAAC;;;;;WAKCy6B,iBAAL;;;;;WAIK,IAAIz6B,CAAC,GAAG,KAAKw6B,aAAL,CAAmBv6B,MAAnB,GAA4B,CAAzC,EAA4CD,CAAC,IAAI,CAAjD,EAAoDA,CAAC,EAArD,EAAyD;YACpDO,CAAC,GAAG,KAAKi6B,aAAL,CAAmBx6B,CAAnB,CAAR;;YACIO,CAAC,YAAY8Q,IAAjB,EAAuB;eACjBmpB,aAAL,CAAmBzH,MAAnB,CAA0B/yB,CAA1B,EAA6B,CAA7B;SADD,MAEO,IAAIO,CAAC,YAAY+Q,cAAjB,EAAkC;;;;;WAKrCmpB,iBAAL;;;;wCA2C0Bl4B,GAnoB5B;;UAqoBM6a,SAAS,GAAG9a,QAAQ,CAACC,GAAD,EAAMoK,SAAN,CAAxB;;UACIyQ,SAAJ,EAAe;;YAGV2C,OAAO,GAAG3C,SAAS,CAACrc,KAAxB;;YACIgf,OAAO,KAAK,IAAhB,EAAsB;iBAAS/c,kBAAkB,CAAC,SAAD,CAAzB;;;YAEpB+c,OAAO,CAAC3V,WAAR,IAAuB,IAA3B,EAAiC;cAC5B,CAAC2V,OAAO,CAAClY,OAAb,EAAsBkY,OAAO,CAAClY,OAAR,GAAkB,EAAlB;UACtBkY,OAAO,CAAClY,OAAR,CAAgB5H,MAAhB,GAAyB,CAAzB;;;;;;kCAEc8f,OAAO,CAAC3V,WAAtB,mIAAmC;kBAA1BozB,CAA0B;kBAC9B,KAAKjD,KAAL,CAAW7yB,eAAX,KAA+B,IAAnC,EAAyC,OAAO1E,kBAAkB,CAAC,kCAAD,CAAzB;kBACrCyE,GAAG,GAAG,KAAK8yB,KAAL,CAAW7yB,eAAX,CAA2BC,oBAA3B,CAAgD61B,CAAhD,EAAmD,IAAnD,CAAV;kBACI/1B,GAAG,CAACK,MAAJ,KAAe,IAAnB,EAAyB,OAAO9E,kBAAkB,CAAC,uBAAD,CAAzB;kBACrB+c,OAAO,CAAClY,OAAR,CAAgBpC,OAAhB,CAAwBgC,GAAG,CAACK,MAA5B,IAAsC,CAA1C,EAA6CiY,OAAO,CAAClY,OAAR,CAAgBrI,IAAhB,CAAqBiI,GAAG,CAACK,MAAzB;;;;;;;;;;;;;;;;;;;UAK5CvF,GAAG,KAAK,IAAZ,EAAkB;eAASS,kBAAkB,CAAC,KAAD,CAAzB;;;WACfipB,eAAL,CAAqBzsB,IAArB,CAA0B+C,GAA1B;;;;uCAKyBk7B,eA/pB3B;UAgqBM,OAAOA,eAAP,KAA2B,WAA/B,EAA2C;YACtCl7B,GAAG,GAAG,KAAK0pB,eAAL,CAAqBkL,GAArB,EAAV;eACOr0B,eAAe,CAACP,GAAD,CAAtB;OAFD,MAGO;YACHk7B,eAAe,GAAG,KAAKxR,eAAL,CAAqBhsB,MAA1C,EAAkD;gBAC3C,IAAIyC,KAAJ,CAAU,gCAAV,CAAN;;;YAGG4pB,MAAM,GAAG,KAAKL,eAAL,CAAqB8G,MAArB,CAA4B,KAAK9G,eAAL,CAAqBhsB,MAArB,GAA8Bw9B,eAA1D,EAA2EA,eAA3E,CAAb;eACO36B,eAAe,CAACwpB,MAAD,CAAtB;;;;;;aAKO,KAAKL,eAAL,CAAqB,KAAKA,eAAL,CAAqBhsB,MAArB,GAA8B,CAAnD,CAAP;;;;;WAIIymB,SAAL,CAAeoP,KAAf;WAEKkF,eAAL,CAAqB/6B,MAArB,GAA8B,CAA9B;WAEK6kB,cAAL,GAAsB3R,OAAO,CAACrM,IAA9B;WACKkjB,eAAL,GAAuB7W,OAAO,CAACrM,IAA/B;WAEK+e,WAAL,GAAmB,IAAnB;;;;;MAIAjkB,KAAK,CAACK,MAAN,CAAc,KAAKykB,SAAL,CAAe8F,cAAf,CAA8BzqB,IAA9B,IAAsCmR,WAAW,CAACY,QAAhE;UACI4pB,kBAAkB,GAAG,KAAKhX,SAAL,CAAe8F,cAAf,CAA8B0K,2BAAvD;;UAEIwG,kBAAkB,IAAI,CAAC,CAA3B,EAA8B;QAC7BA,kBAAkB,GAAG,CAArB;;;WAGI,IAAI19B,CAAC,GAAG,KAAKw6B,aAAL,CAAmBv6B,MAAnB,GAA4B,CAAzC,EAA4CD,CAAC,IAAI09B,kBAAjD,EAAqE19B,CAAC,EAAtE,EAA0E;YACrEuC,GAAG,GAAG,KAAKi4B,aAAL,CAAmBx6B,CAAnB,CAAV;YACIu9B,GAAG,GAAGj7B,QAAQ,CAACC,GAAD,EAAM+J,WAAN,CAAlB;YACIgxB,GAAG,GAAGh7B,QAAQ,CAACC,GAAD,EAAM+O,cAAN,CAAlB;YAEIisB,GAAG,IAAI,IAAX,EAAiB;YACbD,GAAJ,EAAS;;YAELC,GAAG,CAAClwB,SAAJ,IAAiBkwB,GAAG,CAACjwB,kBAAzB,EAA6C;eACvCktB,aAAL,CAAmBzH,MAAnB,CAA0B/yB,CAA1B,EAA6B,CAA7B;;eACKy6B,iBAAL;SAFD,MAGO;;;;;;;;UAMWrO,8EAA8B;UAC7C,KAAK1F,SAAL,CAAe8F,cAAf,CAA8BzqB,IAA9B,IAAsCmR,WAAW,CAACY,QAAtD,EACC,KAAK6pB,6BAAL;WAEIjX,SAAL,CAAekX,GAAf,CAAmBxR,OAAnB;;;;kCAGoB9qB,IA5tBtB,EA4tBkCuuB,qBA5tBlC;;WA8tBOmL,eAAL,CAAqB/6B,MAArB,GAA8B,CAA9B;UAEI49B,UAAU,GAAG,KAAKtD,KAAL,CAAW5O,aAAX,CAAyBrqB,IAAzB,CAAjB;UACI,CAACu8B,UAAU,CAACjzB,MAAZ,IAAsBizB,UAAU,CAACj+B,KAAX,IAAoB,CAAC,CAA/C,EACCi+B,UAAU,CAACj+B,KAAX,GAAmB,CAAnB;WAEIklB,cAAL,GAAsB+Y,UAAtB;UAEIhO,qBAAJ,EACC,KAAKiL,iBAAL;;;;oDAGqCtK,aA1uBxC,EA0uBkEzqB,IA1uBlE;WA2uBO2gB,SAAL,CAAemF,IAAf,CAAoB3Y,WAAW,CAAC0kB,0BAAhC,EAA4D,KAAK3L,eAAL,CAAqBhsB,MAAjF;WACKymB,SAAL,CAAe8F,cAAf,CAA8B1H,cAA9B,GAA+C3R,OAAO,CAACoB,OAAR,CAAgBic,aAAhB,CAA/C;WAEKb,8BAAL,CAAoC5pB,IAApC;;;;mDAGqCA,IAjvBvC;;UAmvBMA,IAAI,IAAI,IAAZ,EAAkB;aACZ,IAAI/F,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG+F,IAAI,CAAC9F,MAAzB,EAAiCD,CAAC,EAAlC,EAAsC;cACjC,EAAE,OAAO+F,IAAI,CAAC/F,CAAD,CAAX,KAAmB,QAAnB,IAA+B,OAAO+F,IAAI,CAAC/F,CAAD,CAAX,KAAmB,QAApD,CAAJ,EAAmE;kBAC5D,IAAI0C,KAAJ,CAAU,4GAAV,CAAN;;;eAGI+mB,mBAAL,CAAyBvhB,KAAK,CAAC+D,MAAN,CAAalG,IAAI,CAAC/F,CAAD,CAAjB,CAAzB;;;;;;;UAME,KAAK0mB,SAAL,CAAe8F,cAAf,CAA8BzqB,IAA9B,IAAsCmR,WAAW,CAAC0kB,0BAAtD,EAAkF;aAC5E9S,cAAL,GAAsB3R,OAAO,CAACrM,IAA9B;aACK+e,WAAL,GAAmB,IAAnB;eACO,IAAP;;;aAGM,KAAP;;;;;UAII,KAAKa,SAAL,CAAe8F,cAAf,CAA8BzqB,IAA9B,IAAsCmR,WAAW,CAAC0kB,0BAAtD,EAAkF;cAC3E,IAAIvsB,cAAJ,CAAmB,wEAAsE,KAAKqb,SAAL,CAAegJ,cAAxG,CAAN;;;UAGGoO,6BAA6B,GAAG,KAAKpX,SAAL,CAAe8F,cAAf,CAA8ByK,+BAAlE;UAEI8G,WAAW,GAAqB,IAApC;;aACO,KAAK9R,eAAL,CAAqBhsB,MAArB,GAA8B69B,6BAArC,EAAoE;YAC/DpM,SAAS,GAAG,KAAKjH,kBAAL,EAAhB;YACIsT,WAAW,KAAK,IAApB,EACCA,WAAW,GAAGrM,SAAd;;;WAGG9E,YAAL,CAAkB1Z,WAAW,CAAC0kB,0BAA9B;;UAEImG,WAAJ,EAAiB;YACZA,WAAW,YAAYnoB,IAA3B,EACC,OAAO,IAAP,CAFe;;;YAMZooB,SAAS,GAAGv7B,UAAU,CAACs7B,WAAD,EAAc71B,KAAd,CAA1B,CANgB;;;YAUZ81B,SAAS,CAAC5xB,SAAV,IAAuBS,SAAS,CAACW,YAArC,EAAmD;iBAC3CwwB,SAAS,CAAC7xB,WAAV,CAAsB1K,QAAtB,EAAP;SAXe;;;;eAgBTu8B,SAAS,CAAC7xB,WAAjB;;;aAGM,IAAP;;;;6BAGenK,OA9yBjB,EA8yBkCgzB,SA9yBlC;UA+yBM,CAACA,SAAL,EAAgB;YACX,KAAKsG,cAAL,IAAuB,IAA3B,EAAiC,KAAKA,cAAL,GAAsB,EAAtB;;aAC5BA,cAAL,CAAoB97B,IAApB,CAAyBwC,OAAzB;OAFD,MAGO;YACF,KAAKu5B,gBAAL,IAAyB,IAA7B,EAAmC,KAAKA,gBAAL,GAAwB,EAAxB;;aAC9BA,gBAAL,CAAsB/7B,IAAtB,CAA2BwC,OAA3B;;;;;;WAKIi8B,sBAAL,GAA8B,IAA9B;WACKC,sBAAL,GAA8B,IAA9B;;;;;aAjyBO,KAAKxX,SAAL,CAAeyX,KAAtB;;;;;aAIO,KAAK3D,aAAZ;;;;;;;;UAOK,KAAK5U,WAAV,EAAwB,OAAO,EAAP;aACjB,KAAKoV,eAAZ;;;;;aAIO,KAAKA,eAAZ;;;;;aAIO,KAAKM,cAAZ;;;;;aAKO,KAAKC,gBAAZ;;;;;aAKO,KAAKZ,eAAZ;;;;;aAOO,KAAKD,gBAAZ;;;;;aAOO,KAAKE,YAAZ;;;;;aAKO,KAAKC,YAAZ;;;;;aAKO,KAAKC,iBAAZ;;;;;UAWIhS,OAAO,GAAG,KAAKhE,cAAnB;;UACIgE,OAAO,CAACle,MAAZ,EAAoB;eACZ,IAAP;OADD,MAEO;YACFke,OAAO,CAACxnB,IAAR,KAAiB,IAArB,EAA2B;iBAAS0B,kBAAkB,CAAC,cAAD,CAAzB;;;eACtB8lB,OAAO,CAACxnB,IAAR,CAAaG,QAAb,EAAP;;;;;;aAKM,KAAKilB,SAAL,CAAe8F,cAAf,CAA8B1H,cAA9B,CAA6CtQ,IAA7C,EAAP;KApGF;sBAuGoBzT,KAvGpB;WAwGO2lB,SAAL,CAAe8F,cAAf,CAA8B1H,cAA9B,GAA+C/jB,KAAK,CAACyT,IAAN,EAA/C;;;;;aAIO,KAAKkS,SAAL,CAAe0J,aAAf,CAA6BpG,eAA7B,CAA6CxV,IAA7C,EAAP;KA5GF;sBA+GqBzT,KA/GrB;WAgHO2lB,SAAL,CAAe0J,aAAf,CAA6BpG,eAA7B,GAA+CjpB,KAAK,CAACyT,IAAN,EAA/C;;;;;aAIO,CAAC,KAAKsQ,cAAL,CAAoBla,MAArB,IAA+B,CAAC,KAAK4qB,QAA5C;;;;;aAIO,KAAKF,aAAL,IAAsB,IAAtB,IAA8B,KAAKA,aAAL,CAAmBr1B,MAAnB,GAA4B,CAAjE;;;;;aAIO,KAAKs1B,eAAL,IAAwB,IAAxB,IAAgC,KAAKA,eAAL,CAAqBt1B,MAArB,GAA8B,CAArE;;;;;UAII,KAAKg+B,sBAAT,EAAkC;YAC7B3zB,EAAE,GAAG,IAAI3E,aAAJ,EAAT;;;;;;gCAEsB,KAAK60B,aAA3B,mIAA0C;gBAAjC9E,SAAiC;;gBAErC0I,WAAW,GAAG97B,QAAQ,CAACozB,SAAD,EAAYppB,WAAZ,CAA1B;;gBACI8xB,WAAW,KAAK,IAApB,EAA0B;cACzB9zB,EAAE,CAACzE,MAAH,CAAUu4B,WAAW,CAACr9B,KAAtB;;;;;;;;;;;;;;;;;;aAIGs9B,YAAL,GAAoB,KAAKC,qBAAL,CAA2Bh0B,EAAE,CAAC7I,QAAH,EAA3B,CAApB;aACKw8B,sBAAL,GAA8B,KAA9B;;;aAGM,KAAKI,YAAZ;;;;;UAoCI,KAAKH,sBAAT,EAAkC;aAC5BK,YAAL,GAAoB,EAApB;;;;;;gCAEqB,KAAK/D,aAA1B,mIAAyC;gBAAjC9E,SAAiC;;gBAEpCvU,GAAG,GAAG7e,QAAQ,CAACozB,SAAD,EAAYjZ,GAAZ,CAAlB;;gBACI0E,GAAG,KAAK,IAAZ,EAAkB;mBACZod,YAAL,CAAkB/+B,IAAlB,CAAuB2hB,GAAG,CAACxE,IAA3B;;;;;;;;;;;;;;;;;;aAIGuhB,sBAAL,GAA8B,KAA9B;;;aAGM,KAAKK,YAAZ;;;;;aAKO,KAAK7X,SAAL,CAAe8F,cAAf,CAA8BhD,sBAArC;KAtMF;sBAwM4BzoB,KAxM5B;WAyMO2lB,SAAL,CAAe8F,cAAf,CAA8BhD,sBAA9B,GAAuDzoB,KAAvD;;;;;UA0EIwB,GAAG,GAAY,EAAnB;UAEIi8B,aAAJ;;;;;;8BACc,KAAKxD,eAAnB,mIAAoC;cAA3Bz6B,CAA2B;;cAC/BA,CAAC,CAAC0qB,kBAAF,KAAyB,IAA7B,EAAmC;mBAASjoB,kBAAkB,CAAC,sBAAD,CAAzB;;;UACrCzC,CAAC,CAAC0hB,mBAAF,GAAwB1hB,CAAC,CAAC0qB,kBAAF,CAAqB2L,WAA7C;;cAEI,KAAKlQ,SAAL,CAAe+X,eAAf,CAA+Bl+B,CAAC,CAAC0hB,mBAAjC,KAAyD,IAA7D,EAAoE;gBAC/Duc,aAAa,IAAI,IAArB,EACCA,aAAa,GAAG,IAAIpzB,GAAJ,EAAhB;YAEDozB,aAAa,CAACj+B,CAAC,CAAC0hB,mBAAF,CAAsBxgB,QAAtB,EAAD,CAAb,GAAkDlB,CAAC,CAAC0qB,kBAAF,CAAqByL,SAAvE;;;;;;;;;;;;;;;;;;UAIE8H,aAAa,IAAI,IAArB,EACCj8B,GAAG,CAAC,eAAD,CAAH,GAAuBi8B,aAAvB;MAEDj8B,GAAG,CAAC,kBAAD,CAAH,GAA0B,KAAKmkB,SAAL,CAAegY,YAAf,EAA1B;MACAn8B,GAAG,CAAC,gBAAD,CAAH,GAAwB,KAAK8hB,cAAL,CAAoBqS,SAA5C;MAEAn0B,GAAG,CAAC,WAAD,CAAH,GAAmBgb,iBAAiB,CAAC8D,YAAlB,CAA+B,KAAK4K,eAApC,CAAnB;MAEA1pB,GAAG,CAAC,cAAD,CAAH,GAAsBgb,iBAAiB,CAAC8D,YAAlB,CAA+B,KAAKmZ,aAApC,CAAtB;MAEAj4B,GAAG,CAAC,gBAAD,CAAH,GAAwBgb,iBAAiB,CAAC8D,YAAlB,CAA+B,KAAK2Z,eAApC,CAAxB;;UAEG,CAAC,KAAKtP,eAAL,CAAqB9gB,MAAzB,EAAiC;YAC5B,KAAK8gB,eAAL,CAAqBpqB,IAArB,KAA8B,IAAlC,EAAwC;iBAAS0B,kBAAkB,CAAC,2BAAD,CAAzB;;;QAC1CT,GAAG,CAAC,qBAAD,CAAH,GAA6B,KAAKmpB,eAAL,CAAqBpqB,IAArB,CAA0BlC,gBAAvD;;;MAGDmD,GAAG,CAAC,aAAD,CAAH,GAAqBgb,iBAAiB,CAACohB,sBAAlB,CAAyC,KAAK3K,WAA9C,CAArB;MACAzxB,GAAG,CAAC,aAAD,CAAH,GAAqBgb,iBAAiB,CAACohB,sBAAlB,CAAyC,KAAK1K,WAA9C,CAArB;MACA1xB,GAAG,CAAC,SAAD,CAAH,GAAiB,KAAK4qB,gBAAtB;MACA5qB,GAAG,CAAC,WAAD,CAAH,GAAmB,KAAKsrB,SAAxB;MACAtrB,GAAG,CAAC,gBAAD,CAAH,GAAwB,KAAKurB,cAA7B;MAEAvrB,GAAG,CAAC,gBAAD,CAAH,GAAwB,KAAKq8B,oBAA7B;;MAGAr8B,GAAG,CAAC,kBAAD,CAAH,GAA0B,KAAKg4B,KAAL,CAAW7W,iBAArC;aAEOnhB,GAAP;KA9TF;sBAgUexB,KAhUf;UAiUMmd,OAAO,GAAGnd,KAAd;UAEI89B,YAAY,GAAG3gB,OAAO,CAAC,gBAAD,CAA1B;;UACI2gB,YAAY,IAAI,IAApB,EAA0B;cACnB,IAAIxzB,cAAJ,CAAmB,wCAAnB,CAAN;OADD,MAGK,IAAIhK,QAAQ,CAACw9B,YAAD,CAAR,GAAyB,KAAKC,yBAAlC,EAA6D;cAC3D,IAAIzzB,cAAJ,CAAmB,qEAAmEwzB,YAAnE,GAAgF,oBAAhF,GAAqG,KAAKC,yBAA1G,GAAoI,mBAAvJ,CAAN;;;WAGIpY,SAAL,CAAeqY,YAAf,CAA4B7gB,OAAO,CAAC,kBAAD,CAAnC,EAAyD,KAAKqc,KAA9D;WACKlW,cAAL,CAAoBqS,SAApB,GAAgCxY,OAAO,CAAC,gBAAD,CAAvC;WAEKwc,gBAAL,GAAwBnd,iBAAiB,CAACsE,sBAAlB,CAAyC3D,OAAO,CAAC,WAAD,CAAhD,CAAxB;WAEKsc,aAAL,GAAqBjd,iBAAiB,CAACsE,sBAAlB,CAAyC3D,OAAO,CAAC,cAAD,CAAhD,CAArB;WACKuc,iBAAL;;WAGKO,eAAL,GAAuBzd,iBAAiB,CAACsE,sBAAlB,CAAyC3D,OAAO,CAAC,gBAAD,CAAhD,CAAvB;UAEI8gB,uBAAuB,GAAG9gB,OAAO,CAAC,qBAAD,CAArC;;UACI8gB,uBAAuB,IAAI,IAA/B,EAAqC;YAChCC,UAAU,GAAG,IAAIlgC,IAAJ,CAASigC,uBAAuB,CAACv9B,QAAxB,EAAT,CAAjB;aACKiqB,eAAL,GAAuB,KAAK6O,KAAL,CAAW5O,aAAX,CAAyBsT,UAAzB,CAAvB;;;WAGIrE,YAAL,GAAoBrd,iBAAiB,CAAC2hB,sBAAlB,CAAyChhB,OAAO,CAAC,aAAD,CAAhD,CAApB;WACK2c,YAAL,GAAoBtd,iBAAiB,CAAC2hB,sBAAlB,CAAyChhB,OAAO,CAAC,aAAD,CAAhD,CAApB;WACK4c,iBAAL,GAAyBz5B,QAAQ,CAAC6c,OAAO,CAAC,SAAD,CAAR,CAAjC;WACK2P,SAAL,GAAiBxsB,QAAQ,CAAC6c,OAAO,CAAC,WAAD,CAAR,CAAzB;WACK4P,cAAL,GAAsBzsB,QAAQ,CAAC6c,OAAO,CAAC,gBAAD,CAAR,CAA9B;;UAGIihB,cAAc,GAAGjhB,OAAO,CAAC,eAAD,CAA5B;;;;;;8BAEa,KAAK8c,eAAlB,mIAAmC;cAA3Bz6B,CAA2B;cAC9B6+B,iBAAiB,GAAG,KAAK1Y,SAAL,CAAe+X,eAAf,CAA+Bl+B,CAAC,CAAC0hB,mBAAjC,CAAxB;;cACImd,iBAAiB,IAAI,IAAzB,EAAgC;YAC/B7+B,CAAC,CAAC0qB,kBAAF,GAAuBmU,iBAAiB,CAACxW,IAAlB,EAAvB;WADD,MAEO;gBACFyW,kBAAkB,GAAGF,cAAc,CAAC5+B,CAAC,CAAC0hB,mBAAF,CAAsBxgB,QAAtB,EAAD,CAAvC;YACAlB,CAAC,CAAC0qB,kBAAF,GAAuB,IAAI0K,SAAS,CAACO,MAAd,CAAqBmJ,kBAArB,EAAyC,KAAK9E,KAA9C,CAAvB;;;;;;;;;;;;;;;;;;;;;UAiPE,KAAKC,aAAL,CAAmBv6B,MAAnB,GAA4B,CAAhC,EAAmC;aAE7B,IAAID,CAAC,GAAG,KAAKw6B,aAAL,CAAmBv6B,MAAnB,GAA4B,CAAzC,EAA4CD,CAAC,IAAI,CAAjD,EAAoDA,CAAC,EAArD,EAAyD;cACpDuC,GAAG,GAAG,KAAKi4B,aAAL,CAAmBx6B,CAAnB,CAAV;cACIuC,GAAG,YAAY+O,cAAnB,EACC;cACGqL,IAAI,GAAG,KAAK6d,aAAL,CAAmBx6B,CAAnB,CAAX;;cACI2c,IAAI,YAAYrQ,WAApB,EAAiC;gBAC5BqQ,IAAI,CAACtP,SAAT,EACC,OAAO,IAAP,CADD,KAEK,IAAIsP,IAAI,CAACsgB,eAAT,EACJ;;;;;aAKG,KAAP;;;;;WAIK,IAAIj9B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKw6B,aAAL,CAAmBv6B,MAAvC,EAA+CD,CAAC,EAAhD,EAAmD;YAC9C,KAAKw6B,aAAL,CAAmBx6B,CAAnB,aAAiCsM,WAArC,EACC,OAAO,IAAP;;;aAEK,KAAP;;;;;WAIK,IAAItM,CAAC,GAAG,KAAKw6B,aAAL,CAAmBv6B,MAAnB,GAA4B,CAAzC,EAA4CD,CAAC,IAAI,CAAjD,EAAoDA,CAAC,EAArD,EAAyD;;YAEpDs9B,GAAG,GAAGh7B,QAAQ,CAAC,KAAKk4B,aAAL,CAAmBx6B,CAAnB,CAAD,EAAwBsR,cAAxB,CAAlB;;YACIgsB,GAAG,YAAYhsB,cAAf,IAAiCgsB,GAAG,CAAC9rB,WAAJ,IAAmBF,cAAc,CAACG,WAAf,CAA2BS,WAAnF,EAAgG;iBACxF,IAAP;;;;aAIK,KAAP;;;;;;;ACvnBF,IAAI,CAACnI,MAAM,CAACE,SAAZ,EAAuB;EACtBF,MAAM,CAACE,SAAP,GAAmB,SAASA,SAAT,CAAmB8Y,IAAnB;WACX,OAAOA,IAAP,KAAgB,QAAhB,IAA4BC,QAAQ,CAACD,IAAD,CAApC,IAA8CA,IAAI,GAAG,CAAC,gBAAtD,IAA0EA,IAAI,GAAG,gBAAjF,IAAqG9e,IAAI,CAAC0W,KAAL,CAAWoI,IAAX,MAAqBA,IAAjI;GADD;;;AAKD,IAAaE,OAAb;;AAAA;;;;;;;;;2BAEQ,GAAoB,EAApB;qCAEA,GAA8B,EAA9B;yBA0hBC,GAA+B,EAA/B;wCA+tBD,GAA0C,KAA1C;0BAmiBC,GAAiD,IAAjD;4BAGA,GAAmE,IAAnE;gCACA,GAAkC,KAAlC;uCAEA,GAAkD,IAAlD;8BASA,GAAgC,KAAhC;6BACA,GAAyC,IAAzC;iCAEA,GAAkC,CAAlC;mBAEA,GAAwB,IAAxB;;;QA/uDHpf,gBAAJ;QACIoZ,KAAK,GAA4B,IAArC;QACIiG,IAAI,GAAmB,IAA3B;;QAEI/jB,SAAS,CAAC,CAAD,CAAT,YAAwBuE,SAA5B,EAAuC;MACtCG,gBAAgB,GAAG1E,SAAS,CAAC,CAAD,CAA5B;;UAEI,OAAOA,SAAS,CAAC,CAAD,CAAhB,KAAwB,WAA5B,EAAyC;QACxC8d,KAAK,GAAG9d,SAAS,CAAC,CAAD,CAAjB;OAJqC;;;YAQjCgkB,qBAAL,GAA6Btf,gBAA7B,CARsC;KAAvC,MAUO;UACF,OAAO1E,SAAS,CAAC,CAAD,CAAhB,KAAwB,QAA5B,EAAsC;YACjCikB,UAAU,GAAGjkB,SAAS,CAAC,CAAD,CAA1B;QACA+jB,IAAI,GAAGzc,IAAI,CAACG,KAAL,CAAWwc,UAAX,CAAP;OAFD,MAGO;QACNF,IAAI,GAAG/jB,SAAS,CAAC,CAAD,CAAhB;;;;;QAKE8d,KAAK,IAAI,IAAb,EACC,MAAKoG,gBAAL,GAAwB,IAAIrG,qBAAJ,CAA0BC,KAA1B,CAAxB;UAEIqG,UAAL,GAAkB,IAAIlY,GAAJ,EAAlB;;;QAII8X,IAAI,KAAK,IAAb,EAAmB;UACdK,UAAU,GAAYL,IAA1B;UAEIM,UAAU,GAAGD,UAAU,CAAC,YAAD,CAA3B;UACIC,UAAU,IAAI,IAAlB,EACC,MAAM,IAAI9gB,KAAJ,CAAU,yEAAV,CAAN;UAEG+gB,cAAc,GAAGpiB,QAAQ,CAACmiB,UAAD,CAA7B;;UACIC,cAAc,GAAG,MAAKC,iBAA1B,EAA4C;cACrC,IAAIhhB,KAAJ,CAAU,qFAAV,CAAN;OADD,MAGK,IAAI+gB,cAAc,GAAG,MAAKE,2BAA1B,EAAsD;cACpD,IAAIjhB,KAAJ,CAAU,0FAAV,CAAN;OADI,MAGA,IAAI+gB,cAAc,IAAI,MAAKC,iBAA3B,EAA6C;QACjDvhB,OAAO,CAACC,IAAR,CAAa,iIAAb;;;UAGGwhB,SAAS,GAAGL,UAAU,CAAC,MAAD,CAA1B;UACIK,SAAS,IAAI,IAAjB,EACC,MAAM,IAAIlhB,KAAJ,CAAU,wEAAV,CAAN;UAEGmhB,WAAJ;;UACIA,WAAW,GAAGN,UAAU,CAAC,UAAD,CAA5B,EAA0C;cACpCF,gBAAL,GAAwB9F,iBAAiB,CAACuG,uBAAlB,CAA0CD,WAA1C,CAAxB;;;YAGIV,qBAAL,GAA6B1gB,UAAU,CAAC8a,iBAAiB,CAACQ,qBAAlB,CAAwC6F,SAAxC,CAAD,EAAqDlgB,SAArD,CAAvC;;YAEKqgB,UAAL;;;;;;;;;;;;;;;;;UAMGC,qBAAqB,GAAGzG,iBAAiB,CAACI,qBAAlB,CAAwC,KAAKwF,qBAA7C,CAA5B;UAEKI,UAAU,GAAY,EAA3B;MACAA,UAAU,CAAC,YAAD,CAAV,GAA2B,KAAKG,iBAAhC;MACAH,UAAU,CAAC,MAAD,CAAV,GAAqBS,qBAArB;UAEI,KAAKX,gBAAL,IAAyB,IAA7B,EACCE,UAAU,CAAC,UAAD,CAAV,GAAyBhG,iBAAiB,CAAC0G,uBAAlB,CAA0C,KAAKZ,gBAA/C,CAAzB;aAEM5c,IAAI,CAACC,SAAL,CAAe6c,UAAf,CAAP;;;;;WAIKW,aAAL,CAAmB,YAAnB;WAEKC,MAAL,GAAc,IAAIC,UAAJ,CAAe,IAAf,CAAd;;WACKD,MAAL,CAAYE,cAAZ,CAA2BC,qBAA3B,CAAiD,KAAKC,2BAAL,CAAiCC,IAAjC,CAAsC,IAAtC,CAAjD;;WAEKC,YAAL;;;;;UAII,KAAKN,MAAL,KAAgB,IAApB,EAA0B;eAASnhB,kBAAkB,CAAC,aAAD,CAAzB;;;WACvBmhB,MAAL,CAAYO,WAAZ;;;;;WAIKR,aAAL,CAAmB,gBAAnB;;UACI,KAAKC,MAAL,KAAgB,IAApB,EAA0B;eAASnhB,kBAAkB,CAAC,aAAD,CAAzB;;;WACvBmhB,MAAL,CAAYQ,QAAZ;;;;;UAII,KAAKxB,qBAAL,CAA2BlU,YAA3B,CAAwCvD,GAAxC,CAA4C,aAA5C,CAAJ,EAA+D;YAC1DkZ,eAAe,GAAG,KAAKC,KAAL,CAAWC,cAAX,CAA0BtQ,IAA1B,EAAtB;aAEKuQ,UAAL,CAAgB,IAAIhmB,IAAJ,CAAS,aAAT,CAAhB,EAAyC,KAAzC;aAEKimB,gBAAL;aAEKH,KAAL,CAAWC,cAAX,GAA4BF,eAA5B;;;WAGIC,KAAL,CAAWR,cAAX,CAA0BY,sBAA1B;;;;;WAIKC,aAAL,CAAmB,CAAnB;aACO,KAAKC,WAAZ;;;;kCAWoBC,mBAlMtB;UAmMM,CAAC,KAAKC,sBAAV,EACC,KAAKC,wBAAL;WAEIN,gBAAL,CAAsBI,mBAAtB;;;;;UAGuBA,0FAAsB;UACzC,KAAKG,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAeC,WAAf;UAEGC,kBAAkB,GAAGL,mBAAmB,GAAG,CAA/C;WACKM,uBAAL;;UAEI,CAAC,KAAKC,oBAAV,EAAgC;aAC1BA,oBAAL,GAA4BF,kBAA5B;;YAEI,CAAC,KAAKG,WAAV,EAAuB;gBAChB,IAAIva,cAAJ,CAAmB,mEAAnB,CAAN;;;aAGI8Y,MAAL,CAAY0B,WAAZ,GAA0B,KAA1B;;aACK1B,MAAL,CAAY2B,WAAZ;;YAEI,KAAKJ,uBAAL,IAAgC,CAApC,EACC,KAAKvB,MAAL,CAAYE,cAAZ,CAA2B0B,6BAA3B,GAA2D,IAA3D;;;UAGEC,iBAAiB,GAAG,IAAIrD,SAAJ,EAAxB;MACAqD,iBAAiB,CAACC,KAAlB;UAEIC,yBAAyB,GAAG,KAAhC;;SACG;YACE;UACHA,yBAAyB,GAAG,KAAKC,kBAAL,EAA5B;SADD,CAEE,OAAOC,CAAP,EAAU;cACP,EAAEA,CAAC,YAAY/a,cAAf,CAAJ,EAAoC,MAAM+a,CAAN;eAE/BC,QAAL,CAAcD,CAAC,CAACpkB,OAAhB,EAAyBmF,SAAzB,EAAoCif,CAAC,CAAC9a,gBAAtC;;;;YAIG4a,yBAAJ,EACC;;YAEG,KAAKP,oBAAL,IAA6BK,iBAAiB,CAACM,mBAAlB,GAAwClB,mBAAzE,EAA8F;;;OAb/F,QAiBQ,KAAKQ,WAjBb;;MAmBAI,iBAAiB,CAACO,IAAlB;;UAEIL,yBAAyB,IAAI,CAAC,KAAKN,WAAvC,EAAoD;YAC/C,KAAKY,mBAAL,IAA4B,IAAhC,EAAsC;eAChCC,oBAAL,CAA0B,KAAKD,mBAA/B;eACKA,mBAAL,GAA2B,IAA3B;;;YAGG,CAAC,KAAKZ,WAAV,EAAuB;cAClB,KAAKf,KAAL,CAAW6B,SAAX,CAAqBC,YAAzB,EACC,KAAKN,QAAL,CAAc,kFAAd;;cAEG,KAAKxB,KAAL,CAAW+B,gBAAX,CAA4B3mB,MAA5B,IAAsC,CAAtC,IAA2C,CAAC,KAAK4kB,KAAL,CAAWgB,WAAvD,IAAsE,KAAKgB,6BAAL,IAAsC,IAAhH,EAAsH;gBACjH,KAAKhC,KAAL,CAAW6B,SAAX,CAAqBI,MAArB,CAA4B5T,WAAW,CAAC+L,MAAxC,CAAJ,EACC,KAAKoH,QAAL,CAAe,oFAAf,EADD,KAEK,IAAI,KAAKxB,KAAL,CAAW6B,SAAX,CAAqBI,MAArB,CAA4B5T,WAAW,CAACY,QAAxC,CAAJ,EACJ,KAAKuS,QAAL,CAAe,gEAAf,EADI,KAEA,IAAI,CAAC,KAAKxB,KAAL,CAAW6B,SAAX,CAAqBK,MAA1B,EACJ,KAAKV,QAAL,CAAe,0DAAf,EADI,KAGJ,KAAKA,QAAL,CAAe,gFAAf;;;;aAIExB,KAAL,CAAWgB,WAAX,GAAyB,KAAzB;YAEI,KAAKH,uBAAL,IAAgC,CAApC,EACC,KAAKvB,MAAL,CAAYE,cAAZ,CAA2B0B,6BAA3B,GAA2D,KAA3D;aAEIJ,oBAAL,GAA4B,KAA5B;;;WAGID,uBAAL;UAEI,KAAKH,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAeyB,YAAf;;;;;UAIG,KAAKzB,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAe0B,OAAf;WAEIC,IAAL;UAEI,KAAK3B,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAe4B,QAAf;;UAEG,CAAC,KAAKvB,WAAN,IAAqB,CAAC,KAAKf,KAAL,CAAW6B,SAAX,CAAqBU,yBAA/C,EAA0E;aACpEC,+BAAL;;;UAGG,KAAK9B,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAe+B,WAAf;;UAEG,CAAC,KAAKzC,KAAL,CAAW0C,kBAAhB,EAAoC;YAE/B,KAAKf,mBAAL,IAA4B,IAAhC,EAAsC;cAEjC,KAAKA,mBAAL,CAAyBgB,WAAzB,KAAyC,IAA7C,EAAmD;mBAASxkB,kBAAkB,CAAC,sCAAD,CAAzB;;;cACjD,KAAK6hB,KAAL,CAAW2C,WAAX,KAA2B,IAA/B,EAAqC;mBAASxkB,kBAAkB,CAAC,wBAAD,CAAzB;;;cAEnCykB,MAAM,GAAG,KAAKC,iCAAL,CACZ,KAAKlB,mBAAL,CAAyBrB,WADb,EAC0B,KAAKN,KAAL,CAAWM,WADrC,EAEZ,KAAKqB,mBAAL,CAAyBgB,WAAzB,CAAqCvnB,MAFzB,EAEiC,KAAK4kB,KAAL,CAAW2C,WAAX,CAAuBvnB,MAFxD,CAAb;;cAKIwnB,MAAM,IAAIxE,KAAK,CAAC0E,iBAAN,CAAwBC,qBAAtC,EAA6D;iBAEvDnB,oBAAL,CAA0B,KAAKD,mBAA/B;mBAEO,IAAP;WAJD,MAOK,IAAIiB,MAAM,IAAIxE,KAAK,CAAC0E,iBAAN,CAAwBE,cAAtC,EAAsD;iBACrDrB,mBAAL,GAA2B,IAA3B;;;;YAIE,KAAK3B,KAAL,CAAWqB,yBAAf,EAA0C;cACrC,KAAKN,WAAT,EAAsB;gBACjB,KAAKY,mBAAL,IAA4B,IAAhC,EACC,KAAKA,mBAAL,GAA2B,KAAKsB,aAAL,EAA3B;WAFF,MAKK;iBACCtB,mBAAL,GAA2B,IAA3B;;;;;UAKC,KAAKjB,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAewC,YAAf;aAEM,KAAP;;;;sDAGwCC,QArV1C,EAqVmEC,QArVnE,EAqV4FC,YArV5F,EAqVkHC,YArVlH;UAsVMH,QAAQ,KAAK,IAAjB,EAAuB;eAAShlB,kBAAkB,CAAC,UAAD,CAAzB;;;UACrBilB,QAAQ,KAAK,IAAjB,EAAuB;eAASjlB,kBAAkB,CAAC,UAAD,CAAzB;;;UAErBolB,kBAAkB,GAAGH,QAAQ,CAAChoB,MAAT,IAAmB+nB,QAAQ,CAAC/nB,MAA5B,IAAsCgoB,QAAQ,CAACI,MAAT,CAAgBL,QAAQ,CAAC/nB,MAAT,GAAkB,CAAlC,KAAwC,IAAvG;UACIioB,YAAY,IAAIC,YAAhB,IAAgCH,QAAQ,CAAC/nB,MAAT,IAAmBgoB,QAAQ,CAAChoB,MAA5D,IAAsEmoB,kBAA1E,EACC,OAAOnF,KAAK,CAAC0E,iBAAN,CAAwBW,QAA/B;;UAEG,CAACF,kBAAL,EAAyB;eACjBnF,KAAK,CAAC0E,iBAAN,CAAwBE,cAA/B;;;UAGGM,YAAY,GAAGD,YAAnB,EACC,OAAOjF,KAAK,CAAC0E,iBAAN,CAAwBC,qBAA/B;;WAEI,IAAI5nB,CAAC,GAAGgoB,QAAQ,CAAC/nB,MAAtB,EAA8BD,CAAC,GAAGioB,QAAQ,CAAChoB,MAA3C,EAAmDD,CAAC,EAApD,EAAwD;YACnDO,CAAC,GAAG0nB,QAAQ,CAACI,MAAT,CAAgBroB,CAAhB,CAAR;;YACIO,CAAC,IAAI,GAAL,IAAYA,CAAC,IAAI,IAArB,EAA2B;iBACnB0iB,KAAK,CAAC0E,iBAAN,CAAwBC,qBAA/B;;;;aAIK3E,KAAK,CAAC0E,iBAAN,CAAwBW,QAA/B;;;;;WAIKpE,aAAL,CAAmB,mBAAnB;UAEI5Z,EAAE,GAAG,IAAI3E,aAAJ,EAAT;;aAEO,KAAKigB,WAAZ,EAAyB;QACxBtb,EAAE,CAACzE,MAAH,CAAU,KAAK0iB,QAAL,EAAV;;;aAGMje,EAAE,CAAC7I,QAAH,EAAP;;;;kCAGoBH,IA1XtB;aA2XS,KAAKknB,oBAAL,CAA0BnlB,aAA1B,CAAwC/B,IAAxC,CAAP;;;;0CAG4BE,IA9X9B;UA+XMinB,cAAc,GAAG,KAAKD,oBAAL,CAA0BvZ,YAA1B,CAAuCvD,GAAvC,CAA2ClK,IAA3C,CAArB;UACIinB,cAAc,YAAY/kB,SAA9B,EACC,OAAO+kB,cAAP,CADD,KAGC,OAAO,IAAP;;;;kCAGmBnnB,IAtYtB;UAuYMA,IAAI,CAACrB,MAAL,IAAe,CAAnB,EACC,OAAOkT,OAAO,CAACrM,IAAf;UAEGhH,CAAC,GAAG,IAAIqT,OAAJ,EAAR;UAEIuV,eAAe,GAAGpnB,IAAI,CAACrB,MAA3B;UAEI6H,MAAM,GAAG,IAAb;;UACIxG,IAAI,CAACgT,aAAL,KAAuB,IAA3B,EAAiC;eAAStR,kBAAkB,CAAC,oBAAD,CAAzB;;;UAE/B1B,IAAI,CAACgT,aAAL,CAAmBzT,OAAvB,EAAgC;QAC/B6nB,eAAe,GAAGpnB,IAAI,CAACrB,MAAL,GAAc,CAAhC;QACA6H,MAAM,GAAG,KAAK0gB,oBAAL,CAA0BnlB,aAA1B,CAAwC/B,IAAxC,EAA8C6F,SAA9C,EAAyDuhB,eAAzD,CAAT;QACA5oB,CAAC,CAACuF,SAAF,GAAcyC,MAAM,CAACzC,SAArB;QACAvF,CAAC,CAACF,KAAF,GAAU0B,IAAI,CAACgT,aAAL,CAAmB1U,KAA7B;OAJD,MAKO;QACNkI,MAAM,GAAG,KAAK0gB,oBAAL,CAA0BnlB,aAA1B,CAAwC/B,IAAxC,CAAT;QACAxB,CAAC,CAACuF,SAAF,GAAcyC,MAAM,CAACzC,SAArB;QACAvF,CAAC,CAACF,KAAF,GAAU,CAAC,CAAX;;;UAGGkI,MAAM,CAACvF,GAAP,IAAc,IAAd,IAAsBuF,MAAM,CAACvF,GAAP,IAAc,KAAKimB,oBAAnB,IAA2CE,eAAe,GAAG,CAAvF,EAA0F;aACpFhmB,KAAL,CAAW,qCAAqCpB,IAArC,GAA4C,6CAAvD;OADD,MAEO,IAAIwG,MAAM,CAACyG,WAAX,EACN,KAAKoa,OAAL,CAAa,qCAAqCrnB,IAArC,GAA4C,iCAA5C,GAA8EwG,MAAM,CAACvF,GAAP,CAAWjB,IAAzF,GAA8F,IAA3G;;aAEMxB,CAAP;;;;;aAIO,KAAK+kB,KAAL,CAAW+D,IAAX,EAAP;;;;yCAG2B/D,KAxa7B;WAyaOV,MAAL,GAAcU,KAAd;;;;;UAKIgE,iBAAiB,GAAG,IAAxB;UAEIC,OAAO,GAAG,KAAKjE,KAAL,CAAWC,cAAX,CAA0BtQ,IAA1B,EAAd;;UACIsU,OAAO,CAACle,MAAZ,EAAoB;;;;;UAKhBme,gBAAgB,GAAGzmB,QAAQ,CAACwmB,OAAO,CAAC3U,OAAR,EAAD,EAAoBzQ,SAApB,CAA/B;;aAEMqlB,gBAAN,EAAwB;aAElBC,cAAL,CAAoBD,gBAApB,EAAsC,IAAtC,EAFuB;;YAKnBA,gBAAgB,CAACvjB,OAAjB,CAAyBvF,MAAzB,IAAmC,CAAvC,EAA0C;;;;QAI1C6oB,OAAO,GAAG3V,OAAO,CAACoB,OAAR,CAAgBwU,gBAAhB,CAAV,CATuB;;QAWvBA,gBAAgB,GAAGzmB,QAAQ,CAACwmB,OAAO,CAAC3U,OAAR,EAAD,EAAoBzQ,SAApB,CAA3B;;;WAGImhB,KAAL,CAAWC,cAAX,GAA4BgE,OAAO,CAACtU,IAAR,EAA5B;UAEI,KAAK+Q,SAAL,IAAkB,IAAtB,EACC,KAAKA,SAAL,CAAe2B,IAAf,CAAoB,KAAKrC,KAAL,CAAW6B,SAA/B;;;;;;UAOGuC,iBAAiB,GAAGH,OAAO,CAAC3U,OAAR,EAAxB;UACI+U,oBAAoB,GAAG,KAAKC,0BAAL,CAAgCF,iBAAhC,CAA3B;;UAGI,KAAKpE,KAAL,CAAWC,cAAX,CAA0Bla,MAA9B,EAAsC;;;;UAIlCse,oBAAJ,EAA0B;QACzBL,iBAAiB,GAAG,KAApB;;;;;UAKGvI,WAAW,GAAGhe,QAAQ,CAAC2mB,iBAAD,EAAoBvU,WAApB,CAA1B;;UACI4L,WAAJ,EAAiB;YACZhB,MAAM,GAAG,KAAK8J,aAAL,CAAmB9I,WAAnB,CAAb;;YACIhB,MAAJ,EAAY;eACNuF,KAAL,CAAW+B,gBAAX,CAA4BpnB,IAA5B,CAAiC8f,MAAjC;;;QAGD2J,iBAAiB,GAAG,IAApB;QACAJ,iBAAiB,GAAG,KAApB;;;;;UAKGI,iBAAiB,YAAYvlB,SAAjC,EAA4C;QAC3CmlB,iBAAiB,GAAG,KAApB;;;;UAIGA,iBAAJ,EAAuB;;;;;YAMlBQ,UAAU,GAAG/mB,QAAQ,CAAC2mB,iBAAD,EAAoBxb,oBAApB,CAAzB;;YACI4b,UAAU,IAAIA,UAAU,CAAC1b,YAAX,IAA2B,CAAC,CAA9C,EAAiD;;cAG5C2b,UAAU,GAAG,KAAKzE,KAAL,CAAW6B,SAAX,CAAqB6C,uBAArB,CAA6CF,UAAU,CAAC3b,YAAxD,CAAjB;UACAub,iBAAiB,GAAG,IAAIxb,oBAAJ,CAAyB4b,UAAU,CAAC3b,YAApC,EAAkD4b,UAAlD,CAApB;SAXqB;;;YAelB,KAAKzE,KAAL,CAAW2E,sBAAf,EAAuC;eACjC3E,KAAL,CAAW4E,mBAAX,CAA+BR,iBAA/B;SADD;aAIK;iBACCpE,KAAL,CAAW6E,kBAAX,CAA8BT,iBAA9B;;;;;WAKGU,WAAL;;;;UAKI5I,UAAU,GAAGze,QAAQ,CAAC2mB,iBAAD,EAAoB3X,cAApB,CAAzB;;UACIyP,UAAU,IAAIA,UAAU,CAACvP,WAAX,IAA0BF,cAAc,CAACG,WAAf,CAA2BmB,WAAvE,EAAoF;aAC9EiS,KAAL,CAAW6B,SAAX,CAAqBkD,UAArB;;;;;mCAIoBvkB,SAphBvB,EAohB6CwkB,OAphB7C;UAqhBM,CAACxkB,SAAS,CAAC0L,mBAAX,IAAkC8Y,OAAtC,EAA+C;YAC1CxkB,SAAS,CAACqL,qBAAd,EACC,KAAKoZ,+BAAL,CAAqCzkB,SAArC;YAEGA,SAAS,CAACwL,wBAAd,EACC,KAAKkZ,+BAAL,CAAqC1kB,SAArC;;;;;;UAME2kB,eAAe,GAAG,KAAKnF,KAAL,CAAWmF,eAAX,CAA2BxV,IAA3B,EAAtB;UACIsU,OAAO,GAAG,KAAKjE,KAAL,CAAWC,cAAX,CAA0BtQ,IAA1B,EAAd;UAEIsU,OAAO,CAACle,MAAR,IAAkBke,OAAO,CAAClpB,KAAR,IAAiB,CAAC,CAAxC,EACC;WAEIqqB,eAAL,CAAqBhqB,MAArB,GAA8B,CAA9B;;UACI,CAAC+pB,eAAe,CAACpf,MAArB,EAA6B;;YAExBsf,wBAAwB,GAAGF,eAAe,CAAC7V,OAAhB,EAA/B;YACIgW,YAAY,GAAG7nB,QAAQ,CAAC4nB,wBAAD,EAA2BxmB,SAA3B,CAAR,IAAiDpB,QAAQ,CAAC0nB,eAAe,CAAC3kB,SAAjB,EAA4B3B,SAA5B,CAA5E;;eACOymB,YAAP,EAAqB;eACfF,eAAL,CAAqBzqB,IAArB,CAA0B2qB,YAA1B,EADoB;;;UAGpBA,YAAY,GAAG7nB,QAAQ,CAAC6nB,YAAY,CAACxmB,MAAd,EAAsBD,SAAtB,CAAvB;;;;UAIE0mB,uBAAuB,GAAGtB,OAAO,CAAC3U,OAAR,EAA9B;UAEIiW,uBAAuB,IAAI,IAA/B,EAAqC;;UAGjCC,wBAAwB,GAAG/nB,QAAQ,CAAC8nB,uBAAuB,CAACzmB,MAAzB,EAAiCD,SAAjC,CAAvC;;aACO2mB,wBAAwB,KAAK,KAAKJ,eAAL,CAAqBxkB,OAArB,CAA6B4kB,wBAA7B,IAAyD,CAAzD,IAA8DA,wBAAwB,CAACtZ,mBAA5F,CAA/B,EAAiJ;;;YAI5IuZ,eAAe,GAAGD,wBAAwB,CAAC7kB,OAAzB,CAAiCvF,MAAjC,GAA0C,CAA1C,IAClBmqB,uBAAuB,IAAIC,wBAAwB,CAAC7kB,OAAzB,CAAiC,CAAjC,CAD/B,CAJgJ;;aAQ3IwjB,cAAL,CAAoBqB,wBAApB,EAA8CC,eAA9C;QAEAF,uBAAuB,GAAGC,wBAA1B,CAVgJ;;QAYhJA,wBAAwB,GAAG/nB,QAAQ,CAAC+nB,wBAAwB,CAAC1mB,MAA1B,EAAkCD,SAAlC,CAAnC;;;;;kCAImB4c,WAxkBtB;UAykBMiK,UAAU,GAAG,IAAjB;;UAGIjK,WAAW,CAACrL,YAAhB,EAA8B;YACzBuV,cAAc,GAAG,KAAK3F,KAAL,CAAW4F,kBAAX,EAArB;;YACI,CAAC,KAAKC,QAAL,CAAcF,cAAd,CAAL,EAAoC;UACnCD,UAAU,GAAG,KAAb;;;;UAIEI,SAAS,GAAG,EAAhB;UACIC,cAAc,GAAG,EAArB;;UAEItK,WAAW,CAACnL,oBAAhB,EAAsC;;YAEjC0V,gBAAgB,GAAGpoB,UAAU,CAAC,KAAKoiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCne,WAAlC,CAAjC;QACAse,cAAc,GAAGC,gBAAgB,CAAC9pB,KAAjB,IAA0B,EAA3C;;;UAGGuf,WAAW,CAACpL,eAAhB,EAAiC;;YAE5B4V,WAAW,GAAGroB,UAAU,CAAC,KAAKoiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCne,WAAlC,CAA5B;QACAqe,SAAS,GAAGG,WAAW,CAAC/pB,KAAZ,IAAqB,EAAjC;;;;UAIGuf,WAAW,CAAC3L,QAAhB,EAA0B;YACrBoW,UAAU,GAAG,KAAKC,sBAAL,CAA4B1K,WAAW,CAACtL,YAAxC,CAAjB;;YACI+V,UAAU,GAAG,CAAjB,EAAoB;UACnBR,UAAU,GAAG,KAAb;;;;;;;UAOE,CAACA,UAAL,EAAiB;eACT,IAAP;;;UAGGjL,MAAM,GAAG,IAAI1C,MAAJ,EAAb;MACA0C,MAAM,CAAC/R,UAAP,GAAoB+S,WAAW,CAAC1L,YAAhC;MACA0K,MAAM,CAAC0C,UAAP,GAAoB1B,WAAW,CAAChf,IAAZ,CAAiBG,QAAjB,EAApB;MACA6d,MAAM,CAAClK,kBAAP,GAA4BkL,WAAW,CAAClL,kBAAxC;MACAkK,MAAM,CAAC2L,kBAAP,GAA4B,KAAKpG,KAAL,CAAW6B,SAAX,CAAqBwE,UAArB,EAA5B;MAEA5L,MAAM,CAAC3C,IAAP,GAAc,CAACgO,SAAS,GAAGC,cAAb,EAA6B5kB,OAA7B,CAAqC,kBAArC,EAAyD,EAAzD,CAAd;aAEOsZ,MAAP;;;;6BAGe/c,GA5nBjB;UA6nBM4oB,MAAM,GAAG,KAAb;;UACI5oB,GAAG,YAAY2F,KAAnB,EAA0B;YACrBuD,GAAG,GAAGlJ,GAAV;;YAEIkJ,GAAG,YAAYiB,iBAAnB,EAAsC;cACjC0e,SAAS,GAAG3f,GAAhB;eACK/I,KAAL,CAAW,uCAAuC0oB,SAAS,CAAC7d,UAAjD,GAA8D,qHAAzE;iBACO,KAAP;;;eAGM9B,GAAG,CAACgM,QAAX;;;aAEM0T,MAAP;;;;+CAGiCxc,UA5oBnC;UA6oBMA,UAAU,IAAI,IAAlB,EAAyB;eACjB,KAAP;;;;UAIGA,UAAU,YAAY0E,MAA1B,EAAkC;YAC7BgY,aAAa,GAAG1c,UAApB;;YAEI0c,aAAa,CAACxX,aAAlB,EAAiC;cAC5B2W,cAAc,GAAG,KAAK3F,KAAL,CAAW4F,kBAAX,EAArB,CADgC;;cAI5B,CAAC,KAAKC,QAAL,CAAcF,cAAd,CAAL,EACC,OAAO,IAAP;;;YAGEa,aAAa,CAAC5X,iBAAlB,EAAqC;cAChCkM,OAAO,GAAG0L,aAAa,CAAC3X,kBAA5B;cAEI4X,WAAW,GAAG,KAAKzG,KAAL,CAAWR,cAAX,CAA0BkH,mBAA1B,CAA8C5L,OAA9C,CAAlB;;cAEI2L,WAAW,IAAI,IAAnB,EAAyB;iBACnB5oB,KAAL,CAAW,6EAA6Eid,OAA7E,GAAuF,GAAlG;WADD,MAGK,IAAI,EAAE2L,WAAW,YAAY5e,iBAAzB,CAAJ,EAAiD;;gBAGjD8e,UAAU,GAAGlpB,QAAQ,CAACgpB,WAAD,EAAc9e,QAAd,CAAzB;gBAEIif,YAAY,GAAG,oEAAoE9L,OAApE,GAA8E,uCAAjG;;gBACI6L,UAAU,YAAYhf,QAAtB,IAAkCgf,UAAU,CAACzqB,KAAX,IAAoB,CAA1D,EAA6D;cAC5D0qB,YAAY,IAAI,+BAAhB;aADD,MAEO;cACNA,YAAY,IAAI,gBAAgBH,WAAhB,GAA8B,IAA9C;;;iBAGI5oB,KAAL,CAAW+oB,YAAX;;;cAGGrM,MAAM,GAAG3c,UAAU,CAAC6oB,WAAD,EAAc5e,iBAAd,CAAvB;eACKmY,KAAL,CAAW6G,eAAX,GAA6B,KAAKC,aAAL,CAAmBvM,MAAM,CAAC7R,UAA1B,CAA7B;SAxBD,MA0BO,IAAI8d,aAAa,CAAClM,UAAlB,EAA8B;eAC/ByM,oBAAL,CAA0BP,aAAa,CAACtX,gBAAxC,EAA0DsX,aAAa,CAAChM,YAAxE;iBACO,IAAP;SAFM,MAGA;eACDwF,KAAL,CAAW6G,eAAX,GAA6BL,aAAa,CAACnX,aAAd,CAA4BM,IAA5B,EAA7B;;;YAGG6W,aAAa,CAAC9X,aAAlB,EAAiC;eAC3BsR,KAAL,CAAW6B,SAAX,CAAqBmF,IAArB,CACCR,aAAa,CAAC/X,aADf,EAECnM,SAFD,EAGC,KAAK0d,KAAL,CAAWiH,YAAX,CAAwB7rB,MAHzB;;;YAOG,KAAK4kB,KAAL,CAAW6G,eAAX,CAA2B9gB,MAA3B,IAAqC,CAACygB,aAAa,CAAClM,UAAxD,EAAoE;cAE/DkM,aAAa,IAAIA,aAAa,CAAC9nB,aAA/B,IAAgD8nB,aAAa,CAAC9nB,aAAd,CAA4BwoB,UAA5B,IAA0C,IAA9F,EAAoG;iBAC9FrpB,KAAL,CAAW,kCAAkC2oB,aAAa,CAAC9nB,aAAd,CAA4BwoB,UAAzE;WADD,MAEO;iBACDrpB,KAAL,CAAW,+BAA+B2oB,aAA1C;;;;eAIK,IAAP;OA7DD;WAiEK,IAAI1c,UAAU,YAAY2C,cAA1B,EAA2C;cAC3C0a,WAAW,GAAGrd,UAAlB;;kBAEQqd,WAAW,CAACxa,WAApB;iBAEKF,cAAc,CAACG,WAAf,CAA2BE,SAAhC;mBACM1P,MAAL,CAAY,KAAK4iB,KAAL,CAAW2E,sBAAX,KAAsC,KAAlD,EAAyD,mCAAzD;mBACK3E,KAAL,CAAW2E,sBAAX,GAAoC,IAApC;;;iBAGIlY,cAAc,CAACG,WAAf,CAA2BI,OAAhC;mBACM5P,MAAL,CAAY,KAAK4iB,KAAL,CAAW2E,sBAAX,KAAsC,IAAlD,EAAwD,mCAAxD;mBACK3E,KAAL,CAAW2E,sBAAX,GAAoC,KAApC;;;iBAGIlY,cAAc,CAACG,WAAf,CAA2BG,UAAhC;;kBAGK,KAAKiT,KAAL,CAAWoH,eAAX,CAA2BhsB,MAA3B,GAAoC,CAAxC,EAA2C;oBAEtCisB,MAAM,GAAG,KAAKrH,KAAL,CAAW4F,kBAAX,EAAb,CAF0C;;oBAKtC,EAAEyB,MAAM,YAAYtW,IAApB,CAAJ,EAA+B;;;;sBAI1B+G,IAAI,GAAG,IAAIrQ,WAAJ,CAAgB4f,MAAM,CAACzqB,QAAP,EAAhB,CAAX;uBAEKojB,KAAL,CAAW6E,kBAAX,CAA8B/M,IAA9B;;;;;;iBAMErL,cAAc,CAACG,WAAf,CAA2BW,IAAhC;;;iBAGKd,cAAc,CAACG,WAAf,CAA2BK,SAAhC;mBACM+S,KAAL,CAAW4E,mBAAX,CAA+B,KAAK5E,KAAL,CAAWsH,mBAAX,EAA/B;;;iBAGI7a,cAAc,CAACG,WAAf,CAA2BM,iBAAhC;mBACM8S,KAAL,CAAW4F,kBAAX;;;iBAGInZ,cAAc,CAACG,WAAf,CAA2BO,WAAhC;iBACKV,cAAc,CAACG,WAAf,CAA2BQ,SAAhC;kBAEKma,OAAO,GAAGJ,WAAW,CAACxa,WAAZ,IAA2BF,cAAc,CAACG,WAAf,CAA2BO,WAAtD,GACbkB,WAAW,CAACY,QADC,GACUZ,WAAW,CAAC+L,MADpC;kBAGIoN,0BAA0B,GAA6B,IAA3D;;kBACID,OAAO,IAAIlZ,WAAW,CAAC+L,MAA3B,EAAmC;oBAC9BqN,MAAM,GAAG,KAAKzH,KAAL,CAAW4F,kBAAX,EAAb,CADkC;;gBAGlC4B,0BAA0B,GAAG/pB,QAAQ,CAACgqB,MAAD,EAAS5f,iBAAT,CAArC;;oBACI2f,0BAA0B,KAAK,IAAnC,EAAyC;uBACnCpqB,MAAL,CAAYqqB,MAAM,YAAY1W,IAA9B,EAAoC,+CAApC;;;;kBAIE,KAAKiP,KAAL,CAAW0H,iCAAX,EAAJ,EAAmD;;eAAnD,MAGK,IAAI,KAAK1H,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoCzqB,IAApC,IAA4CqqB,OAA5C,IAAuD,CAAC,KAAKvH,KAAL,CAAW6B,SAAX,CAAqBK,MAAjF,EAAyF;oBAEzF0F,KAAK,GAA6B,IAAIrhB,GAAJ,EAAtC;gBACAqhB,KAAK,CAACzjB,GAAN,CAAUkK,WAAW,CAACY,QAAtB,EAAgC,sCAAhC;gBACA2Y,KAAK,CAACzjB,GAAN,CAAUkK,WAAW,CAAC+L,MAAtB,EAA8B,iCAA9B;oBAEIyN,QAAQ,GAAGD,KAAK,CAAC/gB,GAAN,CAAU,KAAKmZ,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoCzqB,IAA9C,CAAf;;oBACI,CAAC,KAAK8iB,KAAL,CAAW6B,SAAX,CAAqBK,MAA1B,EAAkC;kBACjC2F,QAAQ,GAAG,gCAAX;;;oBAGGC,QAAQ,GAAG,WAAWF,KAAK,CAAC/gB,GAAN,CAAU0gB,OAAV,CAAX,GAAgC,kBAAhC,GAAqDM,QAApE;qBAEKhqB,KAAL,CAAWiqB,QAAX;eAbI,MAgBA;qBACC9H,KAAL,CAAW+H,YAAX;oBAEIP,0BAAJ,EACC,KAAKxH,KAAL,CAAW6G,eAAX,GAA6B,KAAKC,aAAL,CAAmBU,0BAA0B,CAAC9e,UAA9C,CAA7B;;;;;iBAIE+D,cAAc,CAACG,WAAf,CAA2BS,WAAhC;mBACM2S,KAAL,CAAW6E,kBAAX,CAA8BsC,WAA9B;mBAEK/pB,MAAL,CAAY,KAAK4iB,KAAL,CAAW2E,sBAAX,KAAsC,IAAlD,EAAwD,0DAAxD;mBACK3E,KAAL,CAAW2E,sBAAX,GAAoC,KAApC;;;iBAGIlY,cAAc,CAACG,WAAf,CAA2BU,SAAhC;kBAEK0a,qBAAqB,GAAgB,EAAzC;kBAEIC,mBAAmB,GAAG,CAA1B;;mBACK,IAAI9sB,CAAC,GAAG,KAAK6kB,KAAL,CAAWiH,YAAX,CAAwB7rB,MAAxB,GAAiC,CAA9C,EAAiDD,CAAC,IAAI,CAAtD,EAAyD,EAAEA,CAA3D,EAA8D;oBACzDuC,GAAG,GAAG,KAAKsiB,KAAL,CAAWiH,YAAX,CAAwB9rB,CAAxB,CAAV;gBAEA8sB,mBAAmB,GAH0C;;oBAMzDC,OAAO,GAAGzqB,QAAQ,CAACC,GAAD,EAAM+O,cAAN,CAAtB;;oBACIyb,OAAO,IAAIA,OAAO,CAACvb,WAAR,IAAuBF,cAAc,CAACG,WAAf,CAA2BS,WAAjE,EAA8E;;;;oBAI1E3P,GAAG,YAAY+J,WAAnB,EAAiC;kBAChCugB,qBAAqB,CAACrtB,IAAtB,CAA2B+C,GAA3B;;eAjBH;;;mBAsBMsiB,KAAL,CAAWmI,mBAAX,CAA+BF,mBAA/B,EAtBD;;;cA0BCD,qBAAqB,GAAGA,qBAAqB,CAACI,OAAtB,EAAxB,CA1BD;;kBA6BK3iB,EAAE,GAAG,IAAI3E,aAAJ,EAAT;;;;;;qCACcknB,qBAAd,8HAAqC;sBAA5BtsB,CAA4B;kBACpC+J,EAAE,CAACzE,MAAH,CAAUtF,CAAC,CAACkB,QAAF,EAAV;iBA/BF;;;;;;;;;;;;;;;;;mBAmCMojB,KAAL,CAAW2E,sBAAX,GAAoC,IAApC;mBACK3E,KAAL,CAAW4E,mBAAX,CAA+B,IAAInd,WAAJ,CAAgBhC,EAAE,CAAC7I,QAAH,EAAhB,CAA/B;;;iBAGI6P,cAAc,CAACG,WAAf,CAA2BY,WAAhC;kBACK6a,WAAW,GAAG,KAAKrI,KAAL,CAAW+B,gBAAX,CAA4B3mB,MAA9C;mBACK4kB,KAAL,CAAW4E,mBAAX,CAA+B,IAAIjd,QAAJ,CAAa0gB,WAAb,CAA/B;;;iBAGI5b,cAAc,CAACG,WAAf,CAA2BX,KAAhC;mBACM+T,KAAL,CAAW4E,mBAAX,CAAgC,IAAIjd,QAAJ,CAAc,KAAKqY,KAAL,CAAWsI,gBAAX,GAA4B,CAA1C,CAAhC;;;iBAGI7b,cAAc,CAACG,WAAf,CAA2Ba,UAAhC;iBACKhB,cAAc,CAACG,WAAf,CAA2Bc,SAAhC;kBACK6M,OAAM,GAAG,KAAKyF,KAAL,CAAW4F,kBAAX,EAAb;;kBACI,EAAErL,OAAM,YAAY1S,iBAApB,CAAJ,EAA6C;oBACxC0gB,SAAS,GAAG,EAAhB;oBACIhO,OAAM,YAAY5S,QAAtB,EACC4gB,SAAS,GAAG,8FAAZ;qBACI1qB,KAAL,CAAW,2FAAyF0c,OAAzF,GAAgGgO,SAA3G;;eANF;;;kBAWKC,YAAY,GAAG5qB,UAAU,CAAC2c,OAAD,EAAS1S,iBAAT,CAA7B,CAXD;;kBAaKrH,SAAS,GAAG/C,QAAQ,CAAC,KAAKe,aAAL,CAAmBgqB,YAAY,CAAC9f,UAAhC,EAA4C+f,UAA7C,EAAyD5pB,SAAzD,CAAxB;kBAEI6pB,WAAJ;;kBACIloB,SAAS,IAAI,IAAjB,EAAuB;oBAClB2mB,WAAW,CAACxa,WAAZ,IAA2BF,cAAc,CAACG,WAAf,CAA2Ba,UAA1D,EACCib,WAAW,GAAG,KAAKC,sBAAL,CAA4BnoB,SAA5B,CAAd,CADD,KAGCkoB,WAAW,GAAG,KAAKvC,sBAAL,CAA4B3lB,SAA5B,CAAd;eAJF,MAKO;oBACF2mB,WAAW,CAACxa,WAAZ,IAA2BF,cAAc,CAACG,WAAf,CAA2Ba,UAA1D,EACCib,WAAW,GAAG,CAAC,CAAf,CADD,KAGCA,WAAW,GAAG,CAAd;qBAEI5E,OAAL,CAAa,kCAAkCqD,WAAW,CAACvqB,QAAZ,EAAlC,GAA2D,aAA3D,GAA2E4rB,YAAY,CAAC9f,UAAb,CAAwB9L,QAAxB,EAAxF;;;mBAGIojB,KAAL,CAAW4E,mBAAX,CAA+B,IAAIjd,QAAJ,CAAa+gB,WAAb,CAA/B;;;iBAGIjc,cAAc,CAACG,WAAf,CAA2Be,MAAhC;;oBACKib,MAAM,GAAGnrB,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAArB;oBACIkhB,MAAM,GAAGprB,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAArB;oBAEIkhB,MAAM,IAAI,IAAV,IAAkBA,MAAM,YAAYlhB,QAAlB,KAA+B,KAArD,EACC,OAAO,KAAK9J,KAAL,CAAW,yDAAX,CAAP;oBAEG+qB,MAAM,IAAI,IAAV,IAAkBC,MAAM,YAAYlhB,QAAlB,KAA+B,KAArD,EACC,OAAO,KAAK9J,KAAL,CAAW,yDAAX,CAAP,CARsC;;;oBAYnC+qB,MAAM,CAAC1sB,KAAP,KAAiB,IAArB,EAA2B;yBAASiC,kBAAkB,CAAC,cAAD,CAAzB;;;oBACzB0qB,MAAM,CAAC3sB,KAAP,KAAiB,IAArB,EAA2B;yBAASiC,kBAAkB,CAAC,cAAD,CAAzB;;;oBAEzB2qB,WAAW,GAAGF,MAAM,CAAC1sB,KAAP,GAAe2sB,MAAM,CAAC3sB,KAAtB,GAA8B,CAAhD;oBACI4sB,WAAW,IAAI,CAAnB,EACC,KAAKjrB,KAAL,CAAW,uCAAuCgrB,MAAM,CAAC3sB,KAA9C,GAAsD,kBAAtD,GAA2E0sB,MAAM,CAAC1sB,KAAlF,GAA0F,8BAArG;oBAEG6sB,UAAU,GAAG,KAAK/I,KAAL,CAAWgJ,SAAX,GAAuB,KAAKhJ,KAAL,CAAWiJ,cAAnD;oBACIC,MAAM,GAAG,IAAIvL,IAAJ,CAASoL,UAAT,CAAb;oBAEII,UAAU,GAAGD,MAAM,CAACrL,IAAP,EAAjB;oBACIuL,WAAW,GAAID,UAAU,GAAGL,WAAd,GAA6BD,MAAM,CAAC3sB,KAAtD;qBACK8jB,KAAL,CAAW4E,mBAAX,CAA+B,IAAIjd,QAAJ,CAAayhB,WAAb,CAA/B,EAxBuC;;qBA2BlCpJ,KAAL,CAAWiJ,cAAX,GAA4BE,UAA5B;;;;iBAII1c,cAAc,CAACG,WAAf,CAA2BgB,UAAhC;kBACKgQ,IAAI,GAAGngB,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAAnB;kBACIiW,IAAI,IAAI,IAAR,IAAgBA,IAAI,YAAYjW,QAAhB,KAA6B,KAAjD,EACC,OAAO,KAAK9J,KAAL,CAAW,qCAAX,CAAP,CAHF;;;kBAOK+f,IAAI,CAAC1hB,KAAL,KAAe,IAAnB,EAAyB;uBAASiC,kBAAkB,CAAC,cAAD,CAAzB;;;mBAEtB6hB,KAAL,CAAWgJ,SAAX,GAAuBpL,IAAI,CAAC1hB,KAA5B;mBACK8jB,KAAL,CAAWiJ,cAAX,GAA4B,CAA5B;mBAEKjJ,KAAL,CAAW4E,mBAAX,CAA+B,IAAI7T,IAAJ,EAA/B;;;iBAGItE,cAAc,CAACG,WAAf,CAA2BiB,UAAhC;kBACKmL,KAAK,GAAG,KAAKmN,sBAAL,CAA4B,KAAKnG,KAAL,CAAWC,cAAX,CAA0Bzf,SAAtD,IAAmE,CAA/E,CADD;;mBAEMwf,KAAL,CAAW4E,mBAAX,CAA+B,IAAIjd,QAAJ,CAAaqR,KAAb,CAA/B;;;iBAGIvM,cAAc,CAACG,WAAf,CAA2BkB,oBAAhC;kBACKub,YAAY,GAAG,KAAKC,wBAAL,EAAnB;mBACKtJ,KAAL,CAAW4E,mBAAX,CAA+B,IAAIjd,QAAJ,CAAa0hB,YAAb,CAA/B;;;iBAGI5c,cAAc,CAACG,WAAf,CAA2BmB,WAAhC;;;;iBAIKtB,cAAc,CAACG,WAAf,CAA2BoB,IAAhC;;;;kBAIK,KAAKgS,KAAL,CAAW6B,SAAX,CAAqBC,YAAzB,EAAuC;qBACjC9B,KAAL,CAAW6B,SAAX,CAAqB0H,SAArB;eADD;mBAKK;uBACCvJ,KAAL,CAAWgB,WAAX,GAAyB,IAAzB,CADI;;uBAIChB,KAAL,CAAWC,cAAX,GAA4B3R,OAAO,CAACrM,IAApC;;;;;;iBAMGwK,cAAc,CAACG,WAAf,CAA2BqB,GAAhC;mBACM+R,KAAL,CAAWF,QAAX;;;iBAGIrT,cAAc,CAACG,WAAf,CAA2BsB,WAAhC;;kBAEKzK,MAAM,GAAGhG,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAArB,CAFD;;kBAIK6hB,WAAW,GAAG5rB,UAAU,CAAC,KAAKoiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCne,WAAlC,CAA5B;;kBAEIhE,MAAM,KAAK,IAAf,EAAqB;sBACd,IAAI+C,cAAJ,CAAmB,yEAAnB,CAAN;;;kBAGGijB,kBAAkB,GAAG,IAAzB;;kBAEI,KAAK5mB,eAAL,KAAyB,IAA7B,EAAmC;uBAAS1E,kBAAkB,CAAC,sBAAD,CAAzB;;;kBACjCwF,YAAY,GAAG,KAAKd,eAAL,CAAqBC,oBAArB,CAA0C0mB,WAAW,CAACttB,KAAtD,EAA6D,IAA7D,CAAnB;;kBACIyH,YAAY,CAACZ,MAAjB,EAAyB;;;oBAGpBU,MAAM,CAACvH,KAAP,KAAiB,IAArB,EAA2B;yBAASiC,kBAAkB,CAAC,cAAD,CAAzB;;;oBAEzBurB,SAAS,GAAG/lB,YAAY,CAACV,MAAb,CAAqBsQ,mBAArB,CAAyC9P,MAAM,CAACvH,KAAhD,EAAuDoF,WAAW,CAACW,IAAnE,CAAhB;;oBACIynB,SAAS,CAAC3mB,MAAd,EAAsB;kBACrB0mB,kBAAkB,GAAG,IAAI3hB,SAAJ,CAAc4hB,SAAS,CAACzmB,MAAxB,EAAiCQ,MAAM,CAACvH,KAAxC,CAArB;;eAPF,MASO;sBACA,IAAIsK,cAAJ,CAAmB,gCAAgCgjB,WAAW,CAACttB,KAA/D,CAAN;;;kBAGGutB,kBAAkB,IAAI,IAA1B,EACCA,kBAAkB,GAAG,IAAI3hB,SAAJ,EAArB;mBAEIkY,KAAL,CAAW4E,mBAAX,CAA+B6E,kBAA/B;;;iBAGIhd,cAAc,CAACG,WAAf,CAA2BuB,SAAhC;kBACKrI,GAAG,GAAGrI,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCviB,KAAlC,CAAlB;kBACIhE,GAAG,GAAG5B,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCviB,KAAlC,CAAlB,CAFD;;kBAKKsmB,UAAU,GAAGlsB,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkC9d,SAAlC,CAAzB;kBAEI6hB,UAAU,KAAK,IAAf,IAAuBtqB,GAAG,KAAK,IAA/B,IAAuCyG,GAAG,KAAK,IAAnD,EACC,MAAM,IAAIU,cAAJ,CAAmB,mDAAnB,CAAN;;kBAEGmjB,UAAU,CAACztB,KAAX,KAAqB,IAAzB,EAA+B;uBAASiC,kBAAkB,CAAC,kBAAD,CAAzB;;;kBAC7B8E,MAAM,GAAG0mB,UAAU,CAACztB,KAAX,CAAiB0tB,gBAAjB,CAAkCvqB,GAAG,CAACiI,WAAtC,EAAmDxB,GAAG,CAACwB,WAAvD,CAAb;mBAEK0Y,KAAL,CAAW4E,mBAAX,CAAgC,IAAI9c,SAAJ,CAAc7E,MAAd,CAAhC;;;iBAGIwJ,cAAc,CAACG,WAAf,CAA2BwB,UAAhC;;oBACK0E,OAAO,GAAG,KAAKkN,KAAL,CAAW4F,kBAAX,EAAd;oBACI9S,OAAO,KAAK,IAAhB,EACC,MAAM,IAAItM,cAAJ,CAAmB,+BAAnB,CAAN;oBAEGR,IAAI,GAAG8M,OAAO,CAAC5W,KAAnB;oBAEIqN,OAAO,GAAmB,IAA9B;;oBAEIvD,IAAI,KAAK,IAAb,EAAmB;wBAAQ7H,kBAAkB,CAAC,MAAD,CAAxB;;;oBACjB6H,IAAI,CAACvB,KAAL,IAAc,CAAlB,EAAqB;kBACpB8E,OAAO,GAAG,IAAIlH,OAAJ,EAAV;iBADD,MAEO;;sBAEF0mB,WAAU,GAAG,KAAK/I,KAAL,CAAWgJ,SAAX,GAAuB,KAAKhJ,KAAL,CAAWiJ,cAAnD;;sBACIC,OAAM,GAAG,IAAIvL,IAAJ,CAASoL,WAAT,CAAb;;sBAEII,WAAU,GAAGD,OAAM,CAACrL,IAAP,EAAjB;;sBACIgM,aAAa,GAAGV,WAAU,GAAGnjB,IAAI,CAACvB,KAAtC,CANM;;;;;;sBAaFqlB,cAAc,GAAG9jB,IAAI,CAAC+jB,OAAL,EAArB;;uBACK,IAAI5uB,EAAC,GAAG,CAAb,EAAgBA,EAAC,IAAI0uB,aAAa,GAAG,CAArC,EAAwC1uB,EAAC,EAAzC,EAA6C;oBAC5C2uB,cAAc,CAACjM,IAAf;;;sBAEG3hB,KAAK,GAAG4tB,cAAc,CAACjM,IAAf,GAAsB3hB,KAAlC;sBACI8tB,UAAU,GAAsC;oBACnD5mB,GAAG,EAAE9B,WAAW,CAACyC,iBAAZ,CAA8B7H,KAAK,CAAC,CAAD,CAAnC,CAD8C;oBAEnDmH,KAAK,EAAEnH,KAAK,CAAC,CAAD;mBAFb,CAlBM;;sBAwBF8tB,UAAU,CAAC5mB,GAAX,CAAe7B,UAAf,KAA8B,IAAlC,EAAwC;2BAASpD,kBAAkB,CAAC,2BAAD,CAAzB;;;kBAC1CoL,OAAO,GAAG,IAAIlH,OAAJ,CAAY2nB,UAAU,CAAC5mB,GAAX,CAAe7B,UAA3B,EAAuC,IAAvC,CAAV;kBACAgI,OAAO,CAACpG,GAAR,CAAY6mB,UAAU,CAAC5mB,GAAvB,EAA4B4mB,UAAU,CAAC3mB,KAAvC;uBAEK2c,KAAL,CAAWiJ,cAAX,GAA4BE,WAA5B;;;qBAGInJ,KAAL,CAAW4E,mBAAX,CAA+B,IAAI9c,SAAJ,CAAcyB,OAAd,CAA/B;;;;;mBAKK1L,KAAL,CAAW,+BAA+BspB,WAA1C;;;;iBAIM,IAAP;SA1WI;aA8WA,IAAIrd,UAAU,YAAY8G,kBAA1B,EAA+C;gBAC/CoK,MAAM,GAAGlR,UAAb;gBACImgB,WAAW,GAAG,KAAKjK,KAAL,CAAW4F,kBAAX,EAAlB;iBAEK5F,KAAL,CAAWR,cAAX,CAA0B0K,MAA1B,CAAiClP,MAAjC,EAAyCiP,WAAzC;mBAEO,IAAP;WANI;eAUA,IAAIngB,UAAU,YAAY0G,iBAA1B,EAA8C;kBAC9C2L,MAAM,GAAGrS,UAAb;kBACIqgB,UAAU,GAAG,IAAjB,CAFkD;;kBAK9ChO,MAAM,CAACxL,YAAP,IAAuB,IAA3B,EAAiC;oBAE5BnQ,UAAS,GAAG2b,MAAM,CAACiO,iBAAvB;;oBACIpR,MAAK,GAAG,KAAKmN,sBAAL,CAA4B3lB,UAA5B,CAAZ;;gBACA2pB,UAAU,GAAG,IAAIxiB,QAAJ,CAAaqR,MAAb,CAAb;eAJD;mBAQK;kBAEJmR,UAAU,GAAG,KAAKnK,KAAL,CAAWR,cAAX,CAA0BkH,mBAA1B,CAA8CvK,MAAM,CAACxf,IAArD,CAAb;;sBAEIwtB,UAAU,IAAI,IAAlB,EAAwB;wBACnBE,UAAU,GAAG,KAAKrK,KAAL,CAAWR,cAAX,CAA0B8K,0BAA1B,CAAsDnO,MAAM,CAACxf,IAA7D,CAAjB;;wBACI0tB,UAAU,IAAI,IAAlB,EAAwB;2BAClBvG,OAAL,CAAa,wCAAwC3H,MAAM,CAACxf,IAA/C,GAAsD,0FAAtD,GAAmJ0tB,UAAhK;sBACAF,UAAU,GAAGE,UAAb,CAFuB;;;2BAMlBrK,KAAL,CAAWR,cAAX,CAA0B+K,SAA1B,CAAoCpO,MAAM,CAACxf,IAA3C,EAAiDwtB,UAAjD;qBAND,MAOO;2BACDrG,OAAL,CAAc,0BAA0B3H,MAAM,CAACxf,IAAjC,GAAwC,uHAAtD;sBACAwtB,UAAU,GAAG,IAAIxiB,QAAJ,CAAa,CAAb,CAAb;;;;;mBAKEqY,KAAL,CAAW4E,mBAAX,CAA+BuF,UAA/B;qBAEO,IAAP;aAnCI;iBAuCA,IAAIrgB,UAAU,YAAYkH,kBAA1B,EAA8C;oBAC9CwZ,IAAI,GAAG1gB,UAAX;oBACI2gB,UAAU,GAAG,KAAKzK,KAAL,CAAW4F,kBAAX,CAA8B4E,IAAI,CAACtZ,kBAAnC,CAAjB;;oBACIjO,OAAM,GAAGunB,IAAI,CAAClZ,IAAL,CAAUmZ,UAAV,CAAb;;qBACKzK,KAAL,CAAW4E,mBAAX,CAA+B3hB,OAA/B;uBACO,IAAP;;;;aAIM,KAAP;;;;qCAGuBxG,IA9nCzB;UA8nCuCiuB,qFAAiB;UAAMxpB,2EAAc;WACrEme,aAAL,CAAoB,iCAApB;;UAEIqL,cAAJ,EAAoB;aACdC,cAAL;OADD,MAEO;YACF,KAAK3K,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoCzqB,IAApC,IAA4CmR,WAAW,CAACY,QAA5D,EAAsE;cACjE2b,UAAU,GAAG,EAAjB;cACIpqB,SAAS,GAAG,KAAKwf,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoC1H,cAApC,CAAmDzf,SAAnE;;cACIA,SAAS,IAAI,IAAjB,EAAuB;YACtBoqB,UAAU,GAAG,MAAIpqB,SAAS,CAAC/D,IAAV,CAAeG,QAAf,EAAJ,GAA+B,IAA5C;;;gBAEK,IAAIiB,KAAJ,CAAU,kCAAgC+sB,UAAhC,GAA2C,mCAA3C,GAA+EnuB,IAA/E,GAAoF,0EAApF,GAA+J,KAAKujB,KAAL,CAAW6B,SAAX,CAAqBgJ,cAA9L,CAAN;;;;WAIG7K,KAAL,CAAW8K,8BAAX,CAA0C5pB,IAA1C;WACKgf,UAAL,CAAgB,IAAIhmB,IAAJ,CAASuC,IAAT,CAAhB;;;;kCAGoBsuB,WAlpCtB;UAopCM,KAAKjK,oBAAT,EACC,MAAM,IAAIjjB,KAAJ,CAAU,WAAWktB,WAAX,GAAyB,wHAAnC,CAAN;;;;+BAGgB9vB,CAxpCnB;UAwpC4B+vB,4FAAiC;WACtDhL,KAAL,CAAWiL,aAAX,CAAyBhwB,CAAzB,EAA4B+vB,qBAA5B;;WAGKE,iCAAL;;;;sCAGwBC,SA/pC1B;MAgqCEA,SAAS,GAAGA,SAAZ;UACIC,OAAO,GAAG,KAAKC,cAAnB;WACKjuB,MAAL,CAAY+tB,SAAS,IAAI,CAAb,IAAkBA,SAAS,GAAGC,OAAO,CAAChwB,MAAlD,EAA0D,qBAA1D;UAEIkwB,cAAc,GAAGF,OAAO,CAACD,SAAD,CAA5B;;UACIG,cAAc,CAAClF,kBAAf,KAAsC,IAA1C,EAAgD;eAASjoB,kBAAkB,CAAC,mCAAD,CAAzB;;;UAC9CmtB,cAAc,CAAC5iB,UAAf,KAA8B,IAAlC,EAAwC;eAASvK,kBAAkB,CAAC,2BAAD,CAAzB;;;WAErC6hB,KAAL,CAAW6B,SAAX,CAAqB0J,aAArB,GAAqCD,cAAc,CAAClF,kBAApD;WAEKlG,UAAL,CAAgBoL,cAAc,CAAC5iB,UAA/B;;;;gCAGkBwL,YA7qCpB;UA8qCM;eACI,KAAKsX,qBAAL,CAA2BtX,YAA3B,KAA4C,IAAnD;OADD,CAEE,OAAMqN,CAAN,EAAS;eACH,KAAP;;;;;qCAIsBrN,YArrCzB;UAqrC+ChT,2EAAc;UAAIuqB,uFAA4B;;;;;;;WAQtFpM,aAAL,CAAmB,qBAAnB;;UAEInL,YAAY,IAAI,IAApB,EAA0B;cACnB,IAAIrW,KAAJ,CAAU,kBAAV,CAAN;OADD,MAGK,IAAIqW,YAAY,IAAI,EAAhB,IAAsBA,YAAY,CAACwX,IAAb,MAAuB,EAAjD,EAAqD;cACnD,IAAI7tB,KAAJ,CAAU,mCAAV,CAAN;;;UAGG8tB,aAAa,GAAG,KAAKH,qBAAL,CAA2BtX,YAA3B,CAApB;;UACIyX,aAAa,IAAI,IAArB,EAA2B;cACpB,IAAI9tB,KAAJ,CAAU,8BAA8BqW,YAA9B,GAA6C,GAAvD,CAAN;;;UAGG0X,kBAAkB,GAAgB,EAAtC;MACAA,kBAAkB,CAACjxB,IAAnB,CAAwBgB,KAAxB,CAA8BiwB,kBAA9B,EAAkD,KAAK5L,KAAL,CAAWiH,YAA7D;;WACK3H,MAAL,CAAY2B,WAAZ;;WAEKjB,KAAL,CAAW6L,+BAAX,CAA2CF,aAA3C,EAA0DzqB,IAA1D;;UAGI4qB,YAAY,GAAG,IAAIhrB,aAAJ,EAAnB;;aACO,KAAKigB,WAAZ,EAAyB;QACxB+K,YAAY,CAAC9qB,MAAb,CAAoB,KAAK0iB,QAAL,EAApB;;;UAEGqI,UAAU,GAAGD,YAAY,CAAClvB,QAAb,EAAjB;;WAEK0iB,MAAL,CAAY2B,WAAZ,CAAwB2K,kBAAxB;;UAEI3oB,MAAM,GAAG,KAAK+c,KAAL,CAAWgM,kCAAX,EAAb;aAEQP,gBAAD,GAAqB;QAACQ,QAAQ,EAAEhpB,MAAX;QAAmBokB,MAAM,EAAE0E;OAAhD,GAA8D9oB,MAArE;;;;uCAGyBipB,aA/tC3B;UAguCMC,oBAAoB,GAAG,KAAKnM,KAAL,CAAW6B,SAAX,CAAqBuK,QAArB,CAA8BhxB,MAAzD;WAEK4kB,KAAL,CAAW6B,SAAX,CAAqBmF,IAArB,CAA0B3Y,WAAW,CAAC+L,MAAtC;WAEK4H,6BAAL,GAAqCkK,aAArC;WAEKlM,KAAL,CAAWqM,SAAX;UAEIC,eAAe,GAAG,KAAKtM,KAAL,CAAWoH,eAAX,CAA2BhsB,MAAjD;WAEKsoB,QAAL;WAEK1B,6BAAL,GAAqC,IAArC;;;;UAKI,KAAKhC,KAAL,CAAW6B,SAAX,CAAqBuK,QAArB,CAA8BhxB,MAA9B,GAAuC+wB,oBAA3C,EAAiE;aAC3DnM,KAAL,CAAW+H,YAAX;;;UAGGwE,cAAc,GAAG,KAAKvM,KAAL,CAAWoH,eAAX,CAA2BhsB,MAAhD;;UACImxB,cAAc,GAAGD,eAArB,EAAsC;eAC9B,KAAKtM,KAAL,CAAW4F,kBAAX,EAAP;OADD,MAEO;eACC,IAAP;;;;;yCAM0B4G,QA/vC7B,EA+vCsDC,iBA/vCtD;UAgwCMD,QAAQ,KAAK,IAAjB,EAAuB;eAASruB,kBAAkB,CAAC,UAAD,CAAzB;;;UACrBqsB,IAAI,GAAG,KAAK/L,UAAL,CAAgB5X,GAAhB,CAAoB2lB,QAApB,CAAX;;UACIE,yBAAyB,GAAG,IAAhC;UAEIC,aAAa,GAAG,OAAOnC,IAAP,KAAgB,WAApC;;UAGI,CAACmC,aAAL,EAAoB;YACf,KAAKC,8BAAT,EAAyC;UACxCF,yBAAyB,GAAG,KAAKlB,qBAAL,CAA2BgB,QAA3B,CAA5B;eACKpvB,MAAL,CAAYsvB,yBAAyB,KAAK,IAA1C,EAAgD,uCAAuCF,QAAvC,GAAkD,2EAAlG,EAFwC;;eAKnCxM,KAAL,CAAW6B,SAAX,CAAqBmF,IAArB,CACC3Y,WAAW,CAACY,QADb,EAEC3M,SAFD,EAGC,KAAK0d,KAAL,CAAWiH,YAAX,CAAwB7rB,MAHzB;eAKK4kB,KAAL,CAAW6G,eAAX,GAA6BvY,OAAO,CAACoB,OAAR,CAAgBgd,yBAAhB,CAA7B;;SAVD,MAaO;eACDtvB,MAAL,CAAY,KAAZ,EAAmB,uCAAuCovB,QAAvC,GAAkD,0DAArE;;;;;UAKEtrB,IAAI,GAAU,EAAlB;;WACK,IAAI/F,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGsxB,iBAApB,EAAuC,EAAEtxB,CAAzC,EAA4C;;YAEvC0xB,SAAS,GAAGjvB,UAAU,CAAC,KAAKoiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCviB,KAAlC,CAA1B;YACIypB,QAAQ,GAAGD,SAAS,CAACvlB,WAAzB;QACApG,IAAI,CAACvG,IAAL,CAAUmyB,QAAV;;;;;MAKD5rB,IAAI,CAACknB,OAAL;;UAGI2E,UAAU,GAAGvC,IAAK,CAACtpB,IAAD,CAAtB;;UAGI8rB,SAAS,GAAG,IAAhB;;UACID,UAAU,IAAI,IAAlB,EAAwB;QACvBC,SAAS,GAAG3pB,KAAK,CAAC+D,MAAN,CAAa2lB,UAAb,CAAZ;aACK3vB,MAAL,CAAY4vB,SAAS,KAAK,IAA1B,EAAgC,qEAAqED,UAArE,CAAhC;OAFD,MAGO;QACNC,SAAS,GAAG,IAAIjc,IAAJ,EAAZ;;;WAGIiP,KAAL,CAAW4E,mBAAX,CAA+BoI,SAA/B;;;;gDAGkCR,QAtzCpC,EAszCsDhC,IAtzCtD;WAuzCOnL,aAAL,CAAmB,2BAAnB;WACKjiB,MAAL,CAAY,CAAC,KAAKqhB,UAAL,CAAgBza,GAAhB,CAAoBwoB,QAApB,CAAb,EAA4C,eAAeA,QAAf,GAA0B,2BAAtE;;WACK/N,UAAL,CAAgBta,GAAhB,CAAoBqoB,QAApB,EAA8BhC,IAA9B;;;;8BAGgBtuB,KA5zClB;;;;;aAi0CSA,KAAP;;;;yCAG2BswB,QAp0C7B,EAo0C+ChC,IAp0C/C;;;WAq0COptB,MAAL,CAAYotB,IAAI,IAAI,IAApB,EAA0B,4BAA1B;WAEKyC,2BAAL,CAAiCT,QAAjC,EAA2C,UAACtrB,IAAD;QAC1C,MAAI,CAAC9D,MAAL,CAAY8D,IAAI,CAAC9F,MAAL,IAAeovB,IAAI,CAACpvB,MAAhC,EAAwC,gCAAgCovB,IAAI,CAACpvB,MAArC,GAA8C,YAAtF;;YAEI8xB,WAAW,GAAG,EAAlB;;aACK,IAAI/xB,CAAC,GAAG,CAAR,EAAWK,CAAC,GAAG0F,IAAI,CAAC9F,MAAzB,EAAiCD,CAAC,GAAGK,CAArC,EAAwCL,CAAC,EAAzC,EAA4C;UAC3C+xB,WAAW,CAAC/xB,CAAD,CAAX,GAAiB,MAAI,CAACgyB,SAAL,CAAejsB,IAAI,CAAC/F,CAAD,CAAnB,CAAjB;;;eAEMqvB,IAAI,CAAC7uB,KAAL,CAAW,IAAX,EAAiBuxB,WAAjB,CAAP;OAPD;;;;2CAW6BV,QAl1C/B;WAm1COnN,aAAL,CAAmB,+BAAnB;WACKjiB,MAAL,CAAY,KAAKqhB,UAAL,CAAgBza,GAAhB,CAAoBwoB,QAApB,CAAZ,EAA2C,eAAeA,QAAf,GAA0B,uBAArE;;WACK/N,UAAL,WAAuB+N,QAAvB;;;;;UAQI9wB,CAAC,GAAqB,IAA1B;UACI0xB,CAAC,GAAqB,IAA1B;UACIC,gBAAgB,GAAgB/yB,SAAS,CAAC,CAAD,CAAT,IAAgB,IAAIgzB,GAAJ,EAApD;;UAEIhzB,SAAS,CAAC,CAAD,CAAT,YAAwBuE,SAA5B,EAAuC;QACtCnD,CAAC,GAAGpB,SAAS,CAAC,CAAD,CAAb;;;UAGGA,SAAS,CAAC,CAAD,CAAT,YAAwB8D,SAA5B,EAAuC;QACtCgvB,CAAC,GAAG9yB,SAAS,CAAC,CAAD,CAAb;;;UAGGoB,CAAC,KAAK,IAAN,IAAc0xB,CAAC,KAAK,IAAxB,EAA8B;aACxB3M,wBAAL,CAA8B,KAAKnC,qBAAnC,EAA0D+O,gBAA1D;aACK7M,sBAAL,GAA8B,IAA9B,CAF6B;;YAKzB6M,gBAAgB,CAAC1nB,IAAjB,IAAyB,CAA7B,EAAiC;eAC3B6a,sBAAL,GAA8B,IAA9B;SADD,MAEO;cACFrjB,OAAO,GAAG,8CAAd;UACAA,OAAO,IAAKkwB,gBAAgB,CAAC1nB,IAAjB,GAAwB,CAAzB,GAA8B,GAA9B,GAAoC,EAA/C;UACAxI,OAAO,IAAI,KAAX;UACAA,OAAO,IAAItC,KAAK,CAAC0yB,IAAN,CAAWF,gBAAX,EAA6BpxB,IAA7B,CAAkC,MAAlC,CAAX;UACAkB,OAAO,IAAI,IAAX;UACAA,OAAO,IAAK,KAAKyvB,8BAAN,GAAwC,uCAAxC,GAAkF,2BAA7F;eAEK/uB,KAAL,CAAWV,OAAX;;OAfF,MAiBO,IAAIzB,CAAC,IAAI,IAAT,EAAe;;;;;;gCACIA,CAAC,CAACiF,OAA3B,mIAAoC;gBAA3B6sB,YAA2B;gBAC/BhtB,SAAS,GAAGgtB,YAAhB;gBACIhtB,SAAS,IAAI,IAAb,IAAqB,CAACA,SAAS,CAACxC,YAApC,EACC,KAAKyiB,wBAAL,CAA+B+M,YAA/B,EAA6CH,gBAA7C;;;;;;;;;;;;;;;;;;;;;;gCAEuB3xB,CAAC,CAAC0O,YAA3B,mIAAyC;;gBAA/BtI,GAA+B;gBAA1B5F,KAA0B;;iBACnCukB,wBAAL,CAA+BhjB,QAAQ,CAACvB,KAAD,EAAQkC,SAAR,CAAvC,EAA2DivB,gBAA3D;;;;;;;;;;;;;;;;OAPK,MASA,IAAID,CAAC,IAAI,IAAT,EAAe;YACjB/S,MAAM,GAAG5c,QAAQ,CAAC2vB,CAAD,EAAI5e,MAAJ,CAArB;;YACI6L,MAAM,IAAIA,MAAM,CAACC,UAArB,EAAiC;cAC5B3d,IAAI,GAAG0d,MAAM,CAACnL,gBAAlB;;cACIvS,IAAI,KAAK,IAAb,EAAmB;mBAASwB,kBAAkB,CAAC,MAAD,CAAzB;;;cACjB,CAAC,KAAKsgB,UAAL,CAAgBza,GAAhB,CAAoBrH,IAApB,CAAL,EAAgC;gBAC3B,KAAKiwB,8BAAT,EAAyC;kBACpCa,aAAa,GAAG,KAAK9J,oBAAL,CAA0BvZ,YAA1B,CAAuCpG,GAAvC,CAA2CrH,IAA3C,CAApB;;kBACI,CAAC8wB,aAAL,EAAoB;gBACnBJ,gBAAgB,CAACK,GAAjB,CAAqB/wB,IAArB;;aAHF,MAKO;cACN0wB,gBAAgB,CAACK,GAAjB,CAAqB/wB,IAArB;;;;;;;;oCAOkBkM,YAt5CxB,EAs5C8C8kB,QAt5C9C;WAu5COtO,aAAL,CAAmB,wBAAnB;UAEI,KAAKuO,kBAAL,KAA4B,IAAhC,EACC,KAAKA,kBAAL,GAA0B,IAAIrnB,GAAJ,EAA1B;UAEE,CAAC,KAAKyZ,KAAL,CAAWR,cAAX,CAA0BqO,4BAA1B,CAAuDhlB,YAAvD,CAAJ,EACC,MAAM,IAAIrC,cAAJ,CAAmB,8BAA4BqC,YAA5B,GAAyC,gDAA5D,CAAN;;UAEG,KAAK+kB,kBAAL,CAAwB5pB,GAAxB,CAA4B6E,YAA5B,CAAJ,EAA+C;aACzC+kB,kBAAL,CAAwB/mB,GAAxB,CAA4BgC,YAA5B,EAA2ClO,IAA3C,CAAgDgzB,QAAhD;OADD,MAEO;aACDC,kBAAL,CAAwBzpB,GAAxB,CAA4B0E,YAA5B,EAA0C,CAAC8kB,QAAD,CAA1C;;;;;qCAIsBG,aAt6CzB,EAs6CkDC,SAt6ClD;WAu6CO,IAAI5yB,CAAC,GAAG,CAAR,EAAWK,CAAC,GAAGsyB,aAAa,CAAC1yB,MAAlC,EAA0CD,CAAC,GAAGK,CAA9C,EAAiDL,CAAC,EAAlD,EAAqD;aAC/C6yB,eAAL,CAAqBF,aAAa,CAAC3yB,CAAD,CAAlC,EAAuC4yB,SAAS,CAAC5yB,CAAD,CAAhD;;;;;2CAI4BwyB,QA56C/B,EA46CiEM,oBA56CjE;WA66CO5O,aAAL,CAAmB,4BAAnB;UAEI,KAAKuO,kBAAL,KAA4B,IAAhC,EACC;;UAEG,OAAOK,oBAAP,KAAgC,WAApC,EAAiD;YAC5C,KAAKL,kBAAL,CAAwB5pB,GAAxB,CAA4BiqB,oBAA5B,CAAJ,EAAuD;cAClDF,SAAS,GAAG,KAAKH,kBAAL,CAAwB/mB,GAAxB,CAA4BonB,oBAA5B,CAAhB;;UACAF,SAAS,CAACG,MAAV,CAAiBH,SAAS,CAACntB,OAAV,CAAkB+sB,QAAlB,CAAjB,EAA8C,CAA9C;;OAHF,MAKO;YACF5Q,IAAI,GAAG,KAAK6Q,kBAAL,CAAwB7Q,IAAxB,EAAX;;;;;;;gCAEoBA,IAApB,mIAAyB;gBAAhBjC,OAAgB;;gBACpBiT,UAAS,GAAG,KAAKH,kBAAL,CAAwB/mB,GAAxB,CAA4BiU,OAA5B,CAAhB;;YACAiT,UAAS,CAACG,MAAV,CAAiBH,UAAS,CAACntB,OAAV,CAAkB+sB,QAAlB,CAAjB,EAA8C,CAA9C;;;;;;;;;;;;;;;;;;;;gDAKgC9kB,YAj8CpC,EAi8C0DslB,WAj8C1D;UAk8CM,KAAKP,kBAAL,KAA4B,IAAhC,EACC;;UAEGG,SAAS,GAAG,KAAKH,kBAAL,CAAwB/mB,GAAxB,CAA4BgC,YAA5B,CAAhB;;UACI,OAAOklB,SAAP,KAAqB,WAAzB,EAAsC;YACjC,EAAEI,WAAW,YAAY9qB,KAAzB,CAAJ,EAAqC;gBAC9B,IAAIxF,KAAJ,CAAU,iEAAV,CAAN;SAFoC;;;YAKjC+I,GAAG,GAAGhJ,UAAU,CAACuwB,WAAD,EAAc9qB,KAAd,CAApB;;;;;;gCAEqB0qB,SAArB,mIAAgC;gBAAvBJ,QAAuB;YAC/BA,QAAQ,CAAC9kB,YAAD,EAAejC,GAAG,CAACU,WAAnB,CAAR;;;;;;;;;;;;;;;;;;;;yCASyB7K,IAv9C7B;aAw9CS,KAAK2xB,wCAAL,CAA8C3xB,IAA9C,CAAP;;;;6DAG+C4xB,UA39CjD;UA49CM5xB,IAAI,GAAG,IAAIvC,IAAJ,CAASm0B,UAAT,CAAX;UAEIC,aAAa,GAAG,KAAK9vB,aAAL,CAAmB/B,IAAnB,EAAyB+D,SAA7C;;UACI8tB,aAAa,KAAK,IAAtB,EAA4B;eAASnwB,kBAAkB,CAAC,eAAD,CAAzB;;;aACxB,IAAN,EAAY;YACPowB,YAAY,GAAcD,aAAa,CAAC3tB,OAAd,CAAsB,CAAtB,CAA9B;YACI4tB,YAAY,YAAY1vB,SAA5B,EACCyvB,aAAa,GAAGC,YAAhB,CADD,KAEK;;;UAGFC,IAAI,GAAoB,IAA5B;;;;;;8BAEaF,aAAa,CAAC3tB,OAA3B,mIAAoC;cAA5BjF,CAA4B;;cAE/B4gB,GAAG,GAAG7e,QAAQ,CAAC/B,CAAD,EAAIkc,GAAJ,CAAlB;;cACI0E,GAAJ,EAAS;gBACJkS,IAAI,IAAI,IAAZ,EAAkBA,IAAI,GAAG,EAAP;YAClBA,IAAI,CAAC7zB,IAAL,CAAU2hB,GAAG,CAACxE,IAAd;WAFD,MAGO;;;;;;;;;;;;;;;;;aAGD0W,IAAP;;;;;UAII/oB,EAAE,GAAG,IAAI3E,aAAJ,EAAT;WAEK6iB,oBAAL,CAA0B5Y,sBAA1B,CAAiDtF,EAAjD,EAAqD,CAArD,EAAwD,KAAKua,KAAL,CAAWC,cAAX,CAA0B3Q,OAA1B,EAAxD;aAEO7J,EAAE,CAAC7I,QAAH,EAAP;;;;2CAG6B4D,SA7/C/B;UA8/CMiF,EAAE,GAAG,IAAI3E,aAAJ,EAAT;MACAN,SAAS,CAACuK,sBAAV,CAAiCtF,EAAjC,EAAqC,CAArC,EAAwC,KAAKua,KAAL,CAAWC,cAAX,CAA0B3Q,OAA1B,EAAxC;aACO7J,EAAE,CAAC7I,QAAH,EAAP;;;;;WAIKojB,KAAL,CAAWmF,eAAX,GAA6B,KAAKnF,KAAL,CAAWC,cAAX,CAA0BtQ,IAA1B,EAA7B;;UAEI,CAAC,KAAKqQ,KAAL,CAAW6G,eAAX,CAA2B9gB,MAAhC,EAAwC;aAElCia,KAAL,CAAWC,cAAX,GAA4B,KAAKD,KAAL,CAAW6G,eAAX,CAA2BlX,IAA3B,EAA5B;aACKqQ,KAAL,CAAW6G,eAAX,GAA6BvY,OAAO,CAACrM,IAArC;aAEKipB,iCAAL;;YAEI,CAAC,KAAKlL,KAAL,CAAWC,cAAX,CAA0Bla,MAA/B,EAAuC;;;;;UAKpC0oB,0BAA0B,GAAG,KAAKC,uBAAL,EAAjC;;UAEI,CAACD,0BAAL,EAAiC;YAE5BE,MAAM,GAAG,KAAb;;YAEI,KAAK3O,KAAL,CAAW6B,SAAX,CAAqBI,MAArB,CAA4B5T,WAAW,CAACY,QAAxC,CAAJ,EAAuD;eAEjD+Q,KAAL,CAAW+H,YAAX,CAAwB1Z,WAAW,CAACY,QAApC;;cAEI,KAAK+Q,KAAL,CAAW2E,sBAAf,EAAuC;iBACjC3E,KAAL,CAAW4E,mBAAX,CAA+B,IAAI7T,IAAJ,EAA/B;;;UAGD4d,MAAM,GAAG,IAAT;SARD,MASO,IAAI,KAAK3O,KAAL,CAAW6B,SAAX,CAAqBC,YAAzB,EAAuC;eACxC9B,KAAL,CAAW6B,SAAX,CAAqB0H,SAArB;UAEAoF,MAAM,GAAG,IAAT;SAHM,MAIA;eACD3O,KAAL,CAAW0H,iCAAX;;;YAGGiH,MAAM,IAAI,CAAC,KAAK3O,KAAL,CAAWC,cAAX,CAA0Bla,MAAzC,EAAiD;eAC3C+e,WAAL;;;;;;;UAME8J,mBAAmB,GAAG,IAA1B;UAEI3K,OAAO,GAAG,KAAKjE,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoC1H,cAApC,CAAmDtQ,IAAnD,EAAd;MACAsU,OAAO,CAAClpB,KAAR;;UAEIkpB,OAAO,CAACzjB,SAAR,KAAsB,IAA1B,EAAgC;eAASrC,kBAAkB,CAAC,mBAAD,CAAzB;;;aAC3B8lB,OAAO,CAAClpB,KAAR,IAAiBkpB,OAAO,CAACzjB,SAAR,CAAkBG,OAAlB,CAA0BvF,MAAlD,EAA0D;QAEzDwzB,mBAAmB,GAAG,KAAtB,CAFyD;;YAKrDC,YAAY,GAAGpxB,QAAQ,CAACwmB,OAAO,CAACzjB,SAAR,CAAkB1B,MAAnB,EAA2BD,SAA3B,CAA3B;;YACIgwB,YAAY,YAAYhwB,SAAxB,KAAsC,KAA1C,EAAiD;;;;YAI7CiwB,eAAe,GAAGD,YAAa,CAACluB,OAAd,CAAsBC,OAAtB,CAA8BqjB,OAAO,CAACzjB,SAAtC,CAAtB;;YACIsuB,eAAe,IAAI,CAAC,CAAxB,EAA2B;;;;QAI3B7K,OAAO,GAAG,IAAI3V,OAAJ,CAAYugB,YAAZ,EAA0BC,eAA1B,CAAV;QAEA7K,OAAO,CAAClpB,KAAR;QAEA6zB,mBAAmB,GAAG,IAAtB;;YACI3K,OAAO,CAACzjB,SAAR,KAAsB,IAA1B,EAAgC;iBAASrC,kBAAkB,CAAC,mBAAD,CAAzB;;;;UAG/B,CAACywB,mBAAL,EAA0B3K,OAAO,GAAG3V,OAAO,CAACrM,IAAlB;WAErB+d,KAAL,CAAW6B,SAAX,CAAqB8F,cAArB,CAAoC1H,cAApC,GAAqDgE,OAAO,CAACtU,IAAR,EAArD;aAEOif,mBAAP;;;;;UAIIG,UAAU,GAAG,KAAKzP,MAAL,CAAY+L,cAA7B;UAEI2D,gBAAgB,GAAGD,UAAU,CAACE,MAAX,CAAkB,UAACvzB,CAAD;eACjCA,CAAC,CAAC6U,kBAAT;OADsB,CAAvB;UAIIye,gBAAgB,CAAC5zB,MAAjB,IAA2B,CAA3B,IAAgC2zB,UAAU,CAAC3zB,MAAX,GAAoB4zB,gBAAgB,CAAC5zB,MAAzE,EACC,OAAO,KAAP;UAEGqf,MAAM,GAAGuU,gBAAgB,CAAC,CAAD,CAA7B;;UAEIvU,MAAM,CAAC/R,UAAP,KAAsB,IAA1B,EAAgC;eAASvK,kBAAkB,CAAC,mBAAD,CAAzB;;;UAE9Bsc,MAAM,CAAC2L,kBAAP,KAA8B,IAAlC,EAAwC;eAASjoB,kBAAkB,CAAC,2BAAD,CAAzB;;;WAErC6hB,KAAL,CAAW6B,SAAX,CAAqB0J,aAArB,GAAqC9Q,MAAM,CAAC2L,kBAA5C;WAEKlG,UAAL,CAAgBzF,MAAM,CAAC/R,UAAvB,EAAmC,KAAnC;aAEO,IAAP;;;;2CAG6BlI,SA3mD/B;UA4mDMA,SAAS,KAAK,IAAlB,EAAwB;eAASrC,kBAAkB,CAAC,WAAD,CAAzB;;;UACtB,CAACqC,SAAS,CAACqL,qBAAf,EAAuC;QACtCvO,OAAO,CAACC,IAAR,CAAa,4BAA0BiD,SAAS,CAAC7D,IAApC,GAAyC,QAAzC,GAAkD6D,SAAS,CAAC9B,aAA5D,GAA0E,6EAAvF;eACO,CAAP;;;UAGGsa,KAAK,GAAG,CAAZ;UACIkW,gBAAgB,GAAG1uB,SAAS,CAAC/D,IAAV,CAAeG,QAAf,EAAvB;MACAoc,KAAK,GAAG,KAAKgH,KAAL,CAAWmP,WAAX,CAAuBtoB,GAAvB,CAA2BqoB,gBAA3B,KAAgDlW,KAAxD;aACOA,KAAP;;;;oDAGsCxY,SAxnDxC;UAynDMwY,KAAK,GAAG,CAAZ;UACIkW,gBAAgB,GAAG1uB,SAAS,CAAC/D,IAAV,CAAeG,QAAf,EAAvB;UACI,KAAKojB,KAAL,CAAWmP,WAAX,CAAuBnrB,GAAvB,CAA2BkrB,gBAA3B,CAAJ,EAAkDlW,KAAK,GAAG,KAAKgH,KAAL,CAAWmP,WAAX,CAAuBtoB,GAAvB,CAA2BqoB,gBAA3B,CAAR;MAClDlW,KAAK;WACAgH,KAAL,CAAWmP,WAAX,CAAuBhrB,GAAvB,CAA2B+qB,gBAA3B,EAA6ClW,KAA7C;;;;oDAGsCxY,SAhoDxC;UAioDM0uB,gBAAgB,GAAG1uB,SAAS,CAAC/D,IAAV,CAAeG,QAAf,EAAvB;WACKojB,KAAL,CAAWoP,WAAX,CAAuBjrB,GAAvB,CAA2B+qB,gBAA3B,EAA6C,KAAKlP,KAAL,CAAWsI,gBAAxD;;;;2CAG6B9nB,SAroD/B;UAsoDM,CAACA,SAAS,CAACwL,wBAAf,EAA0C;aACpCnO,KAAL,CAAW,+BAA6B2C,SAAS,CAAC7D,IAAvC,GAA4C,QAA5C,GAAqD6D,SAAS,CAAC9B,aAA/D,GAA6E,6EAAxF;;;UAGGwwB,gBAAgB,GAAG1uB,SAAS,CAAC/D,IAAV,CAAeG,QAAf,EAAvB;UACI7B,KAAK,GAAG,KAAKilB,KAAL,CAAWoP,WAAX,CAAuBvoB,GAAvB,CAA2BqoB,gBAA3B,CAAZ;;UACI,OAAOn0B,KAAP,KAAiB,WAArB,EAAkC;eAC1B,KAAKilB,KAAL,CAAWsI,gBAAX,GAA8BvtB,KAArC;OADD,MAEO;eACC,CAAC,CAAR;;;;;;;UAMGs0B,iBAAiB,GAAG5xB,QAAQ,CAAC,KAAKuiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAAhC;;UACI,EAAE0nB,iBAAiB,YAAY1nB,QAA/B,CAAJ,EAA8C;aACxC9J,KAAL,CAAW,2DAAX;eACO,CAAP;;;UAGGyxB,YAAY,GAAG,KAAKtP,KAAL,CAAWC,cAAX,CAA0Bzf,SAA7C;;UACI8uB,YAAY,KAAK,IAArB,EAA2B;eAASnxB,kBAAkB,CAAC,cAAD,CAAzB;;;;;UAIzBkxB,iBAAiB,CAACnzB,KAAlB,KAA4B,IAAhC,EAAsC;eAASiC,kBAAkB,CAAC,yBAAD,CAAzB;;;UACpCoxB,WAAW,GAAGF,iBAAiB,CAACnzB,KAApC;;UAGIszB,WAAW,GAAG5xB,UAAU,CAAC,KAAKoiB,KAAL,CAAW4F,kBAAX,EAAD,EAAkCje,QAAlC,CAA5B;UACI8nB,QAAQ,GAAGD,WAAW,CAACtzB,KAA3B;;;UAIIuzB,QAAQ,KAAK,IAAjB,EAAuB;eAAStxB,kBAAkB,CAAC,UAAD,CAAzB;;;UAErBuxB,SAAS,GAAGD,QAAQ,GAAGF,WAA3B;UACII,cAAc,GAAGF,QAAQ,GAAGF,WAAhC;UAEIK,UAAU,GAAGN,YAAY,CAAC7yB,IAAb,CAAkBG,QAAlB,EAAjB;UACIizB,YAAY,GAAG,CAAnB;;WACK,IAAI10B,CAAC,GAAG,CAAR,EAAWK,CAAC,GAAGo0B,UAAU,CAACx0B,MAA/B,EAAuCD,CAAC,GAAGK,CAA3C,EAA8CL,CAAC,EAA/C,EAAkD;QACjD00B,YAAY,IAAID,UAAU,CAACE,UAAX,CAAsB30B,CAAtB,KAA4B,CAA5C;;;UAEG40B,UAAU,GAAGF,YAAY,GAAGH,SAAf,GAA2B,KAAK1P,KAAL,CAAWgJ,SAAvD;UACIE,MAAM,GAAG,IAAIvL,IAAJ,CAASve,IAAI,CAAC0W,KAAL,CAAWia,UAAX,CAAT,CAAb;UAEIC,eAAe,GAAG,EAAtB;;WACK,IAAI70B,GAAC,GAAG,CAAb,EAAgBA,GAAC,GAAGo0B,WAApB,EAAiC,EAAEp0B,GAAnC,EAAsC;QACrC60B,eAAe,CAACr1B,IAAhB,CAAqBQ,GAArB;;;WAGI,IAAIA,GAAC,GAAG,CAAb,EAAgBA,GAAC,IAAIw0B,cAArB,EAAqC,EAAEx0B,GAAvC,EAA0C;YACrC80B,MAAM,GAAG/G,MAAM,CAACrL,IAAP,KAAgBmS,eAAe,CAAC50B,MAA7C;YACI80B,WAAW,GAAGF,eAAe,CAACC,MAAD,CAAjC;QACAD,eAAe,CAAC9B,MAAhB,CAAuB+B,MAAvB,EAA+B,CAA/B;;YAEI90B,GAAC,IAAIw0B,cAAT,EAAyB;iBACjBO,WAAP;;;;YAII,IAAIryB,KAAJ,CAAU,yBAAV,CAAN;;;;0BAGYV,OAxsDd;UAwsD+BsJ,uFAAmB;UAC5C8a,CAAC,GAAG,IAAI/a,cAAJ,CAAmBrJ,OAAnB,CAAR;MACAokB,CAAC,CAAC9a,gBAAF,GAAqBA,gBAArB;YACM8a,CAAN;;;;4BAGcpkB,OA9sDhB;WA+sDOqkB,QAAL,CAAcrkB,OAAd,EAAuB,IAAvB;;;;6BAGeA,OAltDjB;UAktDkCgzB,gFAAY;UAAO1pB,uFAAmB;UAClEhI,EAAE,GAAG,KAAK2xB,oBAAd;UAEIC,YAAY,GAAGF,SAAS,GAAG,SAAH,GAAe,OAA3C;;UAEI1xB,EAAE,IAAI,IAAV,EAAgB;YACX6xB,OAAO,GAAG7pB,gBAAgB,GAAGhI,EAAE,CAAC8xB,aAAN,GAAsB9xB,EAAE,CAACE,eAAvD;QACAxB,OAAO,GAAG,aAAakzB,YAAb,GAA4B,KAA5B,GAAoC5xB,EAAE,CAAC+xB,QAAvC,GAAkD,SAAlD,GAA8DF,OAA9D,GAAwE,IAAxE,GAA+EnzB,OAAzF;OAFD,MAIK,IAAG,CAAC,KAAK6iB,KAAL,CAAWC,cAAX,CAA0Bla,MAA9B,EAAsC;QAC1C5I,OAAO,GAAG,aAAakzB,YAAb,GAA4B,KAA5B,GAAoC,KAAKrQ,KAAL,CAAWC,cAA/C,GAAgE,KAAhE,GAAwE9iB,OAAlF;OADI,MAGA;QACJA,OAAO,GAAG,aAAakzB,YAAb,GAA4B,IAA5B,GAAmClzB,OAA7C;;;WAGI6iB,KAAL,CAAWwB,QAAX,CAAoBrkB,OAApB,EAA6BgzB,SAA7B;;UAGI,CAACA,SAAL,EACC,KAAKnQ,KAAL,CAAWF,QAAX;;;;2BAGYziB,SAzuDf;UAyuDmCF,8EAAyB;;UACtDE,SAAS,IAAI,KAAjB,EAAwB;YACnBF,OAAO,IAAI,IAAf,EAAqB;UACpBA,OAAO,GAAG,cAAV;;;cAGK,IAAIU,KAAJ,CAAUV,OAAO,GAAG,GAAV,GAAgB,KAAKizB,oBAA/B,CAAN;;;;;;UAxuDGhF,OAAO,GAAa,EAAxB;;UAEI,KAAK9L,MAAL,KAAgB,IAApB,EAA0B;eAASnhB,kBAAkB,CAAC,aAAD,CAAzB;;;;;;;;8BACf,KAAKmhB,MAAL,CAAY+L,cAAzB,mIAAyC;cAAjC3vB,CAAiC;;cACpC,CAACA,CAAC,CAAC6U,kBAAP,EAA2B;YAC1B7U,CAAC,CAACX,KAAF,GAAUqwB,OAAO,CAAChwB,MAAlB;YACAgwB,OAAO,CAACzwB,IAAR,CAAae,CAAb;;;;;;;;;;;;;;;;;;aAIK0vB,OAAP;;;;;WAIK/L,aAAL,CAAmB,gDAAnB;aACO,KAAKW,KAAL,CAAWM,WAAlB;;;;;WAIKjB,aAAL,CAAmB,gDAAnB;aACO,KAAKW,KAAL,CAAW2C,WAAlB;;;;;aAIO,KAAK3C,KAAL,CAAWyQ,aAAlB;;;;;aAIO,KAAKzQ,KAAL,CAAW0Q,eAAlB;;;;;aAIO,KAAK1Q,KAAL,CAAW2Q,QAAlB;;;;;aAIO,KAAK3Q,KAAL,CAAW4Q,UAAlB;;;;;aAIO,KAAK5Q,KAAL,CAAWR,cAAlB;;;;;aAIO,KAAKhB,gBAAZ;;;;;aAIO,KAAKc,MAAZ;;;;;aAoIO,KAAKU,KAAL,CAAWe,WAAlB;;;;;aAIO,CAAC,KAAKD,oBAAb;;;;;aAqxCO,KAAKsN,wCAAL,CAA8C,EAA9C,CAAP;;;;;UAgSI3vB,EAAJ;UAEIwlB,OAAO,GAAG,KAAKjE,KAAL,CAAWC,cAAzB;;UACI,CAACgE,OAAO,CAACle,MAAT,IAAmBke,OAAO,CAAC3U,OAAR,OAAsB,IAA7C,EAAmD;QAClD7Q,EAAE,GAAGwlB,OAAO,CAAC3U,OAAR,GAAmB5Q,aAAxB;;YACID,EAAE,KAAK,IAAX,EAAiB;iBACTA,EAAP;;;;WAIG,IAAItD,CAAC,GAAG,KAAK6kB,KAAL,CAAW6B,SAAX,CAAqBuK,QAArB,CAA8BhxB,MAA9B,GAAuC,CAApD,EAAuDD,CAAC,IAAI,CAA5D,EAA+D,EAAEA,CAAjE,EAAoE;QACnE8oB,OAAO,GAAG,KAAKjE,KAAL,CAAW6B,SAAX,CAAqBuK,QAArB,CAA+BjxB,CAA/B,EAAkC8kB,cAA5C;;YACI,CAACgE,OAAO,CAACle,MAAT,IAAmBke,OAAO,CAAC3U,OAAR,OAAsB,IAA7C,EAAmD;UAClD7Q,EAAE,GAAGwlB,OAAO,CAAC3U,OAAR,GAAmB5Q,aAAxB;;cACID,EAAE,KAAK,IAAX,EAAiB;mBACTA,EAAP;;;;;WAKE,IAAItD,GAAC,GAAG,KAAK6kB,KAAL,CAAWiH,YAAX,CAAwB7rB,MAAxB,GAAiC,CAA9C,EAAiDD,GAAC,IAAI,CAAtD,EAAyD,EAAEA,GAA3D,EAA8D;YACzD01B,SAAS,GAAG,KAAK7Q,KAAL,CAAWiH,YAAX,CAAyB9rB,GAAzB,CAAhB;QACAsD,EAAE,GAAGoyB,SAAS,CAACnyB,aAAf;;YACID,EAAE,KAAK,IAAX,EAAiB;iBACTA,EAAP;;;;aAIK,IAAP;;;;;UAII,KAAKujB,6BAAT,EAAwC;eAChC,KAAKA,6BAAZ;OADD,MAEO;eACC,KAAK1D,qBAAZ;;;;;;EAvxDwBlgB,SAA3B;;AAuzDA,WAAiBggB;MACJ0E,iBAAZ;;aAAYA;IACXA,oDAAA,aAAA;IACAA,iEAAA,0BAAA;IACAA,0DAAA,mBAAA;GAHD,EAAYA,iBAAiB,GAAjB1E,uBAAA,KAAAA,uBAAA,KAAA,CAAZ;CADD,EAAiBA,OAAK,KAALA,OAAK,KAAA,CAAtB;;;;"}